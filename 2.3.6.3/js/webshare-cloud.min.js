"use strict";console.assert||(console.assert=function(e){});var extendFactory=function(prefix){return function(childClazz,parentClazz){var oldPrototype=this[childClazz].prototype;if(parentClazz){var namespace=this,oldConstructor=this[childClazz],newConstructor;newConstructor=oldConstructor.toString().match(new RegExp("("+prefix.join("|")+")."+parentClazz+".(call|apply)"),"g")?function(){oldConstructor.apply(this,arguments)}:function(){namespace[parentClazz].call(this),oldConstructor.apply(this,arguments)},eval(String(prefix[0]+"."+childClazz+" = "+newConstructor.toString()))}var definition={instanceOf:{value:function(e){return this instanceof e},configurable:!1,writable:!0},hasMixin:{value:function(e){return!!(this._mixins&&this._mixins.indexOf(e)>=0)},configurable:!1,writable:!0}};Object.keys(oldPrototype).forEach(function(e){definition[e]={value:oldPrototype[e],configurable:!1,writable:!0}}),this[childClazz].prototype=Object.create(this[parentClazz]&&this[parentClazz].prototype||Object.prototype,definition),this[childClazz].prototype.constructor=this[childClazz]}},defineMixinFactory=function(e){var t=function(e){for(var t=this[e],i=arguments.length,n=1;i>n;n++){for(var o=arguments[n],r=this[o],a=0;a<r._mixins.length;a++)t._mixins.indexOf(r._mixins[a])<0&&(t._mixins.push(r._mixins[a]),t._mixinNames.push(r._mixinNames[a]));for(var s in r)r.hasOwnProperty(s)&&0!==s.indexOf("_mixin")&&void 0===t[s]&&(t[s]=r[s])}};return function(i){var n=this[i];for(var o in n);n._mixinNames=[e[0]+"."+i],n._mixins=[n],arguments.length>1&&t.apply(this,arguments)}},mixinFactory=function(){return function(e,t){var i=this[e],n=this[t];for(var o in n)n.hasOwnProperty(o)&&0!==o.indexOf("_mixin")&&(n[o]===this.requiredForMixin||void 0===i.prototype[o]&&(i.prototype[o]=n[o]));i.prototype._mixins=(i.prototype._mixins||[]).filter(function(){return!0}),i.prototype._mixinNames=(i.prototype._mixinNames||[]).filter(function(){return!0});for(var r=0;r<n._mixins.length;r++)i.prototype._mixins.indexOf(n._mixins[r])<0&&(i.prototype._mixins.push(n._mixins[r]),i.prototype._mixinNames.push(n._mixinNames[r]))}},createNamespace=function(e,t,i){var n,o;"string"==typeof t?(n=t,o=i):"object"==typeof t&&(o=t);var r=o||window;r[e]||(r[e]=Object.create(r[n]||Object.prototype)),r[e]._namespace=e;var a=[],s=r[e];do a.push(s._namespace),s=Object.getPrototypeOf(s);while(s._namespace);r[e].extend=extendFactory(a),r[e].defineMixin=defineMixinFactory(a),r[e].requiredForMixin="required",r[e].mixin=mixinFactory(a)};createNamespace("F"),F.assert=function(){},F.assertBoolean=function(){},F.assertBooleanIfDefined=function(){},F.assertBooleans=function(e){for(var t=0,i=e.length;i>t;++t);},F.assertString=function(){},F.assertStringIfDefined=function(){},F.assertStrings=function(e){for(var t=0,i=e.length;i>t;++t);},F.assertNumber=function(){},F.assertNumberIfDefined=function(){},F.assertNumbers=function(e){for(var t=0,i=e.length;i>t;++t);},F.assertNumbersIfDefined=function(e){},F.assertArray=function(e){window.ArrayBuffer&&e instanceof ArrayBuffer,window.Uint8Array&&e instanceof Uint8Array,window.Int8Array&&e instanceof Int8Array,window.Uint16Array&&e instanceof Uint16Array,window.Int16Array&&e instanceof Int16Array,window.Uint32Array&&e instanceof Uint32Array,window.Int32Array&&e instanceof Int32Array,window.Float32Array&&e instanceof Float32Array,window.Float64Array&&e instanceof Float64Array,window.Uint8ClampedArray&&e instanceof Uint8ClampedArray},F.assertArrayIfDefined=function(e){window.ArrayBuffer&&e instanceof ArrayBuffer,window.Uint8Array&&e instanceof Uint8Array,window.Int8Array&&e instanceof Int8Array,window.Uint16Array&&e instanceof Uint16Array,window.Int16Array&&e instanceof Int16Array,window.Uint32Array&&e instanceof Uint32Array,window.Int32Array&&e instanceof Int32Array,window.Float32Array&&e instanceof Float32Array,window.Float64Array&&e instanceof Float64Array,window.Uint8ClampedArray&&e instanceof Uint8ClampedArray},F.assertArrays=function(e){for(var t=0,i=e.length;i>t;++t);},F.assertFunction=function(){},F.assertFunctionIfDefined=function(){},F.assertObject=function(){},F.assertObjectIfDefined=function(){},F.assertObjects=function(e){for(var t=0,i=e.length;i>t;++t);},F.assertEnum=function(){},F.assertEnumIfDefined=function(){},F.ServiceContainer=function(e){e?(this._services=Object.create(e._services),this._serviceInstances=Object.create(e._serviceInstances),this._controllers=Object.create(e._controllers),this._parameters=Object.create(e._parameters),this._auxiliaries=Object.create(e._auxiliaries),this._auxiliaryInstances=Object.create(e._auxiliaryInstances)):(this._services={},this._serviceInstances={},this._controllers={},this._parameters={},this._auxiliaries={},this._auxiliaryInstances={}),this._parameterPattern=/^%(.+)%$/,this._servicePattern=/^@(.+)$/,this._configurations=[],this._phase=F.ServiceContainer.Phase.Define},F.ServiceContainer.prototype={get:function(e){var t=this.getAuxiliary(e);if(t)return t;var i="?"==e.charAt(0),n=i?e.substring(1):e;if(this._parameterPattern.test(n)){var o=this._parameterPattern.exec(n);return this.getParameter(o[1],i)}return this._servicePattern.test(n)?this.getService(n.substr(1),i):void 0},registerAuxiliary:function(e,t){this._auxiliaries[e]=t},getAuxiliary:function(e){return this._auxiliaries[e]?(this._auxiliaryInstances[e]=this._auxiliaryInstances[e]||this._auxiliaries[e](),this._auxiliaryInstances[e]):!1},registerController:function(e,t){for(var i=[],n=2;n<arguments.length;n++)i.push(arguments[n]);this._controllers[e]={constructor:t,injections:i,instances:0}},redefineController:function(e,t){for(var i=[],n=2;n<arguments.length;n++)i.push(arguments[n]);this._controllers[e].constructor=t,this._controllers[e].injections=i},getController:function(e){var t=this;return function(i){var n=t._controllers[e];n.instances++;var o=n.injections.map(function(e){return t.get(e)});o.unshift(i);var r=function(){};r.prototype=n.constructor.prototype;var a=new r;return n.constructor.apply(a,o),a}},getAngularController:function(e){return["$scope",this.getController(e)]},registerParameter:function(e,t){this._parameters[e]=t},getParameter:function(e){return this._parameters[e]},registerService:function(e,t){this._services[e]={constructor:t,injections:F.sliceArguments(arguments,2)}},redefineService:function(e,t){this._services[e]={constructor:t,injections:F.sliceArguments(arguments,2)}},getService:function(e){if(this._services[e]){var t=this;return this._serviceInstances[e]=this._serviceInstances[e]||function(){var i=t._services[e],n=function(){};n.prototype=i.constructor.prototype;var o=[];i.injections.forEach(function(e){o.push(t.get(e))});var r=new n;return i.constructor.apply(r,o),r}(),this._serviceInstances[e]}},getServices:function(e){var t=[],i=this,n=e||function(){return!0};return angular.forEach(this._services,function(e,o){var r=i.getService(o);n(r)&&t.push(r)}),t},inject:function(){var e=arguments[arguments.length-1],t=F.sliceArguments(arguments,0,arguments.length-1);return e.apply(this,t.map(F.proxy(this.get,this)))},config:function(){this._configurations.push(arguments),this._phase===F.ServiceContainer.Phase.Run&&this.inject.apply(this,arguments)},init:function(){this._phase=F.ServiceContainer.Phase.Init;var e=this;this._configurations.forEach(function(t){e.inject.apply(e,t)}),this._phase=F.ServiceContainer.Phase.Run}},F.extend("ServiceContainer"),F.ServiceContainer.Phase={Define:1,Init:2,Run:3},F._serviceContainer=new F.ServiceContainer,F.DI=function(){return F._serviceContainer},F.NOP=function(){},F.log=function(){},F.handled=function(e){e&&(e._handled=!0)},F.proxy=function(e,t){return function(){return e.apply(t,arguments)}},F.async=function(e,t){t?setTimeout(F.proxy(e,t),0):setTimeout(e,0)},F.consoleOrMock=window.console||{error:function(){}},F.shipError=function(){F.consoleOrMock.error.apply(F.consoleOrMock,arguments)},F.unhandledErrors=[],window.onerror=function(e,t,i,n){F.shipError("Uncaught exception:"),F.shipError("Message   : "+e),F.shipError("URL       : "+t+(i?":"+i+(n?":"+n:""):""));for(var o=4;o<arguments.length;o++)F.shipError("Additional info "+o+":"),F.shipError(arguments[o]);F.unhandledErrors.push({errorMessage:e,url:t,lineNumber:i})},window.Q&&(Q.onerror=function(e){if(!e||!e._handled)throw e}),F.unknownError=new Error("EM_UNKNOWN_ERROR"),F.connectionError=new Error("EM_CONNECTION_ERROR"),angular&&(angular.module("f.filter",[]),angular.module("f.widget",[]),angular.module("f.util",[]),angular.module("f.unit",[])),F.findFirst=function(e,t){if("function"==typeof t){for(var i=0;i<e.length;i++)if(t(e[i]))return e[i]}else for(var n=0;n<e.length;n++)if(e[n]===t)return e[n]},F.findIndex=function(e,t){for(var i=0;i<e.length;i++)if(t(e[i],i))return i;return-1},F.removeFirst=function(e,t){if("function"==typeof t){for(var i=0;i<e.length;i++)if(t(e[i]))return e.splice(i,1)[0]}else for(var n=0;n<e.length;n++)if(e[n]===t)return e.splice(n,1)[0]},F.clearArray=function(e){for(;e.length>0;)e.shift()},F.removeAll=function(e,t){if("function"==typeof t)for(var i=0;i<e.length;i++)t(e[i])&&e.splice(i--,1);else for(var n=0;n<e.length;n++)e[n]===t&&e.splice(n--,1);return e},F.addUnique=function(e,t){return-1==e.indexOf(t)?(e.push(t),!0):!1},F.cloneArray=function(e){return e.filter(function(){return!0})},F.sliceArguments=function(e,t,i){return Array.prototype.slice.call(e,t,i)},F.fillArray=function(e,t){for(var i=[],n=0;e>n;++n)i.push(t);return i},F.moveElementInArray=function(e,t,i){e.splice(i,0,e.splice(t,1)[0])},F.extractComponent=function(e,t,i){for(var n=Math.floor(e.length/i),o=new e.constructor(n),r=t,a=0;n>a;r+=i,a++)o[a]=e[r];return o},F.sortNumbers=function(e){return e instanceof Array||!e.sort?Array.prototype.sort.call(e,function(e,t){return e-t}):e.sort()},F.isTouch=function(){var e="ontouchstart"in document.documentElement||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0;return function(){return e}}(),document.documentElement.className+=F.isTouch()?" f_touch":" f_noTouch",F.isMobile=function(){return/iPhone|iPod|iPad|Android|BlackBerry|arm|touch/i.test(navigator.userAgent)},F.getWindowWidth=function(){return window.innerWidth},F.getWindowHeight=function(){return window.innerHeight},F.isSmallScreen=function(){return window.innerWidth<919},F.isIE=function(){var e=navigator.userAgent;return/Trident/i.test(e)||/Edge/i.test(e)||/msie/i.test(e)},F.ieVersion=function(){var e=navigator.userAgent;return/Trident\/.*rv:(\d+)\.\d+/i.test(e)||/Edge\/(\d+)\.\d+/i.test(e)||/MSIE (\d+)\.\d+/i.test(e)?Number(RegExp.$1):0},F.isMobileSafari=function(){return/mobile.*safari|safari.*mobile/i.test(navigator.userAgent)},F.supportsFileReader=function(){var e;return function(){if(void 0===e)if(window.FileReader){var t;try{t=new FileReader}catch(i){}e=!!t}else e=!1;return e}}(),F.getMaxCanvasWidth=function(){return F.isMobile&&F.isMobile()?2048:8192},F.getMaxCanvasHeight=function(){return F.isMobile&&F.isMobile()?1024:8192},F.getGLContext=function(e){for(var t,i=["webgl","experimental-webgl","webkit-3d","moz-webgl"],n=0;n<i.length;++n){try{t=e.getContext(i[n])}catch(o){}if(t)break}return t},F.getGLExtension=function(e,t){e._glExt||(e._glExt={});var i=["","WEBKIT_","MOZ_","MS_","O_"],n=e._glExt;return void 0===n[t]&&i.forEach(function(i){n[t]||(n[t]=e.getExtension(i+t))}),n[t]},F.isWebGlAvailable=function(){if(void 0===F.isWebGlAvailable._webGlAvailable){var e=document.createElement("canvas");F.isWebGlAvailable._webGlAvailable=!(!window.WebGLRenderingContext||!F.getGLContext(e))}return F.isWebGlAvailable._webGlAvailable},window.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){window.setTimeout(e,1e3/60)}}(),F.datestringToDateObj=function(e){var t=e.split(/[- :]/);return new Date(t[0],t[1]-1,t[2],t[3],t[4],t[5])},F.parseDateTimeStr=function(e){var t=e.substr(0,10)+"T"+e.substr(11)+"Z";return Date.parse(t)},F.ageInDays=function(e,t){var i=F.parseDateTimeStr(e),n=t?t:(new Date).getTime(),o=864e5;return(n-i)/o},F.getDateOfDateTimeStr=function(e){return e.substr(0,10)},F.isDefaultDate=function(e){return null===e||void 0===e?!0:0===e.lastIndexOf("1970-01-01",0)},F.dateToMySQLString=function(e,t){return t?e.toISOString().slice(0,10):e.toISOString().slice(0,19).replace("T"," ")},F.FiniteStateMachine=function(e,t){this._states=e,this._listeners=this.createListenerMap(e),this._state=t,this._meta={}},F.FiniteStateMachine.prototype={read:function(e){var t=this._state;if(!this._states[t][e])throw new Error("Invalid transition input: ["+t+", "+e+"]");var i=this._states[t][e],n=this._listeners,o=function(n){n(t,e,i)};n[t]._leave.forEach(o),n[t][e].forEach(o),n._global.forEach(o),this._state=i,n[i]._enter.forEach(o)},addListener:function(e){var t=this._listeners._global;return t.push(e),function(){F.removeAll(t,function(t){return t===e})}},addEnterListener:function(e,t){var i=this._listeners[e]._enter;return i.push(t),function(){F.removeAll(i,function(e){return e===t})}},addLeaveListener:function(e,t){var i=this._listeners[e]._leave;return i.push(t),function(){F.removeAll(i,function(e){return e===t})}},addInputListener:function(e,t,i){var n=this._listeners[e][t];return n.push(i),function(){F.removeAll(n,function(e){return e===i})}},createListenerMap:function(e){var t={};t._global=[];for(var i in e){var n=e[i],o=t[i]={};o._enter=[],o._leave=[];for(var r in n)o[r]=[]}return t},validate:function(e){if(!(e instanceof Object))return!1;if(0===Object.keys(e).length)return!1;for(var t in e){if(!(e[t]instanceof Object))return!1;for(var i in e[t]){var n=e[t][i];if(!(e[n]instanceof Object))return!1}}return!0}},F.extend("FiniteStateMachine"),F.curry=function(e,t,i){var n=Array.prototype.slice,o=n.call(arguments,3);return function(){var r=n.call(arguments,0,t-o.length),a=i?r.concat(o):o.concat(r);return e.apply(this,a)}},F.returns=function(e){return function(){return e}},F.wrapPoint=function(e,t,i,n){var o=i-1,r=n-1;return e>=0&&o>=e&&t>=0&&r>=t?[e,t]:e>o&&t>r?F.wrapBottomRight(e,t,i,n):0>e&&t>r?F.wrapBottomLeft(e,t,i,n):0>e&&0>t?F.wrapTopLeft(e,t,i):e>o&&0>t?F.wrapTopRight(e,t,i):e>o&&t>=0&&r>=t?F.wrapRight(e,t,i):e>=0&&o>=e&&t>r?F.wrapBottom(e,t,i,n):0>e&&t>=0&&r>=t?F.wrapLeft(e,t,i):e>=0&&o>=e&&0>t?F.wrapTop(e,t,i):void 0},F.wrapLeft=function(e,t,i){return[0>e?e+i:e,t]},F.wrapRight=function(e,t,i){return[e>=i?e-i:e,t]},F.wrapTop=function(e,t,i){if(0>t){var n=Math.floor(i/2),o=n>e?e+n:e-n,r=-t-1;return[o,r]}return[e,t]},F.wrapBottom=function(e,t,i,n){if(t>=n){var o=Math.floor(i/2),r=o>e?e+o:e-o,a=n+n-1-t;return[r,a]}return[e,t]},F.wrapTopLeft=function(e,t,i){var n=F.wrapTop(e,t,i);return F.wrapLeft(n[0],n[1],i)},F.wrapTopRight=function(e,t,i){var n=F.wrapTop(e,t,i);return F.wrapRight(n[0],n[1],i)},F.wrapBottomLeft=function(e,t,i,n){var o=F.wrapBottom(e,t,i,n);return F.wrapLeft(o[0],o[1],i)},F.wrapBottomRight=function(e,t,i,n){var o=F.wrapBottom(e,t,i,n);return F.wrapRight(o[0],o[1],i)},F.log2=Math.log2||function(e){return Math.log(e)/Math.LN2},F.log10=Math.log10||function(e){return Math.log(e)/Math.LN10},F.fmodSigned=function(e,t){if(0===t)return e;var i=e-t*Math.floor(e/t);if(t>0){if(i>=t)return 0;if(0>i)return t+i===t?0:t+i}else{if(t>=i)return 0;if(i>0)return t+i===t?0:t+i}return i},F.wrapTo_0_2PI=function(e){return F.fmodSigned(e,2*Math.PI)},F.wrapTo_MinusPI_PI=function(e){return F.fmodSigned(e+Math.PI,2*Math.PI)-Math.PI},F.wrapTo_Minus05PI_05PI=function(e){return Math.min(Math.PI/2,Math.max(-Math.PI/2,e))},F.closeToModulo=function(e,t,i,n){var o=((e-t)%i+i)%i,r=i-o;return Math.min(o,r)<=n},F.closeToAngles=function(e,t,i){var n,o;return"number"==typeof i?(n=i,o=i):(n=i[0],o=i[1]),F.closeToModulo(e[0],t[0],2*Math.PI,n)&&F.closeTo(e[1],t[1],o)},F.closeTo=function(e,t,i){return void 0===i&&(i=.001),Math.abs(e-t)<=i},F.closeToArray=function(e,t,i){var n=e.length;if(n!==t.length)return!1;void 0===i&&(i=.001);for(var o=0;n>o;++o)if(i<Math.abs(e[o]-t[o]))return!1;return!0},F.roundDecimal=function(e,t){var i=Math.pow(10,t);return Math.round(e*i)/i},F.calcQuantilesKd=function(e,t,i){var n,o=e.constructor,r=Math.floor(e.length/i),a=new Array(t.length);for(n=0;n<t.length;n++)a[n]=new o(i);for(var s=0;i>s;s++){var c=F.extractComponent(e,s,i);for(F.sortNumbers(c),n=0;n<t.length;n++){var l=Math.floor(t[n]*(r-1));a[n][s]=c[l]}}return a},F.typeOf=function(e){return null===e?"null":e instanceof Array?"array":typeof e},F.compareJSON=function(e,t){if(F.typeOf(e)!==F.typeOf(t))return!1;switch(F.typeOf(e)){case"object":for(var i in e)if(!F.compareJSON(e[i],t[i]))return!1;for(var n in t)if(F.typeOf(e[n])!==F.typeOf(t[n]))return!1;break;case"array":if(e.length!==t.length)return!1;for(var o=0;o<e.length;o++)if(!F.compareJSON(e[o],t[o]))return!1;break;case"string":case"number":case"boolean":return e===t;case"undefined":case"null":break;default:return!1}return!0},F.deepAssign=function(e,t,i){t=t.split(".");for(var n,o=e,r=0;r<t.length;r++)n=t[r],r===t.length-1?o[n]=i:o=o[n]=o[n]||{};return o},F.mergeObjects=function(e){for(var t=1,i=arguments.length;i>t;t++){var n=arguments[t];for(var o in n)n.hasOwnProperty(o)&&(e[o]=n[o])}return e},F.findKey=function(e,t){for(var i in e)if(e[i]===t)return i},F.getFileNameFromPath=function(e){if("string"==typeof e||e instanceof String){var t=e.lastIndexOf("\\"),i=e.lastIndexOf("/"),n=Math.max(t,i),o=n>=0&&n!==e.length-1;return o?e.substr(n+1):e}},F.getExtensionFromPath=function(e){var t=F.getFileNameFromPath(e);if(void 0===t||0===t.length)return void 0;var i=t.lastIndexOf(".");return-1!==i&&i!==t.length-1?t.substring(i+1):void 0},F.isFolderPath=function(e){if(void 0===e||0===e.length)return!1;var t=e[e.length-1];if("/"===t||"\\"===t)return!0;var i=F.getExtensionFromPath(e);return void 0===i?!0:!1},F.getFolderFromPath=function(e){var t=F.getExtensionFromPath(e);if(void 0===t)return e;var i=e.lastIndexOf("\\"),n=e.lastIndexOf("/"),o=Math.max(i,n);return o>=0?e.substr(0,o+1):""},F.getUniqueFolderPath=function(e,t){var i,n,o,r="/"===t[t.length-1]||"\\"===t[t.length-1],a=0,s=!0;for(n=e.map(function(e){return e=F.toUnixPath(e),"/"!==e[e.length-1]?e+"/":e}),o=F.toUnixPath(t),o="/"!==o[o.length-1]?o+"/":o,i=o;n.some(function(e){return 0===e.indexOf(i)});)a++,i=o.slice(0,-1)+a+"/",s=!1;return s?t:r?t.slice(0,-1)+a+t.slice(-1):t+a},F.toUnixPath=function(e){return e.replace(/\\/g,"/")},F.getDriveFromPath=function(e){if("string"==typeof e||e instanceof String){var t=e.indexOf(":"),i=t>=0;return i?e.substr(0,t+1):""}},F.generateUUID=function(){for(var e="",t=0,i=0;32>i;i++)t=16*Math.random()|0,(8==i||12==i||16==i||20==i)&&(e+="-"),e+=(12==i?4:16==i?3&t|8:t).toString(16);return e},F.validateNumber=function(e){return isNaN(parseFloat(e))||!isFinite(e)?"EM_ONLY_NUMBERS":void 0},F.validateIpV4Address=function(e){var t=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/i;return"string"==typeof e&&t.test(e)?void 0:"FE_IP_ADDRESS_INVALID"},F.validatePassword=function(e){if(void 0===e)return"FE_PW_TOO_SHORT";var t=/\d+/,i=/(?=\w*[A-Z])/,n=/(?=\w*[a-z])/,o=/^[\x00-\x7F]*$/;return t.test(e)?i.test(e)?n.test(e)?o.test(e)?e.length<8?"FE_PW_TOO_SHORT":e.length>76?"FE_PW_TOO_LONG":void 0:"FE_PW_ASCII":"FE_PW_LOWERCASE":"FE_PW_UPPERCASE":"FE_PW_NUMBER"},F.validateEmail=function(){var e=/^[a-z0-9!#$%&'*+\/=?^_`{|}~.-]+@[a-z0-9-]+(\.[a-z0-9-]+)+$/i,t=255;return function(i){return"string"==typeof i&&e.test(i)?i.length>t?"FE_EMAIL_TOO_LONG":void 0:"FE_EMAIL_VALID"}}(),F.validateLocation=function(e){var t=/^\-?\d+(\.\d+)?,( )?\-?\d+(\.\d+)?(,( )?\-?\d+(\.\d+)?)?$/;if(!e.match(t))return"FE_LOCATION_WRONG_FORMAT";var i=F.locationStringToArray(e);return i[0]<-180||i[0]>180||i[1]<-90||i[1]>90?"FE_LOCATION_INVALID_VALUES":void 0},F.locationArrayToString=function(e){if(!e||e.length<2)return"";var t=F.roundDecimal(e[1],7)+", "+F.roundDecimal(e[0],7);return e[2]&&(t=t+", "+F.roundDecimal(e[2],5)),t},F.locationStringToArray=function(e){if(""===e)return[];var t=e.split(","),i=[F.roundDecimal(parseFloat(t[1]),7),F.roundDecimal(parseFloat(t[0]),7)];return t[2]&&(i[2]=F.roundDecimal(parseFloat(t[2]),5)),i},F.shortenString=function(e,t,i,n){void 0===n&&(n="...");var o=t-i-n.length+1;if(t<e.length){var r=e.substr(0,i),a=e.substr(e.length-o);e=r+n+a}return e},F.shortenPath=function(e,t,i,n){void 0===n&&(n="...");var o=Math.min(i,F.getDriveFromPath(e).length)+1,r=t-o-n.length;if(t<e.length){var a=e.substr(0,o),s=e.substr(e.length-r),c=s.indexOf(-1===s.indexOf("\\")?"/":"\\");if(-1!==c)s=s.substr(c),e=a+n+s;else{var l=e.lastIndexOf(F.getFileNameFromPath(e)),h=e.length-l-r+n.length,d=e.substr(l-1,Math.round((e.length-l)/2)-Math.round(h/2)),u=e.substr(l-1+Math.round((e.length-l)/2)+Math.round(h/2+.5));e=a+n+d+n+u}}return e},F.containsString=function(e,t,i){return e&&t?(e=i?e:e.toLowerCase(),t=i?t:t.toLowerCase(),e.indexOf(t)>=0):!1},F.byteLength=function(e){for(var t=e.length,i=e.length-1;i>=0;i--){var n=e.charCodeAt(i);n>127&&2047>=n?t++:n>2047&&65535>=n&&(t+=2),n>=56320&&57343>=n&&i--}return t},F.PlugModule=function(e){this._plug=e,this._id=void 0,this._femalePlugFactory={},this._malePlugFactory={},this._femalePlugs={},this._malePlugs={},this._triggers={},this._connectTriggers={},this._connectorService=e},F.PlugModule.prototype={connect:function(){this._plug.connect.apply(this._plug,arguments)},getFemalePlug:function(e){var t=this._femalePlugFactory[e]();return this._femalePlugs[e].push(t),t},getMalePlug:function(e){var t=this._malePlugFactory[e]();if(this._malePlugs[e].push(t),this._connectTriggers[e])for(var i=0;i<this._connectTriggers[e].length;i++)t.addConnectTrigger(this._connectTriggers[e][i]);return t},returnPlug:function(e){var t=e._identifier;e.instanceOf(F.FemalePlug)?this._femalePlugs[t]=this._femalePlugs[t].filter(function(t){return t!==e}):e.instanceOf(F.MalePlug)&&(this._malePlugs[t]=this._malePlugs[t].filter(function(t){return t!==e}))},providesMalePlug:function(e){return this._malePlugFactory[e]?!0:!1},providesFemalePlug:function(e){return this._femalePlugFactory[e]?!0:!1},provideFemalePlug:function(e,t){this._femalePlugFactory[e]||(this._plug.addFemaleProvider(this,e,t),this._femalePlugFactory[e]=F.proxy(function(){return new F.FemalePlug(this,e,t)},this),this._femalePlugs[e]=this._femalePlugs[e]||[])},revokeFemalePlug:function(e){this._plug.removeFemaleProvider(this,e),delete this._femalePlugFactory[e]},provideMalePlug:function(e,t){if(!this._malePlugFactory[e]){this._plug.addMaleProvider(this,e,t),this._malePlugFactory[e]=F.proxy(function(){return new F.MalePlug(this,e,t)},this),this._malePlugs[e]=this._malePlugs[e]||[];for(var i=0;i<t.length;i++)this._triggers[t[i]]=this._triggers[t[i]]||[],this._triggers[t[i]].push(e)}},revokeMalePlug:function(e){this._plug.removeMaleProvider(this,e),delete this._malePlugFactory[e],delete this._connectTriggers[e]},triggerInternal:function(e,t,i){if(!this._triggers[t])throw new Error("Event "+t+" is not provided in any male plug");F.PageBox.collect();for(var n=[],o=0;o<this._triggers[t].length;o++)for(var r=this._triggers[t][o],a=0;a<this._malePlugs[r].length;a++){var s=this._malePlugs[r][a];n.push(s[e].call(s,t,i))}var c;return c=n.length>0?Q.all(n):Q.resolve(),c.then(function(){F.PageBox.commit()})},trigger:function(e,t){return this.triggerInternal("triggerInternal",e,t)},triggerAndDisconnect:function(e,t){this.triggerInternal("triggerInternalAndDisconnect",e,t)},triggerAndDestroy:function(e,t){var i=this;return this.triggerInternal("triggerInternalAndDisconnect",e,t).then(function(){i.destroy()})},addConnectTrigger:function(e,t){this._connectTriggers[e]=this._connectTriggers[e]||[],this._connectTriggers[e].push(t)},destroy:function(){var e;for(e in this._femalePlugFactory)this.revokeFemalePlug(e);for(e in this._malePlugFactory)this.revokeMalePlug(e);for(e in this._malePlugs)this._malePlugs[e].forEach(function(e){e.disconnect()}),delete this._malePlugs[e];for(e in this._femalePlugs)this._femalePlugs[e].forEach(function(e){e.disconnect()}),delete this._femalePlugs[e];for(var t in this._triggers)delete this._triggers[t]}},F.extend("PlugModule"),F.PlugController=function(e,t){F.PlugModule.call(this,t),this._wirePlugs={},this._wireControllers=[],this._watches={},this.$scope=e,e._ctrl=this,this.autoConnect(e)},F.PlugController.prototype={setID:function(e){this._id=e,e&&this._plug.registerPlugModule(e,this)},autoConnect:function(e){if(e){var t=this._plug,i=(this._wirePlugs,this._wireControllers),n=this;this._watches.auto=e.$watch("auto",function(e){for(var o in i)i[o].forEach(function(e){t.withdrawPlug(e),e.disconnect()}),delete i[o];if("string"==typeof e&&/^([a-zA-Z0-9]+(,[a-zA-Z0-9]+)*)?$/.test(e)){var r=e.split(",");for(var a in n._femalePlugFactory)for(var s=n.getFemalePlug(a),c=0;c<r.length;c++)i[r[c]]=i[r[c]]||[],i[r[c]].push(s),t.placePlug(r[c],s)}})}},autoDisconnect:function(){for(var e in this._watches)this._watches[e](),delete this._watches[e];for(var t in this._wirePlugs){var i=this._wirePlugs[t];this._plug.withdrawPlug(i);var n=i._identifier;i.disconnect(),this._femalePlugs[n]=this._femalePlugs[n].filter(function(e){return e!==i}),delete this._wirePlugs[t]}var o=this;for(var r in this._wireControllers)this._wireControllers[r].forEach(function(e){o._plug.withdrawPlug(e),e.disconnect()}),delete this._wireControllers[r]},provideFemalePlug:function(e,t){F.PlugModule.prototype.provideFemalePlug.call(this,e,t);var i=this;for(var n in this._femalePlugFactory)!function(){var e=n,t=n.toLowerCase();i._watches[t]||(i._watches[t]=i.$scope.$watch(t,function(n){if(i._wirePlugs[t]&&(i._plug.withdrawPlug(i._wirePlugs[t]),i._wirePlugs[t].disconnect()),"string"==typeof n&&/^([a-zA-Z0-9]+(,[a-zA-Z0-9]+)*)?$/.test(n)){i._wirePlugs[t]=i.getFemalePlug(e);for(var o=n.split(","),r=0;r<o.length;r++)i._plug.placePlug(o[r],i._wirePlugs[t])}}))}()},returnPlug:function(e){if(e.instanceOf(F.FemalePlug)){this._plug.withdrawPlug(e);var t=e._identifier.toLowerCase();this._wirePlugs[t]&&delete this._wirePlugs[t];for(var i in this._wireControllers)this._wireControllers[i]=this._wireControllers[i].filter(function(t){return t!==e})}F.PlugModule.prototype.returnPlug.call(this,e)},destroy:function(){this.autoDisconnect(),this._id&&this._plug.unregisterPlugModule(this._id),F.PlugModule.prototype.destroy.call(this)}},F.extend("PlugController","PlugModule"),F.PlugController.createDirective=function(e){var t={link:function(t,i,n){t._ctrl.setID(n.id),t.$on("$destroy",function(){t._ctrl.destroy()}),e.link&&e.link.apply(this,arguments)},restrict:"E",scope:{id:"@",auto:"@"}};e.controller?t.controller=e.controller:e.controllerClass&&(t.controller=["$scope",function(t){this.$scope=t,t.ctrl=new e.controllerClass(t)}]),e.compile&&(t.compile=e.compile),e.templateUrl?t.templateUrl=e.templateUrl:e.template&&(t.template=e.template),e.transclude&&(t.transclude=e.transclude),e.replace&&(t.replace=e.replace),e.require&&(t.require=e.require);for(var i in e.scope)t.scope[i]=e.scope[i];return t},F.PlugDescription=function(e,t){this._identifier=e,this._pins=t,this._maleProviders=[],this._femaleProviders=[]},F.PlugDescription.prototype={addMaleProvider:function(e){this._maleProviders.push(e)},removeMaleProvider:function(e){this._maleProviders=this._maleProviders.filter(function(t){return t!=e})},addFemaleProvider:function(e){this._femaleProviders.push(e)},removeFemaleProvider:function(e){this._femaleProviders=this._femaleProviders.filter(function(t){return t!=e})}},F.PlugBase=function(){this._plugDescriptions={},this._plugModules={}},F.PlugBase.prototype={registerPlugModule:function(e,t){if(this._plugModules[e]&&this._plugModules[e]!==t)throw new Error("Multiple plug modules with id "+e);this._plugModules[e]=t},unregisterPlugModule:function(e){this._plugModules[e]&&delete this._plugModules[e]},getPlugModule:function(e){if(!this._plugModules[e])throw new Error("Plug module does not exist "+e);return this._plugModules[e]},addMaleProvider:function(e,t,i){var n=this._plugDescriptions[t];if(!n)throw new Error("Plug "+t+" has never been described");if(!i)throw new Error("Plug "+t+" provides no pins");if(i.sort(),i.length!=n._pins.length)throw new Error("Plug "+t+" doesn't match descriptor");for(var o=0;o<i.length;o++)if(i[o]!=n._pins[o])throw new Error("Plug "+t+" doesn't match descriptor");n.addMaleProvider(e)},removeMaleProvider:function(e,t){if(t)this._plugDescriptions[t].removeMaleProvider(e);else for(t in this._plugDescriptions)this._plugDescriptions[t].removeMaleProvider(e)},addFemaleProvider:function(e,t,i){var n=this._plugDescriptions[t];if(!n)throw new Error("Plug "+t+" has never been described");if(!i)throw new Error("Plug "+t+" provides no pins");if(i.sort(),i.length!=n._pins.length)throw new Error("Plug "+t+" doesn't match descriptor");for(var o=0;o<i.length;o++)if(i[o]!=n._pins[o])throw new Error("Plug "+t+" doesn't match descriptor");for(var r=0;r<n._pins.length;r++)if(!(e[n._pins[r]]&&e[n._pins[r]]instanceof Function))throw new Error("PlugModule doesn't implement descriptor "+t+" - missing pin: "+n._pins[r]);n.addFemaleProvider(e)},removeFemaleProvider:function(e,t){if(t)this._plugDescriptions[t].removeFemaleProvider(e);else for(t in this._plugDescriptions)this._plugDescriptions[t].removeFemaleProvider(e)},describe:function(e,t){if(!(t instanceof Array&&t.length))throw new Error("Plug "+e+" has no pins in description");if(this._plugDescriptions[e]){var i=this._plugDescriptions[e]._pins;if(!F.compareJSON(t,i))throw new Error("Plug "+e+" is already described: "+t.join(","))}this._plugDescriptions[e]=new F.PlugDescription(e,t.sort())},getPlugDescription:function(e){return this._plugDescriptions[e]},getPlugIdentifiers:function(){var e=[];for(var t in this._plugDescriptions)e.push(t);return e}},F.extend("PlugBase"),F.PlugConnectorService=function(){this._pendingPlugs={}},F.PlugConnectorService.prototype={registerPlugModule:function(e,t){if(F.PlugBase.prototype.registerPlugModule.call(this,e,t),this._pendingPlugs[e]){for(var i=0;i<this._pendingPlugs[e].length;i++)this.connect(t,this._pendingPlugs[e][i],void 0,!0);delete this._pendingPlugs[e]}},connect:function(e,t,i){if(e.instanceOf(F.MalePlug)&&t.instanceOf(F.FemalePlug))this.connectSingle(e,t);else if(e.instanceOf(F.FemalePlug)&&t.instanceOf(F.MalePlug))this.connectSingle(t,e);else if(e.instanceOf(F.MalePlug)&&t.instanceOf(F.PlugModule))t.providesFemalePlug(e._identifier)&&this.connectSingle(e,t.getFemalePlug(e._identifier));else if(e.instanceOf(F.FemalePlug)&&t.instanceOf(F.PlugModule))t.providesMalePlug(e._identifier)&&this.connectSingle(t.getMalePlug(e._identifier),e);else if(e.instanceOf(F.PlugModule)&&t.instanceOf(F.Plug))this.connect(t,e);else if(e.instanceOf(F.PlugModule)&&t.instanceOf(F.PlugModule)){if(!i||"mf"==i||"bi"==i)for(var n in e._malePlugFactory)t.providesFemalePlug(n)&&this.connectSingle(e.getMalePlug(n),t.getFemalePlug(n));if(!i||"fm"==i||"bi"==i)for(var o in t._malePlugFactory)e.providesFemalePlug(o)&&this.connectSingle(t.getMalePlug(o),e.getFemalePlug(o))}},connectSingle:function(e,t){if(e._identifier!=t._identifier)throw new Error("Plug "+e._identifier+" doesn't fit into "+t._identifier);e.connectInternal(t),t.connectInternal(e)},placePlug:function(e,t){this._plugModules[e]?this.connect(this._plugModules[e],t):(this._pendingPlugs[e]=this._pendingPlugs[e]||[],this._pendingPlugs[e].push(t))},withdrawPlug:function(e){for(var t in this._pendingPlugs)this._pendingPlugs[t]=this._pendingPlugs[t].filter(function(t){return t!==e})},getMalePlugProviders:function(e){return this._plugDescriptions[e]._maleProviders},getFemalePlugProviders:function(e){return this._plugDescriptions[e]._femaleProviders},connectWithAll:function(e){var t=this,i=e.instanceOf(F.MalePlug)?this.getFemalePlugProviders(e._identifier):this.getMalePlugProviders(e._identifier);i.forEach(function(i){t.connect(e,i)})}},F.extend("PlugConnectorService","PlugBase"),F.SelectionService=function(){this._selections={}},F.SelectionService.prototype={getSelection:function(e){return this._selections[e]},registerSelection:function(e,t){this._selections[e]=t
},clearAll:function(){angular.forEach(this._selections,function(e){e.clear()})}},F.extend("SelectionService"),F.Plug=function(e,t,i){this._uid=F.Plug.UID++,this._scope=e,this._identifier=t,this._pins=i,this._connectors=[]},F.Plug.prototype={connect:function(e){F.DI().getService("plug").connect(this,e)},disconnect:function(){this.disconnectInternal()},connectInternal:function(e){if(!this._scope||!this._identifier)throw new Error("Invalid plug");-1==this._connectors.indexOf(e)&&this._connectors.push(e)},disconnectInternal:function(e){if(e){var t=this._connectors.indexOf(e);t>-1&&this._connectors.splice(t,1)}else{for(var i=0;i<this._connectors.length;i++)this._connectors[i].disconnectInternal(this);this._connectors=[]}this.isValid()&&0===this._connectors.length&&(this._scope.returnPlug(this),delete this._scope,delete this._identifier)},isValid:function(){return void 0!==this._scope&&void 0!==this._identifier}},F.Plug.UID=0,F.extend("Plug"),F.MalePlug=function(e,t,i){F.Plug.call(this,e,t,i),this._connectTriggers=[]},F.MalePlug.prototype={addConnectTrigger:function(e){this._connectTriggers.push(e)},connectInternal:function(e){F.Plug.prototype.connectInternal.call(this,e);for(var t=0;t<this._connectTriggers.length;t++)this._connectTriggers[t].call(this._scope,this._scope,this)},trigger:function(e,t){return F.PageBox.collect(),this.triggerInternal(e,t).then(function(e){return F.PageBox.commit(),e})},triggerInternal:function(e,t){var i=this,n=Q.defer();return F.async(function(){var o=[];i._connectors.forEach(function(i){var n=i[e].apply(i,t);Q.isPromise(n)&&o.push(n)}),o.length>0?Q.allSettled(o).then(function(){n.resolve(i)}).done():n.resolve(i)}),n.promise},triggerInternalAndDisconnect:function(e,t){var i=this;return this.triggerInternal(e,t).then(function(e){return i.disconnect(),e})}},F.extend("MalePlug","Plug"),F.FemalePlug=function(e,t,i){F.Plug.call(this,e,t,i);for(var n=0;n<i.length;n++)this[i[n]]=F.proxy(e[i[n]],e)},F.extend("FemalePlug","Plug"),F.Selection=function(e,t,i){F.PlugModule.call(this,i);this._identifier=e,this._model=t,this._connectorService.describe(e+"Select",["select","unselect"]),this.provideFemalePlug(e+"Select",["select","unselect"]),this.provideMalePlug(e+"Select",["select","unselect"]),this.addConnectTrigger(e+"Select",function(e,t){var i=this._model.filter(function(e){return e._selected});i.length>0&&t.trigger("select",[i,this._identifier])})},F.Selection.prototype={contains:function(e){return-1!=this._model.indexOf(e)},hasSelected:function(){return this._model.some(function(e){return e._selected})},countSelected:function(){return this._model.reduce(function(e,t){return e+t._selected},0)},select:function(e){var t=!e._selected;e._selected=!0,t&&this.trigger("select",[[e],this._identifier])},selectMulti:function(e){var t=[];e.forEach(function(e){e._selected||t.push(e),e._selected=!0}),t.length>0&&this.trigger("select",[t,this._identifier])},setSelection:function(e){var t=[];this._model.forEach(function(i){i._selected&&-1==e.indexOf(i)&&(i._selected=!1,t.push(i))});var i=[];e.forEach(function(e){e._selected||(e._selected=!0,i.push(e))}),t.length>0&&this.trigger("unselect",[t,this._identifier]),i.length>0&&this.trigger("select",[i,this._identifier])},selectAll:function(){var e=[];this._model.forEach(function(t){t._selected||(t._selected=!0,e.push(t))}),e.length>0&&this.trigger("select",[e,this._identifier])},unselect:function(e){var t=e._selected;e._selected=!1,t&&this.trigger("unselect",[[e],this._identifier])},unselectMulti:function(e){var t=[];e.forEach(function(e){e._selected&&t.push(e),e._selected=!1}),t.length>0&&this.trigger("unselect",[t,this._identifier])},clear:function(){var e=[];this._model.forEach(function(t){t._selected&&(t._selected=!1,e.push(t))}),e.length>0&&this.trigger("unselect",[e,this._identifier])}},F.extend("Selection","PlugModule"),F.Selectable={selection:F.requiredForMixin,select:function(){this.selection().select(this)},unselect:function(){this.selection().unselect(this)},toggleSelection:function(){this._selected?this.selection().unselect(this):this.selection().select(this)}},F.defineMixin("Selectable"),F.DI().config(function(){this.registerService("plug",F.PlugConnectorService),this.registerService("selection",F.SelectionService)}),F.DI().config("@plug",F.crudConfig=function(e){e.describe("ObjectAdd",["addObjects"]),e.describe("ObjectUpdate",["updateObjects"]),e.describe("ObjectRemove",["removeObjects"]),e.describe("ObjectCRUD",["addObjects","updateObjects","removeObjects"])}),F.DI().config("@plug",F.editConfig=function(e){e.describe("ObjectPick",["pickObject"]),e.describe("ObjectShow",["showObjects"]),e.describe("ObjectEdit",["editObject"]),e.describe("RelationChange",["addRelation","removeRelation"])}),F.DI().config("@plug",F.settingsConfig=function(e){e.describe("SettingsUpdate",["updateSettings"])}),angular.module("f.filter").filter("selectionname",function(){return function(e){return e?"FE_SELECTED_"+e.toUpperCase():void 0}}),F.TaskResult=function(e,t,i,n){this._infos=t||[],this._errors=e||[],this._keepOpen=i||!1,this._errorObjs=n||[],this._followupTask=void 0,this._navigateTo=void 0,this._handover=void 0,this._options=void 0},F.extend("TaskResult"),F.TaskContext=function(){this.panel=void 0,this.category=void 0,this.task=void 0,this.categories=[],this.activeCategory=void 0,this.activeTask=void 0},F.TaskContext.prototype={set:function(e){this.panel!=e.panel&&(this.panel=e.panel,this.categories=e.categories),this.activeCategory!=e.activeCategory&&(this.category=e.category,this.activeCategory=e.activeCategory,this.activeTask=void 0),this.task!=e.task&&(this.task=e.task,this.activeTask=void 0),e.activeTask&&(this.activeTask=e.activeTask)}},F.extend("TaskContext"),F.TaskSeed=function(e,t,i,n,o){this.panel=e,this.category=t,this.task=i,this.handover=n,this.options=o,this.categories=[]},F.extend("TaskSeed"),F.TaskSection=function(e,t){F.PlugModule.call(this,t);var i=this;this._id=void 0,this._task=void 0,this._source=void 0,this._index=void 0,this._caption=void 0,this._description=void 0,this._widget=void 0,this._icon=void 0,this._selectPageClass=void 0,this._pageConfiguration=void 0,this._select=void 0,this._selection=void 0,this._resetSelection=void 0,this._selectSingle=!1,this._female=void 0,this._pinBinding=void 0,this._start=void 0,this._complete=!1,this._active=!1,this._canTransitionBackwards=!1,this._alwaysVisible=!1,this._optional=!1,this._activation=0,this._plugs=[],this._selections={},this._hint=void 0,e.compactPanel=!1,this.$scope=e,e.$on("collapseTaskPanel",function(e,t){i.$scope.compactPanel=t}),e.openTaskPanel=function(){i.$scope.compactPanel&&i.$scope.$root.$broadcast("collapseTaskPanel",!1)}},F.TaskSection.prototype={activate:function(){var e=this._pageConfiguration;this._selectPageClass?this._task.selectPageClass(this._selectPageClass,e):this._task.configurePage(e),this._active||(this._active=!0,this._male&&this._trigger&&this.activateMalePlug(),this._select?this.activateSelection():this._female&&this.activateFemale(),this._activation++)},deactivate:function(){this._active=!1,this._male&&this.revokeMalePlug(this._male),this._select?this.deactivateSelection():this._female&&this.revokeFemalePlug(this._female);for(var e=0;e<this._plugs.length;e++)this._plugs[e].disconnect();this._plugs=[]},activateMalePlug:function(){var e=this._connectorService.getPlugDescription(this._male);this.provideMalePlug(this._male,e._pins);var t=this.getMalePlug(this._male);if(this._connectors){var i=this;this._connectors.forEach(function(e){i._connectorService.connect(t,i._connectorService.getPlugModule(e))})}else this._connectorService.connectWithAll(t);this._plugs.push(t);var n=this.$scope,o=this._trigger[1].map(function(e){return n.$eval(e)});this.trigger(this._trigger[0],o)},activateFemale:function(){for(var e=this._connectorService.getPlugDescription(this._female),t=/^([a-zA-Z0-9]+)\((.*)\)$/,i=t.exec(this._pinBinding),n={pin:i[1],param:i[2].split(",").map(function(e){return e.trim()})},o=this.$scope,r=0;r<e._pins.length;r++)this[e._pins[r]]=e._pins[r]==n.pin?this[e._pins[r]]||function(){var e=arguments;o.$apply(function(t){for(var i,o=n.param[0].split("."),r=t,a=0;a<o.length;a++)i=o[a],a===o.length-1?r[i]=e[0]:r=r[i]=r[i]||{}})}:this[e._pins[r]]||function(){};this.provideFemalePlug(this._female,e._pins);{var a=this.getFemalePlug(this._female);this._connectorService.connectWithAll(a)}this._plugs.push(a)},prepareSelections:function(){for(var e=this._selection.split(","),t=0;t<e.length;t++)this.$scope.$eval(e[t]+" = []")},activateSelection:function(){for(var e=this._select.split(","),t=this._selection.split(","),i=0;i<e.length;i++){var n=e[i];this._selections[n]||(this._selections[n]={selection:F.DI().getService("selection").getSelection(n),target:this.$scope.$eval(t[i])}),this._activation?this._selections[n].selection.setSelection(this._selections[n].target):this._resetSelection&&this._selections[n].selection.setSelection(this._selections[n].target),this.provideFemalePlug(n+"Select",["select","unselect"]);var o=this.getFemalePlug(n+"Select");this._plugs.push(o),this._connectorService.connect(o,this._selections[n].selection)}},deactivateSelection:function(){for(;this._plugs.length;)this._plugs[0].disconnect(),this._plugs.shift();var e=this._select.split(","),t=this;e.forEach(function(e){t.revokeFemalePlug(e+"Select")})},compile:function(e){if(this._source=e,this._id=e.id,this._caption=e.caption,this._startCondition=e.startCondition||"true",this._completeCondition=e.completeCondition||"true",this._description=e.description,this._optional=e.optional,this._selectPageClass=e.selectPageClass,this._pageConfiguration=e.pageConfiguration||{},this._alwaysVisible=e.alwaysVisible,this._canTransitionBackwards=e.canTransitionBackwards||!1,this._pageConfiguration.task=!0,this._select=e.select,this._selection=e.selection,this._selectionEntry=e.selectionEntry,this._selectionIcon=e.selectionIcon,this._selectionIconShow=e.selectionIconShow,this._selectSingle=e.selectSingle,this._resetSelection=e.resetSelection,this._female=e.female,this._male=e.male,this._connectors=e.connectors,this._pinBinding=e.pinBinding,this._trigger=e.trigger,this._widget=e.widget,this._icon=e.iconPath?e.iconPath:"icons/"+e.icon,this._toolbarWidget=e.toolbarWidget,this._selection&&this.prepareSelections(),this._selectionEntry&&this._select&&this._selection){var t=this._select.split(","),i=this._selection.split(","),n=this._widget;this._widget=this._toolbarWidget||"";for(var o="true",r=0;r<i.length;r++)this._widget=this._widget+'<selection selection="'+i[r]+'" alerts="alerts" name="'+t[r]+'"'+(this._selectSingle?' single="'+o+'"':"")+' template="'+this._selectionEntry+'"'+(this._selectionIcon?' icon="'+this._selectionIcon+'" iconshow="'+this._selectionIconShow+'"':"")+"/>",o=o+" && !"+i[r]+".length";this._widget=this._widget+n}},select:function(e,t){var i=this;this.$scope.$apply(function(){if(i._selections.hasOwnProperty(t))for(var n=0;n<e.length;n++)F.addUnique(i._selections[t].target,e[n]);if(1==i._index&&i._selectSingle){var o=0;for(var r in i._selections)o+=i._selections[r].target.length;o>1&&i._task.setRepeat()}})},unselect:function(e,t){var i=this;this.$scope.$apply(function(){if(i._selections.hasOwnProperty(t))for(var n=0;n<e.length;n++)F.removeFirst(i._selections[t].target,e[n]);if(1==i._index&&i._selectSingle){var o=0;for(var r in i._selections)o+=i._selections[r].target.length;2>o&&i._task.unsetRepeat()}})}},F.extend("TaskSection","PlugModule"),F.Task=function(e){F.PlugModule.call(this,e),this._description=void 0,this._panel=void 0,this._category=void 0,this._categoryIcon=void 0,this._categoryIconMargin=void 0,this._id=void 0,this._caption=void 0,this._icon=void 0,this._iconMargin=void 0,this._buttonDescription=void 0,this._executeButtonText=void 0,this._sections=void 0,this._activeSection=void 0,this._activeSectionPromise=void 0,this._taskProcessor=void 0,this._executed=!1,this.$scope=void 0,this._defer=Q.defer(),this._argument={},this._options={},this._result=new F.TaskResult,this.$compile=angular.injector(["ng","f.task"]).get("$compile"),this._alertService=F.DI().getService("alert")},F.Task.prototype={getPromise:function(){return this._defer.promise},setupDescription:function(){},setup:function(){},execute:function(){return Q.resolve()},cancel:function(){},teardown:function(){},abort:function(){return this._result._followupTask=void 0,this.clearSelections(),this.cancel(),this._defer.resolve(),this._defer.promise},queryTaskLaunch:function(){return!1},setScope:function(e){e.input={},this.$scope=e,this.setupDescription(),this.compileDescription();var t=this,i=this.setupInternal(e);Q.isPromise(i)?i.then(function(){t.activateInitialSection(),t.$scope.$apply()}).fail(function(e){Q(t._alertService.error(e.message)).then(function(){t.abort()})}):this.activateInitialSection()},setupInternal:function(e){return this.setup(e,this._argument)},executeInternal:function(){var e=this,t=this.$scope&&this.$scope.input;this._executed||(this.canBeExecuted()?(this._executed=!0,this.execute(t).then(function(t){return t instanceof F.TaskResult&&(t._infos.forEach(function(t){e._alertService.message(t,F.AlertServiceBase.DELAY_FOREVER)}),t._errors.forEach(function(t){e._alertService.error(t)}),t._errorObjs.forEach(function(t){e._alertService.errorObj(t)}),t._keepOpen)?(e._executed=!1,void e.$scope.$apply()):void e._defer.resolve()}).fail(function(t){t==F.Task.LOCAL_RECOVERY?(e._executed=!1,e.$scope.$apply()):(e._alertService.error(t.message),e._defer.resolve())}).done()):F.async(function(){this.setHint("EM_COMPLETE_TASK_STEPS")},this))},canBeExecuted:function(){return!this._description||this._sections&&this._sections.every(function(e){return e._complete})},teardownInternal:function(){return this.teardown(this._executed,this.getPromise().isFulfilled()),this.clearSelections(),this._result},clearSelections:function(){if(this._sections){var e=[];if(this._executed&&this._sections.length&&this._sections[0]._selectSingle){for(var t=this._sections[0],i=t._select.split(","),n=0;n<i.length;n++){var o=t._selections[i[n]];if(o.target.length){o.selection.unselect(o.target[0]);break}}e=i}this._sections.forEach(function(t){if(t._select){var i=t._select.split(",");i.forEach(function(t){-1==e.indexOf(t)&&F.DI().getService("selection").getSelection(t).clear()})}})}},setAttributes:function(e,t,i){this._panel=e,this._category=t,this._id=i.id,this._caption=i.caption,this._categoryIcon=t.iconPath?t.iconPath:"icons/im/taskbar/"+this._category.id+"/main.png",this._icon=i.iconPath?i.iconPath:"icons/im/taskbar/"+this._category.id+"/"+i.icon,this._categoryIconMargin=t.iconMargin?t.iconMargin:!1,this._iconMargin=i.iconMargin?i.iconMargin:!1},compileDescription:function(){this._sections=[];for(var e=0;e<this._description.length;e++){var t=this._description[e],i=new F.TaskSection(this.$scope,this._connectorService);i._task=this,i._index=e+1,i.compile(t),this._sections.push(i)}},activateInitialSection:function(){var e=0,t=this._options.taskSection;if(t)if("string"===F.typeOf(t)){var i=F.findIndex(this._sections,function(e){return e._id===t});-1!==i&&(e=i)}else"number"===F.typeOf(t)&&(e=this._options.taskSection-1);return this.setActiveSection(this._sections[e])},getNextSection:function(){var e,t,i=this._sections,n=this._activeSection,o=i.indexOf(n);if(0>o)return void 0;for(t=o+1;t<i.length;t++)if(e=i[t],e._start)return e;return void 0},getPreviousSection:function(){var e=this._sections.indexOf(this._activeSection);if(1>e)return void 0;for(var t=e-1;t>=0;--t){var i=this._sections[t];if(i._start)return i}return void 0},activateNextSection:function(){var e=this.getNextSection();return e?this.setActiveSection(e):Q.reject()},activatePreviousSection:function(){var e=this.getPreviousSection();return e?this.setActiveSection(e):Q.reject()},setActiveSection:function(e){var t=this;if(!this._activeSectionPromise){var i=this._activeSectionPromise=Q.resolve(),n=t._activeSection&&t._activeSection!==e;return i.then(function(){return n?(t._activeSection.deactivate(),t.onLeave(t._activeSection._index,t._activeSection._id)):void 0}).then(function(){return n?t.onTransition(t._activeSection._index,t._activeSection._id,e._index,e._id):void 0}).then(function(){var i=t._activeSection===e;return t._activeSection=e,t.$scope.$apply(function(){e.activate()}),t.onEnter(e._index,e._id,i)}).fail(function(e){Q(t._alertService.error(e.message)).then(function(){t.abort()})}).fin(function(){t._activeSectionPromise=void 0})}},onEnter:function(){},onTransition:function(){},onLeave:function(){},getTaskProcessor:function(){return this._taskProcessor},getPageBox:function(){return this._taskProcessor?this._taskProcessor.getPageBox():void 0},selectPageClass:function(e,t){this._taskProcessor&&this._taskProcessor.trigger("selectPageClass",[e,t])},configurePage:function(e){this._taskProcessor&&this._taskProcessor.trigger("configurePage",[e])},setHint:function(e,t){var i=this;this.$scope&&(this.$scope.$apply(function(t){t.hint=e}),setTimeout(function(){i.$scope.$apply("hint = undefined")},t||5e3))},setRepeat:function(e,t){this._result||(this._result=new F.TaskResult),this._result._followupTask={panel:this._panel,category:this._category.id,task:this._id},e&&(this._result._options=e),t&&(this._result._handover=t)},unsetRepeat:function(){var e=this._result._followupTask;e&&this._panel==e.panel&&this._category.id==e.category&&this._id==e.task&&(this._result._followupTask=void 0,this._result._options=void 0,this._result._handover=void 0)}},F.extend("Task","PlugModule"),F.Task.LOCAL_RECOVERY="local_recovery",F.TaskService=function(e){this._taskFactory={},this._validators={},this._taskCategories=e},F.TaskService.prototype={getTaskCategories:function(e){return this._taskCategories[e]},validate:function(e,t){var i=this,n=[];return t.reduce(function(t,o){return t.then(function(){return i.validateSingle(e,o).then(function(e){n.push(e)},function(){})})},Q.resolve()).then(function(){return n})},validateSingle:function(e,t){var i=this;if(!t[e])return Q.resolve(t);var n=t[e].map(function(e){return i._validators[e]()});return Q.all(n).then(function(e){if(e.some(function(e){return"string"==typeof e})){var i=new Error;throw i.reasons=e.filter(function(e){return e}),i}return t})},getTaskInstance:function(e,t,i){var n=F.findFirst(this._taskCategories[e],function(e){return e.id==t}),o=F.findFirst(n.tasks,function(e){return e.id==i});if(this._taskFactory[e][t]&&this._taskFactory[e][t][i]){var r=this._taskFactory[e][t][i],a=function(){};a.prototype=r.task.prototype;var s=[];r.injections.forEach(function(e){s.push(F.DI().get(e))});var c=new a;return r.task.apply(c,s),c.setAttributes(e,n,o),c}},addCategory:function(e,t,i){if(!(t instanceof Object)||"string"!=typeof t.id||"string"!=typeof t.caption||"string"!=typeof t.iconPath&&"string"!=typeof t.icon)throw new Error("Invalid description. Must at least contain id, caption, icon.");var n=this._taskCategories[e];if(!n)throw new Error("Panel does not exist");if(t.name=t.caption,t.tasks&&!(t.tasks instanceof Array))throw new Error("Tasks must be an array");if(t.tasks=t.tasks||[],i===F.TaskService.FIRST)n.unshift(t);else if(i){var o=F.findFirst(n,function(e){return e.id===i});if(o){var r=n.indexOf(o);n.splice(r+1,0,t)}else n.push(t)}else n.push(t)},addTask:function(e,t,i,n){if(!(i instanceof Object)||"string"!=typeof i.id||"string"!=typeof i.caption||"string"!=typeof i.iconPath&&"string"!=typeof i.icon)throw new Error("Invalid description. Must at least contain id, caption, icon.");if(!this._taskCategories[e])throw new Error("Panel does not exist");var o=this._taskCategories[e],r=F.findFirst(o,function(e){return e.id===t});if(!r)throw new Error("Category "+t+" does not exist in panel "+e);if(n===F.TaskService.FIRST)r.tasks.unshift(i);else if(n){var a=F.findFirst(r.tasks,function(e){return e.id===n});if(a){var s=r.tasks.indexOf(a);r.tasks.splice(s+1,0,i)}else r.tasks.push(i)}else r.tasks.push(i)},registerTaskFactory:function(e,t,i,n){this._taskFactory[e]=this._taskFactory[e]||{},this._taskFactory[e][t]=this._taskFactory[e][t]||{},this._taskFactory[e][t][i]={task:n,injections:F.sliceArguments(arguments,4)}},taskExists:function(e,t,i){if(!this._taskCategories[e])return!1;var n=this._taskCategories[e],o=F.findFirst(n,function(e){return e.id===t});if(!o)return!1;var r=F.findFirst(o.tasks,function(e){return e.id===i});return!!r},removeCategory:function(e,t){if(this._taskCategories[e]){var i=this._taskCategories[e];F.removeFirst(i,function(e){return e.id===t})}},removeTask:function(e,t,i){if(this._taskCategories[e]){var n=this._taskCategories[e],o=F.findFirst(n,function(e){return e.id===t});o&&F.removeFirst(o.tasks,function(e){return e.id===i})}},addValidator:function(e,t){this._validators[e]=t}},F.extend("TaskService"),F.TaskService.FIRST="_theveryfirst_",F.TaskProcessor=function(e,t,i,n){F.PlugController.call(this,e,i);this._task=t,this._url=n,this._context=new F.TaskContext,this._pageBox=void 0,this.provideFemalePlug("TaskLaunch",["launchTask"]),this.provideMalePlug("PageSelect",["selectPage","selectPageClass"]),this.provideMalePlug("PageConfigure",["configurePage"])},F.TaskProcessor.prototype={launchTask:function(e,t,i,n,o){var r=this,a=Q.defer(),s=o||{},c=n||{},l=this.getActiveTask();return l&&l.queryTaskLaunch(e,t,i)?Q.resolve():(a.resolve(new F.TaskSeed(e,t,i,c,s)),a.promise.then(function(e){return r.addCategories(e)}).then(function(e){return e.category?r.validateCategory(e):e}).then(function(e){return e.task?r.validateTask(e).then(function(){return r.getTaskInstance(e)}):e}).then(function(e){if(e){var t=r.getActiveTask();if(t)return t._result._abortedByLaunchTask=!0,t.abort().then(function(){return e})}return e}).then(function(e){return e&&(r._context.set(e),!s.noNavigation)?r.switchPage(r._context,e):void 0},function(e){throw e&&e.reasons&&r.onError(e.reasons),e}))},getActiveTask:function(){return this._context.activeTask},abortActiveTask:function(){var e=this._context.activeTask;return e?e.abort():Q.resolve()},onError:function(){},addCategories:function(e){var t=this._task.getTaskCategories(e.panel);return this._task.validate("visible",t).then(function(t){return e.categories=t,e.category=e.category||(t?t[0].id:void 0),e})},validateCategory:function(e){var t=F.findFirst(e.categories,function(t){return t.id==e.category});if(!t)throw void 0;return this._task.validateSingle("executable",t).then(function(){return e.activeCategory=t,e})},validateTask:function(e){var t=F.findFirst(e.activeCategory.tasks,function(t){return t.id==e.task});if(!t)throw void 0;return this._task.validateSingle("executable",t).then(function(){return e})},getTaskInstance:function(e){var t=this._task.getTaskInstance(e.panel,e.category,e.task);if(!t){var i=new Error;throw i.reasons=["EM_TASK_NOT_IMPLEMENTED"],i}t._taskProcessor=this,t._argument=e.handover,t._options=e.options;var n=this;return t.getPromise().done(function(){n.onTaskComplete(t)}),this.isVisualTask(t)?(e.activeTask=t,e):(t.setupInternal(),void t.executeInternal())},onTaskComplete:function(e){var t=e.teardownInternal();this._context.activeTask==e&&(this._context.activeTask=void 0),this.handleTaskResult(t)},switchPage:function(e,t){var i=e.activeCategory,n=t.options&&t.options.pageConfiguration?t.options.pageConfiguration:i.pageConfiguration;return i?i.page?this.trigger("selectPageClass",[i.page,n]):this.trigger("configurePage",[n]):Q.resolve()},isVisualTask:function(e){return!!e._description},handleTaskResult:function(e){if(e._followupTask){var t=e._followupTask;this.launchTask(t.panel,t.category,t.task,e._handover,e._options)}else e._navigateTo?this._url&&this._url.navigateTo(e._navigateTo):e._abortedByLaunchTask||this.launchTask(this._context.panel,this._context.category)},setPageBoxByID:function(e){this._pageBox=this._plug.getPlugModule(e)},getPageBox:function(){return this._pageBox}},F.extend("TaskProcessor","PlugController"),angular.module("f.task",[]),F.DI().config(function(){this.registerService("task",F.TaskService,"%taskcategories%")}),F.DI().config("@plug",F.taskConfig=function(e){e.describe("TaskLaunch",["launchTask"])}),F.TaskPanel=function(e,t,i,n,o,r){F.TaskProcessor.call(this,e,t,n,r);var a=this;this._alert=i,this._queryKey="t",this._lastLaunch=void 0,this.$scope.context=this._context,e.historyViewTask=!1,e.compactPanel=!1,e.launchTask=F.proxy(this.launchTask,this),e.$on("collapseTaskPanel",function(t,i){e.compactPanel=i,void 0!==a._lastLaunch&&(a._lastLaunch.m=i?"f":"t",a.updateURL(!0))}),e.$watch("pagebox",function(e){e&&a.setPageBoxByID(e)}),this.provideFemalePlug("URLChange",["setFragment","applyURL"]),this.connect(this,r),o&&(this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this,o))},F.TaskPanel.prototype={onError:function(e){var t=this;e.forEach(function(e){t._alert.error(e,F.AlertServiceBase.DELAY_SHORT)})},login:function(){if(this._lastLaunch){var e=this._lastLaunch;this.launchTask(e.p,e.c,void 0,void 0,{noNavigation:!0}).fail(function(){}).done()}},logout:function(){this.launchTask("default")},updateAccount:function(){},launchTask:function(e,t,i,n,o){var r=this;this._lastLaunch={p:e},t&&(this._lastLaunch.c=t),this._lastLaunch.m=this.$scope.compactPanel?"f":"t",this._url.collect();var a=n||{};a._lastPage=this._url.$location.url();var s=o||{},c=[e,t,i,a,s];return F.TaskProcessor.prototype.launchTask.apply(this,c).then(function(){r.$scope.$root.$broadcast("launchTask",e,t,i),r._context.activeTask&&(r.$scope.$root.$broadcast("collapseTaskPanel",!1),r._context.activeTask.getPromise().done(function(){r.updateURL()})),r.$scope.$apply(),r.updateURL()}).fin(function(){r._url.commit()})},updateURL:function(e){this._lastLaunch&&this._url.setFragment(this._queryKey,this._url.encode(this._lastLaunch),["v"],e)},setFragment:function(e){e.isUnresolved(this._queryKey)&&e.resolve(this._queryKey,e.get(this._queryKey).query,["v"])},applyURL:function(e,t){if(e==this._queryKey){var i=t.get(e),n=this._url.decode(i.query),o=this;this.launchTask(n.p,n.c,void 0,void 0,{noNavigation:!0}).fail(function(){o._lastLaunch=n}).done(),n.m&&this.$scope.$root.$broadcast("collapseTaskPanel","f"==n.m)}},handleTaskResult:function(e){F.TaskProcessor.prototype.handleTaskResult.call(this,e),this.$scope&&this.$scope.$apply()}},F.extend("TaskPanel","TaskProcessor"),F.DI().registerController("taskpanel",F.TaskPanel,"@task","@alert","@plug","?@login","@url"),angular.module("f.task").directive("taskpanel",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("taskpanel"),link:function(e){e.$watch("context.activeCategory",function(t,i){if(e.historyViewTask=!1,i&&e.context.categories.some(function(e){return e==i})){var n="#collapse"+i.id;$(n).collapse("hide")}if(t){var o="#collapse"+t.id;$(o).collapse("show")}}),e.$watch("context.activeTask",function(t){e.historyViewTask=void 0!==t})},scope:{pagebox:"@"},transclude:!0,templateUrl:F.partialUrl("taskpanel.html")})}),angular.module("f.task").directive("taskcontent",function(){return{controller:["$scope",function(e){e.$watch("task",function(t){t&&t.setScope(e)})}],restrict:"E",require:"^taskpanel",scope:{task:"="},templateUrl:F.partialUrl("taskcontent.html")}}),angular.module("f.task").directive("widget",["$compile",function(e){return{link:function(t,i){i.find("div").append(e(t.section._widget)(t));var n=t.section,o=n._startCondition;if(0===o.indexOf("#")){var r=o.substring(1),a=!1;o="true",t.task._sections.forEach(function(e){e._id===r&&(o=e._completeCondition,a=!0)})}t.$watch(o,function(e){n._start=!!e,n._complete=!n._start||!!t.$eval(n._completeCondition)}),t.$watch(n._completeCondition,function(e){n._start=!!t.$eval(o),n._complete=!n._start||!!e})},scope:!1,restrict:"E",require:"^taskcontent",template:'<div style="padding: 5px 0px"></div>'}}]),angular.module("f.task").directive("selection",["$compile",function(e){return{restrict:"E",compile:function(t,i){var n='<span class="f_breakAll" ng-class="{ f_textBold:(single && $index == 0), f_textItalic:(single && $index == 0), f_textInactive:(single === false || (single && $index != 0)) }" ng-bind-template="'+i.template+'"></span>';i.icon&&(n+="<img"+(i.iconshow?' ng-if="'+i.iconshow+'"':"")+' class="f_icon24" static-src="'+i.icon+'"/>');var o='<div class="col-xs-10" style="min-height:26px; padding-top:2px;"><table><tr><td><img class="f_icon20" static-src="icons/bulletpoint.png"/></td><td>'+n+'</td></tr></table></div><div class="col-xs-2"><button ng-click="entry.unselect()" class="btn btn-default" style="height:25px; width: 25px; padding:0;" title="{{\'FE_REMOVE\' | i18n}} {{entry._displayName}}"><img class="f_icon24" static-src="icons/remove.png"/></button></div>',r='<alert type="warning" ng-show="hasAlert(name, entry)" class="f_taskSelAlert">{{alertText(name, entry)}}</alert>',a='<div ng-show="selection.length > 0"><b>{{ name | selectionname | i18n}}</b><div class="container-fluid" style="padding-left:0px;"><div ng-if="selection.length > collapseThresh && !hasAlerts(name)"><div ng-show="single" class="row" ng-repeat="entry in [selection[0]]" style="margin-bottom:2px;">'+o+r+'</div><div class="row" style="margin-bottom:2px;"><div class="col-xs-10" style="min-height:26px; padding-top:2px;"><table><tr><td><img class="f_icon20" static-src="icons/bulletpoint.png"/></td><td>[{{selection.length - (single ? 1 : 0)}} {{(single ? "FE_MORE_OBJS" : "FE_OBJS") | i18n}}]</td></tr></table></div><div class="col-xs-2"><button ng-click="unselectCollapsed()" class="btn btn-default" style="height:25px; width: 25px; padding:0;" title="{{\'FE_REMOVE\' | i18n}}"><img class="f_icon24" static-src="icons/remove.png"/></button></div></div></div><div ng-if="selection.length <= collapseThresh || hasAlerts(name)"><div class="row" ng-repeat="entry in selection" style="margin-bottom:2px;">'+o+r+"</div></div></div></div>";return function(t,i,n){i.append(e(a)(t)),t.$parent.$watch(n.single,function(e){void 0!==e&&(t.single=!!e)}),t.collapseThresh=F.DI().getParameter("selectionCollapseThresh",!0)||Number.MAX_VALUE,t.unselectCollapsed=function(){var e=t.selection[0].selection();t.single?e.unselectMulti(t.selection.slice(1)):e.clear()},t.hasAlerts=function(e){return t.alerts&&t.alerts[e]&&0<Object.keys(t.alerts[e]).length},t.hasAlert=function(e,i){return t.alerts&&t.alerts[e]&&t.alerts[e][i.getID()]},t.alertText=function(e,i){return t.alerts&&t.alerts[e]&&t.alerts[e][i.getID()]?t.alerts[e][i.getID()]:""}}},scope:{selection:"=",name:"@",alerts:"="}}}]),angular.module("f.task").directive("tasktoolbar",function(){return{restrict:"E",scope:{model:"=",onchange:"&",visibility:"="},link:function(e,t,i){var n=F.DI().getParameter(i.toolbar);e.tools=n.tools,e.text=n.text,e.click=function(t){e.model=t,F.async(function(){e.$apply(function(){e.onchange({value:t})})})}},template:'<p ng-if="text">{{text | i18n}}</p><p class="btn-group f_taskToolbar"><button ng-repeat="tool in tools" ng-if="(visibility && visibility[tool.id] !== undefined) ? visibility[tool.id] : tool.showDefault" class="btn btn-default f_taskToolbarBtn" ng-class="{\'btn-info\': model==tool.id}" ng-click="click(tool.id)"><img class="f_icon24" static-src="icons/{{tool.icon}}"></button></p>'}}),angular.module("f.task").directive("edit",function(){return{link:function(e,t,i){e.$watch("source",function(t,i){e.target=t,t!==i&&e.onChange(void 0!==e.target?e.target:"")}),e.onChange=function(t){i.validation&&e.$parent[i.validation]&&(e.error=e.$parent[i.validation](t))},e.onNgChange=function(t){e.onChange(t),i.userchange&&e.$parent[i.userchange]&&e.$parent[i.userchange](t)}},restrict:"E",scope:{source:"=",target:"=",placeholder:"@",disabled:"="},template:'<input type="text" class="form-control" ng-model="target" ng-disabled="disabled" ng-change="onNgChange(target)" placeholder="{{placeholder}}"/><div class="f_textBold f_textError">{{error | i18n}}</div>'}}),angular.module("f.task").directive("editarea",function(){return{link:function(e,t,i){e.$watch("source",function(t,i){e.target=t,t!==i&&e.onChange(e.target||"")}),e.onChange=function(t){i.validation&&e.$parent[i.validation]&&(e.error=e.$parent[i.validation](t))
}},restrict:"E",scope:{source:"=",target:"=",placeholder:"@"},template:'<div><textarea class="form-control" rows="3" style="resize: none;" ng-model="target" ng-change="onChange(target)"></textarea><div class="f_textBold f_textError">{{error | i18n}}</div></div>'}}),angular.module("f.task").directive("checkbox",function(){return{link:function(e){e.$watch("source",function(t){e.target=t}),e.onClick=function(){e.target=!e.target}},restrict:"E",scope:{source:"=",target:"=",name:"@"},template:'<div ng-click="onClick()" style="cursor:pointer"><div style="display:inline-block;vertical-align: top;width:48px"><img class="f_icon48"  ng-src="'+F.imgUrl("icons/im/selected_{{target == true}}.png")+'"/></div><div style="display:inline-block;width:170px;vertical-align: top;padding-top:12px;"><div><p class="f_textM">{{name}}</p></div></div></div>'}}),angular.module("f.task").directive("radio",function(){return{link:function(e){e.onClick=function(t){t==e.selected||e.options[t].disabled&&void 0!==e.options[t].disabled()||(e.selected=t,e.change({key:t}))}},restrict:"E",scope:{options:"=",selected:"=",change:"&"},template:'<div ng-repeat="(key, value) in options" class="f_radio" ng-class="{ f_radioDisabled: value.disabled && value.disabled() }" ng-click="onClick(key)" title="{{ value.disabled() | i18n }}"><img class="f_icon32" ng-src="'+F.imgUrl("icons/im/radio_{{ key == selected }}.png")+'"/><span class="f_textM">{{ (value.label ? value.label : value) | i18n }}</span></div>'}}),F.URLService=function(e,t,i,n,o){F.PlugModule.call(this,e);var r=this;this.$location=t,this.$rootScope=i,this._defaultURL=o,this._timeout=3e3,this._root=n,this._fragments=new F.Query,this._resolve=void 0,this._delay=0,i.$on("$locationChangeStart",function(e){r._delay&&e.preventDefault()}),i.$on("$locationChangeSuccess",function(e,t){r.navigateTo(t)}),this.provideMalePlug("URLChange",["setFragment","applyURL"]),this.addConnectTrigger("URLChange",function(e,t){e._resolve&&t.trigger("setFragment",[e._resolve])})},F.URLService.prototype={navigateTo:function(e,t){var i=new F.Query(this.isQuery(e)?e:this._defaultURL);if(!i.equals(this._fragments)){this._resolve=i,this.trigger("setFragment",[i]);var n=this;i.subscribe("change",function(){n.trigger("setFragment",[i])}),i.subscribe("allResolved",function(){if(n._resolve==i){n._resolve=void 0;var e=i.getResolutionOrder();e.forEach(function(e){n.trigger("applyURL",[e,i])}),n._fragments.apply(i),n.updateURL(t)}})}},setFragment:function(e,t,i,n){this._fragments.set(e,t,i),this.updateURL(n)},getFragment:function(e){var t=this._fragments.get(e);return t?t.query:void 0},collect:function(){this._delay++},commit:function(){this._delay=Math.max(0,this._delay-1),this.updateURL()},encode:function(e){return Object.keys(e).map(function(t){var i=(e[t]+"").replace(/,/g,",,");return t+(i?":"+i:"")}).join(",")},decode:function(e){return e=e.replace(/,,/g,"&"),e.split(",").reduce(function(e,t){var i=t.split(":");if(i.length<=2&&""!==i[0]){var n=i[1]||"";e[i[0]]=n.replace(/&/g,",")}return e},{})},updateURL:function(e){if(!this._delay){var t=this._fragments.toQuery(this._root);this.isEmpty(t)||this.isCurrent(t)||(e?this.$location.search(t).replace():this.$location.search(t),F.async(this.$rootScope.$apply,this.$rootScope))}},isQuery:function(e){return-1!=e.indexOf("?")},isEmpty:function(e){return 0===Object.keys(e).length},isCurrent:function(e){var t=this.$location.search(),i=Object.keys(e);return Object.keys(t).length==i.length&&i.every(function(i){return t[i]==e[i]})}},F.extend("URLService","PlugModule"),F.Query=function(e){this._fragments={},this._listeners={},e&&this.parseQuery(e)},F.Query.prototype={set:function(e,t,i){this._fragments[e]={query:t||"",dependencies:i||[],resolved:!1}},get:function(e){return this._fragments[e]},toQuery:function(e){for(var t=F.cloneArray(e),i={};t.length>0;){var n=t.shift(),o=this.get(n);if(!o)return{};i[n]=o.query,o.dependencies.forEach(function(e){t.push(e)})}return i},toString:function(e){var t=this.toQuery(e);return Object.keys(t).map(function(e){return e+"="+t[e]}).join("&")},parseQuery:function(e){this._fragments={};var t=e.substring(Math.max(e.indexOf("?")+1,0),e.length),i=this;t.split("&").forEach(function(e){var t=e.split("=");i.set(t[0],t[1]||"")})},resolve:function(e,t,i){if(this._fragments[e]&&!this._fragments[e].resolved){this._fragments[e].query=t||"",this._fragments[e].dependencies=F.removeAll(i||[],""),this._fragments[e].resolved=!0;var n=this,o=!1;this._fragments[e].dependencies.forEach(function(e){n._fragments[e]||(n.set(e,""),o=!0)}),o&&this.notify("change"),this.allResolved()&&this.notify("allResolved")}},isUnresolved:function(e){return e&&this._fragments[e]&&!this._fragments[e].resolved},allResolved:function(){var e=this;return Object.keys(this._fragments).every(function(t){return e._fragments[t].resolved})},getResolutionOrder:function(){var e=this,t=Object.keys(this._fragments);t.forEach(function(t){e._fragments[t].temp=F.cloneArray(e._fragments[t].dependencies)});for(var i=[];t.some(function(t){return e._fragments[t].temp});){var n=F.removeFirst(t,function(t){return 0===e._fragments[t].temp.length});if(!n)return;delete e._fragments[n].temp,t.forEach(function(t){F.removeAll(e._fragments[t].temp,n)}),i.push(n)}return i},equals:function(e){var t=this;return Object.keys(this._fragments).every(function(i){return e._fragments[i]&&t._fragments[i].query==e._fragments[i].query})},apply:function(e){var t=this;Object.keys(e._fragments).forEach(function(i){t._fragments[i]=e._fragments[i]})},subscribe:function(e,t){this._listeners[e]?this._listeners[e].push(t):this._listeners[e]=[t]},notify:function(e){this._listeners[e]&&this._listeners[e].forEach(function(e){e.call(this)})}},F.extend("Query"),F.DI().registerService("url",F.URLService,"@plug","$location","$rootScope","%URLroots%","%defaultURL%"),F.DI().config("@plug",F.routeConfig=function(e){e.describe("URLChange",["setFragment","applyURL"])}),F.Embeddable=function(e,t,i){F.PlugController.call(this,e,t);var n=this;this._url=i,this._id=void 0,this._visible=!1,this._embeddedModules=[],this._page=void 0,this._configuration=void 0,e.miniView=!1,e.trigger=F.proxy(this.trigger,this),e.$on("addEmbeddedModule",function(e,t){t!=n&&(e.stopPropagation(),n.addModule(t))}),e.$on("removeEmbeddedModule",function(e,t){t!=n&&(e.stopPropagation(),n.removeModule(t))}),e.$on("$destroy",function(){e.$emit("removeEmbeddedModule",n)}),this.provideFemalePlug("URLChange",["setFragment","applyURL"]),this.connect(this,this._url)},F.Embeddable.prototype={visible:function(e){return void 0!==e&&(this.$scope.visible=e),this.$scope.visible},miniView:function(){return this.$scope.miniView},setMiniView:function(e,t){return this.$scope.miniView=e,Q.all(this._embeddedModules.map(function(i){return Q.try(i.setMiniView.bind(i,e,t))}))},preparePageChange:function(e){return this._embeddedModules.reduce(function(t,i){return i.preparePageChange(e)||t},!1)},changePage:function(e){var t=this.getPage();t&&t.changePage(e)},setID:function(e){F.PlugController.prototype.setID.call(this,e),this.$scope.$emit("addEmbeddedModule",this),e&&this.updateURL()},updateURL:function(e){var t=this._embeddedModules.map(function(e){return e._id});this._url.setFragment(this._id,t.join(","),F.cloneArray(t),e)},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query,t.query.split(","))}},applyURL:function(){},addModule:function(e){e._page=this.getPage(),F.addUnique(this._embeddedModules,e),e._page.$scope.visible?(e.onConfigure&&e.onConfigure(this._configuration),e.onShow&&e.onShow()):e.onHide&&e.onHide(),this.updateURL()},removeModule:function(e){this.getPage().$scope.visible&&e.onHide&&e.onHide(),F.removeFirst(this._embeddedModules,e),e._page=void 0,this.updateURL()},onShow:function(){this._visible=!0,this.$scope.visible=!0,this._embeddedModules.forEach(function(e){e.onShow&&e.onShow()})},onHide:function(){this._visible=!1,this.$scope.visible=!1,this._embeddedModules.forEach(function(e){e.onHide&&e.onHide()})},onConfigure:function(e){this._configuration=e,this._embeddedModules.forEach(function(t){t.onConfigure&&t.onConfigure(e)})},getPage:function(){return this._page},getPageBox:function(){var e=this.getPage();return e?e.getPageBox():void 0},isTaskActive:function(){var e=this.getPageBox();return e?e.isTaskActive():!1},selectPageClass:function(e,t){var i=this.getPageBox(),n=Q.defer();return i?F.async(function(){i.selectPageClass(e,t).then(function(){n.resolve()}).done()}):n.resolve(),n.promise},launchTask:function(e,t,i,n,o){var r=this.getPageBox();return r?r.launchTask(e,t,i,n,o):void 0}},F.extend("Embeddable","PlugController"),F.Page=function(e,t,i){F.Embeddable.call(this,e,t,i);this._class=void 0,this._pageBox=void 0},F.Page.prototype={changePage:function(e){if(this._pageBox){var t=e||{};t.page=t.page||this._id,this._pageBox.requestChange(t)}},getPage:function(){return this},getPageBox:function(){return this._pageBox}},F.extend("Page","Embeddable"),F.Page.createDirective=function(e){e.transclude=!0,e.require="^pagebox";var t=e.link;e.link=function(e,i,n,o){var r=o.$scope.ctrl,a=e.ctrl;a._class=n["class"],e["class"]=n["class"],r.addPage(a),t&&t.apply(this,arguments)};var i=F.PlugController.createDirective(e);return i},F.PageBox=function(e,t,i){F.PlugController.call(this,e,t),this._url=i,this._pageMap={},this._changes=[],this._miniViewLarge=!1,this._collecting=0,this._queryKey="v",e.displayMaximized=!1,e.taskActive=!1,e.$on("collapseTaskPanel",function(t,i){e.displayMaximized=i}),F.PageBox.instances.push(this),this.provideMalePlug("TaskLaunch",["launchTask"]),this.provideMalePlug("PageChanged",["changedPage"]),this.provideFemalePlug("PageSelect",["selectPage","selectPageClass"]),this.provideFemalePlug("PageConfigure",["configurePage"]),this.provideFemalePlug("URLChange",["setFragment","applyURL"]),this.connect(this,this._url)},F.PageBox.prototype={addPage:function(e){this._pageMap[e._id]=e,e._pageBox=this,e.visible(!1)},selectPage:function(e,t){var i=this.createTarget(F.PageBox.Action.SelectPage,t);return this._pageMap[e]&&(i.state[e]={visible:!0}),this.update(i)},selectPageClass:function(e,t){var i=this.createTarget(F.PageBox.Action.SelectPageClass,t);for(var n in this._pageMap)-1!==this._pageMap[n]._class.split(" ").indexOf(e)&&(i.state[n]={visible:!0});return this.update(i)},configurePage:function(e){var t=this.createTarget(F.PageBox.Action.ConfigurePage,e);for(var i in this._pageMap)this._pageMap[i].visible()&&(t.state[i]={visible:!0,miniView:this._pageMap[i].miniView()});return this.update(t)},update:function(e){this._updating=!0;var t,i=this.prepare(e),n=0;do{t=!1;for(var o in this._pageMap)t=this._pageMap[o].preparePageChange(i)||t;n++}while(t&&3>n);return this.apply(e)},prepare:function(e){for(var t in this._pageMap)e.state[t]||(e.state[t]={visible:!1}),e.state[t].config=e.config;return e},apply:function(e){var t=this,i=Q.defer();t._url.collect();var n=Object.keys(e.state),o=n.map(function(i){return Q.try(function(){var n=e.state[i],o=t._pageMap[i];return n.visible?Q.try(function(){return!o.miniView()&&n.miniView?o.setMiniView(!0,F.PageBox.MiniViewTransition.Open):o.miniView()&&!n.miniView?o.setMiniView(!1,F.PageBox.MiniViewTransition.Main):void 0}).then(function(){return n.config!==!1?o.onConfigure(n.config):void 0}).then(function(){return t.showPage(o)}):Q.try(function(){return o.visible()&&o.miniView()?o.setMiniView(!1,F.PageBox.MiniViewTransition.Close):void 0}).then(function(){return t.hidePage(o)}).then(function(){return n.config!==!1?o.onConfigure(n.config):void 0})})});return Q.allSettled(o).then(function(){t._url.commit(),t.updateURL(),i.resolve(),t.$scope.$apply(function(){t.$scope.taskActive=e.config&&e.config.task})}),i.promise.then(F.proxy(function(){this.trigger("changedPage",[e]),this._updating=!1},this))},isPageVisible:function(e){return this._pageMap[e]&&this._pageMap[e].visible()},isTaskActive:function(){return!!this.$scope.taskActive},showPage:function(e){var t=!e.visible();return e.visible(!0),t?e.onShow():void 0},hidePage:function(e){var t=e.visible();return e.visible(!1),t?e.onHide():void 0},swapMiniView:function(){var e=this.createTarget(F.PageBox.Action.SwapMiniView);e.config=!1;var t,i;for(var n in this._pageMap)this._pageMap[n].visible()&&!this._pageMap[n].miniView()&&(t=n),this._pageMap[n].visible()&&this._pageMap[n].miniView()&&(i=n);return t&&i?(e.state[i]={visible:!0},e.state[t]={visible:!0,miniView:!0},this.update(e)):Q.resolve()},closeMiniView:function(){var e=this.createTarget(F.PageBox.Action.CloseMiniView);e.config=!1;for(var t in this._pageMap)this._pageMap[t].visible()&&!this._pageMap[t].miniView()&&(e.state[t]={visible:!0});return this.update(e)},collect:function(){this._collecting++},isCollecting:function(){return this._collecting>0},requestChange:function(e){this._collecting&&this._changes.push(e)},commit:function(){if(0===--this._collecting&&this._changes.length>0){var e=this.createTarget(F.PageBox.Action.ChangeRequest);if(e.config=!1,this._changes.forEach(function(t){var i=t.page;e.state[i]={visible:!0},t.miniView&&(e.state[i].miniView=t.miniView,e.miniView=i)}),e.miniView&&1===Object.keys(e.state).length)for(var t in this._pageMap)!e.state[t]&&this._pageMap[t].visible()&&(e.state[t]={visible:!0});return this._changes=[],this.update(e)}return Q.resolve()},createTarget:function(e,t){return{action:e,state:{},config:t}},updateURL:function(){var e=[];for(var t in this._pageMap)this._pageMap[t].visible()&&!this._pageMap[t].miniView()&&e.push(t);this._url.setFragment(this._queryKey,e.join(","),F.cloneArray(e))},setFragment:function(e){if(e.isUnresolved(this._queryKey)){var t=e.get(this._queryKey),i=this._url.decode(t.query),n=Object.keys(i);e.resolve(this._queryKey,t.query,n)}},applyURL:function(e,t){if(e==this._queryKey){var i=t.get(this._queryKey),n=this._url.decode(i.query),o=this.createTarget(F.PageBox.Action.ApplyURL);for(var r in n)o.state[r]={visible:!0},"mv"===n[r]&&(o.state[r].miniView=!0);return this.update(o)}return Q.resolve()},launchTask:function(e,t,i,n,o){return this.trigger("launchTask",[e,t,i,n,o])}},F.extend("PageBox","PlugController"),F.PageBox.instances=[],F.PageBox.collect=function(){for(var e=0;e<F.PageBox.instances.length;e++)F.PageBox.instances[e].collect()},F.PageBox.commit=function(){for(var e=0;e<F.PageBox.instances.length;e++)F.PageBox.instances[e].commit()},F.PageBox.Action={SelectPage:"selectpage",SelectPageClass:"selectpageclass",ConfigurePage:"configurePage",SwapMiniView:"swapminiview",CloseMiniView:"closeminiview",ChangeRequest:"changerequest",ApplyURL:"applyurl"},F.PageBox.MiniViewTransition={Open:"open",Main:"main",Close:"close"},F.DI().registerController("pagebox",F.PageBox,"@plug","@url"),F.DI().registerController("page",F.Page,"@plug","@url"),F.DI().config("@plug",F.pageboxConfig=function(e){e.describe("PageSelect",["selectPage","selectPageClass"]),e.describe("PageChanged",["changedPage"]),e.describe("PageConfigure",["configurePage"]),e.describe("TaskLaunch",["launchTask"])}),angular.module("f.widget").directive("pagebox",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("pagebox"),scope:{haveTaskpanel:"@",maximizeWhenNoTask:"@"},transclude:!0,template:'<div class="f_pagebox" ng-class="{f_pageboxFullWidth: (displayMaximized && haveTaskpanel), f_pageboxNoTaskPanel: (!haveTaskpanel || (!taskActive && maximizeWhenNoTask))}" style="overflow-y:hidden;" ng-transclude></div>'})}),angular.module("f.widget").directive("page",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("page"),link:function(e,t,i,n,o){var r=n.$scope.ctrl,a=e.ctrl;a._class=i["class"],e["class"]=i["class"],e.pageBox=r,e.swapMiniView=F.async.bind(this,r.swapMiniView,r),e.closeMiniView=F.async.bind(this,r.closeMiniView,r),r.addPage(a);var s=t.find("div.f_page"),c=e.$new();o(c,function(e){s.append(e)}),e.$on("f_scroll",function(e,t){e.stopPropagation(),s[0].addEventListener("scroll",t)})},require:"^pagebox",transclude:!0,template:'<div class="{{class}} f_page" ng-class="{ f_miniView: miniView, f_miniViewSmall: !pageBox._miniViewLarge, f_miniViewLarge: pageBox._miniViewLarge }" ng-show="visible"></div><div ng-if="miniView" class="f_miniViewTools"><div class="btn-group-vertical f_actionBarVertical"><button class="btn btn-default f_actionBarBtn" style="pointer-events: auto;"  ng-click="swapMiniView()" title="{{ \'FE_SWAP_VIEW\' | i18n }}"><img class="f_actionBarIconLarge" static-src="icons/viewswap.png" /></button><button class="btn btn-default f_actionBarBtn" style="pointer-events: auto;" ng-switch="pageBox._miniViewLarge" ng-click="pageBox._miniViewLarge = !pageBox._miniViewLarge" title="{{ \'FE_CHANGE_VIEW_SIZE\' | i18n }}"><img ng-switch-when="true" class="f_actionBarIconLarge" static-src="icons/viewcollapse.png" /><img ng-switch-when="false" class="f_actionBarIconLarge" static-src="icons/viewexpand.png" /></button><button class="btn btn-default f_actionBarBtn" style="pointer-events: auto;"  ng-click="closeMiniView()" title="{{ \'FE_CLOSE_VIEW\' | i18n }}"><img class="f_actionBarIconLarge" static-src="icons/viewclose.png" /></button></div></div>'})}),F.CookieService=function(e){this._localStorage=e,this._namespace="ws",this._versionNo="1",this._separator="$",this._prefix=this._namespace+this._separator+this._versionNo+this._separator,this._cache={},this.cleanupOldVersion()},F.CookieService.prototype={cleanupOldVersion:function(){for(var e in this._localStorage){var t=e.split("$");"ws"===t[0]&&t[1]!==this._versionNo&&this.removeItemWrapper(e)}},prefixKey:function(e){return this._prefix+e},setLocalStorageItem:function(e,t){this.setItemWrapper(this.prefixKey(e),t)},getLocalStorageItem:function(e){return this.getItemWrapper(this.prefixKey(e))},getLocalStorageItemAsArray:function(e){var t=this.getItemWrapper(this.prefixKey(e));return t?t.split(","):[]},removeLocalStorageItem:function(e){this.removeItemWrapper(this.prefixKey(e))},appendLocalStorageItem:function(e,t,i){var n=this.getLocalStorageItem(e);if(n){var o=n.split(","),r=o.indexOf(t);i&&r>=0&&o.splice(r,1),o.push(t),this.setLocalStorageItem(e,o)}else this.setLocalStorageItem(e,t)},getItemWrapper:function(e){return void 0!==this._cache[e]?this._cache[e]:this._localStorage.getItem(e)},setItemWrapper:function(e,t){this._cache[e]=""+t;try{this._localStorage.setItem(e,t)}catch(i){}},removeItemWrapper:function(e){delete this._cache[e];try{this._localStorage.removeItem(e)}catch(t){}}},F.extend("CookieService"),F.ErrorService=function(){},F.ErrorService.prototype={httpHandler:function(e){var t=this;return function(i,n,o,r){var a=t.parseException(i,r,n);e instanceof Function?e(a,n):e.reject(a)}},restHandler:function(e){var t=this;return function(i){var n=t.parseException(i.data,i.config,i.status);e instanceof Function?e(n,i.status):e.reject(n)}},isCustomException:function(e){return e instanceof Array},parseException:function(e,t,i){var n;if(this.isCustomException(e)){n=e.map(function(e){var t=new Error;return t._api=!0,t._code=i,t._type=e.Type,t.message=e.Message,t._infos=e.Infos,t._callstack=e.CallStack,t});for(var o=0;o<n.length-1;o++)n[o]._previous=n[o+1]}else n=0===i?[F.connectionError]:[F.unknownError];return n[0]},isExceptionType:function(e,t){return e._type==t},hasExceptionType:function(e,t){var i=e;do{if(i._type==t)return!0;i=e._previous}while(i);return!1}},F.extend("ErrorService"),F.Script=function(e,t,i){this._scriptloader=e,this._id=t,this._url=i,this._promise=void 0},F.Script.prototype={requireOnce:function(e){var t=this.isFailed();return(!this._promise||t)&&(this._promise=this._scriptloader.loadAndEvalScript(this._url,void 0,e)),this._promise.fail(function(){var e=new Error;throw e._repeated=t,e})},isPending:function(){return this._promise&&this._promise.isPending()},isLoaded:function(){return this._promise&&this._promise.isFulfilled()},isFailed:function(){return this._promise&&this._promise.isRejected()}},F.extend("Script"),F.ScriptLoaderService=function(){this._jQuery=$},F.ScriptLoaderService.prototype={loadAndEvalScript:function(e,t,i){var n=Q.defer();if(t=this._jQuery.extend(t||{},{dataType:"script",cache:!0,url:e}),this._jQuery.ajax(t).done(function(){n.resolve()}).fail(function(){n.reject()}),void 0!==i){setTimeout(function(){n.reject()},i)}return n.promise}},F.extend("ScriptLoaderService"),F.ScriptService=function(e){this._scriptloader=e,this._registeredScripts={}},F.ScriptService.prototype={registerScript:function(e,t){this._registeredScripts[e]=new F.Script(this._scriptloader,e,t)},getScript:function(e){return this._registeredScripts[e]}},F.extend("ScriptService"),void 0===window.F_WEB_ROOT&&(window.F_WEB_ROOT="/"),void 0===window.F_WEB_ROOT_LOCAL&&(window.F_WEB_ROOT_LOCAL="/"),void 0===window.F_WEB_PREFIX&&(window.F_WEB_PREFIX="/"),void 0===window.F_WEB_PREFIX_LOCAL&&(window.F_WEB_PREFIX_LOCAL="/"),void 0===window.APP&&(window.APP={}),F.appAssetSchema=/^app:\/\/([a-z0-9][a-z0-9_-]*[a-z0-9])\/(.+)$/,F.appResource=function(e){var t=e.match(F.appAssetSchema);if(t){var i=t[1],n=window.APP,o=n[i]&&n[i].Version||"0.0.0.0",r=t[2];return"app/"+i+"/"+o+"/"+r}},F.isImgCrossOriginAvailable=function(){var e="crossOrigin"in new Image;return function(){return e}}(),F.createObjectURL=void 0,window.URL&&window.URL.createObjectURL?F.createObjectURL=window.URL.createObjectURL:window.webkitURL&&window.webkitURL.createObjectURL&&(F.createObjectURL=window.webkitURL.createObjectURL),F.imgUrl=function(e){var t=F.appResource(e);return t?window.F_WEB_ROOT+t:window.F_WEB_PREFIX+"img/"+e},function(){var e=F.isImgCrossOriginAvailable(),t=(e?window.F_WEB_PREFIX:window.F_WEB_PREFIX_LOCAL)+"img/";F.imgUrlCanvasSafe=function(e){return t+e}}(),F.partialUrlFactory=function(){var e=F.isIE()&&F.ieVersion()<12,t=e?window.F_WEB_ROOT_LOCAL:window.F_WEB_ROOT,i=(e?window.F_WEB_PREFIX_LOCAL:window.F_WEB_PREFIX)+"partials/";return function(e){var n=F.appResource(e);return n?t+n:i+e}},F.partialUrl=F.partialUrlFactory(),F.jsAssetUrl=function(e){return window.F_WEB_PREFIX+"js/assets/"+e},F.Hyperlink=function(e,t,i){this._url=e||"",this._description=t||e||"",this._provider=i||this.extractProvider()},F.Hyperlink.prototype={extractProvider:function(){var e=F.Hyperlink._providers;for(var t in e){var i=e[t].apiConfig;if(i.ownsUrl(this._url))return i.provider_id}return"extlink"}},F.extend("Hyperlink"),F.Hyperlink.registerProvider=function(e){var t=e.apiConfig.provider_id;F.Hyperlink._providers[t]=e},F.Hyperlink._providers={},void 0===window.F_CDN&&(window.F_CDN=""),F.SignedURLService=function(e,t,i){this.$http=e,this._error=t,this._URL=i,this._signatures={},this._promises={}},F.SignedURLService.prototype={hasCDN:function(){return!!window.F_CDN},getSignature:function(e,t){return t&&this.isExpired(e)&&delete this._signatures[e],this._signatures[e]?this._signatures[e]:this.loadSignature(e)},loadSignature:function(e){if(this._promises[e])return this._promises[e];var t=this,i=Q.defer();this._promises[e]=i.promise;var n={method:"GET",url:this._URL+e};return this.$http(n).success(function(n){delete t._promises[e],n.Signatures.forEach(function(e){e.Query="?Policy="+e.Policy+"&Signature="+e.Signature+"&Key-Pair-Id="+n.KeyPairID}),t._signatures[e]=n,i.resolve(n)}).error(this._error.httpHandler(function(n){delete t._promises[e],i.reject(n)})),i.promise},isExpired:function(e,t){var i=this._signatures[e],n=void 0===t?30:t;if(i){var o=i.Expires-n-Date.now()/1e3;return 0>o}return!0},getSource:function(e,t){var i=e.Signatures;return i[t%i.length]}},F.extend("SignedURLService"),F.DI().config(function(){this.registerService("cookie",F.CookieService,"$localStorage"),this.registerService("error",F.ErrorService),this.registerService("scriptloader",F.ScriptLoaderService),this.registerService("script",F.ScriptService,"@scriptloader")}),F.linkifyWeb=function(e){return e?"http:"===e.substr(0,5)||"https:"===e.substr(0,6)||"mailto:"===e.substr(0,7)||"ftp:"===e.substr(0,4)?e:0<=e.indexOf("@")?"mailto:"+e:"http://"+e:""},F.linkifyLocal=function(e,t){if(!e)return"";if("www."===e.substr(0,4))return"http://"+e;if("http:"===e.substr(0,5)||"https:"===e.substr(0,6)||"mailto:"===e.substr(0,7)||"ftp:"===e.substr(0,4))return e;if(0<=e.indexOf("@"))return"mailto:"+e;var i=e.length-1,n=e[i];("/"===n||"\\"===n)&&(e=e.substr(0,i));var o=e.lastIndexOf("\\");return 0>o&&(o=e.lastIndexOf("/")),o>=0?t+e.substr(o+1):t+e},angular.module("f.filter").filter("linkify",function(){var e=F.DI().getParameter("linkifyDocsRoot",!0);return e?function(t){return F.linkifyLocal(t,e)}:F.linkifyWeb}),angular.module("f.util").directive("backImg",function(){return function(e,t,i){i.$observe("backImg",function(e){e?t.css({"background-image":"url('"+e+"')"}):t.css("background-image","")})}}),angular.module("f.util").directive("staticBackImg",function(){return function(e,t,i){i.$observe("staticBackImg",function(e){e?t.css({"background-image":"url('"+F.imgUrl(e)+"')"}):t.css("background-image","")})}}),angular.module("f.util").directive("staticSrc",function(){return function(e,t,i){i.$observe("staticSrc",function(e){i.$set("src",F.imgUrl(e))})}}),angular.module("f.util").directive("staticHref",function(){return function(e,t,i){i.$observe("staticHref",function(e){i.$set("href",window.F_WEB_PREFIX+e)})}}),angular.module("f.util").directive("asyncpartial",["$compile",function(e){return{link:function(t,i,n){var o=t.$watch(n.firstload,function(r){if(r){var a=e("<notag ng-include=\"'"+F.partialUrl(n.partial)+"'\"></notag>")(t);i.replaceWith(a),o()}})},restrict:"E",template:"<div/>"}}]),angular.module("f.util").directive("fallbackSrc",function(){return{link:function(e,t,i){t.bind("error",function(){angular.element(this).attr("src",F.imgUrl(i.fallbackSrc))})}}}),F.LocalizedStrings=F.LocalizedStrings||{},F.LocaleService=function(e,t){F.PlugModule.call(this,t);this._script=e;var i=[];F.LocaleService.Languages.forEach(function(t){var n=t.resource.toLowerCase();i.indexOf(n)<0&&(e.registerScript("fe_strings_"+t.resource,F.jsAssetUrl("webshare-strings."+n+".js")),i.push(n))}),this._activeLanguage=F.LocaleService.Languages[0],this._activeLanguageToSet=F.LocaleService.Languages[0],this._defaultLanguage=F.LocaleService.Languages[0],this._activeLanguageStrings={IM_STRING_NOT_FOUND:""},this._defaultLanguageStrings=this._activeLanguageStrings,this._haveAnyStrings=!1,this._pendingAddition={},this.setLanguage(this._defaultLanguage.id,!0),this.provideMalePlug("SettingsUpdate",["updateSettings"])},F.LocaleService.prototype={translate:function(e){return e?this._activeLanguageStrings[e]||this._defaultLanguageStrings[e]||(this._haveAnyStrings?this._activeLanguageStrings.IM_STRING_NOT_FOUND+" ("+e+")":""):""},addStrings:function(e,t){if(this.isLoaded(e)){for(var i in t)F.LocalizedStrings[e][i]=t[i];this.digestAllScopes()}else this._pendingAddition[e]=this._pendingAddition[e]||[],this._pendingAddition[e].push(t)},addResourceScript:function(e,t){if(this.isLoaded(e)){var i=F.appResource(t);i||(i=t),this._script.registerScript(t,i),this._script.getScript(t).requireOnce().fail(function(){}).done()}else this._pendingAddition[e]=this._pendingAddition[e]||[],this._pendingAddition[e].push(t)},setDefaultLanguage:function(){this.setLanguage(this._defaultLanguage.id,!0)},setLanguage:function(e){var t=this.getLanguages(),i=F.findFirst(t,function(t){return t.id===e}),n=this;if(!i)return Q.reject();this._activeLanguageToSet=i;var o=Q.defer(),r=function(){i.id===n._defaultLanguage.id&&(n._defaultLanguageStrings=F.LocalizedStrings[i.resource]),i.id===n._activeLanguageToSet.id&&(n._activeLanguage=i,n._activeLanguageStrings=F.LocalizedStrings[i.resource]),n._haveAnyStrings=!0,n.digestAllScopes(),n.trigger("updateSettings",["language",[]]),o.resolve()};return this.isLoaded(i.resource)?F.async(r):this._script.getScript("fe_strings_"+i.resource).requireOnce().then(function(){var e=n._pendingAddition[i.resource];e&&(e.forEach(function(e){"string"==typeof e?n.addResourceScript(i.resource,e):n.addStrings(i.resource,e)}),n._pendingAddition[i.resource]=void 0),r()},function(e){o.reject(e)}).done(),o.promise},getLanguages:function(){return F.LocaleService.Languages},getActiveLanguage:function(){return this._activeLanguage},isLoaded:function(e){return!!F.LocalizedStrings[e]},composeMessage:function(e,t){for(var i="",n=e.split("%VAR%"),o=0;o<t.length;o++)i+=n[o]+t[o];return n.length>t.length&&(i+=n[o]),i},translateAndCompose:function(e,t){var i=this.translate(e);return i&&t&&t.length>0&&(i=this.composeMessage(i,t)),i},getOccurences:function(e,t){for(var i,n=new RegExp(t,"g"),o=[];i=n.exec(e);)o.push(i.index);return o},digestAllScopes:function(){var e=document.getElementsByClassName("ng-scope");Array.prototype.forEach.call(e,function(e){angular.element(e).scope().$digest()})}},F.extend("LocaleService","PlugModule"),F.LocaleService.Languages=[{id:"en_US",resource:"en_US",caption:"English (US)",icon:"en_US.png"},{id:"en_UK",resource:"en_US",caption:"English (UK)",icon:"en_UK.png"},{id:"de_DE",resource:"de_DE",caption:"Deutsch",icon:"de_DE.png"},{id:"fr_FR",resource:"fr_FR",caption:"Franais",icon:"fr_FR.png"},{id:"it_IT",resource:"it_IT",caption:"Italiano",icon:"it_IT.png"},{id:"ja_JP",resource:"ja_JP",caption:"",icon:"ja_JP.png"},{id:"es_ES",resource:"es_MX",caption:"Espaol (ESP)",icon:"es_ES.png"},{id:"es_MX",resource:"es_MX",caption:"Espaol (MX)",icon:"es_MX.png"},{id:"pl_PL",resource:"pl_PL",caption:"Polski",icon:"pl_PL.png"},{id:"pt_PT",resource:"pt_BR",caption:"Portugus (PT)",icon:"pt_PT.png"},{id:"pt_BR",resource:"pt_BR",caption:"Portugus (BR)",icon:"pt_BR.png"},{id:"zh_CN",resource:"zh_CN",caption:"",icon:"zh_CN.png"}],F.DI().config(function(){this.registerService("locale",F.LocaleService,"@script","@plug")}),angular.module("f.filter").filter("i18n",function(){var e=F.DI().getService("locale");return function(t,i){return e.translateAndCompose(t,i)}}),angular.module("f.filter").filter("date",function(){var e=F.DI().getService("locale");return function(t,i){return F.isDefaultDate(t)?e.translate("FE_UNKNOWN"):i?F.getDateOfDateTimeStr(t):t}}),angular.module("f.filter").filter("dateperiod",function(){var e=F.DI().getService("locale");return function(t,i){var n=F.isDefaultDate(t[0]),o=F.isDefaultDate(t[1]);if(n&&o)return e.translate("FE_UNKNOWN");var r=i?F.getDateOfDateTimeStr(t[0]):t[0],a=i?F.getDateOfDateTimeStr(t[1]):t[1];return n?a:o||r===a?r:r+"  "+a}}),F.makeCRCTable=function(){for(var e,t=[],i=0;256>i;i++){e=i;for(var n=0;8>n;n++)e=1&e?3988292384^e>>>1:e>>>1;t[i]=e}return t},F.crc32=function(e){for(var t=F.crc32._crcTable||(F.crc32._crcTable=F.makeCRCTable()),i=-1,n=0;n<e.length;n++)i=i>>>8^t[255&(i^e.charCodeAt(n))];return(-1^i)>>>0},F.EncryptionService=function(){},F.EncryptionService.prototype={encrypt:function(e){return this.base64_encode(e)},base64_encode:function(e){var t,i,n,o,r,a,s,c,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h=0,d=0,u="",p=[];if(!e)return e;do t=e.charCodeAt(h++),i=e.charCodeAt(h++),n=e.charCodeAt(h++),c=t<<16|i<<8|n,o=c>>18&63,r=c>>12&63,a=c>>6&63,s=63&c,p[d++]=l.charAt(o)+l.charAt(r)+l.charAt(a)+l.charAt(s);while(h<e.length);u=p.join("");var _=e.length%3;return(_?u.slice(0,_-3):u)+"===".slice(_||3)},base64_decode:function(e){var t,i,n,o,r,a,s,c,l="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",h=0,d=0,u="",p=[];if(!e)return e;e+="";do o=l.indexOf(e.charAt(h++)),r=l.indexOf(e.charAt(h++)),a=l.indexOf(e.charAt(h++)),s=l.indexOf(e.charAt(h++)),c=o<<18|r<<12|a<<6|s,t=c>>16&255,i=c>>8&255,n=255&c,p[d++]=64==a?String.fromCharCode(t):64==s?String.fromCharCode(t,i):String.fromCharCode(t,i,n);while(h<e.length);return u=p.join("")},crc32:function(e){return F.crc32(e)}},F.extend("EncryptionService"),F.DI().config(function(){this.registerService("encryption",F.EncryptionService)}),F.ChangeObject=function(){this._changes=Object.create(this)},F.ChangeObject.prototype={cleanUpChanges:function(){var e=this,t=this._changes;Object.keys(t).forEach(function(i){t[i]instanceof Function||t[i]!=e[i]||delete t[i]})},hasUnsavedChanges:function(){return this.cleanUpChanges(),Object.keys(this._changes).length>0
},applyChanges:function(){this.copyChangesToOrigin(),this.discardChanges()},discardChanges:function(){var e=this;Object.keys(this._changes).forEach(function(t){delete e._changes[t]})},copyChangesToOrigin:function(){this.cleanUpChanges();var e=this,t=this._changes;Object.keys(t).forEach(function(i){t[i]instanceof Function||t[i]==e[i]||(e[i]=t[i])})},matchesJson:function(){},readJson:function(){},writeJson:function(){},writeChanges:function(){this.cleanUpChanges();var e=this._changes.writeJson(),t={};return Object.keys(this._changes).forEach(function(i){var n=i.charAt(1).toUpperCase()+i.substr(2);e.hasOwnProperty(n)&&(t[n]=e[n])}),t.Class=e.Class,t},applyUpdate:function(e){e?(this.readJson(e),this.discardChanges()):this.applyChanges()}},F.extend("ChangeObject"),F.Serializer=function(){this._classes={}},F.Serializer.prototype={read:function(e){if(e instanceof Array){for(var t=0;t<e.length;t++)e[t]=this.read(e[t]);return e}if(e instanceof Object){if(e.Class&&this._classes[e.Class]){var i=this._classes[e.Class]();return i.readJson(e),i}return e}return e},registerClass:function(e,t){this._classes[e]=t}},F.extend("Serializer"),F.CRUDService=function(e,t,i,n,o,r,a,s,c){F.PlugModule.call(this,s),this._serializer=o,this._error=r,this._constructor=t,this._entities=[],this._resource=c,this._restClient=this._resource(i+"/:id",n,{create:{method:"POST",params:{}},read:{method:"GET",params:{}},readAll:{method:"GET",params:{},isArray:!0},edit:{method:"PUT",params:{}},remove:{method:"DELETE",params:{},isArray:!0},action:{method:"POST",params:{}},arrayAction:{method:"POST",params:{},isArray:!0}}),this._selection=new F.Selection(e,this._entities,s),this._filter=function(){return!0},a.registerSelection(e,this._selection),this.provideMalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"])},F.CRUDService.prototype={getNew:function(e){var t=new this._constructor(this);return e&&t.readJson(e),t},getAll:function(e,t){var i=this,n=Q.defer();return this._restClient.readAll(e||{},function(e){Q.try(i.updateInternalMultiple.bind(i,e)).then(function(){var e=t||function(){return!0};n.resolve(i._entities.filter(e))},n.reject)},this._error.restHandler(n)),n.promise},getAllFromServer:function(e,t){var i=this,n=Q.defer();return this._restClient.readAll(e||{},function(e){var o=i._serializer.read(e);t&&(o=o.filter(t)),n.resolve(o)},this._error.restHandler(n)),n.promise},getAllWith:function(e,t,i){var n=t||{};return n["with"]=e,this.getAll(n,i)},getByIDs:function(e,t,i){var n=F.curry(this.getByID,3,!0,t||{},i);return Q.all(e.map(F.proxy(n,this)))},getByID:function(e,t,i,n){var o=Q.defer(),r=F.findFirst(this._entities,function(t){return t.getID()===e});if(r)Q.try(this.handleSingleEntity.bind(this,r)).then(o.resolve.bind(o,r),o.reject.bind(o));else{if(!i)return this.getSingle(e,t,n);this.getAll(t).then(function(t){var i=F.findFirst(t,function(t){return t.getID()===e});i?o.resolve(i):o.reject(new Error("EM_RESOURCE_NOT_FOUND"))}).done()}return o.promise},create:function(e,t){var i=Q.defer(),n=this;return this._restClient.create(t||{},e.writeJson(),function(t){e.readJson(t),Q.try(n.handleSingleEntity.bind(n,e)).then(function(){n._filter(e)?(n._entities.push(e),Q.try(n.handleEntityChanges.bind(n,[e],[],[])).then(i.resolve.bind(i,e),i.reject.bind(i))):i.resolve()})},this._error.restHandler(i)),i.promise},update:function(e,t){var i=Q.defer(),n=t||{};n.id=e.getID();var o=this;return this._restClient.edit(n,e.writeChanges(),function(t){e.applyUpdate(t),Q.try(o.handleSingleEntity.bind(o,e)).then(o.postUpdate.bind(o,e)).then(i.resolve.bind(i,e),i.reject)},this._error.restHandler(function(t){o._error.isExceptionType(t,"FindObjectException")&&o.removeSingleInternal(e),i.reject(t)})),i.promise},remove:function(e,t,i){var n=Q.defer(),o=t||{};o.id=e.getID();var r=this,a=i||null;return this._restClient.remove(o,a,function(){r.removeSingleInternal(e),n.resolve()},this._error.restHandler(function(t){r._error.isExceptionType(t,"FindObjectException")?(r.removeSingleInternal(e),n.resolve()):n.reject(t)})),n.promise},action:function(e,t){var i=Q.defer();return this._restClient.action(t||{},e,function(e){i.resolve(e)},this._error.restHandler(i)),i.promise},arrayAction:function(e,t){var i=Q.defer();return this._restClient.arrayAction(t||{},e,function(e){i.resolve(e)},this._error.restHandler(i)),i.promise},entityAction:function(e,t,i){var n=i||{};n.id=e.getID();var o=this;return this.action(t,n).then(function(t){e.readJson(t);var i=o._entities.indexOf(e);!o._filter(e)&&i>-1&&(F.removeFirst(this._entities,e),o.trigger("removeObject",[e]))})},getSingle:function(e,t,i){var n=this,o=Q.defer(),r=t||{};return r.id=e,this._restClient.read(r,function(e){n.updateInternalSingle(e,i).then(function(e){e?o.resolve(e):o.reject(new Error("EM_RESOURCE_NOT_FOUND"))})},this._error.restHandler(o)),o.promise},updateInternalSingle:function(e,t){var i,n=F.findFirst(this._entities,function(t){return t.matchesJson(e)}),o=[],r=[],a=[];n?(n.readJson(e),this._filter(n)?(r.push(n),i=n):(F.removeFirst(this._entities,n),a.push(n),i=t?void 0:n)):(n=this._serializer.read(e),this._filter(n)?(this._entities.push(n),o.push(n),i=n):i=t?void 0:n);var s=Q.resolve();return i&&(s=s.then(this.handleSingleEntity.bind(this,i))),s.then(this.handleEntityChanges.bind(this,o,r,a)).thenResolve(i)},updateInternalMultiple:function(e){for(var t=[];this._entities.length;)t.push(this._entities.shift());var i=[],n=[],o=this;return e.forEach(function(e){var r=F.removeFirst(t,function(t){return t.matchesJson(e)});if(r)r.readJson(e),o._filter(r)?(o._entities.push(r),n.push(r)):t.push(r);else{var a=o._serializer.read(e);o._filter(a)&&(o._entities.push(a),i.push(a))}}),this.handleEntityChanges(i,n,t)},handleSingleEntity:function(){},handleEntityChanges:function(e,t,i){i.length>0&&(this._selection.unselectMulti(i),this.trigger("removeObjects",[i])),t.length>0&&this.trigger("updateObjects",[t]),e.length>0&&this.trigger("addObjects",[e])},removeSingleInternal:function(e){var t=this._entities.indexOf(e);t>-1&&(this._entities.splice(t,1),this._selection.unselect(e),this.trigger("removeObjects",[[e]]))},removeInternal:function(){for(this._selection.unselectMulti(this._entities),this.trigger("removeObjects",[F.cloneArray(this._entities)]);this._entities.length;)this._entities.shift()},postUpdate:function(e){var t=-1!==this._entities.indexOf(e),i=this._filter(e);t&&i?this.handleEntityChanges([],[e],[]):i?(this._entities.push(e),this.handleEntityChanges([e],[],[])):t&&(F.removeFirst(this._entities,e),this.handleEntityChanges([],[],[e]))}},F.extend("CRUDService","PlugModule"),F.CRUDObject=function(e){this._service=e,this._selected=!1},F.CRUDObject.prototype={create:function(){return this._service.create instanceof Function&&this._service.create(this)},update:function(e){return this._service.update instanceof Function&&this._service.update(this,e)},remove:function(e){return this._service.remove instanceof Function&&this._service.remove(this,void 0,e)},getID:function(){},selection:function(){return this._service._selection}},F.extend("CRUDObject","ChangeObject"),F.mixin("CRUDObject","Selectable"),F.DI().registerService("serializer",F.Serializer),F.addObjectsByID=function(e,t){var i=!1,n={};e.forEach(function(e){n[e.getID()]=!0});for(var o=0;o<t.length;o++)n.hasOwnProperty(t[o].getID())||(e.push(t[o]),i=!0);return i},F.removeObjectsByID=function(e,t){for(var i=!1,n={};e.length;){var o=e.pop();n[o.getID()]=o}for(var r=0;r<t.length;r++)n.hasOwnProperty(t[r].getID())&&(delete n[t[r].getID()],i=!0);for(var a in n)e.push(n[a]);return i},F.AccountService=function(e,t,i){this.$http=e,this._encryption=t,this._error=i},F.AccountService.prototype={create:function(e,t,i,n,o){var r=Q.defer();return this.$http({method:"POST",url:"/user/createuser",data:{firstname:e,middlename:t,lastname:i,username:n,password:this._encryption.encrypt(o)}}).success(function(){r.resolve()}).error(this._error.httpHandler(r)),r.promise},validateAccount:function(e){var t=Q.defer();return this.$http({method:"POST",url:"/user/validateaccount",data:{token:e}}).success(function(){t.resolve()}).error(this._error.httpHandler(t)),t.promise},changePassword:function(e,t){var i=Q.defer();return this.$http({method:"POST",url:"/user/applynewpassword",data:{token:e,password:this._encryption.encrypt(t)}}).success(function(){i.resolve()}).error(this._error.httpHandler(i)),i.promise},resetPassword:function(e){var t=Q.defer();return this.$http({method:"POST",url:"/user/resetpassword",data:{email:e}}).success(function(){t.resolve()}).error(this._error.httpHandler(t)),t.promise},sanitizeToken:function(e){var t=decodeURIComponent(e.replace(/\+/g,"%20"));return t.replace(/\s/g,"")},updateSettings:function(e){var t=Q.defer();return this.$http({method:"PUT",url:"/user/settings/"+e.getID(),data:e.writeChanges()}).success(function(i){e.applyUpdate(i),t.resolve()}).error(this._error.httpHandler(t)),t.promise},updateMe:function(e){var t=Q.defer();return this.$http({method:"PUT",url:"/domain/updateme",data:e.writeChanges()}).success(function(i){e.applyUpdate(i),t.resolve()}).error(this._error.httpHandler(t)),t.promise}},F.extend("AccountService"),F.LoginServiceBase=function(e,t,i,n){F.PlugModule.call(this,n),this._error=e,this._http=t,this._encryption=i,this._listeners={},this._me=void 0,this._meDefer=void 0,this.provideMalePlug("Login",["login","logout","updateAccount"])},F.LoginServiceBase.prototype={setMe:function(e){var t=void 0!==this._me;this._me=e,this._meDefer.resolve(),t?(this.notify("update"),this.trigger("updateAccount")):(this.notify("login"),this.trigger("login"))},resetMe:function(){var e=!!this._me;this._me=void 0,e&&(this.notify("logout"),this.trigger("logout")),this._meDefer&&this._meDefer.resolve()},login:function(e,t){var i=this._encryption.encrypt(e),n=this._encryption.encrypt(t);this._meDefer=Q.defer();var o=Q.defer(),r={method:"POST",url:"/login_user_info?_username="+encodeURIComponent(i)+"&_password="+encodeURIComponent(n)},a=this;return this._http(r).success(function(e){a.setMe(e),o.resolve()}).error(this._error.httpHandler(function(e){a.resetMe(),o.reject(e)})),o.promise},logout:function(){var e=Q.defer(),t={method:"POST",url:"/logout"},i=this;return this._http(t).success(function(){i._meDefer=Q.defer(),i.resetMe(),e.resolve()}).error(this._error.httpHandler(e)),e.promise},isLoggedIn:function(){var e=this;return this.getMe().then(function(){return void 0!==e._me})},getUserID:function(){var e=this;return this.getMe().then(function(){return e._me?e._me.Id:null})},getUsername:function(){var e=this;return this.getMe().then(function(){return e._me?e._me.Username:null})},getFirstname:function(){var e=this;return this.getMe().then(function(){return e._me?e._me.Firstname:null})},getMiddlename:function(){var e=this;return this.getMe().then(function(){return e._me?e._me.Middlename:null})},getLastname:function(){var e=this;return this.getMe().then(function(){return e._me?e._me.Lastname:null})},getSettings:function(){var e=this;return this.getMe().then(function(){return e._me?e._me.UserSettings:null})},getMe:function(e){if(!e&&this._meDefer)return this._meDefer.promise;this._meDefer=Q.defer();var t={method:"GET",url:"/domain/whoami"},i=this;return this._http(t).success(function(e){i.setMe(e)}).error(this._error.httpHandler(function(e){i._error.isExceptionType(e,"AuthenticationException")?i.resetMe():i._meDefer.reject(e)})),this._meDefer.promise},refresh:function(){return this.getMe(!0)},subscribe:function(e,t){this._listeners[e]?this._listeners[e].push(t):this._listeners[e]=[t]},notify:function(e){this._listeners[e]&&this._listeners[e].forEach(function(e){e.call(this)})}},F.extend("LoginServiceBase","PlugModule"),F.UserLocaleService=function(e,t,i){F.LocaleService.call(this,e,t);var n=this,o=function(){i.getSettings().then(function(e){n.updateLanguageBySettings(e)}).done()},r=function(){n.setDefaultLanguage(!0)};i.subscribe("login",o),i.subscribe("logout",r),i.subscribe("update",o)},F.UserLocaleService.prototype={updateLanguageBySettings:function(e){e&&e.Language&&this.setLanguage(e.Language)}},F.extend("UserLocaleService","LocaleService"),F.UserBase=function(e){F.CRUDObject.call(this,e),this._ID=void 0,this._firstname="",this._middlename="",this._lastname="",this._username=""},F.UserBase.prototype={getID:function(){return this._ID},matchesJson:function(e){return this._ID===e.Id},getUsername:function(){return this._username},readJson:function(e){this._ID=e.Id,this._firstname=e.Firstname,this._middlename=e.Middlename,this._lastname=e.Lastname,this._username=e.Username},writeJson:function(){var e={};return e.Class="UserBase",e.Id=this._ID,e.Firstname=this._firstname,e.Middlename=this._middlename,e.Lastname=this._lastname,e.Username=this._username,e},getName:function(){var e=[];return"string"==typeof this._firstname&&this._firstname.length>0&&e.push(this._firstname),"string"==typeof this._lastname&&this._lastname.length>0&&e.push(this._lastname),e.join(" ")},getNameAndUsername:function(){var e=this.getName();return e.length>0?e+" <"+this._username+">":this._username}},F.extend("UserBase","CRUDObject"),F.UserServiceBase=function(e,t,i,n,o,r,a,s){a=a||F.UserBase,s=s||"/admin/user",F.CRUDService.call(this,"User",a,s,{},e,t,n,o,r);var c=this;i.subscribe("logout",function(){c.removeInternal()})},F.UserServiceBase.prototype={},F.extend("UserServiceBase","CRUDService"),F.UserSettingsBase=function(){F.ChangeObject.call(this),this._ID=void 0,this._units="",this._areaunit="",this._angleUnit="",this._language="",this._currency="",this._timezone=null,this._coordSystem=""},F.UserSettingsBase.prototype={getID:function(){return this._ID},matchesJson:function(e){return this._ID===e.Id},readJson:function(e){this._ID=e.Userid,this._units=e.Units,this._areaunit=e.Areaunit,this._angleUnit=e.AngleUnit,this._language=e.Language,this._currency=e.Currency,this._timezone=e.Timezone,this._coordSystem=e.CoordSystem},writeJson:function(){var e={};return e.Class="UserSettingsBase",e.Userid=this._ID,e.Units=this._units,e.Areaunit=this._areaunit,e.AngleUnit=this._angleUnit,e.Language=this._language,e.Currency=this._currency,e.Timezone=this._timezone,e.CoordSystem=this._coordSystem,e}},F.extend("UserSettingsBase","ChangeObject"),angular.module("f.user",[]),void 0===window.F_USER_DIRECTORY&&(window.F_USER_DIRECTORY=""),F.DI().registerService("user",F.UserServiceBase,"@serializer","@error","@login","@selection","@plug","$resource"),F.DI().registerService("account",F.AccountService,"$http","@encryption","@error"),F.DI().registerService("login",F.LoginServiceBase,"@error","$http","@encryption","@plug"),F.DI().config(function(){this.redefineService("locale",F.UserLocaleService,"@script","@plug","@login")}),F.userBaseConfigSerializer=function(e,t){e.registerClass("UserBase",function(){return t.getNew()})},F.authenticationException=new Error("EXCEPTION_MESSAGE_AUTHENTICATION"),F.authenticationException._type="AuthenticationException",F.DI().config("@plug",F.userConfig=function(e){e.describe("Login",["login","logout","updateAccount"])}),F.DI().config("?@task","@login",F.userConfigValidators=function(e,t){e&&e.addValidator("login",function(){var e="EM_NO_LOGIN";return t.isLoggedIn().then(function(t){return t?void 0:e},function(){return e})})}),angular.module("f.user").filter("userfilter",function(){return function(e,t){return e.filter(function(e){return t?e._firstname&&-1!==e._firstname.toLowerCase().indexOf(t.toLowerCase())||e._lastname&&-1!==e._lastname.toLowerCase().indexOf(t.toLowerCase())||e._username&&-1!==e._username.toLowerCase().indexOf(t.toLowerCase())?e:void 0:e})}}),F.CreateAccountBox=function(e,t,i,n){F.Embeddable.call(this,e,i,n);var o=this;e.formData={},this._promise=void 0,e.getPromise=function(){return o._promise},e.submit=function(i){var n=e.formData;e.canSubmit()&&(o._promise=t.create(n.firstname,n.middlename||"",n.lastname,n.username,n.password),o._promise.then(function(){o.$scope.$apply(function(){o.$scope.formData={},i.$setPristine()})}).done())},e.notValidNames=/^[a-z A-Z]+$/,e.validatePassword=function(){if(void 0===e.formData.password)return!1;var t=F.validatePassword(e.formData.password);return e.passwordsEqual()&&void 0===t},e.passwordsEqual=function(){return e.formData.confirmPassword===e.formData.password},e.canSubmit=function(){var t=e.getPromise();return e.validatePassword()&&e.formData.termsAccepted&&e.formData.firstname&&e.formData.lastname&&e.formData.username&&(void 0===t||!t.isPending())}},F.CreateAccountBox.prototype={onShow:function(){F.Embeddable.prototype.onShow.call(this),this.$scope.formData={}}},F.extend("CreateAccountBox","Embeddable"),F.LoginBox=function(e,t,i,n,o,r){F.Embeddable.call(this,e,n,o);var a=this;this._login=t,this._cookie=i,this._nextURL=void 0,this._cookieID=r,this._promise=void 0,e.getPromise=function(){return a._promise},this._loginPromise=void 0,this._logoutPromise=void 0,e.getLoginPromise=function(){return a._loginPromise},e.getLogoutPromise=function(){return a._logoutPromise},e.usernameList=this._cookie.getLocalStorageItemAsArray(this._cookieID),e.credentials={username:e.usernameList[e.usernameList.length-1],password:""},e.userDirectory=window.F_USER_DIRECTORY,e.login=function(t,i,n){t&&i&&(a._loginPromise=a._login.login(t,i),a._loginPromise.then(function(){a.setCookie(t),a.refresh(),a._nextURL&&a._url.navigateTo(a._nextURL)},function(){}).done(),e.credentials.password="",n.$setPristine())},e.logout=function(){a._logoutPromise=a._login.logout(),a._logoutPromise.then(function(){a.refresh(),a.$scope.$apply()},function(){}).done()},e.loadLostPassword=function(){a.selectPageClass("lostpassword",{username:e.credentials.username})},e.createAccount=function(){a.selectPageClass("createaccount")}},F.LoginBox.prototype={setCookie:function(e){this._cookie.appendLocalStorageItem(this._cookieID,e,!0);var t=this;this.$scope.$apply(function(e){e.usernameList=t._cookie.getLocalStorageItemAsArray(t._cookieID)})},refresh:function(){this._promise=this._login.getUsername(),this._loginPromise=void 0,this._logoutPromise=void 0},onShow:function(){F.Embeddable.prototype.onShow.call(this),this.refresh()},onConfigure:function(e){this._nextURL=void 0,e&&(this._nextURL=e.nextURL)}},F.extend("LoginBox","Embeddable"),F.LostPasswordBox=function(e,t,i){F.Embeddable.call(this,e,t,i);e.username=""},F.LostPasswordBox.prototype={onConfigure:function(e){this.$scope.username="",e&&e.username&&(this.$scope.username=e.username)}},F.extend("LostPasswordBox","Embeddable"),F.DI().config(function(){this.registerParameter("lastusercookieid","lastuser"),this.registerController("createaccount",F.CreateAccountBox,"@account","@plug","@url"),this.registerController("login",F.LoginBox,"@login","@cookie","@plug","@url","%lastusercookieid%"),this.registerController("lostpassword",F.LostPasswordBox,"@plug","@url")});var fWidget=angular.module("f.widget");fWidget.directive("login",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("login"),template:'<asyncpartial firstload="visible" partial="login.html"></asyncpartial>'})}),fWidget.directive("createaccount",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("createaccount"),template:'<asyncpartial firstload="visible" partial="createaccount.html"></asyncpartial>'})}),fWidget.directive("lostpassword",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("lostpassword"),template:'<asyncpartial firstload="visible" partial="lostpasswordpage.html"></asyncpartial>'})}),fWidget.directive("lostpasswordform",function(){var e=F.DI().getService("account"),t=F.DI().getService("cookie"),i=F.DI().getParameter("lastusercookieid");return{restrict:"E",scope:{},link:function(n,o,r){n.usernameList=t.getLocalStorageItemAsArray(i),n.credentials={username:""},r.username?n.credentials.username=r.username:n.usernameList.length>0&&(n.credentials.username=n.usernameList[n.usernameList.length-1]),n.dots="",n.resetPassword=function(t){var i=/.+@.+[.].+/;t&&t.match(i)?(n.isError=!1,n.message="FE_SENDING_EMAIL",n.dots="...",e.resetPassword(t).then(function(){n.$apply(function(e){e.isError=!1,e.message="IM_EMAIL_SENT",e.dots=""})},function(e){n.$apply(function(t){t.isError=!0,t.message=e.message||"EM_UNDEFINED",t.dots=""})}).done()):(n.isError=!0,n.message="EM_INSERT_USERNAME",n.dots="")}},templateUrl:F.partialUrl("lostpasswordform.html")}}),F.ProjectBase=function(e){F.CRUDObject.call(this,e),this._name=void 0,this._displayName=void 0,this._projectUUID=void 0},F.ProjectBase.prototype={getID:function(){return this._name},matchesJson:function(e){return this._name===e.Name},readJson:function(e){this._name=e.Name,this._displayName=e.DisplayName,this._projectUUID=e.ProjectUUID},writeJson:function(){var e={};return e.Class="ProjectBase",e.Name=this._name,e.DisplayName=this._displayName,e.ProjectUUID=this._projectUUID,e}},F.extend("ProjectBase","CRUDObject"),F.ProjectServiceBase=function(e,t,i,n,o,r,a,s,c,l){c=c||F.ProjectBase,l=l||"/project";var h="Project";F.CRUDService.call(this,h,c,l,{},e,t,n,o,r);var d=this;this.$http=a,this._url=s,this._currentProject=void 0,this._queryKey="p",this._listeners={},i.subscribe("logout",function(){d.removeInternal(),d._currentProject=void 0}),this.provideMalePlug("ProjectChange",["changeProject"]),this.provideFemalePlug("URLChange",["setFragment","applyURL"]),this.connect(this,this._url)},F.ProjectServiceBase.prototype={changeProject:function(e){return this._currentProject=e,this.updateURL(),this.notify("change"),this.trigger("changeProject",[e])},getCurrent:function(){if(!this._currentProject)throw new Error("EM_NO_PROJECT");return this._currentProject},hasCurrent:function(){return void 0!==this._currentProject},isCurrent:function(e){return void 0!==this._currentProject&&this._currentProject===e},subscribe:function(e,t){this._listeners[e]?this._listeners[e].push(t):this._listeners[e]=[t]},notify:function(e){this._listeners[e]&&this._listeners[e].forEach(function(e){e.call(this)})},updateURL:function(){this._url.setFragment(this._queryKey,this._currentProject)},setFragment:function(e){e.isUnresolved(this._queryKey)&&e.resolve(this._queryKey,e.get(this._queryKey).query)},applyURL:function(e,t){if(e==this._queryKey){var i=this._currentProject,n=t.get(this._queryKey).query;this._currentProject=n,n!==i&&(this.notify("change"),this.trigger("changeProject",[n]))}}},F.extend("ProjectServiceBase","CRUDService"),F.DI().registerService("project",F.ProjectServiceBase,"@serializer","@error","@login","@selection","@plug","$resource","$http","@url"),F.DI().config("@plug",F.projectPlug=function(e){e.describe("ProjectChange",["changeProject"])}),F.projectBaseConfigSerializer=function(e,t){e.registerClass("ProjectBase",function(){return t.getNew()})},F.DI().config("@task","@project",function(e,t){e.addValidator("project",function(){return t.hasCurrent()?Q.resolve():Q.resolve("EM_NO_PROJECT")})}),F.RevisionService=function(e,t,i,n){this._http=e,this._error=t,this._project=i,this._cookie=n,this._lastRead={}},F.RevisionService.prototype={getCurrent:function(){var e=Q.defer(),t=this._project.getCurrent(),i={method:"GET",url:"/revision/control/"+t};return this._http(i).success(function(t){e.resolve(t.revision)}).error(this._error.httpHandler(e)),e.promise},getLastRead:function(e){return this._lastRead[e]=this._lastRead[e]||parseInt(this._cookie.getLocalStorageItem("rev/"+e))||Number.MAX_VALUE,this._lastRead[e]},touch:function(e,t,i){this._lastRead[e]||this.getLastRead(e),this._lastRead[e]==Number.MAX_VALUE&&i&&(this._lastRead[e]=t-1);var n=parseInt(this._cookie.getLocalStorageItem("rev/"+e)||0);this._cookie.setLocalStorageItem("rev/"+e,Math.max(t,n))}},F.extend("RevisionService"),F.DataFilter=function(){this._categories=void 0,this._tags=void 0,this._root=void 0,this._createdBy=void 0},F.DataFilter.prototype={setCategories:function(e){this._categories=e},setTags:function(e){this._tags=e},setCreatedBy:function(e){this._createdBy=e},setRoot:function(e){this._root=e?"":void 0},hasRoot:function(){return""===this._root},filter:function(e){return!(this._categories&&-1==this._categories.indexOf(e._category)||this._tags&&!this._tags.some(function(t){return-1!=e._tags.indexOf(t)})||this._createdBy&&-1==this._createdBy.indexOf(e._createdBy))},enhanceRead:function(e){this._categories&&(e.category=this._categories.join(",")),this._tags&&(e.tags=this._tags.join(",")),this._createdBy&&(e.createdby=this._createdBy.join(",")),""===this._root&&(e.root=this._root)},enhanceUpdate:function(e){""===this._root&&(e.root=this._root)},enhanceRemove:function(e){""===this._root&&(e.root=this._root)}},F.extend("DataFilter","ChangeObject"),F.WorkspaceService=function(e,t,i,n){F.PlugModule.call(this,i);var o=this;this._error=e,this._project=t,this._http=n,this._root=!1,this._promiseAncestors=void 0,this._promiseProject=void 0,t.subscribe("change",function(){o._promiseAncestors=void 0,o._promiseProject=void 0})},F.WorkspaceService.prototype={addCustomAttributes:function(e){return Q.all([this.getAncestorMap(),this.getProject()]).spread(function(t,i){var n=i._trafo;return e.forEach(function(e){e._ancestors=t[e._parentUUID]||[],e instanceof WS.Measurement&&e.setCustomTrafo(n)}),e})},getAncestorMap:function(e){return!e&&this._promiseAncestors?this._promiseAncestors:(this._promiseAncestors=this.loadAncestors(),this._promiseAncestors)},getProject:function(e){return!e&&this._promiseProject?this._promiseProject:(this._promiseProject=this._project.getCurrentProject(),this._promiseProject)},loadAncestors:function(){var e=this,t=Q.defer(),i=this._project.getCurrent(),n={method:"GET",url:"/workspaceskeleton/"+i+(this._root?"?root":"")};return this._http(n).success(function(i){t.resolve(e.listToAncestorMap(i))}).error(this._error.httpHandler(t)),t.promise},listToAncestorMap:function(e){return e.reduce(function(e,t){var i=e[t.ParentUUID]||[];return e[t.UUID]=i.concat([t]),e},{})},root:function(e){e!==this._root&&(this._promiseAncestors=void 0,this._promiseProject=void 0),this._root=e}},F.extend("WorkspaceService","PlugModule"),F.ProjectCRUDService=function(e,t,i,n,o,r,a,s,c,l,h,d,u){F.CRUDService.call(this,e,t,i+"/:project",n,o,r,s,c,u);var p=this;this._project=a,this._login=l,this._revision=h,this._workspace=d,this._dataFilter=new F.DataFilter,this._className=e,a.subscribe("change",function(){p.clearCache(),p.removeInternal(),p.setDataFilter(new F.DataFilter)});var _=function(){p.clearCache(),a.hasCurrent()||p.removeInternal()};l.subscribe("login",_),l.subscribe("update",_),l.subscribe("logout",_),this._pendingSync=void 0,this._lastSync=void 0},F.ProjectCRUDService.prototype={setDataFilter:function(e){return this._dataFilter=e,this._filter=F.proxy(e.filter,e),this.getAll(void 0,void 0,0)},getNew:function(){var e=F.CRUDService.prototype.getNew.call(this);return this._project.hasCurrent()&&(e._project=this._project.getCurrent()),e},getAll:function(e,t,i){var n=this,o=e&&e.project,r=o?0:void 0===i?60:i,a=t||function(){return!0};if(this._lastSync&&(new Date-this._lastSync)/1e3<r)return Q.resolve(this._entities.filter(a));var s=o||this._project.getCurrent();if(!this._pendingSync){if(WS._2GO)this._pendingSync=this._workspace.getAll(this._className).then(function(e){return e});else{var c={project:s};this._dataFilter.enhanceRead(c);var l=Q.defer();this._restClient.readAll(c,l.resolve,this._error.restHandler(l)),this._pendingSync=l.promise}this._pendingSync=this._pendingSync.then(function(e){return n._pendingSync=void 0,n.updateInternalMultiple(e)}).then(function(){var e=n._entities,t=0;return e.forEach(function(e){e._project=s,t=Math.max(t,e._revision)}),t&&n._revision.touch(s,t),n.setFlags(e),n._lastSync=o?void 0:new Date,e},function(e){throw n._pendingSync=void 0,e})}return this._pendingSync.then(function(e){return e.filter(a)})},handleSingleEntity:function(e){return this._workspace.addCustomAttributes([e])},handleEntityChanges:function(e,t,i){return this._workspace.addCustomAttributes(e.concat(t)).then(F.CRUDService.prototype.handleEntityChanges.bind(this,e,t,i))},getAllFromServer:function(e){if(WS._2GO){var t=this;return this._workspace.getAll(this._className).then(function(e){return t._serializer.read(e)})}var i=e&&e.project||this._project.getCurrent(),n={project:i};return F.CRUDService.prototype.getAllFromServer.call(this,n).then(function(e){return e.forEach(function(e){e._project=i}),e})},getByID:function(e,t,i){var n=this,o=this._project.getCurrent(),r=t||{};this._dataFilter.enhanceRead(r),r.project=o;var a=WS._2GO;return F.CRUDService.prototype.getByID.call(this,e,r,a,i).then(function(e){return e._project=o,n._revision.touch(o,e._revision),n.setFlags([e]),e})},create:function(e,t){var i=t||{};i.project=e._project;var n=this;return F.CRUDService.prototype.create.call(this,e,i).then(function(){return n._revision.touch(e._project,e._revision,!0),n.setFlags([e]),e})},update:function(e,t){var i=t||{};i.project=e._project,this._dataFilter.enhanceUpdate(i);var n=this;return F.CRUDService.prototype.update.call(this,e,i).then(function(){n._revision.touch(e._project,e._revision,!0),n.setFlags([e])},function(t){throw n._error.isExceptionType(t,"RevisionUnreadException")&&(e.readJson(t._infos.Object),n._revision.touch(e._project,e._revision,!0),n.postUpdate(e),n.setFlags([e])),t})},remove:function(e,t){var i=t||{};i.project=e._project,i.revision=e._revision,this._dataFilter.enhanceRemove(i);var n=this;return F.CRUDService.prototype.remove.call(this,e,i).fail(function(t){throw n._error.isExceptionType(t,"RevisionUnreadException")&&(e.readJson(t._infos.Object),n._revision.touch(e._project,e._revision,!0),n.postUpdate(e),n.setFlags([e])),t})},setFlags:function(e){if(e.length){var t=this,i=this._revision.getLastRead(e[0]._project),n=this._dataFilter.hasRoot();Q.all([this._login.getUsername(),this._login.isUser()]).spread(function(o,r){var a=[];e.forEach(function(e){var t=e._hot,s=e._writeLock;e._hot=e._revision>i;var c=r&&(e._createdBy===o||e._writePublic),l=e._temporary;e._writeLock=!n&&!c&&!l,(t!=e._hot||s!=e._writeLock)&&a.push(e)}),a.length>0&&t.trigger("updateObjects",[a])}).done()}},clearCache:function(){this._lastSync=void 0,this._pendingSync=void 0}},F.extend("ProjectCRUDService","CRUDService"),F.TransformationService=function(e,t,i,n,o,r,a,s,c){F.ProjectCRUDService.call(this,"Transformation",F.Transformation,"/transformation",{},e,t,i,n,o,r,a,s,c)},F.TransformationService.prototype={inquireGlobalFolder:function(e){var t=this;return this._workspace.inquireGlobalFolder(e).then(function(e){return t.getAll(void 0,void 0,0).then(function(t){return F.findFirst(t,function(t){return t._UUID===e.UUID})})})}},F.extend("TransformationService","ProjectCRUDService"),F.RootService=function(e,t,i,n,o,r,a,s,c){F.ProjectCRUDService.call(this,"Workspace",F.Root,"/workspaceroot",{},e,t,i,n,o,r,a,s,c)},F.extend("RootService","ProjectCRUDService"),F.ProjectCRUDObject=function(e){F.CRUDObject.call(this,e),this._exportVersion=void 0,this._class=void 0,this._createdBy=void 0,this._UUID=void 0,this._parentUUID=void 0,this._name=void 0,this._displayName=void 0,this._revision=void 0,this._category=void 0,this._tags=void 0,this._readPublic=void 0,this._readGroups=void 0,this._writePublic=void 0,this._writeGroups=void 0,this._project=void 0,this._writeLock=!1,this._hot=!1,this._ancestors=void 0},F.ProjectCRUDObject.prototype={getID:function(){return this._UUID},readJson:function(e){this._exportVersion=e.ExportVersion,this._class=e.Class,this._createdBy=e.CreatedBy,this._UUID=e.UUID,this._parentUUID=e.ParentUUID,this._name=e.Name,this._displayName=e.DisplayName,this._revision=e.Revision,this._category=e.Category,this._tags=e.Tags,this._readPublic=e.ReadPublic,this._readGroups=e.ReadGroups,this._writePublic=e.WritePublic,this._writeGroups=e.WriteGroups,WS._2GO&&(this._revision=this._revision||1,this._category=this._category||"",this._tags=this._tags||[],this._readPublic=this._readPublic||!1,this._readGroups=this._readGroups||[],this._writePublic=this._writePublic||!1,this._writeGroups=this._writeGroups||[])},writeJson:function(){var e={};
return e.ExportVersion=this._exportVersion,e.Class=this._class,e.CreatedBy=this._createdBy,e.UUID=this._UUID,e.ParentUUID=this._parentUUID,e.Name=this._name,e.DisplayName=this._displayName,e.Revision=this._revision,e.Category=this._category,e.Tags=this._tags,e.ReadPublic=this._readPublic,e.ReadGroups=this._readGroups,e.WritePublic=this._writePublic,e.WriteGroups=this._writeGroups,e},writeChanges:function(){var e=F.CRUDObject.prototype.writeChanges.call(this);return e.Revision=this._revision,e},matchesJson:function(e){return this._UUID===e.UUID},canBeShownInView:function(){return!1}},F.extend("ProjectCRUDObject","CRUDObject"),F.Transformation=function(e){F.ProjectCRUDObject.call(this,e),this._trafoLocal=void 0,this._trafoGlobal=void 0,this._class="Transformation"},F.Transformation.prototype={readJson:function(e){F.ProjectCRUDObject.prototype.readJson.call(this,e),this._trafoLocal=e.TransformationLocal,this._trafoGlobal=e.TransformationGlobal},writeJson:function(){var e=F.ProjectCRUDObject.prototype.writeJson.call(this);return e.Class=this._class,e.TransformationLocal=this._trafoLocal,e.TransformationGlobal=this._trafoGlobal,e},getTranslationGlobal:function(){return this._trafoGlobal?mat4.getTranslation(this._trafoGlobal):[0/0,0/0,0/0]},getTranslationLocal:function(){return this._trafoLocal?mat4.getTranslation(this._trafoLocal):[0/0,0/0,0/0]},getGlobalX:function(){return this._trafoGlobal?this._trafoGlobal[12]:0/0},getGlobalY:function(){return this._trafoGlobal?this._trafoGlobal[13]:0/0},getGlobalZ:function(){return this._trafoGlobal?this._trafoGlobal[14]:0/0},getLocalX:function(){return this._trafoLocal?this._trafoLocal[12]:0/0},getLocalY:function(){return this._trafoLocal?this._trafoLocal[13]:0/0},getLocalZ:function(){return this._trafoLocal?this._trafoLocal[14]:0/0},calcPositionInRefSystem:function(e,t){return mat4.posInRefSystem(t||this.getTranslationGlobal(),e)},calcTrafoInRefSystem:function(e,t){return mat4.trafoInRefSystem(t||this._trafoGlobal,e)},showLocalCoords:function(){return!mat4.equal(this._trafoGlobal,this._trafoLocal)}},F.extend("Transformation","ProjectCRUDObject"),F.Root=function(e){F.Transformation.call(this,e),this._class="Workspace"},F.Root.prototype={writeJson:function(){var e=F.Transformation.prototype.writeJson.call(this);return e.Class="Workspace",e}},F.extend("Root","Transformation"),F.HyperlinkedObject={readHyperlinksJson:function(e){var t=e.Hyperlinks,i=e.HyperlinksDescriptions,n=t.length;if(!i||i.length!==t.length){i=[];for(var o=0;n>o;o++)i.push(t[o])}this._hyperlinks=[];for(var r=0;n>r;r++)this._hyperlinks.push(new F.Hyperlink(t[r],i[r]))},writeHyperlinksJson:function(e){return e.Hyperlinks=[],e.HyperlinksDescriptions=[],this._hyperlinks.forEach(function(t){e.Hyperlinks.push(t._url),e.HyperlinksDescriptions.push(t._description)}),e},writeHyperlinksChanges:function(e){return void 0!==this._changes._hyperlinks&&(e.Hyperlinks=[],e.HyperlinksDescriptions=[],this._changes._hyperlinks.forEach(function(t){e.Hyperlinks.push(t._url),e.HyperlinksDescriptions.push(t._description)})),e}},F.defineMixin("HyperlinkedObject"),F.DI().registerService("revision",F.RevisionService,"$http","@error","@project","@cookie"),F.DI().registerService("workspace",F.WorkspaceService,"@error","@project","@plug","$http"),F.isLocked=function(e){return e._writeLock},F.isUnlocked=function(e){return!e._writeLock},F.Unit=function(e,t,i,n,o){this._conversionFactors=e,this._precisionOffsets=t,this._strings=i,this._unit=n,this._inverse=o||!1},F.Unit.prototype={getExactValue:function(e){return this.convertFromBaseUnit(e)},getValue:function(e,t,i){if(0===e)return"0";var n=this.determinePrecision(t,i),o=this.convertFromBaseUnit(e,i);return n>=1?o.toFixed(n):Math.round(o).toString()},getValueAndUnitString:function(e,t,i){return this.getValue(e,t,i)+" "+this.getUnitString(i)},getUnitString:function(e){var t=e!==!0?this._unit:this.getSmallestUnit();return(this._inverse?"/":"")+this._strings[t]},convertToBaseUnit:function(e){var t=this._conversionFactors[this._unit];return this._inverse?e*t:e/t},convertFromBaseUnit:function(e,t){var i=t!==!0?this._unit:this.getSmallestUnit(),n=this._conversionFactors[i];return this._inverse?e/n:e*n},determinePrecision:function(e,t){var i=t!==!0?this._unit:this.getSmallestUnit(),n=this._precisionOffsets[i],o=this._inverse?e-n:e+n;return Math.max(0,o)},setUnit:function(e){"number"==typeof this._conversionFactors[e]&&(this._unit=e)},getSmallestUnit:function(){return this._unit}},F.extend("Unit"),F.Unit.calcPrecisionOffsets=function(e){var t={};for(var i in e)t[i]=Math.round(-F.log10(e[i]));return t},F.LengthUnit=function(e,t){var i=e?e:F.LengthUnit.m;F.Unit.call(this,F.LengthUnit.ConversionFactors,F.LengthUnit.PrecisionOffsets,F.LengthUnit.Strings,i,t||!1)},F.LengthUnit.prototype={getSmallestUnit:function(){switch(this._unit){case"km":case"m":case"dm":case"cm":case"mm":return"mm";case"mi":case"yd":case"ft":case"in":return"in";case"ydUS":case"ftUS":case"inUS":return"inUS";default:return this._unit}}},F.extend("LengthUnit","Unit"),F.LengthUnit.km="km",F.LengthUnit.m="m",F.LengthUnit.dm="dm",F.LengthUnit.cm="cm",F.LengthUnit.mm="mm",F.LengthUnit.mi="mi",F.LengthUnit.yd="yd",F.LengthUnit.ft="ft",F.LengthUnit["in"]="in",F.LengthUnit.ydUS="ydUS",F.LengthUnit.ftUS="ftUS",F.LengthUnit.inUS="inUS",F.LengthUnit.Strings={km:"km",m:"m",dm:"dm",cm:"cm",mm:"mm",mi:"mi",yd:"yd",ft:"ft","in":"in",ydUS:"yd US",ftUS:"ft US",inUS:"in US"},F.LengthUnit.ConversionFactors={km:.001,m:1,dm:10,cm:100,mm:1e3,mi:1/1609.344,yd:1/.9144,ft:1/.3048,"in":1/.0254,ydUS:1/(3600/3937),ftUS:1/(1200/3937),inUS:39.37},F.LengthUnit.PrecisionOffsets=F.Unit.calcPrecisionOffsets(F.LengthUnit.ConversionFactors),F.LengthUnit.PrecisionOffsets.ft=F.LengthUnit.PrecisionOffsets.ftUS=0,F.LengthUnit.PrecisionOffsets.in=F.LengthUnit.PrecisionOffsets.inUS=-1,F.AreaUnit=function(e,t){var i=e?e:F.AreaUnit.m;F.Unit.call(this,F.AreaUnit.ConversionFactors,F.AreaUnit.PrecisionOffsets,F.AreaUnit.Strings,i,t||!1)},F.extend("AreaUnit","Unit"),F.AreaUnit.km="km",F.AreaUnit.ha="ha",F.AreaUnit.a="a",F.AreaUnit.m="m",F.AreaUnit.dm="dm",F.AreaUnit.cm="cm",F.AreaUnit.mm="mm",F.AreaUnit.mi="mi",F.AreaUnit.ac="ac",F.AreaUnit.yd="yd",F.AreaUnit.ft="ft",F.AreaUnit["in"]="in",F.AreaUnit.ydUS="ydUS",F.AreaUnit.ftUS="ftUS",F.AreaUnit.inUS="inUS",F.AreaUnit.Strings={km:"km",ha:"ha",a:"a",m:"m",dm:"dm",cm:"cm",mm:"mm",mi:"mi",ac:"ac",yd:"yd",ft:"ft","in":"in",ydUS:"yd US",ftUS:"ft US",inUS:"in US"},F.AreaUnit.ConversionFactors={km:1e-6,ha:1e-4,a:.01,m:1,dm:100,cm:1e4,mm:1e6,mi:1/2589988.11034,ac:1/4046.8564224,yd:1/.83612736,ft:1/.09290304,"in":1/64516e-8,ydUS:1/Math.pow(3600/3937,2),ftUS:1/Math.pow(1200/3937,2),inUS:1/Math.pow(1200/3937/12,2)},F.AreaUnit.PrecisionOffsets=F.Unit.calcPrecisionOffsets(F.AreaUnit.ConversionFactors),F.AngleUnit=function(e,t){var i=e||F.AngleUnit.rad;F.Unit.call(this,F.AngleUnit.ConversionFactors,F.AngleUnit.PrecisionOffsets,F.AngleUnit.Strings,i,t||!1)},F.extend("AngleUnit","Unit"),F.AngleUnit.rad="rad",F.AngleUnit.deg="deg",F.AngleUnit.gon="gon",F.AngleUnit.Strings={rad:"rad",deg:"deg",gon:"gon"},F.AngleUnit.ConversionFactors={rad:1,deg:180/Math.PI,gon:200/Math.PI},F.AngleUnit.PrecisionOffsets=F.Unit.calcPrecisionOffsets(F.AngleUnit.ConversionFactors),F.UnitServiceBase=function(e){F.PlugModule.call(this,e);this._lengthUnit=new F.LengthUnit,this._inverseLengthUnit=new F.LengthUnit,this._inverseLengthUnit._inverse=!0,this._areaUnit=new F.AreaUnit,this._angleUnit=new F.AngleUnit,this.provideMalePlug("SettingsUpdate",["updateSettings"])},F.UnitServiceBase.prototype={getLengthUnit:function(){return this._lengthUnit._unit},getLengthUnitString:function(e,t){return e?"["+this._lengthUnit.getUnitString(t)+"]":this._lengthUnit.getUnitString(t)},getAreaUnit:function(){return this._areaUnit._unit},getAreaUnitString:function(e){return e?"["+this._areaUnit.getUnitString()+"]":this._areaUnit.getUnitString()},getAngleUnit:function(){return this._angleUnit._unit},getAngleUnitString:function(e){return e?"["+this._angleUnit.getUnitString()+"]":this._angleUnit.getUnitString()},getExactLength:function(e){return this._lengthUnit.getExactValue(e)},getExactArea:function(e){return this._areaUnit.getExactValue(e)},getExactAngle:function(e){return this._angleUnit.getExactValue(e)},getLength:function(e,t,i){return this._lengthUnit.getValue(e,t,i)},getArea:function(e,t){return this._areaUnit.getValue(e,t)},getAngle:function(e,t){return this._angleUnit.getValue(e,t)},getLengthAndUnit:function(e,t,i){return this._lengthUnit.getValueAndUnitString(e,t,i)},getAreaAndUnit:function(e,t){return this._areaUnit.getValueAndUnitString(e,t)},getAngleAndUnit:function(e,t){return this._angleUnit.getValueAndUnitString(e,t)},removeInternal:function(){this.setLengthUnit(F.LengthUnit.m),this.setAreaUnit(F.AreaUnit.m),this.setAngleUnit(F.AngleUnit.deg)},setLengthUnit:function(e){this._lengthUnit.setUnit(e),this._inverseLengthUnit.setUnit(e)},setAreaUnit:function(e){this._areaUnit.setUnit(e)},setAngleUnit:function(e){this._angleUnit.setUnit(e)},getResolution:function(e,t,i){var n=this._inverseLengthUnit.getValue(e,t)+" "+i+this._inverseLengthUnit.getUnitString();return n}},F.extend("UnitServiceBase","PlugModule"),F.DI().registerService("unit",F.UnitServiceBase,"@plug"),angular.module("f.unit").filter("unit",function(){var e=F.DI().getService("unit");return function(t,i,n,o,r){if(void 0===t)return"";if(i=void 0===i?3:i,n=void 0===n?!0:n,r=void 0===r?!1:r,o)return e.getLength(t,i,r);var a=e.getLengthAndUnit(t,i,r);return n&&(a=a.replace(/ /g,"")),a}}),angular.module("f.unit").filter("resolution",function(){var e=F.DI().getService("unit");return function(t,i,n,o){if(void 0===t)return"";i=void 0===i?2:i,n=void 0===n?"px":n,o=void 0===o?!0:o;var r=e.getResolution(t,i,n);return o&&(r=r.replace(/ /g,"")),r}}),angular.module("f.unit").filter("areaunit",function(){var e=F.DI().getService("unit");return function(t,i,n,o){if(void 0===t)return"";if(void 0===n&&(n=!0),i=void 0!==i?i:4,o)return e.getArea(t,i);var r=e.getAreaAndUnit(t,i);return n&&(r=r.replace(/ /g,"")),r}}),angular.module("f.unit").filter("angleunit",function(){var e=F.DI().getService("unit");return function(t,i,n,o){if(void 0===t)return"";if(void 0===n&&(n=!0),i=void 0!==i?i:4,o)return e.getAngle(t,i);var r=e.getAngleAndUnit(t,i);return n&&(r=r.replace(/ /g,"")),r}}),function(){var e=function(e,t,i,n,o){if("undefined"==typeof t)return"";void 0===n&&(n=!0),i="undefined"!=typeof i?i:3;for(var r,a="",s=t.length,c=0;s>c;c++)r=o?e.getLengthAndUnit(t[c],i):e.getLength(t[c],i),n&&(r=r.replace(/ /g,"")),a+=r,c!==s-1&&(a+=", ");return a};angular.module("f.unit").filter("pos",function(){var t=F.DI().getService("unit");return function(i,n,o){return e(t,i,n,o,!0)}}),angular.module("f.unit").filter("pos2d",function(){var t=F.DI().getService("unit");return function(i,n,o){return i?e(t,[i[0],i[1]],n,o,!0):void 0}}),angular.module("f.unit").filter("pos_short",function(){var t=F.DI().getService("unit");return function(i,n){return e(t,i,n,!1,!1)}}),angular.module("f.unit").filter("pos_short_multi",function(){var t=F.DI().getService("unit");return function(i,n){if("undefined"==typeof i)return"";for(var o="",r=i.length,a=r-1,s=0;r>s;++s)o+=e(t,i[s],n,!1,!1),s!==a&&(o+="\n");return o}})}(),angular.module("f.unit").filter("addlengthunit",function(){var e=F.DI().getService("unit");return function(t){var i=t;return void 0!==e&&(i=i+" ("+e.getLengthUnit()+")"),i}}),F.ColorGenerator=function(){},F.extend("ColorGenerator"),F.hexChars=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],F.ColorGenerator.hexColorFromInt=function(e){if(!e)return"#000000";for(var t=16777215&e,i="",n=0;6>n;n++)i=F.hexChars[15&t]+i,t>>=4;return"#"+i},F.ColorGenerator.intColorFromString=function(e){return e?16777215&F.crc32(e):0},F.ColorGenerator.hexColorFromString=function(e){var t=F.ColorGenerator.intColorFromString(e);return F.ColorGenerator.hexColorFromInt(t)},F.ColorGenerator.rgbColorFromInt=function(e){var t=F.ColorGenerator.hexColorFromInt(e),i=F.ColorGenerator.hexToRGBA(t),n=F.ColorGenerator.intColorToDbl(i);return n},F.ColorGenerator.isHexColor=function(e,t){return 9!==e.length||t?/(^#[0-9A-F]{6}$)/i.test(e):/(^#[0-9A-F]{8}$)|(^#[0-9A-F]{6}$)/i.test(e)},F.ColorGenerator.hexToRGBA=function(e,t){e=e.substr(1);var i,n,o,r,a=parseInt(e,16);return 8===e.length?(i=a>>24&255,n=a>>16&255,o=a>>8&255,r=255&a):(i=a>>16&255,n=a>>8&255,o=255&a,r=255),t?[i,n,o,r]:[i,n,o]},F.ColorGenerator.rgbaToHex=function(e,t){var i,n=function(e){var t=e.toString(16);return 1===t.length?"0"+t:t},o=n(e[0]),r=n(e[1]),a=n(e[2]);return i=t?4===e.length?n(e[3]):"FF":"","#"+o+r+a+i},F.ColorGenerator.intColorToDbl=function(e){for(var t=[],i=0,n=e.length;n>i;++i)t[i]=e[i]/255;return t},F.ImageResolution=function(e,t,i,n){this._width=e,this._height=t,this._id=i,this._resourceKeyForName=n},F.ImageResolution.prototype={getName:function(){return this._resourceKeyForName},getId:function(){return this._id}},F.extend("ImageResolution"),F.ColorMode=function(e,t){this._id=e,this._resourceKeyForName=t},F.ColorMode.prototype={getName:function(){return this._resourceKeyForName}},F.extend("ColorMode"),F.BaseAdapter=function(e,t){this._node=e,this._handlerStack=t,this._onEventProxied=F.proxy(this.onEvent,this)},F.BaseAdapter.prototype={setHandlerStack:function(e){this._handlerStack=e},callHandlerStack:function(e,t,i){for(var n=!1,o=this._handlerStack.length-1;o>=0&&!n;o--){var r=this._handlerStack[o];r[t]&&(n=r[t].apply(r,i))}n&&e.stopPropagation()}},F.MouseAdapter=function(e,t,i){F.BaseAdapter.call(this,e,t),this._captureConfig=i,this._capture=i===F.MouseAdapter.Capture.On,this._state=F.MouseAdapter.States.initial,this._button=void 0,this._dragStart=void 0,this._dragLast=void 0,this._scrollLast=0,this._scrollInitDistance=100,this._timeLastClick=0,this._timeLastDown=0,this._lastClick=void 0,this._holdFirst=void 0,this._holdLast=void 0,this._holdClose=!0,this._holdTimeout=void 0,this._isTouchScrolling=!1,this._isTouchPanning=!1,this._preventClick=!1,this._pickDuration=0,this.listenersOnOff("on")},F.MouseAdapter.prototype={initState:function(){this._state=F.MouseAdapter.States.initial,this._button=void 0,this._dragStart=void 0,this._dragLast=void 0,this._scrollLast=0,this._scrollInitDistance=100,this._timeLastClick=0,this._timeLastDown=0,this._lastClick=void 0,this._holdFirst=void 0,this._holdLast=void 0,this._holdClose=!0,this._holdTimeout=void 0,this._isTouchScrolling=!1,this._isTouchPanning=!1,this._preventClick=!1},initial:function(){this._state=F.MouseAdapter.States.initial,this._button=void 0,this._dragStart=void 0,this._dragLast=void 0,this._scrollLast=void 0,this._holdFirst=void 0,this._holdLast=void 0,this._holdClose=!0,this._holdTimeout=void 0,this._isTouchScrolling=!1,this._isTouchPanning=!1,this._preventClick=!1,this.updateCaptureMode()},setNode:function(e){this.listenersOnOff("off"),this.initState(),this._node=e,this.listenersOnOff("on")},updateCaptureMode:function(){var e,t=this._capture;switch(this._captureConfig){case F.MouseAdapter.Capture.Off:e=!1;break;case F.MouseAdapter.Capture.On:e=!0;break;case F.MouseAdapter.Capture.DragOnly:e=this._state===F.MouseAdapter.States.drag}e!==t&&(this.listenersOnOff("off"),this._capture=e,this.listenersOnOff("on"))},pageToNodeX:function(e){var t=this._node,i=0;do i+=t.offsetLeft,t=t.offsetParent;while(t);return e-i},pageToNodeY:function(e){var t=this._node,i=0;do i+=t.offsetTop,t=t.offsetParent;while(t);return e-i},listenersOnOff:function(e){var t=this._onEventProxied,i=$(this._capture?window:this._node);i[e]("touchstart touchmove touchend",t),i[e]("mousedown mousemove mouseup",t),this._capture||$(this._node)[e]("mouseleave",t),$(this._node)[e]("mousewheel DOMMouseScroll",t)},toEventEnum:function(e){var t=e.button,i=e.originalEvent.touches?e.originalEvent.touches.length:0;switch(e.type){case"mousemove":return F.MouseAdapter.Events.mouseMove;case"touchmove":return 1===i||2===i?F.MouseAdapter.Events.touchMove:F.MouseAdapter.Events.unknown;case"mousedown":return 0===t||1===t||2===t?F.MouseAdapter.Events.mouseDown:F.MouseAdapter.Events.unknown;case"mouseup":return 0===t||1===t||2===t?F.MouseAdapter.Events.mouseUp:F.MouseAdapter.Events.unknown;case"touchstart":return 1===i?F.MouseAdapter.Events.touchStartOneFinger:2===i?F.MouseAdapter.Events.touchStartTwoFinger:F.MouseAdapter.Events.unknown;case"touchend":return 1===i?F.MouseAdapter.Events.touchEndTwoFinger:i?F.MouseAdapter.Events.unknown:F.MouseAdapter.Events.touchEndOneFinger;case"mousewheel":case"DOMMouseScroll":return F.MouseAdapter.Events.mouseScroll;case"mouseleave":return F.MouseAdapter.Events.mouseLeave;default:return F.MouseAdapter.Events.unknown}},isTouchEvent:function(e){return e.type.indexOf("touch")>-1},getPositionOfFingers:function(e){var t,i,n=e.originalEvent.touches;if(!n)return[t,i];var o=e.originalEvent.changedTouches;if(0===n.length&&o)1<=o.length&&(t={x:this.pageToNodeX(o[0].pageX),y:this.pageToNodeY(o[0].pageY)}),2<=o.length&&(i={x:this.pageToNodeX(o[1].pageX),y:this.pageToNodeY(o[1].pageY)});else if(1===n.length){if(t={x:this.pageToNodeX(n[0].pageX),y:this.pageToNodeY(n[0].pageY)},o&&1<=o.length){var r=n[0],a=o[0];(r.identifier!==a.identifier||r.pageX!==a.pageX||r.pageY!==a.pageY||r.screenX!==a.screenX||r.screenY!==a.screenY)&&(i={x:this.pageToNodeX(o[0].pageX),y:this.pageToNodeY(o[0].pageY)})}}else 2<=n.length&&(t={x:this.pageToNodeX(n[0].pageX),y:this.pageToNodeY(n[0].pageY)},i={x:this.pageToNodeX(n[1].pageX),y:this.pageToNodeY(n[1].pageY)});return[t,i]},getDistanceBetweenFingers:function(e,t,i){var n=1;if(t&&i){var o=t.x-i.x,r=t.y-i.y;n=Math.max(1,Math.sqrt(o*o+r*r))}return n},getMousePosition:function(e){return void 0!==e.pageX&&void 0!==e.pageY?{x:this.pageToNodeX(e.pageX),y:this.pageToNodeY(e.pageY)}:void 0},getScrollCurrent:function(e,t,i){var n=this.getDistanceBetweenFingers(e,t,i),o=n/this._scrollInitDistance;return o=1>o?-1/o+1:o-1,o=-20*o},onEvent:function(e){e.preventDefault();{var t=this.getNowMillis(),i=this.toEventEnum(e),n=this._state,o=e.button,r=F.MouseAdapter.Events.mouseDown,a=F.MouseAdapter.Events.mouseMove,s=F.MouseAdapter.Events.mouseUp,c=F.MouseAdapter.Events.mouseScroll,l=F.MouseAdapter.Events.touchStartOneFinger,h=F.MouseAdapter.Events.touchStartTwoFinger,d=F.MouseAdapter.Events.touchMove,u=F.MouseAdapter.Events.touchEndOneFinger,p=F.MouseAdapter.Events.touchEndTwoFinger;F.MouseAdapter.Events.mouseLeave,F.MouseAdapter.Events.unknown}if(i===c)return void this.mouseScroll(e);var _=this.getPositionOfFingers(e),g=_[0],f=_[1],m=g&&f?{x:(g.x+f.x)/2,y:(g.y+f.y)/2}:void 0,v=this.getMousePosition(e),S=v||g,b=o===F.MouseAdapter.Button.Left||void 0===o,y=i===r||i===l,P=i===a||i===d,C=i===s||i===u,w=i===l,T=i===d,M=i===h,W=i===p;switch(n){case F.MouseAdapter.States.initial:y?(this._preventClick=!1,this.startDrag(e,S),w&&b&&this.holdTimeout(e,S)):M&&(this.startScroll(e,g,f),this.startDragTwoFingers(e,m));break;case F.MouseAdapter.States.drag:y?void 0===this._button&&(this._preventClick=!1,this.startDrag(e,S),w&&b&&this.holdTimeout(e,S)):P?T&&b&&!this._preventClick&&this.isHold(e,S,this._dragStart,t,this._timeLastDown)?this.startHold(e,S):(this.moveDrag(e,S),T&&b&&!this._preventClick&&this.isHoldByDist(e,S,this._dragStart)?this.holdTimeout(e,S):this._holdTimeout=void 0):C?(this._button===o||void 0===this._button)&&(!this._preventClick&&this.isClick(e,S,this._dragStart)&&this.click(e,S),this.stopDrag(e,S)):M?(this.stopDrag(e,S),this.startScroll(e,g,f),this.startDragTwoFingers(e,m)):this.stopDrag(e,S);break;case F.MouseAdapter.States.scrollDrag:if(y)this.stopDragTwoFingers(e,m),this.stopScroll(e),void 0===this._button&&(this._preventClick=!0,this.startDrag(e,S));else if(M)this.startScroll(e,g,f),this.startDragTwoFingers(e,m);else if(T){var E=this.getDistanceBetweenFingers(e,g,f);if(this.isTouchScrolling(E,this._scrollInitDistance)){var I=this.getScrollCurrent(e,g,f);this.moveScroll(e,I)}this.isTouchPanning(m,this._dragStart)&&this.moveDragTwoFingers(e,m)}else this.stopDragTwoFingers(e,m),this.stopScroll(e);break;case F.MouseAdapter.States.stopScrollDrag:y?void 0===this._button&&(this._preventClick=!0,this.startDrag(e,S)):P?(this._preventClick=!0,this.startDrag(e,S)):this.initial();break;case F.MouseAdapter.States.hold:P?this.moveHold(e,S):M?this.startHoldDrag(e,f):y||this.stopHold(e,S);break;case F.MouseAdapter.States.holdDrag:W||g&&!f?this.stopHoldDrag(e):C?(this.stopHoldDrag(e),this.stopHold(e,S)):T?(this.moveHold(e,g),this.moveHoldDrag(e,f)):y||M||(this.stopHoldDrag(e),this.stopHold(e,S))}},startDrag:function(e,t){this._state=F.MouseAdapter.States.drag,this._button=e.button,this._dragStart=t,this._dragLast=t,this._timeLastDown=this.getNowMillis();var i=this._button||F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onDragStart",[t.x,t.y,i]),this.updateCaptureMode(),this._node&&$(this._node).focus()},moveDrag:function(e,t){if(t.x!==this._dragLast.x||t.y!==this._dragLast.y){var i=this._button||F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onDragMove",[t.x,t.y,this._dragLast.x,this._dragLast.y,i]),this._dragLast=t}},stopDrag:function(e,t){var i=this._button||F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onDragStop",[t.x,t.y,i]),this._button=void 0,this.initial()},click:function(e,t){var i=this._button||F.MouseAdapter.Button.Left,n=this.getNowMillis(),o=this.isTouchEvent(e),r=this.isDblClick(e,t,this._lastClick,n,this._timeLastClick);this._pickDuration=0,r?(this.callHandlerStack(e,"onDblClick",[this._lastClick.x,this._lastClick.y,i,o]),this._timeLastClick=0,this._lastClick=void 0):(this.callHandlerStack(e,"onClick",[t.x,t.y,i,o]),this._timeLastClick=n,this._lastClick=t)},mouseScroll:function(e){var t=e.originalEvent.wheelDelta/60||-e.originalEvent.detail,i=this._state;this.startScroll(e),this.moveScroll(e,-t),this.stopScroll(e),this._state=i},startScroll:function(e,t,i){this._state=F.MouseAdapter.States.scrollDrag,this._scrollLast=0,this._scrollInitDistance=this.getDistanceBetweenFingers(e,t,i),this.callHandlerStack(e,"onScrollStart")},moveScroll:function(e,t){var i=t-this._scrollLast;i&&this.callHandlerStack(e,"onScroll",[i,this.isTouchEvent(e)]),this._scrollLast=t},stopScroll:function(e){this._state=F.MouseAdapter.States.stopScrollDrag,this.callHandlerStack(e,"onScrollStop"),this._scrollLast=0},startDragTwoFingers:function(e,t){this._dragStart=t,this._dragLast=t,this.callHandlerStack(e,"onDragStart",[t.x,t.y,F.MouseAdapter.Button.Middle])},moveDragTwoFingers:function(e,t){(t.x!==this._dragLast.x||t.y!==this._dragLast.y)&&(this.callHandlerStack(e,"onDragMove",[t.x,t.y,this._dragLast.x,this._dragLast.y,F.MouseAdapter.Button.Middle]),this._dragLast=t)},stopDragTwoFingers:function(e,t){this.callHandlerStack(e,"onDragStop",[t.x,t.y,F.MouseAdapter.Button.Middle])},startHold:function(e,t){this._state=F.MouseAdapter.States.hold,this._holdFirst=t,this._holdLast=t;var i=F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onHoldStart",[t.x,t.y,i])},moveHold:function(e,t){if(t.x!==this._holdLast.x||t.y!==this._holdLast.y){var i=F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onHoldMove",[t.x,t.y,this._holdLast.x,this._holdLast.y,this._holdFirst.x,this._holdFirst.y,i]),this._holdLast=t}},stopHold:function(e,t){this._state=F.MouseAdapter.States.drag;var i=F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onHoldStop",[t.x,t.y,i]),this.stopDrag(e,t)},startHoldDrag:function(e,t){this._state=F.MouseAdapter.States.holdDrag,this._dragStart=t,this._dragLast=t;var i=F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onDragStart",[t.x,t.y,i])},moveHoldDrag:function(e,t){if(t.x!==this._dragLast.x||t.y!==this._dragLast.y){var i=F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onDragMove",[t.x,t.y,this._dragLast.x,this._dragLast.y,i]),this._dragLast=t}},stopHoldDrag:function(e){this._state=F.MouseAdapter.States.hold;var t=F.MouseAdapter.Button.Left;this.callHandlerStack(e,"onDragStop",[this._dragLast.x,this._dragLast.y,t])},holdTimeout:function(e,t){var i=F.MouseAdapter.HOLD_WAITTIME_TOUCH,n=this,o=setTimeout(function(){n._holdTimeout===o&&n._state===F.MouseAdapter.States.drag&&n.startHold(e,t)},i);this._holdTimeout=o},isClick:function(e,t,i){var n=t.x-i.x,o=t.y-i.y,r=n*n+o*o;return r<(this.isTouchEvent(e)?F.MouseAdapter.CLICK_SQDIST_TOUCH:F.MouseAdapter.CLICK_SQDIST)},isDblClick:function(e,t,i,n,o){return this.isDblClickByTime(e,n,o)&&i&&this.isDblClickByDist(e,t,i)},isDblClickByTime:function(e,t,i){var n=t-i,o=this.getDblClickWaitTime(e);return o>n},getDblClickWaitTime:function(e){return Math.max(this.getDefaultDblClickWaitTime(e),this._pickDuration+F.MouseAdapter.DBLCLICK_PICK_TIME_ADDITION)},getDefaultDblClickWaitTime:function(e){return"boolean"==typeof e?e?F.MouseAdapter.DBLCLICK_WAITTIME_TOUCH:F.MouseAdapter.DBLCLICK_WAITTIME:this.isTouchEvent(e)?F.MouseAdapter.DBLCLICK_WAITTIME_TOUCH:F.MouseAdapter.DBLCLICK_WAITTIME},setPickDuration:function(e){this._pickDuration=e},isDblClickByDist:function(e,t,i){var n=t.x-i.x,o=t.y-i.y,r=n*n+o*o;return r<(this.isTouchEvent(e)?F.MouseAdapter.DBLCLICK_SQDIST_TOUCH:F.MouseAdapter.DBLCLICK_SQDIST)},isHold:function(e,t,i,n,o){return this.isHoldByDist(e,t,i)&&this.isHoldByTime(e,n,o)},isHoldByDist:function(e,t,i){var n=t.x-i.x,o=t.y-i.y,r=n*n+o*o;return this._holdClose=this._holdClose&&r<(this.isTouchEvent(e)?F.MouseAdapter.HOLD_SQDIST_TOUCH:F.MouseAdapter.HOLD_SQDIST),this._holdClose},isHoldByTime:function(e,t,i){return F.MouseAdapter.HOLD_WAITTIME_TOUCH<t-i},isTouchScrolling:function(e,t){return this._isTouchScrolling=!this._isTouchPanning&&(this._isTouchScrolling||F.MouseAdapter.SCROLL_DIST_TOUCH<=Math.abs(e-t)),this._isTouchScrolling},isTouchPanning:function(e,t){if(e){var i=e.x-t.x,n=e.y-t.y,o=i*i+n*n;this._isTouchPanning=!this._isTouchScrolling&&(this._isTouchPanning||F.MouseAdapter.PAN_SQDIST_TOUCH<=o)}else this._isTouchPanning=!1;return this._isTouchPanning},getNowMillis:function(){return Date.now()}},F.extend("MouseAdapter","BaseAdapter"),F.MouseAdapter.Button={Left:0,Middle:1,Right:2},F.MouseAdapter.Capture={Off:0,On:1,DragOnly:2},F.MouseAdapter.Events={mouseDown:1,mouseMove:2,mouseUp:3,mouseScroll:4,touchStartOneFinger:5,touchStartTwoFinger:6,touchMove:7,touchEndOneFinger:8,touchEndTwoFinger:9,mouseLeave:10,unknown:11},F.MouseAdapter.States={initial:1,drag:2,scrollDrag:3,stopScrollDrag:4,hold:5,holdDrag:6},F.MouseAdapter.CLICK_SQDIST=16,F.MouseAdapter.CLICK_SQDIST_TOUCH=36,F.MouseAdapter.DBLCLICK_WAITTIME=400,F.MouseAdapter.DBLCLICK_WAITTIME_TOUCH=800,F.MouseAdapter.DBLCLICK_PICK_TIME_ADDITION=100,F.MouseAdapter.DBLCLICK_SQDIST=25,F.MouseAdapter.DBLCLICK_SQDIST_TOUCH=2500,F.MouseAdapter.HOLD_WAITTIME_TOUCH=400,F.MouseAdapter.HOLD_SQDIST=25,F.MouseAdapter.HOLD_SQDIST_TOUCH=225,F.MouseAdapter.PAN_SQDIST_TOUCH=64,F.MouseAdapter.SCROLL_DIST_TOUCH=8,F.MouseHandler=function(){},F.MouseHandler.prototype={onClick:function(){},onDblClick:function(){},onDragStart:function(){},onDragMove:function(){},onDragStop:function(){},onScrollStart:function(){},onScroll:function(){},onScrollStop:function(){},onHoldStart:function(){},onHoldMove:function(){},onHoldStop:function(){}},F.extend("MouseHandler"),F.MouseAdapterExt=function(e,t,i){this._usePointerEvents=!!(window.PointerEvent&&navigator.pointerEnabled||!window.PointerEvent&&window.MSPointerEvent),this._peTouches=[],F.MouseAdapter.call(this,e,t,i)},F.MouseAdapterExt.prototype={listenersOnOff:function(e){var t=F.MouseAdapterExt.PEvent,i=this._onEventProxied,n=$(this._capture?window:this._node);this._usePointerEvents?(n[e](t.POINTER_DOWN+" "+t.POINTER_MOVE+" "+t.POINTER_UP,i),this._capture||$(this._node)[e](t.POINTER_LEAVE,i),$(this._node)[e]("mousewheel DOMMouseScroll",i)):F.MouseAdapter.prototype.listenersOnOff.call(this,e)},onEvent:function(e){var t=F.MouseAdapterExt.PEvent;if(e.preventDefault(),this._usePointerEvents&&e.type.lastIndexOf(t.POINTER_PREFIX,0)>=0){if(e=this.transformPointerEvent(e),e===t.IGNORE)return;if(e===t.UNKNOWN)return this.pointerResetTouchState(),void this.initial()}F.MouseAdapter.prototype.onEvent.call(this,e)},transformPointerEvent:function(e){var t=F.MouseAdapterExt.PEvent,i=e.originalEvent.pointerType,n=(e.originalEvent.pointerId,e.originalEvent.button,e.originalEvent.pageX),o=e.originalEvent.pageY;return"mouse"!==i&&"touch"!==i&&4!==i&&2!==i?t.IGNORE:"touch"===i||2===i?this.transformPointerTouchEvent(e,n,o):0===this._peTouches.length?this.pointerToMouseEvent(e,n,o):e.type===t.POINTER_MOVE||e.type===t.POINTER_LEAVE?t.IGNORE:(this.pointerResetTouchState(),t.UNKNOWN)},pointerToMouseEvent:function(e,t,i){var n,o=F.MouseAdapterExt.PEvent;switch(e.type){case o.POINTER_MOVE:n="mousemove";break;case o.POINTER_DOWN:n="mousedown";break;case o.POINTER_UP:n="mouseup";break;case o.POINTER_LEAVE:n="mouseleave"}return{type:n,button:e.originalEvent.button,pageX:t,pageY:i,originalEvent:{},preventDefault:function(){e.preventDefault()},stopPropagation:function(){e.stopPropagation()}}},transformPointerTouchEvent:function(e,t,i){var n,o=F.MouseAdapterExt.PEvent,r=e.originalEvent.pointerId,a=o.UNKNOWN;switch(e.type){case o.POINTER_MOVE:n=this.findTouchPointerId(r),n>=0&&(this._peTouches[n].pageX=t,this._peTouches[n].pageY=i,a=this.pointerToTouchEvent(e,"touchmove",n));break;case o.POINTER_DOWN:this._peTouches.push({pointerId:r,pageX:t,pageY:i}),a=this.pointerToTouchEvent(e,"touchstart",this._peTouches.length-1);break;case o.POINTER_UP:n=this.findTouchPointerId(r),n>=0&&(this._peTouches[n].pageX=t,this._peTouches[n].pageY=i,a=this.pointerToTouchEvent(e,"touchend",n));break;case o.POINTER_LEAVE:a=o.IGNORE}return a},pointerResetTouchState:function(){F.clearArray(this._peTouches)},findTouchPointerId:function(e){for(var t=this._peTouches,i=0;i<t.length;i++)if(t[i].pointerId===e)return i;return-1},pointerToTouchEvent:function(e,t,i){var n=this._peTouches.map(function(e){return{pageX:e.pageX,pageY:e.pageY}}),o={type:t,originalEvent:{changedTouches:[n[i]]},preventDefault:function(){e.preventDefault()},stopPropagation:function(){e.stopPropagation()}};return"touchend"===t&&(this._peTouches.splice(i,1),n.splice(i,1)),o.originalEvent.touches=n,o}},F.extend("MouseAdapterExt","MouseAdapter"),F.MouseAdapterExt.PEvent=function(){var e=!window.PointerEvent;return{IGNORE:"ignore",UNKNOWN:"unknown",POINTER_DOWN:e?"MSPointerDown":"pointerdown",POINTER_UP:e?"MSPointerUp":"pointerup",POINTER_MOVE:e?"MSPointerMove":"pointermove",POINTER_LEAVE:e?"mouseleave":"pointerleave",POINTER_PREFIX:e?"MSPointer":"pointer"}}(),F.KeyboardAdapter=function(e,t){F.BaseAdapter.call(this,e,t),this.listenersOnOff("on")},F.KeyboardAdapter.prototype={onEvent:function(e){var t=document.activeElement;if(t){var i=t.nodeName.toLowerCase();if("input"===i||"textarea"===i||"select"===i)return}if("keydown"===e.handleObj.type||"keyup"===e.handleObj.type){var n="keydown"===e.handleObj.type?"Press":"Release";switch(e.keyCode){case 38:case 87:this.callHandlerStack(e,"onForward"+n);break;case 40:case 83:this.callHandlerStack(e,"onBackward"+n);break;case 37:case 65:this.callHandlerStack(e,"onLeft"+n);break;case 39:case 68:this.callHandlerStack(e,"onRight"+n);break;case 33:case 82:this.callHandlerStack(e,"onUp"+n);break;case 34:case 70:this.callHandlerStack(e,"onDown"+n);break;case 73:this.callHandlerStack(e,"onI"+n);break;case 74:this.callHandlerStack(e,"onJ"+n);break;case 75:this.callHandlerStack(e,"onK"+n);break;case 76:this.callHandlerStack(e,"onL"+n);break;case 107:this.callHandlerStack(e,"onPlus"+n);break;case 109:this.callHandlerStack(e,"onMinus"+n);break;case 16:this.callHandlerStack(e,"onShift"+n)}}},listenersOnOff:function(e){var t=this._onEventProxied,i=$(this._capture?window:this._node);i[e]("keydown",t),i[e]("keyup",t)}},F.extend("KeyboardAdapter","BaseAdapter"),F.AlertServiceBase=function(){},F.AlertServiceBase.prototype={error:function(){},errorObj:function(){},message:function(){},debugMessage:function(){},tip:function(){}},F.extend("AlertServiceBase"),F.AlertServiceBase.DELAY_SHORT=5e3,F.AlertServiceBase.DELAY_MEDIUM=1e4,F.AlertServiceBase.DELAY_FOREVER=0,angular.module("f.alert",[]),F.DI().registerService("alert",F.AlertServiceBase),angular.module("f.alert").directive("alert",function(){return{transclude:!0,restrict:"E",scope:{type:"@"},template:'<div class="alert alert-{{type}} f_alert f_alert-{{type}} f_textM f_textDark" style="margin-bottom:5px; position:relative;" ng-transclude></div>'}
}),angular.module("f.alert").directive("errorbox",function(){return{scope:{error:"="},template:'<asyncpartial firstload="error" partial="errorbox.html"></asyncpartial>',restrict:"E",link:function(e){e.$watch("error",function(t){t?(e.errorinfo=JSON.stringify(t,void 0,2),e.showErrorInfo=!1):e.errorinfo=""}),e.toggleInfo=function(){e.showErrorInfo=!e.showErrorInfo}}}}),angular.module("f.component",[]),F.PLACEHOLD_EMPTY="",angular.module("f.component").filter("int2rgb",function(){return function(e){return F.ColorGenerator.hexColorFromInt(e)}}),angular.module("f.component").filter("bgcolor",function(){return function(e){return{"background-color":e}}}),angular.module("f.component").filter("startFrom",function(){return function(e,t){return t=+t,e.slice(t)}}),angular.module("f.component").filter("paginate",function(){return function(e,t,i){return e?(t=+t,i=+i,e.slice(t*i,t*i+i)):void 0}}),angular.module("f.component").directive("pagination",function(){return{restrict:"E",scope:{length:"=",index:"=",limit:"="},link:function(e){e.Math=window.Math,e.pages=0,e.collapsed=!1,e.indexes=[],e.setIndex=function(t){e.index=t},e.$watch('index + "|" + limit + "|" + length',function(t){var i=t.split("|"),n=i[0],o=i[1],r=i[2];if(e.pages=Math.ceil(r/o),e.index=Math.max(0,Math.min(e.pages-1,n||0)),e.collapsed=e.pages>7,F.clearArray(e.indexes),e.collapsed){var a;e.index<=3?e.indexes.push(2,3,4,5):e.index>=e.pages-4?(a=e.pages-4,e.indexes.push(a,a+1,a+2,a+3)):(a=e.index,e.indexes.push(a,a+1,a+2))}else for(var s=1;s<=e.pages;s++)e.indexes.push(s)})},template:'<a ng-show="collapsed" class="f_paginationitem f_cursorPointer f_unselectable" ng-class="{ f_selected : index === 0 }" ng-click="setIndex(0)">1</a><span class="f_paginationitem f_unselectable" ng-show="collapsed && indexes[0] != 2">...</span><a class="f_paginationitem f_cursorPointer f_unselectable" ng-class="{ f_selected: index == i - 1 }" ng-repeat="i in indexes" ng-click="setIndex(i - 1)">{{ i }}</a><span class="f_paginationitem f_unselectable" ng-show="collapsed && indexes[indexes.length - 1] != pages - 1">...</span><a ng-show="collapsed" class="f_paginationitem f_cursorPointer f_unselectable" ng-show="pages > 1" ng-class="{ f_selected: index == pages - 1 }" ng-click="setIndex(pages - 1)">{{ pages }}</a>'}}),angular.module("f.component").directive("collapsibleblock",function(){return{scope:{caption:"@",collapsed:"@",line:"@",toggle:"&"},templateUrl:F.partialUrl("collapsibleblock.html"),replace:!0,restrict:"E",transclude:!0,link:function(e,t,i,n,o){var r=t.children("div");o(e.$parent,function(e){r.append(e)}),e.toggleCollapsed=function(){var t="true"==e.collapsed;e.collapsed=t?"false":"true",F.async(function(){e.$apply(function(){e.toggle({collapsed:!t})})})}}}}),angular.module("f.component").directive("chart",function(){return{replace:!0,restrict:"E",transclude:!1,scope:{scalelabel:"@",type:"@",draw:"@",data:"=",tooltipTempl:"@"},link:function(e,t){var i,n,o=t.find(".f_chartCanvasWrapper");e.createCanvas=function(){o.empty(),i=document.createElement("canvas"),o[0].appendChild(i),i.width=o.width(),i.height=o.height(),n=i.getContext("2d")},e.updateChart=function(t,i){e.createCanvas();var o;if(1<t.max){var r=Math.pow(10,Math.floor(F.log10(t.max)));o=Math.ceil(t.max/r)*r}else o=0<t.max?t.max:0;var a=10,s=1;1>=o&&(s=10);var c={scaleOverride:!0,bezierCurve:!1,animation:i,animationSteps:F.isMobile()?40:100,scaleSteps:a,scaleStepWidth:Math.ceil(o/a)/s,scaleStartValue:0,tooltipTemplate:"<%if (label){%><%=label%>: <%}%><%= value.toFixed(3)%>"},l=e.tooltipTempl;l&&(l=l.replace(/\[/g,"<%"),l=l.replace(/\]/g,"%>"),c.tooltipTemplate=l),"2d"===e.type&&("bar"===e.draw?new Chart(n).Bar(t,c):"line"===e.draw?new Chart(n).Line(t,c):"radar"===e.draw&&new Chart(n).Radar(t,c)),"1d"===e.type&&("polararea"===e.draw?new Chart(n).PolarArea(t,c):"pie"===e.draw?new Chart(n).Pie(t,c):"donut"===e.draw&&new Chart(n).Doughnut(t,c))},e.$watch("data",function(t){e.updateChart(t,!0)}),$(window).resize(function(){e.updateChart(e.data,!1)}),e.$on("redrawchart",function(t,i){e.updateChart(e.data,!!i&&i.animate)})},template:'<div><div class="f_chartCanvasWrapper" style="width:100%; height:100%; text-align:center;"></div></div>'}}),angular.module("f.component").directive("chartlegend",function(){return{replace:!0,restrict:"E",transclude:!1,scope:{data:"="},template:'<table class="table"><tr ng-repeat="d in data" style="width:auto"><td class="f_chartLabelColor"><div class="f_chartLabelColor" ng-style="{\'background-color\': d.color}" /> </td><td ng-repeat="col in d.legendLabels track by $index" style="white-space:nowrap; width:auto">{{col}}</td></tr></table>'}}),angular.module("f.component").directive("formrow",function(){return{transclude:!0,restrict:"E",scope:{label:"@"},link:function(e,t,i){e.label=i.label;var n=e.$eval(i.validation);e.rules=[],n.forEach(function(t){var i={message:t.message};e.$parent.$watch(t.show,function(e){i.show=e}),e.rules.push(i)})},template:'<div class="control-group"><label class="f_textM f_alignLeft" style="padding-top:5px">{{label}}</label><div class="controls" ng-transclude></div><ul><li class="f_textError f_textM" ng-repeat="rule in rules" ng-show="rule.show">{{rule.message | i18n}}</li></ul></div>'}}),angular.module("f.component").directive("promise",function(){return{controller:function(){this.thens=[],this.fails=[],this.progress=[]},link:function(e,t,i,n){function o(t){t.forEach(function(t){var i=e.$new();c.push(i),t.transclude(i,function(e){s.push(e),t.element.after(e)})})}function r(){for(;c.length;)c[0].$destroy(),c.shift();for(;s.length;)s[0].remove(),s.shift()}function a(){i.progress&&e.$eval(i.progress+" = undefined")}var s=[],c=[];e.$watch(function(e){return e.$eval(i.promise)},function(t){if(r(),i.then){var s=i.defaultvalue;"string"==typeof s&&(s=e.$eval(s)),F.deepAssign(e,i.then,s)}i.fail&&F.deepAssign(e,i.fail,void 0),Q.isPromise(t)&&(o(n.progress),t.progress(function(t){e.$apply(function(){a(t)})}).then(function(t){r(),e.$apply(function(){a(),i.then&&F.deepAssign(e,i.then,t),o(n.thens)})},function(t){r(),e.$apply(function(){a(),i.fail&&F.deepAssign(e,i.fail,t),o(n.fails)})}).done())})},restrict:"EA"}}),angular.module("f.component").directive("promisethen",function(){return{transclude:"element",require:"^promise",priority:500,compile:function(e,t,i){return function(e,t,n,o){o.thens.push({transclude:i,element:t})}}}}),angular.module("f.component").directive("promisefail",function(){return{transclude:"element",require:"^promise",priority:500,compile:function(e,t,i){return function(e,t,n,o){o.fails.push({transclude:i,element:t})}}}}),angular.module("f.component").directive("promiseprogress",function(){return{transclude:"element",require:"^promise",priority:500,compile:function(e,t,i){return function(e,t,n,o){o.progress.push({transclude:i,element:t})}}}}),angular.module("f.component").directive("unitedit",function(){return{link:function(e){var t,i=function(){if(t)if(F.validateNumber(e.model))e.internalModel=void 0;else{var i=e.precision||0;e.internalModel=+t.getValue(e.model,i)}},n=function(){var n=e.unitclass||F.LengthUnit;t=new n(e.unit,e.inverse),i()};e.$watch("unitclass",n),e.$watch("unit",n),e.$watch("precision",i);var o=!1;e.$watch("model",function(){o||i(),o=!1}),e.focusLost=i,e.internalModelChange=function(){var i=e.internalModel;o=!0,e.model=!e.validateNumber(i)&&t?t.convertToBaseUnit(parseFloat(i)):void 0,F.async(function(){e.$apply(function(){e.change({newValue:e.model})})})},e.formatUnit=function(){return t?t.getUnitString():""},e.validateNumber=F.validateNumber},restrict:"E",scope:{model:"=",unitclass:"=",unit:"=",change:"&",precision:"=",inverse:"=",unitcaption:"@",icon:"@",disabled:"="},template:'<div class="input-group"><div ng-if="icon" class="input-group-addon" style="max-width: 50px;padding-left: 8px;"><img class="f_icon32" static-src="icons/{{icon}}"/></div><input class="form-control" type="number" ng-model="internalModel" ng-change="internalModelChange()" ng-blur="focusLost()" ng-disabled="disabled" id="appendedInput"><div class="input-group-addon f_textSM"><span ng-if="unitcaption">{{unitcaption}}</span>{{formatUnit(unit)}}</div></div><div class="f_textBold f_textM f_textError" style="overflow:visible">{{validateNumber(internalModel) | i18n}}</div>'}}),angular.module("f.component").directive("ngEnter",function(){return function(e,t,i){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(i.ngEnter)}),t.preventDefault())})}}),angular.module("f.component").directive("markdown",function(){var e=F.DI().get("$sanitize"),t=new Showdown.converter;return{restrict:"E",link:function(i,n,o){var r=!1;i.$watch(o.source,function(i){r=r||!!i,n.html(r?e(t.makeHtml(i||"")):t.makeHtml(n.text()))})}}}),angular.module("f.component").directive("tasktagpicker",function(){return{restrict:"E",replace:!0,scope:{input:"=",tags:"="},link:function(e){e.addTag=function(t){if(t)F.addUnique(e.input.tags,t);else if(e.input.tagToAdd){var i=e.input.tagToAdd.split(/[\s]+/);i.forEach(function(t){F.addUnique(e.input.tags,t)})}e.input.tagToAdd=""},e.removeTag=function(t){F.removeFirst(e.input.tags,t)}},template:'<div><div style="padding: 5px;"><p ng-show="input.operation === \'add\'">{{\'FE_TAGS_TO_ADD\'|i18n}}:<p/><p ng-show="input.operation ===\'remove\'">{{\'FE_TAGS_TO_REMOVE\'|i18n}}:<p/><alert type="info" ng-show="input.tags.length === 0">{{ \'FE_SELECT_TAGS_NONE\' | i18n }}</alert><span ng-repeat="tag in input.tags"><span style="cursor:pointer;margin-bottom:5px;" title="{{\'FE_REMOVE_TAG\'|i18n}}" ng-click="removeTag(tag)" class="f_label f_labelInteractive">{{tag}} <img style="margin-bottom:2px" class="f_icon16" static-src="icons/im/checked_false.png"></span></span></div><div ng-show="tags" class="f_taskSubContainer"><p ng-show="input.operation === \'add\'">{{\'FE_SELECT_TAGS_ADD\'|i18n}}:<p/><p ng-show="input.operation === \'remove\'">{{\'FE_SELECT_TAGS_REMOVE\'|i18n}}:<p/><div style="width:100%;max-height:200px;overflow-y:auto;"><div ng-repeat="tag in tags" class="f_hover" ng-click="addTag(tag.Tag)" style="width:100%;height:40px;padding-top:6px;" title="{{\'FE_ADD_TAG\'|i18n}}"><span style="cursor:pointer;margin:5px;padding: 5px 20px 5px 20px; margin: 1px 0px 0px 5px;" class="f_label f_labelInteractive">{{tag.Tag}} </span></div></div></div><form  ng-show="input.operation != \'remove\'" style="margin-top:10px; margin-bottom:5px; width:230px !important"><div class="input-group"><input class="form-control" type="text" ng-model="input.tagToAdd" style="width:140px !important" placeholder="{{\'FE_NEW_TAG\'|i18n}}"/><button ng-click="addTag()" title="{{\'FE_ADD_TAG\'|i18n}}" class="btn btn-default input-group-addon" style="width:90px !important; height:34px;">{{\'FE_PUSH\'|i18n}}</button></div></form></div>'}}),angular.module("f.component").directive("taskcategorypicker",function(){return{restrict:"E",replace:!0,scope:{input:"=",categories:"="},link:function(e){e.setCategory=function(t){t?e.input.category=t:(e.input.category=e.input.catToSet,e.input.catToSet=void 0)},e.removeCategory=function(){e.input.category=""}},template:'<div><div ng-if="input.category" style="padding: 5px;"><p>{{\'FE_CURRENT_CATEGORY\'|i18n}}:<p/><category class="f_catWrapper f_textM" text="input.category" interactive="true" title="{{\'FE_REMOVE_CATEGORY\'|i18n}}" ng-click="removeCategory()"/><br><br></div><div ng-show="categories" class="f_taskSubContainer"><p>{{\'FE_EXIST_CATEGORY\'|i18n}}:<p/><div style="width:100%;max-height:200px;overflow-y:auto;"><div ng-repeat="cat in categories" class="f_hover" ng-click="setCategory(cat.Category)" style="width:100%;height:40px;padding-top:6px;"><category class="f_catWrapper f_textM" text="cat.Category" interactive="false"/></div></div></div><form  style="margin-top:10px; margin-bottom:5px; width:230px !important"><div class="input-group"><input class="form-control" type="text" ng-model="input.catToSet" style="width:140px !important;" placeholder="{{\'FE_NEW_CATEGORY\'|i18n}}"/><button ng-click="setCategory()" title="{{\'FE_SET_CATEGORY\'|i18n}}" class="btn btn-default input-group-addon" style="width:90px !important; height:34px;">{{\'FE_SET\'|i18n}}</button></div></form></div>'}}),angular.module("f.component").directive("actionbar",function(){return{replace:!0,restrict:"E",transclude:!0,link:function(){},template:'<div><div ng-if="page.actionBarActive === true" unselectable="off" class="f_actionBarWrapper"><div ng-transclude></div></div><div class="f_actionBarTrigger" ng-click="page.actionBarActive = !page.actionBarActive"></div></div>'}}),angular.module("f.component").directive("actionbarextension",function(){return{require:"?^actionbar",replace:!0,restrict:"E",transclude:!0,link:function(){},template:'<div ng-transclude unselectable="off" class="f_actionBarWrapper f_actionBarExtensionCtrlWrapper"></div>'}}),angular.module("f.component").directive("buttongroup",function(){return{require:"?^actionbar",scope:{vertical:"@"},replace:!0,restrict:"E",transclude:!0,link:function(){},template:'<div ng-transclude class="f_actionBarVertical" ng-class="{\'btn-group-vertical\': vertical == true}" style="margin-bottom:5px;"></div>'}}),angular.module("f.component").directive("validatepassword",function(){return{require:"ngModel",link:function(e,t,i,n){n.$parsers.unshift(function(t){return e.validatePassword(t)}),e.validatePassword=function(e){var t=F.validatePassword(e);return void 0===t?(n.$setValidity("validatepassword",!0),e):void n.$setValidity("validatepassword",!1)}}}}),angular.module("f.component").directive("passwordsequal",function(){return{require:"ngModel",link:function(e,t,i,n){n.$parsers.unshift(function(t){return t===e.formData.password?(n.$setValidity("passwordsequal",!0),t):void n.$setValidity("passwordsequal",!1)})}}}),angular.module("f.component").directive("emailvalid",function(){return{require:"ngModel",link:function(e,t,i,n){n.$parsers.unshift(function(t){return e.validateEmail(t)}),n.$formatters.unshift(function(t){return e.validateEmail(t)}),e.validateEmail=function(e){return void 0===F.validateEmail(e)?(n.$setValidity("emailvalid",!0),e):void n.$setValidity("emailvalid",!1)}}}}),angular.module("f.component").directive("locationvalid",function(){return{require:"ngModel",link:function(e,t,i,n){n.$parsers.unshift(function(t){return e.validateLocation(t)}),n.$formatters.unshift(function(t){return e.validateLocation(t)}),e.validateLocation=function(e){return!e||e&&!F.validateLocation(e.toString())?(n.$setValidity("locationvalid",!0),e):void n.$setValidity("locationvalid",!1)}}}}),angular.module("f.component").directive("filenamevalid",function(){return{require:"ngModel",link:function(e,t,i,n){var o=/^(?!(?:CON|PRN|AUX|NUL|COM[1-9]|LPT[1-9])(?:\.[^.]*)?$)[^<>:"/\\|?*\x00-\x1F]*[^<>:"/\\|?*\x00-\x1F\ .]$/i;n.$parsers.unshift(function(t){return e.validateFilename(t)}),n.$formatters.unshift(function(t){return e.validateFilename(t)}),e.validateFilename=function(e){return e&&e.toString().match(o)?(n.$setValidity("filenamevalid",!0),e):void n.$setValidity("filenamevalid",!1)}}}}),angular.module("f.component").directive("numbervalid",function(){return{require:"ngModel",link:function(e,t,i,n){n.$parsers.unshift(function(t){return e.validateNumber(t)}),n.$formatters.unshift(function(t){return e.validateNumber(t)}),e.validateNumber=function(e){var t=F.validateNumber(e);return void 0===t||void 0===e||""===e?(n.$setValidity("numbervalid",!0),e):void n.$setValidity("numbervalid",!1)}}}}),angular.module("f.component").directive("ipv4valid",function(){return{require:"ngModel",link:function(e,t,i,n){n.$parsers.unshift(function(t){return e.validateIpAddress(t)}),n.$formatters.unshift(function(t){return e.validateIpAddress(t)}),e.validateIpAddress=function(e){var t=F.validateIpV4Address(e);return void 0===t?(n.$setValidity("ipv4valid",!0),e):void n.$setValidity("ipv4valid",!1)}}}}),angular.module("f.component").directive("focusMe",["$parse",function(e){return{link:function(t,i,n){var o=e(n.focusMe);t.$watch(o,function(e){e&&(F.isMobile()||F.async(function(){$(i[0]).find(".form-control").focus()}))})}}}]),angular.module("f.component").directive("scrollChange",[function(){return{scope:{scrollChange:"="},link:function(e,t,i){var n=0;i.scrollThreshold&&(n=parseInt(i.scrollThreshold)),e.$emit("f_scroll",function(t){var i=t.target||t.srcElement;e.$apply(function(e){e.scrollChange=i.scrollTop>n})})}}}]),angular.module("f.component").directive("spinner",function(){return{scope:{},replace:!0,restrict:"E",transclude:!0,link:function(){},template:'<div class="f_spinnerWrapper"><div class="f_spinnerRotator"></div><div ng-transclude></div></div>'}}),F.ApiWrapperBoxcom=function(e){this._script=e},F.ApiWrapperBoxcom.prototype={load:function(){return this._script.getScript(F.ApiWrapperBoxcom.apiConfig.script_id).requireOnce()},getLinks:function(){if(!window.BoxSelect)return Q.reject();var e=Q.defer(),t={clientId:F.ApiWrapperBoxcom.apiConfig.api_key,linkType:"direct",multiselect:!0};try{var i=new BoxSelect(t);i.success(function(t){var i=t.map(function(e){return new F.Hyperlink(e.url,e.name,F.ApiWrapperBoxcom.apiConfig.provider_id)});e.resolve(i)}),i.cancel(function(){e.resolve([])}),i.launchPopup()}catch(n){e.reject(n)}return e.promise}},F.ApiWrapperBoxcom.apiConfig={script_url:"https://app.box.com/js/static/select.js",script_id:"boxcomAPI",api_key:"spbpd479cawgqvxvtoqbm2xnt6k9hc32",dev_id:void 0,provider_caption:"Box.com",provider_id:"boxcom",ownsUrl:function(e){return e.indexOf("boxcloud")>=0}},F.ApiWrapperDropbox=function(e){this._script=e},F.ApiWrapperDropbox.prototype={load:function(){return this._script.getScript(F.ApiWrapperDropbox.apiConfig.script_id).requireOnce()},getLinks:function(){if(!window.Dropbox)return Q.reject();var e=Q.defer(),t={success:function(t){var i=t.map(function(e){return new F.Hyperlink(e.link,e.name,F.ApiWrapperDropbox.apiConfig.provider_id)});e.resolve(i)},cancel:function(){e.resolve([])},linkType:"preview",multiselect:!0};try{Dropbox.appKey=F.ApiWrapperDropbox.apiConfig.api_key,Dropbox.choose(t)}catch(i){e.reject(i)}return e.promise}},F.ApiWrapperDropbox.apiConfig={script_url:"https://www.dropbox.com/static/api/2/dropins.js",script_id:"dropboxAPI",api_key:"u2oqlz503my0cdw",dev_id:void 0,provider_caption:"Dropbox",provider_id:"dropbox",ownsUrl:function(e){return e.indexOf("dropbox")>=0}},F.HyperlinkEditor=function(e,t,i,n,o){F.PlugController.call(this,e,t);var r=this;this._script=i,this._alert=n,this._apis={};var a="cloudstorage_on";e.cloudStorageOn="1"===o.getLocalStorageItem(a),e.input.cloudStorageLinks=[],e.providerClick=function(t){var i=e.providers[t];i.loaded?r.filesFrom(t):r.loadProvider(t)},e.cloudStorageChanged=function(){if(e.cloudStorageOn)for(var t in e.providers)r.loadProvider(t);o.setLocalStorageItem(a,e.cloudStorageOn?"1":"0")},e.addLink=function(){if(e.input.linkToAdd){var t=e.input.linkToAdd.split(/[\s]+/);t.forEach(function(t){e.input.hyperlinkObjects.push(new F.Hyperlink(t))})}e.input.linkToAdd=""},e.removeLink=function(e,t){F.removeFirst(t,e)},e.providers={};for(var s in F.Hyperlink._providers)this.addProvider(s);e.cloudStorageOn&&e.cloudStorageChanged()},F.HyperlinkEditor.prototype={addProvider:function(e){var t=F.Hyperlink._providers[e];this.$scope.providers[e]={conf:t.apiConfig,loading:!1,loaded:void 0},this._apis[e]=new t(this._script,this._alert)},loadProvider:function(e){var t=this,i=this.$scope,n=i.providers[e];n.loaded||n.loading||(n.loading=!0,n.loaded=void 0,this._apis[e].load().then(function(){i.$apply(function(){n.loading=!1,n.loaded=!0})},function(e){i.$apply(function(){n.loading=!1,n.loaded=!1}),e&&e._repeated||t._alert.error("EM_CONN_API_ERROR",void 0,void 0,[n.conf.provider_caption])}).done())},filesFrom:function(e){var t=this,i=this._apis[e],n=this.$scope.providers[e].conf,o=n.provider_caption;i.getLinks().then(function(e){t.$scope.$apply(function(){e.forEach(function(e){t.$scope.input.hyperlinkObjects.push(e)})})},function(){t._alert.error("EM_CONN_API_ERROR",void 0,void 0,[o])}).done()}},F.extend("HyperlinkEditor","PlugController"),F.DI().registerController("hyperlinkeditor",F.HyperlinkEditor,"@plug","@script","@alert","@cookie"),angular.module("f.component").directive("hyperlinkeditor",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("hyperlinkeditor"),scope:{input:"="},template:'<div><div style="margin-bottom:15px; width:230px !important"><p>{{\'TD_CREATE_HLINK\'|i18n}}</p><div class="input-group" style="margin-top: -5px;"><input class="form-control" type="text" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false" ng-model="input.linkToAdd" style="width:140px !important" placeholder="{{\'FE_NEW_LINK\'|i18n}}"/><button ng-click="addLink()" title="{{\'FE_ADD_LINK\'|i18n}}" class="btn btn-default input-group-addon" style="width:90px !important; height:34px;">{{\'FE_PUSH\'|i18n}}</button></div></div><div class="f_taskSubContainer" style="margin-bottom:25px; position: relative;"><p>{{\'FE_DROPBOX_FILES\'|i18n}}</p><div class="checkbox"><label><input type="checkbox" class="large" ng-model="cloudStorageOn" ng-change="cloudStorageChanged()">{{\'FE_ENABLE\'|i18n}}</label></div><div ng-if="!cloudStorageOn" style="position: absolute; right: 0px; bottom: -4px;"><img ng-if="!cloudStorageOn" ng-repeat="p in providers" class="f_icon28" static-src="icons/{{p.conf.provider_id}}.png"/></div><div ng-if="cloudStorageOn" class="btn-group centered" style="margin-left: 24px;"><button ng-repeat="p in providers" ng-disabled="p.loading" class="btn btn-default" ng-click="providerClick(p.conf.provider_id)" title="{{p.conf.provider_caption}}" style="width:85px;"><img class="f_icon32" static-src="icons/{{p.conf.provider_id}}.png"/><img ng-show="p.loading" class="f_icon16" static-src="icons/im/spinner.gif" style="position: absolute; right: 5px; top: 5px;" /><img ng-show="p.loaded === false" class="f_icon24" static-src="icons/im/alerts/warning.png" style="position: absolute; right: 0px; top: 0px;" /></button></div></div><div><alert type="info" ng-show="input.hyperlinkObjects.length === 0 && input.hyperlinkObjects.length===0">{{ \'FE_LINKS_NONE\' | i18n }}</alert><div ng-repeat="link in input.hyperlinkObjects" style="width:100%; margin-bottom:2px;" class="btn-group"><a href="{{link._url | linkify}}" target="_blank" title="{{\'FE_OPEN_LINK\'|i18n}}: {{link._url}}" class="f_textS btn btn-default" style="width: 79%;overflow: hidden;height: 35px; text-align:left;"><img class="f_icon20" static-src="icons/{{link._provider}}.png" ><div style="margin-left:3px; display:inline-block;" >{{link._description}}</div><div style="width:3px;display:inline-block;"></div></a><button ng-click="removeLink(link, input.hyperlinkObjects)" class="btn btn-default" title="{{\'FE_CLICK_TO_REMOVE\'|i18n}}: {{link._filename}}"><img class="f_icon20" static-src="icons/im/checked_false.png" ></button></div><div ng-repeat="link in input.hyperlinks" style="width:100%; margin-bottom:2px;" class="btn-group"><a href="{{link | linkify}}" target="_blank" title="{{\'FE_OPEN_LINK\'|i18n}}: {{link | linkify}}" class="f_textS btn btn-default" style="width: 79%;overflow: hidden;height: 35px; text-align:left;"><img class="f_icon20" static-src="icons/extlink.png" style="vertical-align: bottom;"><div style="margin-left:3px; display:inline-block;" >{{link}}</div><div style="width:3px;display:inline-block;"></div></a><button ng-click="removeLink(link, input.hyperlinks)" class="btn btn-default" title="{{\'FE_CLICK_TO_REMOVE\'|i18n}}: {{link | linkify}}"><img class="f_icon20" static-src="icons/im/checked_false.png" ></button></div></div></div>'})}),F.DI().config("@script",F.hyperlinkConfig=function(e){[F.ApiWrapperBoxcom,F.ApiWrapperDropbox].forEach(function(t){e.registerScript(t.apiConfig.script_id,t.apiConfig.script_url),F.Hyperlink.registerProvider(t)})}),F.RadialMenuItem=function(e,t){F.PlugController.call(this,e,t),this.$scope=e;var i=this;e.visible=!1,e.enabled=!0,e.x=0,e.y=0,e.icon="",e.type="",e.menu=void 0,e.checkbox={show:!1,checked:!1,x:0,y:0},e.title="",e.setPosition=function(e,t){var n=i.$scope;n.x=e,n.y=t},e.execute=function(){var e=i.$scope;if(e.enabled){var t=i.getSubMenuType();"OkCancel"==t?e.menu.showSubMenuOkCancel(e).then(function(t){t&&i.execute(),e.menu.closeMenu()},function(){e.menu.closeMenu()}):(i.execute(),e.menu.closeMenu())}}},F.RadialMenuItem.prototype={getSubMenuType:function(){return"remove"==this.$scope.type?"OkCancel":""},execute:function(){var e,t=this.$scope.menu.object,i=this.$scope.type,n=F.DI().getParameter(this.$scope.menu.impl);try{e=n.execute[i](t)}catch(o){e=Q.reject(o)}e&&n.error&&e.fail(function(e){n.error(e,i,t)}).done()}},F.extend("RadialMenuItem","PlugController"),F.RadialMenu=function(e,t){F.PlugController.call(this,e,t),this.$scope=e;var i=this;e.object=void 0,e.visible=!1,e.x=0,e.y=0,e.impl="",e.items=[],e.subItems=[],e.q=void 0,e.defer=void 0,e.showMenu=function(){var e=i.$scope;if(void 0!==e.object){i.hideAll();var t=e.object,n=F.DI().getParameter(e.impl),o=e.items.map(function(e){var i=e.type,o=n.evaluate[i](t);return Q.when(o,function(r){var a;return r&&n.options&&n.options[i]&&(a=n.options[i](t)),Q.all([Q.resolve(e),o,Q(a)])})}),r=i._promiseEval=Q.all(o);r.then(function(n){if(i._promiseEval===r&&e.object===t){i._promiseEval=void 0;var o=[];n.forEach(function(e){var t=e[0],i=e[1],n=e[2];i&&(o.push(t),n&&(t.checkbox=n.checkbox,t.title=n.title))}),1<=o.length&&e.$apply(function(){i.showItems(o),i.arrangeItems(o),e.visible=!0})}})}},e.showSubMenu=function(e,t){var n=i.$scope;if(void 0!==n.object){i.hideAll();var o=[];"OkCancel"==e&&n.subItems.forEach(function(e){("ok"==e.type||"cancel"==e.type)&&o.push(e)}),1<=o.length&&(t.enabled=!1,t.visible=!0,i.showSubItems(o),i.arrangeSubItems(o,t),n.visible=!0)}},e.showSubMenuOkCancel=function(e){var t=i.$scope;return t.showSubMenu("OkCancel",e),t.defer=t.q.defer(),t.defer.promise},e.closeMenu=function(){var e=i.$scope;e.defer&&e.defer.resolve(!1),e.defer=void 0,i.hideAll();var t=F.DI().getParameter(e.impl);t.execute.unhighlight&&t.execute.unhighlight(e.object),e.visible=!1,e.object=void 0}},F.RadialMenu.prototype={hideItems:function(){this.$scope.items.forEach(function(e){e.visible=!1})},hideSubItems:function(){this.$scope.subItems.forEach(function(e){e.visible=!1})},hideAll:function(){this.hideItems(),this.hideSubItems()},showItems:function(e){e.forEach(function(e){e.enabled=!0,e.visible=!0})},showSubItems:function(e){e.forEach(function(e){e.visible=!0})},arrangeItems:function(e){for(var t=e.length,i=8>=t?90:90+10*(t-8),n=2*Math.PI/t,o=0;t>o;++o){var r=n*(o-1*t/4),a=Math.floor(Math.cos(r)*i)-30,s=Math.floor(Math.sin(r)*i)-30;e[o].setPosition(a,s)}},arrangeSubItems:function(e,t){for(var i=e.length,n=4>=i?75:75+10*(i-4),o=2*Math.PI/i,r=0;i>r;++r){var a=o*(r-1*i/2),s=t.x+Math.floor(Math.cos(a)*n),c=t.y+Math.floor(Math.sin(a)*n);e[r].setPosition(s,c)}}},F.extend("RadialMenu","PlugController"),F.RadialSubMenuItem=function(e,t){F.PlugController.call(this,e,t),this.$scope=e;var i=this;e.visible=!1,e.x=0,e.Y=0,e.icon="",e.type="",e.menu=void 0,e.setPosition=function(e,t){var n=i.$scope;n.x=e,n.y=t},e.resolve=function(){var e=i.$scope;e.menu.defer.resolve("ok"==e.type?!0:"cancel"==e.type?!1:!1)}},F.RadialSubMenuItem.prototype={},F.extend("RadialSubMenuItem","PlugController"),angular.module("f.component.radialmenu",[]),F.DI().registerController("radialsubmenuitem",F.RadialSubMenuItem,"@plug"),F.DI().registerController("radialmenuitem",F.RadialMenuItem,"@plug"),F.DI().registerController("radialmenu",F.RadialMenu,"@plug"),angular.module("f.component.radialmenu").directive("radialmenu",["$q",function(e){return F.PlugController.createDirective({link:function(t){t.$watch("object",function(i,n){if(void 0!==n&&i!=n){var o=F.DI().getParameter(t.impl);o.execute.unhighlight&&o.execute.unhighlight(n)}void 0!==i&&i!=n&&(t.q=e,t.showMenu())})},controllerClass:F.DI().getController("radialmenu"),restrict:"E",scope:{x:"=",y:"=",visible:"=",object:"=",impl:"@",auto:"@"},transclude:!0,template:'<div class="f_rmRm" ng-show="visible" ng-style="{left: x, top: y}"><radialsubmenuitem icon="icons/im/checked_true.png" type="ok" title="{{\'FE_OK\'|i18n}}"></radialsubmenuitem><radialsubmenuitem icon="icons/im/checked_false.png" type="cancel" title="{{\'FE_CANCEL\'|i18n}}"></radialsubmenuitem><div ng-transclude></div></div>'})}]),angular.module("f.component.radialmenu").directive("radialmenuitem",function(){return F.PlugController.createDirective({link:function(e,t,i,n){var o=F.DI().getService("locale");n.$scope.items.push(e),e.menu=n.$scope,e.$watch("title",function(e){e&&i.$set("title",o.translate(e))})},controllerClass:F.DI().getController("radialmenuitem"),require:"^radialmenu",restrict:"E",scope:{type:"@",icon:"@"},template:'<div class="f_rmCircle" ng-show="visible" ng-click="execute()" ng-class="{f_rmDisabled: !enabled}" ng-style="{marginLeft: x + \'px\', marginTop: y + \'px\'}"><span class="f_rmMiddle"></span><img static-src="{{icon}}" /><img ng-show="checkbox.show" static-src="icons/im/checked_{{checkbox.checked}}.png" class="f_rmCheckbox" ng-style="{left: checkbox.x + \'px\', top: checkbox.y + \'px\'}" /></div>'})}),angular.module("f.component.radialmenu").directive("radialsubmenuitem",function(){return F.PlugController.createDirective({link:function(e,t,i,n){n.$scope.subItems.push(e),e.menu=n.$scope},controllerClass:F.DI().getController("radialsubmenuitem"),require:"^radialmenu",restrict:"E",scope:{type:"@",icon:"@"},template:'<div class="f_rmCircle" ng-show="visible" ng-click="resolve()" ng-style="{marginLeft: x + \'px\', marginTop: y + \'px\'}"><span class="f_rmMiddle"></span><img static-src="{{icon}}" /></div>'})}),createNamespace("WS","F"),WS.Version={_version:"@version 2.3.6.3"},WS.Version.getVersion=function(){return WS.Version._version.substr(8)},WS._2GO=window.WS2GO,angular.module("ws.filter",[]),angular.module("ws.widget",[]),WS.Layer=function(e,t,i,n,o,r,a,s,c){WS.CRUDObject.call(this,e),this._id=t,this._resourceKeyForName=i,this._viewType=n,this._viewId=o,this._visible=void 0!==r?r:!0,this._render=!0,this._zIndex=void 0!==a?a:0,this._visibleDistanceThres=void 0!==s?s:1e3,this._visibleDistanceThresEnabled=void 0!==c?c:!1,this._forcedMaxDistance=void 0,this._cookieId="layer."+this._id+"."+this._viewType},WS.Layer.prototype={renderLayer:function(){return this._visible&&this._render},clone:function(){return new WS.Layer(this._service,this._id,this._resourceKeyForName,this._viewType,this._viewId,this._visible,this._zIndex,this._visibleDistanceThres,this._visibleDistanceThresEnabled)},getName:function(){return this._resourceKeyForName},writeToLocalStorage:function(){var e={visible:this._visible,visibleDistanceThresEnabled:this._visibleDistanceThresEnabled,visibleDistanceThres:this._visibleDistanceThres};this._service._cookie.setLocalStorageItem(this._cookieId,JSON.stringify(e))},getFromLocalStorage:function(){var e=JSON.parse(this._service._cookie.getLocalStorageItem(this._cookieId));e&&(this._visible=e.visible,this._visibleDistanceThresEnabled=e.visibleDistanceThresEnabled,this._visibleDistanceThres=e.visibleDistanceThres)},removeLocalStorageItem:function(){this._service._cookie.removeLocalStorageItem(this._cookieId)}},WS.extend("Layer","CRUDObject"),WS.Layer.LayerIDs={DEFAULT:"Default",ANNOTATIONS:"Annotation",MEASUREMENTS:"Measurements",SCANS:"Scans",ORTHOPHOTOS:"Orthophoto",TEMP:"Temp",PANO:"Pano",POINT_CLOUD:"PtCloud",VIEW_CAM:"ViewCamera",DYNAMIC:"Dynamic"},WS.Layer.ViewTypes={PANO_VIEW:"PanoramaView",OVERVIEW_MAP:"OverviewMap"},WS.LayerService=function(e,t){WS.PlugModule.call(this,e),this._cookie=t,this._entities=[],this._tempEntities=[],this.getNew(WS.Layer.LayerIDs.VIEW_CAM,"FE_PANO_VIEW_CAM",WS.Layer.ViewTypes.OVERVIEW_MAP,!0,0).create(),this.getNew(WS.Layer.LayerIDs.ORTHOPHOTOS,"FE_ORTHOPHOTO",WS.Layer.ViewTypes.OVERVIEW_MAP,!0,0).create(),this.getNew(WS.Layer.LayerIDs.MEASUREMENTS,"FE_MEASUREMENT",WS.Layer.ViewTypes.OVERVIEW_MAP,!0,1).create(),this.getNew(WS.Layer.LayerIDs.ANNOTATIONS,"FE_ANNOTATION",WS.Layer.ViewTypes.OVERVIEW_MAP,!0,2).create(),this.getNew(WS.Layer.LayerIDs.SCANS,"FE_SCANPOSITION",WS.Layer.ViewTypes.OVERVIEW_MAP,!0,3).create(),this.getNew(WS.Layer.LayerIDs.TEMP,"FE_TEMP_OBJECT",WS.Layer.ViewTypes.OVERVIEW_MAP,!0,4).create(),this.getNew(WS.Layer.LayerIDs.DYNAMIC,"FE_TEMP_OBJECT",WS.Layer.ViewTypes.OVERVIEW_MAP,!0,5,100,!1).create(),this.getNew(WS.Layer.LayerIDs.PANO,"FE_PANO_IMAGE",WS.Layer.ViewTypes.PANO_VIEW,!0,0,100,!1).create(),this.getNew(WS.Layer.LayerIDs.POINT_CLOUD,"FE_POINT_CLOUD",WS.Layer.ViewTypes.PANO_VIEW,!0,1,100,!1).create(),this.getNew(WS.Layer.LayerIDs.ORTHOPHOTOS,"FE_ORTHOPHOTO",WS.Layer.ViewTypes.PANO_VIEW,!0,2,100,!1).create(),this.getNew(WS.Layer.LayerIDs.SCANS,"FE_SCANPOSITION",WS.Layer.ViewTypes.PANO_VIEW,!0,3,50,!0).create(),this.getNew(WS.Layer.LayerIDs.MEASUREMENTS,"FE_MEASUREMENT",WS.Layer.ViewTypes.PANO_VIEW,!0,3,100,!1).create(),this.getNew(WS.Layer.LayerIDs.ANNOTATIONS,"FE_ANNOTATION",WS.Layer.ViewTypes.PANO_VIEW,!0,3,100,!1).create(),this.getNew(WS.Layer.LayerIDs.TEMP,"FE_TEMP_OBJECT",WS.Layer.ViewTypes.PANO_VIEW,!0,3,100,!1).create(),this.getNew(WS.Layer.LayerIDs.DYNAMIC,"FE_TEMP_OBJECT",WS.Layer.ViewTypes.PANO_VIEW,!0,4,100,!1).create(),this.provideMalePlug("ObjectUpdate",["updateObjects"])
},WS.LayerService.prototype={getNew:function(e,t,i,n,o,r,a){var s=this.viewType(i),c=this.viewInstance(i),l=new WS.Layer(this,e,t,s,c,n,o,r,a);return l.getFromLocalStorage(),l},getAll:function(e,t){var i=[],n=Q.defer();if(e){var o=this.viewType(e),r=this.viewInstance(e);r?this._tempEntities.forEach(function(e){e._viewType===o&&e._viewId===r&&i.push(e.clone())}):this._entities.forEach(function(e){e._viewType===o&&i.push(e.clone())})}else this._entities.forEach(function(e){i.push(e.clone())}),this._tempEntities.forEach(function(e){i.push(e.clone())});return t&&(i=i.filter(t)),n.resolve(i),n.promise},getByID:function(e){var t,i=Q.defer();if(e._viewId)t=this.getOrCreateLayer(e._id,e._viewType,e._viewId);else{var n=this.getArrayIndex(e);n>=0&&(t=this._entities[n])}return t?i.resolve(t):i.reject(new Error("EM_RESOURCE_NOT_FOUND")),i.promise},removeAll:function(){this._entities=[],this._tempEntities=[]},remove:function(e){var t,i=Q.defer();return e._viewId?(t=this.getTempArrayIndex(e),t>=0?(this._tempEntities.splice(t,1),i.resolve()):i.reject(new Error("EM_RESOURCE_NOT_FOUND"))):(t=this.getArrayIndex(e),t>=0?(this._entities.splice(t,1),i.resolve()):i.reject(new Error("EM_RESOURCE_NOT_FOUND"))),i.promise},create:function(e){var t,i=Q.defer(),n=(e._id,e._viewType,e._viewId);return n?(t=this.getTempArrayIndex(e),0>t?(this._tempEntities.push(e),i.resolve()):i.reject(new Error)):(t=this.getArrayIndex(e),0>t?(this._entities.push(e),i.resolve()):i.reject(new Error)),i.promise},update:function(e){var t=Q.defer();e.applyUpdate();var i,n=e.clone(),o=n._id,r=n._viewType;if(n._viewId)i=this.getTempArrayIndex(n),i>=0?this._tempEntities[i]=n:this._tempEntities.push(n),t.resolve();else if(i=this.getArrayIndex(n),i>=0){this._entities[i]=n,t.resolve();for(var a=0;a<this._tempEntities.length;)this._tempEntities[a]._id===o&&this._tempEntities[a]._viewType===r?this._tempEntities.splice(a,1):a++}else t.reject(new Error("EM_RESOURCE_NOT_FOUND"));return this.trigger("updateObjects",[[e]]),void 0===e._viewId&&e.writeToLocalStorage(),t.resolve(),t.promise},isLayerVisible:function(e,t){var i=this.viewType(t),n=this.viewInstance(t),o=this.getLayer(e,i,n);return o?o._visible:!1},setLayerVisibility:function(e,t,i){var n=this.viewType(t),o=this.viewInstance(t);if(void 0===e||void 0===n)return!1;var r;r=o?this.getOrCreateLayer(e,n,o):this.getLayer(e,n,o),r&&(r._visible=i,this.update(r))},getZIndexOfLayer:function(e,t){var i=this.viewType(t),n=this.viewInstance(t);if(void 0===e||void 0===i)return!1;var o=this.getLayer(e,i,n);return o?o._zIndex:-1},getObjectsVisbleUpToDistance:function(e,t){var i=this.viewType(t),n=this.viewInstance(t);if(void 0===e||void 0===i)return Number.POSITIVE_INFINITY;var o=this.getLayer(e,i,n);if(!o)return Number.POSITIVE_INFINITY;var r=o._visibleDistanceThresEnabled?o._visibleDistanceThres:Number.POSITIVE_INFINITY,a=o._forcedMaxDistance;return void 0!==a?Math.min(r,a):r},forceMaxDistance:function(e,t,i){var n=this.viewType(t),o=this.viewInstance(t),r=this.getLayer(e,n,o);r&&(r._forcedMaxDistance=i)},layerExists:function(e,t){var i=this.viewType(t),n=this.viewInstance(t),o=this.getLayer(e,i,n);return void 0!==o},getArrayIndex:function(e){for(var t=0,i=this._entities.length;i>t;t++){var n=this._entities[t];if(n._id===e._id&&n._viewType===e._viewType)return t}return-1},getTempArrayIndex:function(e){for(var t=0,i=this._tempEntities.length;i>t;t++){var n=this._tempEntities[t];if(n._id===e._id&&n._viewType===e._viewType&&n._viewId===e._viewId)return t}return-1},getLayer:function(e,t,i){if(void 0===e||void 0===t)return void 0;var n,o,r={_id:e,_viewType:t,_viewId:i};return i&&(o=this.getTempArrayIndex(r),o>=0&&(n=this._tempEntities[o])),n||(o=this.getArrayIndex(r),o>=0&&(n=this._entities[o])),n},getOrCreateLayer:function(e,t,i){var n,o={_id:e,_viewType:t,_viewId:i},r=this.getTempArrayIndex(o);return r>=0?n=this._tempEntities[r]:(r=this.getArrayIndex(o),r>=0&&(n=this._entities[r].clone(),n._viewId=i,this.create(n))),n},viewType:function(e){return"string"==typeof e?e:e?e._type:void 0},viewInstance:function(e){return"string"==typeof e?void 0:e?e._id:void 0}},WS.extend("LayerService","PlugModule"),F.DI().registerService("layer",WS.LayerService,"@plug","@cookie"),WS.PickPointListener=function(e){this._view=e},WS.PickPointListener.prototype={onPickPoint:function(e,t,i,n){var o=new WS.Point3d(i,[e,t],this.getRefSystem(),this._view,n);this._view.trigger("pickPoint",[o])},getRefSystem:function(){var e=this._view;return e.instanceOf(WS.PanoramaView)?e._root:e.instanceOf(WS.OverviewMap)?e._mapObject:void 0}},WS.extend("PickPointListener"),WS.Object=function(){this._id=WS.Object.Id++},WS.extend("Object"),WS.Object.Id=1,WS.Observable=function(){this._listener=[]},WS.Observable.prototype={addListener:function(e){this._listener.push(e)},removeListener:function(e){var t=this._listener.indexOf(e);t>=0&&this._listener.splice(t,1)},informListener:function(e,t){for(var i,n=0,o=this._listener.length;o>n;n++)i=this._listener[n],i&&i[e]&&i[e].apply(i,t)}},WS.extend("Observable","Object"),WS.Buffer=function(e,t,i,n,o,r){this._bufferData=void 0,this._bufferType=t,this._itemSize=void 0!==i?i:this._bufferType==WS.Buffer.Type.ARRAY?3:1,this._itemDataType=void 0!==n?n:this.getItemDataTypeFromBufferType(this._bufferType),this._offset=void 0!==o?o:0,this._stride=void 0!==r?r:0,this.setBufferData(e)},WS.Buffer.prototype={addListener:function(e){WS.Observable.prototype.addListener.call(this,e),e[WS.Buffer.OnDataChangeFuncName]&&e[WS.Buffer.OnDataChangeFuncName]()},setBufferData:function(e){this._bufferData=e,this.informListener(WS.Buffer.OnDataChangeFuncName,[])},getItemDataTypeFromBufferType:function(e){return e===WS.Buffer.Type.ARRAY?WS.Buffer.ItemDataType.FLOAT:e===WS.Buffer.Type.ELEMENT?WS.Buffer.ItemDataType.USHORT:void 0},hasData:function(){return!!(this._bufferData&&this._bufferData.length&&this._bufferData.length>0)},addItem:function(e){if(this._bufferData instanceof Array)for(var t=0;t<this._itemSize;t++)this._bufferData.push(e[t]);else{var i=this._bufferData.constructor,n=this._bufferData.length,o=n+this._itemSize,r=new i(o);r.set(this._bufferData);for(var a=0;a<this._itemSize;a++)r[a+n]=e[a];this._bufferData=r}this.informListener(WS.Buffer.OnDataChangeFuncName,[])},getItem:function(e,t){var i=this._bufferData,n=this._itemSize;if(i&&n){for(var o=e*n,r=0;n>r;r++)t[r]=i[o+r];return n}},setItem:function(e,t,i){var n=this._bufferData,o=this._itemSize;if(n&&o){for(var r=e*o,a=0;o>a;a++)n[r+a]=t[a];i||this.informListener(WS.Buffer.OnDataChangeFuncName,[])}},setComponentOfAllItems:function(e,t){for(var i=this._bufferData,n=i.length,o=e;n>o;o+=this._itemSize)i[o]=t;this.informListener(WS.Buffer.OnDataChangeFuncName,[])},getCountItems:function(){return this._bufferData&&this._itemSize>0?this._bufferData.length/this._itemSize:0},setComponent:function(e,t,i,n){this._bufferData[this._itemSize*e+t]=i,n||this.informListener(WS.Buffer.OnDataChangeFuncName,[])}},WS.extend("Buffer","Observable"),WS.Buffer.Type={ARRAY:"ARRAY_BUFFER",ELEMENT:"ELEMENT_ARRAY_BUFFER"},WS.Buffer.ItemDataType={FLOAT:"FLOAT",USHORT:"UNSIGNED_SHORT",UBYTE:"UNSIGNED_BYTE"},WS.Buffer.OnDataChangeFuncName="onDataChange",WS.ArrayBuffer=function(e,t,i,n,o){WS.Buffer.call(this,e,WS.Buffer.Type.ARRAY,t,i,n,o)},WS.extend("ArrayBuffer","Buffer"),WS.IndexBuffer=function(e,t,i,n){WS.Buffer.call(this,e,WS.Buffer.Type.ELEMENT,1,t,i,n)},WS.extend("IndexBuffer","Buffer"),WS.Geometry=function(){this._indexBuffer=void 0,this._indicesToUse=void 0,this._positionBuffer=void 0,this._positionItemsToUse=void 0,this._primitiveType=WS.Geometry.PrimitiveType.Triangles},WS.Geometry.prototype={getPosition:function(e,t){return this._positionBuffer.getItem(e,t)},getCountPositions:function(){var e=this._positionBuffer?this._positionBuffer.getCountItems():0;return Math.min(e,this._positionItemsToUse||Number.MAX_VALUE)},getCountIndices:function(){var e=this._indexBuffer?this._indexBuffer.getCountItems():0;return Math.min(e,this._indicesToUse||Number.MAX_VALUE)}},WS.extend("Geometry","Object"),WS.Geometry.PrimitiveType={Points:"POINTS",Triangles:"TRIANGLES",TriangleStrip:"TRIANGLE_STRIP",LineStrip:"LINE_STRIP",Lines:"LINES",PolyCircuit:"POLY_CIRCUIT"},WS.CenteredQuadGeometry=function(){WS.Geometry.call(this),this._positionBuffer=WS.CenteredQuadGeometry.PositionBuffer,this._primitiveType=WS.Geometry.PrimitiveType.TriangleStrip},WS.extend("CenteredQuadGeometry","Geometry"),WS.CenteredQuadGeometry.PositionBuffer=new WS.ArrayBuffer([-1,-1,-1,1,1,-1,1,1],2),WS.ObjectLabeler=function(e,t){this._interval=void 0===e?WS.ObjectLabeler.DEFAULT_INTERVAL:e,this._delta=2*this._interval+1,this._numChannels=void 0===t?4:t,this._numValues=Math.floor(256/this._delta)-1,this._numValuesTotal=Math.pow(this._numValues,this._numChannels),this._minValue=this._delta+this._interval,this._maxValue=this._numValues*this._delta+this._interval,this._colorToRenderable={};var i=this._maxValue;this._nextColor=[i,i,i,4===this._numChannels?i:255]},WS.ObjectLabeler.prototype={assignColorToRenderable:function(e,t){var i=this.getColor(),n={color:i.rgb,renderable:e,memberRenderable:t};return this._colorToRenderable[i.key]=n,i.rgb},fillPickColorBuffer:function(e,t){for(var i=this._numChannels-1,n=this._minValue,o=this._maxValue,r=this._delta,a=4*t,s=new Uint8Array(a),c=new Uint8Array([o,o,o,o]),l=0;a>l;){s[l++]=c[0],s[l++]=c[1],s[l++]=c[2],s[l++]=c[3];for(var h=i;h>=0&&(c[h]-=r,!(c[h]>=n));h--)c[h]=o}e.setBufferData(s)},lookupRenderable:function(e){if(0===e[3])return void 0;var t=this.adjustColor(e),i=this.colorToKey(t);return this._colorToRenderable[i]},lookupIndex:function(e){return 0===e[3]?void 0:this.colorToIdx(e)},getColor:function(){for(var e=this._nextColor,t=F.cloneArray(e),i=this.colorToKey(t),n=this._minValue,o=this._maxValue,r=this._delta,a=this._numChannels-1;a>=0&&(e[a]-=r,!(e[a]>=n));a--)e[a]=o;return{key:i,rgb:t}},adjustColor:function(e){for(var t=this._numChannels,i=[],n=0;t>n;n++){var o=Math.floor(e[n]/this._delta);i[n]=o*this._delta+this._interval}3===t&&(i[3]=255);vec4.subtract(e,i,[]);return i},colorToIdx:function(e){for(var t=this._numChannels,i=this._numValues,n=[],o=0;t>o;o++){var r=Math.floor(e[o]/this._delta);n[o]=i-r}return 3===t?n[2]+i*n[1]+i*i*n[0]:n[3]+i*n[2]+i*i*n[1]+i*i*i*n[0]},colorToKey:function(e){return e[0]+","+e[1]+","+e[2]+","+e[3]}},WS.extend("ObjectLabeler"),WS.ObjectLabeler.DEFAULT_INTERVAL=1,WS.Rectangle=function(e,t,i,n){this._topLeftX=e,this._topLeftY=t,this._width=i,this._height=n},WS.Rectangle.prototype={containsPt:function(e,t){return e>=this._topLeftX&&e<=this._topLeftX+this._width&&t>=this._topLeftY&&t<=this._topLeftY+this._height},containsRect:function(e){return this.containsPt(e._topLeftX,e._topLeftY)&&this.containsPt(e._topLeftX+e._width,e._topLeftY+e._height)}},WS.extend("Rectangle"),WS.Rectangle.fromCorners=function(e,t,i,n){var o=Math.min(e,i),r=Math.max(e,i),a=Math.min(t,n),s=Math.max(t,n);return new WS.Rectangle(o,a,r-o,s-a)},WS.DownCenteredQuadGeometry=function(){WS.Geometry.call(this),this._positionBuffer=WS.DownCenteredQuadGeometry.PositionBuffer,this._primitiveType=WS.Geometry.PrimitiveType.TriangleStrip},WS.extend("DownCenteredQuadGeometry","Geometry"),WS.DownCenteredQuadGeometry.PositionBuffer=new WS.ArrayBuffer([-1,0,-1,2,1,0,1,2],2),WS.ShaderUniform=function(e,t,i){this._name=e,this._type=t,this._id=i,this._value=void 0},WS.extend("ShaderUniform"),WS.ShaderUniforms=function(){this._elements={}},WS.ShaderUniforms.prototype={addUniform:function(e){this._elements[e._name]=e},getUniform:function(e){return this._elements[e]},getUniforms:function(){return this._elements}},WS.extend("ShaderUniforms"),WS.Material=function(e,t,i,n,o,r,a){this._transparent=void 0!==e?e:!1,this._depthTest=void 0!==t?t:!0,this._depthWrite=void 0!==i?i:!0,this._rgbDepthTestSupport=!1,this._cullFace=void 0!==a?a:WS.Material.Cull.OFF,this._images=n,this._canvas=void 0,this._coordBuffer=o,this._colorBuffer=r},WS.Material.prototype={setTextureImgUrls:function(e){this._images=[];for(var t=0,i=e.length;i>t;t++)this._images[t]=new WS.Image(e[t])},setTextureImages:function(e){this._images=e},clearTextureImages:function(){this._images=[]},setTextureImgFilter:function(e,t){if(void 0!==t&&t<this._images.length)this._images[t].setImageFilter(e);else for(var i=0,n=this._images.length;n>i;i++)this._images[i].setImageFilter(e)},getColor:function(e,t){var i=this._colorBuffer,n=i?i.getCountItems():0;if(!(0>=n)){var o=Math.min(n-1,e);return i.getItem(o,t)}},getColorCount:function(){return this._colorBuffer?this._colorBuffer.getCountItems():0},hasImages:function(){return 0<this._images.length},areImagesLoaded:function(){for(var e=0,t=this._images.length;t>e;e++)if(!this._images[e].isLoaded())return!1;return!0},getImage:function(e){return e<this._images.length?this._images[e]:void 0}},WS.extend("Material","Object"),WS.Material.Cull={OFF:0,BACK:1,FRONT:2},WS.ShaderMaterial=function(e,t,i,n,o,r,a,s){WS.Material.call(this,t,i,n,o,r,a,s),this._shaderProgramDesc=e,this._pickColor=void 0},WS.ShaderMaterial.prototype={configureShader:function(){return!0},configureRenderer2d:function(){return!0}},WS.extend("ShaderMaterial","Material"),WS.SpriteMaterial=function(e,t,i){var n=void 0!==e?[e]:[];WS.ShaderMaterial.call(this,WS.SpriteShaderDesc,!0,!1,!1,n,WS.SpriteMaterial.TextureCoords),this._spriteSize=t,this._scaleByDepth=void 0!==i?i:!0},WS.SpriteMaterial.prototype={configureShader:function(e){var t=e._camera,i=e._viewport,n=e._geometry,o=e.getShaderProgram(this);o.setAttributeValue("aVertexPosition",e.getGlBuffer(n._positionBuffer)),o.setAttributeValue("aVertexTextureCoords",e.getGlBuffer(this._coordBuffer));var r=e.getMaterialTextures(this),a=void 0!==r&&r.length>0?r[0]:void 0;return a&&!a.isImageUploaded()?!1:(o.setUniformValue("uTex0",new WS.TextureValue(a,0)),o.setUniformValue("uModelMatrix",e.getModelMatrix()),o.setUniformValue("uViewMatrix",t._transform),o.setUniformValue("uInverseViewMatrix",t._inverseTransform),o.setUniformValue("uProjectionMatrix",t._projMatrix),o.setUniformValue("uSpriteSize",this._spriteSize),o.setUniformValue("uScaleByDepth",this._scaleByDepth),o.setUniformValue("uViewPort",i._dimensions),!0)}},WS.extend("SpriteMaterial","ShaderMaterial"),WS.SpriteMaterial.TextureCoords=new WS.ArrayBuffer([0,0,0,1,1,0,1,1],2),WS.SceneNode=function(){this._children=[],this._parent=void 0},WS.SceneNode.prototype={addChild:function(e){this._children.push(e),e._parent&&e._parent.removeChild(e),e._parent=this},removeChild:function(e){var t=this._children.indexOf(e);-1!=t&&(this._children.splice(t,1),e._parent=void 0)},hasChildren:function(){return 0<this._children.length},getRootNode:function(){for(var e=this;e._parent;)e=e._parent;return e},traverse:function(e){e.prepare(),this.traverseInternal(e.preVisit.bind(e),e.visit.bind(e),e.postVisit.bind(e))},traverseInternal:function(e,t,i){var n;if(n=e(this),!n)return!1;if(n=t(this),!n)return!1;for(var o=0,r=this._children.length;r>o&&n;o++)n=this._children[o].traverseInternal(e,t,i);return i(this)}},WS.extend("SceneNode","Object"),mat4.isIdentity=function(e){var t=1e-6;return Math.abs(e[0]-1)<t&&Math.abs(e[1]-0)<t&&Math.abs(e[2]-0)<t&&Math.abs(e[3]-0)<t&&Math.abs(e[4]-0)<t&&Math.abs(e[5]-1)<t&&Math.abs(e[6]-0)<t&&Math.abs(e[7]-0)<t&&Math.abs(e[8]-0)<t&&Math.abs(e[9]-0)<t&&Math.abs(e[10]-1)<t&&Math.abs(e[11]-0)<t&&Math.abs(e[12]-0)<t&&Math.abs(e[13]-0)<t&&Math.abs(e[14]-0)<t&&Math.abs(e[15]-1)<t},mat4.setTranslation=function(e,t){e[12]=t[0],e[13]=t[1],e[14]=t[2]},mat4.getTranslation=function(e){return[e[12],e[13],e[14]]},mat4.getColumn=function(e,t,i){var n=4*t;return i[0]=e[n],i[1]=e[n+1],i[2]=e[n+2],i[3]=e[n+3],i},mat4.transpose3x3=function(e,t){t||(t=e);var i=e[0],n=e[1],o=e[2],r=e[4],a=e[5],s=e[6],c=e[8],l=e[9],h=e[10];return t[0]=i,t[1]=r,t[2]=c,t[4]=n,t[5]=a,t[6]=l,t[8]=o,t[9]=s,t[10]=h,t!==e&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[3]=e[3],t[7]=e[7],t[11]=e[11],t[15]=e[15]),t},mat4.invertOrtho=function(e,t){t||(t=e);var i=mat4.getTranslation(e);mat4.transpose3x3(e,t),t[12]=t[13]=t[14]=0;var n=mat4.multiplyVec3(t,i);return t[12]=-n[0],t[13]=-n[1],t[14]=-n[2],t},mat4.getXYZRotation=function(e,t,i){var n,o,r=vec3.create([1,0,0]),a=mat4.mult33(e,r);if(F.closeTo(a[0],0)&&F.closeTo(a[1],0)&&F.closeTo(1-Math.abs(a[2]),0))t[0]=0,i[0]=0,a[2]>0?(t[1]=1.5*Math.PI,i[1]=t[1]):(t[1]=.5*Math.PI,i[1]=t[1]),r=vec3.create([0,1,0]),a=mat4.mult33(e,r),n=vec3.dot(r,a),-1>n?n=-1:n>1&&(n=1),o=Math.acos(n),0!==o&&a[0]*r[1]-a[1]*r[0]>0&&(o=2*Math.PI-o),t[2]=o,i[2]=o;else{var s=vec3.create([a[0],a[1],0]);vec3.normalize(s),n=vec3.dot(s,r),-1>n?n=-1:n>1&&(n=1),o=Math.acos(n),0!==o&&s[0]*r[1]-s[1]*r[0]>0&&(o=2*Math.PI-o),i[2]=o+Math.PI,o>Math.PI&&(i[2]=o-Math.PI),t[2]=o;var c=mat4.identity();mat4.rotate(c,-t[2],[0,0,1]);var l=mat4.mult33(c,a);n=vec3.dot(l,r),-1>n?n=-1:n>1&&(n=1);var h=Math.acos(n);0!==h&&l[0]*r[2]-l[2]*r[0]<0&&(h=2*Math.PI-h),t[1]=h,c=mat4.identity(),mat4.rotate(c,-i[2],[0,0,1]),l=mat4.mult33(c,a),n=vec3.dot(l,r),-1>n?n=-1:n>1&&(n=1);var d=Math.acos(n);0!==d&&l[0]*r[2]-l[2]*r[0]<0&&(d=2*Math.PI-d),i[1]=d;var u=vec3.create([0,0,1]),p=mat4.create(e);mat4.invertOrtho(p);var _=mat4.mult33(p,u),g=vec3.create([0,_[1],_[2]]);vec3.normalize(g),n=vec3.dot(g,u),-1>n?n=-1:n>1&&(n=1);var f=Math.acos(n);0!==f&&g[1]*u[2]-g[2]*u[1]<0&&(f=2*Math.PI-f),t[0]=f,i[0]=f+Math.PI,f>Math.PI&&(i[0]=f-Math.PI)}},mat4.mult33=function(e,t){for(var i=vec3.create([0,0,0]),n=3;n--;)for(var o=3;o--;)i[o]+=t[n]*e[4*n+o];return i},mat4.trafoInRefSystem=function(e,t){var i=mat4.invertOrtho(t,mat4.create());return mat4.multiply(i,e,mat4.create())},mat4.posInRefSystem=function(e,t){var i=mat4.invertOrtho(t,mat4.create());return mat4.multiplyVec3(i,e,vec3.create())},mat4.positionsInRefSystem=function(e,t){for(var i=[],n=e.length,o=0;n>o;++o)i.push(mat4.posInRefSystem(e[o],t));return i},vec2.distToLine=function(e,t,i){var n,o,r=vec2.create(),a=vec2.create();return vec2.subtract(t,e,r),o=0===r[0]?(i[1]-e[1])/r[1]:(r[1]/r[0]*(i[1]-e[1])+(i[0]-e[0]))/(r[1]*r[1]/r[0]+r[0]),o>=0&&1>=o?0===r[0]?(a[0]=e[0],a[1]=i[1]):(vec2.scale(r,o,r),vec2.add(e,r,a)):a=o>1?t:e,n=vec2.subtract(i,a,n),vec2.length(n)},vec3.angle=function(e,t){var i=vec3.cross(e,t,vec3.create()),n=vec3.length(i),o=vec3.dot(e,t),r=Math.atan2(n,o);return r},vec3.dist2=function(e,t){var i=t[0]-e[0],n=t[1]-e[1],o=t[2]-e[2];return i*i+n*n+o*o},vec3.fromPolar=function(e,t,i,n){n||(n=vec3.create()),i+=.5*Math.PI;var o=Math.sin(i);return n[0]=e*Math.cos(-t)*o,n[1]=e*Math.sin(-t)*o,n[2]=-e*Math.cos(i),n},vec3.fromCartesianToSpherical=function(e,t){var i=e[0],n=e[1],o=e[2],r=i*i+n*n,a=o*o,s=Math.atan2(n,i);s=(s+2*Math.PI)%(2*Math.PI);var c;c=0!==r?-Math.atan(o/Math.sqrt(r)):o>=0?-.5*Math.PI:.5*Math.PI;var l=Math.sqrt(r+a);return t[0]=s,t[1]=c,t[2]=l,t},vec3.intersectLineWithXYPlane=function(e,t,i){var n=vec3.create();if(vec3.subtract(t,e,n),0===n[2])return void 0;var o=(i-e[2])/n[2];return 0>o||o>1||isNaN(o)?null:(vec3.scale(n,o),vec3.add(n,e,n))},vec3.intersectLineWithYZPlane=function(e,t,i){var n=vec3.create();if(vec3.subtract(t,e,n),0===n[0])return void 0;var o=(i-e[0])/n[0];return 0>o||o>1||isNaN(o)?null:(vec3.scale(n,o),vec3.add(n,e,n))},vec3.intersectLineWithXZPlane=function(e,t,i){var n=vec3.create();if(vec3.subtract(t,e,n),0===n[1])return void 0;var o=(i-e[1])/n[1];return 0>o||o>1||isNaN(o)?null:(vec3.scale(n,o),vec3.add(n,e,n))},vec3.intersectLineWithAxisAlignedPlane=function(e,t,i,n){switch(i){case 0:return vec3.intersectLineWithYZPlane(e,t,n);case 1:return vec3.intersectLineWithXZPlane(e,t,n);case 2:return vec3.intersectLineWithXYPlane(e,t,n)}},vec3.intersectAABoxWithFrustum=function(e,t,i){for(var n=e[0],o=e[1],r=e[2],a=t[0],s=t[1],c=t[2],l=1,h=0;6>h;h++){var d=i[h],u=d[0],p=u[0],_=u[1],g=u[2],f=d[1],m=0>p?n:a,v=0>_?o:s,S=0>g?r:c,b=p>=0?n:a,y=_>=0?o:s,P=g>=0?r:c,C=m*p+v*_+S*g+f;if(0>C)return-1;var w=b*p+y*_+P*g+f;0>w&&(l=0)}return l},vec4.intersectLineWithXYZHyperPlane=function(e,t,i){var n=new MatrixArray(4);if(vec4.subtract(t,e,n),0===n[3])return void 0;var o=(i-e[3])/n[3];return 0>o||o>1||isNaN(o)?null:(vec4.scale(n,o,n),vec4.add(n,e,n))},vec3.clipLineToAxisAlignedPlane=function(e,t,i,n,o){var r=vec3.intersectLineWithAxisAlignedPlane(e,t,i,n);return r?(e[i]<n&&o||e[i]>n&&!o?(e[0]=r[0],e[1]=r[1],e[2]=r[2]):(t[i]<n&&o||t[i]>n&&!o)&&(t[0]=r[0],t[1]=r[1],t[2]=r[2]),!0):!1},vec3.clipLineToUniformCube=function(e,t){var i=0;return vec3.clipLineToAxisAlignedPlane(e,t,0,-1,!0)&&i++,2>=i&&vec3.clipLineToAxisAlignedPlane(e,t,0,1,!1)&&i++,2>=i&&vec3.clipLineToAxisAlignedPlane(e,t,1,-1,!0)&&i++,2>=i&&vec3.clipLineToAxisAlignedPlane(e,t,1,1,!1)&&i++,2>=i&&vec3.clipLineToAxisAlignedPlane(e,t,2,-1,!0)&&i++,2>=i&&vec3.clipLineToAxisAlignedPlane(e,t,2,1,!1)&&i++,i>0},vec4.clipLineToXYZHyperPlane=function(e,t,i,n){var o=vec4.intersectLineWithXYZHyperPlane(e,t,i);return o?(e[3]<i&&n||e[3]>i&&!n?(e[0]=o[0],e[1]=o[1],e[2]=o[2],e[3]=o[3]):(t[3]<i&&n||t[3]>i&&!n)&&(t[0]=o[0],t[1]=o[1],t[2]=o[2],t[3]=o[3]),!0):!1},vec2.isTriangleVisible=function(e,t,i,n,o){return(e[0]>=0||t[0]>=0||i[0]>=0)&&(e[1]>=0||t[1]>=0||i[1]>=0)&&(e[0]<n||t[0]<n||i[0]<n)&&(e[1]<o||t[1]<o||i[1]<o)},window.Float64Array&&(setMatrixArrayType(Float64Array),MatrixArray=Float64Array),WS.BoundingBox3d=function(e){this._min=void 0,this._max=void 0,e&&this.addPoints(e)},WS.BoundingBox3d.prototype={isValid:function(){return!!this._min&&!!this._max},addPoint:function(e){this.isValid()?(e[0]<this._min[0]?this._min[0]=e[0]:this._max[0]<e[0]&&(this._max[0]=e[0]),e[1]<this._min[1]?this._min[1]=e[1]:this._max[1]<e[1]&&(this._max[1]=e[1]),e[2]<this._min[2]?this._min[2]=e[2]:this._max[2]<e[2]&&(this._max[2]=e[2])):(this._min=[e[0],e[1],e[2]],this._max=[e[0],e[1],e[2]])},addPoints:function(e){for(var t=0,i=e.length;i>t;++t)this.addPoint(e[t])},getCenter:function(){return[(this._min[0]+this._max[0])/2,(this._min[1]+this._max[1])/2,(this._min[2]+this._max[2])/2]},getLongestLength:function(){return Math.max(this._max[0]-this._min[0],this._max[1]-this._min[1],this._max[2]-this._min[2])},determineOrientation:function(e){for(var t=this.getLongestLength(),i=[this._min[0]+t/2,this._min[1]+t/2,this._min[2]+t/2],n=i[0],o=i[1],r=i[2],a={id:1,m:[]},s={id:2,m:[]},c={id:3,m:[]},l={id:4,m:[]},h={id:5,m:[]},d={id:6,m:[]},u={id:7,m:[]},p={id:8,m:[]},_=[a,s,c,l,h,d,u,p],g=0,f=e.length;f>g;++g){var m=e[g],v=m[0],S=m[1],b=m[2];n>=v&&o>=S&&r>=b?a.m.push(m):v>n&&o>=S&&r>=b?s.m.push(m):n>=v&&S>o&&r>=b?c.m.push(m):v>n&&S>o&&r>=b?l.m.push(m):n>=v&&o>=S&&b>r?h.m.push(m):v>n&&o>=S&&b>r?d.m.push(m):n>=v&&S>o&&b>r?u.m.push(m):p.m.push(m)}_.sort(function(e,t){return t.m.length-e.m.length});var y=_[0].id,P=_[1].id;if(y>P){var C=y;y=P,P=C}return 1===y&&2===P||1===y&&6===P||3===y&&4===P||3===y&&8===P||5===y&&6===P||2===y&&5===P||7===y&&8===P||4===y&&7===P?"x":1===y&&3===P||1===y&&7===P||2===y&&4===P||2===y&&8===P||5===y&&7===P||3===y&&5===P||6===y&&8===P||4===y&&6===P?"y":1===y&&5===P||2===y&&6===P||3===y&&7===P||4===y&&8===P?"z":1===y&&4===P||1===y&&8===P||5===y&&8===P||4===y&&5===P?"y+":"y-"}},WS.extend("BoundingBox3d"),WS.Transform=function(){this._transform=mat4.identity()},WS.Transform.prototype={rotate:function(e,t){mat4.rotate(this._transform,e,t)},rotateX:function(e){mat4.rotateX(this._transform,e)},rotateY:function(e){mat4.rotateY(this._transform,e)},rotateZ:function(e){mat4.rotateZ(this._transform,e)},translate:function(e){var t=this.getTranslation();vec3.add(t,e,t),this.setTranslation(t)},setTranslation:function(e){mat4.setTranslation(this._transform,e)},getTranslation:function(){return mat4.getTranslation(this._transform)},getX:function(){return this._transform[12]},getY:function(){return this._transform[13]},getZ:function(){return this._transform[14]}},WS.extend("Transform","SceneNode"),WS.Renderable=function(){this._layerId=WS.Layer.LayerIDs.DEFAULT,this._viewingMode=WS.Renderable.ViewingMode.Normal,this._dataObject=void 0,this._UUID=void 0,this._layerService=F.DI().getService("layer"),this._pickable3d=!1},WS.Renderable.prototype={assignPickColors:function(e){var t=e.assignColorToRenderable(this),i=[t[0]/255,t[1]/255,t[2]/255,t[3]/255];this.setPickColor(i)},setPickColor:function(e){this._material._pickColor=e},addToLayer:function(e,t,i){if(this._layerId=e,t){var n=this.getMemberRenderables();n.forEach(function(i){i.addToLayer(e,t,!1)})}if(i){var o=function(){return!0},r=function(i){return i.instanceOf(WS.Renderable)&&i.addToLayer(e,t,!1),!0};this.traverseInternal(o,r,o)}},draw3d:function(){},draw2d:function(){},setViewingMode:function(e){e!==this._viewingMode&&(this._viewingMode=e,this.onViewingModeChange())},update:function(){},onViewingModeChange:function(){},drawMemberRenderables:function(e,t,i,n){for(var o=this.getVisibleMemberRenderables(),r=e._modelMatrixStack,a=0,s=o.length;s>a;a++){var c=o[a];if(c&&c[t]){var l=r.addOrthoMatrix(c._transform,!0);c[t](e,i,n),l&&r.popMatrix()}}},drawMemberRenderables2d:function(e,t,i){this.drawMemberRenderables(e,"draw2d",t,i)},drawMemberRenderables3d:function(e,t,i){this.drawMemberRenderables(e,"draw3d",t,i)},getPickInfoOfMemberRenderable:function(e,t,i,n,o){var r,a,s=mat4.create();for(r=i.length-1;r>=0;--r){var c=i[r];if(c&&c.getPickInfo&&(mat4.multiply(t,c._transform,s),a=c.getPickInfo(e,s,n,o),void 0!==a))return a}return a},getPickInfo:function(){return void 0},getRegionPickInfo:function(){return void 0},supportsDragging:function(){return!1},dragStart:function(){},dragMove:function(){},dragStop:function(){},getVisibleMemberRenderables:function(){return this.getMemberRenderables()},getMemberRenderables:function(){return[]},setDirect:function(){},setDataObject:function(e){this._dataObject=e,this._categoryLabel&&this._categoryLabel.setDataObject(e)},getUuid:function(){return this._UUID||this._dataObject._UUID}},WS.extend("Renderable","Transform"),WS.Renderable.ViewingMode={Inconsiderable:1,Normal:2,Selected:3,Highlighted:4,Displayed:5},WS.Mesh=function(e,t){this._material=t,this._geometry=e},WS.Mesh.prototype={draw3d:function(e,t,i){if(i||t(this)){e.setAndPrepareGeometry(this._geometry);var n=e.setAndPrepareMaterial(this._material);n&&e.drawGeometry()}},draw2d:function(e,t,i){if(i||t(this)){e.setAndPrepareGeometry(this._geometry);var n=e.setAndPrepareMaterial(this._material);n&&e.drawGeometry()}}},WS.extend("Mesh","Renderable"),WS.SpinnerRenderable=function(e,t){this._text=e,this._position=t,this._fullOpSpinnerElementIndex=0,this._spinElementWidth=WS.SpinnerRenderable.SpinElementWidth,this._spinElementHeight=WS.SpinnerRenderable.SpinElementHeight,this._countSpinElements=WS.SpinnerRenderable.CountSpinElements,this._rotationSpeed=WS.SpinnerRenderable.RotationSpeed,this._fontStyle=WS.SpinnerRenderable.FontStyle,this._spinnerColor=WS.SpinnerRenderable.SpinnerColor,this._timeLastIndexChange=0,this._extractFontSizeRegEx=/\D*(\d*)\D*/,this.addToLayer(WS.Layer.LayerIDs.TEMP)},WS.SpinnerRenderable.prototype={draw2d:function(e,t){if(t(this)){var i=e._ctx,n=this._spinElementWidth-this._spinElementHeight,o=n/2,r=this._spinElementHeight,a=r/2;i.font=this._fontStyle;var s=i.measureText(this._text).width,c=parseInt(this._extractFontSizeRegEx.exec(this._fontStyle)[1]),l=s/2+20,h=1,d=(new Date).getTime(),u=d-this._timeLastIndexChange;u>1e3/(this._rotationSpeed*this._countSpinElements)&&(this._fullOpSpinnerElementIndex=(this._fullOpSpinnerElementIndex+1)%this._countSpinElements,this._timeLastIndexChange=d),i.translate(this._position[0],this._position[1]),i.beginPath(),i.arc(0,0,l+30,0,2*Math.PI,!1),i.fillStyle="rgba(255,255,255,0.5)",i.fill(),i.save(),i.rotate(2*this._fullOpSpinnerElementIndex*Math.PI/this._countSpinElements);for(var p=0;p<this._countSpinElements;p++)this._spinnerColor[3]=h,i.fillStyle=WS.Renderer2D.colorToStyle(this._spinnerColor),i.rotate(2*Math.PI/this._countSpinElements),i.save(),i.translate(l,0),i.beginPath(),i.moveTo(-o,-a),i.lineTo(o,-a),i.arc(o,0,a,1.5*Math.PI,.5*Math.PI,!1),i.lineTo(-o,a),i.arc(-o,0,a,.5*Math.PI,1.5*Math.PI,!1),i.fill(),i.restore(),h-=1/this._countSpinElements;i.restore(),this._spinnerColor[3]=1,i.fillStyle=WS.Renderer2D.colorToStyle(this._spinnerColor),i.fillText(this._text,-s/2,c/2-2),i.setTransform(1,0,0,1,0,0)}},draw3d:function(){}},WS.extend("SpinnerRenderable","Renderable"),WS.SpinnerRenderable.SpinElementWidth=30,WS.SpinnerRenderable.SpinElementHeight=12,WS.SpinnerRenderable.CountSpinElements=12,WS.SpinnerRenderable.RotationSpeed=1,WS.SpinnerRenderable.FontStyle="bold 15px Arial",WS.SpinnerRenderable.SpinnerColor=[0,0,0,1],WS.CompassRenderable=function(e){e=e?parseInt(e):WS.CompassRenderable.CompassModes.Degree,this._compassMode=e,this._image=new WS.Image(this._compassMode===WS.CompassRenderable.CompassModes.Gon?WS.CompassRenderable.IMG_URL_GON:WS.CompassRenderable.IMG_URL_DEG),this._steps=this._compassMode===WS.CompassRenderable.CompassModes.Gon?WS.CompassRenderable.STEPS_GON:WS.CompassRenderable.STEPS_DEG,this._bg=new WS.Image(WS.CompassRenderable.BG_URL),this._backgroundColor=WS.CompassRenderable.BackgroundColor,this._componentWidth=WS.CompassRenderable.COMPASS_WIDTH,this._componentHeight=WS.CompassRenderable.COMPASS_HEIGHT,this._pixelPerStep=WS.CompassRenderable.PIX_PER_STEP,this._marginBottom=WS.CompassRenderable.MARGIN_BOTTOM,this._imgWidth=this._pixelPerStep*this._steps,this._imgHeight=WS.CompassRenderable.IMAGE_HEIGHT,this.addToLayer(WS.Layer.LayerIDs.TEMP),this._image.loadImage(),this._bg.loadImage()},WS.CompassRenderable.prototype={setCompassMode:function(e){e=parseInt(e),e!==this._compassMode&&(this._compassMode=e,this._image=new WS.Image(e===WS.CompassRenderable.CompassModes.Gon?WS.CompassRenderable.IMG_URL_GON:WS.CompassRenderable.IMG_URL_DEG),this._image.loadImage(),this._steps=e===WS.CompassRenderable.CompassModes.Gon?WS.CompassRenderable.STEPS_GON:WS.CompassRenderable.STEPS_DEG,this._imgWidth=this._pixelPerStep*this._steps)},draw2d:function(e,t,i,n){if(t(this)){var o=e._ctx;if(o){var r=.5*(e._canvasWidth-this._componentWidth),a=e._canvasHeight-this._marginBottom;o.drawImage(this._bg.getRawImage(),r,a,this._componentWidth,this._componentHeight);var s,c=this.getBearing(e._camera,n),l=c*this._pixelPerStep-.5*this._componentWidth;if(0>l)s=Math.abs(l),o.drawImage(this._image.getRawImage(),this._imgWidth-s,0,s,this._imgHeight,r,a,s,this._componentHeight),o.drawImage(this._image.getRawImage(),0,0,this._componentWidth-s,this._imgHeight,r+s,a,this._componentWidth-s,this._componentHeight);else{s=this._imgWidth-l;var h=Math.min(s,this._componentWidth);if(o.drawImage(this._image.getRawImage(),l,0,h,this._imgHeight,r,a,h,this._componentHeight),s<this._componentWidth){var d=this._componentWidth-(this._imgWidth-l),u=Math.abs(d),p=r+this._componentWidth-u;o.drawImage(this._image.getRawImage(),0,0,u,this._imgHeight,p,a,u,this._componentHeight)}}o.beginPath(),o.rect(r-1+.5*this._componentWidth,a-2,2,this._componentHeight+4),o.fillStyle=WS.CompassRenderable.NeedleColor,o.fill()}}},draw3d:function(){},getBearing:function(e,t){var i=e.createCameraObject(t),n=i.getAxisGlobal();vec3.scale(n,-1),n[2]=0,vec3.normalize(n,n);var o=vec3.create([0,1,0]),r=Math.acos(vec3.dot(o,n))*(this._steps/2/Math.PI);return n[0]<0&&(r=this._steps-r),r}},WS.extend("CompassRenderable","Renderable"),WS.CompassRenderable.BackgroundColor="rgba(0,0,0,0.4)",WS.CompassRenderable.NeedleColor="rgba(250,181,2,0.85)",WS.CompassRenderable.IMG_URL_GON=WS.imgUrlCanvasSafe("assets/bearinggon.png"),WS.CompassRenderable.IMG_URL_DEG=WS.imgUrlCanvasSafe("assets/bearing.png"),WS.CompassRenderable.BG_URL=WS.imgUrlCanvasSafe("assets/bearing_bg.png"),WS.CompassRenderable.COMPASS_WIDTH=180,WS.CompassRenderable.COMPASS_HEIGHT=33,WS.CompassRenderable.IMAGE_HEIGHT=33,WS.CompassRenderable.PIX_PER_STEP=3,WS.CompassRenderable.MARGIN_BOTTOM=60,WS.CompassRenderable.STEPS_DEG=360,WS.CompassRenderable.STEPS_GON=400,WS.CompassRenderable.CompassModes={Degree:0,Gon:1},WS.RectangleRenderable=function(){this._corners=void 0,this._fillStyle=void 0,this._strokeStyle=void 0,this._lineWidth=1,this._lineDash=void 0},WS.RectangleRenderable.prototype={setFillStyle:function(e){this._fillStyle=e},setStrokeStyle:function(e){this._strokeStyle=e},setLineWidth:function(e){this._lineWidth=e
},setLineDash:function(e){this._lineDash=e},setCorners:function(e){this._corners=e},draw2d:function(e,t,i){if(i||t(this)){var n=this._corners,o=e._ctx;n&&o&&(o.beginPath(),o.rect(n[0],n[1],n[2]-n[0],n[3]-n[1]),o.fillStyle=this._fillStyle,o.fill(),this._lineDash&&o.setLineDash&&o.setLineDash(this._lineDash),o.lineWidth=this._lineWidth,o.strokeStyle=this._strokeStyle,o.stroke())}},draw3d:function(){}},WS.extend("RectangleRenderable","Renderable"),WS.SelectionRenderable=function(){this.setStrokeStyle("#000"),this.setLineDash([5]),this.addToLayer(WS.Layer.LayerIDs.TEMP)},WS.SelectionRenderable.prototype={setAppearance:function(e){this.setFillStyle(e?WS.SelectionRenderable.FillStyleAdd:WS.SelectionRenderable.FillStyleSub)}},WS.extend("SelectionRenderable","RectangleRenderable"),WS.SelectionRenderable.FillStyleAdd="rgba(110,243,110,0.5)",WS.SelectionRenderable.FillStyleSub="rgba(223,130,130,0.5)",WS.PickInfo=function(e){this._list=[e]},WS.PickInfo.prototype={add:function(e){this._list.push(e)}},WS.extend("PickInfo"),WS.Image=function(e,t){var i=this;this._imageSrc=e,this._image=new Image,this._isCrossOrigin=0===e.indexOf("//")||0===e.indexOf("http://")||0===e.indexOf("https://"),this._isCrossOrigin&&F.isImgCrossOriginAvailable()&&(this._image.crossOrigin="anonymous"),this._filter=void 0!==t?t:WS.Image.Filter.Linear,this._isLoaded=!1,this._isLoading=!1,this._image.onload=function(){i._isLoaded=!0,i._isLoading=!1,i.informListener(WS.Image.OnLoadFuncName,[])}},WS.Image.prototype={getWidth:function(){return this._image?this._image.width:0},getHeight:function(){return this._image?this._image.height:0},addListener:function(e){WS.Observable.prototype.addListener.call(this,e),this.loadImage(),this.isLoaded()&&e[WS.Image.OnLoadFuncName]&&e[WS.Image.OnLoadFuncName]()},loadImage:function(){this._isLoaded||this._isLoading||(this._isLoading=!0,this._image.src=this._imageSrc)},isLoaded:function(){return this._isLoaded},setImageFilter:function(e){this._filter=e,this.informListener(WS.Image.OnParameterChangeFuncName,[])},getRawImage:function(){return this._image},getDownSampleFactor:function(){var e=this.getSize();return F.isMobileSafari()&&this.getSize()>2097152?Math.ceil(Math.sqrt(e/2097152)):1},isJPG:function(){if(this._imageSrc){var e=this._imageSrc;return-1!=e.indexOf(".jpg")||-1!=e.indexOf(".JPG")}return!1},getSize:function(){return this.getWidth()*this.getHeight()}},WS.extend("Image","Observable"),WS.Image.Filter={Linear:"LINEAR",Nearest:"NEAREST"},WS.Image.OnLoadFuncName="onImageLoad",WS.Image.OnParameterChangeFuncName="onParameterChange",WS.SpriteRenderable=function(e,t){this._savedOriginalLayer=void 0,WS.Mesh.call(this,e,t)},WS.SpriteRenderable.prototype={setDirect:function(e){e?(this._savedOriginalLayer=this._layerId,this.addToLayer(WS.Layer.LayerIDs.DYNAMIC,!0)):(this._layerId===WS.Layer.LayerIDs.DYNAMIC&&void 0!==this._savedOriginalLayer&&this.addToLayer(this._savedOriginalLayer,!0),this._savedOriginalLayer=void 0)},draw2d:function(e,t,i){(i||t(this))&&(this._layerId===WS.Layer.LayerIDs.DYNAMIC?this.drawCanvas(e):this.drawImage(e))},drawCanvas:function(e){var t=this._material._canvas;if(t){var i=this.getRectOnScreen(e._camera,e.getModelMatrix(),e._viewport.getWidth(),e._viewport.getHeight());i&&e._ctx.drawImage(t,i._topLeftX,i._topLeftY,i._width,i._height)}},drawImage:function(e){var t=this._material.getImage(0);if(t)if(t.isLoaded()){var i=this.getRectOnScreen(e._camera,e.getModelMatrix(),e._viewport.getWidth(),e._viewport.getHeight());if(!i)return;e._ctx.drawImage(t.getRawImage(),i._topLeftX,i._topLeftY,i._width,i._height)}else t.loadImage()},drawPick:function(e,t){var i,n,o=this._material;this._canvas||(this._canvas=document.createElement("canvas")),n=this._canvas,i=n.getContext("2d");var r=o.getImage(0);if(r)if(r.isLoaded()){var a=this.getRectOnScreen(e,t);a&&(a._topLeftX=0,a._topLeftY=0,n.width=a._width,n.height=a._height,i.clearRect(0,0,a._width,a._height),i.drawImage(r.getRawImage(),a._topLeftX,a._topLeftY,a._width,a._height))}else r.loadImage()},getPickColor:function(e,t){var i=this._canvas.getContext("2d");return i.getImageData(e,t,1,1).data},getRectOnScreen:function(e,t,i,n){var o=i||e._width,r=n||e._height,a=this._material,s=a._spriteSize[0],c=a._spriteSize[1],l=new MatrixArray(4),h=new MatrixArray(4);h[3]=1;var d,u=e._inverseTransform,p=vec3.create(),_=vec3.create(),g=new MatrixArray(4),f=new MatrixArray(4),m=this._geometry,v=[0,0,0,1];if(mat4.multiplyVec3(t,v,h),d=e.projectPoint(h,l,!0,o,r),!d)return void 0;var S=m._positionBuffer._bufferData;return a._scaleByDepth?(_[0]=u[0],_[1]=u[1],_[2]=u[2],p[0]=u[4],p[1]=u[5],p[2]=u[6],g[0]=_[0],g[1]=_[1],g[2]=_[2],g[3]=1,vec3.add(vec3.add(vec3.scale(g,a._spriteSize[0]*S[2]),vec3.scale(vec3.create(p),a._spriteSize[1]*S[3])),h),e.projectPoint(g,g,!0,o,r),f[0]=_[0],f[1]=_[1],f[2]=_[2],f[3]=1,vec3.add(vec3.add(vec3.scale(f,a._spriteSize[0]*S[4]),vec3.scale(p,a._spriteSize[1]*S[5])),h),e.projectPoint(f,f,!0,o,r),s=f[0]-g[0],c=g[1]-f[1]):(g[0]=l[0]+.5*s*S[2],g[1]=l[1]+.5*c*S[3]),new WS.Rectangle(Math.round(g[0]),Math.round(r-g[1]),Math.round(s),Math.round(c))},getPickInfo:function(e,t,i,n){var o=this.getRectOnScreen(e,t);if(!o)return void 0;if(o.containsPt(i,n)){this.drawPick(e,t);var r=this.getPickColor(i-o._topLeftX,n-o._topLeftY);if(r[3]>0)return new WS.PickInfo(this)}return void 0},getRegionPickInfo:function(e,t,i){var n=this.getRectOnScreen(e,t);if(n)return i.containsRect(n)?new WS.PickInfo(this):void 0}},WS.extend("SpriteRenderable","Mesh"),WS.ClickableSpriteRenderable=function(e,t,i,n,o){WS.SpriteRenderable.call(this,e,t),this._type=i,this.setDataObject(n),this._clickId=o},WS.extend("ClickableSpriteRenderable","SpriteRenderable"),WS.ClickableSpriteRenderable.Type={MEASUREMENT_POINT:"measurementPt"},WS.DynamicQuadGeometry=function(){WS.Geometry.call(this),this._positionBuffer=new WS.ArrayBuffer([0,0,0,2,2,0,2,2],2),this._primitiveType=WS.Geometry.PrimitiveType.TriangleStrip},WS.DynamicQuadGeometry.prototype={setPosition:function(e,t,i,n){if(0===e&&0===t)this._positionBuffer.setBufferData([0,0,0,2,2,0,2,2]);else{var o=2*e/i,r=2*t/n;this._positionBuffer.setComponent(0,0,0-o,!0),this._positionBuffer.setComponent(0,1,0-r,!0),this._positionBuffer.setComponent(1,0,0-o,!0),this._positionBuffer.setComponent(1,1,2-r,!0),this._positionBuffer.setComponent(2,0,2-o,!0),this._positionBuffer.setComponent(2,1,0-r,!0),this._positionBuffer.setComponent(3,0,2-o,!0),this._positionBuffer.setComponent(3,1,2-r,!1)}}},WS.extend("DynamicQuadGeometry","Geometry"),WS.LabelRenderable=function(){this._text=void 0,this._textHeight=WS.LabelRenderable.TEXT_HEIGHT,this._borderAddWidth=WS.LabelRenderable.BORDER_ADD_WIDTH,this._borderAddHeight=this._textHeight-2,this._lineBreakHeight=WS.LabelRenderable.LINE_BREAK_HEIGHT,this._font=WS.LabelRenderable.FONT,this._backgroundColor=vec4.create(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL),this._shadowColor=vec4.create(WS.LabelRenderable.SHADOW_COLOR),this._shadowOffsetX=WS.LabelRenderable.SHADOW_OFFSET_X,this._shadowOffsetY=WS.LabelRenderable.SHADOW_OFFSET_Y,this._shadowBlur=WS.LabelRenderable.SHADOW_BLUR,this._textColor=vec4.create(WS.LabelRenderable.TEXT_COLOR),this._textColorCustom=void 0,this._minBorderWidth=WS.LabelRenderable.MIN_BORDER_WIDTH,this._canvas=document.createElement("canvas"),this._icon=void 0,this._occluded=!1,this._categoryColor=void 0,this._iconMode=WS.LabelRenderable.ICON_MODES.Category;var e=new WS.DynamicQuadGeometry,t=new WS.SpriteMaterial(void 0,vec2.create([0,0]),!1,WS.Image.Filter.Nearest);WS.SpriteRenderable.call(this,e,t),this.addToLayer(WS.Layer.LayerIDs.ANNOTATIONS)},WS.LabelRenderable.prototype={updateImage:function(){this.renderToCanvas(),this._material._spriteSize=vec2.createFrom(this._canvas.width,this._canvas.height),this._layerId===WS.Layer.LayerIDs.DYNAMIC?(this._material._canvas=this._canvas,this._material.clearTextureImages()):(this._material._canvas=void 0,this._material.setTextureImgUrls([this._canvas.toDataURL()]),this._material.setTextureImgFilter(WS.Image.Filter.Nearest))},setText:function(e,t){this._text!==e&&(this._text=e,t||this.updateImage())},setTextSize:function(e,t){this._textHeight!==e&&(this._textHeight=e,this._borderAddHeight=this._textHeight-2,t||this.updateImage())},setTextColor:function(e,t){vec4.equal(e,this._textColor)||(this._textColor=vec4.create(e),t||this.updateImage())},setCustomTextColor:function(e){this._textColorCustom=vec4.create(e)},setBackgroundColor:function(e,t){vec4.equal(e,this._backgroundColor)||(this._backgroundColor=vec4.create(e),t||this.updateImage())},setShadowColor:function(e,t){vec4.equal(e,this._shadowColor)||(this._shadowColor=vec4.create(e),t||this.updateImage())},setTransparency:function(e,t){this._backgroundColor[3]=e,this._shadowColor[3]=e,this._textColor[3]=e,t||this.updateImage()},setOcclusion:function(e){this._occluded!==e&&(this._occluded=e,this.onViewingModeChange())},setIconMode:function(e,t){this._iconMode!==e&&(this._iconMode=e,this.onIconModeChange(t))},setCategoryColor:function(e){this._categoryColor=e},removeIcon:function(e){void 0!==this._icon&&(this._icon=void 0,e||this.updateImage())},onIconModeChange:function(e){switch(this._iconMode){case WS.LabelRenderable.ICON_MODES.None:this.removeIcon(!0);break;case WS.LabelRenderable.ICON_MODES.Category:this.removeIcon(!0),this._categoryColor&&(this._icon=new WS.CategoryGraphics2d(this._categoryColor));break;case WS.LabelRenderable.ICON_MODES.Lockstatus:if(this.removeIcon(!0),this._dataObject._writeLock){var t=new WS.Image(WS.LabelRenderable.ICON_LOCK_URL);t.addListener(this),this._icon=new WS.ImageGraphics2d(t)}}e||this.updateImage()},onImageLoad:function(){this.updateImage()},onViewingModeChange:function(){switch(this._viewingMode){case WS.Renderable.ViewingMode.Normal:this.setNormalColors();break;case WS.Renderable.ViewingMode.Highlighted:this.setHighlightedColors();break;case WS.Renderable.ViewingMode.Selected:this.setSelectedColors();break;case WS.Renderable.ViewingMode.Inconsiderable:this.setInconsiderableColors();break;case WS.Renderable.ViewingMode.Displayed:this.setDisplayedColors()}this.updateImage()},redraw:function(){this.updateImage()},renderToCanvas:function(){},supportsDragging:function(){return!0},dragStart:function(){this.updateImage()},dragMove:function(){},dragStop:function(){this.updateImage()},drawShadow:function(e){e.shadowColor=WS.Renderer2D.colorToStyle(this._shadowColor),e.shadowOffsetX=this._shadowOffsetX,e.shadowOffsetY=this._shadowOffsetY,e.shadowBlur=this._shadowBlur,e.fill(),e.shadowOffsetX=e.shadowOffsetY=0,e.shadowBlur=0},setHighlightedColors:function(){this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_HIGHLIGHTED,!0),this.setTextColor(WS.LabelRenderable.TEXT_COLOR,!0),this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR,!0),this.setTransparency(WS.LabelRenderable.TRANSPARENCY_SELECTED,!0)},setSelectedColors:function(){this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_SELECTED,!0),this.setTextColor(WS.LabelRenderable.TEXT_COLOR,!0),this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR,!0),this.setTransparency(WS.LabelRenderable.TRANSPARENCY_SELECTED,!0)},setInconsiderableColors:function(){this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL,!0),this.setTextColor(this._textColorCustom?this._textColorCustom:WS.LabelRenderable.TEXT_COLOR,!0),this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR,!0),this.setTransparency(WS.LabelRenderable.TRANSPARENCY_INCONSIDERABLE,!0)},setNormalColors:function(){this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL,!0),this.setTextColor(this._textColorCustom?this._textColorCustom:WS.LabelRenderable.TEXT_COLOR,!0),this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR,!0),this.setTransparency(this._occluded?WS.LabelRenderable.TRANSPARENCY_OCCLUDED:WS.LabelRenderable.TRANSPARENCY_NORMAL,!0)},setDisplayedColors:function(){this.setNormalColors(),this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_DISPLAYED,!0)}},WS.extend("LabelRenderable","SpriteRenderable"),WS.LabelRenderable.TEXT_HEIGHT=12,WS.LabelRenderable.LINE_BREAK_HEIGHT=5,WS.LabelRenderable.BORDER_ADD_WIDTH=10,WS.LabelRenderable.FONT="arial",WS.LabelRenderable.BACKGROUND_COLOR_NORMAL=[.86,.86,.86,.85],WS.LabelRenderable.BACKGROUND_COLOR_DISPLAYED=[.9803921568627451,.7098039215686275,.007843137254902,1],WS.LabelRenderable.BACKGROUND_COLOR_SELECTED=[.47,.804,.95,1],WS.LabelRenderable.BACKGROUND_COLOR_HIGHLIGHTED=[.98,.875,.08,1],WS.LabelRenderable.SHADOW_COLOR=[.25,.25,.25,.85],WS.LabelRenderable.SHADOW_OFFSET_X=2,WS.LabelRenderable.SHADOW_OFFSET_Y=2,WS.LabelRenderable.SHADOW_BLUR=1,WS.LabelRenderable.TEXT_COLOR=[0,0,0,.8],WS.LabelRenderable.TRANSPARENCY_SELECTED=1,WS.LabelRenderable.TRANSPARENCY_NORMAL=.85,WS.LabelRenderable.TRANSPARENCY_OCCLUDED=.5,WS.LabelRenderable.TRANSPARENCY_INCONSIDERABLE=.5,WS.LabelRenderable.MIN_BORDER_WIDTH=30,WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP=[.25,.25,.25,.85],WS.LabelRenderable.SHADOW_COLOR_MAP=[.86,.86,.86,.85],WS.LabelRenderable.TEXT_COLOR_MAP=[1,1,1,.8],WS.LabelRenderable.ICON_LOCK_URL=WS.imgUrlCanvasSafe("icons/lock.png"),WS.LabelRenderable.ICON_CATEGORY=0,WS.LabelRenderable.ICON_LOCK=1,WS.LabelRenderable.ICON_MODES={None:0,Category:1,Lockstatus:2},WS.LabelRenderable.ICON_HEIGHT=24,WS.LabelRenderable.ICON_WIDTH=24,WS.AnnotationRenderable=function(e){WS.LabelRenderable.call(this),this._hasMapType="undefined"!=typeof e?e:!1,this._tailOffsetX=0,this._tailOffsetY=WS.AnnotationRenderable.TAIL_Y_OFFSET_DEFAULT,this._tailWidthX=WS.AnnotationRenderable.TAIL_WIDTH_X,this._tailWidthY=WS.AnnotationRenderable.TAIL_WIDTH_Y,this._tailXGapToEdge=WS.AnnotationRenderable.TAIL_X_GAP_TO_EDGE,this._tailYGapToEdge=WS.AnnotationRenderable.TAIL_Y_GAP_TO_EDGE,this._backgroundColor=vec4.create(this._hasMapType?WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP:WS.LabelRenderable.BACKGROUND_COLOR_NORMAL),this._shadowColor=vec4.create(this._hasMapType?WS.LabelRenderable.SHADOW_COLOR_MAP:WS.LabelRenderable.SHADOW_COLOR),this._textColor=vec4.create(this._hasMapType?WS.LabelRenderable.TEXT_COLOR_MAP:WS.LabelRenderable.TEXT_COLOR)},WS.AnnotationRenderable.prototype={setNormalColors:function(){var e;e=this._hasMapType?WS.LabelRenderable.TEXT_COLOR_MAP:this._textColorCustom?this._textColorCustom:WS.LabelRenderable.TEXT_COLOR,this.setBackgroundColor(this._hasMapType?WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP:WS.LabelRenderable.BACKGROUND_COLOR_NORMAL,!0),this.setTextColor(e,!0),this.setShadowColor(this._hasMapType?WS.LabelRenderable.SHADOW_COLOR_MAP:WS.LabelRenderable.SHADOW_COLOR,!0),this.setTransparency(this._occluded?WS.LabelRenderable.TRANSPARENCY_OCCLUDED:WS.LabelRenderable.TRANSPARENCY_NORMAL,!0)},renderToCanvas:function(){this._canvas||(this._canvas=document.createElement("canvas"));var e=this._canvas.getContext("2d"),t=this._textHeight+"px Arial";e.font=t;for(var i=(this._text||"").split("\n"),n=i.length,o=this._minBorderWidth,r=0;n>r;r++){var a=e.measureText(i[r]).width;a>o&&(o=a)}var s=o+this._borderAddWidth;this._icon&&(s+=WS.LabelRenderable.ICON_WIDTH);var c,l,h=n*this._textHeight+(n-1)*this._lineBreakHeight+this._borderAddHeight,d=this._shadowOffsetX+this._shadowBlur,u=this._shadowOffsetY+this._shadowBlur,p=Math.max(0,-this._tailOffsetX),_=Math.max(0,-h-this._tailOffsetY),g=p+s,f=_+h,m=.5*(p+g),v=.5*(_+f),S=vec2.createFrom(p,_),b=vec2.createFrom(m,_),y=vec2.createFrom(g,_),P=vec2.createFrom(g,v),C=vec2.createFrom(g,f),w=vec2.createFrom(m,f),T=vec2.createFrom(p,f),M=vec2.createFrom(p,v),W=vec2.createFrom(Math.max(0,this._tailOffsetX),f+this._tailOffsetY),E=0;if(e.canvas.width=Math.max(g+d,W[0])-Math.min(p,W[0]),e.canvas.height=Math.max(f+u,W[1])-Math.min(_,W[1]),p<=W[0]&&W[0]<=g&&_<=W[1]&&W[1]<=f)E=6;else if(W[0]<=m){var I=Math.atan2(f-W[1],p),R=Math.atan2(_-W[1],p);-.523598776>=I?(c=vec2.createFrom(p+this._tailXGapToEdge+this._tailWidthX,f),l=vec2.createFrom(p+this._tailXGapToEdge,f)):R>=.523598776?(E=2,c=vec2.createFrom(p+this._tailXGapToEdge,_),l=vec2.createFrom(p+this._tailXGapToEdge+this._tailWidthX,_)):(E=1,c=vec2.createFrom(p,f-this._tailYGapToEdge),l=vec2.createFrom(p,f-this._tailYGapToEdge-this._tailWidthY))}else{var L=g-W[0],O=f-W[1],D=_-W[1],F=Math.atan2(O,L),A=Math.atan2(D,L);0>O&&F>=-2.61799388?(E=5,c=vec2.createFrom(g-this._tailXGapToEdge,f),l=vec2.createFrom(g-this._tailXGapToEdge-this._tailWidthX,f)):D>=0&&2.61799388>=A?(E=3,c=vec2.createFrom(g-this._tailXGapToEdge-this._tailWidthX,_),l=vec2.createFrom(g-this._tailXGapToEdge,_)):(E=4,c=vec2.createFrom(g,f-this._tailYGapToEdge),l=vec2.createFrom(g,f-this._tailYGapToEdge-this._tailWidthY))}e.clearRect(0,0,e.canvas.width,e.canvas.height);var x=5;e.fillStyle=WS.Renderer2D.colorToStyle(this._backgroundColor),e.beginPath(),e.moveTo(b[0],b[1]),3===E&&(e.lineTo(c[0],c[1]),e.lineTo(W[0],W[1]),e.lineTo(l[0],l[1])),e.arcTo(y[0],y[1],y[0],y[1]+x,x),4===E?(e.lineTo(c[0],c[1]),e.lineTo(W[0],W[1]),e.lineTo(l[0],l[1])):e.lineTo(P[0],P[1]),e.arcTo(C[0],C[1],C[0]-x,C[1],x),5===E&&(e.lineTo(c[0],c[1]),e.lineTo(W[0],W[1]),e.lineTo(l[0],l[1])),e.lineTo(w[0],w[1]),0===E&&(e.lineTo(c[0],c[1]),e.lineTo(W[0],W[1]),e.lineTo(l[0],l[1])),e.arcTo(T[0],T[1],T[0],T[1]-x,x),1===E?(e.lineTo(c[0],c[1]),e.lineTo(W[0],W[1]),e.lineTo(l[0],l[1])):e.lineTo(M[0],M[1]),e.arcTo(S[0],S[1],S[0]+x,S[1],x),2===E&&(e.lineTo(c[0],c[1]),e.lineTo(W[0],W[1]),e.lineTo(l[0],l[1])),e.closePath(),this.drawShadow(e),e.font=t,e.fillStyle=WS.Renderer2D.colorToStyle(this._textColor);var k=p+.5*this._borderAddWidth,U=_+.5*this._borderAddHeight+this._textHeight-1;for(r=0;n>r;++r)e.fillText(i[r],k,U),U+=this._textHeight+this._lineBreakHeight;this._icon&&this._icon.draw(e,y[0]-24,y[1],WS.LabelRenderable.ICON_WIDTH,WS.LabelRenderable.ICON_HEIGHT);var j=Math.max(W[0]-p,0),N=Math.max(f+u-W[1],0);this._geometry.setPosition(j,N,e.canvas.width,e.canvas.height)},changeTailOffsets:function(e,t,i){if(0!==e||0!==t){if(this._tailOffsetX+=-e,this._tailOffsetY+=-t,i)return;this.updateImage()}},dragMove:function(e,t){this.changeTailOffsets(e,t,!1)},updateIcon:function(e){var t=this._dataObject?this._dataObject._category:void 0;if(t){var i=WS.ColorGenerator.intColorFromString(t),n=WS.ColorGenerator.rgbColorFromInt(i);this.setCategoryColor(n)}else this.setCategoryColor(void 0);this.onIconModeChange(e)}},WS.extend("AnnotationRenderable","LabelRenderable"),WS.AnnotationRenderable.TAIL_WIDTH_X=10,WS.AnnotationRenderable.TAIL_WIDTH_Y=8,WS.AnnotationRenderable.TAIL_X_GAP_TO_EDGE=12,WS.AnnotationRenderable.TAIL_Y_GAP_TO_EDGE=6,WS.AnnotationRenderable.TAIL_Y_OFFSET_DEFAULT=15,WS.MatrixStack=function(){this._top=mat4.identity(),this._stack=[]},WS.MatrixStack.prototype={addOrthoMatrix:function(e,t){var i=0===e[12]&&0===e[13]&&0===e[14]&&1===e[0]&&1===e[5];return i&&t?!1:(this._stack.push(this._top),i||(this._top=mat4.create(this._top),mat4.multiply(this._top,e)),!0)},popMatrix:function(){this._top=this._stack.pop()}},WS.extend("MatrixStack"),WS.Viewport=function(e,t){this._dimensions=vec2.create([e,t])},WS.Viewport.prototype={setDimensions:function(e,t){this._dimensions=vec2.create([e,t])},use:function(){},isValid:function(){return this._dimensions[0]>0&&this._dimensions[1]>0},getWidth:function(){return this._dimensions[0]},getHeight:function(){return this._dimensions[1]}},WS.extend("Viewport"),WS.VisitorBase=function(){},WS.VisitorBase.prototype={prepare:function(){},preVisit:function(){return!0},visit:function(){return!0},postVisit:function(){return!0}},WS.extend("VisitorBase"),WS.SceneVisitorBase=function(){this._modelMatrixStack=void 0},WS.SceneVisitorBase.prototype={preVisit:function(e){return e._transform&&this._modelMatrixStack.addOrthoMatrix(e._transform),!0},postVisit:function(e){return e._transform&&this._modelMatrixStack.popMatrix(),!0}},WS.extend("SceneVisitorBase","VisitorBase"),WS.RenderVisitor=function(e,t,i,n){this._layerService=F.DI().getService("layer"),this._zIndex=i,this._view=n,this._cameraObject=void 0,this._camPosGlobal=void 0,this._filterFunc=void 0,this._renderer=e,this._modelMatrixStack=this._renderer._modelMatrixStack,this._renderFuncName=t,this._isVisible=F.proxy(this.isVisible,this)},WS.RenderVisitor.prototype={prepare:function(){var e=this._renderer._camera;e&&(this._cameraObject=e.createCameraObject(mat4.identity()),this._camPosGlobal=this._cameraObject.getGlobalPosition())},visit:function(e){if(!(e instanceof WS.Renderable))return!0;if(this._renderer instanceof WS.Renderer3D&&this._renderer._renderColorMode===WS.RendererBase.RenderMode.PICK_3D&&!e._pickable3d)return!0;if(e[this._renderFuncName]){var t=this._layerService.getObjectsVisbleUpToDistance(e._layerId,this._view);(t===Number.POSITIVE_INFINITY||vec3.dist2(this._camPosGlobal,mat4.getTranslation(this._modelMatrixStack._top))<t*t)&&e[this._renderFuncName](this._renderer,this._isVisible,!1)}return!0},isVisible:function(e){var t=this._filterFunc?this._filterFunc(e):!0;return t&&this._layerService.isLayerVisible(e._layerId,this._view)&&(void 0===this._zIndex||this._layerService.getZIndexOfLayer(e._layerId,this._view)===this._zIndex)}},WS.extend("RenderVisitor","SceneVisitorBase"),WS.RendererBase=function(e,t){this._clearColor=void 0,this._camera=void 0,this._view=t,this._viewport=void 0,this._canvasScaleFactor=1,this._canvasWidth=void 0,this._canvasHeight=void 0,this._modelMatrixStack=new WS.MatrixStack,this._material=void 0,this._geometry=void 0,this._drawVisitor=void 0,this._ctx=void 0,this._zIndices=e},WS.RendererBase.prototype={setAndPrepareGeometry:function(){},setAndPrepareMaterial:function(){},drawGeometry:function(){},getModelMatrix:function(){return this._modelMatrixStack._top},setCamera:function(e){this._camera=e},setViewPort:function(e){this._viewport=e},setViewPortDimensions:function(e,t){this._viewport.setDimensions(e,t),this._viewport.use()},drawScene:function(e,t,i,n,o){var r=this._drawVisitor;r._filterFunc=n,this.setCamera(e),i||this.clear();for(var a=o&&o.zIndices?o.zIndices:this._zIndices,s=a.length,c=0;s>c;c++)r._zIndex=a[c],t.traverse(r);r._filterFunc=void 0},setClearColor:function(e){this._clearColor=e},clear:function(){},setCanvasScaleFactor:function(e){this._canvasScaleFactor!==e&&(this._canvasScaleFactor=e,this.updateCanvasObjectDimensions())},setCanvasDimensions:function(e,t){var i=this._ctx?this._ctx.canvas:void 0;i&&(this._canvasWidth=e,this._canvasHeight=t),this.updateCanvasObjectDimensions()},updateCanvasObjectDimensions:function(){var e=this._canvasWidth,t=this._canvasHeight,i=this._ctx?this._ctx.canvas:void 0;e=Math.floor(e/this._canvasScaleFactor),t=Math.floor(t/this._canvasScaleFactor),i&&(i.width=e,i.height=t)},getTexture:function(){return void 0},deleteStorageForRenderableAndMembers:function(e){for(var t=e.getMemberRenderables(),i=0,n=t.length;n>i;++i)this.deleteStorageForRenderable(t[i]);this.deleteStorageForRenderable(e)},deleteStorageForRenderable:function(e){this.deleteTexturesForRenderable(e)},deleteTexturesForRenderable:function(e){if(e._material&&e._material._images&&0!==e._material._images.length)for(var t=e._material._images,i=0,n=t.length;n>i;i++)this._textureStorage.deleteTexture(t[i])},getMaterialTextures:function(e){if(!e||!e._images)return void 0;for(var t=[],i=0,n=e._images.length;n>i;i++)t[i]=this.getTexture(e._images[i]);return t},areAllTexturesUploaded:function(e){if(!e._images)return!0;for(var t,i=0,n=e._images.length;n>i;i++)if(t=this.getTexture(e._images[i]),t&&!t.isImageUploaded())return!1;return!0}},WS.extend("RendererBase"),WS.RendererBase.RenderMode={DEFAULT:0,DEPTH:1,PICK_2D:2,PICK_3D:3,PICK_3D_POINT:4,NODE:5},WS.PolyCircuitGeometry=function(e){WS.Geometry.call(this),this._positionBuffer=e,this._positionItemSize=3,this._primitiveType=WS.Geometry.PrimitiveType.PolyCircuit},WS.extend("PolyCircuitGeometry","Geometry"),WS.CanvasTexture=function(e){this._imageUploaded=!1,this._canvasData=[],this._canvasElementWidth=WS.CanvasTexture.ElementWidth,this._canvasElementHeight=WS.CanvasTexture.ElementHeight,this._image=e,this._defer=Q.defer(),this._image.addListener(this)},WS.CanvasTexture.prototype={getPromise:function(){return this._defer.promise},getWidth:function(){return this._image.getWidth()},getHeight:function(){return this._image.getHeight()},onImageLoad:function(){this.uploadImage()},uploadImage:function(){var e=this._image;e.isLoaded()&&(e.getWidth()>this._canvasElementWidth&&e.getHeight()>this._canvasElementHeight?this.uploadImageTiled():this.uploadImageSingle(),this._defer.resolve())},uploadImageSingle:function(){var e,t=this._image;if(t.isLoaded()){var i=document.createElement("canvas"),n=i.getContext("2d"),o=1/t.getDownSampleFactor();i.width=this.getWidth(),i.height=this.getHeight(),n.drawImage(t.getRawImage(),0,0,Math.round(t.getWidth()*o),Math.round(t.getHeight()*o),0,0,i.width,i.height),e=n.getImageData(0,0,i.width,i.height),this._canvasData=e.data,this._imageUploaded=!0}},uploadImageTiled:function(){var e,t,i,n,o,r,a,s,c,l,h,d,u,p,_,g,f=this._image,m=0,v=0,S=[],b=[],y=[],P=this.getWidth(),C=this.getHeight(),w=this._canvasElementHeight,T=this._canvasElementWidth;if(f&&f.isLoaded()){for(p=Math.ceil(f.getWidth()/T),_=Math.ceil(f.getHeight()/w),g=p*_,t=0;g>t;t++)S[t]=document.createElement("canvas"),b[t]=S[t].getContext("2d");for(u=1/f.getDownSampleFactor(),i=0;_>i;i++)for(t=0;p>t;t++)n=t===p-1?P%T:T,o=i===_-1?C%w:w,n=0===n?T:n,o=0===o?w:o,S[m].width=n,S[m].height=o,b[m].drawImage(f.getRawImage(),Math.round(t*n*u),Math.round(i*o*u),Math.round(n*u),Math.round(o*u),0,0,n,o),e=b[m].getImageData(0,0,n,o),y[m]=e.data,m++;var M;M="undefined"!=typeof Uint8ClampedArray?Uint8ClampedArray:"undefined"!=typeof Uint8Array?Uint8Array:Array,this._canvasData=new M(P*C*4);var W=this._canvasData;for(i=0;C>i;i++)for(t=0;P>t;t++)s=Math.floor(t/T),c=Math.floor(i/w),l=s+p*c,n=s===p-1?P%T:T,n=0===n?T:n,r=t%T,a=i%w,h=4*(n*a+r),d=y[l],W[v]=d[h],W[v+1]=d[h+1],W[v+2]=d[h+2],W[v+3]=d[h+3],v+=4;this._imageUploaded=!0}},isImageUploaded:function(){return this._imageUploaded},destroy:function(){this._image&&this._image.removeListener(this),this._imageUploaded=!1,this._canvasData=void 0,this._image=void 0,this._defer=void 0},getPixel:function(e,t,i){var n,o=this.getWidth(),r=this.getHeight();e=e>=0?e:o+e,t=t>=0?t:r+t,e=Math.min(e,o-1),t=Math.min(t,r-1);var a=4*(o*t+e);n=this._canvasData,i[0]=n[a],i[1]=n[a+1],i[2]=n[a+2],i[3]=n[a+3]}},WS.extend("CanvasTexture","Object"),WS.CanvasTexture.ElementWidth=F.getMaxCanvasWidth(),WS.CanvasTexture.ElementHeight=F.getMaxCanvasHeight(),WS.CanvasTexture.getMaxWidth=function(){return F.getMaxCanvasWidth()},WS.CanvasTexture.getMaxHeight=function(){return F.getMaxCanvasHeight()},WS.Renderer2D=function(e,t,i,n){WS.RendererBase.call(this,t,i),this._ctx=e,this._pointSize=1,this._lineWidth=1,this._textureStorage=new WS.TextureStorage(this._ctx),this._drawVisitor=new WS.RenderVisitor(this,"draw2d",void 0,this._view),this._subdivQuality=WS.Renderer2D.SubdivQuality.HIGH,this._subdiv=n||WS.Renderer2D.SubdivOptions,this._subdivTemp2=void 0,this._subdivTemp3=void 0,this.setViewPort(new WS.Viewport(e.canvas.width,e.canvas.height)),this.setClearColor([1,1,1,0]),this.clear()},WS.Renderer2D.prototype={clearStorage:function(){this._textureStorage.deleteAllTextures()},getTexture:function(e){if(!e)return void 0;var t=this._textureStorage.inquireTexture(e,WS.CanvasTexture);return t},setAndPrepareGeometry:function(e){this._geometry=e},setAndPrepareMaterial:function(e){return this._material=e,this._material.configureRenderer2d(this)},setFillColor:function(e){var t=this._ctx,i=WS.Renderer2D.colorToStyle(e);t.fillStyle=i},setStrokeColor:function(e){var t=this._ctx,i=WS.Renderer2D.colorToStyle(e);t.strokeStyle=i},configureRenderer2d:function(){return this._material.configureRenderer2d(this)},clear:function(){var e=this._viewport;this._ctx.clearRect(0,0,e.getWidth(),e.getHeight()),this.setFillColor(this._clearColor),this._ctx.fillRect(0,0,e.getWidth(),e.getHeight())},setPointSize:function(e){this._pointSize=e},setLineWidth:function(e){e!==this._lineWidth&&(this._lineWidth=e,this._ctx.lineWidth=e)},setSubdivQuality:function(e){this._subdivQuality=e},drawPoints:function(e,t,i){for(var n,o,r=this._camera._height,a=this._ctx,s=e.length,c=this._pointSize,l=c/2,h=0;s>h;++h){var d=e[h];d&&(this.setFillColor(t[h]),i?(n=d[0]-l,o=r-d[1]-l,a.fillRect(n,o,c,c)):(n=d[0],o=r-d[1],a.beginPath(),a.arc(n,o,l,0,2*Math.PI,!1),a.fill()))}},drawTexturedTriangleNoSubdiv:function(e,t,i,n,o,r,a,s){var c,l,h,d,u,p,_,g,f=this._ctx,m=i[0],v=i[1],S=n[0],b=n[1],y=o[0],P=o[1],C=r[0],w=r[1],T=a[0]-C,M=a[1]-w,W=s[0]-C,E=s[1]-w;f.save(),f.beginPath(),f.moveTo(m,v),f.lineTo(S,b),f.lineTo(y,P),f.closePath(),f.clip(),S-=m,b-=v,y-=m,P-=v,_=T*E-W*M,0!==_&&(g=1/_,c=(E*S-M*y)*g,l=(E*b-M*P)*g,h=(T*y-W*S)*g,d=(T*P-W*b)*g,u=m-c*C-h*w,p=v-l*C-d*w,f.transform(c,l,h,d,u,p),f.globalAlpha=t,f.drawImage(e,0,0)),f.restore()},subdivAllocTemp:function(){if(!this._subdivTemp2){var e=3*(this._subdiv.high.maxDepth+1);this._subdivTemp2=new Array(e),this._subdivTemp3=new Array(e);for(var t=0;e>t;t++)this._subdivTemp2[t]=vec2.create(),this._subdivTemp3[t]=vec3.create()}},drawTexturedTriangleSubdiv:function(e,t,i,n,o,r,a,s,c){if(vec2.isTriangleVisible(i,n,o,this._viewport.getWidth(),this._viewport.getHeight())){var l,h=this._subdiv[this._subdivQuality];if(c++,c>h.maxDepth)l=0;else if(h.mode===WS.Renderer2D.Subdiv.FIXED)l=7;else{var d=Math.abs(i[0]-n[0])+Math.abs(i[1]-n[1]),u=Math.abs(n[0]-o[0])+Math.abs(n[1]-o[1]),p=Math.abs(o[0]-i[0])+Math.abs(o[1]-i[1]),_=Math.abs(1/i[2]-1/n[2]),g=Math.abs(1/n[2]-1/o[2]),f=Math.abs(1/o[2]-1/i[2]),m=h.minArea2dDepth;l=(d*_>m?1:0)+(u*g>m?2:0)+(p*f>m?4:0)}if(0===l)return void this.drawTexturedTriangleNoSubdiv(e,t,i,n,o,r,a,s);var v,S,b,y,P,C,w=3*c;switch(1&l&&(v=this._subdivTemp3[w],y=this._subdivTemp2[w],vec3.lerp(i,n,.5,v),vec2.lerp(r,a,n[2]/(i[2]+n[2]),y)),2&l&&(S=this._subdivTemp3[w+1],P=this._subdivTemp2[w+1],vec3.lerp(n,o,.5,S),vec2.lerp(a,s,o[2]/(n[2]+o[2]),P)),4&l&&(b=this._subdivTemp3[w+2],C=this._subdivTemp2[w+2],vec3.lerp(o,i,.5,b),vec2.lerp(s,r,i[2]/(o[2]+i[2]),C)),l){case 1:this.drawTexturedTriangleSubdiv(e,t,i,v,o,r,y,s,c),this.drawTexturedTriangleSubdiv(e,t,v,n,o,y,a,s,c);break;case 2:this.drawTexturedTriangleSubdiv(e,t,i,n,S,r,a,P,c),this.drawTexturedTriangleSubdiv(e,t,i,S,o,r,P,s,c);break;case 3:this.drawTexturedTriangleSubdiv(e,t,i,v,S,r,y,P,c),this.drawTexturedTriangleSubdiv(e,t,i,S,o,r,P,s,c),this.drawTexturedTriangleSubdiv(e,t,v,n,S,y,a,P,c);break;case 4:this.drawTexturedTriangleSubdiv(e,t,i,n,b,r,a,C,c),this.drawTexturedTriangleSubdiv(e,t,n,o,b,a,s,C,c);break;case 5:this.drawTexturedTriangleSubdiv(e,t,i,v,b,r,y,C,c),this.drawTexturedTriangleSubdiv(e,t,n,o,v,a,s,y,c),this.drawTexturedTriangleSubdiv(e,t,o,b,v,s,C,y,c);break;case 6:this.drawTexturedTriangleSubdiv(e,t,i,n,b,r,a,C,c),this.drawTexturedTriangleSubdiv(e,t,n,S,b,a,P,C,c),this.drawTexturedTriangleSubdiv(e,t,S,o,b,P,s,C,c);break;case 7:this.drawTexturedTriangleSubdiv(e,t,i,v,b,r,y,C,c),this.drawTexturedTriangleSubdiv(e,t,n,S,v,a,P,y,c),this.drawTexturedTriangleSubdiv(e,t,o,b,S,s,C,P,c),this.drawTexturedTriangleSubdiv(e,t,v,S,b,y,P,C,c)}}},drawTexturedTriangle:function(e,t,i,n,o,r,a,s,c){var l=this._camera._height,h=e.width-1,d=e.height-1,u=vec3.createFrom(i[0],l-i[1],i[4]),p=vec3.createFrom(n[0],l-n[1],n[4]),_=vec3.createFrom(o[0],l-o[1],o[4]),g=vec2.createFrom(r[0]*h,(1-r[1])*d),f=vec2.createFrom(a[0]*h,(1-a[1])*d),m=vec2.createFrom(s[0]*h,(1-s[1])*d);c?(this.subdivAllocTemp(),this.drawTexturedTriangleSubdiv(e,t,u,p,_,g,f,m,0)):this.drawTexturedTriangleNoSubdiv(e,t,u,p,_,g,f,m)},drawTexturedTriangles:function(e,t,i,n){if(!i.isLoaded())return void i.loadImage();for(var o,r,a,s=e.length,c=vec2.create(),l=vec2.create(),h=vec2.create(),d=this._subdiv[this._subdivQuality],u=!this._camera.instanceOf(WS.OrthoCamera)&&d.mode!==WS.Renderer2D.Subdiv.NONE,p=i.getRawImage(),_=0;s>_;_+=3)o=e[_],r=e[_+1],a=e[_+2],o&&r&&a&&(t.getItem(_,c),t.getItem(_+1,l),t.getItem(_+2,h),this.drawTexturedTriangle(p,n,o,r,a,c,l,h,u))},fillTriangle:function(e,t,i,n){var o=this._ctx,r=this._camera._height;this.setFillColor(n),o.beginPath(),o.moveTo(e[0],r-e[1]),o.lineTo(t[0],r-t[1]),o.lineTo(i[0],r-i[1]),o.closePath(),o.fill()
},drawTriangles:function(e,t){for(var i,n,o,r=e.length,a=0;r>a;a+=3)i=e[a],n=e[a+1],o=e[a+2],i&&n&&o&&this.fillTriangle(i,n,o,t[a])},drawTrianglesIndexed:function(e,t,i,n,o){for(var r,a,s,c=this._viewport.getWidth(),l=this._viewport.getHeight(),h=0;i>h;h+=3){var d=t[h],u=t[h+1],p=t[h+2];r=e[d],a=e[u],s=e[p],r&&a&&s&&vec2.isTriangleVisible(r,a,s,c,l)&&!WS.GeometryProjector.isCulled(r,a,s,o)&&this.fillTriangle(r,a,s,n[d])}},drawTriangleStrip:function(e,t,i){for(var n,o,r,a=e.length,s=(this._ctx,this._viewport.getWidth()),c=this._viewport.getHeight(),l=!0,h=0;a>h;h++)n=o,o=r,r=e[h],n&&o&&r&&vec2.isTriangleVisible(n,o,r,s,c)&&!WS.GeometryProjector.isCulled(n,l?o:r,l?r:o,i)&&this.fillTriangle(n,o,r,t[h]),l=!l},drawPolyCircuit:function(e,t){var i=e.length;if(i>=3){var n=this._camera._height,o=!0,r=this._ctx;r.beginPath(),this.setFillColor(t[0]);for(var a=0;i>a;++a){var s=e[a][0],c=n-e[a][1];o?(r.moveTo(s,c),o=!1):r.lineTo(s,c)}r.closePath(),r.fill()}},drawLineSegments:function(e,t,i){for(var n=this._camera._height,o=this._ctx,r=i?1:2,a=0,s=e.length-1;s>a;a+=r)e[a]&&e[a+1]&&(this.setStrokeColor(t[a]),o.beginPath(),o.moveTo(e[a][0],n-e[a][1]),o.lineTo(e[a+1][0],n-e[a+1][1]),o.stroke())},drawLineStrip:function(e,t){this.drawLineSegments(e,t,!0)},drawLines:function(e,t){this.drawLineSegments(e,t,!1)},drawGeometry:function(){var e,t,i,n,o=this._geometry,r=this._material,a=this._viewport.getWidth(),s=this._viewport.getHeight(),c=WS.GeometryProjector.projectGeometry(this._camera,this._geometry,this.getModelMatrix(),a,s,r._cullFace);switch(r.instanceOf(WS.TextureMaterial)?(t=r._images[0],i=r._coordBuffer,n=r._alpha):e=this.getColorsForGeometry(),o._primitiveType){case WS.Geometry.PrimitiveType.Points:this.drawPoints(c,e);break;case WS.Geometry.PrimitiveType.Lines:this.drawLines(c,e);break;case WS.Geometry.PrimitiveType.LineStrip:this.drawLineStrip(c,e);break;case WS.Geometry.PrimitiveType.Triangles:i?this.drawTexturedTriangles(c,i,t,n):o._indexBuffer?this.drawTrianglesIndexed(c,o._indexBuffer._bufferData,o.getCountIndices(),e,r._cullFace):this.drawTriangles(c,e);break;case WS.Geometry.PrimitiveType.TriangleStrip:this.drawTriangleStrip(c,e,r._cullFace);break;case WS.Geometry.PrimitiveType.PolyCircuit:this.drawPolyCircuit(c,e)}},getColorsForGeometry:function(){for(var e=this._material,t=(e.getColorCount(),this._geometry.getCountPositions()),i=new Array(t),n=0;t>n;n++){{var o=new MatrixArray(4);e.getColor(n,o)}i[n]=o}return i}},WS.extend("Renderer2D","RendererBase"),WS.Renderer2D.SubdivQuality={HIGH:"high",LOW:"low"},WS.Renderer2D.Subdiv={NONE:0,FIXED:1,ADAPTIVE:2},WS.Renderer2D.SubdivOptions={high:{mode:WS.Renderer2D.Subdiv.ADAPTIVE,maxDepth:10,minArea2dDepth:150},low:{mode:WS.Renderer2D.Subdiv.ADAPTIVE,maxDepth:10,minArea2dDepth:400}},WS.Renderer2D.colorToStyle=function(e){var t=Math.round(255*e[0]),i=Math.round(255*e[1]),n=Math.round(255*e[2]),o=e[3];return"rgba("+t+","+i+","+n+","+o+")"},F.shaderSrc={color_vs:"attribute vec3 aVertexPosition;uniform mat4 uModelMatrix;uniform mat4 uViewProjectionMatrix;attribute vec4 aColor;varying vec4 v_c;void main(){gl_Position=uViewProjectionMatrix*uModelMatrix*vec4(aVertexPosition,1.0);v_c=aColor;}",color_fs:"precision mediump float;\n#ifndef FAILSAFE\nconst float c=4.0;const float d=256.0*c;float e(vec3 f){return c*(256.0*f.r+f.g+0.00390625*f.b);}uniform bool uDepthTest;uniform float uInvViewX;uniform float uInvViewY;uniform sampler2D uTexDepth;const float h=0.001;bool i(vec4 j,vec3 k){float l=e(k);float m=j.z/j.w;return (m<l+h);}\n#endif\nvarying vec4 v_c;void main(void){\n#ifndef FAILSAFE\nif(uDepthTest){vec2 n=vec2(gl_FragCoord.x*uInvViewX,gl_FragCoord.y*uInvViewY);vec4 k=texture2D(uTexDepth,n);if(!i(gl_FragCoord,k.rgb)){discard;}}\n#endif\ngl_FragColor=v_c;}",dynamicpoint_vs:"const float c=8.0;const float d=5.0;const float e=(c-d);const float f=0.75;const float h=1.001;const float i=(h-f);attribute vec3 aVertexPosition;attribute vec4 aColor;uniform mat4 uModelViewMatrix;uniform mat4 uProjectionMatrix;uniform bool uDynamicPointSize;uniform mat4 uTransform;uniform float uPointSizeFactor;uniform float uMinPointSize,uMaxPointSize;uniform float uAlpha;uniform bool uColor8Bit;uniform int uColorMode;uniform vec4 uFixedColor;uniform bool uQuadPoint;varying vec4 v_c;varying float v_d;\n#ifdef VORONOI\nvarying float v_e;varying float v_f;varying vec3 v_h;\n#endif\nconst float j=4.0;const float k=256.0*j;const float l=1.0/j;vec3 m(float n){vec3 o;n*=l;o.r=floor(n);n-=o.r;o.g=floor(n*256.0);n-=o.g*0.00390625;o.b=n*65536.0;o*=0.00390625;return o;}void main(){float p;vec4 q=uModelViewMatrix*vec4(aVertexPosition,1.0);gl_Position=uProjectionMatrix*q;float s=(-1.0/q.z);if(uDynamicPointSize){p=uPointSizeFactor*s;p=min(uMaxPointSize,max(p,uMinPointSize));p+=(p*abs(gl_Position.x)/gl_Position.w)*0.25;}else{p=uMinPointSize;}gl_PointSize=p;\n#ifdef VORONOI\nv_h=q.xyz;v_f=p;v_e=p/s;\n#endif\nif(uColorMode==0){if(uColor8Bit){v_c=aColor/255.0;}else{v_c=aColor;}}else if(uColorMode==1){v_c=uFixedColor;}else{v_c=vec4(m(-q.z),1.0);}v_c.a*=uAlpha;if(uQuadPoint){v_d=h;}else{v_d=min(h,max(f,(1.0-((p-d)/e))*i+f));}}",dynamicpoint_fs:"#ifdef VORONOI\n#extension GL_EXT_frag_depth : enable\n#endif\nprecision mediump float;varying vec4 v_c;varying float v_d;\n#ifdef VORONOI\nconst float c=2.1;const float d=0.0085;uniform mat4 uProjectionMatrixFS;varying vec3 v_h;varying float v_e;varying float v_f;\n#endif\nconst float e=4.0;const float f=256.0*e;const float h=1.0/e;vec3 i(float j){vec3 k;j*=h;k.r=floor(j);j-=k.r;k.g=floor(j*256.0);j-=k.g*0.00390625;k.b=j*65536.0;k*=0.00390625;return k;}void main(void){float l=2.0*((gl_PointCoord.x-0.5)*(gl_PointCoord.x-0.5)+(gl_PointCoord.y-0.5)*(gl_PointCoord.y-0.5));if(l>=v_d){discard;}\n#ifdef VORONOI\nfloat r=sqrt(l);r=max(0.0,r-c/v_f);vec4 m=vec4(v_h,1.0);m.z-=d*r*v_e;m=uProjectionMatrixFS*m;float n=m.z/m.w;gl_FragDepthEXT=(n+1.0)/2.0;\n#endif\ngl_FragColor=v_c;}",fx_vs:"attribute vec2 aVertexPosition;attribute vec2 aVertexTextureCoords;varying vec2 v_i;void main(){v_i=aVertexTextureCoords;gl_Position=vec4(aVertexPosition,0.0,1.0);}",fx_fs:"precision mediump float;varying vec2 v_i;uniform sampler2D uTex0;void main(void){gl_FragColor=texture2D(uTex0,v_i);}",fxgapfiller_op2_fs:"precision mediump float;const float c=4.0;const float d=256.0*c;const float e=1.0/c;vec3 f(float h){vec3 i;h*=e;i.r=floor(h);h-=i.r;i.g=floor(h*256.0);h-=i.g*0.00390625;i.b=h*65536.0;i*=0.00390625;return i;}float j(vec3 k){return c*(256.0*k.r+k.g+0.00390625*k.b);}const int l=7;const int m=2;varying vec2 v_i;uniform vec2 uTexSize;uniform vec2 uInvTexSize;uniform vec2 uDepthToFrustumSize;uniform sampler2D uTex0;uniform sampler2D uTexDepth;uniform bool uDepthColor;uniform bool uInterpolate;const float n=0.99;bool o(vec3 p){return (p.r>n);}const float q=0.2;const float s=0.5*q;const float t=q*q;const float u=s*s;bool v(out vec2 cc,vec2 cd,float ce){const int cf=3;float ch=ce;int ci=0;for(int cj=1;cj<=l;cj++){if(ci<cf){vec2 ck=(float(cj)*cd)+v_i;vec4 p=texture2D(uTexDepth,ck);float h=j(p.rgb);if((!o(p.rgb))&&h<ch){cc=ck;ci++;ch=h-0.05;}}}return (ci!=0);}bool cl(out vec2 cc,vec2 cd,float ce){for(int cj=1;cj<=m;cj++){vec2 ck=(float(cj)*cd)+v_i;vec4 p=texture2D(uTexDepth,ck);float h=j(p.rgb);if((!o(p.rgb))&&h<ce){cc=ck;return true;}}return false;}vec3 cm(vec2 ck){vec4 cn=texture2D(uTexDepth,ck);float h=j(cn.rgb);ck.xy-=vec2(0.5,0.5);return vec3(ck.x*h*uDepthToFrustumSize.x,ck.y*h*uDepthToFrustumSize.y,h);}bool co(vec3 cp,vec3 cq){vec3 cs=cq-cp;float ct=dot(cs,cs);return ct<t;}bool cu(vec3 cp,vec3 cq){vec3 cs=cq-cp;float ct=dot(cs,cs);return ct<u;}bool cv(out vec3 dc,vec2 dd,vec2 de,vec2 df){vec2 dh=v_i.xy;vec2 r=uTexSize*(dh-df);vec2 di=uTexSize*(dd-df);vec2 dj=uTexSize*(de-df);float dk=di.x*dj.y-dj.x*di.y;if(dk<0.0001){return false;}dc[0]=(dj.y*r.x-dj.x*r.y)/dk;dc[1]=(di.x*r.y-di.y*r.x)/dk;dc[2]=1.0-dc[0]-dc[1];return (dc[0]>=0.0);}vec2 dl(vec2 dd,vec2 de){vec2 dm=uTexSize*(v_i-dd);vec2 dn=uTexSize*(v_i-de);float dp=length(dm);float dq=length(dn);return vec2(dq/(dp+dq),dp/(dp+dq));}bool ds(out vec4 dt,vec2 dd,vec2 de){vec3 du=cm(dd);vec3 dv=cm(de);if(!cu(du,dv)){return false;}else{vec4 ec=texture2D(uTex0,dd);vec4 ed=texture2D(uTex0,de);vec2 dc=dl(dd,de);if(uDepthColor){float ee=dc[0]*du.z+dc[1]*dv.z;dt=vec4(f(ee),1.0);}else if(!uInterpolate){dt=(dc[0]>dc[1])?ec:ed;}else{dt=dc[0]*ec+dc[1]*ed;}return true;}}void ef(out vec4 dt,vec2 dd,vec2 de){vec3 du=cm(dd);vec3 dv=cm(de);vec4 ec=texture2D(uTex0,dd);vec4 ed=texture2D(uTex0,de);if(!cu(du,dv)){bool eh=du.z>dv.z;if(uDepthColor){dt=vec4(f(eh?du.z:dv.z),1.0);}else{dt=eh?ec:ed;}}else{vec2 dc=dl(dd,de);if(uDepthColor){float ee=dc[0]*du.z+dc[1]*dv.z;dt=vec4(f(ee),1.0);}else if(!uInterpolate){dt=(dc[0]>dc[1])?ec:ed;}else{dt=dc[0]*ec+dc[1]*ed;}}}bool ei(out vec4 dt,vec2 dd,vec2 de,vec2 df){vec3 du=cm(dd);vec3 dv=cm(de);if(!co(du,dv)){return false;}vec3 ej=cm(df);if(!co(du,ej)){return false;}if(!co(dv,ej)){return false;}vec4 ec=texture2D(uTex0,dd);vec4 ed=texture2D(uTex0,de);vec4 ek=texture2D(uTex0,df);vec3 dc;if(!cv(dc,dd,de,df)){return false;}if(uDepthColor){float ee=dc[0]*du.z+dc[1]*dv.z+dc[2]*ej.z;dt=vec4(f(ee),1.0);}else{if(!uInterpolate){dt=(dc[0]>max(dc[1],dc[2]))?ec:((dc[1]>dc[2])?ed:ek);}else{dt=dc[0]*ec+dc[1]*ed+dc[2]*ek;}}return true;}void main(void){vec4 el=texture2D(uTexDepth,v_i);float h=j(el.rgb);float em=h-0.05;vec4 en;float eo=uInvTexSize.x;float ep=uInvTexSize.y;vec2 eq,es,et,eu,ev,fc,fd,fe;bool ff,fh,fi,fj,fk,fl,fm,fn;ff=v(eq,vec2(0,-ep),em);fh=v(es,vec2(eo,-ep),em);fi=v(et,vec2(eo,0),em);fj=v(eu,vec2(eo,ep),em);fk=v(ev,vec2(0,ep),em);fl=v(fc,vec2(-eo,ep),em);fm=v(fd,vec2(-eo,0),em);fn=v(fe,vec2(-eo,-ep),em);bool ci=false;if(ff&&fj&&fl){ci=ei(en,eq,eu,fc);}if(!ci&&fh&&fk&&fm){ci=ei(en,es,ev,fd);}if(!ci&&fi&&fl&&fn){ci=ei(en,et,fc,fe);}if(!ci&&fj&&fm&&ff){ci=ei(en,eu,fd,eq);}if(!ci&&ff&&fk){ci=ds(en,eq,ev);}if(!ci&&fh&&fl){ci=ds(en,es,fc);}if(!ci&&fi&&fm){ci=ds(en,et,fd);}if(!ci&&fj&&fn){ci=ds(en,eu,fe);}if(!ci){ff=cl(eq,vec2(0,-ep),em);fi=cl(et,vec2(eo,0),em);fk=cl(ev,vec2(0,ep),em);fm=cl(fd,vec2(-eo,0),em);if(ff&&fk){ef(en,eq,ev);ci=true;}else if(fi&&fm){ef(en,et,fd);ci=true;}}if(!ci){if(uDepthColor){en=el;}else{en=texture2D(uTex0,v_i);}}gl_FragColor=en;}",fxgapfiller_scene_fs:"precision mediump float;const float c=4.0;const float d=256.0*c;const float e=1.0/c;vec3 f(float h){vec3 i;h*=e;i.r=floor(h);h-=i.r;i.g=floor(h*256.0);h-=i.g*0.00390625;i.b=h*65536.0;i*=0.00390625;return i;}float j(vec3 k){return c*(256.0*k.r+k.g+0.00390625*k.b);}varying vec2 v_i;uniform vec2 uPixOffset;uniform vec2 uTexSize;uniform vec2 uDepthToFrustumSize;uniform sampler2D uTex0;uniform sampler2D uTexDepth;uniform bool uDepthColor;uniform bool uInterpolate;const float l=0.07;const int m=9;const float n=float(m);const float o=0.99*d;float p(float h){float q=h*uDepthToFrustumSize.y;float s=l*uTexSize.y/q;return max(2.0,s+1.0);}float t(float u){return 1.0/(u*u);}void main(void){vec2 v=v_i+uPixOffset;vec2 cc=v_i-uPixOffset;vec4 cd=texture2D(uTexDepth,v_i);float h=j(cd.rgb);vec4 k=uDepthColor?cd:texture2D(uTex0,v_i);vec2 ce;float cf;float ch;vec4 ci;bool cj=false;float u=0.0;float ck=n;for(int cl=0;cl<m;cl++){if(!cj){u=u+1.0;ce=v_i+uPixOffset*u;cd=texture2D(uTexDepth,ce);cf=j(cd.rgb);if(cf<o&&cf<h){ci=texture2D(uTex0,ce);ch=t(u);cj=true;}}}if(cj){ck=p(cf);if(u>ck){cj=false;}}if(!cj){cd=texture2D(uTexDepth,v);cf=j(cd.rgb);ci=texture2D(uTex0,v);ch=t(u);}if(cf<o&&cf<h){float cm;float cn;vec4 co;vec2 cp;cj=false;u=0.0;for(int cl=0;cl<m;cl++){if(!cj){u=u+1.0;cp=v_i-uPixOffset*u;cd=texture2D(uTexDepth,cp);cm=j(cd.rgb);if(cm<o&&cm<h){co=texture2D(uTex0,cp);cn=t(u);cj=true;}}}if(cj){ck=p(cm);if(u>ck){cj=false;}}if(!cj){cd=texture2D(uTexDepth,cc);cm=j(cd.rgb);co=texture2D(uTex0,cc);cn=t(u);}if(cm<o&&cm<h){if((h-cf)>0.025){if(abs(cf-cm)<0.1){float cq=cn+ch;if(uDepthColor){h=(cf*ch+cm*cn)/cq;k=vec4(f(h),1.0);}else if(!uInterpolate){k=(ch>cn)?ci:co;}else{k=(ci*ch+co*cn)/cq;}}else{if(cm>cf){if(uDepthColor){k=vec4(f(cm),1.0);}else{k=co;}}else{if(uDepthColor){k=vec4(f(cf),1.0);}else{k=ci;}}}}}}gl_FragColor=k;}",line_vs:"attribute vec3 aVertexPosition;uniform mat4 uModelMatrix;uniform mat4 uViewProjectionMatrix;attribute vec4 aColor;varying vec4 v_c;attribute float aDist;varying float v_j;void main(){v_j=aDist;gl_Position=uViewProjectionMatrix*uModelMatrix*vec4(aVertexPosition,1.0);v_c=aColor;}",line_fs:"precision mediump float;varying vec4 v_c;varying float v_j;uniform float uDashLength;uniform vec4 uDashColor;\n#ifndef FAILSAFE\nconst float c=4.0;const float d=256.0*c;float e(vec3 f){return c*(256.0*f.r+f.g+0.00390625*f.b);}uniform bool uDepthTest;uniform float uInvViewX;uniform float uInvViewY;uniform sampler2D uTexDepth;const float h=0.001;bool i(vec4 j,vec3 k){float l=e(k);float m=j.z/j.w;return (m<l+h);}\n#endif\nvoid main(void){\n#ifndef FAILSAFE\nif(uDepthTest){bool n=false;vec4 o=gl_FragCoord;for(int y=-1;y<=1;y++){for(int x=-1;x<=1;x++){if(!n&&(x==0||y==0)){o.x=gl_FragCoord.x+float(x);o.y=gl_FragCoord.y+float(y);vec2 p=vec2(o.x*uInvViewX,o.y*uInvViewY);vec4 k=texture2D(uTexDepth,p);if(i(o,k.rgb)){n=true;}}}}if(!n){discard;}}\n#endif\nif(mod(v_j,2.0*uDashLength)>uDashLength){gl_FragColor=uDashColor;}else{gl_FragColor=v_c;}}",pano_vs:"attribute vec2 aVertexPosition;void main(){gl_Position=vec4(aVertexPosition.x,aVertexPosition.y,0.0,1.0);}",pano_fs:"precision mediump float;const float c=3.141592654;uniform vec2 uViewport;uniform mat4 uProjMatrix;uniform sampler2D uTex0;uniform sampler2D uTex1;uniform float uBlendFactor0;uniform float uBlendFactor1;uniform bool uCircleVisible;void main(void){vec3 d=vec3(gl_FragCoord.x,gl_FragCoord.y,0.0);vec4 e;e.x=d.x*2.0/uViewport.x-1.0;e.y=d.y*2.0/uViewport.y-1.0;e.z=-1.0;e.w=1.0;e=uProjMatrix*e;e.x=e.x/e.w;e.y=e.y/e.w;e.z=-e.z/e.w;float f=-atan(e.z,sqrt(e.x*e.x+e.y*e.y));if(uCircleVisible&&f<-1.0908307824980232){discard;}float h=atan(e.y,e.x);float i=mod(h/(2.0*c)+1.0,1.0);float j=f/c+0.5;gl_FragColor=uBlendFactor0*texture2D(uTex0,vec2(1.0-i,j))+uBlendFactor1*texture2D(uTex1,vec2(1.0-i,j));}",point_vs:"attribute vec3 aVertexPosition;uniform mat4 uModelMatrix;uniform mat4 uViewProjectionMatrix;uniform float uPointSize;attribute vec4 aColor;varying vec4 v_c;void main(){gl_PointSize=uPointSize;gl_Position=uViewProjectionMatrix*uModelMatrix*vec4(aVertexPosition,1.0);v_c=aColor;}",point_fs:"precision mediump float;varying vec4 v_c;uniform bool uQuadPoint;\n#ifndef FAILSAFE\nconst float c=4.0;const float d=256.0*c;float e(vec3 f){return c*(256.0*f.r+f.g+0.00390625*f.b);}uniform bool uDepthTest;uniform float uInvViewX;uniform float uInvViewY;uniform sampler2D uTexDepth;const float h=0.001;bool i(vec4 j,vec3 k){float l=e(k);float m=j.z/j.w;return (m<l+h);}\n#endif\nvoid main(void){bool n=false;if((!uQuadPoint&&(gl_PointCoord.x-0.5)*(gl_PointCoord.x-0.5)+(gl_PointCoord.y-0.5)*(gl_PointCoord.y-0.5)>=0.25)){n=true;}else{\n#ifndef FAILSAFE\nif(uDepthTest){vec2 o=vec2(gl_FragCoord.x*uInvViewX,gl_FragCoord.y*uInvViewY);vec4 k=texture2D(uTexDepth,o);if(!i(gl_FragCoord,k.rgb)){n=true;}}\n#endif\n}if(n){discard;}gl_FragColor=v_c;}",skybox_fs:"precision mediump float;const float c=3.141592654;uniform vec2 uViewport;uniform mat4 uProjMatrix;uniform sampler2D uTex;uniform float uAlpha;void main(void){vec3 d=vec3(gl_FragCoord.x,gl_FragCoord.y,0.0);vec4 e;e.x=d.x*2.0/uViewport.x-1.0;e.y=d.y*2.0/uViewport.y-1.0;e.z=-1.0;e.w=1.0;e=uProjMatrix*e;e.x=e.x/e.w;e.y=e.y/e.w;e.z=-e.z/e.w;float f=-atan(e.z,sqrt(e.x*e.x+e.y*e.y));float h=atan(e.y,e.x);float i=mod(h/(2.0*c)+1.0,1.0);float j=f/c+0.5;gl_FragColor=uAlpha*texture2D(uTex,vec2(1.0-i,j));}",sprite_vs:"attribute vec2 aVertexPosition;attribute vec2 aVertexTextureCoords;uniform mat4 uModelMatrix;uniform mat4 uViewMatrix;uniform mat4 uInverseViewMatrix;uniform mat4 uProjectionMatrix;uniform vec2 uSpriteSize;uniform bool uScaleByDepth;uniform vec2 uViewPort;varying vec2 v_i;void main(){if(uScaleByDepth){vec4 c=uInverseViewMatrix[1];c=normalize(c);vec4 d=uInverseViewMatrix[0];d=normalize(d);vec4 e=aVertexPosition.x*uSpriteSize.x*d+aVertexPosition.y*uSpriteSize.y*c;vec4 f=uModelMatrix*vec4(0.0,0.0,0.0,1.0)+e;vec4 h=uProjectionMatrix*uViewMatrix*f;float w=abs(h.w);if(h.z>-w&&h.z<w){h.x=h.x/h.w;h.y=h.y/h.w;gl_Position=vec4(h.x,h.y,0,1);}else{gl_Position=vec4(0,0,0,0);}}else{vec4 h=uProjectionMatrix*uViewMatrix*uModelMatrix*vec4(0.0,0.0,0.0,1.0);float w=abs(h.w);if(h.z>-w&&h.z<w){h.x=h.x/h.w;h.y=h.y/h.w;gl_Position=vec4(h.x+uSpriteSize.x/uViewPort.x*aVertexPosition.x,h.y+uSpriteSize.y/uViewPort.y*aVertexPosition.y,0,1);}else{gl_Position=vec4(0,0,0,0);}}v_i=aVertexTextureCoords;}",sprite_fs:"precision mediump float;uniform sampler2D uTex0;varying vec2 v_i;void main(void){gl_FragColor=texture2D(uTex0,v_i);}",texture_vs:"attribute vec3 aVertexPosition;uniform mat4 uModelMatrix;uniform mat4 uViewProjectionMatrix;attribute vec2 aVertexTextureCoords;varying vec2 v_i;void main(){gl_Position=uViewProjectionMatrix*uModelMatrix*vec4(aVertexPosition,1.0);v_i=aVertexTextureCoords;}",texture_fs:"precision mediump float;varying vec2 v_i;uniform sampler2D uTex0;uniform float uAlpha;\n#ifndef FAILSAFE\nconst float c=4.0;const float d=256.0*c;float e(vec3 f){return c*(256.0*f.r+f.g+0.00390625*f.b);}uniform bool uDepthTest;uniform float uInvViewX;uniform float uInvViewY;uniform sampler2D uTexDepth;const float h=0.001;bool i(vec4 j,vec3 k){float l=e(k);float m=j.z/j.w;return (m<l+h);}\n#endif\nvoid main(void){\n#ifndef FAILSAFE\nif(uDepthTest){vec2 n=vec2(gl_FragCoord.x*uInvViewX,gl_FragCoord.y*uInvViewY);vec4 k=texture2D(uTexDepth,n);if(!i(gl_FragCoord,k.rgb)){discard;}}\n#endif\nvec4 o=texture2D(uTex0,v_i);gl_FragColor=vec4(o.rgb,o.a*uAlpha);}"},WS.BasicShaderDesc=function(e,t){this._vertexShader=e,this._fragmentShader=t},WS.BasicShaderDesc.prototype={getDefines:function(){return[]}},WS.extend("BasicShaderDesc"),WS.BasicShaderDesc.ID=void 0,WS.BasicShaderDesc.EXT_DEPTH_RANGE=4,WS.PointShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.point_vs,WS.shaderSrc.point_fs)},WS.extend("PointShaderDesc","BasicShaderDesc"),WS.PointShaderDesc.ID="PointShader",WS.DynamicPointShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.dynamicpoint_vs,WS.shaderSrc.dynamicpoint_fs)},WS.extend("DynamicPointShaderDesc","BasicShaderDesc"),WS.DynamicPointShaderDesc.ID="DynamicPointShader",WS.VoronoiPointShaderDesc=function(){},WS.VoronoiPointShaderDesc.prototype={getDefines:function(e){{var t=WS.DynamicPointShaderDesc.prototype.getDefines.call(this,e);F.getGLExtension(e,"EXT_frag_depth")}return t.concat(["#define VORONOI"])}},WS.extend("VoronoiPointShaderDesc","DynamicPointShaderDesc"),WS.VoronoiPointShaderDesc.ID="VoronoiPointShader",WS.PointMaterial=function(e,t,i){WS.ShaderMaterial.call(this,WS.PointShaderDesc,!0,!0,!1,void 0,void 0,e),this._rgbDepthTestSupport=!0,this._pointSize=void 0!==t?t:1,this._quadPoint=void 0!==i?i:!1},WS.PointMaterial.prototype={configureShader:function(e){var t=e._geometry,i=e.getShaderProgram(this);return i.setAttributeValue("aVertexPosition",e.getGlBuffer(t._positionBuffer)),i.setUniformValue("uModelMatrix",e.getModelMatrix()),i.setUniformValue("uViewProjectionMatrix",e._camera._camMatrix),i.setUniformValue("uPointSize",this._pointSize),i.setAttributeValue("aColor",e.getGlBuffer(this._colorBuffer)),i.setUniformValue("uQuadPoint",this._quadPoint),!0},configureRenderer2d:function(e){return e.setPointSize(this._pointSize),!0}},WS.extend("PointMaterial","ShaderMaterial"),WS.DynamicPointMaterial=function(e,t,i,n,o){WS.ShaderMaterial.call(this,o?WS.VoronoiPointShaderDesc:WS.DynamicPointShaderDesc,!0,!0,!0,void 0,void 0,e),this._dynamicPointSize=n,this._pointSize=t,this._quadPoint=i,this._alpha=1,this._useFixedColor=!1,this._fixedColor=WS.DynamicPointMaterial.BLACK,this._mvMatrix=void 0},WS.DynamicPointMaterial.prototype={configureShader:function(e){var t,i=e._camera,n=e.getShaderProgram(this),o=this._colorBuffer,r=this._fixedColor;switch(e._renderColorMode){case WS.RendererBase.RenderMode.DEPTH:t=2;break;case WS.RendererBase.RenderMode.PICK_3D:case WS.RendererBase.RenderMode.NODE:t=1,r=this._pickColor;break;case WS.RendererBase.RenderMode.PICK_3D_POINT:t=0,o=e._pickColorBuffer;break;default:t=this._useFixedColor?1:0}n.setAttributeValue("aVertexPosition",e.getGlBuffer(e._geometry._positionBuffer,!0)),n.setAttributeValue("aColor",e.getGlBuffer(o,!0)),o===this._colorBuffer&&o._bufferData&&(o._bufferData=void 0),n.setUniformValue("uColorMode",t),n.setUniformValue("uFixedColor",r);var a=this._mvMatrix;a||(a=mat4.multiply(i._transform,e.getModelMatrix(),mat4.create())),n.setUniformValue("uModelViewMatrix",a),n.setUniformValue("uProjectionMatrix",i._projMatrix),this._shaderProgramDesc===WS.VoronoiPointShaderDesc&&n.setUniformValue("uProjectionMatrixFS",i._projMatrix),n.setUniformValue("uAlpha",this._alpha),n.setUniformValue("uColor8Bit",!0),n.setUniformValue("uQuadPoint",this._quadPoint);var s=0,c=0,l=0;if(this._dynamicPointSize){var h=e._camera._fovY*Math.PI/180;s=this._pointSize.physical*e._canvasHeight/(2*Math.tan(h/2)),c=this._pointSize.minPixel,l=this._pointSize.maxPixel}else c=this._pointSize;return n.setUniformValue("uDynamicPointSize",this._dynamicPointSize),n.setUniformValue("uPointSizeFactor",s),n.setUniformValue("uMinPointSize",c),n.setUniformValue("uMaxPointSize",l),!0},configureRenderer2d:function(){}},WS.extend("DynamicPointMaterial","ShaderMaterial"),WS.DynamicPointMaterial.BLACK=[0,0,0,0],WS.PointRenderable=function(e,t,i,n){n=n||new WS.PointMaterial(t,i);var o=new WS.Geometry;o._primitiveType=WS.Geometry.PrimitiveType.Points,o._positionBuffer=e,WS.Mesh.call(this,o,n)},WS.PointRenderable.prototype={setPointPositions:function(e){this._geometry._positionBuffer.setBufferData(e)},setColors:function(e){this._material._colorBuffer.setBufferData(e)},setPointSize:function(e){this._material._pointSize=e}},WS.extend("PointRenderable","Mesh"),WS.DynamicPointRenderable=function(e,t,i,n,o,r){var a="object"==typeof i;n=n||!1,o=o||!1,r&&(this._shortID=r),WS.PointRenderable.call(this,e,void 0,void 0,new WS.DynamicPointMaterial(t,i,n,a,o))},WS.DynamicPointRenderable.prototype={draw2d:function(){},setPointSize:function(e){this._material._dynamicPointSize="object"==typeof e,this._material._pointSize=e},enableVoronoi:function(e){this._material._shaderProgramDesc=e?WS.VoronoiPointShaderDesc:WS.DynamicPointShaderDesc},setAlpha:function(e){this._material._alpha=e},getAlpha:function(){return this._material._alpha}},WS.extend("DynamicPointRenderable","PointRenderable"),WS.LineShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.line_vs,WS.shaderSrc.line_fs)},WS.extend("LineShaderDesc","BasicShaderDesc"),WS.LineShaderDesc.ID="LineShader",WS.LineMaterial=function(e,t,i,n,o){WS.ShaderMaterial.call(this,WS.LineShaderDesc,!0,!0,!1,void 0,void 0,e),this._rgbDepthTestSupport=!0,this._dashLine=void 0!==t?t:WS.LineMaterial.Dash.None,this._dashLineColor=void 0!==i?i:[0,0,0,1],this._dashLength=void 0!==n?n:1,this._lineWidth=void 0!==o?o:1},WS.LineMaterial.prototype={configureShader:function(e){var t=e?e._camera:void 0;if(t){var i=e._geometry,n=e.getShaderProgram(this),o=e.getModelMatrix(),r=t._camMatrix;e.setLineWidth(this._lineWidth),n.setAttributeValue("aVertexPosition",e.getGlBuffer(i._positionBuffer)),n.setUniformValue("uModelMatrix",o),n.setUniformValue("uViewProjectionMatrix",r),n.setAttributeValue("aColor",e.getGlBuffer(this._colorBuffer));var a=this._dashLine?e.getGlBuffer(i._distanceBuffer):0;return n.setAttributeValue("aDist",a),n.setUniformValue("uDashLength",this._dashLength),n.setUniformValue("uDashColor",this._dashLineColor),!0}},configureRenderer2d:function(e){return e.setLineWidth(this._lineWidth),!0}},WS.extend("LineMaterial","ShaderMaterial"),WS.LineMaterial.Dash={None:0,Fixed:1,Adaptive:2},WS.GeometryProjector={},WS.GeometryProjector.projectLineGeometry=function(e,t,i,n,o){var r=[],a=new MatrixArray(4);a[3]=1;var s=new MatrixArray(4);s[3]=1;for(var c,l,h,d=0,u=t.getCountPositions();u-1>d;){if(h=t.getPosition(d,a),h=t.getPosition(d+1,s),h>2){i&&(mat4.multiplyVec3(i,a),mat4.multiplyVec3(i,s)),a[3]=1,s[3]=1,c=new MatrixArray(4),l=new MatrixArray(4);var p=e.projectLine(a,s,c,l,n,o);p||(c=void 0,l=void 0)}else c=[a[0],a[1]],l=[s[0],s[1]];r.push(c),(t._primitiveType===WS.Geometry.PrimitiveType.Lines||d===u-2)&&r.push(l),t._primitiveType===WS.Geometry.PrimitiveType.LineStrip?d++:d+=2}return r},WS.GeometryProjector.projectPoints=function(e,t,i,n,o,r){for(var a=[],s=0,c=t.getCountPositions();c>s;s++){var l=new MatrixArray(4);l[3]=1,t.getPosition(s,l),i&&mat4.multiplyVec3(i,l);var h=e.projectPoint(l,l,r,n,o);h||(l=void 0),a.push(l)}return a},WS.GeometryProjector.projectPointGeometry=function(e,t,i,n,o){return WS.GeometryProjector.projectPoints(e,t,i,n,o,!1)},WS.GeometryProjector.projectTriangleStripGeometry=function(e,t,i,n,o){return WS.GeometryProjector.projectPoints(e,t,i,n,o,!0)},WS.GeometryProjector.projectTriangleGeometry=function(e,t,i,n,o,r){if(t._indexBuffer)return WS.GeometryProjector.projectPoints(e,t,i,n,o,!0);for(var a=[],s=t.getCountPositions(),c=0;s>c;c+=3){for(var l=[],h=!0,d=0;3>d;d++){var u=new MatrixArray(5);if(u[3]=1,t.getPosition(c+d,u),i&&mat4.multiplyVec3(i,u),h=e.projectPoint(u,u,!0,n,o,!1),!h)break;l.push(u)}h=h&&vec2.isTriangleVisible(l[0],l[1],l[2],n,o)&&!WS.GeometryProjector.isCulled(l[0],l[1],l[2],r),h?(a.push(l[0]),a.push(l[1]),a.push(l[2])):(a.push(void 0),a.push(void 0),a.push(void 0))}return a},WS.GeometryProjector.projectPolyCircuitGeometry=function(e,t,i,n,o){for(var r=0,a=0,s=0,c=0,l=[],h=t.getCountPositions(),d=0;h>d;++d){var u=new MatrixArray(4);u[3]=1,t.getPosition(d,u),i&&mat4.multiplyVec3(i,u);{e.projectPoint(u,u,!1,n,o,!0)}u[0]<0&&c++,n<=u[0]&&a++,u[1]<0&&r++,o<=u[1]&&s++,l.push(u)}return r===h||a===h||s===h||c===h?[]:l},WS.GeometryProjector.projectGeometry=function(e,t,i,n,o,r){switch(t._primitiveType){case WS.Geometry.PrimitiveType.Points:return WS.GeometryProjector.projectPointGeometry(e,t,i,n,o);case WS.Geometry.PrimitiveType.Lines:case WS.Geometry.PrimitiveType.LineStrip:return WS.GeometryProjector.projectLineGeometry(e,t,i,n,o);case WS.Geometry.PrimitiveType.Triangles:return WS.GeometryProjector.projectTriangleGeometry(e,t,i,n,o,r);case WS.Geometry.PrimitiveType.TriangleStrip:return WS.GeometryProjector.projectTriangleStripGeometry(e,t,i,n,o);case WS.Geometry.PrimitiveType.PolyCircuit:return WS.GeometryProjector.projectPolyCircuitGeometry(e,t,i,n,o)}},WS.GeometryProjector.isCulled=function(e,t,i,n){if(n===WS.Material.Cull.OFF)return!1;var o=vec2.subtract(t,e,vec2.create()),r=vec2.subtract(i,e,vec2.create()),a=vec2.cross(o,r),s=0>a;return s?n===WS.Material.Cull.BACK:n===WS.Material.Cull.FRONT},WS.LineGeometry=function(e,t){WS.Geometry.call(this),this._positionBuffer=e,this._positionItemSize=3,this._primitiveType=t?WS.Geometry.PrimitiveType.LineStrip:WS.Geometry.PrimitiveType.Lines,this._distanceBuffer=new WS.ArrayBuffer([],1),this._positionBuffer.addListener(this)},WS.LineGeometry.prototype={onDataChange:function(){this.updateDistances()},updateDistances:function(){var e,t=this.getCountPositions(),i=vec3.create(),n=vec3.create(),o=[];if(this._primitiveType===WS.Geometry.PrimitiveType.Lines)for(e=1;t>e;e+=2)this.getPosition(e,i),this.getPosition(e-1,n),o[e-1]=0,o[e]=vec3.dist(i,n);else for(o[0]=0,e=1;t>e;e++)this.getPosition(e,i),this.getPosition(e-1,n),o[e]=o[e-1]+vec3.dist(i,n);this._distanceBuffer.setBufferData(o)},getDistance:function(e){var t=[0];return this._distanceBuffer.getItem(e,t),t[0]}},WS.extend("LineGeometry","Geometry"),WS.LinesGeometry=function(e){WS.LineGeometry.call(this,e,!1)},WS.extend("LinesGeometry","LineGeometry"),WS.LinestripGeometry=function(e){WS.LineGeometry.call(this,e,!1)},WS.extend("LinestripGeometry","LineGeometry"),WS.LineRenderable=function(e,t,i,n,o,r,a){var s=new WS.LineGeometry(e,r);this._dashLength=o,WS.Mesh.call(this,s,new WS.LineMaterial(t,i,n,1,a)),this.updateDashedLine(),this._geometry._distanceBuffer.addListener(this),this._material._colorBuffer.addListener(this)},WS.LineRenderable.prototype={onDataChange:function(){this.updateDashedLine()},setEndPointPositions:function(e){this._geometry._positionBuffer.setBufferData(e)},setColors:function(e){this._material._colorBuffer.setBufferData(e)},setDashLength:function(e){this._dashLength=e,this.updateDashedLine()},getCurrentDashLength:function(){return this.isDashed()?this._material._dashLength:void 0},isDashed:function(){return this._material._dashLine!==WS.LineMaterial.Dash.None},getPickInfo:function(e,t,i,n){var o,r,a,s,c=0,l=this._geometry,h=WS.GeometryProjector.projectGeometry(e,this._geometry,t),d=l._primitiveType==WS.Geometry.PrimitiveType.Lines?2:1;for(c=0,a=h.length-1;a>c;c+=d)if(o=h[c],r=h[c+1],o&&r&&(s=vec2.distToLine(o,r,[i,e._height-n]),s<WS.LineRenderable.pickEpsilon))return new WS.PickInfo(this);return void 0},getRegionPickInfo:function(e,t,i){var n=WS.GeometryProjector.projectGeometry(e,this._geometry,t),o=n.length;if(0===o)return void 0;for(var r=0;o>r;r++){var a=n[r];if(!a||!i.containsPt(a[0],e._height-a[1]))return void 0}return new WS.PickInfo(this)},draw2d:function(e,t,i){(i||t(this))&&(this._geometry.getCountPositions()<2||WS.Mesh.prototype.draw2d.call(this.isDashed()?this._dashedLineRenderable:this,e,t,!0))},draw3d:function(e,t,i){(i||t(this))&&(this._geometry.getCountPositions()<2||WS.Mesh.prototype.draw3d.call(this,e,t,!0))},calcAdaptiveDashLength:function(e){for(var t=WS.LineRenderable.adaptiveDashLengthFactors[0],i=WS.LineRenderable.adaptiveDashLengthFactors[1],n=[i,t],o=[1/t,1/i],r=WS.LineRenderable.maxNumOfAdaptiveDashes,a=WS.LineRenderable.maxNumOfAdaptiveDashes/i,s=this._dashLength,c=0;a>e/s;)s*=o[c++%2];if(0===c)for(;e/s>r;)s*=n[c++%2];return s},updateDashedLine:function(){if(this.isDashed()){var e,t,i,n,o=this._geometry,r=this._material,a=[],s=[],c=o.getCountPositions()-1,l=o._primitiveType===WS.Geometry.PrimitiveType.Lines?2:1,h=new MatrixArray(4),d=new MatrixArray(4);if(r._dashLine===WS.LineMaterial.Dash.Fixed)n=this._dashLength;else{for(var u=0,p=0;c>p;p+=l)e=o.getDistance(p),t=o.getDistance(p+1),u=Math.max(u,t-e);n=u>0?this.calcAdaptiveDashLength(u):1}r._dashLength=n;for(var _,g,f,m,v=vec3.create(),S=vec3.create(),b=new MatrixArray(4),y=r._dashLineColor,P=!1,C=0;c>C;C+=l){for(o.getPosition(C,h),o.getPosition(C+1,d),r.getColor(C,b),e=o.getDistance(C),t=o.getDistance(C+1),i=t-e,vec3.subtract(d,h,v),_=n/i,a.push(h[0],h[1],h[2]),s.push(b[0],b[1],b[2],b[3]),P=!1,g=_;1>=g;g+=_)vec3.scale(v,g,S),vec3.add(h,S,S),a.push(S[0],S[1],S[2]),a.push(S[0],S[1],S[2]),f=P?y:b,m=P?b:y,s.push(f[0],f[1],f[2],f[3]),s.push(m[0],m[1],m[2],m[3]),P=!P;if(a.length%2!==0){a.push(d[0],d[1],d[2]);var w=s.length-4;s.push(s[w],s[w+1],s[w+2],s[w+3])}}this._dashedLineRenderable?(this._dashedLineRenderable.setEndPointPositions(a),this._dashedLineRenderable.setColors(s)):(this._dashedLineRenderable=new WS.LinesRenderable(new WS.ArrayBuffer(a,3),new WS.ArrayBuffer(s,4),WS.LineMaterial.Dash.None),this._dashedLineRenderable.addToLayer(this._layerId,!0))}},getMemberRenderables:function(){return this._dashedLineRenderable?[this._dashedLineRenderable]:[]}},WS.extend("LineRenderable","Mesh"),WS.LineRenderable.pickEpsilon=5,WS.LineRenderable.dashColor=[0,0,0,0],WS.LineRenderable.adaptiveDashLengthFactors=[2,5],WS.LineRenderable.maxNumOfAdaptiveDashes=25,WS.LinesRenderable=function(e,t,i,n,o,r){WS.LineRenderable.call(this,e,t,i,n,o,!1,r)},WS.extend("LinesRenderable","LineRenderable"),WS.LinestripRenderable=function(e,t,i,n,o,r){WS.LineRenderable.call(this,e,t,i,n,o,!0,r)},WS.extend("LinestripRenderable","LineRenderable"),WS.DottedLinesRenderable=function(e,t,i,n,o,r,a,s,c,l){this._pointPositionBuffer=void 0!==e?e:new WS.ArrayBuffer([],3),this._colorBufferPointsSmall=void 0!==t?t:WS.DottedLinesRenderable.colorPointSmall,this._colorBufferPointsLarge=void 0!==i?i:WS.DottedLinesRenderable.colorPointLarge,this._colorBufferLines=void 0!==n?n:WS.DottedLinesRenderable.colorLine;var h=void 0!==o?o:WS.LineMaterial.Dash.None,d=void 0!==r?r:WS.DottedLinesRenderable.sizePointSmall,u=void 0!==a?a:WS.DottedLinesRenderable.sizePointLarge;
this._lineRenderable=new WS.LinesRenderable(this._pointPositionBuffer,this._colorBufferLines,h,s,c,l),this._pointLargeRenderable=new WS.PointRenderable(this._pointPositionBuffer,this._colorBufferPointsLarge,u),this._pointSmallRenderable=new WS.PointRenderable(this._pointPositionBuffer,this._colorBufferPointsSmall,d)},WS.DottedLinesRenderable.prototype={setTransparency:function(e){this._colorBufferPointsSmall.setComponentOfAllItems(3,e),this._colorBufferPointsLarge.setComponentOfAllItems(3,e),this._colorBufferLines.setComponentOfAllItems(3,e)},enableDepthTest:function(e){this._lineRenderable._material._depthTest=e,this._pointLargeRenderable._material._depthTest=e,this._pointSmallRenderable._material._depthTest=e},setPointSizes:function(e,t){this._pointLargeRenderable.setPointSize(t),this._pointSmallRenderable.setPointSize(e)},setPoints:function(e){this._pointPositionBuffer.setBufferData(e)},setCornerPointsFrom2dArray:function(e){for(var t=[],i=0,n=e.length;n>i;i++)t.push.apply(t,e[i]),(0!==i&&i!==n-1||1===n)&&t.push.apply(t,e[i]);this.setPoints(t)},setColorPointsSmall:function(e){this._colorBufferPointsSmall.setBufferData(e)},setColorPointsLarge:function(e){this._colorBufferPointsLarge.setBufferData(e)},setColorLines:function(e){this._colorBufferLines.setBufferData(e)},setDashLength:function(e){this._lineRenderable.setDashLength(e)},getCurrentDashLength:function(){return this._lineRenderable.getCurrentDashLength()},addPoint:function(e){if(e){var t=this._pointPositionBuffer.getCountItems()-1;if(t>0){var i=vec3.create();this._pointPositionBuffer.getItem(t,i),this._pointPositionBuffer.addItem(i)}this._pointPositionBuffer.addItem(e)}},draw3d:function(e,t,i){(i||t(this))&&this.drawMemberRenderables3d(e,t,!0)},draw2d:function(e,t,i){(i||t(this))&&this.drawMemberRenderables2d(e,t,!0)},getPickInfo:function(e,t,i,n){return this._lineRenderable.getPickInfo(e,t,i,n)},getRegionPickInfo:function(e,t,i){return this._lineRenderable.getRegionPickInfo(e,t,i)},getMemberRenderables:function(){return[this._lineRenderable,this._pointLargeRenderable,this._pointSmallRenderable]}},WS.extend("DottedLinesRenderable","Renderable"),WS.DottedLinesRenderable.sizePointSmall=4,WS.DottedLinesRenderable.sizePointLarge=6,WS.DottedLinesRenderable.colorPointSmall=new WS.ArrayBuffer([0,0,0,1],4),WS.DottedLinesRenderable.colorPointLarge=new WS.ArrayBuffer([1,.7,.078,1],4),WS.DottedLinesRenderable.colorLine=new WS.ArrayBuffer([1,.7,.078,1],4),WS.BaseHandler=function(e,t){this._camera=e,this._view=t,this._dblClickHappened=!1},WS.BaseHandler.prototype={activate:function(){},deactivate:function(){},pickPoint:function(e,t,i){if(this._view.instanceOf(WS.MapLeaflet)){var n=this._view.containerPointToXYZ(e,t);return[0,0,n,!1]}var o,r,a,s=this._view.isRootCloud();if(s){if(o=this._view.pick3d(e,this._camera._height-t,!1,!0,i),!o)return void 0;r=0,a=0}else{var c=new WS.PerspectiveCamera;c.copyFrom(this._camera);var l=this._view.getGlobalTrafoOfRoot(),h=mat4.inverse(l,mat4.create()),d=c.getGlobalTrafo(this._view._trafoView),u=mat4.multiply(h,d,mat4.create());c.setFromGlobalTrafo(u,mat4.identity());var p=c.unprojectPoint([e,c._height-t,.99]);o=mat4.multiplyVec3(l,p);var _=c.getAnglesForScreenCoordinates(e,c._height-t);r=_[0],a=_[1]}return[r,a,o,s]}},WS.extend("BaseHandler","Observable"),WS.MoveHandler=function(e,t,i){WS.BaseHandler.call(this,e,t),this._settingService=i},WS.MoveHandler.prototype={startMove:function(){this._view._isMoving++,this._view.hideRadialMenu()},endMove:function(){this._view._isMoving=0<this._view._isMoving?this._view._isMoving-1:0,0===this._view._isMoving&&this._view.triggerCameraChange()},onDragStart:function(){return this.startMove(),!0},onDragStop:function(){return this.endMove(),!0},onScroll:function(e,t){return this._camera.changeFOVY(e,t?3:1),this._view.hideRadialMenu(),!0},determineRotationDeltas:function(e,t){var i=this._settingService.getMovementSpeed(),n=(i-WS.PanoSettings.MinMovementSpeed)/(WS.PanoSettings.MaxMovementSpeed-WS.PanoSettings.MinMovementSpeed);n=Math.max(4*n,1);var o=this._camera._fovY/180*Math.PI,r=o*this._camera._width/this._camera._height,a=e*n/this._camera._width*r,s=t*n/this._camera._height*o;return[a,s]}},WS.extend("MoveHandler","BaseHandler"),WS.PickObjectHandler=function(e,t,i){WS.BaseHandler.call(this,e,i),this._scene=t,this._pickInfo=void 0},WS.PickObjectHandler.prototype={onDragStart:function(e,t,i){if(i!==WS.MouseAdapter.Button.Left)return!1;void 0!==this._pickInfo&&this.onDragStop(e,t);var n=this.pickRenderableInfo(e,t,!0);return void 0!==n&&n._list[0].supportsDragging()?(this._pickInfo=n,this.informListener("onObjectDragStart",[this._pickInfo,e,t]),!0):!1},onDragMove:function(e,t,i,n,o){return o!==WS.MouseAdapter.Button.Left?!1:void 0!==this._pickInfo?(this.informListener("onObjectDragMove",[this._pickInfo,e,t,i,n]),!0):!1},onDragStop:function(e,t,i){if(i!==WS.MouseAdapter.Button.Left)return!1;var n=!1;return void 0!==this._pickInfo&&(this.informListener("onObjectDragStop",[this._pickInfo,e,t]),n=!0),this._pickInfo=void 0,n},onDblClick:function(e,t,i){if(i!==F.MouseAdapter.Button.Left)return!this._view.instanceOf(WS.MapLeaflet);this._dblClickHappened=!0;var n,o=this.pickRenderableInfo(e,t);if(o){var r=o._list;r.length>0&&(n=r[r.length-1])}return n?(this.informListener("onObjectDblClick",[n,e,t,o]),this._view.instanceOf(WS.MapLeaflet)?!1:!0):!1},onClick:function(e,t,i){if(i!==WS.MouseAdapter.Button.Left)return!this._view.instanceOf(WS.MapLeaflet);this._dblClickHappened=!1;var n=this.pickRenderable(e,t);return this.informListener("onObjectClick",[n,e,t]),this._view.instanceOf(WS.MapLeaflet)?!1:!!n},pickRenderable:function(e,t){var i=this.pickRenderableInfo(e,t);return i&&i._list.length?i._list[i._list.length-1]:void 0},pickRenderableInfo:function(e,t,i){var n=(this._view instanceof WS.PanoramaView&&this._view.isRootCloud(),new WS.PickObjectVisitor(this._camera,e,t,this._view));return this._scene.traverse(n),n._pickInfo?n._pickInfo:void 0}},WS.extend("PickObjectHandler","BaseHandler"),WS.SelectRegionHandler=function(e,t,i,n,o){WS.BaseHandler.call(this,e,i),this._scene=t,this._renderable=n,this._rect=[0,0,0,0],this._addToSelection=o},WS.SelectRegionHandler.prototype={onDragStart:function(e,t,i){return i!==WS.MouseAdapter.Button.Left?!1:(this._rect[0]=this._rect[2]=e,this._rect[1]=this._rect[3]=t,this._renderable.setCorners(this._rect),!0)},onDragMove:function(e,t,i,n,o){return o!==WS.MouseAdapter.Button.Left?!1:(this._rect[2]=e,this._rect[3]=t,this._renderable.setCorners(this._rect),!0)},onDragStop:function(e,t,i){if(i!==WS.MouseAdapter.Button.Left)return!1;this._rect[2]=e,this._rect[3]=t;var n=WS.Rectangle.fromCorners(this._rect[0],this._rect[1],this._rect[2],this._rect[3]),o=new WS.SelectRegionVisitor(this._camera,n,this._view);if(this._scene.traverse(o),o._pickedRenderables.length>0){var r=this._addToSelection?"onObjectsSelect":"onObjectsUnselect";this.informListener(r,[o._pickedRenderables])}return this._renderable.setCorners(void 0),!0},deactivate:function(){this._renderable.setCorners(void 0)}},WS.extend("SelectRegionHandler","BaseHandler"),WS.PickObjectVisitor=function(e,t,i,n){this._pickedRenderable=void 0,this._pickInfo=void 0,this._modelMatrixStack=new WS.MatrixStack,this._view=n,this._layerService=F.DI().getService("layer"),this._cameraObject=void 0,this._camera=e,this._x=t,this._y=i,this._is3dView=n instanceof WS.PanoramaView&&n.isRootCloud()},WS.PickObjectVisitor.prototype={prepare:function(){this._camera&&(this._cameraObject=this._camera.createCameraObject(mat4.identity())),this._pickedRenderable=void 0,this._pickInfo=void 0},visit:function(e){var t=this._modelMatrixStack._top;if(e.instanceOf(WS.Renderable)&&e.getPickInfo&&this._layerService.isLayerVisible(e._layerId,this._view)){var i=mat4.getTranslation(t);if(this._cameraObject&&this._cameraObject.calcDistToPoint(i)<this._layerService.getObjectsVisbleUpToDistance(e._layerId,this._view)){var n=e.getPickInfo(this._camera,t,this._x,this._y,this._is3dView);if(void 0!==n)return this._pickedRenderable=e,this._pickInfo=n,!1}}return!0}},WS.extend("PickObjectVisitor","SceneVisitorBase"),WS.SelectRegionVisitor=function(e,t,i){this._pickedRenderables=[],this._modelMatrixStack=new WS.MatrixStack,this._view=i,this._layerService=F.DI().getService("layer"),this._cameraObject=void 0,this._camera=e,this._rectangle=t},WS.SelectRegionVisitor.prototype={prepare:function(){this._camera&&(this._cameraObject=this._camera.createCameraObject(mat4.identity())),this._pickedRenderables=[]},visit:function(e){var t=this._modelMatrixStack._top;if(e.instanceOf(WS.Renderable)&&this._layerService.isLayerVisible(e._layerId,this._view)){var i=mat4.getTranslation(t);if(this._cameraObject&&this._cameraObject.calcDistToPoint(i)<this._layerService.getObjectsVisbleUpToDistance(e._layerId,this._view)){var n=e.getRegionPickInfo(this._camera,t,this._rectangle);n&&this._pickedRenderables.push(e)}}return!0}},WS.extend("SelectRegionVisitor","SceneVisitorBase"),WS.Camera=function(e,t,i,n){this._width=void 0!==e?e:300,this._height=void 0!==t?t:150,this._near=void 0!==i?i:.1,this._far=void 0!==n?n:500,this._inverseTransform=mat4.identity(),this._projMatrix=mat4.identity(),this._camMatrix=mat4.identity(),this._camMatrixOrigin=mat4.identity(),this._dirty=!1,this._changesToTrigger=!1,this._projPoint=vec4.create()},WS.Camera.prototype={copyFrom:function(e){this._children=[];for(var t=0,i=e._children.length;i>t;++t)this._children.push(e._children[t]);this._parent=e._parent,this._transform=mat4.create(e._transform),this._width=e._width,this._height=e._height,this._near=e._near,this._far=e._far,this._inverseTransform=mat4.create(e._inverseTransform),this._projMatrix=mat4.create(e._projMatrix),this._camMatrix=mat4.create(e._camMatrix),this._camMatrixOrigin=mat4.create(e._camMatrixOrigin),this._dirty=e._dirty,this._changesToTrigger=e._changesToTrigger,this._projPoint=vec4.create(e._projPoint)},setDimensions:function(e,t){(e!==this._width||this._height!==t)&&(this._width=e,this._height=t,this.updateCameraMatrix())},setNearAndFarPlane:function(e,t){e&&(this._near=e),t&&(this._far=t),this.updateCameraMatrix()},updateProjectionMatrix:function(){},updateCameraMatrix:function(){this.updateProjectionMatrix(),mat4.inverse(this._transform,this._inverseTransform),mat4.multiply(this._projMatrix,this._transform,this._camMatrix),mat4.set(this._transform,this._camMatrixOrigin),mat4.setTranslation(this._camMatrixOrigin,[0,0,0]),mat4.multiply(this._projMatrix,this._camMatrixOrigin,this._camMatrixOrigin),this._dirty=!0,this._changesToTrigger=!0},rotate:function(e,t){WS.Transform.prototype.rotate.call(this,e,t),this.updateCameraMatrix()},rotateX:function(e){WS.Transform.prototype.rotateX.call(this,e),this.updateCameraMatrix()},rotateY:function(e){WS.Transform.prototype.rotateY.call(this,e),this.updateCameraMatrix()},rotateZ:function(e){WS.Transform.prototype.rotateZ.call(this,e),this.updateCameraMatrix()},projectPoint:function(e,t,i,n,o,r){t=t||e;var a=this._projPoint,s=n||this._width,c=o||this._height;mat4.multiplyVec4(this._camMatrix,e,a);var l=Math.abs(a[3]),h=!0;return((a[0]<=-l||a[0]>=l||a[1]<=-l||a[1]>=l)&&!i||a[2]<=-l||a[2]>=l)&&(h=!1,!r)?h:(t[0]=a[0]/a[3],t[1]=a[1]/a[3],t[2]=a[2]/a[3],t[0]=(t[0]+1)/2*s,t[1]=(t[1]+1)/2*c,t[2]=(t[2]+1)/2,t.length>=4&&(t[3]=1),t.length>=5&&(t[4]=1/a[3]),h)},projectLine:function(e,t,i,n,o,r,a){var s,c=1e-5,l=o||this._width,h=r||this._height;i=i||e,n=n||t,mat4.multiplyVec4(this._camMatrix,e,i),mat4.multiplyVec4(this._camMatrix,t,n);var d=[];if(i[3]>=c&&n[3]>=c||i[3]<=-c&&n[3]<=-c)d.push(i),d.push(n);else{for(var u=new MatrixArray(4),p=new MatrixArray(4),_=0;4>_;_++)u[_]=i[_],p[_]=n[_];s=vec4.clipLineToXYZHyperPlane(i,n,-c,!1),s&&(d.push(i),d.push(n)),s=vec4.clipLineToXYZHyperPlane(u,p,c,!0),s&&(d.push(u),d.push(p))}var g,f,m;for(g=0,f=d.length;f>g;g++)m=d[g],m[0]=m[0]/m[3],m[1]=m[1]/m[3],m[2]=m[2]/m[3];for(g=0,f=d.length;f>g;g+=2){var v=d[g],S=d[g+1];vec3.clipLineToUniformCube(v,S)}for(g=d.length-1;g>=0;g-=1){var b=d[g];((b[0]<-1||b[0]>1||b[1]<-1||b[1]>1)&&!a||b[2]<-1||b[2]>1)&&d.splice(g,1)}for(g=0,f=d.length;f>g;g++)m=d[g],m[0]=(m[0]+1)/2*l,m[1]=(m[1]+1)/2*h,m[2]=(m[2]+1)/2;if(2===d.length){for(var y=0;4>y;y++)i[y]=d[0][y],n[y]=d[1][y];return!0}return!1},unprojectPoint:function(e,t){var i=t||e;return vec3.unproject(e,this._transform,this._projMatrix,[0,0,this._width,this._height],i),i},getAnglesForScreenCoordinates:function(e,t){var i=this.getPosInView(),n=this.unprojectPoint([e,t,.99]),o=vec3.create();vec3.subtract(n,i,o);var r=vec3.create();return vec3.fromCartesianToSpherical(o,r),[2*Math.PI-r[0],-r[1]]},getGlobalTrafo:function(e){if(!e)return this._inverseTransform;var t=mat4.multiply(e,this._inverseTransform,mat4.create());return t},getGlobalPos:function(e){return mat4.getTranslation(e?this.getGlobalTrafo(e):this._inverseTransform)},getTrafoInView:function(){return this._inverseTransform},getPosInView:function(){return mat4.getTranslation(this._inverseTransform)},setFromGlobalTrafo:function(e,t){this._transform=this.calcTrafoInCameraRef(e,t),this.updateCameraMatrix()},setFromGlobalPos:function(e,t){var i=this.getGlobalTrafo(t);mat4.setTranslation(i,e),this.setFromGlobalTrafo(i,t)},calcTrafoInCameraRef:function(e,t){var i=mat4.inverse(e,mat4.create()),n=mat4.multiply(i,t,mat4.create());return n},calcPosInCameraRef:function(e,t){var i=this.getGlobalTrafo(t);mat4.setTranslation(i,e);var n=this.calcTrafoInCameraRef(i,t);return mat4.getTranslation(n)},createCameraObject:function(e){return new WS.CameraObject(this.getGlobalTrafo(e))},translate:function(e){WS.Transform.prototype.translate.call(this,e),this.updateCameraMatrix()},setTranslation:function(e){WS.Transform.prototype.setTranslation.call(this,e),this.updateCameraMatrix()}},WS.extend("Camera","Transform"),WS.PerspectiveCamera=function(e,t,i,n,o){WS.Camera.call(this,e,t,i,n),this._fovY=void 0!==o?o:WS.PerspectiveCamera.DefaultFov,this._mode=WS.PerspectiveCamera.Mode._3D,this.initCameraTransform(),this.updateCameraMatrix()},WS.PerspectiveCamera.prototype={copyFrom:function(e){WS.Camera.prototype.copyFrom.call(this,e),e.instanceOf(WS.PerspectiveCamera)&&(this._fovY=e._fovY,this._mode=e._mode)},initCameraTransform:function(){mat4.identity(this._transform),mat4.rotateX(this._transform,Math.PI*-.5),mat4.rotateZ(this._transform,.5*Math.PI)},updateProjectionMatrix:function(){this._projMatrix=mat4.perspective(this._fovY,this._width/this._height,this._near,this._far)},set3dMode:function(){this._mode=WS.PerspectiveCamera.Mode._3D},setPanoMode:function(){this._mode=WS.PerspectiveCamera.Mode.PANO},isIn3dMode:function(){return this._mode===WS.PerspectiveCamera.Mode._3D},isInPanoMode:function(){return this._mode===WS.PerspectiveCamera.Mode.PANO},createCameraObject:function(e){return new WS.PerspectiveCameraObject(this.getGlobalTrafo(e),this._width/this._height,this._fovY)},setFOVY:function(e){this.changeFOVY(e-this._fovY,0)},changeFOVY:function(e,t){if(this._fovY<=45&&t>0){var i;i=1===t?.25:2===t?.1:0;var n=Math.sin(this._fovY*(Math.PI/180)),o=1/Math.sqrt(2),r=Math.min(1,i+n/o);e*=r}this._fovY=Math.min(WS.PerspectiveCamera.MaxFov,Math.max(WS.PerspectiveCamera.MinFov,this._fovY+e)),this.updateCameraMatrix()},getFOVX:function(){var e=this._fovY*Math.PI/180,t=2*Math.atan(Math.tan(.5*e)*this._width/this._height);return 180*t/Math.PI},calcFrustum:function(e,t){var i=this;t&&(i=new WS.PerspectiveCamera,i.copyFrom(this),i.setNearAndFarPlane(void 0,t));var n,o=[];n=e?mat4.multiply(i._camMatrix,e,mat4.create()):i._camMatrix,o[0]=[vec3.createFrom(n[0]+n[3],n[4]+n[7],n[8]+n[11]),n[12]+n[15]],o[1]=[vec3.createFrom(-n[0]+n[3],-n[4]+n[7],-n[8]+n[11]),-n[12]+n[15]],o[2]=[vec3.createFrom(n[1]+n[3],n[5]+n[7],n[9]+n[11]),n[13]+n[15]],o[3]=[vec3.createFrom(-n[1]+n[3],-n[5]+n[7],-n[9]+n[11]),-n[13]+n[15]],o[4]=[vec3.createFrom(n[2]+n[3],n[6]+n[7],n[10]+n[11]),n[14]+n[15]],o[5]=[vec3.createFrom(-n[2]+n[3],-n[6]+n[7],-n[10]+n[11]),-n[14]+n[15]];for(var r=0;6>r;r++){var a=o[r],s=a[0],c=1/vec3.length(s);a[0]=vec3.scale(s,c),a[1]*=c}return o},calcViewingDistance:function(e,t){var i=this._fovY*Math.PI/180,n=this.getFOVX()*Math.PI/180,o=e/(2*Math.tan(.5*n)),r=t/(2*Math.tan(.5*i));return Math.max(o,r)},getAnglesForCenter:function(){return this.getAnglesForScreenCoordinates(this._width/2,this._height/2)},rotateVertically:function(e){var t=this.getAnglesForCenter(),i=t[1]+e,n=.000174532925,o=Math.min(.5*Math.PI-n,Math.max(Math.PI*-.5+n,i));e-=i-o;var r=mat4.identity();mat4.rotateX(r,-e),mat4.multiply(r,this._transform,this._transform),this.updateCameraMatrix()},rotateHorizontally:function(e){var t=mat4.identity(),i=[0,0,1,0];mat4.multiplyVec4(this._transform,i,i),mat4.rotate(t,-e,i,t),mat4.multiply(t,this._transform,this._transform),this.updateCameraMatrix()},lookAt:function(e,t){var i=this.getGlobalPos(t);i[0].toFixed(3)===e[0].toFixed(3)&&i[1].toFixed(3)===e[1].toFixed(3)&&(e[1]+=.000174532925);var n=mat4.lookAt(i,e,[0,0,1],mat4.create()),o=mat4.inverse(n,mat4.create());this.setFromGlobalTrafo(o,t)},moveForward:function(e){this.translate([0,0,e])},moveSideways:function(e){this.translate([-e,0,0])},moveVertical:function(e){this.translate([0,e,0])},setTheta:function(e){var t=this.getAnglesForCenter(),i=e-t[1];0!==i&&this.rotateVertically(i)},getTheta:function(){var e=this.getAnglesForCenter();return e[1]},setPhi:function(e){var t=this.getAnglesForCenter(),i=t[0]-e;0!==i&&this.rotateHorizontally(i)},getPhi:function(){var e=this.getAnglesForCenter();return e[0]},isLookingAtPole:function(){var e=this.getTheta(),t=.0174532925;return e<-Math.PI/2+t?-1:Math.PI/2-t<e?1:0}},WS.extend("PerspectiveCamera","Camera"),WS.PerspectiveCamera.DefaultFov=65,WS.PerspectiveCamera.MinFov=2,WS.PerspectiveCamera.MaxFov=140,WS.PerspectiveCamera.FrustumBoxIntersection={OUTSIDE:-1,INTERSECT:0,INSIDE:1},WS.PerspectiveCamera.Mode={_3D:0,PANO:1},WS.CameraAnimator=function(){this._camera=void 0,this._duration=void 0,this._endTime=void 0,this._targetPos=void 0,this._targetPhi=void 0,this._targetTheta=void 0,this._targetFov=void 0,this._viewTrafo=void 0,this._diffPos=void 0,this._diffPhi=void 0,this._diffTheta=void 0,this._diffFov=void 0},WS.CameraAnimator.prototype={reset:function(){this._camera=void 0,this._duration=void 0,this._endTime=void 0,this._targetPos=void 0,this._targetPhi=void 0,this._targetTheta=void 0,this._targetFov=void 0,this._viewTrafo=void 0,this._diffPos=void 0,this._diffPhi=void 0,this._diffTheta=void 0,this._diffFov=void 0},isAnimating:function(){return void 0!==this._camera},getNowMillis:function(){return Date.now()},startAnimation:function(e,t,i,n,o,r,a){this.isAnimating()&&this.reset(),this._camera=e,this._duration=t,this._viewTrafo=i,this._targetPos=n,this._targetPhi=o,this._targetTheta=r,this._targetFov=a,this._endTime=this.getNowMillis()+t,this._diffPos=n?vec3.subtract(n,e.getGlobalPos(i),vec3.create()):void 0,this._diffPhi=this.calcPhiDiff(e.getPhi(),o),this._diffTheta=this.calcThetaDiff(e.getTheta(),r),this._diffFov=this.calcFovDiff(e._fovY,a)},calcPhiDiff:function(e,t){return void 0!==t?F.wrapTo_MinusPI_PI(t-e):void 0},calcThetaDiff:function(e,t){return void 0!==t?F.wrapTo_MinusPI_PI(t-e):void 0},calcFovDiff:function(e,t){return void 0!==t?(t=Math.min(WS.PerspectiveCamera.MaxFov,Math.max(WS.PerspectiveCamera.MinFov,t)),t-e):void 0},animate:function(){if(this.isAnimating()){var e=Math.max(0,this._endTime-this.getNowMillis()),t=e/this._duration;if(void 0!==this._targetPos){var i=this._targetPos[0]-t*this._diffPos[0],n=this._targetPos[1]-t*this._diffPos[1],o=this._targetPos[2]-t*this._diffPos[2];this._camera.setFromGlobalPos([i,n,o],this._viewTrafo)}if(void 0!==this._targetPhi){var r=this._targetPhi-t*this._diffPhi;this._camera.setPhi(r)}if(void 0!==this._targetTheta){var a=this._targetTheta-t*this._diffTheta;this._camera.setTheta(a)}if(void 0!==this._targetFov){var s=this._targetFov-t*this._diffFov;this._camera.setFOVY(s)}var c=0===e;return c&&this.reset(),c}},calcGoodDuration:function(e,t,i,n,o,r,a,s){var c=0;if(void 0!==e&&void 0!==t&&!F.closeToArray(e,t,.00999)){var l=vec3.dist(t,e),h=1/Math.pow(50,1/3)*1e3;c=Math.min(2e3,Math.pow(l,1/3)*h)}var d=0,u=0,p=0,_=.00174532925;if(void 0===i||void 0===n||F.closeTo(i,n,_)||(u=Math.abs(this.calcPhiDiff(i,n))),void 0===o||void 0===r||F.closeTo(o,r,_)||(p=Math.abs(this.calcThetaDiff(o,r))),0!==u||0!==p){var g=u+p,f=g/(2*Math.PI),m=Math.pow(f,.75);d=2e3*m}var v=0;if(void 0!==a&&void 0!==s&&!F.closeTo(a,s,.0999)){var S=Math.abs(this.calcFovDiff(a,s));v=1500*S/(WS.PerspectiveCamera.MaxFov-WS.PerspectiveCamera.MinFov)}return Math.max(c,d,v)}},WS.extend("CameraAnimator"),WS.Scene=function(){},WS.Scene.prototype={add:function(e,t){e&&(t?t.addChild(e):this.addChild(e))},remove:function(e,t){var i,n,o,r;if(e.getRootNode()===this&&(i=e._parent,i.removeChild(e),t))for(o=e._children.length,n=0;e._children.length>0&&o>n;)n++,r=e._children[0],i.addChild(r);this.removeChild(e)},removeAll:function(){for(var e=this._children.slice(),t=0,i=e.length;i>t;t++)this.remove(e[t])}},WS.extend("Scene","SceneNode"),WS.PickPointHandler=function(e,t){WS.BaseHandler.call(this,e,t)},WS.PickPointHandler.prototype={onClick:function(e,t,i,n){if(i!==WS.MouseAdapter.Button.Left)return!this._view.instanceOf(WS.MapLeaflet);var o=this.pickPoint(e,t,n?7:5);return o?(this.informListener("onPickPoint",o),this._view.instanceOf(WS.MapLeaflet)?!1:!!o):!1},onDblClick:function(){return this._view.instanceOf(WS.MapLeaflet)?!1:!0}},WS.extend("PickPointHandler","BaseHandler"),WS.PickPointsHandler=function(e,t){WS.PickPointHandler.call(this,e,t)},WS.PickPointsHandler.prototype={onClick:function(e,t,i,n){if(i!==WS.MouseAdapter.Button.Left)return!this._view.instanceOf(WS.MapLeaflet);var o=this.pickPoint(e,t,n?7:5);return o?(this.informListener("onPickPoint",o),this._view.instanceOf(WS.MapLeaflet)?!1:!0):!1}},WS.extend("PickPointsHandler","PickPointHandler"),WS.MeasurementLabelRenderable=function(e){WS.AnnotationRenderable.call(this,e)},WS.MeasurementLabelRenderable.prototype={setProperties:function(e,t,i){this.setTranslation(t),this.setText(e,!0),this._hasMapType||(this.setCustomTextColor(i),this.setTextColor(i,!0)),this.updateImage()}},WS.extend("MeasurementLabelRenderable","AnnotationRenderable"),WS.PolylineMixin={setViewScanUuids:function(e){if(e){var t=this;t._viewScanUuids={},e.forEach(function(e){t._viewScanUuids[e]=!0})}else this._viewScanUuids=void 0},updateSegmentLines:function(){var e=[],t=[],i=[],n=this._pointsLocal.length;if(1===n){var o=this.getColorForState(this._pointStates?this._pointStates[0]:0);t.push.apply(t,o),e.push.apply(e,this.getPointInView(0))}else for(var r=n-1,a=0;r>a;++a){e.push.apply(e,this.getPointInView(a)),e.push.apply(e,this.getPointInView(a+1));var s=this.getColorForState(this._pointStates?this._pointStates[a]:0);t.push.apply(t,s);var c=this.getColorForState(this._pointStates?this._pointStates[a+1]:0);t.push.apply(t,c);var l=this.isSegmentInOtherScan(a),h=this.getColorForState(this._segmentStates?this._segmentStates[a]:0,l);i.push.apply(i,h),i.push.apply(i,h)}this._segmentLines.setColorLines(i),this._segmentLines.setColorPointsLarge(t),this._segmentLines.setPoints(e),this._segmentLinesSelected.setPoints(e),this._segmentLinesHighlighted.setPoints(e)},updateIconMixin:function(e){if(this._categoryLabel){var t=this._dataObject?this._dataObject._category:void 0;if(t){var i=WS.ColorGenerator.intColorFromString(t),n=WS.ColorGenerator.rgbColorFromInt(i);this._categoryLabel.setCategoryColor(n)}else this._categoryLabel.setCategoryColor(void 0);this._categoryLabel.onIconModeChange(e)}},isPointInOtherScan:function(e){return!(!this._pointScans||!this._viewScanUuids||this._viewScanUuids[this._pointScans[e]])},isSegmentInOtherScan:function(e){return!(!this._pointScans||!this._viewScanUuids||this._viewScanUuids[this._pointScans[e]]&&this._viewScanUuids[this._pointScans[e+1]])},updateDashLength:function(){var e=1/this._unit.getExactLength(1);this._segmentLines.setDashLength(e),this._segmentLinesSelected.setDashLength(e),this._segmentLinesHighlighted.setDashLength(e),this._axis&&this._axis.setDashLength(this._segmentLines.getCurrentDashLength())},getPickInfoMixin:function(e,t,i,n){var o;if(this._pointIcons&&(o=this.getPickInfoOfMemberRenderable(e,t,this._pointIcons,i,n)),void 0===o){var r=this.getVisibleMemberRenderables();o=this.getPickInfoOfMemberRenderable(e,t,r,i,n)}return void 0!==o&&o.add(this),o},getRegionPickInfoMixin:function(e,t,i){var n=this._segmentLines.getRegionPickInfo(e,t,i);return n&&n.add(this),n}},WS.defineMixin("PolylineMixin"),WS.PolylineMixin.ColorSelected=new WS.ArrayBuffer([.47,.804,.95,1],4),WS.PolylineMixin.ColorHighlighted=new WS.ArrayBuffer([.98,.875,.08,1],4),WS.PolylineMixin.ColorPtsSmall=new WS.ArrayBuffer([0,0,0,1],4),WS.MeasurementRenderable=function(e,t,i,n,o,r,a){this._unit=i,this._locale=n,this._viewScanUuids=void 0,this.setViewScanUuids(r),this._trafoToRefsystem=t,this._trafoView=a,this._temporary=e.instanceOf(WS.TempMeasurement),this._type=e._type,this._distance=e._distance,this._distances=e._distances,this._pointsGlobal=e._pointsGlobal,this._pointsLocal=e._pointsLocal,this._pointScans=e._pointScans,this._pointStates=e._pointStates,this._segmentStates=e._segmentStates,this._distanceStartEnd=e._distanceStartEnd,this._distanceHorizontalGlobal=e._distanceHorizontalGlobal,this._distanceVerticalGlobal=e._distanceVerticalGlobal,this._distanceXGlobal=e._distanceXGlobal,this._distanceYGlobal=e._distanceYGlobal,this._trafoCustomOfProj=e._trafoCustomOfProj,this._pointsCustom=e._pointsCustom,this._distXCustom=e._distXCustom,this._distYCustom=e._distYCustom,this._distZCustom=e._distZCustom,this._distHCustom=e._distHCustom,this._useCustomTrafo=void 0,this.updateUseCustomTrafo(),this._mode=WS.MeasurementRenderable.MODE_SEGMENT;var s=this;o.get().then(function(e){switch(e._distState){case"axis":s._mode=WS.MeasurementRenderable.MODE_AXIS;break;case"angle":s._mode=WS.MeasurementRenderable.MODE_ANGLE;break;default:s._mode=WS.MeasurementRenderable.MODE_SEGMENT}}).done(),this._objectUUIDs=e._objectUUIDs,this._objectClasses=e._objectClasses,this._labelsModeSegment=[],this._labelsModeAxis=new Array(new WS.MeasurementLabelRenderable(this._type===WS.Measurement.Type.Map),new WS.MeasurementLabelRenderable(this._type===WS.Measurement.Type.Map),new WS.MeasurementLabelRenderable(this._type===WS.Measurement.Type.Map));var c=1/i.getExactLength(1);this._segmentLines=new WS.DottedLinesRenderable(new WS.ArrayBuffer([],3),WS.PolylineMixin.ColorPtsSmall,new WS.ArrayBuffer([],4),new WS.ArrayBuffer([],4),WS.LineMaterial.Dash.Adaptive,void 0,void 0,void 0,c),this._segmentLinesSelected=new WS.DottedLinesRenderable(new WS.ArrayBuffer([],3),WS.PolylineMixin.ColorPtsSmall,WS.PolylineMixin.ColorSelected,WS.PolylineMixin.ColorSelected,WS.LineMaterial.Dash.Adaptive,6,8,void 0,c),this._segmentLinesHighlighted=new WS.DottedLinesRenderable(new WS.ArrayBuffer([],3),WS.PolylineMixin.ColorPtsSmall,WS.PolylineMixin.ColorHighlighted,WS.PolylineMixin.ColorHighlighted,WS.LineMaterial.Dash.Adaptive,6,8,void 0,c),this._segmentLinesSelected.enableDepthTest(!1),this._segmentLinesHighlighted.enableDepthTest(!1),this._axis=new WS.LinesRenderable(new WS.ArrayBuffer([],3),WS.MeasurementRenderable.ColorAxis,WS.LineMaterial.Dash.Fixed,void 0,c),this._categoryLabel=void 0,this._pointIcons=[],this._objectIcons=[],this._multiPointsBuffer=new WS.ArrayBuffer([],3),this._multiPointsPoint=new WS.PointRenderable(this._multiPointsBuffer,new WS.ArrayBuffer([0,0,0,0],4),10)},WS.MeasurementRenderable.prototype={updateUseCustomTrafo:function(){this._useCustomTrafo=void 0!==this._trafoCustomOfProj&&this._unit.isCustomCS()},getPointInView:function(e){return mat4.multiplyVec3(this._trafoToRefsystem,this._pointsLocal[e],vec3.create())},getAxisPointInView:function(){var e,t,i=this._type===WS.Measurement.Type.Map;if(this._useCustomTrafo){e=this._pointsCustom[0],t=this._pointsCustom[this._pointsCustom.length-1];var n=i?[t[0],e[1],e[2]]:[t[0],t[1],e[2]],o=mat4.multiplyVec3(this._trafoCustomOfProj,n,vec3.create());return mat4.posInRefSystem(o,this._trafoView)}return e=this.getPointInView(0),t=this.getPointInView(this._pointsLocal.length-1),i?[t[0],e[1],e[2]]:[t[0],t[1],e[2]]},getImagePathForObjectClass:function(e){switch(e){case WS.Measurement.ObjectClasses.Scan:case WS.Measurement.ObjectClasses.PointCloud:return WS.MeasurementRenderable.ObjectClassImagePaths.Scan;case WS.Measurement.ObjectClasses.Sphere:return WS.MeasurementRenderable.ObjectClassImagePaths.Sphere;case WS.Measurement.ObjectClasses.Plane:case WS.Measurement.ObjectClasses.PlanEx:case WS.Measurement.ObjectClasses.Rectangle:return WS.MeasurementRenderable.ObjectClassImagePaths.Plane;case WS.Measurement.ObjectClasses.Slab:return WS.MeasurementRenderable.ObjectClassImagePaths.Slab;case WS.Measurement.ObjectClasses.Pipe:return WS.MeasurementRenderable.ObjectClassImagePaths.Pipe;default:return WS.MeasurementRenderable.ObjectClassImagePaths.Point}},setSegmentMode:function(e){this._mode=e},switchSegmentMode:function(){this.setSegmentMode(this._mode===WS.MeasurementRenderable.MODE_SEGMENT?WS.MeasurementRenderable.MODE_AXIS:WS.MeasurementRenderable.MODE_SEGMENT)},setViewingModeOfLabels:function(){for(var e=this._viewingMode,t=0,i=this._labelsModeAxis.length;i>t;t++)this._labelsModeAxis[t]&&this._labelsModeAxis[t].setViewingMode(e);for(var n=0,o=this._labelsModeSegment.length;o>n;n++)this._labelsModeSegment[n]&&this._labelsModeSegment[n].setViewingMode(e)},onViewingModeChange:function(){switch(this._viewingMode){case WS.Renderable.ViewingMode.Selected:case WS.Renderable.ViewingMode.Highlighted:this._segmentLines.setTransparency(1),this._axis._material._depthTest=!1;break;case WS.Renderable.ViewingMode.Inconsiderable:this._segmentLines.setTransparency(WS.LabelRenderable.TRANSPARENCY_INCONSIDERABLE),this._axis._material._depthTest=!0;break;case WS.Renderable.ViewingMode.Normal:this._segmentLines.setTransparency(this._occluded?WS.LabelRenderable.TRANSPARENCY_OCCLUDED:1),this._axis._material._depthTest=!0}this.setViewingModeOfLabels()},areSegmentsValid:function(){if(!this._segmentStates)return!0;for(var e=this._segmentStates.length,t=0;e>t;t++)if(0!==this._segmentStates[t])return!1;return!0},isPointValid:function(e){return!this._pointStates||e<this._pointStates.length&&0===this._pointStates[e]},isStartEndValid:function(){return!this._pointStates||this.isPointValid(0)&&this.isPointValid(this._pointStates.length-1)},updateObjectIcons:function(){var e,t,i,n,o,r;if(this._objectIcons=[],this._type===WS.Measurement.Type.Object&&this._objectClasses)for(var a=0,s=this._objectClasses.length;s>a;a++)t=this.getImagePathForObjectClass(this._objectClasses[a]),t&&t.length>0&&(e=this.getPointInView(a),i=new WS.Image(t),n=new WS.CenteredQuadGeometry,o=new WS.SpriteMaterial(i,vec2.create([32,32]),!1,WS.Image.Filter.Nearest),r=new WS.SpriteRenderable(n,o),r.setTranslation(e),this._objectIcons[a]=r)},updatePointIcons:function(){var e,t,i;if(this._pointIcons=[],this._type===WS.Measurement.Type.MultiScanPoint){i=new WS.SpriteMaterial(WS.MeasurementRenderable.RemoteScanPtImage,vec2.create([20,20]),!1),t=new WS.DynamicQuadGeometry,t.setPosition(14,14,20,20);for(var n=[],o=[],r=0,a=this._pointsLocal.length;a>r;r++)if(this.isPointInOtherScan(r)){e=this.getPointInView(r);var s=new WS.ClickableSpriteRenderable(t,i,WS.ClickableSpriteRenderable.Type.MEASUREMENT_POINT,this._dataObject,r);s.setTranslation(e),this._pointIcons.push(s);var c=this.getColorForState(this._pointStates?this._pointStates[r]:0);o.push.apply(o,c),n.push(e[0],e[1],e[2])}this._multiPointsBuffer.setBufferData(n),this._multiPointsPoint.setColors(o)}},updateAxis:function(){var e=this.getPointInView(0),t=this.getPointInView(this._pointsLocal.length-1),i=this.getAxisPointInView(),n=[];n.push.apply(n,e),n.push.apply(n,i),n.push.apply(n,i),n.push.apply(n,t),n.push.apply(n,t),n.push.apply(n,e),this._axis.setEndPointPositions(n)},updateSegmentLabels:function(){var e,t,i=this._pointsLocal.length-1,n=i>=2?i+1:1;this._labelsModeSegment.slice(0,n);for(var o=0;i>o;o++){var r=WS.MeasurementRenderable.SegmentLabelConfForState[this._segmentStates?this._segmentStates[o]:0];
if(r._show){var a=vec3.create();vec3.lerp(this.getPointInView(o),this.getPointInView(o+1),.5,a),e=r._valid?this._unit.getLengthAndUnit(this._distances[o],3):this._locale.translate("FE_INVALID"),t=r._valid?WS.MeasurementRenderable.ColorValid:WS.MeasurementRenderable.ColorInvalid,this._labelsModeSegment[o]||(this._labelsModeSegment[o]=new WS.MeasurementLabelRenderable(this._type===WS.Measurement.Type.Map)),this._labelsModeSegment[o].setProperties(e,a,t),this._labelsModeSegment[o].setOcclusion(this.isSegmentInOtherScan(o))}else this._labelsModeSegment[o]=void 0}if(n>=2){var s=this.areSegmentsValid();e=" = "+(s?this._unit.getLengthAndUnit(this._distance,3):this._locale.translate("FE_INVALID")),t=s?WS.MeasurementRenderable.ColorValid:WS.MeasurementRenderable.ColorInvalid,this._labelsModeSegment[n-1]||(this._labelsModeSegment[n-1]=new WS.MeasurementLabelRenderable(this._type===WS.Measurement.Type.Map)),this._labelsModeSegment[n-1].setProperties(e,this.getPointInView(this._pointsLocal.length-1),t)}},updateCategoryLabel:function(){var e=this._pointsLocal.length-1,t=e>=2?e+1:1;this._categoryLabel=this._labelsModeSegment[t-1],this._categoryLabel.setDataObject(this._dataObject)},updateAxisLabels:function(){this._type===WS.Measurement.Type.Map?this.updateAxisLabelsMap():this.updateAxisLabelsScan()},updateAxisLabelsScan:function(){var e,t,i,n=this.isStartEndValid(),o=n?WS.MeasurementRenderable.ColorValid:WS.MeasurementRenderable.ColorInvalid,r=this.getPointInView(0),a=this.getPointInView(this._pointsLocal.length-1),s=this.getAxisPointInView();if(e=vec3.create(),vec3.lerp(a,s,.5,e),t=n?this._unit.getLengthAndUnit(this._useCustomTrafo?this._distZCustom:this._distanceVerticalGlobal,3):this._locale.translate("FE_INVALID"),i=this._locale.translateAndCompose("FE_MEASUREMENT_AXIS",[t]),this._labelsModeAxis[0].setProperties(i,e,o),e=vec3.create(),vec3.lerp(r,s,.5,e),n)i=this._locale.translateAndCompose("FE_MEASUREMENT_AXIS_TOTAL",[this._unit.getLengthAndUnit(this._useCustomTrafo?this._distHCustom:this._distanceHorizontalGlobal,3),this._unit.getLengthAndUnit(this._useCustomTrafo?this._distXCustom:this._distanceXGlobal,3),this._unit.getLengthAndUnit(this._useCustomTrafo?this._distYCustom:this._distanceYGlobal,3)]);else{var c=this._locale.translate("FE_INVALID");i=this._locale.translateAndCompose("FE_MEASUREMENT_AXIS_TOTAL",[c,c,c])}this._labelsModeAxis[1].setProperties(i,e,o),e=vec3.create(),vec3.lerp(a,r,.5,e),t=n?this._unit.getLengthAndUnit(this._distanceStartEnd,3):this._locale.translate("FE_INVALID"),i=this._locale.translateAndCompose("FE_MEASUREMENT_AXIS_STARTEND",[t]),this._labelsModeAxis[2].setProperties(i,e,o)},updateAxisLabelsMap:function(){var e,t,i,n=WS.MeasurementRenderable.ColorValid,o=this.getPointInView(0),r=this.getPointInView(this._pointsLocal.length-1),a=this.getAxisPointInView();e=vec3.create(),vec3.lerp(o,a,.5,e),t=this._unit.getLengthAndUnit(this._useCustomTrafo?this._distXCustom:this._distanceXGlobal,3),i=this._locale.translateAndCompose("FE_MEASUREMENT_ALONG_X",[t]),this._labelsModeAxis[0].setProperties(i,e,n),e=vec3.create(),vec3.lerp(r,a,.67,e),t=this._unit.getLengthAndUnit(this._useCustomTrafo?this._distYCustom:this._distanceYGlobal,3),i=this._locale.translateAndCompose("FE_MEASUREMENT_ALONG_Y",[t]),this._labelsModeAxis[1].setProperties(i,e,n),e=vec3.create(),vec3.lerp(r,o,.33,e),t=this._unit.getLengthAndUnit(this._distanceStartEnd,3),i=this._locale.translateAndCompose("FE_MEASUREMENT_AXIS_STARTEND",[t]),this._labelsModeAxis[2].setProperties(i,e,n)},setIconMode:function(e,t){this._categoryLabel&&this._categoryLabel.setIconMode(e,t)},updateAppearance:function(){this.updateUseCustomTrafo(),this.updateSegmentLines(),this.updateAxis(),this.updateSegmentLabels(),this.updateAxisLabels(),this.updateObjectIcons(),this.updatePointIcons(),this.updateCategoryLabel(),this.updateIcon(),this.updateDashLength(),this.addToLayer(WS.Layer.LayerIDs.MEASUREMENTS,!0)},updateMSMPoints:function(){this.updateSegmentLines(),this.updatePointIcons(),this.addToLayer(WS.Layer.LayerIDs.MEASUREMENTS,!0)},updateUnit:function(){this.updateUseCustomTrafo(),this.updateSegmentLabels(),this.updateAxis(),this.updateAxisLabels()},updateLanguage:function(){this.updateAxisLabels()},getVisibleMemberRenderables:function(){var e=[];return e.push(this._viewingMode===WS.Renderable.ViewingMode.Highlighted?this._segmentLinesHighlighted:this._viewingMode===WS.Renderable.ViewingMode.Selected?this._segmentLinesSelected:this._segmentLines),this._type===WS.Measurement.Type.MultiScanPoint&&e.push(this._multiPointsPoint),e.push.apply(e,this._objectIcons),e.push.apply(e,this._pointIcons),this._mode===WS.MeasurementRenderable.MODE_SEGMENT?this._labelsModeSegment.forEach(function(t){void 0!==t&&e.push(t)}):this._mode===WS.MeasurementRenderable.MODE_AXIS&&(e.push(this._axis),e.push.apply(e,this._labelsModeAxis)),e},getMemberRenderables:function(){var e=[];return e.push(this._segmentLinesHighlighted),e.push(this._segmentLinesSelected),e.push(this._segmentLines),e.push(this._multiPointsPoint),e.push.apply(e,this._objectIcons),e.push.apply(e,this._pointIcons),this._labelsModeSegment.forEach(function(t){void 0!==t&&e.push(t)}),e.push(this._axis),e.push.apply(e,this._labelsModeAxis),e},draw3d:function(e,t){t(this)&&this.drawMemberRenderables3d(e,t,!1)},draw2d:function(e,t){this.drawMemberRenderables2d(e,t,!1)},getColorForState:function(e,t){var i=t?1:0;return this._temporary?WS.MeasurementRenderable.ColorForStateTemp[i][e]:WS.MeasurementRenderable.ColorForState[i][e]},updateIcon:function(e){this.updateIconMixin(e)},getPickInfo:function(e,t,i,n){return this.getPickInfoMixin(e,t,i,n)},getRegionPickInfo:function(e,t,i){return this.getRegionPickInfoMixin(e,t,i)}},WS.extend("MeasurementRenderable","Renderable"),WS.mixin("MeasurementRenderable","PolylineMixin"),WS.MeasurementRenderable.ColorForState={0:{0:[1,1,0,1],1:[1,0,0,1],2:[1,.7,.078,1]},1:{0:[.5,.5,0,1],1:[.5,0,0,1],2:[.5,.35,.04,1]}},WS.MeasurementRenderable.ColorForStateTemp={0:{0:[1,.7,.078,1],1:[1,0,0,1],2:[1,.7,.078,1]},1:{0:[.5,.35,.04,1],1:[.5,0,0,1],2:[.5,.35,.04,1]}},WS.MeasurementRenderable.SegmentLabelConfForState={0:{_show:!0,_valid:!0},1:{_show:!0,_valid:!1},2:{_show:!1,_valid:!1}},WS.MeasurementRenderable.ColorAxis=new WS.ArrayBuffer([0,.6666,.9333,1],4),WS.MeasurementRenderable.ColorValid=[0,0,0,1],WS.MeasurementRenderable.ColorInvalid=[1,0,0,1],WS.MeasurementRenderable.MODE_AXIS=1,WS.MeasurementRenderable.MODE_SEGMENT=2,WS.MeasurementRenderable.MODE_ANGLE=3,WS.MeasurementRenderable.ObjectClassImagePaths={Plane:WS.imgUrlCanvasSafe("obj_picto_plane.png"),Pipe:WS.imgUrlCanvasSafe("obj_picto_cylinder.png"),Sphere:WS.imgUrlCanvasSafe("obj_picto_sphere.png"),Slab:WS.imgUrlCanvasSafe("obj_picto_slab.png"),Scan:WS.imgUrlCanvasSafe("obj_picto_scanner.png"),Point:WS.imgUrlCanvasSafe("obj_picto_point.png")},WS.MeasurementRenderable.RemoteScanPtImage=new WS.Image(WS.imgUrlCanvasSafe("icons/msm-icon.png"),WS.Image.Filter.Nearest),WS.BlendMaterial=function(e,t,i,n,o,r,a,s){this._blendFactor=r,this._images=o,WS.ShaderMaterial.call(this,e,t,i,n,this._images,a,s)},WS.BlendMaterial.prototype={setTextureImgUrls:function(e){if(this._images.length===e.length){for(var t=!0,i=0;i<this._images.length;i++)this._images[i]._imageSrc!==e[i]&&(t=!1);if(t)return}WS.ShaderMaterial.prototype.setTextureImgUrls.call(this,e)},setBlendFactor:function(e){this._blendFactor=e}},WS.extend("BlendMaterial","ShaderMaterial"),WS.PolygonRenderable=function(e,t){var i=new WS.PolyCircuitGeometry(e),n=new WS.PolygonMaterial(t);WS.Mesh.call(this,i,n)},WS.PolygonRenderable.prototype={setTransparency:function(e){this._material._colorBuffer.setComponentOfAllItems(3,e)},setColor:function(e){this._material._colorBuffer.setBufferData(vec4.create(e))},setPoints:function(e){this._geometry._positionBuffer.setBufferData(e)},draw2d:function(e,t,i){(i||t(this))&&(this._geometry.getCountPositions()<3||WS.Mesh.prototype.draw2d.call(this,e,t,!0))},draw3d:function(e,t,i){(i||t(this))&&this._geometry.getCountPositions()<3}},WS.extend("PolygonRenderable","Mesh"),WS.PickAllHandler=function(e,t,i){WS.PickObjectHandler.call(this,e,t,i),this._waitForDblClick=i.instanceOf(WS.PanoramaView)&&i.isRootCloud()},WS.PickAllHandler.prototype={onClick:function(e,t,i,n){if(i!==WS.MouseAdapter.Button.Left)return!0;this._dblClickHappened=!1;var o,r=this.pickRenderableInfo(e,t);if(r){var a=r._list;a.length>0&&(o=a[a.length-1])}if(o)this.informListener("onObjectClick",[o,e,t,r]);else{var s=Date.now(),c=this.pickPoint(e,t,n?7:5);if(c)if(this._waitForDblClick){var l=Math.max(0,Date.now()-s);this._view._mouseAdapter.setPickDuration(l);var h=this._view._mouseAdapter.getDblClickWaitTime(n),d=h-l,u=this;setTimeout(function(){u._dblClickHappened||u.informListener("onPickPoint",c)},d)}else this.informListener("onPickPoint",c)}return!0}},WS.extend("PickAllHandler","PickObjectHandler"),WS.OrthoCamera=function(e,t,i,n,o,r,a,s){WS.Camera.call(this,e,t,i,n),this._left=void 0!==o?o:0,this._right=void 0!==r?r:200,this._bottom=void 0!==a?a:0,this._top=void 0!==s?s:100,this.updateCameraMatrix()},WS.OrthoCamera.prototype={copyFrom:function(e){WS.Camera.prototype.copyFrom.call(this,e),e.instanceOf(WS.OrthoCamera)&&(this._left=e._left,this._right=e._right,this._bottom=e._bottom,this._top=e._top),this.updateCameraMatrix()},setLeftRightBottomTop:function(e,t,i,n){this._left=e,this._right=t,this._bottom=i,this._top=n,this.updateCameraMatrix()},updateProjectionMatrix:function(){this._projMatrix=mat4.ortho(this._left,this._right,this._bottom,this._top,this._near,this._far)},createCameraObject:function(){var e=vec3.create();return{calcDistToPoint:function(){return 0},getGlobalPosition:function(){return e}}}},WS.extend("OrthoCamera","Camera"),WS.SetViewingModeVisitor=function(e){this._selectedObject=e},WS.SetViewingModeVisitor.prototype={visit:function(e){if(!e.instanceOf(WS.Renderable))return!0;if(this._selectedObject){var t=this._selectedObject===e?WS.Renderable.ViewingMode.Selected:WS.Renderable.ViewingMode.Inconsiderable;e.setViewingMode(t)}else e.setViewingMode(WS.Renderable.ViewingMode.Normal);return!0}},WS.extend("SetViewingModeVisitor","VisitorBase"),WS.Box3dRenderable=function(e,t){t=t||{},this._alwaysHighlight=e,this._faceColors=t.faces||WS.Box3dRenderable.FACE_COLORS,this._wireframeColors=t.wireframe||WS.Box3dRenderable.WIREFRAME_COLORS;var i=e?WS.Renderable.ViewingMode.Selected:WS.Renderable.ViewingMode.Normal;this._offsetZ=void 0,this._sizeX=void 0,this._sizeY=void 0,this._sizeZ=void 0,this._boxVertices=[];var n;for(n=0;8>n;n++)this._boxVertices[n]=vec3.create();this._lines=new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(72),3),this._wireframeColors[i]);var o=new WS.ColorMaterial(this._faceColors[i]),r=new WS.Geometry;r._positionBuffer=new WS.ArrayBuffer(new MatrixArray(24),3),r._indexBuffer=WS.Box3dRenderable.FACE_INDEXBUFFER,r._primitiveType=WS.Geometry.PrimitiveType.Triangles,this._boxFaces=new WS.Mesh(r,o)},WS.Box3dRenderable.prototype={valid:function(){return void 0!==this._sizeX&&void 0!==this._sizeY&&void 0!==this._sizeZ&&void 0!==this._offsetZ},setSize:function(e,t,i,n,o){this._sizeX=t,this._sizeY=i,this._sizeZ=n,this._offsetZ=o||0,e||this.updateAppearance()},updateAppearance:function(){if(this.valid()){var e=this._sizeX,t=this._sizeY,i=this._offsetZ,n=this._offsetZ+this._sizeZ,o=this._boxVertices;vec3.set([0,0,i],o[0]),vec3.set([e,0,i],o[1]),vec3.set([0,t,i],o[2]),vec3.set([e,t,i],o[3]),vec3.set([0,0,n],o[4]),vec3.set([e,0,n],o[5]),vec3.set([0,t,n],o[6]),vec3.set([e,t,n],o[7]);var r,a,s=this._lines._geometry._positionBuffer,c=WS.Box3dRenderable.WIREFRAME_INDICES;for(r=c.length-1;r>=0;r--){var l=c[r];a=r>0,s.setItem(r,o[l],a)}var h=this._boxFaces._geometry._positionBuffer;for(r=7;r>=0;r--)a=r>0,h.setItem(r,o[r],a)}},getMemberRenderables:function(){return[this._lines,this._boxFaces]},getVisibleMemberRenderables:function(){return this.valid()?this.getMemberRenderables():[]},draw3d:function(e,t,i){(i||t(this))&&this.drawMemberRenderables3d(e,t,!1)},draw2d:function(e,t){this.drawMemberRenderables2d(e,t,!1)},onViewingModeChange:function(){var e,t,i=this._alwaysHighlight?WS.Renderable.ViewingMode.Selected:this._viewingMode;switch(i){case WS.Renderable.ViewingMode.Selected:case WS.Renderable.ViewingMode.Highlighted:e=this._faceColors[WS.Renderable.ViewingMode.Selected],t=this._wireframeColors[WS.Renderable.ViewingMode.Selected];break;default:e=this._faceColors[WS.Renderable.ViewingMode.Normal],t=this._wireframeColors[WS.Renderable.ViewingMode.Normal]}this._boxFaces._material._colorBuffer=e,this._lines._material._colorBuffer=t}},WS.extend("Box3dRenderable","Renderable"),WS.Box3dRenderable.FACE_COLORS={},WS.Box3dRenderable.FACE_COLORS[WS.Renderable.ViewingMode.Normal]=new WS.ArrayBuffer([.1,.52,.93,.05],4),WS.Box3dRenderable.FACE_COLORS[WS.Renderable.ViewingMode.Selected]=new WS.ArrayBuffer([.1,.52,.93,.1],4),WS.Box3dRenderable.WIREFRAME_COLORS={},WS.Box3dRenderable.WIREFRAME_COLORS[WS.Renderable.ViewingMode.Normal]=new WS.ArrayBuffer([0,0,0,.5],4),WS.Box3dRenderable.WIREFRAME_COLORS[WS.Renderable.ViewingMode.Selected]=new WS.ArrayBuffer([0,0,0,1],4),WS.Box3dRenderable.WIREFRAME_INDICES=[0,1,1,3,3,2,2,0,4,5,5,7,7,6,6,4,0,4,1,5,2,6,3,7],WS.Box3dRenderable.FACE_INDEXBUFFER=new WS.IndexBuffer([0,1,2,1,2,3,4,5,6,5,6,7,0,1,5,0,4,5,2,3,7,2,6,7,0,2,6,0,4,6,1,3,7,1,5,7]),WS.OrthophotoLabelRenderable=function(){WS.AnnotationRenderable.call(this,!1),this._backgroundColor=vec4.create(WS.OrthophotoLabelRenderable.BG_COLOR),this._shadowColor=vec4.create(WS.OrthophotoLabelRenderable.SHADOW_COLOR)},WS.OrthophotoLabelRenderable.prototype={setNormalColors:function(){WS.LabelRenderable.prototype.setNormalColors.call(this),this.setBackgroundColor(WS.OrthophotoLabelRenderable.BG_COLOR,!0),this.setShadowColor(WS.OrthophotoLabelRenderable.SHADOW_COLOR,!0)}},WS.extend("OrthophotoLabelRenderable","AnnotationRenderable"),WS.OrthophotoLabelRenderable.BG_COLOR=[.882,.941,.969,.85],WS.OrthophotoLabelRenderable.SHADOW_COLOR=[.004,.184,.271,.85],WS.OrthoBox3dRenderable=function(e,t,i,n,o){WS.Box3dRenderable.call(this,e,t),t=t||{},this._imagePlaneAlphas=t.imagePlaneAlphas||WS.OrthoBox3dRenderable.IMAGEPLANE_ALPHAS;var r=e?WS.Renderable.ViewingMode.Selected:WS.Renderable.ViewingMode.Normal;this._alwaysShowBox=o||!1,this._showBox=this._alwaysShowBox,this._imageOffsetZ=0,this._quadVertices=[];for(var a=0;4>a;a++)this._quadVertices[a]=vec3.create();var s=WS.OrthoBox3dRenderable.QUAD_TEX_COORDS,c=this._imagePlaneAlphas[r],l=new WS.TextureMaterial(WS.OrthoBox3dRenderable.IMAGEPLANE_TEX_FRONT,s,!0,c,WS.Material.Cull.BACK),h=new WS.TextureMaterial(WS.OrthoBox3dRenderable.IMAGEPLANE_TEX_BACK,s,!0,c,WS.Material.Cull.FRONT),d=new WS.Geometry;if(d._positionBuffer=new WS.ArrayBuffer(new MatrixArray(18),3),d._primitiveType=WS.Geometry.PrimitiveType.Triangles,this._imagePlaneFront=new WS.Mesh(d,l),this._imagePlaneBack=new WS.Mesh(d,h),this._imagePlaneLines=new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(24),3),this._wireframeColors[r]),this._camVis=void 0,i){var u=new WS.Geometry;u._positionBuffer=new WS.ArrayBuffer(new MatrixArray(18),3),u._primitiveType=WS.Geometry.PrimitiveType.Triangles;var p=new WS.TextureMaterial(WS.OrthoBox3dRenderable.CAMERA_TEX,s,!0);this._camVis=new WS.Mesh(u,p)}this._nameLabel=void 0,n&&(this._nameLabel=new WS.OrthophotoLabelRenderable),this._categoryLabel=this._nameLabel},WS.OrthoBox3dRenderable.prototype={setSize:function(e,t,i,n,o,r){WS.Box3dRenderable.prototype.setSize.call(this,!0,t,i,n,o),this._imageOffsetZ=r||0,e||this.updateAppearance()},setCaption:function(e,t){this._nameLabel&&(e=F.shortenString(e,18,4),this._nameLabel.setText(e,t))},setShowBox:function(e){this._showBox=e||this._alwaysShowBox},updateIcon:function(e){if(this._categoryLabel){var t=this._dataObject?this._dataObject._category:void 0;if(t){var i=F.ColorGenerator.intColorFromString(t),n=F.ColorGenerator.rgbColorFromInt(i);this._categoryLabel.setCategoryColor(n)}else this._categoryLabel.setCategoryColor(void 0);this._categoryLabel.onIconModeChange(e)}},updateAppearance:function(e){if(this.valid()){WS.Box3dRenderable.prototype.updateAppearance.call(this);var t=this._imagePlaneFront._geometry._positionBuffer,i=this._sizeX,n=this._sizeY,o=this._imageOffsetZ,r=[.5*i,.5*n,o],a=[0,0,o],s=[0,n,o],c=[i,0,o],l=[i,n,o];t.setItem(0,a,!0),t.setItem(1,s,!0),t.setItem(2,c,!0),t.setItem(3,c,!0),t.setItem(4,s,!0),t.setItem(5,l,!1);var h=this._imagePlaneLines._geometry._positionBuffer;if(h.setItem(0,a,!0),h.setItem(1,s,!0),h.setItem(2,s,!0),h.setItem(3,l,!0),h.setItem(4,l,!0),h.setItem(5,c,!0),h.setItem(6,c,!0),h.setItem(7,a,!1),this._camVis){var d=.1,u=(.5-d)*i,p=(.5+d)*i,_=p-u,g=this._offsetZ,f=this._offsetZ+this._sizeZ,m=-1*Math.max(.1,Math.min(Math.abs(this._sizeZ),1)),v=Math.min(g,f)+m,S=v-_,b=this._camVis._geometry._positionBuffer;b.setItem(0,[p,0,v],!0),b.setItem(1,[u,0,v],!0),b.setItem(2,[p,0,S],!0),b.setItem(3,[p,0,S],!0),b.setItem(4,[u,0,v],!0),b.setItem(5,[u,0,S],!1)}this._dataObject&&this.setCaption(this._dataObject._displayName,!0),this.updateCategoryLabel(),this.updateIcon(e),this._nameLabel&&this._nameLabel.setTranslation(r)}},setViewingModeOfLabels:function(){this._nameLabel&&this._nameLabel.setViewingMode(this._viewingMode)},onViewingModeChange:function(){WS.Box3dRenderable.prototype.onViewingModeChange.call(this);var e,t=this._alwaysHighlight?WS.Renderable.ViewingMode.Selected:this._viewingMode;switch(t){case WS.Renderable.ViewingMode.Selected:case WS.Renderable.ViewingMode.Highlighted:e=this._imagePlaneAlphas[WS.Renderable.ViewingMode.Selected];break;default:e=this._imagePlaneAlphas[WS.Renderable.ViewingMode.Normal]}[this._imagePlaneFront,this._imagePlaneBack].forEach(function(t){t._material._alpha=e}),this.setViewingModeOfLabels()},getMemberRenderables:function(e){var t=e?[]:WS.Box3dRenderable.prototype.getMemberRenderables.call(this);return t.push(this._imagePlaneFront),t.push(this._imagePlaneBack),t.push(this._imagePlaneLines),this._camVis&&t.push(this._camVis),this._nameLabel&&t.push(this._nameLabel),t},getVisibleMemberRenderables:function(){return this.valid()?this.getMemberRenderables(!this._showBox):[]},getPickInfo:function(e,t,i,n){var o=this.getVisibleMemberRenderables(),r=this.getPickInfoOfMemberRenderable(e,t,o,i,n);return void 0!==r&&r.add(this),r},getRegionPickInfo:function(e,t,i){var n;if(this._nameLabel){var o=mat4.multiply(t,this._nameLabel._transform,mat4.create());n=this._nameLabel.getRegionPickInfo(e,o,i),n&&n.add(this)}return n},setIconMode:function(e,t){this._categoryLabel&&this._categoryLabel.setIconMode(e,t)},updateCategoryLabel:function(){this._categoryLabel&&this._categoryLabel.setDataObject(this._dataObject)},redraw:function(){this._nameLabel&&this._nameLabel.redraw()}},WS.extend("OrthoBox3dRenderable","Box3dRenderable"),WS.OrthoBox3dRenderable.IMAGEPLANE_TEX_FRONT=new WS.Image(WS.imgUrlCanvasSafe("image_nature.png")),WS.OrthoBox3dRenderable.IMAGEPLANE_TEX_BACK=new WS.Image(WS.imgUrlCanvasSafe("image_nature_hatch.png")),WS.OrthoBox3dRenderable.CAMERA_TEX=new WS.Image(WS.imgUrlCanvasSafe("camera.png")),WS.OrthoBox3dRenderable.QUAD_TEX_COORDS=new WS.ArrayBuffer([0,1,0,0,1,1,1,1,0,0,1,0],2),WS.OrthoBox3dRenderable.IMAGEPLANE_ALPHAS={},WS.OrthoBox3dRenderable.IMAGEPLANE_ALPHAS[WS.Renderable.ViewingMode.Normal]=.2,WS.OrthoBox3dRenderable.IMAGEPLANE_ALPHAS[WS.Renderable.ViewingMode.Selected]=.4,WS.CameraRenderable=function(e){var t=e._camera,i=t.getGlobalPos(e._trafoView),n=e._width,o=e._height,r=t.unprojectPoint([n,o,1],vec3.create()),a=t.unprojectPoint([0,o,1],vec3.create()),s=t.unprojectPoint([n,0,1],vec3.create()),c=t.unprojectPoint([0,0,1],vec3.create()),l=t.unprojectPoint([n,o,-1],vec3.create()),h=t.unprojectPoint([0,o,-1],vec3.create()),d=t.unprojectPoint([n,0,-1],vec3.create()),u=t.unprojectPoint([0,0,-1],vec3.create()),p=t.unprojectPoint([n/2,o/2,1],vec3.create()),_=[r,a,s,c,l,h,d,u],g=8,f=new WS.Geometry,m=f._positionBuffer=new WS.ArrayBuffer(new MatrixArray(3*g),3);f._indexBuffer=WS.CameraRenderable.INDEX_BUFFER,f._primitiveType=WS.Geometry.PrimitiveType.Triangles;for(var v=[i[0]-.025,i[1]-.025,i[2]-.025],S=[i[0]+.025,i[1]+.025,i[2]+.025],b=g-1;b>=0;--b){var y=b%2>=1?S[0]:v[0],P=b%4>=2?S[1]:v[1],C=b%8>=4?S[2]:v[2];m.setItem(b,[y,P,C],!0)}var w=new WS.ColorMaterial(new WS.ArrayBuffer([.33,0,0,1],4));w._depthTest=!0,w._depthWrite=!0,w._cullFace=WS.Material.Cull.BACK,this._box=new WS.Mesh(f,w);var T=new WS.Geometry,M=T._positionBuffer=new WS.ArrayBuffer(new MatrixArray(3*g),3);T._indexBuffer=WS.CameraRenderable.INDEX_BUFFER,T._primitiveType=WS.Geometry.PrimitiveType.Triangles;for(var W=0;8>W;++W)M.setItem(7-W,_[W],!0);var E=new WS.ColorMaterial(new WS.ArrayBuffer([.33,.33,.67,.4],4));E._depthTest=!0,E._depthWrite=!0,E._cullFace=WS.Material.Cull.BACK,this._faces=new WS.Mesh(T,E),this._lines=new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(3*g*3),3),new WS.ArrayBuffer([.33,.33,.67,1],4));for(var I=this._lines._geometry._positionBuffer,R=WS.Box3dRenderable.WIREFRAME_INDICES,L=R.length-1;L>=0;L--)I.setItem(L,_[R[L]],L>0);this._centerLine=new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(6),3),new WS.ArrayBuffer([.67,.33,.33,1],4));var O=this._centerLine._geometry._positionBuffer;O.setItem(0,p,!0),O.setItem(1,i),this._UUID=F.generateUUID(),this.addToLayer(WS.Layer.LayerIDs.TEMP,!0)},WS.CameraRenderable.prototype={getMemberRenderables:function(){return[this._box,this._faces,this._lines,this._centerLine]},draw3d:function(e,t){t(this)&&this.drawMemberRenderables3d(e,t,!0)},draw2d:function(){}},WS.extend("CameraRenderable","Renderable"),WS.CameraRenderable.INDEX_BUFFER=new WS.IndexBuffer([0,1,3,0,3,2,5,4,6,5,6,7,4,5,1,4,1,0,2,3,7,2,7,6,4,0,2,4,2,6,1,5,7,1,7,3]),WS.PickPositionRenderable=function(e){this._forMap=e,this._pointState=WS.Point3d.PointState.Unknown;var t=new WS.QuadGeometry,i=new WS.SpriteMaterial(WS.PickPositionRenderable.ImageUnknown,vec2.create([32,32]),!1,WS.Image.Filter.Linear);WS.SpriteRenderable.call(this,t,i)},WS.PickPositionRenderable.prototype={draw2d:function(){this.isVisible()&&WS.SpriteRenderable.prototype.draw2d.apply(this,arguments)},draw3d:function(){this.isVisible()&&WS.SpriteRenderable.prototype.draw3d.apply(this,arguments)},isVisible:function(){var e=this._pointState,t=WS.Point3d.PointState;return this._forMap&&(e===t.Valid||e===t.ValidXY||e===t.Free)||!this._forMap&&e!==t.ValidXY},setPointState:function(e){this._pointState=e;var t=this._material,i=WS.Point3d.PointState,n=WS.PickPositionRenderable;switch(e){case i.Valid:case i.ValidXY:t.setTextureImages([n.ImageValid]);break;case i.Invalid:t.setTextureImages([n.ImageInvalid]);break;case i.Unknown:case i.Free:t.setTextureImages([n.ImageUnknown])}},getPickInfo:function(){return void 0},getRegionPickInfo:function(){return void 0}},WS.extend("PickPositionRenderable","SpriteRenderable"),WS.PickPositionRenderable.ImageUnknown=new WS.Image(WS.imgUrlCanvasSafe("icons/pin_gray.png")),WS.PickPositionRenderable.ImageValid=new WS.Image(WS.imgUrlCanvasSafe("icons/pin_yellow.png")),WS.PickPositionRenderable.ImageInvalid=new WS.Image(WS.imgUrlCanvasSafe("icons/pin_red.png")),WS.ColorShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.color_vs,WS.shaderSrc.color_fs)},WS.extend("ColorShaderDesc","BasicShaderDesc"),WS.ColorShaderDesc.ID="ColorShader",WS.AreaLabelRenderable=function(){WS.MeasurementLabelRenderable.call(this,!1),this._backgroundColor=vec4.create(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP),this._shadowColor=vec4.create(WS.LabelRenderable.SHADOW_COLOR_MAP),this._textColor=vec4.create(WS.AreaLabelRenderable.TEXT_COLOR)},WS.AreaLabelRenderable.prototype={setNormalColors:function(){var e=this._textColorCustom?this._textColorCustom:WS.AreaLabelRenderable.TEXT_COLOR;this.setBackgroundColor(WS.LabelRenderable.BACKGROUND_COLOR_NORMAL_MAP,!0),this.setTextColor(e,!0),this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR_MAP,!0),this.setTransparency(this._occluded?WS.LabelRenderable.TRANSPARENCY_OCCLUDED:WS.LabelRenderable.TRANSPARENCY_NORMAL,!0)}},WS.extend("AreaLabelRenderable","MeasurementLabelRenderable"),WS.AreaLabelRenderable.TEXT_COLOR=[1,1,0,.8],WS.AreaLabelRenderable.TEXT_COLOR_INVALID=[1,.67,.67,.8],WS.AreaMeasurementRenderable=function(e,t,i,n,o,r){WS.MeasurementRenderable.call(this,e,t,i,n,o,void 0,r),this._area=e._area,this._centroidLocal=e._centroidLocal,this._areaValid=e.isAreaValid(),this._areaLabel=new WS.AreaLabelRenderable,this._areaPolygon=new WS.PolygonRenderable(new WS.ArrayBuffer([],3),WS.AreaMeasurementRenderable.COLOR_POLYGON),this._mode=WS.AreaMeasurementRenderable.MODE_AREA;var a=this;o.get().then(function(e){switch(e._areaState){case"show":a._mode=WS.MeasurementRenderable.MODE_SEGMENT;break;default:a._mode=WS.AreaMeasurementRenderable.MODE_AREA}}).done()},WS.AreaMeasurementRenderable.prototype={getCentroidInView:function(){return mat4.multiplyVec3(this._trafoToRefsystem,this._centroidLocal,vec3.create())},setSegmentMode:function(e){this._mode=e},switchSegmentMode:function(){this.setSegmentMode(this._mode===WS.MeasurementRenderable.MODE_SEGMENT?WS.AreaMeasurementRenderable.MODE_AREA:WS.MeasurementRenderable.MODE_SEGMENT)},isShowingDistanceLabels:function(){return this._mode===WS.MeasurementRenderable.MODE_SEGMENT},setViewingModeOfLabels:function(){WS.MeasurementRenderable.prototype.setViewingModeOfLabels.call(this),this._areaLabel.setViewingMode(this._viewingMode)},onViewingModeChange:function(){switch(this._viewingMode){case WS.Renderable.ViewingMode.Selected:this._areaPolygon.setColor(WS.AreaMeasurementRenderable.COLOR_POLYGON_SELECTED);break;case WS.Renderable.ViewingMode.Highlighted:this._areaPolygon.setColor(WS.AreaMeasurementRenderable.COLOR_POLYGON_HIGHLIGHTED);break;case WS.Renderable.ViewingMode.Inconsiderable:this._areaPolygon.setColor(WS.AreaMeasurementRenderable.COLOR_POLYGON),this._areaPolygon.setTransparency(WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_INCONSIDERABLE);break;case WS.Renderable.ViewingMode.Normal:var e=this.determineColorOfArea();this._areaPolygon.setColor(e),this._areaPolygon.setTransparency(this._occluded?WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_OCCLUDED:WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_NORMAL)}WS.MeasurementRenderable.prototype.onViewingModeChange.call(this)},updateUnit:function(){WS.MeasurementRenderable.prototype.updateUnit.call(this),this.updateAreaLabel()},updateAreaLabel:function(){var e=this._areaValid?this._unit.getAreaAndUnit(this._area,4):this._locale.translate("FE_INVALID"),t=this._areaValid?this.getCentroidInView():this.getPointInView(1),i=this._areaValid?WS.AreaLabelRenderable.TEXT_COLOR:WS.AreaLabelRenderable.TEXT_COLOR_INVALID;this._areaLabel.setProperties(e,t,i)},updateAreaPolygon:function(){for(var e=[],t=0,i=this._pointsLocal.length;i>t;++t)e.push.apply(e,this.getPointInView(t));this._areaPolygon.setPoints(e);var n=this.determineColorOfArea();this._areaPolygon.setColor(n),this._areaPolygon.setTransparency(this._occluded?WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_OCCLUDED:WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_NORMAL)},updateCategoryLabel:function(){this._categoryLabel=this._areaLabel,this._categoryLabel.setDataObject(this._dataObject)},updateAppearance:function(){this.updateAreaLabel(),this.updateAreaPolygon(),WS.MeasurementRenderable.prototype.updateAppearance.call(this)},determineColorOfArea:function(){return this._areaValid?this._temporary?WS.AreaMeasurementRenderable.COLOR_POLYGON_TEMPORARY:WS.AreaMeasurementRenderable.COLOR_POLYGON:WS.AreaMeasurementRenderable.COLOR_POLYGON_INVALID},getVisibleMemberRenderables:function(){var e=[];return e.push(this._areaPolygon),e.push(this._viewingMode===WS.Renderable.ViewingMode.Highlighted?this._segmentLinesHighlighted:this._viewingMode===WS.Renderable.ViewingMode.Selected?this._segmentLinesSelected:this._segmentLines),this._mode===WS.MeasurementRenderable.MODE_SEGMENT&&this._labelsModeSegment.forEach(function(t){void 0!==t&&e.push(t)}),e.push(this._areaLabel),e},getMemberRenderables:function(){var e=[];return e.push(this._areaPolygon),e.push(this._segmentLinesHighlighted),e.push(this._segmentLinesSelected),e.push(this._segmentLines),this._labelsModeSegment.forEach(function(t){void 0!==t&&e.push(t)}),e.push(this._areaLabel),e}},WS.extend("AreaMeasurementRenderable","MeasurementRenderable"),WS.AreaMeasurementRenderable.MODE_AREA=3,WS.AreaMeasurementRenderable.COLOR_POLYGON=[1,1,0,.25],WS.AreaMeasurementRenderable.COLOR_POLYGON_TEMPORARY=[1,.7,.078,.25],WS.AreaMeasurementRenderable.COLOR_POLYGON_INVALID=[1,0,0,.25],WS.AreaMeasurementRenderable.COLOR_POLYGON_SELECTED=[.47,.804,.95,.4],WS.AreaMeasurementRenderable.COLOR_POLYGON_HIGHLIGHTED=[.98,.875,.08,.4],WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_NORMAL=.25,WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_OCCLUDED=.1,WS.AreaMeasurementRenderable.TRANSPARENCY_POLYGON_INCONSIDERABLE=.1,WS.PolylineAnnotationRenderable=function(e,t,i,n){this._lineColor=F.ColorGenerator.intColorToDbl(e._displayColor),this._transform=t,this._unit=n,this._viewScanUuids=void 0,this.setViewScanUuids(i),this._pointsLocal=e._pointsLocal,this._pointScans=e._pointScans,this._pointStates=F.fillArray(this._pointsLocal.length,0),this._segmentStates=F.fillArray(this._pointsLocal.length,0);var o=1/n.getExactLength(1);this._segmentLines=new WS.DottedLinesRenderable(new WS.ArrayBuffer([],3),WS.PolylineMixin.ColorPtsSmall,new WS.ArrayBuffer([],4),new WS.ArrayBuffer([],4),WS.LineMaterial.Dash.None,void 0,void 0,void 0,o,2),this._segmentLinesSelected=new WS.DottedLinesRenderable(new WS.ArrayBuffer([],3),WS.PolylineMixin.ColorPtsSmall,WS.PolylineMixin.ColorSelected,WS.PolylineMixin.ColorSelected,WS.LineMaterial.Dash.None,6,8,void 0,o,2),this._segmentLinesHighlighted=new WS.DottedLinesRenderable(new WS.ArrayBuffer([],3),WS.PolylineMixin.ColorPtsSmall,WS.PolylineMixin.ColorHighlighted,WS.PolylineMixin.ColorHighlighted,WS.LineMaterial.Dash.None,6,8,void 0,o,2),this._segmentLinesSelected.enableDepthTest(!1),this._segmentLinesHighlighted.enableDepthTest(!1),this._areaPolygon=e.isClosedMapPolyline()?new WS.PolygonRenderable(new WS.ArrayBuffer([],3),this._lineColor):void 0,this._label=new WS.AnnotationRenderable(e.hasMapType()),this._label.setTranslation(this.getPointInView(0)),this._categoryLabel=this._label,this._showPolyline=!0},WS.PolylineAnnotationRenderable.prototype={getPointInView:function(e){return this._pointsLocal[e]},setShowPolyline:function(e){this._showPolyline=e},onViewingModeChange:function(){switch(this._viewingMode){case WS.Renderable.ViewingMode.Selected:this._areaPolygon&&this._areaPolygon.setColor(WS.PolylineAnnotationRenderable.COLOR_POLYGON_SELECTED);break;case WS.Renderable.ViewingMode.Highlighted:this._areaPolygon&&this._areaPolygon.setColor(WS.PolylineAnnotationRenderable.COLOR_POLYGON_HIGHLIGHTED),this._segmentLines.setTransparency(1);break;case WS.Renderable.ViewingMode.Inconsiderable:this._areaPolygon&&this._areaPolygon.setColor(this._lineColor),this._segmentLines.setTransparency(WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_OCCLUDED);break;case WS.Renderable.ViewingMode.Normal:this._areaPolygon&&(this._areaPolygon.setColor(this._lineColor),this._areaPolygon.setTransparency(this._occluded?WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_OCCLUDED:WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_NORMAL)),this._segmentLines.setTransparency(this._occluded?WS.LabelRenderable.TRANSPARENCY_OCCLUDED:1)}this._label.setViewingMode(this._viewingMode)},getColorForState:function(){return this._lineColor},setText:function(e,t){this._label.setText(e,t)},setIconMode:function(e,t){this._categoryLabel.setIconMode(e,t)},updateAreaPolygon:function(){if(this._areaPolygon){for(var e=[],t=0,i=this._pointsLocal.length;i>t;++t)e.push.apply(e,this.getPointInView(t));this._areaPolygon.setPoints(e),this._areaPolygon.setColor(this._lineColor),this._areaPolygon.setTransparency(this._occluded?WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_OCCLUDED:WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_NORMAL)
}},getVisibleMemberRenderables:function(){var e=[];return this._showPolyline&&(this._areaPolygon&&e.push(this._areaPolygon),e.push(this._viewingMode===WS.Renderable.ViewingMode.Highlighted?this._segmentLinesHighlighted:this._viewingMode===WS.Renderable.ViewingMode.Selected?this._segmentLinesSelected:this._segmentLines)),e.push(this._label),e},getMemberRenderables:function(){var e=[];return this._areaPolygon&&e.push(this._areaPolygon),e.push(this._segmentLinesHighlighted),e.push(this._segmentLinesSelected),e.push(this._segmentLines),e.push(this._label),e},draw3d:function(e,t){t(this)&&this.drawMemberRenderables3d(e,t,!1)},draw2d:function(e,t){this.drawMemberRenderables2d(e,t,!1)},updateIcon:function(e){this.updateIconMixin(e)},getPickInfo:function(e,t,i,n){return this.getPickInfoMixin(e,t,i,n)},getRegionPickInfo:function(e,t,i){return this.getRegionPickInfoMixin(e,t,i)}},WS.extend("PolylineAnnotationRenderable","Renderable"),WS.mixin("PolylineAnnotationRenderable","PolylineMixin"),WS.PolylineAnnotationRenderable.COLOR_POLYGON_SELECTED=[.47,.804,.95,.3],WS.PolylineAnnotationRenderable.COLOR_POLYGON_HIGHLIGHTED=[.98,.875,.08,.3],WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_NORMAL=.2,WS.PolylineAnnotationRenderable.TRANSPARENCY_POLYGON_OCCLUDED=.1,WS.QuadGeometry=function(){WS.Geometry.call(this),this._positionBuffer=WS.QuadGeometry.PositionBuffer,this._primitiveType=WS.Geometry.PrimitiveType.TriangleStrip},WS.extend("QuadGeometry","Geometry"),WS.QuadGeometry.PositionBuffer=new WS.ArrayBuffer([0,0,0,2,2,0,2,2],2),WS.TextureValue=function(e,t){this._texture=e,this._textureUnit=void 0!==t?t:0},WS.extend("TextureValue"),WS.ScanLabelRenderable=function(){WS.LabelRenderable.call(this),this._borderAddWidth=WS.ScanLabelRenderable.BORDER_ADD_WIDTH,this._borderAddHeight=this._textHeight-4,this._backgroundColor=vec4.create(WS.ScanLabelRenderable.BACKGROUND_COLOR_NORMAL),this.addToLayer(WS.Layer.LayerIDs.SCANS)},WS.ScanLabelRenderable.prototype={setNormalColors:function(){this.setBackgroundColor(WS.ScanLabelRenderable.BACKGROUND_COLOR_NORMAL,!0),this.setTextColor(this._textColorCustom?this._textColorCustom:WS.LabelRenderable.TEXT_COLOR,!0),this.setShadowColor(WS.LabelRenderable.SHADOW_COLOR,!0),this.setTransparency(this._occluded?WS.ScanLabelRenderable.TRANSPARENCY_OCCLUDED:WS.ScanLabelRenderable.TRANSPARENCY_NORMAL,!0)},renderToCanvas:function(){this._canvas||(this._canvas=document.createElement("canvas"));var e=this._canvas.getContext("2d"),t=this._textHeight+"px Arial";e.font=t;var i=e.measureText(this._text).width;i=Math.max(this._minBorderWidth,i);var n=i+this._borderAddWidth;this._icon&&(n+=WS.LabelRenderable.ICON_WIDTH);var o=this._textHeight+this._borderAddHeight,r=this._shadowOffsetX+this._shadowBlur,a=this._shadowOffsetY+this._shadowBlur,s=.5*n,c=.5*o,l=vec2.createFrom(0,0),h=vec2.createFrom(s,0),d=vec2.createFrom(n,0),u=vec2.createFrom(n,c),p=vec2.createFrom(n,o),_=vec2.createFrom(s,o),g=vec2.createFrom(0,o),f=vec2.createFrom(0,c);e.canvas.width=n+r,e.canvas.height=o+a,e.clearRect(0,0,e.canvas.width,e.canvas.height);var m=5;e.fillStyle=WS.Renderer2D.colorToStyle(this._backgroundColor),e.beginPath(),e.moveTo(h[0],h[1]),e.arcTo(d[0],d[1],d[0],d[1]+m,m),e.lineTo(u[0],u[1]),e.arcTo(p[0],p[1],p[0]-m,p[1],m),e.lineTo(_[0],_[1]),e.arcTo(g[0],g[1],g[0],g[1]-m,m),e.lineTo(f[0],f[1]),e.arcTo(l[0],l[1],l[0]+m,l[1],m),e.closePath(),this.drawShadow(e),e.font=t,e.fillStyle=WS.Renderer2D.colorToStyle(this._textColor);var v=.5*this._borderAddWidth,S=.5*this._borderAddHeight+this._textHeight-1;e.fillText(this._text,v,S),S+=this._textHeight+this._lineBreakHeight,this._icon&&this._icon.draw(e,d[0]-WS.LabelRenderable.ICON_WIDTH,d[1]-2,WS.LabelRenderable.ICON_WIDTH,WS.LabelRenderable.ICON_HEIGHT);var b=s,y=o+8;this._geometry.setPosition(b,y,e.canvas.width,e.canvas.height)},supportsDragging:function(){return!1}},WS.extend("ScanLabelRenderable","LabelRenderable"),WS.ScanLabelRenderable.BORDER_ADD_WIDTH=8,WS.ScanLabelRenderable.BACKGROUND_COLOR_NORMAL=[1,1,1,.8],WS.ScanLabelRenderable.TRANSPARENCY_NORMAL=.8,WS.ScanLabelRenderable.TRANSPARENCY_OCCLUDED=.45,WS.ScanRenderable=function(e,t,i){this._scanColorizer=e,this._label=new WS.ScanLabelRenderable,this._categoryLabel=this._label,this._hideLabelBySetting=!1,this._displayed=void 0,WS.SpriteRenderable.call(this,t,i)},WS.ScanRenderable.prototype={setViewingModeOfLabels:function(){this._label.setViewingMode(this._viewingMode)},onViewingModeChange:function(){this.setViewingModeOfLabels()},getMemberRenderables:function(){return[this._label]},setCaption:function(e,t){e=F.shortenString(e,14,4),this._label.setText(e,t)},getPickInfo:function(e,t,i,n){var o=this.getVisibleMemberRenderables(),r=this.getPickInfoOfMemberRenderable(e,t,o,i,n);return void 0!==r?(r.add(this),r):WS.SpriteRenderable.prototype.getPickInfo.apply(this,arguments)},setIconMode:function(e,t){this._categoryLabel.setIconMode(e,t)},updateAppearance:function(e){this._dataObject&&this.setCaption(this._dataObject._displayName,!0),this.updateCategoryLabel(),this.updateIcon(e),this.addToLayer(WS.Layer.LayerIDs.SCANS,!0)},updateCategoryLabel:function(){this._categoryLabel.setDataObject(this._dataObject)},updateIcon:function(e){if(this._categoryLabel){var t=this._dataObject?this._dataObject._category:void 0;if(t){var i=WS.ColorGenerator.intColorFromString(t),n=WS.ColorGenerator.rgbColorFromInt(i);this._categoryLabel.setCategoryColor(n)}else this._categoryLabel.setCategoryColor(void 0);this._categoryLabel.onIconModeChange(e)}},redraw:function(){this._label.redraw()},setHideLabelBySetting:function(e){this._hideLabelBySetting=e}},WS.extend("ScanRenderable","SpriteRenderable"),WS.ScanPanoRenderable=function(e){this._occluded=!1;var t=WS.ScanPanoRenderable.OFFSET_PX,i=WS.ScanPanoRenderable.SIZE_PX_STANDARD,n=new WS.DynamicQuadGeometry;n.setPosition(t[0],t[1],i[0],i[1]);var o=new WS.SpriteMaterial(WS.ScanPanoRenderable.IMAGES.NORMAL,WS.ScanPanoRenderable.SIZE_M_STANDARD,!0);WS.ScanRenderable.call(this,e,n,o)},WS.ScanPanoRenderable.prototype={onViewingModeChange:function(){switch(this._viewingMode){case WS.Renderable.ViewingMode.Normal:this._material.setTextureImages([this._occluded?WS.ScanPanoRenderable.IMAGES.INCONSIDERABLE:WS.ScanPanoRenderable.IMAGES.NORMAL]),this._material._spriteSize=WS.ScanPanoRenderable.SIZE_M_STANDARD;break;case WS.Renderable.ViewingMode.Highlighted:this._material.setTextureImages([WS.ScanPanoRenderable.IMAGES.HIGHLIGHTED]),this._material._spriteSize=WS.ScanPanoRenderable.SIZE_M_STANDARD;break;case WS.Renderable.ViewingMode.Selected:this._material.setTextureImages([WS.ScanPanoRenderable.IMAGES.SELECTED]),this._material._spriteSize=WS.ScanPanoRenderable.SIZE_M_INCREASED;break;case WS.Renderable.ViewingMode.Inconsiderable:this._material.setTextureImages([WS.ScanPanoRenderable.IMAGES.INCONSIDERABLE]),this._material._spriteSize=WS.ScanPanoRenderable.SIZE_M_STANDARD;break;case WS.Renderable.ViewingMode.Displayed:this._material.setTextureImages([WS.ScanPanoRenderable.IMAGES.DISPLAYED]),this._material._spriteSize=WS.ScanPanoRenderable.SIZE_M_STANDARD}WS.ScanRenderable.prototype.onViewingModeChange.call(this)},getVisibleMemberRenderables:function(){var e=[];return this._hideLabelBySetting||e.push(this._label),e},draw3d:function(e,t){t(this)&&(WS.Mesh.prototype.draw3d.call(this,e,t,!0),this._hideLabelBySetting||this.drawMemberRenderables3d(e,t,!0))},draw2d:function(e,t){t(this)&&(WS.SpriteRenderable.prototype.draw2d.call(this,e,t,!0),this._hideLabelBySetting||this.drawMemberRenderables2d(e,t,!0))},setOcclusion:function(e){this._label.setOcclusion(e),this._occluded!==e&&(this._occluded=e,this._viewingMode===WS.Renderable.ViewingMode.Normal&&this._material.setTextureImages([this._occluded?WS.ScanPanoRenderable.IMAGES.INCONSIDERABLE:WS.ScanPanoRenderable.IMAGES.NORMAL]))}},WS.extend("ScanPanoRenderable","ScanRenderable"),WS.ScanPanoRenderable.IMAGES={NORMAL:new WS.Image(WS.imgUrlCanvasSafe("pano_marker_white.png")),INCONSIDERABLE:new WS.Image(WS.imgUrlCanvasSafe("pano_marker_white_tr.png")),SELECTED:new WS.Image(WS.imgUrlCanvasSafe("pano_marker_active.png")),HIGHLIGHTED:new WS.Image(WS.imgUrlCanvasSafe("pano_marker_ye.png")),DISPLAYED:new WS.Image(WS.imgUrlCanvasSafe("pano_marker_orange.png"))},WS.ScanPanoRenderable.SIZE_M_STANDARD=vec2.create([.34,.5]),WS.ScanPanoRenderable.SIZE_M_INCREASED=vec2.create([.408,.6]),WS.ScanPanoRenderable.SIZE_PX_STANDARD=vec2.create([170,250]),WS.ScanPanoRenderable.OFFSET_PX=vec2.create([85,9]),WS.ScanMapRenderable=function(e){this._color=[1,1,1,1],this._canvas=document.createElement("canvas"),this._hideLabelByCluster=!0,this._marker=void 0,this.setImage(WS.ScanMapRenderable.IMAGES.NORMAL);var t=WS.ScanMapRenderable.OFFSET,i=WS.ScanMapRenderable.SIZE,n=new WS.DynamicQuadGeometry;n.setPosition(t[0],t[1],i[0],i[1]);var o=new WS.SpriteMaterial(void 0,i,!1);WS.ScanRenderable.call(this,e,n,o)},WS.ScanMapRenderable.prototype={onViewingModeChange:function(){switch(this._viewingMode){case WS.Renderable.ViewingMode.Normal:this.setImage(WS.ScanMapRenderable.IMAGES.NORMAL);break;case WS.Renderable.ViewingMode.Highlighted:this.setImage(WS.ScanMapRenderable.IMAGES.HIGHLIGHTED);break;case WS.Renderable.ViewingMode.Selected:this.setImage(WS.ScanMapRenderable.IMAGES.SELECTED);break;case WS.Renderable.ViewingMode.Inconsiderable:this.setImage(WS.ScanMapRenderable.IMAGES.INCONSIDERABLE);break;case WS.Renderable.ViewingMode.Displayed:this.setImage(WS.ScanMapRenderable.IMAGES.DISPLAYED);break;default:this.setImage(WS.ScanMapRenderable.IMAGES.NORMAL)}WS.ScanRenderable.prototype.onViewingModeChange.call(this),this.updateImage()},onImageLoad:function(){this.updateImage()},setImage:function(e){this._image=e,e.isLoaded()||e.addListener(this)},getVisibleMemberRenderables:function(){var e=[];return this._hideLabelBySetting||this._hideLabelByCluster||e.push(this._label),e},updateImage:function(){this.renderToCanvas();var e=this._canvas.toDataURL();this._marker&&this._marker.setIconByUrl(e)},draw3d:function(e,t){t(this)&&(this._hideLabelBySetting||this._hideLabelByCluster||this.drawMemberRenderables3d(e,t,!0))},draw2d:function(e,t){t(this)&&(this._hideLabelBySetting||this._hideLabelByCluster||this.drawMemberRenderables2d(e,t,!0))},renderToCanvas:function(){var e=this._canvas.getContext("2d"),t=WS.ScanMapRenderable.SIZE[0],i=WS.ScanMapRenderable.SIZE[1];e.canvas.width=t,e.canvas.height=i;var n=16,o=14,r=9,a=e.createLinearGradient(n-2*r,o-2*r,n+r,o+r);a.addColorStop(0,"white"),a.addColorStop(1,WS.Renderer2D.colorToStyle(this._color)),e.fillStyle=a,e.beginPath(),e.arc(n,o,r,0,2*Math.PI,!1),e.fill(),e.strokeStyle=WS.Renderer2D.colorToStyle([.33,.33,.33,1]),e.lineWidth=2,e.stroke();var s=this._image.getRawImage();s&&e.drawImage(s,0,0,t,i)},getPickInfo:function(e,t,i,n){var o=this.getVisibleMemberRenderables(),r=this.getPickInfoOfMemberRenderable(e,t,o,i,n);return void 0!==r?(r.add(this),r):void 0},updateAppearance:function(e){WS.ScanRenderable.prototype.updateAppearance.call(this,e),this.updateColor(!0),e||this.updateImage()},updateColor:function(e){if(this._dataObject){var t=this._scanColorizer.getScanTileColor(this._dataObject._UUID);if(this._color=[t.r/255,t.g/255,t.b/255,1],e)return;this.updateImage()}},redraw:function(){WS.ScanRenderable.prototype.redraw.call(this),this.updateImage()},setHideLabelByCluster:function(e){this._hideLabelByCluster=e},setMarker:function(e){this._marker=e}},WS.extend("ScanMapRenderable","ScanRenderable"),WS.ScanMapRenderable.SIZE=vec2.create([32,45]),WS.ScanMapRenderable.OFFSET=vec2.create([16,3]),WS.ScanMapRenderable.IMAGES={NORMAL:new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_white.png")),INCONSIDERABLE:new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_white.png")),SELECTED:new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_bl.png")),HIGHLIGHTED:new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_ye.png")),DISPLAYED:new WS.Image(WS.imgUrlCanvasSafe("icons/im/map_marker_or.png"))},WS.ScanMapRenderable.prefetchIcons=function(){var e=[WS.ScanMapRenderable.IMAGES.NORMAL,WS.ScanMapRenderable.IMAGES.INCONSIDERABLE,WS.ScanMapRenderable.IMAGES.SELECTED,WS.ScanMapRenderable.IMAGES.HIGHLIGHTED,WS.ScanMapRenderable.IMAGES.DISPLAYED];e.forEach(function(e){e.addListener({onImageLoad:function(){}})})},WS.GlBuffer=function(e,t){this._ctx=t,this._buffer=e,this._bufferID=-1,this.createBuffer(),this._buffer.addListener(this)},WS.GlBuffer.prototype={onDataChange:function(){this.uploadData()},getArrayConstructorFromDataType:function(e){return e===WS.Buffer.ItemDataType.FLOAT?Float32Array:e===WS.Buffer.ItemDataType.USHORT?Uint16Array:e===WS.Buffer.ItemDataType.UBYTE?Uint8Array:void 0},createBuffer:function(){-1===this._bufferID&&(this._bufferID=this._ctx.createBuffer())},uploadData:function(){var e=this._ctx,t=this._buffer;if(t){var i=this.getArrayConstructorFromDataType(t._itemDataType);if(-1!==this._bufferID){var n;return n=t._bufferData instanceof i?t._bufferData:new i(t._bufferData),this.bindBuffer(),e.bufferData(e[t._bufferType],n,e.STATIC_DRAW),this.unbindBuffer(),!0}return!1}},destroy:function(){this._buffer&&this._buffer.removeListener(this),-1!==this._bufferID&&(this._ctx.deleteBuffer(this._bufferID),this._bufferID=-1)},bindBuffer:function(){this._ctx.bindBuffer(this._ctx[this._buffer._bufferType],this._bufferID)},unbindBuffer:function(){this._ctx.bindBuffer(this._ctx[this._buffer._bufferType],null)},useBufferAsAttribInput:function(e){var t=this._ctx,i=this._buffer;i&&t&&(this.bindBuffer(),t.vertexAttribPointer(e,i._itemSize,t[i._itemDataType],!1,i._stride,i._offset),t.enableVertexAttribArray(e))}},WS.extend("GlBuffer","Object"),WS.GlTexture=function(e,t,i){this._magFilter=WS.Image.Filter.Linear,this._minFilter=WS.Image.Filter.Linear,this._wrapS="CLAMP_TO_EDGE",this._wrapT="CLAMP_TO_EDGE",this._format=t||"RGBA",this._type=i||"UNSIGNED_BYTE",this._flipY=!0,this._ctx=e,this._textureID=-1,this.createTexture()},WS.GlTexture.prototype={createTexture:function(){-1===this._textureID&&(this._textureID=this._ctx.createTexture())},uploadParameter:function(){var e=this._ctx;-1!==this._textureID&&(e.bindTexture(e.TEXTURE_2D,this._textureID),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e[this._magFilter]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e[this._minFilter]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e[this._wrapS]),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e[this._wrapT]),e.bindTexture(e.TEXTURE_2D,null))},activateTexture:function(e){var t=this._ctx;return-1!==this._textureID?(t.activeTexture(t.TEXTURE0+e),t.bindTexture(t.TEXTURE_2D,this._textureID),!0):!1},destroy:function(){var e=this._ctx;-1!==this._textureID&&(e.deleteTexture(this._textureID),this._textureID=-1)},getWidth:function(){},getHeight:function(){}},WS.extend("GlTexture","Object"),WS.GlTexture.getMaxSize=function(){if("undefined"==typeof WS.GlTexture.getMaxSize._value){var e=document.createElement("canvas"),t=F.getGLContext(e);WS.GlTexture.getMaxSize._value=t?t.getParameter(t.MAX_TEXTURE_SIZE):0}return WS.GlTexture.getMaxSize._value},WS.GlTexture.getMaxWidth=function(){return WS.GlTexture.getMaxSize()},WS.GlTexture.getMaxHeight=function(){return WS.GlTexture.getMaxSize()},WS.GlBlankTexture=function(e,t,i,n){WS.GlTexture.call(this,i,n?"DEPTH_COMPONENT":"RGBA",n?"UNSIGNED_SHORT":"UNSIGNED_BYTE"),this._width=e,this._height=t,this.uploadParameter(),this.upload()},WS.GlBlankTexture.prototype={upload:function(){var e=this._ctx;return 0<this.getWidth()&&0<this.getHeight()&&-1!==this._textureID?(e.bindTexture(e.TEXTURE_2D,this._textureID),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,this._flipY),e.texImage2D(e.TEXTURE_2D,0,e[this._format],this.getWidth(),this.getHeight(),0,e[this._format],e[this._type],null),e.bindTexture(e.TEXTURE_2D,null),!0):!1},getWidth:function(){return this._width},getHeight:function(){return this._height},resize:function(e,t){this._width=e,this._height=t,this.upload()}},WS.extend("GlBlankTexture","GlTexture"),WS.GlImageTexture=function(e,t){WS.GlTexture.call(this,t),this._image=e,this._imageUploaded=!1,this.extractParameterFromImage(),this.uploadParameter(),this._image.addListener(this)},WS.GlImageTexture.prototype={isImageUploaded:function(){return this._imageUploaded},uploadImage:function(){var e=this._image?this._image.getRawImage():void 0,t=this._ctx;return e&&e.complete&&-1!==this._textureID?(t.bindTexture(t.TEXTURE_2D,this._textureID),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,this._flipY),t.texImage2D(t.TEXTURE_2D,0,t[this._format],t[this._format],t[this._type],e),t.bindTexture(t.TEXTURE_2D,null),this._imageUploaded=!0,!0):!1},onImageLoad:function(){this.uploadImage()},onParameterChange:function(){this.extractParameterFromImage(),this.uploadParameter()},extractParameterFromImage:function(){var e=this._image;e&&(this._magFilter=e._filter,this._minFilter=e._filter)},getWidth:function(){return this._image?this._image.getWidth():0},getHeight:function(){return this._image?this._image.getHeight():0},destroy:function(){this._image&&this._image.removeListener(this),WS.GlTexture.prototype.destroy.call(this),this._imageUploaded=!1}},WS.extend("GlImageTexture","GlTexture"),WS.FrameBuffer=function(e,t,i){if(t=t||1,i=i||!1,t>1){F.getGLExtension(e,"EXT_draw_buffers")}if(i){F.getGLExtension(e,"WEBGL_depth_texture")}var n=e.canvas.width||64,o=e.canvas.height||64,r=e.createFramebuffer();e.bindFramebuffer(e.FRAMEBUFFER,r);for(var a=[],s=0;t>s;s++){var c=new WS.GlBlankTexture(n,o,e);c._magFilter=c._minFilter=WS.Image.Filter.Nearest,c.uploadParameter(),a[s]=c,e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0+s,e.TEXTURE_2D,a[s]._textureID,0)}e.bindTexture(e.TEXTURE_2D,null);var l,h;i?(l=new WS.GlBlankTexture(n,o,e,!0),l._magFilter=l._minFilter=WS.Image.Filter.Nearest,l.uploadParameter(),e.bindTexture(e.TEXTURE_2D,l._textureID),e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,l._textureID,0),e.bindTexture(e.TEXTURE_2D,null)):(h=e.createRenderbuffer(),e.bindRenderbuffer(e.RENDERBUFFER,h),e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,n,o),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,h)),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null),this._ctx=e,this._width=n,this._height=o,this._textures=a,this._depthTexture=l,this._depthBufferID=h,this._framebufferID=r,this._camMatrix=void 0},WS.FrameBuffer.prototype={bind:function(){this._ctx.bindFramebuffer(this._ctx.FRAMEBUFFER,this._framebufferID)},unbind:function(){this._ctx.bindFramebuffer(this._ctx.FRAMEBUFFER,null)},destroy:function(){var e=this._ctx;e.bindFramebuffer(e.FRAMEBUFFER,null),e.bindRenderbuffer(e.RENDERBUFFER,null),this._textures.forEach(function(e){e.destroy()}),this._textures=[],this._depthTexture&&this._depthTexture.destroy(),this._depthTexture=void 0,this._depthBufferID&&e.deleteRenderbuffer(this._depthBufferID),this._depthBufferID=void 0,this._framebufferID&&e.deleteFramebuffer(this._framebufferID),this._framebufferID=void 0},updateSize:function(e,t){if(!(0>=e||0>=t)&&(this._width=e,this._height=t,this._textures.forEach(function(i){i.resize(e,t)}),this._depthTexture&&this._depthTexture.resize(e,t),this._depthBufferID)){var i=this._ctx;i.bindRenderbuffer(i.RENDERBUFFER,this._depthBufferID),i.renderbufferStorage(i.RENDERBUFFER,i.DEPTH_COMPONENT16,e,t),i.bindRenderbuffer(i.RENDERBUFFER,null)}},readTexture:function(e,t,i,n,o){return i=i||1,n=n||1,o=o||new Uint8Array(i*n*4),this.bind(),this._ctx.readPixels(e,t,i,n,this._ctx.RGBA,this._ctx.UNSIGNED_BYTE,o),this.unbind(),o},readClosestOpaquePixel:function(e,t,i,n){n=n||function(){return!0};for(var o,r=2*i+1,a=this.readTexture(e-i,t-i,r,r),s=Number.MAX_VALUE,c=0;r>c;c++)for(var l=(c-i)*(c-i),h=0;r>h;h++){var d=4*(h*r+c),u=a.subarray(d,d+4),p=l+(h-i)*(h-i);0<u[3]&&s>p&&n(u)&&(o=u,s=p)}return o||new Uint8Array([0,0,0,0])}},WS.extend("FrameBuffer","Object"),WS.TextureStorage=function(e){this._textures={},this._ctx=e},WS.TextureStorage.prototype={inquireTexture:function(e,t){if(!e)return void 0;var i=this._textures[e._id];return i||(i=new t(e,this._ctx),this._textures[e._id]=i),i},deleteTexture:function(e){if(e){var t=this._textures[e._id];t&&(t.destroy(),delete this._textures[e._id])}},deleteAllTextures:function(){for(var e in this._textures)this._textures.hasOwnProperty(e)&&this._textures[e].destroy();this._textures={}},isEmpty:function(){return 0===Object.keys(this._textures).length}},WS.extend("TextureStorage"),WS.Shader=function(e,t,i,n){var o="boolean"==typeof n?n:!0;this._shaderID=-1,this._ctx=e,this._type=t,this._shaderSrc=i,this._compiled=void 0,o&&this.compileShader()},WS.Shader.prototype={compileShader:function(){var e=this._ctx;this._shaderID=e.createShader(this._type===WS.Shader.Type.Fragment?e.FRAGMENT_SHADER:e.VERTEX_SHADER),e.shaderSource(this._shaderID,this._shaderSrc),e.compileShader(this._shaderID);var t=e.getShaderParameter(this._shaderID,e.COMPILE_STATUS);if(this._compiled=!!t,!t){var i=console;i.log(e.getShaderInfoLog(this._shaderID))}},isValid:function(){return-1!==this._shaderID},deleteShader:function(){this.isValid()&&(this._ctx.deleteShader(this._shaderID),this._shaderID=-1)}},WS.extend("Shader"),WS.Shader.Type={Vertex:"VERTEX",Fragment:"FRAGMENT"},WS.VertexShader=function(e,t,i){WS.Shader.call(this,e,WS.Shader.Type.Vertex,t,i)},WS.extend("VertexShader","Shader"),WS.FragmentShader=function(e,t,i){WS.Shader.call(this,e,WS.Shader.Type.Fragment,t,i)},WS.extend("FragmentShader","Shader"),WS.ShaderAttribute=function(e,t,i){this._name=e,this._type=t,this._id=i,this._value=void 0},WS.extend("ShaderAttribute"),WS.ShaderAttributes=function(){this._elements={}},WS.ShaderAttributes.prototype={addAttribute:function(e){this._elements[e._name]=e},getAttribute:function(e){return this._elements[e]},getAttributes:function(){return this._elements}},WS.extend("ShaderAttributes"),WS.ShaderProgram=function(e,t,i,n){var o,r;this._vertexShader=void 0,this._fragmentShader=void 0,this._programID=void 0,this._attributes=void 0,this._uniforms=void 0,this._name=t,this._failSafe=!!n,this._ctx=e;var a=console,s=i.getDefines(e);n&&(s=["#define FAILSAFE"].concat(s)),o=s.concat([i._vertexShader]).join("\n"),r=s.concat([i._fragmentShader]).join("\n"),this._vertexShader=new WS.VertexShader(e,o,!0),this._fragmentShader=new WS.FragmentShader(e,r,!0),this._vertexShader._compiled||a.error("VS compile error:",t),this._fragmentShader._compiled||a.error("FS compile error:",t),this._compiled=this.compileProgram(),n&&a.log("tried failsafe mode:",t,"success:",this._compiled),this._compiled&&(this.extractAttributes(),this.extractUniforms())},WS.ShaderProgram.prototype={invalidateValues:function(){if(this._compiled){var e=this._uniforms.getUniforms();for(var t in e)this._uniforms.getUniform(t)._value=void 0}},compileProgram:function(){this._programID=this._ctx.createProgram(),this._ctx.attachShader(this._programID,this._vertexShader._shaderID),this._ctx.attachShader(this._programID,this._fragmentShader._shaderID),this._ctx.linkProgram(this._programID);var e=this._ctx.getProgramParameter(this._programID,this._ctx.LINK_STATUS);if(!e){var t=console;t.log(this._ctx.getProgramInfoLog(this._programID)),t.error("Shader link error:",this._name)}return!!e},setAttributeValue:function(e,t){var i=this._attributes.getAttribute(e);return i._value=t,this.uploadAttributeValue(i),!0},setUniformValue:function(e,t){var i=this._uniforms.getUniform(e);return i._value!==t&&(i._value=t,this.uploadUniformValue(i)),!0},uploadAttributeValue:function(e){var t,i,n,o=this._ctx;i=e._value,void 0!==i&&(i.instanceOf&&i.instanceOf(WS.GlBuffer)?(n=i,n.useBufferAsAttribInput(e._id)):(i instanceof Array||"number"==typeof i)&&(t=WS.ShaderProgram._attributeFunctions[e._type],o.disableVertexAttribArray(e._id),o[t](e._id,i)))},uploadUniformValue:function(e){var t,i,n,o,r=this._ctx;t=e._value,i=WS.ShaderProgram._uniformFunctions[e._type],void 0!==t&&(t.instanceOf&&t.instanceOf(WS.TextureValue)?(n=t._texture,o=t._textureUnit,n.activateTexture(o),r[i](e._id,o)):e._type===r.FLOAT_MAT2||e._type===r.FLOAT_MAT3||e._type===r.FLOAT_MAT4?r[i](e._id,!1,new Float32Array(t)):e._type===r.FLOAT_VEC2||e._type===r.FLOAT_VEC3||e._type===r.FLOAT_VEC4?r[i](e._id,new Float32Array(t)):r[i](e._id,t))},disableAttributeArrays:function(){if(this._compiled){var e=this._ctx,t=this._attributes.getAttributes();for(var i in t){var n=this._attributes.getAttribute(i),o=n._value;o&&o.instanceOf&&o.instanceOf(WS.GlBuffer)&&e.disableVertexAttribArray(n._id)}}},activateProgram:function(){return this.isActive()||(this.setActive(),this._ctx.useProgram(this._programID)),this},deactivateProgram:function(){this.setInactive(),this.disableAttributeArrays()},destroy:function(){this.deactivateProgram(),-1!=this._programID&&(this._ctx.deleteProgram(this._programID),this._vertexShader.deleteShader(),this._fragmentShader.deleteShader())},isActive:function(){return WS.ShaderProgram._activeProgram===this},setActive:function(){WS.ShaderProgram._activeProgram=this},setInactive:function(){this.isActive()&&(WS.ShaderProgram._activeProgram=void 0)},extractAttributes:function(){var e,t,i,n,o,r=this._ctx;for(this._attributes=new WS.ShaderAttributes,n=r.getProgramParameter(this._programID,r.ACTIVE_ATTRIBUTES),o=0;n>o;o++)e=r.getActiveAttrib(this._programID,o),t=r.getAttribLocation(this._programID,e.name),i=new WS.ShaderAttribute(e.name,e.type,t),this._attributes.addAttribute(i)},extractUniforms:function(){var e,t,i,n,o=this._ctx;this._uniforms=new WS.ShaderUniforms,n=o.getProgramParameter(this._programID,o.ACTIVE_UNIFORMS);for(var r=0;n>r;r++)e=o.getActiveUniform(this._programID,r),t=o.getUniformLocation(this._programID,e.name),i=new WS.ShaderUniform(e.name,e.type,t),this._uniforms.addUniform(i)}},WS.extend("ShaderProgram"),WS.ShaderProgram._activeProgram=void 0,WS.ShaderProgram._uniformFunctions={5126:"uniform1f",5124:"uniform1i",35664:"uniform2fv",35665:"uniform3fv",35666:"uniform4fv",35667:"uniform2iv",35668:"uniform3iv",35669:"uniform4iv",35674:"uniformMatrix2fv",35675:"uniformMatrix3fv",35676:"uniformMatrix4fv",35678:"uniform1i",35670:"uniform1i",35671:"uniform2i",35672:"uniform3i",35673:"uniform4i"},WS.ShaderProgram._attributeFunctions={5126:"vertexAttrib1f",35664:"vertexAttrib2fv",35665:"vertexAttrib3fv",35666:"vertexAttrib4fv"},WS.ShaderProgramStorage=function(e){this._compiledShaderPrograms={},this._ctx=e},WS.ShaderProgramStorage.prototype={inquireShaderProgram:function(e){var t=e.ID,i=this._compiledShaderPrograms[t];if(!i){var n=new e;i=new WS.ShaderProgram(this._ctx,t,n),i._compiled||(i=new WS.ShaderProgram(this._ctx,t,n,!0)),this._compiledShaderPrograms[t]=i}return i},deleteAllShaderPrograms:function(){for(var e in this._compiledShaderPrograms)this._compiledShaderPrograms[e]&&this._compiledShaderPrograms[e].destroy();this._compiledShaderPrograms={}},isEmpty:function(){return 0===Object.keys(this._compiledShaderPrograms).length}},WS.extend("ShaderProgramStorage"),WS.BufferStorage=function(e){this._buffers={},this._ctx=e},WS.BufferStorage.prototype={inquireBuffer:function(e){var t;return t=this._buffers[e._id],t||(t=new WS.GlBuffer(e,this._ctx),this._buffers[e._id]=t),t},deleteAllBuffers:function(){var e,t;for(e in this._buffers)t=this._buffers[e],t&&t.destroy();this._buffers={}},deleteBuffer:function(e){var t=this._buffers[e._id];t&&(t.destroy(),delete this._buffers[e._id])},isEmpty:function(){return 0===Object.keys(this._buffers).length}},WS.extend("BufferStorage"),WS.FrameBufferStorage=function(e){this._ctx=e,this._buffers={}},WS.FrameBufferStorage.prototype={get:function(e,t){return this._buffers[e]||(t=t||WS.FrameBuffer,this._buffers[e]=new t(this._ctx)),this._buffers[e]},getIDs:function(){return Object.keys(this._buffers)},destroy:function(e){this._buffers[e]&&(this._buffers[e].destroy(),delete this._buffers[e])},destroyAll:function(){Object.keys(this._buffers).forEach(F.proxy(this.destroy,this))},updateSizes:function(){var e=this._ctx.canvas.width,t=this._ctx.canvas.height;if(!(0>=e||0>=t))for(var i in this._buffers){var n=this._buffers[i];n.updateSize(e,t)}}},WS.extend("FrameBufferStorage"),WS.GlViewport=function(e,t,i){WS.Viewport.call(this,t,i),this._ctx=e},WS.GlViewport.prototype={use:function(){this._ctx.viewport(0,0,this.getWidth(),this.getHeight())}},WS.extend("GlViewport","Viewport"),WS.Renderer3D=function(e,t,i,n){WS.RendererBase.call(this,t,i),this._errorHandler=n,this._depthTest=void 0,this._depthWrite=void 0,this._enableVertexPointSize=void 0,this._enableBlending=void 0,this._cullFace=void 0,this._ctx=e,this._activeShaderProgram=void 0,this._shaderProgramStorage=new WS.ShaderProgramStorage(this._ctx),this._textureStorage=new WS.TextureStorage(this._ctx),this._bufferStorage=new WS.BufferStorage(this._ctx),this._drawVisitor=new WS.RenderVisitor(this,"draw3d",void 0,this._view),this._shaderPrograms={},this._frameBufferStorage=new WS.FrameBufferStorage(e),this._dummyTexture=new WS.GlBlankTexture(16,16,e),this._rgbDepthTest=!1,this._rgbDepthTexture=this._dummyTexture,this._renderColorMode=WS.RendererBase.RenderMode.DEFAULT,this._pickColorBuffer=new WS.ArrayBuffer([],4,WS.Buffer.ItemDataType.UBYTE),this._gapfiller=void 0,this._gfRenderables={},this._gfResultRenderables={},this._dbgGapFillAll=!1,this.setEnableDepthTest(!0),this.setEnableDepthWrite(!0),this.setEnableBlending(!1),this.setDefaultBlendFunc(),this.setViewPort(new WS.GlViewport(this._ctx,e.canvas.width,e.canvas.height)),this.setClearColor([1,1,1,0]),this.clear()},WS.Renderer3D.prototype={destroy:function(){this.clearStorage()},clearStorage:function(){this._textureStorage.deleteAllTextures(),this._bufferStorage.deleteAllBuffers(),this._frameBufferStorage.destroyAll(),this._gfRenderables={},this._gfResultRenderables={},this._shaderProgramStorage.deleteAllShaderPrograms(),this._shaderPrograms={}},invalidateShaderValues:function(){for(var e in this._shaderPrograms)this._shaderPrograms[e].invalidateValues()},drawScene:function(e,t,i,n,o){o=o||{};var r,a=o.destFB,s=o.bufferPrefix||"";o.rgbDepthTest&&(r=this._frameBufferStorage.get(s+"post_gf_depth")._textures[0]);var c=o.colorMode;a&&a.bind();var l;c&&(this.setRenderColorMode(c),c===WS.RendererBase.RenderMode.DEPTH&&(l=F.cloneArray(this._clearColor),this.setClearColor(WS.Renderer3D.DEPTH_CLEARCOLOR))),r&&this.enableRGBDepthTest(!0,r),this.invalidateShaderValues(),WS.RendererBase.prototype.drawScene.apply(this,arguments),a&&a.unbind(),c&&this.setRenderColorMode(WS.RendererBase.RenderMode.DEFAULT),l&&this.setClearColor(l),r&&this.enableRGBDepthTest(!1)},drawSceneIncremental:function(e,t,i,n,o){void 0===this._gapfiller&&this.testGFSupport(),void 0===i&&(i=WS.PointCloudRenderable.Draw.ALL),o=o||{};var r,a=o.bufferPrefix||"",s=o.colorMode,c=s===WS.RendererBase.RenderMode.PICK_3D||s===WS.RendererBase.RenderMode.PICK_3D_POINT,l=o.reuseDepth,h=this._drawVisitor._layerService.getZIndexOfLayer(WS.Layer.LayerIDs.POINT_CLOUD,this._view),d=[h],u=this._zIndices.filter(function(e){return h>e}),p=this._zIndices.filter(function(e){return e>h}),_=this._gapfiller?"pre_gf_":"post_gf_",g=this._frameBufferStorage.get(a+_+"color"),f=this._frameBufferStorage.get(a+_+"depth");if(i!==WS.PointCloudRenderable.Draw.KEEP&&(r=i===WS.PointCloudRenderable.Draw.ADD,this.drawScene(e,t,r,n,{zIndices:d,destFB:g,colorMode:s})),l||i===WS.PointCloudRenderable.Draw.KEEP||(r=i===WS.PointCloudRenderable.Draw.ADD,this.drawScene(e,t,r,n,{zIndices:d,destFB:f,colorMode:WS.RendererBase.RenderMode.DEPTH})),(i!==WS.PointCloudRenderable.Draw.KEEP||this._dbgGapFillAll)&&(this._gapfiller?this.fillGaps(a,s):f._camMatrix=mat4.create(this._camera._camMatrix)),!c){this.drawScene(e,t,!1,n,{zIndices:u});var m=this.getGFResultRenderable(a);this.applyEffect(m),this.drawScene(e,t,!0,n,{bufferPrefix:a,zIndices:p,rgbDepthTest:!0})}},applyEffect:function(e,t){t=t||{};var i=t.destFB,n=t.colorMode;i&&i.bind(),n&&this.setRenderColorMode(n),e.draw3d(this,function(){return!0},!0),i&&i.unbind(),n&&this.setRenderColorMode(WS.RendererBase.RenderMode.DEFAULT)},updateDetailLevel:function(e){var t=e===WS.PanoSettings.Detail3d.MEDIUM||e===WS.PanoSettings.Detail3d.HIGH||e===WS.PanoSettings.Detail3d.VERY_HIGH;
if(this._gapfiller=t?void 0:"",!t){var i=this._frameBufferStorage;i.getIDs().forEach(function(e){(e.indexOf("pre_gf_")>=0||e.indexOf("tmp_")>=0)&&i.destroy(e)}),this._gfRenderables={}}},getGFShader:function(){switch(WS.Renderer3D.GAPFILLER){case"s":return WS.FXGapFillerScene;case"op2":return WS.FXGapFillerOP2}},gapFillerEnabled:function(){return void 0===this._gapfiller&&this.testGFSupport(),!!this._gapfiller},testGFSupport:function(){if(WS.Renderer3D.GAPFILLER){var e=this._shaderProgramStorage.inquireShaderProgram(this.getGFShader());this._gapfiller=e._compiled?WS.Renderer3D.GAPFILLER:""}else this._gapfiller=""},getGFRenderable:function(e,t,i){var n;switch(i){case-1:n=e+"pre_gf_";break;case 0:n=e+"post_gf_";break;default:n="tmp_post_gf_"}var o=n+"color",r=n+"depth";if(!this._gfRenderables[o]){var a=this._frameBufferStorage.get(o),s=this._frameBufferStorage.get(r),c=new WS.CenteredQuadGeometry,l=new WS.FXGapFillMaterial(this.getGFShader(),a._textures[0],s._textures[0],t);this._gfRenderables[o]=new WS.Mesh(c,l)}return this._gfRenderables[o]},getGFResultRenderable:function(e){if(!this._gfResultRenderables[e]){var t=this._frameBufferStorage.get(e+"post_gf_color"),i=new WS.CenteredQuadGeometry,n=new WS.FXMaterial(WS.FXShaderDesc,!0,t._textures[0]);this._gfResultRenderables[e]=new WS.Mesh(i,n)}return this._gfResultRenderables[e]},fillGaps:function(e,t){for(var i=WS.Renderer3D.GAPFILL_PASSES[this._gapfiller],n=0;i>n;n++){var o=(i-n)%2===0?1:0,r=n>0?1-o:-1,a=this.getGFRenderable(e,n,r),s=o?"tmp_post_gf_":e+"post_gf_",c=this._frameBufferStorage.get(s+"color"),l=this._frameBufferStorage.get(s+"depth");l._camMatrix=mat4.create(this._camera._camMatrix),c.bind(),this.clear(!0,!0),this.applyEffect(a,{colorMode:t}),c.unbind(),l.bind(),this.clear(!0,!0,WS.Renderer3D.DEPTH_CLEARCOLOR),this.applyEffect(a,{colorMode:WS.RendererBase.RenderMode.DEPTH}),l.unbind()}},updateCanvasObjectDimensions:function(){WS.RendererBase.prototype.updateCanvasObjectDimensions.apply(this,arguments),this._frameBufferStorage.updateSizes()},enableRGBDepthTest:function(e,t){this._rgbDepthTest=e,this._rgbDepthTexture=e?t:this._dummyTexture},setRenderColorMode:function(e){this._renderColorMode=e},setLineWidth:function(e){e===this._lineWidth||F.isIE()||(this._lineWidth=e,this._ctx.lineWidth(e))},setAndPrepareMaterial:function(e){var t=this._renderColorMode===WS.RendererBase.RenderMode.PICK_3D;if(this.setEnableDepthTest(e._depthTest||t),this.setEnableDepthWrite(e._depthWrite||t),this.setEnableBlending(e._transparent&&this._renderColorMode===WS.RendererBase.RenderMode.DEFAULT),this.setCullFace(e._cullFace),!this.areAllTexturesUploaded(e))return!1;var i=this.getShaderProgram(e);if(!i._compiled)return this._errorHandler&&this._errorHandler(),!1;this.setShaderProgram(i),this._material=e;var n=this._material.configureShader(this);return n&&this._material._rgbDepthTestSupport&&!i._failSafe&&this.configureRGBDepthTest(this._material,i),n},configureRGBDepthTest:function(e,t){t.setUniformValue("uDepthTest",this._rgbDepthTest&&e._depthTest),t.setUniformValue("uTexDepth",new WS.TextureValue(this._rgbDepthTexture,1)),t.setUniformValue("uInvViewX",1/this._camera._width),t.setUniformValue("uInvViewY",1/this._camera._height)},setShaderProgram:function(e){this._activeShaderProgram&&this._activeShaderProgram!==e&&this._activeShaderProgram.deactivateProgram(),this._activeShaderProgram=e.activateProgram()},setAndPrepareGeometry:function(e){this._geometry=e},getGlBuffer:function(e,t){return t||1!==e.getCountItems()?this._bufferStorage.inquireBuffer(e):e._bufferData},getTexture:function(e){if(!e)return void 0;var t=this._textureStorage.inquireTexture(e,WS.GlImageTexture);return t},deleteStorageForRenderable:function(e){WS.RendererBase.prototype.deleteStorageForRenderable.call(this,e),e instanceof WS.Mesh&&this.deleteGlBuffersForMesh(e)},deleteGlBuffersForMesh:function(e){this.deleteGlBuffer(e._geometry._positionBuffer),this.deleteGlBuffer(e._geometry._distanceBuffer),this.deleteGlBuffer(e._material._colorBuffer),this.deleteGlBuffer(e._material._coordBuffer),this.deleteGlBuffer(e._material._indexBuffer)},deleteGlBuffer:function(e){e&&this._bufferStorage.deleteBuffer(e)},getShaderProgram:function(e){var t=e._shaderProgramDesc,i=t.ID;return this._shaderPrograms[i]||(this._shaderPrograms[i]=this._shaderProgramStorage.inquireShaderProgram(t)),this._shaderPrograms[i]},drawGeometry:function(){var e,t=this._geometry,i=t._indexBuffer,n=t._positionBuffer,o=this._ctx;if(i&&n){if(e=t.getCountIndices()){var r=this.getGlBuffer(i);r&&(r.bindBuffer(),o.drawElements(o[t._primitiveType],e,o[i._itemDataType],0),r.unbindBuffer())}}else n&&(e=t.getCountPositions(),e&&o.drawArrays(o[t._primitiveType],0,e))},uploadBoolCapability:function(e,t){var i=this._ctx;t?i.enable(i[e]):i.disable(i[e])},setEnableDepthTest:function(e){e!==this._depthTest&&(this._depthTest=e,this.uploadBoolCapability("DEPTH_TEST",this._depthTest))},setEnableDepthWrite:function(e){e!==this._depthWrite&&(this._depthWrite=e,this._ctx.depthMask(this._depthWrite))},setEnableVertexPointSize:function(e){e!==this._enableVertexPointSize&&(this._enableVertexPointSize=e)},setEnableBlending:function(e){e!==this._enableBlending&&(this._enableBlending=e,this.uploadBoolCapability("BLEND",this._enableBlending))},setCullFace:function(e){if(e!==this._cullFace){this._cullFace=e;var t=this._ctx;if(e===WS.Material.Cull.OFF)t.disable(t.CULL_FACE);else switch(t.enable(t.CULL_FACE),t.frontFace(t.CCW),e){case WS.Material.Cull.BACK:t.cullFace(t.BACK);break;case WS.Material.Cull.FRONT:t.cullFace(t.FRONT)}}},setDefaultBlendFunc:function(){var e=this._ctx;e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)},setClearColor:function(e){this._clearColor=e,this._ctx&&this._ctx.clearColor(this._clearColor[0],this._clearColor[1],this._clearColor[2],this._clearColor[3])},clear:function(e,t,i){var n=this._ctx,o=void 0!==e?e:!0,r=void 0!==t?t:!0,a=o?n.COLOR_BUFFER_BIT:0;a|=r?n.DEPTH_BUFFER_BIT:0,r&&this.setEnableDepthWrite(!0);var s;i&&(s=this._clearColor,this.setClearColor(i)),n.clear(a),s&&this.setClearColor(s)}},WS.extend("Renderer3D","RendererBase"),WS.Renderer3D.DEPTH_CLEARCOLOR=[1,1,1,1],WS.Renderer3D.GAPFILLER="op2",WS.Renderer3D.GAPFILL_PASSES={op2:3,s:10},WS.PolygonMaterial=function(e){var t=new WS.ArrayBuffer(e,4);WS.ShaderMaterial.call(this,WS.ColorShaderDesc,!0,!1,!1,void 0,void 0,t)},WS.PolygonMaterial.prototype={configureShader:function(){return!1}},WS.extend("PolygonMaterial","ShaderMaterial"),WS.SpriteShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.sprite_vs,WS.shaderSrc.sprite_fs)},WS.extend("SpriteShaderDesc","BasicShaderDesc"),WS.SpriteShaderDesc.ID="SpriteShader",WS.PickObjectListener=function(e,t,i,n){this._view=e,this._selectionMode=t,this._selection=i,this._alert=n,this._lastSelectedObject=void 0},WS.PickObjectListener.prototype={onObjectClick:function(e,t,i){var n=void 0!==e?e._dataObject:void 0;this.onDataObjectClick(n,t,i)},onDataObjectClick:function(e,t,i){if(!e)return this._selectionMode===WS.PickObjectListener.SelectionMode.Single&&this._lastSelectedObject&&(this._lastSelectedObject.unselect(),this._lastSelectedObject=void 0),void this._view.hideRadialMenu();if(this._selectionMode===WS.PickObjectListener.SelectionMode.None)return void this._alert.tip("IM_NOT_IN_SELECTIONMODE");if(this.isSelectionAllowed(e))switch(this._selectionMode){case WS.PickObjectListener.SelectionMode.Multi:e.toggleSelection();break;case WS.PickObjectListener.SelectionMode.Single:this._lastSelectedObject&&this._lastSelectedObject.unselect(),e.select(),this._lastSelectedObject=e;break;case WS.PickObjectListener.SelectionMode.Menu:this._view.showRadialMenu(e,t,i)}},isSelectionAllowed:function(e){var t=["Scan","Annotation","Measurement","TempMeasurement","Orthophoto"],i=this,n=t.some(function(t){var n=t.toLowerCase();return i._view._allowedSelections&&-1!==i._view._allowedSelections.indexOf(n)&&i._selection.getSelection(t).contains(e)});return n},onObjectsSetSelected:function(e,t){var i={};e.forEach(F.proxy(function(e){var t=e._dataObject;if(this.isSelectionAllowed(t)){var n=t.selection()._identifier;i[n]=i[n]||[],i[n].push(t)}},this));for(var n in i){var o=i[n],r=this._selection.getSelection(n);t?r.selectMulti(o):r.unselectMulti(o)}},onObjectsSelect:function(e){this.onObjectsSetSelected(e,!0)},onObjectsUnselect:function(e){this.onObjectsSetSelected(e,!1)},onObjectDblClick:function(e,t,i,n){var o=void 0!==e?e._dataObject:void 0;this.onDataObjectDblClick(o,t,i,n)},onDataObjectDblClick:function(e,t,i,n){if(this._view.hideRadialMenu(),e)if(e instanceof WS.Scan&&this._view._changeScanAllowed&&(this._view instanceof WS.OverviewMap||!this._view.isObjectRoot(e)))this._view.trigger("showObjects",[[e],"pano/3d"]);else if(e instanceof WS.Measurement&&n&&n._list[0]instanceof WS.ClickableSpriteRenderable){var o=n._list[0]._clickId,r={object:e,root:e._pointScans[o],rootType:"scan",lookAt:e._pointsGlobal[o]};this._view.trigger("focusOn",[r,"pano/3d"])}else if(this._view._type===WS.PanoramaView.type&&this._view._changeScanAllowed){var a={object:e};this._view.trigger("focusOn",[a,"pano/3d"])}},onObjectDragStart:function(e,t,i){this._view.hideRadialMenu(),e._list[0].setDirect(!0),e._list[0].dragStart(t,i)},onObjectDragMove:function(e,t,i,n,o){e._list[0].dragMove(t-n,i-o)},onObjectDragStop:function(e,t,i){e._list[0].setDirect(!1),e._list[0].dragStop(t,i)},getRefSystem:function(){var e=this._view;return e.instanceOf(WS.PanoramaView)?e._root:e.instanceOf(WS.OverviewMap)?e._mapObject:void 0}},WS.extend("PickObjectListener"),WS.PickObjectListener.SelectionMode={None:0,Single:1,Multi:2,Menu:3},WS.TextureShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.texture_vs,WS.shaderSrc.texture_fs)},WS.extend("TextureShaderDesc","BasicShaderDesc"),WS.TextureShaderDesc.ID="TextureShader",WS.FXShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.fx_vs,WS.shaderSrc.fx_fs)},WS.extend("FXShaderDesc","BasicShaderDesc"),WS.FXShaderDesc.ID="FXShader",WS.FXGapFiller=function(e){WS.BasicShaderDesc.call(this,WS.shaderSrc.fx_vs,e)},WS.extend("FXGapFiller","BasicShaderDesc"),WS.FXGapFillerScene=function(){WS.FXGapFiller.call(this,WS.shaderSrc.fxgapfiller_scene_fs)},WS.extend("FXGapFillerScene","FXGapFiller"),WS.FXGapFillerScene.ID="FXGapFillerScene",WS.FXGapFillerOP2=function(){WS.FXGapFiller.call(this,WS.shaderSrc.fxgapfiller_op2_fs)},WS.extend("FXGapFillerOP2","FXGapFiller"),WS.FXGapFillerOP2.ID="FXGapFillerOP2",WS.Point3d=function(e,t,i,n,o){this._class="Point3d",this._UUID=F.generateUUID(),this._estimatedPosition=e,this._localAngles=t,this._refSystem=i,this._takenInView=n,this._3d=o||!1;var r=n._type===WS.OverviewMap.type;this._positionLocal=void 0,this._positionGlobal=o||r?vec3.create(e):void 0,this._pointState=o?WS.Point3d.PointState.Valid:r?WS.Point3d.PointState.ValidXY:WS.Point3d.PointState.Unknown},WS.Point3d.prototype={createRenderable:function(e){switch(e._type){case WS.PanoramaView.type:case WS.OverviewMap.type:return this.createRenderableForView(e)}},createRenderableForView:function(e){var t=e._type===WS.OverviewMap.type,i=new WS.PickPositionRenderable(t);i.setDataObject(this),i.addToLayer(WS.Layer.LayerIDs.TEMP);var n=this;return i.update=function(){var t=n.calcPositionInRefSystem(e._trafoView,!0);i.setTranslation(t),i.setPointState(n._pointState)},i.update(),i},getTrafoGlobal:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,this._positionGlobal[0],this._positionGlobal[1],this._positionGlobal[2],1]},getTrafoLocal:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,this._positionLocal[0],this._positionLocal[1],this._positionLocal[2],1]},calcPositionInRefSystem:function(e,t){var i=this._positionGlobal||t&&this._estimatedPosition||[];return mat4.posInRefSystem(i,e)}},WS.extend("Point3d"),WS.Point3d.PointState={Valid:0,Invalid:1,Unknown:2,Free:3,ValidXY:4},WS.TextureMaterial=function(e,t,i,n,o){this._alpha=void 0!==n?n:1,i=void 0!==i?i:this._alpha<1,WS.ShaderMaterial.call(this,WS.TextureShaderDesc,i,!0,!1,[e],t,void 0,o),this._rgbDepthTestSupport=!0},WS.TextureMaterial.prototype={configureShader:function(e){var t=e._geometry,i=e.getShaderProgram(this);i.setAttributeValue("aVertexPosition",e.getGlBuffer(t._positionBuffer)),i.setUniformValue("uModelMatrix",e.getModelMatrix()),i.setUniformValue("uViewProjectionMatrix",e._camera._camMatrix),i.setUniformValue("uAlpha",this._alpha),i.setAttributeValue("aVertexTextureCoords",e.getGlBuffer(this._coordBuffer));var n=e.getMaterialTextures(this),o=void 0!==n&&n.length>0?n[0]:void 0;return o&&!o.isImageUploaded()?!1:(i.setUniformValue("uTex0",new WS.TextureValue(o,0)),!0)}},WS.extend("TextureMaterial","ShaderMaterial"),WS.SetIconModeVisitor=function(e){this._iconMode=e},WS.SetIconModeVisitor.prototype={visit:function(e){return e.setIconMode&&e.setIconMode(this._iconMode),!0}},WS.extend("SetIconModeVisitor","VisitorBase"),WS.ShowBoxVisitor=function(e){this._show=e},WS.ShowBoxVisitor.prototype={visit:function(e){return e.setShowBox&&e.setShowBox(this._show),!0}},WS.extend("ShowBoxVisitor","VisitorBase"),WS.ShowPolylineVisitor=function(e){this._show=e},WS.ShowPolylineVisitor.prototype={visit:function(e){return e.setShowPolyline&&e.setShowPolyline(this._show),!0}},WS.extend("ShowPolylineVisitor","VisitorBase"),WS.ScanColorVisitor=function(){},WS.ScanColorVisitor.prototype={visit:function(e){return e instanceof WS.ScanMapRenderable&&e.updateColor(),!0}},WS.extend("ScanColorVisitor","VisitorBase"),WS.ScanLabelsVisitor=function(e){this._show=e},WS.ScanLabelsVisitor.prototype={visit:function(e){return e.setHideLabelBySetting&&e.setHideLabelBySetting(!this._show),!0}},WS.extend("ScanLabelsVisitor","VisitorBase"),WS.UpdateLanguageVisitor=function(){},WS.UpdateLanguageVisitor.prototype={visit:function(e){return e.updateLanguage&&e.updateLanguage(),!0}},WS.extend("UpdateLanguageVisitor","VisitorBase"),WS.UpdateUnitVisitor=function(){},WS.UpdateUnitVisitor.prototype={visit:function(e){return e.updateUnit&&e.updateUnit(),!0}},WS.extend("UpdateUnitVisitor","VisitorBase"),WS.ColorMaterial=function(e){var t=e._bufferData[3],i=1>t;WS.ShaderMaterial.call(this,WS.ColorShaderDesc,i,!0,!1,void 0,void 0,e),this._rgbDepthTestSupport=!0},WS.ColorMaterial.prototype={configureShader:function(e){var t=e._camera,i=e._geometry,n=e.getShaderProgram(this),o=e.getModelMatrix(),r=t._camMatrix;return n.setAttributeValue("aVertexPosition",e.getGlBuffer(i._positionBuffer)),n.setAttributeValue("aColor",e.getGlBuffer(this._colorBuffer)),n.setUniformValue("uModelMatrix",o),n.setUniformValue("uViewProjectionMatrix",r),!0}},WS.extend("ColorMaterial","ShaderMaterial"),WS.FXMaterial=function(e,t,i,n){WS.ShaderMaterial.call(this,e,t,!1,!1,void 0,WS.FXMaterial.TexBuffer),this._colorTexValue=new WS.TextureValue(i,0),this._depthTexValue=n?new WS.TextureValue(n,1):void 0},WS.FXMaterial.prototype={configureShader:function(e){{var t=e._geometry,i=e.getShaderProgram(this);this._colorTexValue._texture}return i.setAttributeValue("aVertexPosition",e.getGlBuffer(t._positionBuffer,!0)),i.setAttributeValue("aVertexTextureCoords",e.getGlBuffer(this._coordBuffer)),i.setUniformValue("uTex0",this._colorTexValue),!0},configureRenderer2d:function(){}},WS.extend("FXMaterial","ShaderMaterial"),WS.FXMaterial.TexBuffer=new WS.ArrayBuffer([0,0,0,1,1,0,1,1],2),WS.FXGapFillMaterial=function(e,t,i,n){WS.FXMaterial.call(this,e,!1,t,i),this._gfPass=n},WS.FXGapFillMaterial.prototype={configureShader:function(e){if(!WS.FXMaterial.prototype.configureShader.call(this,e))return!1;var t=e.getShaderProgram(this),i=this._colorTexValue._texture,n=e._camera,o=n._fovY*Math.PI/180,r=2*Math.tan(.5*o),a=r*n._width/n._height;t.setUniformValue("uDepthToFrustumSize",[a,r]);var s=i.getWidth(),c=i.getHeight(),l=1/s,h=1/c;if(t.setUniformValue("uTexSize",[s,c]),t.setUniformValue("uTexDepth",this._depthTexValue),t.setUniformValue("uInterpolate",e._renderColorMode===WS.RendererBase.RenderMode.DEFAULT),t.setUniformValue("uDepthColor",e._renderColorMode===WS.RendererBase.RenderMode.DEPTH),this._shaderProgramDesc===WS.FXGapFillerScene){var d=this._gfPass%2===0;t.setUniformValue("uPixOffset",d?[l,0]:[0,h])}else t.setUniformValue("uInvTexSize",[l,h]);return!0}},WS.extend("FXGapFillMaterial","FXMaterial"),WS.LoginService=function(e,t,i,n,o,r){F.LoginServiceBase.call(this,e,t,i,n),this._localStorage=o;var a=this;r.addEventListener("storage",function(e){"logout"===e.key&&a.resetMe()},!1)},WS.LoginService.prototype={logout:function(){var e=this,t=F.LoginServiceBase.prototype.logout.call(this);return t.then(function(){var t=1-parseInt(e._localStorage.getItem("logout")||0);e._localStorage.setItem("logout",t)}),t},getDomain:function(){var e=this;return this.getMe().then(function(){return e._me?e._me.Domain:null})},isUser:function(){var e=this;return this.getMe().then(function(){return e._me&&e._me.Roles?e._me.Roles.some(function(e){return 3===e.Id}):!1})},isProjectManager:function(){var e=this;return this.getMe().then(function(){return e._me&&e._me.Roles?e._me.Roles.some(function(e){return 1===e.Id}):!1})},isDomainAdmin:function(){var e=this;return this.getMe().then(function(){return e._me&&e._me.Roles?e._me.Roles.some(function(e){return 2===e.Id}):!1})},isProjectManagerorDomainAdmin:function(){return Q.all([this.isProjectManager(),this.isDomainAdmin()]).then(function(e){return e.some(function(e){return e})})},getMe:function(e){return WS._2GO?(this._me=void 0,this._meDefer||(this._meDefer=Q.defer(),this._meDefer.resolve()),this._meDefer.promise):F.LoginServiceBase.prototype.getMe.call(this,e)}},WS.extend("LoginService","LoginServiceBase"),WS.UserService=function(e,t,i,n,o,r){F.UserServiceBase.call(this,e,t,i,n,o,r,WS.User),this._filter=function(e){return e._active}},WS.extend("UserService","UserServiceBase"),WS.User=function(e){F.UserBase.call(this,e),this._groups=[],this._roles=[],this._groupids=null,this._roleids=null},WS.User.prototype={readJson:function(e){F.UserBase.prototype.readJson.call(this,e),this._active=e.Active,null!==e.GroupIds&&(this._groupids=e.GroupIds),null!==e.RoleIds&&(this._roleids=e.RoleIds)},writeJson:function(){var e=F.UserBase.prototype.writeJson.call(this);return e.Class="User",e}},WS.extend("User","UserBase"),WS.User.getStringIDForKey=function(e){switch(e){case"_firstname":case"_lastname":case"_middlename":case"_units":case"_language":return"FE"+e.toUpperCase();case"_areaunit":return"FE_AREA_UNIT";case"_angleUnit":return"FE_ANGLE_UNIT";case"_coordSystem":return"FE_CS"}return""},WS.Usersettings=function(){F.UserSettingsBase.call(this)},WS.Usersettings.prototype={writeJson:function(){var e=F.UserSettingsBase.prototype.writeJson.call(this);return e.Class="Usersettings",e}},WS.extend("Usersettings","UserSettingsBase"),WS.UserSettingsTask=function(e,t,i,n,o,r,a,s,c){WS.Task.call(this,e),this._userService=t,this._accountService=i,this._unitService=n,this._loginService=o,this._localeService=r,this._error=a,this._alert=s,this._localUserSettings=c,this._plugHandle=void 0,this._description=[{caption:"TC_EDIT_SETTINGS",optional:!0,description:"TD_EDIT_SETTINGS",selectPageClass:"useraccount",widget:'<p ng-show="changesAvailable()" style="font-weight: bold;">{{\'TD_CHANGES\' | i18n}}</p><ul><li ng-repeat="(key, value) in input.user._changes">{{getKey(key)}}: {{value}}</li><li ng-repeat="(key, value) in input.settings._changes">{{getKey(key)}}: {{mapValue(value)}}</li><li ng-show="input.requestPassword">{{\'FE_REQUEST_PWD_RESET\' | i18n}}</li></ul>',icon:WS.Icons.TaskSection.configure}]},WS.UserSettingsTask.prototype={setup:function(e){this.$scope=e;var t=this;this.provideFemalePlug("ObjectEdit",["editObject"]),this._plugHandle=this.getFemalePlug("ObjectEdit"),this._connectorService.getMalePlugProviders("ObjectEdit").forEach(function(e){t.connect(t._plugHandle,e)}),e.changesAvailable=function(){return t.changedUser()||t.changedSettings()||t.changedPassword()},e.getKey=function(e){return t._localeService.translate(WS.User.getStringIDForKey(e))},e.mapValue=function(e){for(var i=t._localeService.getLanguages(),n=0,o=i.length;o>n;n++)if(i[n].id===e)return i[n].caption;switch(e){case"gon":return t._localeService.translate("FE_GON");case"deg":return t._localeService.translate("FE_DEGREE")}return e}},execute:function(e){if(WS._2GO)return this._localUserSettings.update(e.settings._changes._language,e.settings._changes._units,e.settings._changes._areaunit,e.settings._changes._angleUnit,e.settings._changes._coordSystem),Q.resolve();var t=[],i=this;if(void 0!==e.settings._changes._language&&this._localeService.setLanguage(e.settings._changes._language),void 0!==e.settings._changes._units&&this._unitService.setLengthUnit(e.settings._changes._units),void 0!==e.settings._changes._areaunit&&this._unitService.setAreaUnit(e.settings._changes._areaunit),void 0!==e.settings._changes._angleUnit&&this._unitService.setAngleUnit(e.settings._changes._angleUnit),void 0!==e.settings._changes._coordSystem&&this._unitService.setCS(e.settings._changes._coordSystem),this.changedUser()){var n=this._accountService.updateMe(e.user).then(function(){i._loginService.refresh()}).fail(function(e){i._error.isExceptionType(e,"InvalidRequestParameterException")&&i._alert.errorObj(e,F.AlertServiceBase.DELAY_SHORT)});t.push(n)}if(this.changedSettings()){var o=this._accountService.updateSettings(e.settings).then(function(){i._loginService.refresh()}).fail(function(e){i._error.isExceptionType(e,"InvalidRequestParameterException")&&i._alert.errorObj(e,F.AlertServiceBase.DELAY_SHORT)});t.push(o)}if(this.changedPassword()){var r=this._accountService.resetPassword(e.user._username).then(function(){i._alert.message("IM_EMAIL_SENT")});t.push(r)}return Q.all(t)},teardown:function(){this._plugHandle.disconnect(),this._result._navigateTo=this._argument._lastPage},editObject:function(e){var t=this.$scope;e instanceof WS.User?t.input.user=e:e instanceof WS.Usersettings?t.input.settings=e:void 0!==e.requestPassword&&t.$apply(function(){t.input.requestPassword=e.requestPassword})},queryTaskLaunch:function(e,t,i){return e===this._panel&&t===this._category.id&&i===this._id},changedUser:function(){var e=this.$scope.input.user;return e&&e._changes instanceof Object&&Object.keys(e._changes).length},changedSettings:function(){var e=this.$scope.input.settings;return e&&e._changes instanceof Object&&Object.keys(e._changes).length},changedPassword:function(){return this.$scope.input.requestPassword}},WS.extend("UserSettingsTask","Task"),WS.WSUserLocaleService=function(e,t,i,n){this._domainSettings=n,this._hasSet=!1,F.UserLocaleService.call(this,e,t,i),this.setDefaultLanguage(!1)},WS.WSUserLocaleService.prototype={setDefaultLanguage:function(e){var t=this;this._domainSettings.get(!0).then(function(i){(e||!t._hasSet)&&t.setLanguage(i._language,!0)},function(){(e||!t._hasSet)&&F.UserLocaleService.prototype.setDefaultLanguage.call(t,!1)}).done()},setLanguage:function(e,t){t||(this._hasSet=!0),F.UserLocaleService.prototype.setLanguage.call(this,e,t)}},WS.extend("WSUserLocaleService","UserLocaleService"),F.DI().redefineService("user",WS.UserService,"@serializer","@error","@login","@selection","@plug","$resource"),F.DI().redefineService("login",WS.LoginService,"@error","$http","@encryption","@plug","$localStorage","$window"),F.DI().config(function(){this.redefineService("locale",WS.WSUserLocaleService,"@script","@plug","@login","@domainsettings")}),F.DI().config("@serializer","@user",WS.userConfigSerializer=function(e,t){e.registerClass("User",function(){return t.getNew()})}),F.DI().config("@task","@login",WS.userRoleConfigValidators=function(e,t){e.addValidator("user",function(){var e="EM_NO_USER";return t.isUser().then(function(t){return t?void 0:e},function(){return e})}),e.addValidator("admin",function(){var e="EM_NO_ADMIN";return t.isProjectManager().then(function(t){return t?void 0:e},function(){return e})}),e.addValidator("superuser",function(){var e="EM_NO_SUPERUSER";return t.isDomainAdmin().then(function(t){return t?void 0:e},function(){return e})})}),F.DI().config("@task",function(e){e.registerTaskFactory("default","settings","myaccount",WS.UserSettingsTask,"@plug","@user","@account","@unit","@login","@locale","@error","@alert","?@localusersettings")}),WS.PMException=new Error("EM_NO_ADMIN"),WS.PMException._type="AuthorizationException",WS.DAException=new Error("EM_NO_SUPERUSER"),WS.DAException._type="AuthorizationException",WS.UnitService=function(e,t,i){this._domainSettings=i,this._hasSet=!1,this._coordSystem=WS.UnitService.CS.PROJECT,F.UnitServiceBase.call(this,t),this.setDefaultUnits(!1);var n=this;if(e){var o=function(){e.getSettings().then(function(e){i.get(!0).then(function(t){n.updateUnitsBySettings(e,t)},function(){n.updateUnitsBySettings(e,void 0)}).done()}).done()},r=function(){n.setDefaultUnits(!0)};e.subscribe("login",o),e.subscribe("logout",r),e.subscribe("update",o)}},WS.UnitService.prototype={updateUnitsBySettings:function(e,t){e&&(t&&t._overrideLengthUnit?this.setLengthUnit(t._lengthUnit):e.Units&&this.setLengthUnit(e.Units),t&&t._overrideAreaUnit?this.setAreaUnit(t._areaUnit):e.Areaunit&&this.setAreaUnit(e.Areaunit),t&&t._overrideAngleUnit?this.setAngleUnit(t._angleUnit):e.AngleUnit&&this.setAngleUnit(e.AngleUnit),e.CoordSystem&&this.setCS(e.CoordSystem),this.trigger("updateSettings",["unit",[this._lengthUnit,this._areaUnit,this._angleUnit,this._coordSystem]]))},setDefaultUnits:function(e){var t=this;this._domainSettings.get(!0).then(function(i){var n=e||!t._hasSet;(n||i._overrideLengthUnit)&&t.setLengthUnit(i._lengthUnit),(n||i._overrideAreaUnit)&&t.setAreaUnit(i._areaUnit),(n||i._overrideAngleUnit)&&t.setAngleUnit(i._angleUnit),n&&t.setCS(WS.UnitService.CS.PROJECT),t.trigger("updateSettings",["unit",[t._lengthUnit,t._areaUnit,t._angleUnit,t._coordSystem]])},function(){(e||!t._hasSet)&&(t.removeInternal(),t.trigger("updateSettings",["unit",[t._lengthUnit,t._areaUnit,t._angleUnit,t._coordSystem]]))}).done()},setLengthUnit:function(e){this._hasSet=!0,F.UnitServiceBase.prototype.setLengthUnit.call(this,e)},setAreaUnit:function(e){this._hasSet=!0,F.UnitServiceBase.prototype.setAreaUnit.call(this,e)},setAngleUnit:function(e){this._hasSet=!0,F.UnitServiceBase.prototype.setAngleUnit.call(this,e)},setCS:function(e){this._hasSet=!0,this._coordSystem=e},isCustomCS:function(){return this._coordSystem===WS.UnitService.CS.PROJECT},removeInternal:function(){F.UnitServiceBase.prototype.removeInternal.call(this),this.setCS(WS.UnitService.CS.PROJECT)}},WS.extend("UnitService","UnitServiceBase"),WS.UnitService.SupportedLengthUnitsMetric=[["m","m"],["dm","dm"],["cm","cm"],["mm","mm"]],WS.UnitService.SupportedLengthUnitsImperial=[["yd","yd"],["ft","ft"],["in","in"]],WS.UnitService.SupportedLengthUnitsSurvey=[["ydUS","yd US"],["ftUS","ft US"],["inUS","in US"]],WS.UnitService.SupportedAreaUnitsMetric=[["ha","ha"],["a","a"],["m","m"],["dm","dm"],["cm","cm"],["mm","mm"]],WS.UnitService.SupportedAreaUnitsImperial=[["ac","ac"],["yd","yd"],["ft","ft"],["in","in"]],WS.UnitService.SupportedAreaUnitsSurvey=[["ydUS","yd US"],["ftUS","ft US"],["inUS","in US"]],WS.UnitService.SupportedAngleUnits=[["deg","FE_DEGREE"],["gon","FE_GON"]],WS.UnitService.CS={PROJECT:"project",GLOBAL:"global",LOCAL:"local"},WS.UnitService.SupportedCSs=[[WS.UnitService.CS.PROJECT,"FE_PROJ_COORDS_IF"],[WS.UnitService.CS.GLOBAL,"FE_GLOBAL_COORDS"]],F.DI().redefineService("unit",WS.UnitService,"?@login","@plug","@domainsettings"),WS.ProjectService=function(e,t,i,n,o,r,a,s){F.ProjectServiceBase.call(this,e,t,i,n,o,r,a,s,WS.Project),WS._2GO&&(this._clientSingle=this._resource("ws2go-data/project/:id/project.json",{},{read:{method:"GET",params:{}}}),this._clientList=this._resource("ws2go-data/project/projects.json",{},{read:{method:"GET",params:{},isArray:!0}})),this._projectCache={};var c=this;i.subscribe("login",function(){c.removeInternal()})},WS.ProjectService.prototype={getAll:function(e,t){if(WS._2GO){var i=this,n=Q.defer();return this._clientList.read({},function(e){var o=e.map(function(e){var t=Q.defer();return i._clientSingle.read({id:e},function(i){i.Name=e,t.resolve(i)},function(){t.resolve(void 0)}),t.promise});Q.all(o).then(function(e){e=e.filter(function(e){return!!e}),i.updateInternalMultiple(e);var o=t||function(){return!0};n.resolve(i._entities.filter(o))})},this._error.restHandler(n)),n.promise}return F.ProjectServiceBase.prototype.getAll.call(this,e,t)},getByID:function(e,t,i,n){return i=i||WS._2GO,F.ProjectServiceBase.prototype.getByID.call(this,e,t,i,n)},updateImage:function(e,t,i){var n=Q.defer(),o=WS.getMimeType(t),r="/data/project/"+e._name+"/project-image/"+t;return this.$http({method:"PUT",url:r,data:i,headers:{"Content-Type":o}}).success(function(){n.resolve()}).error(this._error.httpHandler(n)),n.promise},remove:function(e,t){return F.ProjectServiceBase.prototype.remove.call(this,e,t).fail(function(e){throw"IntegrityViolationException"===e._type&&(e.message="EM_JOB_DEL_PROJ"),e})},getAllWithStates:function(e,t){return this.getAll(t,function(t){return!!F.findFirst(e,t._uploadState)||!!F.findFirst(e,t._state)})},getCurrentProject:function(){var e=this._currentProject;return e?(this._projectCache[e]||(this._projectCache={},this._projectCache[e]=this.getByID(e)),this._projectCache[e]):Q.reject(new Error("EM_NO_PROJECT"))},isCurrentProject:function(e){return this.isCurrent(e._name)},removeInternal:function(){F.ProjectServiceBase.prototype.removeInternal.call(this),this._projectCache={}},canShowObjectInPano:function(e){return e.canBeShownInView("panorama")?this.getCurrentProject().then(function(e){return e.hasScan()},function(){return!1}):Q.resolve(!1)},canShowObjectInMap:function(e){return e.canBeShownInView("map")?this.getCurrentProject().then(function(e){return e.hasOverviewMap()},function(){return!1}):Q.resolve(!1)},getUsedProjectIds:function(){var e=Q.defer(),t={method:"GET",url:"/projectname/"};return this.$http(t).success(function(t){e.resolve(t)}).error(this._error.httpHandler(e)),e.promise}},WS.extend("ProjectService","ProjectServiceBase"),WS.Project=function(e){F.ProjectBase.call(this,e),this._description=void 0,this._keywords=void 0,this._latitude=void 0,this._longitude=void 0,this._image=void 0,this._public=void 0,this._featured=void 0,this._exportVersion=void 0,this._enable3D=void 0,this._type=void 0,this._trafo=void 0,this._trafoName=void 0,this._uploadState=void 0,this._numberOfScans=void 0,this._oldestScanRecordingTime=void 0,this._newestScanRecordingTime=void 0,this._newestScanModificationTime=void 0,this._workspaceModificationTime=void 0,this._uploader=void 0,this._simple3DEnabled=void 0,this._uploadDate=void 0,this._creator=void 0,this._creationDate=void 0,this._state=void 0,this._groupids=null,this._pointClouds=void 0,this._imageUrl=void 0,this._newImage=void 0,this._storageSize=void 0},WS.Project.prototype={readJson:function(e){F.ProjectBase.prototype.readJson.call(this,e),this._description=e.Description,this._keywords=e.Keywords,this._latitude=e.Latitude,this._longitude=e.Longitude,this._image=e.Image,this._public=e.Public,this._featured=e.Featured,this._exportVersion=e.ExportVersion,this._enable3D=e.Enable3D,this._type=e.Type,this._trafo=!e.Trafo||mat4.equal(e.Trafo,[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])?void 0:e.Trafo,this._trafoName=e.TrafoName,this._uploadState=e.UploadState,this._numberOfScans=e.NumberOfScans,this._oldestScanRecordingTime=e.OldestScanRecordingTime,this._newestScanRecordingTime=e.NewestScanRecordingTime,this._newestScanModificationTime=e.NewestScanModificationTime,this._workspaceModificationTime=e.WorkspaceModificationTime,this._uploader=e.Uploader,this._simple3DEnabled=e.Simple3DEnabled,this._uploadDate=e.UploadDate,this._creator=e.Creator,this._creationDate=e.CreationDate,this._state=e.State,this._pointClouds=e.PointClouds,null!==e.GroupIds&&(this._groupids=e.GroupIds),WS._2GO&&(this._type===WS.Project.Type.INC?this._state="Published":(this._type=WS.Project.Type.WSC,this._uploadState="Completed",this._simple3DEnabled=!0),this._enable3D=!0,this._pointClouds={}),this.setImgUrl()},writeJson:function(){var e=F.ProjectBase.prototype.writeJson.call(this);
return e.Class="Project",e.Description=this._description,e.Keywords=this._keywords,e.Latitude=this._latitude,e.Longitude=this._longitude,e.Image=this._image,e.Public=this._public,e.Featured=this._featured,e.ExportVersion=this._exportVersion,e.Enable3D=this._enable3D,e.Type=this._type,e.Trafo=this._trafo?this._trafo:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],e.TrafoName=this._trafoName,e.UploadState=this._uploadState,e.NumberOfScans=this._numberOfScans,e.OldestScanRecordingTime=this._oldestScanRecordingTime,e.NewestScanRecordingTime=this._newestScanRecordingTime,e.NewestScanModificationTime=this._newestScanModificationTime,e.WorkspaceModificationTime=this._workspaceModificationTime,e.Uploader=this._uploader,e.Simple3DEnabled=this._simple3DEnabled,e.UploadDate=this._uploadDate,e.Creator=this._creator,e.CreationDate=this._creationDate,e.State=this._state,e},getTrimmedDescription:function(e){if(this._description.length<=e)return this._description;var t=this._description.substring(0,e),i=t.lastIndexOf(" ");return t=t.substring(0,i+1),t+="[...]"},setImgUrl:function(){this._imageUrl=WS._2GO?"ws2go-data/project/"+this._name+"/project.jpg":"data/project/"+this._name+"/project-image?r="+this._image},getImage:function(){return this._imageUrl},addGroups:function(e){return F.DI().getService("admin").addRelatedGroups(this,e)},removeGroups:function(e){return F.DI().getService("admin").removeRelatedGroups(this,e)},getGroups:function(){return F.DI().getService("project").getRelatedGroups(this)},updateImage:function(e,t){return this._service.updateImage(this,e,t)},hasPendingPointCloud:function(){return this.hasPendingProjectPointCloud()||this.hasPendingScanPointCloud()},hasPendingProjectPointCloud:function(){var e=this._pointClouds;return!(!e||!(e.Project&&0<e.Project.pending||e.EntityPC&&0<e.EntityPC.pending))},hasPendingScanPointCloud:function(){var e=this._pointClouds;return!!(e&&e.Scan&&0<e.Scan.pending)},hasPointCloud:function(){return this.hasProjectPointCloud()||this.hasScanPointCloud()},hasProjectPointCloud:function(){var e=this._pointClouds;return!(!e||!(e.Project&&0<e.Project.complete||e.EntityPC&&0<e.EntityPC.complete))},hasScanPointCloud:function(){var e=this._pointClouds;return!!(e&&e.Scan&&0<e.Scan.complete)},getPointCloudState:function(){return this.hasPendingPointCloud()?0:this.hasProjectPointCloud()&&this.hasScanPointCloud()?1:this.hasProjectPointCloud()?2:this.hasScanPointCloud()?3:this._simple3DEnabled?4:5},hasScan:function(){return this._numberOfScans>0},hasOverviewMap:function(){return this._type===WS.Project.Type.WSC}},WS.extend("Project","ProjectBase"),WS.Project.Type={WSC:"wsc",INC:"inc"},WS.Project.State={DRAFT:"Draft",PUBLISHED:"Published"},WS.Project.UploadState={STARTED:"Started",COMPLETED:"Completed"},WS.Project.DISPLAYNAME_MAX_CHARS=60,WS.Project.DISPLAYNAME_MAX_BYTES=128,F.DI().registerService("root",F.RootService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),F.DI().redefineService("project",WS.ProjectService,"@serializer","@error","@login","@selection","@plug","$resource","$http","@url"),F.DI().config("@serializer","@project","@root",function(e,t,i){e.registerClass("Project",function(){return t.getNew()}),e.registerClass("Workspace",function(){return i.getNew()})}),F.DI().config("@task","@project",WS.projectValidators=function(e,t){e.addValidator("map",function(){return t.hasCurrent()?t.getCurrentProject().then(function(e){return e.hasOverviewMap()?void 0:"EM_NO_MAP"},function(){}):Q.resolve("EM_NO_PROJECT")}),e.addValidator("canconfiguremap",function(){return t.hasCurrent()?t.getCurrentProject().then(function(e){return e.hasOverviewMap()?e._exportVersion<10?"EM_NO_LAYERMAP":void 0:"EM_NO_MAP"},function(e){return e.message||"EM_UNKNOWN_ERROR"}):Q.resolve("EM_NO_PROJECT")})}),angular.module("ws.filter").filter("projectfilter",function(){return function(e,t,i,n){if(!t&&!i&&void 0===n)return e;var o=(t||"").toLowerCase(),r=o.match(/^>(\d+)$/),a=r&&2===r.length?(new Date).getTime()-24*parseInt(r[1])*60*60*1e3:void 0;return e.filter(function(e){return(-1!==e._displayName.toLowerCase().indexOf(o)||-1!==e._name.toLowerCase().indexOf(o)||-1!==e._description.toLowerCase().indexOf(o)||-1!==e._keywords.toLowerCase().indexOf(o)||("3"===o||"3d"===o)&&e._enable3D&&e.hasProjectPointCloud()||a&&F.datestringToDateObj(e._uploadDate||e._creationDate).getTime()<a)&&(!i||i<=e._exportVersion)&&(void 0===n||e.hasOverviewMap()===n)})}}),WS.DataFilterCtrl=function(e,t,i,n,o,r,a,s,c,l,h,d){WS.PlugController.call(this,e,t);var u=this;this._plug=t,this._login=i,this._project=n,this._alert=o,this._measurement=r,this._annotation=a,this._scan=s,this._category=c,this._tag=l,this._orthophoto=h,this._workspace=d,this.$scope=e,this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.provideFemalePlug("ProjectChange",["changeProject"]),this._plug.connect(this,this._login),this._plug.connect(this,this._project),e.filter=new WS.ChangeObject,e.filter._categories=[],e.filter._tags=[],e.filter._ignoreShared=!1,e.filter._root=!1,window.filter=e.filter,e.categories=[],e.tags=[],e.isAdmin=!1,e.drawer=!1,e.userName=void 0,this.checkUser(),e.getKnown=function(){u._category.getAll().then(function(t){e.$apply(function(e){e.categories=t.map(function(e){return e.Category}).sort(function(e,t){return e.localeCompare(t)})})},function(){}).done(),u._tag.getAll().then(function(t){e.$apply(function(e){e.tags=t.map(function(e){return e.Tag}).sort(function(e,t){return e.localeCompare(t)})})},function(){}).done()},e.toggleOpen=function(){e.drawer?e.cancel():e.open()},e.tooltipToggleBtn=function(){return e.drawer?"FE_CANCEL":"FE_OPEN_FILTER_PANEL"},e.open=function(){try{u._project.getCurrent()}catch(t){return void u._alert.message(t.message)}e.getKnown(),e.drawer=!0,e.filter._changes._categories=F.cloneArray(e.filter._categories),e.filter._changes._tags=F.cloneArray(e.filter._tags)},e.cancel=function(){e.drawer=!1,e.filter.discardChanges()},e.resetFilters=function(){var t=e.filter._changes;t._categories=[],t._tags=[],t._ignoreShared=!1,t._root=!1},e.apply=function(){e.filter.applyChanges(),e.drawer=!1;var t=new F.DataFilter,i=new F.DataFilter;e.filter._categories.length>0&&t.setCategories(e.filter._categories),e.filter._tags.length>0&&t.setTags(e.filter._tags),e.filter._root&&(t.setRoot(e.filter._root),i.setRoot(e.filter._root)),u._workspace.root(e.filter._root),e.filter._ignoreShared&&e.userName&&(t.setCreatedBy([e.userName,""]),i.setCreatedBy([e.userName,""]));try{u._project.getCurrent()}catch(n){return void u._alert.message(n.message)}var o=[u._category.setDataFilter(i),u._tag.setDataFilter(i),u._annotation.setDataFilter(t),u._measurement.setDataFilter(t),u._orthophoto.setDataFilter(t),u._scan.setDataFilter(t)];Q.allSettled(o).then(function(){e.userName&&(u._login.notify("update"),u._login.trigger("updateAccount"))})},e.remove=function(e,t){F.removeFirst(e,t)},e.addOrRemove=function(e,t){var i=e.indexOf(t);-1==i?e.push(t):e.splice(i,1)}},WS.DataFilterCtrl.prototype={checkUser:function(){var e=this;this._login.isProjectManager().then(function(t){e.$scope.$apply("isAdmin = "+t)}).done(),this._login.getUsername().then(function(t){e.$scope.$apply(function(e){e.userName=t})}).done()},changeProject:function(){this.$scope.$apply(function(e){e.resetFilters(),e.filter.applyChanges()})},login:function(){this.checkUser()},logout:function(){this.checkUser()},updateAccount:function(){this.checkUser()}},WS.extend("DataFilterCtrl","PlugController"),WS.TagService=function(e,t,i,n){this._resource=e,this._project=t,this._error=i,this._workspace=n,this._dataFilter=new F.DataFilter,this._restClient=this._resource("/tag/:project",{},{readAll:{method:"GET",params:{},isArray:!0}})},WS.TagService.prototype={setDataFilter:function(e){return this._dataFilter=e,this.getAll()},getAll:function(){if(WS._2GO)return this._workspace.getAll("_tags");var e=Q.defer(),t={project:this._project.getCurrent()};return this._dataFilter.enhanceRead(t),this._restClient.readAll(t,function(t){e.resolve(t)},this._error.restHandler(e)),e.promise}},WS.extend("TagService"),WS.CategoryService=function(e,t,i,n){this._resource=e,this._project=t,this._error=i,this._workspace=n,this._dataFilter=new F.DataFilter,this._restClient=this._resource("/category/:project",{},{readAll:{method:"GET",params:{},isArray:!0}})},WS.CategoryService.prototype={setDataFilter:function(e){return this._dataFilter=e,this.getAll()},getAll:function(){if(WS._2GO)return this._workspace.getAll("_categories");var e=Q.defer(),t={project:this._project.getCurrent()};return this._dataFilter.enhanceRead(t),this._restClient.readAll(t,function(t){e.resolve(t)},this._error.restHandler(e)),e.promise},getAllWithoutEmpty:function(){return this.getAll().then(function(e){return F.removeFirst(e,function(e){return""===e.Category}),e})}},WS.extend("CategoryService"),WS.SelectionTask={getSelectionStep:function(e){return F.mergeObjects({caption:"TC_DELETE_OBJECT",description:void 0,selectionEntry:"{{entry._displayName}}",selectionIcon:"icons/lock.png",selectionIconShow:"entry._writeLock",toolbarWidget:'<tasktoolbar ng-if="task._category.id != \'object\'" toolbar="viewselectiontoolbar" model="section._pageConfiguration.mode" onchange="setSelectionTool(value, section)"></tasktoolbar>',icon:WS.Icons.TaskSection.selectobject},e||{})},getSelectionStepDescription:function(){var e=this._category&&"object"===this._category.id;return e?"TD_DELETE_OBJECT":"TD_SELECT_OBJECTS_W_TOOLS"},setupSelectionStep:function(){var e=this;this.$scope.setSelectionTool=function(t,i){e.setActiveSection(i)}}},WS.defineMixin("SelectionTask"),WS.ModelTask={getNameStep:function(e){return F.mergeObjects({caption:"TC_ENTER_NAME",optional:!0,widget:'<edit target="input.name" validation="validateName" focus-me="section._active" placeholder="{{\'FE_ENTER_NAME\'|i18n}}"/>',icon:WS.Icons.TaskSection.textinput,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},completeCondition:"input.name.length == 0 || !validateName(input.name)"},e||{})},getDescriptionStep:function(e){return F.mergeObjects({caption:"TC_ENTER_DESCR",optional:!0,widget:'<div><markdownhint></markdownhint><br><br><editarea target="input.description" focus-me="section._active" placeholder="{{\'FE_ENTER_DESCR\'|i18n}}"/></div>',icon:WS.Icons.TaskSection.textinput,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1}},e||{})},getHyperlinkStep:function(e){return F.mergeObjects({caption:"TC_CREATE_ANNOTATION_HYPERLINK",optional:!0,description:"TD_CREATE_HLINK_CLOUD_STORAGE",widget:'<hyperlinkeditor input="input" focus-me="section._active"></hyperlinkeditor>',icon:WS.Icons.TaskSection.hyperlink,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1}},e||{})},getCategoryStep:function(e){return F.mergeObjects({caption:"TC_ENTER_CATEGORY",optional:!0,widget:'<taskcategorypicker input="input" categories="categories" focus-me="section._active"></taskcategorypicker>',icon:WS.Icons.TaskSection.category,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1}},e||{})},getTagStep:function(e){return F.mergeObjects({caption:"TC_ENTER_TAGS",optional:!0,widget:'<tasktagpicker input="input" tags="tags" focus-me="section._active"></tasktagpicker>',icon:WS.Icons.TaskSection.tags,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1}},e||{})},getColorStep:function(e){return F.mergeObjects({caption:"TC_SET_COLOR",optional:!0,widget:'<wscolorpicker color="input.color" focus-me="section._active"></wscolorpicker>',icon:WS.Icons.TaskSection.colormode,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},completeCondition:"isColorValid()"},e||{})},setupNameStep:function(){this.$scope.validateName=function(e){return e&&e.length&&e.length>255?"EM_NAME_TOO_LONG":void 0}},setupHyperlinkStep:function(){this.$scope.input.hyperlinkObjects=[]},setupCategoryStep:function(){var e=this.$scope;e.input.category="",this._cat.getAll().then(function(t){e.$apply(e.categories=t)}).done()},setupTagStep:function(){var e=this.$scope;e.input.tags=[],this._tag.getAll().then(function(t){e.$apply(e.tags=t)}).done()},setupCategoryTagSteps:function(){this.setupCategoryStep(),this.setupTagStep()},setupColorStep:function(){var e=this.$scope;e.input.color="#00e500",e.isColorValid=function(){return F.ColorGenerator.isHexColor(e.input.color,!0)}}},WS.defineMixin("ModelTask"),WS.RemoveTask=function(e){WS.Task.call(this,e),this._description=[this.getSelectionStep({pageConfiguration:{selection:"annotation,measurement,tempmeasurement,orthophoto",mode:WS.ViewBase.Mode.SelectObjects,name:"RemoveTask"},select:"Annotation,Measurement,TempMeasurement,Orthophoto",selection:"input.annotations,input.measurements,input.tempMeasurements,input.orthophotos",widget:'<alert type="warning" ng-show="hasUnlocked() && hasLocked()">{{ \'FE_WARN_WRITELOCKED\' | i18n }}</alert><alert type="error" ng-show="length() > 0 && !hasUnlocked()">{{ \'FE_ERROR_ALLWRITELOCKED\' | i18n }}</alert>',completeCondition:"hasUnlocked()"})]},WS.RemoveTask.prototype={setupDescription:function(){this._description[0].description=this.getSelectionStepDescription()},setup:function(e){this.$scope=e,this.setupSelectionStep(),e.hasLocked=function(){return e.input.annotations.some(F.isLocked)||e.input.measurements.some(F.isLocked)||e.input.orthophotos.some(F.isLocked)},e.length=function(){return e.input.tempMeasurements.length+e.input.annotations.length+e.input.measurements.length+e.input.orthophotos.length},e.hasUnlocked=function(){return e.input.tempMeasurements.length>0||e.input.annotations.some(F.isUnlocked)||e.input.measurements.some(F.isUnlocked)||e.input.orthophotos.some(F.isUnlocked)}},execute:function(e){var t=e.annotations.concat(e.measurements,e.tempMeasurements,e.orthophotos);return Q.allSettled(t.filter(F.isUnlocked).map(function(e){return e.remove()})).then(function(e){var t={};return e.forEach(function(e){"rejected"===e.state&&(t[e.reason.message]=!0)}),new WS.TaskResult(Object.keys(t))})}},WS.extend("RemoveTask","Task"),WS.mixin("RemoveTask","SelectionTask"),WS.EditTask=function(e,t,i){WS.Task.call(this,e),this._cat=t,this._tag=i,this._description=[this.getSelectionStep({pageConfiguration:{selection:"annotation,measurement,orthophoto,scan",mode:WS.ViewBase.Mode.SelectObjects},select:"Annotation,Measurement,Orthophoto,Scan",selection:"input.annotations,input.measurements,input.orthophotos, input.scans",selectSingle:!0,widget:'<alert type="error" ng-show="first() && first()._writeLock">{{ \'FE_ERROR_WRITELOCKED\' | i18n }}</alert>',completeCondition:"first() && !first()._writeLock"}),this.getColorStep({caption:"TC_EDIT_COLOR",startCondition:'first()._class === "Annotation" && first().isPolyline()'}),{caption:"TC_EDIT_NAME",optional:!0,widget:'<edit target="input.name" source="first()._displayName" focus-me="section._active" placeholder="{{\'FE_ENTER_NAME\'|i18n}}"/>',icon:WS.Icons.TaskSection.textinput,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},startCondition:"first()",completeCondition:"input.name.length > 0"},{caption:"TC_EDIT_DESCR",optional:!0,widget:'<div><markdownhint></markdownhint><br><br><editarea target="input.description" source="first()._description" focus-me="section._active" placeholder="{{\'FE_ENTER_DESCR\'|i18n}}"/></div>',icon:WS.Icons.TaskSection.textinput,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},startCondition:'first()._class == "Annotation" || first()._class == "Orthophoto"'},this.getHyperlinkStep({caption:"TC_EDIT_HYPERLINKS",startCondition:'first()._class == "Annotation" || first()._class == "Orthophoto"'}),this.getCategoryStep({caption:"TC_EDIT_CATEGORY",startCondition:"first()"}),this.getTagStep({caption:"TC_EDIT_TAGS",startCondition:"first()"})]},WS.EditTask.prototype={setupDescription:function(){this._description[0].description=this.getSelectionStepDescription()},setup:function(e){var t=this;t.$scope=e,e.first=function(){return e.input.annotations[0]||e.input.measurements[0]||e.input.orthophotos[0]||e.input.scans[0]},this.setupSelectionStep(),this.setupHyperlinkStep(),this.setupCategoryTagSteps(),this.setupColorStep(),e.$watch("first()",function(t){t&&(e.input.tags=F.cloneArray(t._tags),e.input.category=t._category,e.input.hyperlinkObjects=F.cloneArray(t._hyperlinks||[]),"Annotation"===t._class&&t.isPolyline()&&(e.input.color=F.ColorGenerator.rgbaToHex(t._displayColor,!1)))})},execute:function(e){var t=e.annotations[0]||e.measurements[0]||e.orthophotos[0]||e.scans[0];return t._changes._displayName=e.name,t._changes._category=e.category,t._changes._tags=e.tags,("Annotation"===t._class||"Orthophoto"===t._class)&&(t._changes._description=e.description,t._changes._hyperlinks=e.hyperlinkObjects),"Annotation"===t._class&&t.isPolyline()&&(t._changes._displayColor=F.ColorGenerator.hexToRGBA(e.color,!0)),t.update().then(function(){return t._service._filter(t)?void 0:new WS.TaskResult([],["IM_FILTERED_OBJECT_EDIT"])})}},WS.extend("EditTask","Task"),WS.mixin("EditTask","SelectionTask"),WS.mixin("EditTask","ModelTask"),WS.PickPointsTask={getPointListDesc:function(){return'<div class="f_textS" ng-repeat="point in input.pickedPoints" ng-switch="point._pointState"><div class="btn-group" style="margin-bottom: 10px;"><button ng-click="focusPoint(point)" class="btn btn-default f_textS" style="height: 25px; padding-top: 0px; width: 200px;" title="{{focusPointWhere(point) | i18n}}"><div style="text-align: center; display: inline-block;"><img class="f_icon16" style="margin: 4px;" static-src="{{ isRemotePoint(point) ? \'icons/colordot-msm-arrow.png\' : \'icons/colordot-msm.png\' }}"/><span ng-switch-when="0">{{ getPosInCS(point._positionGlobal) | pos_short }}</span><span ng-switch-when="1">{{ \'FE_INVALID_POINT\' | i18n }}</span><span ng-switch-when="2">{{ \'FE_LOADING\' | i18n }}</span></div></button><button ng-click="removePoint(point)" class="btn btn-default" style="height: 25px; width: 25px; padding: 0;" title="{{\'FE_REMOVE\' | i18n}}"><img class="f_icon24" static-src="icons/remove.png"/></button></div></div>'},setupMixin:function(e){var t=this;this._finished=!1,this.setupCategoryTagSteps(),this._projectService.getCurrentProject().then(function(e){t._project=e}),e.input.pickedPoint=void 0,e.input.pickedPoints=[],e.pointsReady=function(){return e.input.pickedPoints.every(function(e){return e._positionGlobal})},e.isRemotePoint=function(e){return t._pano?!t._pano._visible||!t._pano.isObjectRoot(e._refSystem)&&!t._pano.isRootPointCloud():!1},e.focusPoint=function(e){var i=e._refSystem;if(e._positionGlobal){var n=i instanceof WS.Scan?i:void 0,o={lookAt:e._positionGlobal,picker:!1,root:n};t.trigger("focusOn",[o,i instanceof WS.PointCloud?"3d":n?"pano/3d":"map"])}},e.focusPointWhere=function(e){var i=e._refSystem;return i instanceof WS.MapObject?"FE_SHOW_IN_MAP":i instanceof WS.PointCloud?"FE_SHOW_IN_3D":t._pano.isRootCloud()?"FE_SHOW_IN_3D":"FE_SHOW_IN_PANO"},e.removePoint=function(i){t.removePoint(e.input.pickedPoints,i,e.input.close)},e.getPosInCS=function(e){return t._project._trafo&&t._unit.isCustomCS()?mat4.posInRefSystem(e,t._project._trafo):e},this.provideMalePlug("PointPick3DControl",["setPickedPoints"]),this.provideMalePlug("ViewFocus",["focusOn"]),this._connectorService.connectWithAll(this.getMalePlug("PointPick3DControl")),this._connectorService.connectWithAll(this.getMalePlug("ViewFocus"))},teardownMixin:function(){this.triggerAndDestroy("setPickedPoints",[[]]),this._finished=!0},removePoint:function(e,t,i){F.removeFirst(e,t)&&this.trigger("setPickedPoints",[e,i,this.getLineColor(),void 0,this.getLineColor()])},removeDuplicates:function(e){for(var t=0,i=1;i<e.length;){var n=e[t],o=e[i];if(n._positionGlobal&&o._positionGlobal){var r=n._positionGlobal[0],a=n._positionGlobal[1],s=n._positionGlobal[2],c=o._positionGlobal[0],l=o._positionGlobal[1],h=o._positionGlobal[2];r===c&&a===l&&s===h?this.$scope.removePoint(o):(t++,i++)}else t++,i++}},applyPickedPointInScanView:function(e,t,i,n){this.trigger("setPickedPoints",[t,n,this.getLineColor(),void 0,this.getLineColor()]);var o=this;this._point3d.determine3DCoords(i).then(function(){o._finished||e.$apply(function(){o.removeDuplicates(t),o.trigger("setPickedPoints",[t,n,o.getLineColor(),void 0,o.getLineColor()])})},function(){e.$apply(function(){i._pointState=WS.Point3d.PointState.Invalid,o.removeDuplicates(t),o.trigger("setPickedPoints",[t,n,o.getLineColor(),void 0,o.getLineColor()])})}).done()},applyPickedPointInMap:function(e,t,i,n){i._pointState=WS.Point3d.PointState.Valid,i._positionGlobal=i._estimatedPosition,this.removeDuplicates(t),this.trigger("setPickedPoints",[t,n,this.getLineColor(),void 0,this.getLineColor()])},getTypeInfo:function(e){var t=e.some(function(e){return e._3d}),i=t?0:Object.keys(e.reduce(function(e,t){return e[t._refSystem._UUID]=!0,e},{})).length;return[t,i]},setPointsAttributes:function(e,t,i,n){var o,r=e instanceof WS.Measurement;i[0]?(e._pointsGlobal=[],t.forEach(function(t){e._pointsGlobal.push(vec3.create(t._positionGlobal))}),n&&this.closeArea(e._pointsGlobal)):1===i[1]?(e._pointsLocal=[],r&&(e._pointStates=[]),t.forEach(function(t){e._pointsLocal.push(vec3.create(t._positionLocal)),r&&e._pointStates.push(t._pointState)}),o=n?this.closeArea(e._pointsLocal):!1,o&&r&&e._pointStates.push(e._pointStates[0]),e._parentUUID=t[0]._refSystem._UUID):(e._pointsGlobal=[],r&&(e._pointStates=[]),e._pointScans=[],t.forEach(function(t){e._pointsGlobal.push(vec3.create(t._positionGlobal)),r&&e._pointStates.push(t._pointState),e._pointScans.push(t._refSystem._UUID)}),o=n?this.closeArea(e._pointsGlobal):!1,o&&(r&&e._pointStates.push(e._pointStates[0]),e._pointScans.push(e._pointScans[0])))},closeArea:function(e){if(e.length<3)return!1;var t=e[0],i=e[e.length-1];return(t[0]!==i[0]||t[1]!==i[1]||t[2]!==i[2])&&e.push(vec3.create(e[0])),!0},watchClose:function(e,t){var i=this;e.$watch("input.close",function(n){var o=e.input.pickedPoints;0<o.length&&(t?i.applyPickedPointInMap(e,o,o[o.length-1],n):i.applyPickedPointInScanView(e,o,o[o.length-1],n))})}},WS.defineMixin("PickPointsTask"),F.DI().config("@task",function(e){this.registerController("datafilter",WS.DataFilterCtrl,"@plug","@login","@project","@alert","@measurement","@annotation","@scan","@category","@tag","@orthophoto","@workspace"),this.registerService("category",WS.CategoryService,"$resource","@project","@error","?@workspace"),this.registerService("tag",WS.TagService,"$resource","@project","@error","?@workspace"),this.registerService("transformation",F.TransformationService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),e.registerTaskFactory("default","object","editcategory",WS.EditCategoryTask,"@plug","@category"),e.registerTaskFactory("default","panoramaview","editcategory",WS.EditCategoryTask,"@plug","@category"),e.registerTaskFactory("default","overviewmap","editcategory",WS.EditCategoryTask,"@plug","@category"),e.registerTaskFactory("default","object","edittag",WS.EditTagTask,"@plug","@tag"),e.registerTaskFactory("default","panoramaview","edittag",WS.EditTagTask,"@plug","@tag"),e.registerTaskFactory("default","overviewmap","edittag",WS.EditTagTask,"@plug","@tag"),e.registerTaskFactory("default","object","edit",WS.EditTask,"@plug","@category","@tag"),e.registerTaskFactory("default","panoramaview","edit",WS.EditTask,"@plug","@category","@tag"),e.registerTaskFactory("default","overviewmap","edit",WS.EditTask,"@plug","@category","@tag"),e.registerTaskFactory("default","object","remove",WS.RemoveTask,"@plug"),e.registerTaskFactory("default","panoramaview","remove",WS.RemoveTask,"@plug"),e.registerTaskFactory("default","overviewmap","remove",WS.RemoveTask,"@plug")}),F.DI().config("@serializer","@transformation",WS.modelConfig=function(e,t){e.registerClass("Transformation",function(){return t.getNew()})}),angular.module("ws.filter").filter("objectfilter",function(){return function(e,t,i){return e.filter(function(e){if(!t)return e;var n=t.toLowerCase();if(-1!==e._displayName.toLowerCase().indexOf(n))return!0;if(i){if(i.category&&-1!==e._category.toLowerCase().indexOf(n))return!0;if(i.recordingTime&&e instanceof WS.Scan&&-1!==e._recordingTime.toLowerCase().indexOf(n))return!0;if(i.tags&&e._tags.some(function(e){return-1!==e.toLowerCase().indexOf(n)}))return!0}})}}),angular.module("ws.widget").directive("category",function(){return F.DI().inject("$filter","@encryption",function(e,t){return{restrict:"E",scope:!0,link:function(i,n,o){var r=0,a=!1,s=function(){i.style=e("bgcolor")(e("int2rgb")(16777215&r))};i.$watch(o.text,function(e){void 0!==e&&(i.text=e,a||(r=t.crc32(e),s()))}),i.$watch(o.text,function(e){void 0!==e&&(i.text=e,a||(r=t.crc32(e),s()))}),i.$watch(o.interactive,function(e){i.interactive=e})},template:'<span style="float:left; margin-right:5px; margin-bottom:5px; height:26px; padding-left:5px; padding-right:5px; padding-bottom:3px; padding-top:3px; border-radius:3px; " ng-class="{ws_interactive: interactive, ws_categoryItem: interactive}" ><div ng-show="text" ng-style="style" class="f_category"></div><p ng-show="text" style="display: inline-block; vertical-align: 2px">&nbsp;&nbsp;&nbsp;{{text}}</p><p ng-show="!text" style="display: inline-block; vertical-align: 2px; font-style: italic">&mdash;{{ \'FE_NONE\' | i18n }}&mdash;</p><img ng-show="interactive" style="display: inline; vertical-align: top;" class="f_icon16" static-src="icons/im/checked_false.png"/></span>'}})}),angular.module("ws.widget").directive("datafilter",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("datafilter"),templateUrl:WS.partialUrl("datafilters.html")})}),WS.EditCategoryTask=function(e,t){WS.Task.call(this,e),this._cat=t,this._description=[this.getSelectionStep({pageConfiguration:{selection:"annotation,measurement,orthophoto,scan",mode:WS.ViewBase.Mode.SelectObjects},select:"Annotation,Measurement,Orthophoto,Scan",selection:"input.annotations,input.measurements,input.orthophotos,input.scans",widget:'<alert type="warning" ng-show="hasUnlocked() && hasLocked()">{{ \'FE_WARN_WRITELOCKED\' | i18n }}</alert><alert type="error" ng-show="length() > 0 && !hasUnlocked()">{{ \'FE_ERROR_ALLWRITELOCKED\' | i18n }}</alert>',completeCondition:"hasUnlocked()"}),{caption:"TC_SELECT_CATEGORY",widget:'<radio options="operations" selected="input.operation"></radio>',icon:WS.Icons.TaskSection.category,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},completeCondition:"input.operation"},{caption:"TC_ENTER_CATEGORY",startCondition:'input.operation === "add" && (input.annotations.length || input.measurements.length || input.orthophotos.length || input.scans.length)',widget:'<taskcategorypicker input="input" categories="categories" focus-me="section._active"></taskcategorypicker>',icon:WS.Icons.TaskSection.category,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},completeCondition:"input.category !== undefined"}]},WS.EditCategoryTask.prototype={setupDescription:function(){this._description[0].description=this.getSelectionStepDescription()},setup:function(e){this.$scope=e;var t=this;this.setupSelectionStep(),e.operations={add:"FE_SET_CATEGORY",remove:"FE_REMOVE_CATEGORY"},e.input.category=void 0,e.hasLocked=function(){return e.input.annotations.some(F.isLocked)||e.input.measurements.some(F.isLocked)||e.input.orthophotos.some(F.isLocked)||e.input.scans.some(F.isLocked)},e.hasUnlocked=function(){return e.input.annotations.some(F.isUnlocked)||e.input.measurements.some(F.isUnlocked)||e.input.orthophotos.some(F.isUnlocked)||e.input.scans.some(F.isUnlocked)},e.length=function(){return e.input.annotations.length+e.input.measurements.length+e.input.orthophotos.length+e.input.scans.length},this._cat.getAllWithoutEmpty().then(function(e){t.$scope.$apply(t.$scope.categories=e)}).done()},execute:function(e){var t=e.annotations.concat(e.measurements,e.orthophotos,e.scans),i="add"==e.operation?e.category:"";return Q.allSettled(t.filter(F.isUnlocked).map(function(e){return e._changes._category=i,e.hasUnsavedChanges()?e.update().then(function(){return e}):Q.resolve(e)})).then(function(e){var t={},i={};return e.forEach(function(e){if("rejected"==e.state)i[e.reason.message]=!0;else if("fulfilled"==e.state){var n=e.value;n._service._filter(n)||(t.IM_FILTERED_OBJECT_EDIT=!0)}}),new WS.TaskResult(Object.keys(i),Object.keys(t))})}},WS.extend("EditCategoryTask","Task"),WS.mixin("EditCategoryTask","SelectionTask"),WS.EditTagTask=function(e,t){WS.Task.call(this,e),this._tag=t,this._description=[this.getSelectionStep({pageConfiguration:{selection:"annotation,measurement,orthophoto,scan",mode:WS.ViewBase.Mode.SelectObjects},select:"Annotation,Measurement,Orthophoto,Scan",selection:"input.annotations,input.measurements,input.orthophotos,input.scans",widget:'<alert type="warning" ng-show="hasUnlocked() && hasLocked()">{{ \'FE_WARN_WRITELOCKED\' | i18n }}</alert><alert type="error" ng-show="length() > 0 && !hasUnlocked()">{{ \'FE_ERROR_ALLWRITELOCKED\' | i18n }}</alert>',completeCondition:"hasUnlocked()"}),{caption:"TC_SELECT_TAGS",widget:'<radio options="operations" selected="input.operation"></radio>',icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},completeCondition:"input.operation"},{caption:"FE_SELECT_TAGS",widget:'<tasktagpicker input="input" tags="tags" focus-me="section._active"></tasktagpicker>',icon:WS.Icons.TaskSection.tags,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},startCondition:'tags && input.operation && input.operation != "removeall" && (input.annotations.length || input.measurements.length || input.orthophotos.length || input.scans.length)',completeCondition:"input.tags.length > 0"}]},WS.EditTagTask.prototype={setupDescription:function(){this._description[0].description=this.getSelectionStepDescription()},setup:function(e){this.$scope=e;var t=this;this.setupSelectionStep(),this.setupTagStep(),e.operations={add:"FE_ADD_TAGS",remove:"FE_REMOVE_TAGS",removeall:"FE_REMOVE_ALL_TAGS"},e.hasLocked=function(){return e.input.annotations.some(F.isLocked)||e.input.measurements.some(F.isLocked)||e.input.orthophotos.some(F.isLocked)||e.input.scans.some(F.isLocked)},e.hasUnlocked=function(){return e.input.annotations.some(F.isUnlocked)||e.input.measurements.some(F.isUnlocked)||e.input.orthophotos.some(F.isUnlocked)||e.input.scans.some(F.isUnlocked)},e.length=function(){return e.input.annotations.length+e.input.measurements.length+e.input.orthophotos.length+e.input.scans.length},e.$watch("input.operation",function(){t.$scope.input.tags=[]})},execute:function(e){var t=e.annotations.concat(e.measurements,e.orthophotos,e.scans);return Q.allSettled(t.filter(F.isUnlocked).map(function(t){"removeall"==e.operation?t._changes._tags=[]:(t._changes._tags=F.cloneArray(t._tags),e.tags.forEach(function(i){"add"===e.operation?F.addUnique(t._changes._tags,i):"remove"===e.operation&&F.removeFirst(t._changes._tags,i)}));var i=F.cloneArray(t._tags).sort();return t._changes._tags.sort(),F.compareJSON(i,t._changes._tags)?(t.discardChanges(),Q.resolve(t)):t.update().then(function(){return t})})).then(function(e){var t={},i={};return e.forEach(function(e){if("rejected"==e.state)i[e.reason.message]=!0;else if("fulfilled"==e.state){var n=e.value;n._service._filter(n)||(t.IM_FILTERED_OBJECT_EDIT=!0)}}),new WS.TaskResult(Object.keys(i),Object.keys(t))})}},WS.extend("EditTagTask","Task"),WS.mixin("EditTagTask","SelectionTask"),WS.mixin("EditTagTask","ModelTask"),WS.Scan=function(e){WS.Transformation.call(this,e),this._class="Scan",this._writeLock=!0,this._recordingTime=void 0,this._modificationTime=void 0,this._panoramaColorWidths=void 0,this._panoramaGrayWidths=void 0,this._distanceImageWidths=void 0,this._type=void 0,this._scanPointsShown=!1,this._distanceImages={},this._imagePathCache={}},WS.Scan.prototype={getID:function(){return this._UUID},matchesJson:function(e){return this._UUID===e.UUID},getBestFittingImage:function(e,t){var i=this._imagePathCache[t]||(this._imagePathCache[t]={});
return i[e]||(i[e]=this.getImagePath(this.getSimilarAvailablePanoImage(e,t)))},getSimilarAvailablePanoImage:function(e,t){if(WS.Scan.PanoImageColorModes.hasOwnProperty(t)){var i={width:e,colorModeId:t},n=this.arePanoImagesAvailableForMode(t);if(!n)for(var o in WS.Scan.PanoImageColorModes)if(o!=t&&(n=this.arePanoImagesAvailableForMode(o))){i.colorModeId=o;break}if(n)return i.width=this.getSimilarAvailablePanoImageWidth(e,i.colorModeId),i}},getSimilarAvailableImagesForBlending:function(e){var t=[];return t[0]=this.getSimilarAvailablePanoImage(e,"color"),t[1]=this.getSimilarAvailablePanoImage(e,"gray"),t},getSimilarAvailableDistanceImage:function(e){var t,i=F.cloneArray(this._distanceImageWidths).sort(function(e,t){return e-t});if(i[0]>=e)t=i[0];else for(var n=1,o=i.length;o>n;n++)if(i[n]>e){t=i[n-1];break}return t||(t=i[i.length-1]),t},getImagePath:function(e){if(e){var t=e.width,i=e.colorModeId;return WS._2GO?"ws2go-data/project/"+this._project+"/scans/"+this._UUID+"-"+i+"-"+t+".jpg":"/data/project/"+this._project+"/scan/"+this._UUID+"/"+i+"/"+t}},getDistanceImagePath:function(e){return WS._2GO?"ws2go-data/project/"+this._project+"/distances/"+this._UUID+"-"+e+".dist":"/data/project/"+this._project+"/distance/"+this._UUID+"/"+e},getPanoImageDescByPath:function(e){var t=WS._2GO?/.*\/scans\/.*-.*-(.*)\.jpg/:/.*\/scan\/.*\/.*\/(.*)/,i=WS._2GO?/.*\/scans\/.*-(.*)-.*\.jpg/:/.*\/scan\/.*\/(.*)\/.*/,n=t.exec(e),o=i.exec(e);if(o&&2===o.length&&n&&2===n.length){var r=parseInt(n[1]),a=o[1];return{width:r,colorModeId:a}}return void 0},getImageResolutionByPath:function(e){var t=this.getPanoImageDescByPath(e);if(t)return WS.Scan.getResolutionByWidth(t.width)},arePanoImagesAvailableForMode:function(e){if(!WS.Scan.PanoImageColorModes.hasOwnProperty(e))return!1;switch(e){case"gray":return this._panoramaGrayWidths?this._panoramaGrayWidths.length>0:!1;case"color":return this._panoramaColorWidths?this._panoramaColorWidths.length>0:!1;case"blend":return(this._panoramaColorWidths?this._panoramaColorWidths.length>0:!1)&&(this._panoramaGrayWidths?this._panoramaGrayWidths.length>0:!1)}},getSimilarAvailablePanoImageWidth:function(e,t){var i,n="color"==t?this._panoramaColorWidths:this._panoramaGrayWidths;if(0!==n.length){e=Math.min(e,WS.Scan.DeviceMaxResolutionPx);var o=F.cloneArray(n);if(o.sort(function(e,t){return e-t}),o[0]>=e)i=o[0];else for(var r=1,a=n.length;a>r;r++)if(o[r]>e){i=o[r-1];break}return i||(i=o[n.length-1]),i}},showScanPoints:function(){this._scanPointsShown=!0,this._service.showScanPoints(this)},hideScanPoints:function(){this._scanPointsShown=!1,this._service.hideScanPoints(this)},readJson:function(e){WS.Transformation.prototype.readJson.call(this,e),this._recordingTime=e.RecordingTime,this._modificationTime=e.ModificationTime,this._panoramaColorWidths=e.PanoramaColorWidths,this._panoramaGrayWidths=e.PanoramaGrayWidths,this._distanceImageWidths=e.DistanceImageWidths,this._type=e.Type},writeJson:function(){var e=WS.Transformation.prototype.writeJson.call(this);return e.RecordingTime=this._recordingTime,e.ModificationTime=this._modificationTime,e.PanoramaColorWidths=this._panoramaColorWidths,e.PanoramaGrayWidths=this._panoramaGrayWidths,e.DistanceImageWidths=this._distanceImageWidths,e.Type=this._type,e},getWeightedDistance:function(e,t,i){var n=this;return this._service.loadDistanceImage(this,this.getSimilarAvailableDistanceImage(i)).then(function(o){return n.lookupWeightedDistance(o,e,t,i)})},lookupWeightedDistance:function(e,t,i,n){var o=F.wrapTo_0_2PI(t),r=F.wrapTo_Minus05PI_05PI(i),a=.5*n,s=n-n*o/(2*Math.PI);s===n&&(s=0);var c=(r+.5*Math.PI)*a/Math.PI;c===a&&(c=0);var l,h,d,u,p,_,g,f,m=Math.floor(s),v=Math.floor(c),S=.5>s-m,b=.5>c-v;S&&b?(l=1-(s-(m-1+.5)),d=1-(c-(v-1+.5)),p=F.wrapPoint(m-1,v-1,n,a),_=F.wrapPoint(m,v-1,n,a),g=F.wrapPoint(m-1,v,n,a),f=[m,v]):S&&!b?(l=1-(s-(m-1+.5)),d=1-(c-(v+.5)),p=F.wrapPoint(m-1,v,n,a),_=[m,v],g=F.wrapPoint(m-1,v+1,n,a),f=F.wrapPoint(m,v+1,n,a)):!S&&b?(l=1-(s-(m+.5)),d=1-(c-(v-1+.5)),p=F.wrapPoint(m,v-1,n,a),_=F.wrapPoint(m+1,v-1,n,a),g=[m,v],f=F.wrapPoint(m+1,v,n,a)):(l=1-(s-(m+.5)),d=1-(c-(v+.5)),p=[m,v],_=F.wrapPoint(m+1,v,n,a),g=F.wrapPoint(m,v+1,n,a),f=F.wrapPoint(m+1,v+1,n,a)),h=1-l,u=1-d;var y,P=l*d,C=h*d,w=l*u,T=h*u,M=e[p[1]*n+p[0]],W=e[_[1]*n+_[0]],E=e[g[1]*n+g[0]],I=e[f[1]*n+f[0]];if(P>.99)return M;if(0===M&&(y=1/(1-P),C*=y,w*=y,T*=y,P=0),C>.99)return W;if(0===W&&(y=1/(1-C),P*=y,w*=y,T*=y,C=0),w>.99)return E;if(0===E&&(y=1/(1-w),P*=y,C*=y,T*=y,w=0),T>.99)return I;if(0===I&&(y=1/(1-T),P*=y,C*=y,w*=y,T=0),0===P&&0===C&&0===w&&0===T)return 0;var R=M*P,L=W*C,O=E*w,D=I*T,A=R+L+O+D;return A},createRenderable:function(e){if(e._type!==WS.PanoramaView.type&&e._type!==WS.OverviewMap.type)return void 0;var t=F.DI().getService("scancolorizer"),i=e._type===WS.OverviewMap.type?new WS.ScanMapRenderable(t):new WS.ScanPanoRenderable(t);i.setDataObject(this);var n=this;return i.update=function(t){var o=n.calcPositionInRefSystem(e._trafoView);i.setTranslation(o),i.updateAppearance(t)},i},createScanCloudRenderable:function(e,t){var i=WS.ScanCloudRenderable.DetailWidth[t.details3d()],n=t.getPrefferedColorMode();return new WS.ScanCloudRenderable(this,this._service,i,n._id,e)},canBeShownInView:function(){return!0},isVirtual:function(){return"Virtual"===this._type||"Photo"===this._type}},WS.extend("Scan","Transformation"),WS.Scan.PanoImageResolutions=[new WS.ImageResolution(1024,512,"low","FE_RESOLUTION_LOW"),new WS.ImageResolution(2048,1024,"medium","FE_RESOLUTION_MEDIUM"),new WS.ImageResolution(4096,2048,"high","FE_RESOLUTION_HIGH"),new WS.ImageResolution(8192,4096,"ultrahigh","FE_RESOLUTION_VERYHIGH")],WS.Scan.DeviceMaxResolutionIdx=F.isMobileSafari()?1:3,WS.Scan.DeviceMaxResolutionPx=F.isMobileSafari()?2048:8192,WS.Scan.getResolutionByWidth=function(e){for(var t=0,i=WS.Scan.PanoImageResolutions.length;i>t;t++)if(WS.Scan.PanoImageResolutions[t]._width===e)return WS.Scan.PanoImageResolutions[t];return void 0},WS.Scan.PanoImageColorModes={gray:new WS.ColorMode("gray","FE_GRAY"),color:new WS.ColorMode("color","FE_COLOR"),blend:new WS.ColorMode("blend","FE_BLEND")},WS.ScanService=function(e,t,i,n,o,r,a,s,c){WS.ProjectCRUDService.call(this,"Scan",WS.Scan,"/scan",{},e,t,i,n,o,r,a,s,c),this.provideMalePlug("ScanPointsShow",["showScanPoints","hideScanPoints"]),this._rootScan=void 0,this._scanToCache=void 0},WS.ScanService.prototype={showScanPoints:function(e){this.trigger("showScanPoints",[e])},hideScanPoints:function(e){this.trigger("hideScanPoints",[e])},loadDistanceImage:function(e,t){var i=this,n=WS.ScanService.BIG_SIZE;if(t>=n){var o=this._scanToCache;if(o&&o!==e)for(var r=n;8192>=r;r*=2)delete o._distanceImages[r];this._scanToCache=e}if(!e._distanceImages[t]){var a=Q.defer();e._distanceImages[t]=a.promise;var s=F.DI().get("$http");s.get(e.getDistanceImagePath(t),{responseType:"arraybuffer"}).success(function(o){t>=n&&e!==i._scanToCache&&(e._distanceImages[t]=void 0),a.resolve(new Float32Array(o))}).error(function(){e._distanceImages[t]=void 0,a.reject()})}return e._distanceImages[t]},getNearestScan:function(e,t,i,n){return this.getAll().then(function(o){if(0===o.length)throw new Error("EM_NO_SCAN_AVAILABLE");"center"===e&&(e=vec3.create(),o.forEach(function(t){vec3.add(e,t.getTranslationGlobal())}),vec3.scale(e,1/o.length));var r=2===e.length?vec2.length:vec3.length;if(e.length<16){var a=mat4.identity();mat4.setTranslation(a,[e[0],e[1],e[2]||0]),e=a}var s=o.map(function(t){return{distance:r(t.calcPositionInRefSystem(e)),scan:t}}).sort(function(e,t){return e.distance-t.distance}),c=s[0].scan,l=s.filter(function(e){return(!t||-1===t.indexOf(e.scan._UUID))&&(!i||i.indexOf(e.scan._UUID)>=0)});if(0===l.length){if(n)return c;throw new Error("EM_NO_SCAN_AVAILABLE")}return l[0].scan})},handleEntityChanges:function(e,t,i){return this._rootScan&&(F.findFirst(t,this._rootScan)||t.push(this._rootScan),F.findFirst(this._entities,this._rootScan)||this._entities.push(this._rootScan),F.removeFirst(i,this._rootScan)),F.ProjectCRUDService.prototype.handleEntityChanges.call(this,e,t,i)}},WS.extend("ScanService","ProjectCRUDService"),WS.ScanService.BIG_SIZE=1024,angular.module("ws.scanlist",[]),F.DI().registerService("scan",WS.ScanService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),F.DI().config("@plug",WS.scanPointPlug=function(e){e.describe("ScanPointsShow",["showScanPoints","hideScanPoints"])}),F.DI().config("@serializer","@scan",function(e,t){e.registerClass("Scan",function(){return t.getNew()})}),WS.Annotation=function(e){WS.Transformation.call(this,e),this._class="Annotation",this._description=void 0,this._hyperlinks=[],this._type=void 0,this._pointsLocal=void 0,this._pointsGlobal=void 0,this._pointScans=void 0,this._displayColor=void 0,this._displayLineWidth=void 0,this._displayLineType=void 0,this._displayAreaType=void 0,this._angle=void 0},WS.Annotation.prototype={readJson:function(e){F.Transformation.prototype.readJson.call(this,e),this.readHyperlinksJson(e),this._description=e.Description,this._type=e.Type,this._pointsLocal=e.PointsLocal,this._pointsGlobal=e.PointsGlobal,this._pointScans=e.PointScans,this._displayColor=e.DisplayColor,this._displayLineWidth=e.DisplayLineWidth,this._displayLineType=e.DisplayLineType,this._displayAreaType=e.DisplayAreaType,delete this._angle,WS._2GO&&(this._type=this._type||"")},writeJson:function(){var e=F.Transformation.prototype.writeJson.call(this);return this.writeHyperlinksJson(e),e.Class="Annotation",e.Description=this._description,e.Type=this._type,e.PointsLocal=this._pointsLocal,e.PointsGlobal=this._pointsGlobal,e.PointScans=this._pointScans,e.DisplayColor=this._displayColor,e.DisplayLineWidth=this._displayLineWidth,e.DisplayLineType=this._displayLineType,e.DisplayAreaType=this._displayAreaType,e.Angle=this._angle,e},writeChanges:function(){var e=WS.Transformation.prototype.writeChanges.call(this);return this.writeHyperlinksChanges(e)},createRenderable:function(e){if(this.isPolyline()){if(this._type===WS.Annotation.Type.POLYLINE_MAP){var t=e._mapObject?e._mapObject._trafoGlobal:mat4.identity();return this.createRenderableInternal(e,t)}var i,n,o=F.DI().getService("scan"),r=F.DI().getService("transformation"),a=this._ancestors&&this._ancestors.length&&this._ancestors[this._ancestors.length-1];a&&"Transformation"===a.Class?i=r:a&&"Scan"===a.Class?i=o:this._type===WS.Annotation.Type.POLYLINE_SCAN?(i=o,n=r):(i=r,n=o);var s=this;return i.getByID(s._parentUUID).fail(function(e){if(n)return n.getByID(s._parentUUID);throw e}).then(function(t){return s.createRenderableInternal(e,t._trafoGlobal)})}return this.createRenderableInternal(e,void 0)},createRenderableInternal:function(e,t){var i;if(this.isPolyline()){var n=this.calcTrafoInRefSystem(e._trafoView,t),o=this._type!==WS.Annotation.Type.POLYLINE_MAP&&e.getRelatedScanUUIDs?e.getRelatedScanUUIDs():void 0;i=new WS.PolylineAnnotationRenderable(this,n,o,F.DI().getService("unit"))}else i=new WS.AnnotationRenderable(this.hasMapType());i.setDataObject(this);var r=this;return i.update=function(){if(!r.isPolyline()){var t=r.calcPositionInRefSystem(e._trafoView);i.setTranslation(t)}i.setText(r._displayName,!0),i.updateIcon(),r.isPolyline()&&(i._lineColor=F.ColorGenerator.intColorToDbl(r._displayColor),i.updateSegmentLines(),i.updateDashLength(),i.updateAreaPolygon()),i.addToLayer(WS.Layer.LayerIDs.ANNOTATIONS,!0)},i},canBeShownInView:function(e){return"map"!==e&&("panorama"!==e&&"3d"!==e||this.hasMapType())?!1:!0},hasMapType:function(){return this._type===WS.Annotation.Type.MAP||this._type===WS.Annotation.Type.POLYLINE_MAP},isPolyline:function(){return this._type===WS.Annotation.Type.POLYLINE_MAP||this._type===WS.Annotation.Type.POLYLINE_SCAN||this._type===WS.Annotation.Type.POLYLINE_MULTI||this._type===WS.Annotation.Type.POLYLINE_SPACE},isClosedMapPolyline:function(){var e=this._pointsGlobal;return this._type===WS.Annotation.Type.POLYLINE_MAP&&3<e.length&&F.closeToArray(e[0],e[e.length-1])},getBoundingBox:function(){var e=this.isPolyline()?this._pointsGlobal:[this.getTranslationGlobal()];return new WS.BoundingBox3d(e)},determineOrientation:function(){if(!this.isPolyline())return"x";var e=this.getBoundingBox();return e.determineOrientation(this._pointsGlobal)},getGlobalOrLocalPoints:function(e){return e===WS.UnitService.CS.LOCAL?this._pointsLocal:this._pointsGlobal}},WS.extend("Annotation","Transformation"),WS.mixin("Annotation","HyperlinkedObject"),WS.Annotation.Type={DEFAULT:"",POINT_VALID:"PointValid",POINT_INVALID:"PointInvalid",MAP:"Map",OBJECT:"Object",SPACE:"Space",POLYLINE_MAP:"PolylineMap",POLYLINE_SCAN:"PolylineScan",POLYLINE_MULTI:"PolylineMulti",POLYLINE_SPACE:"PolylineSpace"},WS.AnnotationService=function(e,t,i,n,o,r,a,s,c){WS.ProjectCRUDService.call(this,"Annotation",WS.Annotation,"/annotation",{},e,t,i,n,o,r,a,s,c)},WS.extend("AnnotationService","ProjectCRUDService"),angular.module("ws.annotation",[]),F.DI().registerService("annotation",WS.AnnotationService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),F.DI().config("@serializer","@annotation",function(e,t){e.registerClass("Annotation",function(){return t.getNew()})}),F.DI().config("@task",function(e){e.registerTaskFactory("default","overviewmap","annotate",WS.AnnotateMapTask,"@plug","@annotation","@locale","@point3d","@unit","@category","@tag","@layer","@project"),e.registerTaskFactory("default","panoramaview","annotate",WS.AnnotatePanoTask,"@plug","@annotation","@locale","@point3d","@unit","@category","@tag","@layer","@project","@alert")}),WS.AnnotateTask=function(e,t,i,n,o,r,a,s,c,l){F.Task.call(this,e),this._annotation=t,this._locale=i,this._point3d=n,this._unit=o,this._cat=r,this._tag=a,this._layer=s,this._projectService=c,this._project=void 0,this._viewType=l,this._description=[{caption:"TD_CREATE_ANNOTATION_PICK",description:"TC_CREATE_ANNOTATION_PICK",widget:'<div ng-show="0 < input.pickedPoints.length"><p style="font-weight: bold;">{{"FE_SELECTED_POINTS_1" | i18n | addlengthunit}}:</p>'+this.getPointListDesc()+'<checkbox ng-show="2 < input.pickedPoints.length" target="input.close" source="input.close" name="{{ \'FE_CONNECT_END_POINTS\' | i18n }}"></checkbox></div><alert type="info" ng-show="!hasEnoughPoints()" style="margin-bottom: 10px !important;">{{ \'FE_PTS_REQUIRED\' | i18n }}: {{stillRequiredPoints()}}</alert><button ng-show="!input.pickPolyline" ng-click="pickPolyline()" class="btn btn-default f_btnAutoWidth" style="width: 224px; margin-top: 5px;" title="{{\'FE_SELECT_AREA\'|i18n}}"><div style="margin-left: -28px;"><img class="f_icon24" static-src="icons/im/taskbar/overviewmap/measurearea.png"/> {{\'FE_SELECT_AREA\'|i18n}}</div></button>',icon:WS.Icons.TaskSection.point3d,female:"PointPick3D",pinBinding:"pickPoint(input.pickedPoint)",pageConfiguration:{mode:this._viewType===WS.Layer.ViewTypes.PANO_VIEW?WS.ViewBase.Mode.PickPointOpenScans:WS.ViewBase.Mode.PickPolygon},completeCondition:"hasEnoughPoints() && pointsReady()"},this.getColorStep({startCondition:"input.pickPolyline"}),this.getNameStep({optional:!1,completeCondition:"input.name.length > 0 && !validateName(input.name)"}),this.getDescriptionStep(),this.getHyperlinkStep(),this.getCategoryStep(),this.getTagStep()]},WS.AnnotateTask.prototype={setup:function(e){var t=this;this.$scope=e,this.setupNameStep(),this.setupHyperlinkStep(),this.setupMixin(e),this.setupColorStep(),e.input.pickPolyline=!1,e.input.close=!0,e.hasEnoughPoints=function(){return e.input.pickPolyline?1<e.input.pickedPoints.length:0<e.input.pickedPoints.length},e.stillRequiredPoints=function(){return Math.max(0,(e.input.pickPolyline?2:1)-e.input.pickedPoints.length)},e.pickPolyline=function(){e.input.pickPolyline=!0,t.trigger("setPickedPoints",[e.input.pickedPoints,e.input.close,t.getLineColor(),void 0,t.getLineColor()])},e.$watch("input.color",function(i){if(F.ColorGenerator.isHexColor(i)){var n=e.input.pickedPoints;0<n.length&&t.trigger("setPickedPoints",[n,e.input.close,t.getLineColor(),void 0,t.getLineColor()])}})},teardown:function(){this.teardownMixin()},executeBase:function(e,t){return t._description=e.description,t._displayName=e.name,t._category=e.category,t._tags=e.tags,e.hyperlinkObjects&&(t._hyperlinks=e.hyperlinkObjects),t.isPolyline()&&(t._displayColor=F.ColorGenerator.hexToRGBA(e.color,!0)),t.create().then(F.proxy(function(){return t._service._filter(t)?this.isVisible(e.pickedPoints[0])?void 0:new WS.TaskResult([],["IM_HIDDEN_OBJECT"]):new WS.TaskResult([],["IM_FILTERED_OBJECT"])},this))},isVisible:function(){return this._layer.isLayerVisible(WS.Layer.LayerIDs.ANNOTATIONS,this._viewType)},getLineColor:function(){return this.$scope.input.pickPolyline?F.ColorGenerator.intColorToDbl(F.ColorGenerator.hexToRGBA(this.$scope.input.color,!0)):void 0}},WS.extend("AnnotateTask","Task"),WS.mixin("AnnotateTask","ModelTask"),WS.mixin("AnnotateTask","PickPointsTask"),WS.AnnotatePanoTask=function(e,t,i,n,o,r,a,s,c,l){WS.AnnotateTask.call(this,e,t,i,n,o,r,a,s,c,WS.Layer.ViewTypes.PANO_VIEW),this._pano=e.getPlugModule("pv1"),this._alert=l},WS.AnnotatePanoTask.prototype={queryTaskLaunch:function(e,t){return"default"===e&&"panoramaview"===t},setup:function(e){WS.AnnotateTask.prototype.setup.call(this,e);var t=this;e.$watch("input.pickedPoint",function(i){if(i&&i._takenInView._type===WS.PanoramaView.type){var n=e.input.pickedPoints;e.input.pickPolyline||0===n.length?n.push(i):n[0]=i,t.applyPickedPointInScanView(e,n,i,e.input.close)}}),this.watchClose(e,!1)},isVisible:function(e){var t=WS.Layer.LayerIDs.ANNOTATIONS,i=this._layer.isLayerVisible(t,this._viewType),n=this._layer.getObjectsVisbleUpToDistance(t,this._viewType),o=e._positionLocal?vec3.length(e._positionLocal):vec3.dist(e._positionGlobal,e._takenInView.getCamGlobalPos());return i&&n>o},execute:function(e){var t=e.pickedPoints,i=this._annotation.getNew(),n=this.getTypeInfo(t);if(1<t.length)this.setPointsAttributes(i,t,n,e.close),i._type=n[0]?WS.Annotation.Type.POLYLINE_SPACE:1===n[1]?WS.Annotation.Type.POLYLINE_SCAN:WS.Annotation.Type.POLYLINE_MULTI;else{var o=t[0];n[0]?(i._trafoGlobal=o.getTrafoGlobal(),i._type=WS.Annotation.Type.SPACE):(i._trafoLocal=o.getTrafoLocal(),i._type=o._pointState===WS.Point3d.PointState.Valid?WS.Annotation.Type.POINT_VALID:WS.Annotation.Type.POINT_INVALID,i._parentUUID=o._refSystem._UUID)}return this.executeBase(e,i)}},WS.extend("AnnotatePanoTask","AnnotateTask"),WS.AnnotateMapTask=function(e,t,i,n,o,r,a,s,c){WS.AnnotateTask.call(this,e,t,i,n,o,r,a,s,c,WS.Layer.ViewTypes.OVERVIEW_MAP)},WS.AnnotateMapTask.prototype={queryTaskLaunch:function(e,t){return"default"===e&&"overviewmap"===t},setup:function(e){WS.AnnotateTask.prototype.setup.call(this,e);var t=this;e.$watch("input.pickedPoint",function(i){if(i&&i._takenInView instanceof WS.OverviewMap){var n=e.input.pickedPoints;e.input.pickPolyline||0===n.length?n.push(i):n[0]=i,t.applyPickedPointInMap(e,n,i,e.input.close)}}),this.watchClose(e,!0)},execute:function(e){var t=e.pickedPoints,i=this._annotation.getNew();return i._parentUUID=t[0]._refSystem._UUID,1<t.length?(i._type=WS.Annotation.Type.POLYLINE_MAP,i._pointsGlobal=[],t.forEach(function(e){i._pointsGlobal.push(e._positionGlobal)}),e.close&&this.closeArea(i._pointsGlobal)):(i._type=WS.Annotation.Type.MAP,i._trafoGlobal=t[0].getTrafoGlobal()),this.executeBase(e,i)}},WS.extend("AnnotateMapTask","AnnotateTask"),WS.Measurement=function(e){WS.Transformation.call(this,e),this._class="Measurement",this._type=void 0,this._displayType=void 0,this._distance=void 0,this._pointsLocal=void 0,this._pointsGlobal=void 0,this._pointScans=void 0,this._pointStates=void 0,this._segmentStates=void 0,this._distances=void 0,this._distanceStartEnd=void 0,this._distanceHorizontalLocal=void 0,this._distanceHorizontalGlobal=void 0,this._distanceVerticalLocal=void 0,this._distanceVerticalGlobal=void 0,this._distanceXLocal=void 0,this._distanceXGlobal=void 0,this._distanceYLocal=void 0,this._distanceYGlobal=void 0,this._axisPointLocal=void 0,this._axisPointGlobal=void 0,this._objectUUIDs=void 0,this._objectClasses=void 0,this._objectPaths=void 0,this._area=void 0,this._centroidLocal=void 0,this._centroidGlobal=void 0,this._areaValid=void 0,this._angles=void 0,this._trafoCustomOfProj=void 0,this._pointsCustom=void 0,this._distXCustom=void 0,this._distYCustom=void 0,this._distZCustom=void 0,this._distHCustom=void 0,this._centroidCustom=void 0},WS.Measurement.prototype={readJson:function(e){WS.Transformation.prototype.readJson.call(this,e),this._type=e.Type,this._displayType=e.DisplayType,this._distance=e.Distance,this._pointsLocal=e.PointsLocal,this._pointsGlobal=e.PointsGlobal,this._pointScans=e.PointScans,this._pointStates=e.PointStates,this._segmentStates=e.SegmentStates,this._distances=e.Distances,this._distanceStartEnd=e.DistanceStartEnd,this._distanceHorizontalLocal=e.DistanceHorizontalLocal,this._distanceHorizontalGlobal=e.DistanceHorizontalGlobal,this._distanceVerticalLocal=e.DistanceVerticalLocal,this._distanceVerticalGlobal=e.DistanceVerticalGlobal,this._distanceXLocal=e.DistanceXLocal,this._distanceXGlobal=e.DistanceXGlobal,this._distanceYLocal=e.DistanceYLocal,this._distanceYGlobal=e.DistanceYGlobal,this._axisPointLocal=e.AxisPointLocal,this._axisPointGlobal=e.AxisPointGlobal,this._objectUUIDs=e.ObjectUUIDs,this._objectClasses=e.ObjectClasses,this._objectPaths=e.ObjectPaths,this._area=e.Area,this._centroidLocal=e.CentroidLocal,this._centroidGlobal=e.CentroidGlobal,this._areaValid=e.AreaValid,delete this._angles,WS._2GO&&(this._areaValid=this._areaValid||(this._type===WS.Measurement.Type.Map?!0:void 0))},writeJson:function(){var e=WS.Transformation.prototype.writeJson.call(this);return e.Class="Measurement",e.Type=this._type,e.DisplayType=this._displayType,e.Distance=this._distance,e.PointsLocal=this._pointsLocal,e.PointsGlobal=this._pointsGlobal,e.PointScans=this._pointScans,e.PointStates=this._pointStates,e.SegmentStates=this._segmentStates,e.Distances=this._distances,e.DistanceStartEnd=this._distanceStartEnd,e.DistanceHorizontalLocal=this._distanceHorizontalLocal,e.DistanceHorizontalGlobal=this._distanceHorizontalGlobal,e.DistanceVerticalLocal=this._distanceVerticalLocal,e.DistanceVerticalGlobal=this._distanceVerticalGlobal,e.DistanceXLocal=this._distanceXLocal,e.DistanceXGlobal=this._distanceXGlobal,e.DistanceYLocal=this._distanceYLocal,e.DistanceYGlobal=this._distanceYGlobal,e.AxisPointLocal=this._axisPointLocal,e.AxisPointGlobal=this._axisPointGlobal,e.ObjectUUIDs=this._objectUUIDs,e.ObjectClasses=this._objectClasses,e.ObjectPaths=this._objectPaths,e.Area=this._area,e.CentroidLocal=this._centroidLocal,e.CentroidGlobal=this._centroidGlobal,e.Angles=this._angles,e.AreaValid=this._areaValid,e},createRenderable:function(e){if(e._type===WS.PanoramaView.type){var t,i,n=F.DI().getService("scan"),o=F.DI().getService("transformation"),r=this._ancestors&&this._ancestors.length&&this._ancestors[this._ancestors.length-1];r&&"Transformation"===r.Class?t=o:r&&"Scan"===r.Class?t=n:this._type===WS.Measurement.Type.ScanPoint?(t=n,i=o):(t=o,i=n);var a=this;return t.getByID(a._parentUUID).fail(function(e){if(i)return i.getByID(a._parentUUID);throw e}).then(function(t){return a.createRenderableForPanoView(e,t._trafoGlobal)})}return this.createRenderableForMap(e,e._mapObject?e._mapObject._trafoGlobal:mat4.identity())},createRenderableForPanoView:function(e,t){var i=this.calcTrafoInRefSystem(e._trafoView,t),n=new WS.MeasurementRenderable(this,i,F.DI().getService("unit"),F.DI().getService("locale"),F.DI().getService("domainsettings"),e.getRelatedScanUUIDs(),e._trafoView);return n.setDataObject(this),this.addUpdateMethodToRenderable(n),n},createRenderableForMap:function(e,t){var i=this.calcTrafoInRefSystem(mat4.identity(),t),n=this._displayType===WS.Measurement.DisplayType.Distance?new WS.MeasurementRenderable(this,i,F.DI().getService("unit"),F.DI().getService("locale"),F.DI().getService("domainsettings"),void 0,e._trafoView):new WS.AreaMeasurementRenderable(this,i,F.DI().getService("unit"),F.DI().getService("locale"),F.DI().getService("domainsettings"),e._trafoView);return n.setDataObject(this),this.addUpdateMethodToRenderable(n),n},addUpdateMethodToRenderable:function(e){var t=this;e.update=function(){this._temporary=t.instanceOf(WS.TempMeasurement),this._type=t._type,this._distance=t._distance,this._distances=t._distances,this._pointsLocal=t._pointsLocal,this._pointScans=t._pointScans,this._pointStates=t._pointStates,this._segmentStates=t._segmentStates,this._axisPointLocal=t._axisPointLocal,this._distanceStartEnd=t._distanceStartEnd,this._distanceHorizontalGlobal=t._distanceHorizontalGlobal,this._distanceVerticalGlobal=t._distanceVerticalGlobal,this._distanceXGlobal=t._distanceXGlobal,this._distanceYGlobal=t._distanceYGlobal,this._objectUUIDs=t._objectUUIDs,this._objectClasses=t._objectClasses,t._type===WS.Measurement.Type.Map&&(this._area=t._area,this._centroidLocal=t._centroidLocal,this._areaValid=t.isAreaValid()),this.updateAppearance()}},areSegmentsValid:function(){if(!this._segmentStates)return!0;for(var e=this._segmentStates.length,t=0;e>t;t++)if(0!==this._segmentStates[t])return!1;return!0},isSegmentValid:function(e){return!this._segmentStates||0===this._segmentStates[e]},isPointValid:function(e){return void 0===this._pointStates||0===this._pointStates[e]},isStartEndValid:function(){return!this._pointStates||this.isPointValid(0)&&this.isPointValid(this._pointStates.length-1)},canBeShownInView:function(e){var t=WS.Measurement.Type;switch(e){case"map":return this._type===t.Map;case"panorama":return this._type===t.MultiScanPoint||(this._type===t.ScanPoint||this._type===t.SpacePoint||this._type===t.Object)&&this._ancestors.some(function(e){return"Scan"===e.Class});case"3d":return this._type!==t.Map}return!1},isAreaValid:function(){return this._exportVersion<4||this._areaValid},getBoundingBox:function(){return new WS.BoundingBox3d(this._pointsGlobal)},determineOrientation:function(){var e=this.getBoundingBox();return e.determineOrientation(this._pointsGlobal)},setCustomTrafo:function(e){if(void 0===e)this._trafoCustomOfProj=void 0,this._pointsCustom=void 0,this._distXCustom=void 0,this._distYCustom=void 0,this._distZCustom=void 0,this._distHCustom=void 0,this._centroidCustom=void 0;else{this._trafoCustomOfProj=e,this._pointsCustom=mat4.positionsInRefSystem(this._pointsGlobal,this._trafoCustomOfProj);var t=this._pointsCustom.length,i=this._pointsCustom[0],n=this._pointsCustom[t-1];this._distXCustom=Math.abs(n[0]-i[0]),this._distYCustom=Math.abs(n[1]-i[1]),this._distZCustom=Math.abs(n[2]-i[2]),this._distHCustom=Math.sqrt(this._distXCustom*this._distXCustom+this._distYCustom*this._distYCustom),this._centroidGlobal&&(this._centroidCustom=this.calcPositionInRefSystem(this._trafoCustomOfProj,this._centroidGlobal))}},getGlobalOrLocalPoints:function(e){return e===WS.UnitService.CS.LOCAL?this._pointsLocal:this._pointsGlobal}},WS.extend("Measurement","Transformation"),WS.Measurement.ObjectClasses={Scan:"Scan",PointCloud:"PointCloud",Sphere:"Sphere",Plane:"Plane",PlanEx:"PlaneWithBorder",Rectangle:"Rectangle",Slab:"Slab",Pipe:"Pipe"},WS.Measurement.Type={ScanPoint:"ScanPointMeasurement",MultiScanPoint:"MultiScanPointMeasurement",Object:"ObjectMeasurement",SpacePoint:"SpacePointMeasurement",Map:"MapMeasurement"},WS.Measurement.DisplayType={Distance:"Distance",Area:"Area"},WS.Measurement.SegmentState={VALID:0,INVALID:1,UNLOADED:2},WS.MeasurementService=function(e,t,i,n,o,r,a,s,c){WS.ProjectCRUDService.call(this,"Measurement",WS.Measurement,"/measurement",{},e,t,i,n,o,r,a,s,c)},WS.extend("MeasurementService","ProjectCRUDService"),WS.TempMeasurement=function(e){WS.Measurement.call(this,e),this._temporary=!0},WS.extend("TempMeasurement","Measurement"),WS.TempMeasurementService=function(e,t,i,n,o,r,a,s,c,l){WS.ProjectCRUDService.call(this,"TempMeasurement",WS.TempMeasurement,"/measurement",{},e,t,i,n,o,r,a,s,l),this._mapObject=c},WS.TempMeasurementService.prototype={generateName:function(){var e=this._entities.length,t=9>e?"0"+(e+1):e+1;return"TemporaryMeasurement"+t},getNew:function(){var e=WS.ProjectCRUDService.prototype.getNew.call(this);return e._name=this.generateName(),e},create:function(e,t){var i=t||{};return i.temporary=!0,WS.ProjectCRUDService.prototype.create.call(this,e,i)},remove:function(e){return F.removeFirst(this._entities,e)&&(e.unselect(),this.trigger("removeObjects",[[e]])),Q.resolve()},update:function(){},getAll:function(e,t){var i=t||function(){return!0};return Q.resolve(this._entities.filter(i))}},WS.extend("TempMeasurementService","ProjectCRUDService"),WS.DistanceService=function(e,t){this.$http=e,this._error=t},WS.DistanceService.prototype={get:function(e,t,i,n,o){var r=Q.defer();return this.$http({method:"GET",url:"/measurement/distance/"+e+"/"+t+"/"+i+"/"+n+"/"+o}).success(function(e){r.resolve(e)}).error(this._error.httpHandler(r)),r.promise}},WS.extend("DistanceService"),F.DI().registerService("measurement",WS.MeasurementService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),F.DI().registerService("tempmeasurement",WS.TempMeasurementService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","@mapobject","$resource"),F.DI().registerService("distance",WS.DistanceService,"$http","@error"),F.DI().config("@serializer","@measurement",function(e,t){e.registerClass("Measurement",function(){return t.getNew()})}),F.DI().config("@serializer","@tempmeasurement",function(e,t){e.registerClass("TempMeasurement",function(){return t.getNew()})}),F.DI().config("@task",function(e){e.registerTaskFactory("default","overviewmap","measuredistance",WS.MeasureMapTask,"@plug","@point3d","@measurement","@tempmeasurement","@unit","@locale","@login","@category","@tag","@layer","@domainsettings","@project"),e.registerTaskFactory("default","overviewmap","measurearea",WS.MeasureAreaTask,"@plug","@point3d","@measurement","@tempmeasurement","@unit","@locale","@login","@category","@tag","@layer","@domainsettings","@project"),e.registerTaskFactory("default","panoramaview","measuredistance",WS.MeasurePanoTask,"@plug","@point3d","@measurement","@tempmeasurement","@unit","@locale","@login","@category","@tag","@layer","@alert","@domainsettings","@project")}),WS.MeasureTask=function(e,t,i,n,o,r,a,s,c,l,h,d,u){F.Task.call(this,e),this._point3d=t,this._locale=r,this._measurement=i,this._tempmeasurement=n,this._unit=o,this._login=a,this._cat=s,this._tag=c,this._layer=l,this._domainSettings=h,this._projectService=d,this._project=void 0,this._viewType=u;var p={startCondition:"input.persist"};this._description=[{caption:"TC_CREATE_MEASUREMENT",description:"TD_CREATE_MEASUREMENT",widget:'<alert type="info" ng-show="!hasEnoughPoints()">{{ \'FE_PTS_REQUIRED\' | i18n }}: {{stillRequiredPoints()}}</alert><alert type="info" ng-show="viewType == \'PanoramaView\' && input.pickedPoints.length > 0">{{ \'FE_NAVIGATE_TO_PICK\' | i18n }}</alert><p ng-show="input.pickedPoints.length > 0" style="font-weight: bold;">{{"FE_SELECTED_POINTS_1" | i18n | addlengthunit}}:</p>'+this.getPointListDesc()+'<checkbox ng-show="2 < input.pickedPoints.length && !isForArea" target="input.close" source="input.close" name="{{ \'FE_CONNECT_END_POINTS\' | i18n }}"></checkbox>',icon:WS.Icons.TaskSection.point3d,female:"PointPick3D",pinBinding:"pickPoint(input.pickedPoint)",pageConfiguration:{mode:this._viewType===WS.Layer.ViewTypes.PANO_VIEW?WS.ViewBase.Mode.PickPointOpenScans:WS.ViewBase.Mode.PickPolygon},completeCondition:"hasEnoughPoints() && pointsReady()"},this.getNameStep()],WS._2GO||this._description.push({caption:"TC_SAVE_MEASUREMENT",optional:!0,widget:'<checkbox target="input.persist" source="input.checkPersist" ng-show="input.isUser" name="{{\'TD_PERSIST_MEASUREMENT\' | i18n}}"></checkbox><div ng-show="!input.loggedIn"><img class="f_icon32" static-src="icons/im/alerts/info.png"/> {{"FE_ONLY_TEMP_MEASUREMENT" | i18n}}</div><div ng-show="input.loggedIn && !input.isUser"><img class="f_icon32" static-src="icons/im/alerts/info.png"/> {{"FE_MEASUREMENT_NO_USER" | i18n}}</div>',icon:WS.Icons.TaskSection.check,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1}},this.getCategoryStep(p),this.getTagStep(p))
},WS.MeasureTask.prototype={setup:function(e){var t=this;t.$scope=e,this.setupNameStep(),this.setupMixin(e),e.viewType=this._viewType,e.input.loggedIn=!1,e.input.isUser=!1,e.input.checkPersist=!1,e.input.close=!1,e.hasEnoughPoints=function(){return 1<e.input.pickedPoints.length},e.stillRequiredPoints=function(){return Math.max(0,2-e.input.pickedPoints.length)},this.preallocatePersist(e.input)},teardown:function(){this.teardownMixin()},executeBase:function(e,t){return""!==e.name&&(t._displayName=e.name),e.persist&&(t._category=e.category,t._tags=e.tags),t.create().then(F.proxy(function(){return e.persist&&!t._service._filter(t)?new WS.TaskResult([],["IM_FILTERED_OBJECT"]):this._layer.isLayerVisible(WS.Layer.LayerIDs.MEASUREMENTS,this._viewType)?void 0:new WS.TaskResult([],["IM_HIDDEN_OBJECT"])},this))},preallocatePersist:function(e){var t=this;this._login.isLoggedIn().then(function(i){e.loggedIn=i,i&&t._login.isUser().then(function(i){e.isUser=i,i&&t._domainSettings.get().then(function(t){e.checkPersist=t._persistMeasurements}).done()}).done()}).done()},getLineColor:function(){return void 0}},WS.extend("MeasureTask","Task"),WS.mixin("MeasureTask","ModelTask"),WS.mixin("MeasureTask","PickPointsTask"),WS.MeasurePanoTask=function(e,t,i,n,o,r,a,s,c,l,h,d,u){WS.MeasureTask.call(this,e,t,i,n,o,r,a,s,c,l,d,u,WS.Layer.ViewTypes.PANO_VIEW),this._pano=this._plug.getPlugModule("pv1"),this._alert=h},WS.MeasurePanoTask.prototype={queryTaskLaunch:function(e,t){return"default"===e&&("panoramaview"===t||"overviewmap"===t||"object"===t)},setup:function(e){WS.MeasureTask.prototype.setup.call(this,e);var t=this;e.$watch("input.pickedPoint",function(i){if(i&&i._takenInView instanceof WS.PanoramaView){var n=e.input.pickedPoints;n.push(i),t.applyPickedPointInScanView(e,n,i,e.input.close)}}),this.watchClose(e,!1)},execute:function(e){var t=e.persist?this._measurement.getNew():this._tempmeasurement.getNew(),i=e.pickedPoints,n=this.getTypeInfo(i);this.setPointsAttributes(t,i,n,e.close),t._type=n[0]?WS.Measurement.Type.SpacePoint:1===n[1]?WS.Measurement.Type.ScanPoint:WS.Measurement.Type.MultiScanPoint;var o=this;return this.executeBase(e,t).then(function(e){return e||!n[0]||o._pano.isRootCloud()||(e=new WS.TaskResult([],["IM_HIDDEN_OBJECT"])),e})}},WS.extend("MeasurePanoTask","MeasureTask"),WS.MeasureMapTask=function(e,t,i,n,o,r,a,s,c,l,h,d){WS.MeasureTask.call(this,e,t,i,n,o,r,a,s,c,l,h,d,WS.Layer.ViewTypes.OVERVIEW_MAP)},WS.MeasureMapTask.prototype={queryTaskLaunch:function(e,t){return"default"===e&&"overviewmap"===t},setup:function(e){WS.MeasureTask.prototype.setup.call(this,e);var t=this;e.$watch("input.pickedPoint",function(i){if(i&&i._takenInView._type===WS.OverviewMap.type){var n=e.input.pickedPoints;n.push(i),t.applyPickedPointInMap(e,n,i,e.input.close)}}),this.watchClose(e,!0)},execute:function(e){var t=e.pickedPoints,i=e.persist?this._measurement.getNew():this._tempmeasurement.getNew();return i._parentUUID=t[0]._refSystem._UUID,i._type=WS.Measurement.Type.Map,i._displayType=WS.Measurement.DisplayType.Distance,i._pointsGlobal=[],t.forEach(function(e){i._pointsGlobal.push(e._positionGlobal)}),e.close&&this.closeArea(i._pointsGlobal),this.executeBase(e,i)}},WS.extend("MeasureMapTask","MeasureTask"),WS.MeasureAreaTask=function(e,t,i,n,o,r,a,s,c,l,h,d){WS.MeasureMapTask.call(this,e,t,i,n,o,r,a,s,c,l,h,d)},WS.MeasureAreaTask.prototype={setup:function(e){WS.MeasureMapTask.prototype.setup.call(this,e);e.input.close=!0,e.isForArea=!0,e.hasEnoughPoints=function(){return 2<e.input.pickedPoints.length},e.stillRequiredPoints=function(){return Math.max(0,3-e.input.pickedPoints.length)}},execute:function(e){var t=e.pickedPoints,i=e.persist?this._measurement.getNew():this._tempmeasurement.getNew();i._parentUUID=t[0]._refSystem._UUID,i._type=WS.Measurement.Type.Map,i._displayType=WS.Measurement.DisplayType.Area,i._pointsGlobal=[],t.forEach(function(e){i._pointsGlobal.push(e._positionGlobal)});this.closeArea(i._pointsGlobal);return this.executeBase(e,i)}},WS.extend("MeasureAreaTask","MeasureMapTask"),WS.AlertService=function(e){this._locale=e,this._iconWarning=this.createIconMarkup("warning.png"),this._iconInfo=this.createIconMarkup("info.png"),this._iconTip=this.createIconMarkup("tip.png"),this._iconMessage=this.createIconMarkup("message.png"),this._iconClose='<img align="right" class="f_icon24 ws_alertifyIconClose f_unselectable" unselectable="on" src="'+WS.imgUrl("icons/im/alerts/close.png")+'" />'},WS.AlertService.prototype={createIconMarkup:function(e){return'<img align="left" class="f_icon32 f_unselectable" unselectable="on" src="'+WS.imgUrl("icons/im/alerts/"+e)+'" />'},createMessageMarkup:function(e){return'<div class="f_unselectable" unselectable="on" style="display:inline;"><p style="margin-left:32px; margin-top:5px;" unselectable="on">'+e+"</p></div>"},error:function(e,t,i,n){var o=this._locale.translateAndCompose(e,n);i&&(o+=i),alertify.error(this._iconClose+this._iconWarning+this.createMessageMarkup(o),t||F.AlertServiceBase.DELAY_FOREVER)},errorObj:function(e,t){var i,n=e.message,o=e._infos;if("EM_LOCK"===n){var r=o.Holder||"n/a",a=o.Locked||"n/a";i=o.Operation,"Create"===i?this.error("EM_LOCK_C",t,void 0,[r,a]):"Update"===i?this.error("EM_LOCK_U",t,void 0,[a,r]):"Delete"===i?this.error("EM_LOCK_D",t,void 0,[a,r]):this.error("EM_LOCK",t,void 0,[a])}else if("EM_INVALID_STATE"===n){var s=o.ObjectName||"n/a",c=o.Data||"n/a";i=o.Operation,"Update"===i?this.error("EM_STATE_U",t,void 0,[s]):"Delete"===i?this.error("EM_STATE_D",t,void 0,[s]):"CreateData"===i?this.error("EM_STATE_CD",t,void 0,[c]):"DeleteData"===i?this.error("EM_STATE_DD",t,void 0,[c]):this.error("EM_STATE",t,void 0,[s])}else this.error(n,t)},message:function(e,t,i){var n=this._locale.translateAndCompose(e,i);alertify.success(this._iconClose+this._iconInfo+this.createMessageMarkup(n),void 0===t?F.AlertServiceBase.DELAY_SHORT:t)},debugMessage:function(e,t){alertify.success(this._iconClose+this._iconInfo+this.createMessageMarkup(e),void 0===t?F.AlertServiceBase.DELAY_FOREVER:t)},tip:function(e,t,i){var n=this._locale.translateAndCompose(e,i);alertify.success(this._iconClose+this._iconTip+this.createMessageMarkup(n),void 0===t?F.AlertServiceBase.DELAY_SHORT:t)}},WS.extend("AlertService","AlertServiceBase"),F.DI().redefineService("alert",WS.AlertService,"@locale"),WS.Headerbar=function(e,t,i,n,o,r,a,s){WS.PlugController.call(this,e,n);var c=this;this._login=t,this._locale=i,this._alert=o,this._jobQueue=r,this._project=s,e.userDirectory=window.F_USER_DIRECTORY,e.activeLanguage=function(){return c._locale.getActiveLanguage()},e.availableLanguages=function(){return c._locale.getLanguages()},e.setLanguage=function(t){c._locale.setLanguage(t.id),e.closeMenus()},e.setToolTipTaskPanel=function(e){return c._locale.translate(e?"FE_MAXIMIZE_TASKPANEL":"FE_MINIMIZE_TASKPANEL")},e.loginState="Login",e.taskpanelCollapsed=!1,e.username=void 0,e.panel="default",e.toggleTaskPanel=function(){"default"!==c.$scope.panel&&"workbench"!==c.$scope.panel||!c.$scope.hasProjectManagerorDomainAdminRights?c.trigger("launchTask",["default"]):c.trigger("launchTask",["admin"]),e.closeMenus()},e.toggleLoginState=function(){"Login"===e.loginState?c.trigger("selectPageClass",["login",{nextURL:c.getRedirectUrl()}]):t.logout().fail(function(e){c._alert.errorObj(e,F.AlertServiceBase.DELAY_SHORT)}).done(),e.closeMenus()},e.toggleMaximizePage=function(){e.$root.$broadcast("collapseTaskPanel",!e.taskpanelCollapsed),e.closeMenus()},e.$on("collapseTaskPanel",function(t,i){e.taskpanelCollapsed=i}),e.$on("launchTask",function(t,i,n){e.panel=i,e.category=n}),this.$scope.createAccount=function(){c.trigger("selectPageClass",["createaccount"]),e.closeMenus()},this.$scope.openJobQueue=function(){c.trigger("launchTask",["default","jobqueue"]),e.closeMenus()},this.$scope.selectProjectSelector=function(){c.trigger("launchTask",["default"])},e.menuState={language:!1,help:!1,login:!1,share:!1},e.closeMenus=function(){e.menuState.language=!1,e.menuState.help=!1,e.menuState.login=!1,e.menuState.share=!1,void 0!==e.killListener&&(e.killListener(),e.killListener=void 0)},e.toggleMenu=function(t){var i=e.menuState[t];e.closeMenus(),e.menuState[t]=!i,e.menuState.share===!0&&(e.killListener=e.$root.$on("$locationChangeSuccess",function(){e.updateShareUrl()}))},e.openInNewTab=function(e){var t=window.open(e,"_blank");t.focus()},e.iframe={code:"",width:800,height:600},e.share=function(){e.updateShareUrl(),e.toggleMenu("share")},e.updateShareUrl=function(){e.currenturl=F.DI().get("$location").absUrl(),e.emailurl=e.encodeEmailUrl(e.currenturl),e.iframe.code='<iframe src="'+e.currenturl+'" width="'+e.iframe.width+'" height="'+e.iframe.height+'" frameborder="0"></iframe>'},e.hasProjectManagerorDomainAdminRights=!1,e.numJobs={running:0,pending:0},r&&e.$watch('numJobs.pending + "|" + numJobs.running',function(){r.updateJobStatus()}),e.encodeEmailUrl=function(e){return e.replace(/&/g,"%26")},a.setInterval(function(){e.numJobs.running+e.numJobs.pending>0&&c.updateQueueState()},WS.Headerbar.QUEUE_POLL_INTERVAL),this.provideMalePlug("TaskLaunch",["launchTask"]),this.provideMalePlug("PageSelect",["selectPage","selectPageClass"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideFemalePlug("ProjectChange",["changeProject"]),this.connect(this,t),this.connect(this.getFemalePlug("ProjectChange"),s),r&&this.connect(this,r),t.isLoggedIn()},WS.Headerbar.prototype={getRedirectUrl:function(){var e=F.DI().get("$location").search(),t=e.v,i="lp"===t||"lg"===t||"ca"===t?"?v=ps&t=p:default,c:projectselector,m:t&ps=ps1&ps1=":F.DI().get("$location").url();return i},login:function(){var e=this;this.$scope.$apply('loginState = "Logout"'),this._login.getUsername().then(function(t){e.$scope.$apply('username = "'+t+'"')}).done(),this._login.isProjectManagerorDomainAdmin().then(function(t){e.$scope.$apply(function(e){e.hasProjectManagerorDomainAdminRights=t})}).done(),this.updateQueueState()},logout:function(){this.$scope.$apply(function(e){e.loginState="Login",e.hasProjectManagerorDomainAdminRights=!1,e.username=void 0,e.panel="default",e.numJobs.running=e.numJobs.pending=0,e.projectName=void 0,e.$root.htmltitle=void 0})},addObjects:function(){this.updateQueueState()},updateObjects:function(){this.updateQueueState()},removeObjects:function(){this.updateQueueState()},updateQueueState:function(){if(this._jobQueue){var e=this,t=this.$scope;e._jobQueue.getAggregated([WS.Job.State.RUNNING,WS.Job.State.PENDING],!0).then(function(i){var n=i._amount;0===n?t.$apply(function(){t.numJobs.running=t.numJobs.pending=0}):e._jobQueue.getAggregated([WS.Job.State.RUNNING],!0).then(function(e){t.$apply(function(){t.numJobs.running=e._amount,t.numJobs.pending=Math.max(0,n-e._amount)})})})}},updateAccount:function(){var e=this;this._login.isProjectManagerorDomainAdmin().then(function(t){e.$scope.$apply(function(e){e.hasProjectManagerorDomainAdminRights=t})}).done()},changeProject:function(e){var t=this;e&&this._project.getCurrentProject().then(function(e){t.$scope.$root.htmltitle=e._displayName,t.$scope.projectName=e._displayName},function(){t.$scope.$root.htmltitle=void 0,t.$scope.projectName=void 0}).done()}},WS.extend("Headerbar","PlugController"),WS.Headerbar.QUEUE_POLL_INTERVAL=3e4,angular.module("ws.headerbar",[]),F.DI().registerController("headerbar",WS.Headerbar,"@login","@locale","@plug","@alert","?@jobqueue","$window","@project"),angular.module("ws.headerbar").directive("headerbar",function(){var e=WS.PlugController.createDirective({controllerClass:F.DI().getController("headerbar"),scope:{linkToMainPage:"@",showDatafilter:"@",showLoginMenu:"@",showTaskpanelBtn:"@"},templateUrl:WS.partialUrl("headerbar.html")});return e.replace=!0,e}),angular.module("ws.component",[]),angular.module("ws.component").directive("markdownhint",function(){return{restrict:"E",template:'<p style="margin-bottom:0px;">{{"FE_MARKDOWN_HINT" | i18n}}</p><a href="http://daringfireball.net/projects/markdown/syntax" target=_blank"><img class="f_icon16 f_textInline" static-src="icons/extlink.png"/><p class="f_textInline">{{"FE_LEARN_MORE"|i18n}}</p></a>'}}),angular.module("ws.component").directive("betahint",function(){return F.DI().inject("%linkRepository%","%previewGuide%","%devSupportMail%",function(e,t,i){return{restrict:"E",transclude:!0,link:function(n){n.extLink=e+t;var o="WebShare Cloud v2.3 - Preview Feedback",r="I tried this:%0D%0A%0D%0AThis worked well:%0D%0A%0D%0AThis did not work:%0D%0A%0D%0ASuggestions/comments:%0D%0A%0D%0A-------%0D%0A%0D%0AI used this browser: "+navigator.userAgent+"%0D%0A%0D%0A";n.mailLink="mailto:"+i+"?subject="+o+"&body="+r},templateUrl:F.partialUrl("betahint.html")}})}),angular.module("ws.component").directive("resolutionpicker",function(){return{require:"?^actionbar",scope:{settings:"=",refresh:"&"},replace:!0,restrict:"E",transclude:!0,link:function(e){e.setIndex=function(t){e.settings.index=t}},template:'<div class="btn-group" role="group"><div ng-if="settings.showResolutions" class="btn-group" role="group"><button type="button" class="btn btn-default dropdown-toggle f_btnDropdown" data-toggle="dropdown" aria-expanded="false" style="min-width: 130px;">{{settings.widths[settings.index]}} x {{settings.heights[settings.index]}}&nbsp;&nbsp;<span class="caret"></span></button><ul class="dropdown-menu" role="menu"><li ng-repeat="res in settings.widths track by $index"><a class="f_cursorPointer" ng-click="setIndex($index)">{{settings.widths[$index]}} x {{settings.heights[$index]}}</a></li></ul></div><a ng-if="settings.showOpen" role="button" class="btn btn-default f_btnDropdown" href="{{settings.paths[0]}}" target="_blank" style="padding-top: 0px; padding-bottom: 0px; padding-left: 2px; padding-right: 8px;"><img class="f_icon32" static-src="icons/im/taskbar/projectselector/download.png"/>{{\'FE_OPEN_IN_TAB\'|i18n}}</a><button ng-if="settings.showRefresh" type="button" class="btn btn-default f_btnDropdown" ng-click="refresh()" title="{{\'FE_REFRESH\'|i18n}}"><img style="display: inline;" class="f_icon24" static-src="icons/im/refresh.png"/></button></div>'}}),angular.module("ws.component").directive("wscolorpicker",function(){return{scope:{color:"="},restrict:"E",link:function(e){e.colors=["#ffffff","#808080","#000000","#ff0000","#ff8000","#ffff00","#00e500","#00e5e5","#007fff","#0000ff","#8000ff","#ff00d4","#990000","#7f5f00","#007f00","#009999"],e.color=F.ColorGenerator.isHexColor(e.color,!0)?e.color.toLowerCase():e.colors[6],e.picked=e.color;var t=document.createElement("input");t.setAttribute("type","color"),e.showAdvanced="text"!==t.type,e.pick=function(t){e.picked!==t&&(e.picked=t)},e.changeHex=function(){e.color=e.color.toLowerCase(),F.ColorGenerator.isHexColor(e.color,!0)&&e.pick(e.color)},e.isColorValid=function(){return F.ColorGenerator.isHexColor(e.color,!0)},e.$watch("picked",function(t){e.color!==t&&(e.color=t)})},templateUrl:WS.partialUrl("wscolorpicker.html")}}),angular.module("ws.component").directive("copybtnsmall",function(){return{restrict:"E",scope:{copy:"@"},link:function(e){e.copyToClipboard=function(e){WS.copyToClipboard(e.replace(/[ \t]/g,""))}},template:'<button class="btn btn-default ws_copyBtnS" ng-click="copyToClipboard(copy)" title="{{\'FE_COPY_CB\'|i18n}}"><img static-src="icons/copy-tiny.png" class="ws_copyBtnImgS" /></button>'}}),angular.module("ws.component").directive("copybtnlarge",function(){return{restrict:"E",scope:{copy:"@",caption:"@"},link:function(e){e.copyToClipboard=function(e){WS.copyToClipboard(e.replace(/[ \t]/g,""))}},template:'<button class="btn btn-default" ng-click="copyToClipboard(copy)" title="{{\'FE_COPY_CB\'|i18n}}">{{caption}}&nbsp;&nbsp;<img static-src="icons/copy-tiny.png" class="ws_copyBtnImgL" /></button>'}}),WS.copyToClipboard=function(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();try{document.execCommand("copy")}catch(i){}document.body.removeChild(t)},angular.module("ws.component.radialmenu",[]),angular.module("ws.component.radialmenu").directive("radialmenubackground",function(){return{restrict:"E",scope:{object:"=",resolution:"@",colormode:"@"},link:function(e){e.visibleFlg=!1,e.defaultResolution=512,e.defaultColorMode="color",e.$watch("object",function(){e.visibleFlg=!1,setTimeout(function(){e.$apply(function(){e.visibleFlg=!0})},300)}),e.getBackgroundImageUrl=function(){if(e.object&&e.object.instanceOf(WS.Scan)){var t=void 0===e.resolution?e.defaultResolution:e.resolution,i=void 0===e.colormode?e.defaultColorMode:e.colormode;return"color"!==i&&"gray"!==i&&(i=e.defaultColorMode),e.object.getBestFittingImage(parseInt(t),i)}return""}},template:'<div ng-if="object._class === \'Scan\'"><div ng-if="visibleFlg" class="f_rmImage" back-img="{{getBackgroundImageUrl()}}"></div><div ng-if="!visibleFlg" class="f_rmImageInvisible" style="opacity:0;"></div></div>'}}),WS.VisibilityActionbar=function(e,t,i){WS.PlugController.call(this,e,t),this.$scope=e;var n=this;this._layerService=i,this._viewType=WS.Layer.ViewTypes[e.viewtype],e.layerVisibility=this.updateLayerVisibilityInternal(),e.toggleVisibility=function(e){var t=WS.Layer.LayerIDs[e];void 0!==t&&""!==t&&n._layerService.setLayerVisibility(t,n._viewType,!n._layerService.isLayerVisible(t,n._viewType))},this.provideFemalePlug("ObjectUpdate",["updateObjects"]),this._connectorService.connect(this,this._layerService)},WS.VisibilityActionbar.prototype={updateObjects:function(e){var t=this;e.forEach(function(e){if(e._viewType===t._viewType)switch(e._id){case WS.Layer.LayerIDs.SCANS:t.$scope.$apply(function(){t.$scope.layerVisibility.SCANS=e._visible});break;case WS.Layer.LayerIDs.ANNOTATIONS:t.$scope.$apply(function(){t.$scope.layerVisibility.ANNOTATIONS=e._visible});break;case WS.Layer.LayerIDs.MEASUREMENTS:t.$scope.$apply(function(){t.$scope.layerVisibility.MEASUREMENTS=e._visible});break;case WS.Layer.LayerIDs.ORTHOPHOTOS:t.$scope.$apply(function(){t.$scope.layerVisibility.ORTHOPHOTOS=e._visible})}})},updateLayerVisibilityInternal:function(){return{SCANS:this._layerService.isLayerVisible(WS.Layer.LayerIDs.SCANS,this._viewType),ANNOTATIONS:this._layerService.isLayerVisible(WS.Layer.LayerIDs.ANNOTATIONS,this._viewType),MEASUREMENTS:this._layerService.isLayerVisible(WS.Layer.LayerIDs.MEASUREMENTS,this._viewType),ORTHOPHOTOS:this._layerService.isLayerVisible(WS.Layer.LayerIDs.ORTHOPHOTOS,this._viewType)}}},WS.extend("VisibilityActionbar","PlugController"),F.DI().registerController("visibilityactionbar",WS.VisibilityActionbar,"@plug","@layer"),angular.module("ws.component").directive("visibilityactionbar",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("visibilityactionbar"),require:"?^actionbar",scope:{viewtype:"@"},restrict:"E",transclude:!1,link:function(){},template:'<actionbarextension class="ws_abSubMenu" style="top: 0px;"><div class="btn-toolbar" role="toolbar"><div class="btn-group"><button class="btn btn-default ws_abSubBtn" ng-class="{\'btn-info\':layerVisibility.SCANS}" ng-click="toggleVisibility(\'SCANS\')" title="{{ \'FE_SCANPOSITION\' | i18n }}"><img class="ws_abSubIcon" static-src="icons/scanpos.png" /></button><button class="btn btn-default ws_abSubBtn" ng-class="{\'btn-info\':layerVisibility.MEASUREMENTS}" ng-click="toggleVisibility(\'MEASUREMENTS\')" title="{{ \'FE_MEASUREMENTS\' | i18n }}"><img class="ws_abSubIcon" static-src="icons/measure.png" /></button><button class="btn btn-default ws_abSubBtn" ng-class="{\'btn-info\':layerVisibility.ANNOTATIONS}" ng-click="toggleVisibility(\'ANNOTATIONS\')" title="{{ \'FE_ANNOTATIONS\' | i18n }}"><img class="ws_abSubIcon" static-src="icons/annotation.png" /></button><button class="btn btn-default ws_abSubBtn" ng-class="{\'btn-info\':layerVisibility.ORTHOPHOTOS}" ng-click="toggleVisibility(\'ORTHOPHOTOS\')" title="{{ \'FE_ORTHOPHOTOS\' | i18n }}"><img class="ws_abSubIcon" static-src="icons/orthophoto.png" /></button></div></div></actionbarextension>'})}),WS.ImageGallery=function(e,t,i,n,o){WS.Embeddable.call(this,e,t,i);var r=this;r.scope=e,e.objlist=void 0,e.currentobj=void 0,e.colormode=void 0,e.imgindex=void 0,e.canShowIn3d={},this._plug=t,this._pointCloud=n,this._panoSettings=o,e.resetGallery=function(){r.resetGallery()},e.toggleColorMode=function(){"color"===r.scope.colormode?r.scope.colormode="gray":"gray"===r.scope.colormode&&(r.scope.colormode="color")},e.setImg=function(e){return void 0===e?void(r.scope.currentObj=void 0):(r.scope.imgindex=e>=r.scope.objlist.length?0:0>e?r.scope.objlist.length-1:e,void(r.scope.currentobj=r.scope.objlist[r.scope.imgindex]))},e.nextImage=function(){r.scope.setImg(r.scope.imgindex+1)},e.prevImage=function(){r.scope.setImg(r.scope.imgindex-1)},e.showObjects=function(e,t){r.trigger("showObjects",[e,t]),r.resetGallery()},e.focusObject=function(e,t){r.trigger("focusOn",[{object:e},t]),r.resetGallery()},this.provideFemalePlug("ObjectShow",["showObjects"]),this.provideMalePlug("ObjectShow",["showObjects"]),this.provideMalePlug("ViewFocus",["focusOn"]),this._plug.connectWithAll(this.getMalePlug("ObjectShow")),this._plug.connectWithAll(this.getMalePlug("ViewFocus")),this.connect(this,o)},WS.ImageGallery.prototype={showObjects:function(e,t,i){"gallery"===t&&(this.scope.objlist=e,this.scope.currentobj=i.object,this.scope.colormode=i.colormode,this.scope.imgindex=e.indexOf(i.object),this.update3d(e),this.scope.$apply())},resetGallery:function(){this.scope.objlist=void 0,this.scope.currentobj=void 0,this.scope.colormode=void 0,this.scope.imgindex=void 0,this.scope.canShowIn3d={}},update3d:function(e){var t=this;if(this._panoSettings.isWebGlEnabled()){var i=e.map(function(e){return t._pointCloud.canShowObjectIn3d(e).then(function(i){t.$scope.canShowIn3d[e._UUID]=i})});Q.allSettled(i).then(function(){t.$scope.$apply()})}else e.forEach(function(e){t.$scope.canShowIn3d[e._UUID]=!1}),this.$scope.$apply()}},WS.extend("ImageGallery","Embeddable"),angular.module("ws.component.imagegallery",[]),F.DI().registerController("imagegallery",WS.ImageGallery,"@plug","@url","@pointcloud","@panosettings"),angular.module("ws.component").directive("imagegallery",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("imagegallery"),scope:{},link:function(){},templateUrl:WS.partialUrl("imagegallery.html")})}),WS.MapBase=function(e){F.Transformation.call(this,e),this._backgroundColor=void 0,this._clearView=void 0,this._geoReferenced=void 0,this._globalBottomRightX=void 0,this._globalBottomRightY=void 0,this._globalTopLeftX=void 0,this._globalTopLeftY=void 0,this._heightInMeters=void 0,this._maxLevel=void 0,this._minLevel=void 0,this._pixelsPerMeterMax=void 0,this._tileBottomRightX=void 0,this._tileBottomRightY=void 0,this._tileSizeInMeters=void 0,this._tileTopLeftX=void 0,this._tileTopLeftY=void 0,this._widthInMeters=void 0,this._numMapLevels=void 0,this._pixelsPerMeterMin=void 0},WS.MapBase.prototype={readJson:function(e){F.Transformation.prototype.readJson.call(this,e),this._backgroundColor=e.BackgroundColor,this._clearView=e.ClearView,this._geoReferenced=e.GeoReferenced,this._globalBottomRightX=e.GlobalBottomRightX,this._globalBottomRightY=e.GlobalBottomRightY,this._globalTopLeftX=e.GlobalTopLeftX,this._globalTopLeftY=e.GlobalTopLeftY,this._heightInMeters=e.HeightInMeters,this._maxLevel=e.MaxLevel,this._minLevel=e.MinLevel,this._pixelsPerMeterMax=e.PixelsPerMeter,this._tileBottomRightX=e.TileBottomRightX,this._tileBottomRightY=e.TileBottomRightY,this._tileSizeInMeters=e.TileSizeInMeters,this._tileTopLeftX=e.TileTopLeftX,this._tileTopLeftY=e.TileTopLeftY,this._widthInMeters=e.WidthInMeters,this._numMapLevels=this._maxLevel-this._minLevel+1,this._pixelsPerMeterMin=this._pixelsPerMeterMax/Math.pow(2,this._numMapLevels-1)},writeJson:function(){var e=F.Transformation.prototype.writeJson.call(this);return e.BackgroundColor=this._backgroundColor,e.ClearView=this._clearView,e.GeoReferenced=this._geoReferenced,e.GlobalBottomRightX=this._globalBottomRightX,e.GlobalBottomRightY=this._globalBottomRightY,e.GlobalTopLeftX=this._globalTopLeftX,e.GlobalTopLeftY=this._globalTopLeftY,e.HeightInMeters=this._heightInMeters,e.MaxLevel=this._maxLevel,e.MinLevel=this._minLevel,e.PixelsPerMeter=this._pixelsPerMeter,e.TileBottomRightX=this._tileBottomRightX,e.TileBottomRightY=this._tileBottomRightY,e.TileSizeInMeters=this._tileSizeInMeters,e.TileTopLeftX=this._tileTopLeftX,e.TileTopLeftY=this._tileTopLeftY,e.WidthInMeters=this._widthInMeters,e}},WS.extend("MapBase","Transformation"),WS.MapLayer=function(e){WS.MapBase.call(this,e),this._class="MapLayer",this._objectUUID=void 0,this._opacity=void 0,this._shortID=void 0,this._type=void 0,this._maxScanElevation=void 0,this._minScanElevation=void 0,this._scanNames=void 0,this._scanUUIDs=void 0,this._zBottom=void 0,this._zTop=void 0},WS.MapLayer.prototype={readJson:function(e){WS.MapBase.prototype.readJson.call(this,e),this._objectUUID=e.ObjectUUID,this._opacity=e.Opacity,this._shortID=e.ShortID,this._type=e.Type,this._maxScanElevation=e.MaxScanElevation,this._minScanElevation=e.MinScanElevation,this._scanNames=e.ScanNames,this._scanUUIDs=e.ScanUUIDs,this._zBottom=e.ZBottom,this._zTop=e.ZTop},writeJson:function(){var e=WS.MapBase.prototype.writeJson.call(this);return e.Class="MapLayer",e.ObjectUUID=this._objectUUID,e.Opacity=this._opacity,e.ShortID=this._shortID,e.Type=this._type,e.MaxScanElevation=this._maxScanElevation,e.MinScanElevation=this._minScanElevation,e.ScanNames=this._scanNames,e.ScanUUIDs=this._scanUUIDs,e.ZBottom=this._zBottom,e.ZTop=this._zTop,e}},WS.extend("MapLayer","MapBase"),WS.MapLayer.Type={SCAN:"Scan",LAYOUT_PLAN:"LayoutPlan",CLIPPING_BOX:"ClippingBox",WORKSPACE:"Workspace"},WS.MapObject=function(e){WS.MapBase.call(this,e),this._class="Map",this._clippingBoxes=void 0,this._hasLayoutLayers=void 0,this._hasMapLayers=void 0,this._hasScanLayers=void 0,this._layerOrder=void 0,this._layoutLayersMaxLevel=void 0,this._layoutLayersMinLevel=void 0,this._maxScanElevation=void 0,this._minScanElevation=void 0,this._scanLayersMaxLevel=void 0,this._scanLayersMinLevel=void 0,this._zBottom=void 0,this._zTop=void 0},WS.MapObject.prototype={readJson:function(e){WS.MapBase.prototype.readJson.call(this,e),this._clippingBoxes=e.ClippingBoxes,this._hasLayoutLayers=e.HasLayoutLayers,this._hasMapLayers=e.HasMapLayers,this._hasScanLayers=e.HasScanLayers,this._layerOrder=e.LayerOrder,this._layoutLayersMaxLevel=e.LayoutLayersMaxLevel,this._layoutLayersMinLevel=e.LayoutLayersMinLevel,this._maxScanElevation=e.MaxScanElevation,this._minScanElevation=e.MinScanElevation,this._scanLayersMaxLevel=e.ScanLayersMaxLevel,this._scanLayersMinLevel=e.ScanLayersMinLevel,this._zBottom=e.ZBottom,this._zTop=e.ZTop},writeJson:function(){var e=WS.Transformation.prototype.writeJson.call(this);return e.Class="Map",e.ClippingBoxes=this._clippingBoxes,e.HasLayoutLayers=this._hasLayoutLayers,e.HasMapLayers=this._hasMapLayers,e.HasScanLayers=this._hasScanLayers,e.LayerOrder=this._layerOrder,e.LayoutLayersMaxLevel=this._layoutLayersMaxLevel,e.LayoutLayersMinLevel=this._layoutLayersMinLevel,e.MaxScanElevation=this._maxScanElevation,e.MinScanElevation=this._minScanElevation,e.ScanLayersMaxLevel=this._scanLayersMaxLevel,e.ScanLayersMinLevel=this._scanLayersMinLevel,e.ZBottom=this._zBottom,e.ZTop=this._zTop,e},getOrderOfLayer:function(e,t){for(var i=t?this._changes._layerOrder:this._layerOrder,n=0,o=i.length;o>n;++n)if(i[n]===e)return n;return 0},getLeafletCRS:function(){return WS.MapObject.getLeafletCRS(this)}},WS.extend("MapObject","MapBase"),WS.MapObject.getLeafletCRS=function(e){var t=L.extend({},L.CRS,{projection:L.Projection.LonLat,transformation:new L.Transformation(1,-e._globalTopLeftX,-1,e._globalTopLeftY),scale:function(t){return Math.pow(2,t-e._maxLevel)*e._pixelsPerMeterMax},getSize:function(t){var i=e._maxLevel-t,n=Math.ceil(e._tileBottomRightX/Math.pow(2,i)),o=Math.ceil(e._tileBottomRightY/Math.pow(2,i));return L.point(256*(n+1),256*(o+1))}});return t},WS.Blender=function(){this._objs=void 0,this._durations=void 0,this._endTimes=void 0,this._targetAlphas=void 0,this._diffAlphas=void 0},WS.Blender.prototype={reset:function(){this._objs=void 0,this._durations=void 0,this._endTimes=void 0,this._targetAlphas=void 0,this._diffAlphas=void 0},getNowMillis:function(){return Date.now()},startBlending:function(e,t,i){this._objs=[],this._durations=[],this._endTimes=[],this._targetAlphas=[],this._diffAlphas=[];for(var n=this.getNowMillis(),o=0,r=e.length;r>o;++o){var a=e[o],s=t[o],c=i[o],l=n+s,h=c-a.getAlpha();this._objs.push(a),this._durations.push(s),this._endTimes.push(l),this._targetAlphas.push(c),this._diffAlphas.push(h)}},blend:function(){for(var e=!0,t=this.getNowMillis(),i=0,n=this._objs.length;n>i;++i){var o=this._objs[i],r=this._durations[i],a=this._endTimes[i],s=this._targetAlphas[i],c=this._diffAlphas[i],l=Math.max(0,a-t),h=l/r,d=s-h*c;o.setAlpha(d),e=e&&0===l}return e}},WS.extend("Blender"),WS.Point3dService=function(e,t){WS.PlugModule.call(this,e),this._distance=t,this._point3d=void 0,this.provideMalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"])},WS.Point3dService.prototype={getPoint:function(){return this._point3d},setPoint:function(e){var t=this._point3d;this._point3d=e,e!==t?(t&&this.trigger("removeObjects",[[t]]),e&&this.trigger("addObjects",[[e]])):e&&this.trigger("updateObjects",[[e]]),e&&e._pointState===WS.Point3d.PointState.Unknown&&this.determineDistance()},determineDistance:function(){var e=this,t=this._point3d;this.determine3DCoords(this._point3d).then(function(){e._point3d===t&&e.trigger("updateObjects",[[t]])})},determine3DCoords:function(e){if(e._pointState===WS.Point3d.PointState.Unknown){var t=e._refSystem,i=e._takenInView instanceof WS.PanoramaView?e._takenInView.getImageWidth():-1;return this._distance.get(t._project,t._UUID,e._localAngles[0],e._localAngles[1],i).then(function(t){return e._pointState=t.PointState,e._positionLocal=t.PositionLocal,e._positionGlobal=t.PositionGlobal,e})}return Q.resolve(e)}},WS.extend("Point3dService","PlugModule"),WS.Graphics2d=function(){},WS.Graphics2d.prototype={draw:function(){}},WS.extend("Graphics2d"),WS.ImageGraphics2d=function(e){this._image=e,this._image.loadImage(),WS.Graphics2d.call(this)},WS.ImageGraphics2d.prototype={draw:function(e,t,i,n,o){this._image.isLoaded()&&e.drawImage(this._image.getRawImage(),t,i,o,n)}},WS.extend("ImageGraphics2d","Graphics2d"),WS.ViewBase=function(e,t,i){WS.Embeddable.call(this,e,t,i),this._objects={},this._mode=void 0,this._modeToHandlerStack=void 0,this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"])},WS.ViewBase.prototype={objectFilter:function(){return!1},addObject:function(e){if(!this.objectFilter(e))return 0;var t=e._class.toLowerCase();if(!this._objects[t])return 0;var i=F.addUnique(this._objects[t].entities,e);return i?2:1},addObjects:function(e){var t=this;e.forEach(function(e){t.addObject(e)})},updateObjects:function(){},removeObject:function(e){var t=e._class.toLowerCase();this._objects[t]&&F.removeFirst(this._objects[t].entities,e)},removeObjects:function(e){var t=this;e.forEach(function(e){t.removeObject(e)})},activateHandlerStack:function(){},setMode:function(e){this._mode=e;var t=this._modeToHandlerStack?this._modeToHandlerStack[e]:void 0;t&&this.activateHandlerStack(t)},getMode:function(){return this._mode}},WS.extend("ViewBase","Embeddable"),WS.ViewBase.Mode={Move:1,PickPoint:2,SelectObject:3,PickPolygon:4,SelectObjects:5,PickAll:6,SelectObjectsRectAdd:7,SelectObjectsRectSub:8,PickPointOpenScans:9},WS.CameraObject=function(e){this._globalTransform=e},WS.CameraObject.prototype={getGlobalPosition:function(){return mat4.getTranslation(this._globalTransform)},getRightGlobal:function(){var e=new MatrixArray(4);return mat4.getColumn(this._globalTransform,0,e),vec3.create(e)},getUpGlobal:function(){var e=new MatrixArray(4);return mat4.getColumn(this._globalTransform,1,e),vec3.create(e)},getAxisGlobal:function(){var e=new MatrixArray(4);
return mat4.getColumn(this._globalTransform,2,e),vec3.create(e)},calcDistToPoint:function(e){var t=this.getGlobalPosition();return vec3.dist(t,e)}},WS.CategoryGraphics2d=function(e){this._color=e,this._color[3]=WS.CategoryGraphics2d._alpha,WS.Graphics2d.call(this)},WS.CategoryGraphics2d.prototype={draw:function(e,t,i,n,o){var r=n/2,a=o/2;e.fillStyle=WS.Renderer2D.colorToStyle(this._color),e.lineWidth=1,e.beginPath(),e.moveTo(t+r,i+WS.CategoryGraphics2d._margin),e.lineTo(t+n-WS.CategoryGraphics2d._margin,i+a),e.lineTo(t+r,i+o-WS.CategoryGraphics2d._margin),e.lineTo(t+WS.CategoryGraphics2d._margin,i+a),e.lineTo(t+r,i+WS.CategoryGraphics2d._margin),e.closePath(),e.fill(),e.stroke()}},WS.extend("CategoryGraphics2d","Graphics2d"),WS.CategoryGraphics2d._margin=5,WS.CategoryGraphics2d._alpha=1,WS.PerspectiveCameraObject=function(e,t,i){WS.CameraObject.call(this,e),this._aspectRatio=t,this._fovY=i},WS.extend("PerspectiveCameraObject","CameraObject"),WS.View3d=function(e,t,i){WS.ViewBase.call(this,e,t,i),this._page=void 0,this._canvasList=void 0,this._camera=void 0,this._scene=void 0,this._renderMode=void 0,this._activeHandlerStack=void 0,this._mouseAdapter=void 0,this._keyboardAdapter=void 0,this._renderableMap={},this._selectionRenderable=new WS.SelectionRenderable,this._type=void 0,this._width=void 0,this._height=void 0,this._renderer=[],this._cameraIdleCount=0,this._isMoving=0,this._trafoView=void 0,this._init=!1,this._render=!1,this._isRendering=!1,this._animationProxy=F.proxy(this.animloop,this),this._hlObject=void 0,this._viewModeCtrl=void 0,this._viewModeCtrlD=Q.defer(),this._dbgFpsTimes=[0,0,0,0],this._dbgFps=0,this.provideMalePlug("CameraChanged",["onCameraChange"])},WS.View3d.prototype={startRendering:function(){this._render=!0,this._isRendering||this.animloop()},stopRendering:function(){this._render=!1},isRendering:function(){return this._render},forceRerender:function(){this._camera&&(this._camera._dirty=!0,this._camera._changesToTrigger=!0,this._cameraIdleCount=0)},setCanvas:function(e){this._canvasList=e},destroyRenderers:function(){this.stopRendering(),this._renderer.forEach(function(e){e.clearStorage()}),this._renderer.length=0},initRenderers:function(){},getGLExtension:function(){},initScene:function(){},initHandlers:function(){},initCamera:function(){},init:function(){this.initRenderers(),this.initScene(),this.initCamera(),this.initHandlers(),this.onUpdateViewDimensions(),this._init=!0},render:function(){},pick3d:function(e,t,i,n,o,r){r=void 0===r?5:r;var a=this._renderer[0],s=new WS.ObjectLabeler,c=this.getAllRenderables();c.forEach(function(e){e._pickable3d&&e.assignPickColors(s)});var l=a._frameBufferStorage.get("pick_post_gf_color");o?a.drawSceneIncremental(this._camera,this._scene,void 0,void 0,{colorMode:WS.RendererBase.RenderMode.PICK_3D,bufferPrefix:"pick_"}):a.drawScene(this._camera,this._scene,!1,void 0,{destFB:l,colorMode:WS.RendererBase.RenderMode.PICK_3D});var h,d;d=!i!=!n,d&&(h=function(e){var t=s.lookupRenderable(e);if(t){var n=t.memberRenderable||t.renderable,o=n instanceof WS.DynamicPointRenderable;return i?!o:o}return!0});var u,p=l.readClosestOpaquePixel(e,t,r,h),_=s.lookupRenderable(p);if(_){var g=_.memberRenderable||_.renderable;if(n&&g instanceof WS.DynamicPointRenderable){var f=a._pickColorBuffer,m=new WS.ObjectLabeler,v=g._geometry._positionBuffer;f.getCountItems()!==v.getCountItems()&&m.fillPickColorBuffer(f,v.getCountItems());var S=function(e){return e===g};o?a.drawSceneIncremental(this._camera,this._scene,void 0,S,{colorMode:WS.RendererBase.RenderMode.PICK_3D_POINT,bufferPrefix:"pick_",reuseDepth:!0}):a.drawScene(this._camera,this._scene,!1,S,{destFB:l,colorMode:WS.RendererBase.RenderMode.PICK_3D_POINT});var b=l.readClosestOpaquePixel(e,t,r),y=m.lookupIndex(b);if(void 0!==y){var P=vec3.create();v.getItem(y,P),mat4.multiplyVec3(_.renderable._transform,P),u=mat4.multiplyVec3(this._trafoView,P)}}else!i||g instanceof WS.DynamicPointRenderable||(u=new WS.PickInfo(g))}return u},animloop:function(){if(this._init){if(!this._render)return void(this._isRendering=!1);this._isRendering=!0,this.onUpdateViewDimensions(),this._moveHandler instanceof WS.PointCloudMoveHandler&&this._moveHandler.update();var e=this._cameraAnimator&&this._cameraAnimator.isAnimating();this._camera._dirty=this._camera._dirty||e,this._camera._dirty?this._cameraIdleCount=0:this._cameraIdleCount++,this.render(),this._camera._dirty=!1,this._perfNumFrames++;for(var t=this._dbgFpsTimes,i=t.length,n=i-2;n>=0;n--)t[n+1]=t[n];t[0]=Date.now(),this._dbgFps=1e3*(i-1)/(t[0]-t[i-1])}requestAnimationFrame(this._animationProxy)},perf:function(e){var t=console;this._perfNumFrames=0,this._perfT0=Date.now(),this._perfProfile=e,e&&t.profile()},perfEnd:function(){var e=console;this._perfProfile&&e.profileEnd();var t=Date.now()-this._perfT0,i=this._perfNumFrames/(t/1e3);e.log("#frames: ",this._perfNumFrames,"fps: ",i,"    @",this._width,"x",this._height)},activateHandlerStack:function(e){if(this.deactivateHandlerStack(),this._activeHandlerStack=e,this._mouseAdapter)this._mouseAdapter.setHandlerStack(this._activeHandlerStack);else{var t=this._canvasList[this._canvasList.length-1];this._mouseAdapter=new WS.MouseAdapterExt(t,this._activeHandlerStack,WS.MouseAdapter.Capture.DragOnly)}this._keyboardAdapter?this._keyboardAdapter.setHandlerStack(this._activeHandlerStack):this._keyboardAdapter=new F.KeyboardAdapter(window,this._activeHandlerStack),this._activeHandlerStack.forEach(function(e){e.activate()})},deactivateHandlerStack:function(){this._activeHandlerStack&&this._activeHandlerStack.forEach(function(e){e.deactivate()}),this._mouseAdapter&&this._mouseAdapter.setHandlerStack([]),this._keyboardAdapter&&this._keyboardAdapter.setHandlerStack([])},updateDimensionsForRenderer:function(e,t){for(var i=0,n=this._renderer.length;n>i;i++)this._renderer[i].setCanvasDimensions(e,t),this._renderer[i].setViewPortDimensions(e,t),this._renderer[i].clear()},onUpdateViewDimensions:function(e,t){var i=this._canvasList;return(void 0===e||void 0===t)&&(e=$(i[0]).width(),t=$(i[0]).height()),e&&t&&(e!==this._width||t!==this._height)?(this.updateDimensionsForRenderer(e,t),this._camera.setDimensions(e,t),this._width=e,this._height=t,!0):!1},addObject:function(e,t){var i=WS.ViewBase.prototype.addObject.call(this,e);if(2===i&&e.createRenderable&&!this.hasRenderableOfType(e._UUID,WS.View3d.RenderableType.DEFAULT)){var n=e.createRenderable(this),o=this;Q.isPromise(n)?n.then(function(i){i&&o.addRenderable(i,WS.View3d.RenderableType.DEFAULT,e,t)}):n&&this.addRenderable(n,WS.View3d.RenderableType.DEFAULT,e,t)}return i},addRenderable:function(e,t,i,n){t=t||WS.View3d.RenderableType.DEFAULT,n&&e.addToLayer(n._id,!0);var o=e.getUuid();void 0===this._renderableMap[o]&&(this._renderableMap[o]={}),this._renderableMap[o][t]=e,this._scene.add(e)},updateAddedRenderable:function(e,t){e._dataObject&&e._dataObject===this._hlObject?this.highlight(e._dataObject):this.updateViewingMode(e);var i=void 0!==e.redraw;e.update&&e.update(i),e.setIconMode&&e.setIconMode(t,i),i&&e.redraw()},updateViewingMode:function(e){var t=e._dataObject;e.setViewingMode(t&&t._selected?WS.Renderable.ViewingMode.Selected:t&&this._hlObject===t?WS.Renderable.ViewingMode.Highlighted:WS.Renderable.ViewingMode.Normal)},hasRenderableOfType:function(e,t){for(var i in this._renderableMap[e])if(this._renderableMap[e].hasOwnProperty(i)&&i===t)return!0;return!1},removeRenderables:function(e){for(var t in this._renderableMap[e])this._renderableMap[e].hasOwnProperty(t)&&this.removeRenderable(this._renderableMap[e][t],e)},removeRenderable:function(e,t){t=t||e._UUID||e._dataObject._UUID,this._scene.remove(e,!0);for(var i in this._renderableMap[t])this._renderableMap[t].hasOwnProperty(i)&&this._renderableMap[t][i]===e&&delete this._renderableMap[t][i];0===this._renderableMap[t].length&&delete this._renderableMap[t],this.deleteStorageForRenderableAndMembers(e)},deleteStorageForRenderableAndMembers:function(e){for(var t=0,i=this._renderer.length;i>t;++t)this._renderer[t].deleteStorageForRenderableAndMembers(e)},getRenderable:function(e,t){return e&&e._UUID&&this._renderableMap[e._UUID]?(t=t||WS.View3d.RenderableType.DEFAULT,this._renderableMap[e._UUID][t]):void 0},getRenderables:function(e){if(!e||!e._UUID)return[];var t=e._UUID,i=[];for(var n in this._renderableMap[t])this._renderableMap[t].hasOwnProperty(n)&&i.push(this._renderableMap[t][n]);return i},getAllRenderables:function(){var e=[];for(var t in this._renderableMap)if(this._renderableMap.hasOwnProperty(t))for(var i in this._renderableMap[t])this._renderableMap[t].hasOwnProperty(i)&&e.push(this._renderableMap[t][i]);return e},removeObject:function(e){WS.ViewBase.prototype.removeObject.call(this,e),this.removeRenderables(e._UUID),this._fsm&&"highlight"===this._fsm._state&&this._fsm._meta.focus&&this._fsm._meta.focus.object&&this._fsm._meta.focus.object._UUID===e._UUID&&(this._fsm.read("move"),this.updateURL()),this.$scope.menu&&this.$scope.menu.object===e&&this.hideRadialMenu()},removeAllObjects:function(){var e=this._objects,t=this,i=[];for(var n in e)e.hasOwnProperty(n)&&e[n].entities.forEach(function(e){i.push(e)});i.forEach(function(e){t.removeObject(e)})},filterObjects:function(){var e=this._objects,t=this,i=[];for(var n in e)e.hasOwnProperty(n)&&e[n].entities.forEach(function(e){t.objectFilter(e)||i.push(e)});i.forEach(function(e){t.removeObject(e)})},updateObject:function(e){if(e&&e._UUID)for(var t=this.getRenderables(e),i=0,n=t.length;n>i;++i){var o=t[i];o._dataObject&&o._dataObject===this._hlObject?this.highlight(o._dataObject):this.updateViewingMode(o),o.update()}},select:function(e){for(var t=0,i=e.length;i>t;++t)for(var n=this.getRenderables(e[t]),o=0,r=n.length;r>o;++o)n[o].setViewingMode(WS.Renderable.ViewingMode.Selected)},unselect:function(e){for(var t=0,i=e.length;i>t;++t)for(var n=this.getRenderables(e[t]),o=0,r=n.length;r>o;++o)n[o].setViewingMode(WS.Renderable.ViewingMode.Normal)},highlight:function(e){e!==this._hlObject&&this.unhighlight(this._hlObject),this._hlObject=e;for(var t=this.getRenderables(e),i=0,n=t.length;n>i;++i)this.updateViewingMode(t[i])},unhighlight:function(e){this._hlObject===e&&(this._hlObject=void 0);for(var t=this.getRenderables(e),i=0,n=t.length;n>i;++i)this.updateViewingMode(t[i])},getCamGlobalPos:function(){return this._camera?this._camera.getGlobalPos(this._trafoView):vec3.create([0,0,0])},getCameraObject:function(){return this._camera?this._camera.createCameraObject(this._trafoView):void 0},triggerCameraChange:function(){var e=this._camera;e&&e._changesToTrigger&&(this.trigger("onCameraChange",[this.getCameraObject(),this]),e._changesToTrigger=!1)},showRadialMenu:function(e,t,i){if(this.$scope.menu.object!==e){var n=e.instanceOf(WS.Scan)?140:120,o=n+10,r=Math.max(t,o);r=Math.min(r,this._width-o);var a=Math.max(i,o);a=Math.min(a,this._height-o-24),this.highlight(e),this.$scope.$apply(function(t){t.menu.object=e,t.menu.visible=!0,t.menu.x=r+"px",t.menu.y=a+"px"})}},hideRadialMenu:function(){this.$scope.menu&&(this.$scope.menu.object&&(this.unhighlight(this.$scope.menu.object),this.$scope.menu.object=void 0),this.$scope.$apply(function(e){e.menu.visible=!1}))},removeLines:function(){this._linesRenderable&&(this._scene&&this._scene.removeChild(this._linesRenderable),this.deleteStorageForRenderableAndMembers(this._linesRenderable)),this._linesRenderable=void 0},removeLineEnd:function(){this._lineAreaEnd&&(this._scene&&this._scene.removeChild(this._lineAreaEnd),this.deleteStorageForRenderableAndMembers(this._lineAreaEnd)),this._lineAreaEnd=void 0},createLine:function(e,t,i,n,o,r){var a=t?new WS.ArrayBuffer(t,4):void 0,s=i?new WS.ArrayBuffer(i,4):void 0,c=n?new WS.ArrayBuffer(n,4):void 0,l=1/this._unit.getExactLength(1);this._linesRenderable=new WS.DottedLinesRenderable(new WS.ArrayBuffer([],3),s,c,a,WS.LineMaterial.Dash.Adaptive,o,r,t,l),this._linesRenderable.addToLayer(WS.Layer.LayerIDs.TEMP,!0),this._linesRenderable.setCornerPointsFrom2dArray(e),this._linesRenderable.setViewingMode(WS.Renderable.ViewingMode.Normal),this._scene.add(this._linesRenderable)},createLineEnd:function(e,t,i){var n=e.length;if(!(3>n)){var o=[e[e.length-1],e[0]],r=this._linesRenderable.getCurrentDashLength(),a=t?new WS.ArrayBuffer(t,4):void 0,s=i?new WS.ArrayBuffer(i,4):void 0;this._lineAreaEnd=new WS.DottedLinesRenderable(new WS.ArrayBuffer([],3),a,s,new WS.ArrayBuffer([.5,.5,.5,1],4),WS.LineMaterial.Dash.Fixed,4,6,[1,1,1,1],r),this._lineAreaEnd.addToLayer(WS.Layer.LayerIDs.TEMP,!0),this._lineAreaEnd.setCornerPointsFrom2dArray(o),this._lineAreaEnd.setViewingMode(WS.Renderable.ViewingMode.Normal),this._scene.add(this._lineAreaEnd)}}},WS.extend("View3d","ViewBase"),WS.View3d.RenderMode={WebGl:1,Canvas:2},WS.View3d.RenderableType={DEFAULT:"d",PANORAMA:"p",SCAN_CLOUD:"s"},F.DI().registerService("point3d",WS.Point3dService,"@plug","@distance"),F.DI().config("@plug",WS.viewConfigPlug=function(e){e.describe("ViewMode",["setMode"]),e.describe("CameraChanged",["onCameraChange"]),e.describe("SceneRootChange",["sceneRootChange"]),e.describe("PointPick3D",["pickPoint"]),e.describe("PointPick3DControl",["setPickedPoints"]),e.describe("ViewFocus",["focusOn"])}),F.DI().registerParameter("viewselectiontoolbar",{tools:[{showDefault:!0,icon:"select_48.png",id:WS.ViewBase.Mode.SelectObjects},{showDefault:!0,icon:"rectangle_light_plus_76.png",id:WS.ViewBase.Mode.SelectObjectsRectAdd},{showDefault:!0,icon:"rectangle_light_minus_76.png",id:WS.ViewBase.Mode.SelectObjectsRectSub}],text:F.isTouch()?"FE_VIEW_NAVIGATE_TOUCH":"FE_VIEW_NAVIGATE_MOUSE"}),WS.PanoSettings=function(e,t,i,n,o,r,a,s,c,l,h,d){WS.CRUDObject.call(this,d),this._movementSpeed=void 0!==e?e:10,this._imageResolutionIndex=void 0!==t?t:2,this._imageResolutionIndex=Math.min(this._imageResolutionIndex,WS.Scan.DeviceMaxResolutionIdx),this._colorMode=void 0!==i?i:"color",this._iconMode=void 0!==n?n:WS.PanoSettings.IconModes.Category,this._blendFactor=void 0!==o?o:.6,this._enableWebGl=void 0!==r?r:!0,this._showCompass=void 0!==a?a:!0,this._showScanLabelsInPano=void 0!==s?s:!0,this._showOrthoVolumes=c||!1,this._details3d=void 0!==l?l:WS.PanoSettings.Detail3d.AUTOMATIC,this._showPolylines=void 0!==h?h:!0},WS.PanoSettings.prototype={clone:function(){return new WS.PanoSettings(this._movementSpeed,this._imageResolutionIndex,this._colorMode,this._iconMode,this._blendFactor,this._enableWebGl,this._showCompass,this._showScanLabelsInPano,this._showOrthoVolumes,this._details3d,this._showPolylines,this._service)},getPanoImageResolution:function(){return WS.PanoSettings.Resolutions[this._imageResolutionIndex]},getColorMode:function(){return WS.PanoSettings.ColorModes[this._colorMode]},writeToLocalStorage:function(){this._service.writeToLocalStorage(this)},details3d:function(){var e=this._details3d;return e===WS.PanoSettings.Detail3d.AUTOMATIC?WS.PanoSettings.autoDetails3d():e}},WS.extend("PanoSettings","CRUDObject"),WS.PanoSettings.ColorModes=WS.Scan.PanoImageColorModes,WS.PanoSettings.Resolutions=WS.Scan.PanoImageResolutions,WS.PanoSettings.MinMovementSpeed=1,WS.PanoSettings.MaxMovementSpeed=20,WS.PanoSettings.IconModes=WS.LabelRenderable.ICON_MODES,WS.PanoSettings.IconModeNames=["FE_NO_ICONS","FE_ICON_CATEGORY","FE_ICON_READWRITE"],WS.PanoSettings.Detail3d={AUTOMATIC:"Automatic",VERY_LOW:"VeryLow",LOW:"Low",MEDIUM:"Medium",HIGH:"High",VERY_HIGH:"VeryHigh"},WS.PanoSettings.autoDetails3d=function(){return F.isMobile()||11===F.ieVersion()?WS.PanoSettings.Detail3d.MEDIUM:WS._2GO?WS.PanoSettings.Detail3d.HIGH:WS.PanoSettings.Detail3d.VERY_HIGH},WS.PanoSettings.details3dStringID=function(e){switch(e){case WS.PanoSettings.Detail3d.VERY_LOW:return"FE_RESOLUTION_VERYLOW";case WS.PanoSettings.Detail3d.LOW:return"FE_RESOLUTION_LOW";case WS.PanoSettings.Detail3d.MEDIUM:return"FE_RESOLUTION_MEDIUM";case WS.PanoSettings.Detail3d.HIGH:return"FE_RESOLUTION_HIGH";case WS.PanoSettings.Detail3d.VERY_HIGH:return"FE_RESOLUTION_VERYHIGH";default:return"FE_AUTOMATIC"}},L.TileLayer.Canvas.WithZoomOffset=L.TileLayer.Canvas.extend({options:{},initialize:function(e){this._map=void 0,L.TileLayer.Canvas.prototype.initialize.call(this,e),L.setOptions(this,e)},onAdd:function(e){this._map=e,this.calcLayerZoom(),L.TileLayer.Canvas.prototype.onAdd.call(this,e)},calcLayerZoom:function(){var e=this.options._wsZoomOffset,t=this._map.getZoom(),i=this.options._wsNativeTileSize,n=this.options.minZoom,o=this.options.maxNativeZoom;"number"!=typeof o&&(o=this.options.maxZoom);var r=t+e;r=Math.max(r,n),r=Math.min(r,o),e=r-t,this.options.tileSize=i*Math.pow(2,-e),this.options.zoomOffset=e,this.options._wsLayerZoom=r},_reset:function(){this.calcLayerZoom(),L.TileLayer.Canvas.prototype._reset.apply(this,Array.prototype.slice.call(arguments,1))},_createTile:function(){var e=L.TileLayer.Canvas.prototype._createTile.call(this);return e.width=e.height=this.options._wsNativeTileSize,e.style.width=e.style.height=this._getTileSize()+"px",e.className+=" f_pixelated",e},_loadTile:function(e,t){this._adjustTilePoint(t),L.TileLayer.Canvas.prototype._loadTile.call(this,e,t)}}),WS.ScanTilesLayer=L.TileLayer.Canvas.WithZoomOffset.extend({initialize:function(e,t,i,n,o,r,a,s,c){a=void 0!==a?a:WS.ScanTilesLayer.ZOOM_OFFSET,s=void 0!==s?s:WS.ScanTilesLayer.MAX_PARALLEL_IMG_LOADS,c=c||function(){return new Image},L.TileLayer.Canvas.WithZoomOffset.prototype.initialize.call(this,{async:!1,minZoom:e._scanLayersMinLevel,maxZoom:e._scanLayersMaxLevel+WS.OverviewMap.ADDITIONAL_ZOOM_LEVELS,maxNativeZoom:e._scanLayersMaxLevel,_wsZoomOffset:a,_wsNativeTileSize:256,continuousWorld:!0,noWrap:!0,opacity:1,zIndex:WS.ScanTilesLayer.Z_INDEX_START_SCANS}),this._projectId=r,this._scanLayerData=i,this._highlightedScanIds={mouseover:[],menu:[],selection:[],all:[]},this._timeouts={mouseover:void 0},this._clustersByScanId={},this._scanColors={},this._pendingTiles={},this._loadedTiles={},this._tileQueue=[],this._numLoadingTiles=0,this._canvasMap={},this._enableLoadingTiles=!0,this._scanColorizer=n,this._scanList=t,this._maxParallelImgLoads=s,this._imgFactory=c,this._CDN=o},onAdd:function(e){L.TileLayer.Canvas.WithZoomOffset.prototype.onAdd.call(this,e),e.on("moveend",this.loadFromQueue,this),e.on("zoomend",this.resetAfterZoom,this),this.resetAfterZoom()},onRemove:function(e){L.TileLayer.Canvas.WithZoomOffset.prototype.onRemove.call(this,e),e.off("moveend",this.loadFromQueue,this),e.off("zoomend",this.resetAfterZoom,this)},resetAfterZoom:function(){this.calcLayerZoom(),this.options._wsLayerZoom!==this._currentZoom&&this.discardAllTiles(),this._currentZoom=this.options._wsLayerZoom,this.setScanList("mouseover",[]),this.cleanupCanvasMap(this._currentZoom),this.redraw()},redraw:function(){this.calcColors(),this._map&&L.TileLayer.Canvas.WithZoomOffset.prototype.redraw.call(this)},setScanList:function(e,t){var i="mouseover"===e?WS.ScanTilesLayer.TIMEOUT_MOUSEOVER:0;this.setScanListInternal(e,t,i)},setScanListInternal:function(e,t,i,n){var o=this;if(i>0){var r=function(){o.setScanListInternal(e,t,0,!0)};"number"==typeof this._timeouts[e]&&clearTimeout(this._timeouts[e]),this._timeouts[e]=setTimeout(r,i)}else{n&&"number"==typeof this._timeouts[e]&&(this._timeouts[e]=void 0);var a=this._highlightedScanIds[e];if(a.length=0,t.forEach(function(e){a.push(e)}),"mouseover"===e){this._clustersByScanId={};var s=this._clustersByScanId;t.forEach(function(e){s[e]=t})}this.onUpdateScanSet()}},addToScanList:function(e,t){var i=this._highlightedScanIds[e];t.forEach(function(e){F.addUnique(i,e)}),this.onUpdateScanSet()},removeFromScanList:function(e,t){var i=this._highlightedScanIds[e];t.forEach(function(e){F.removeFirst(i,e)}),this.onUpdateScanSet()},removeFromAllScanLists:function(e){var t=["selection","menu","mouseover"];t.forEach(F.proxy(function(t){"number"==typeof this._timeouts[t]&&(clearTimeout(this._timeouts[t]),this._timeouts[t]=void 0);var i=this._highlightedScanIds[t];e.forEach(function(e){F.removeFirst(i,e)})},this)),this.onUpdateScanSet()},onUpdateScanSet:function(){var e=this._highlightedScanIds,t=e.all,i=[];[].concat(e.mouseover,e.selection,e.menu).forEach(function(e){F.addUnique(i,e)}),this.sortScanList(i);var n=[],o=[];i.forEach(function(e){t.indexOf(e)<0&&n.push(e)}),t.forEach(function(e){i.indexOf(e)<0&&o.push(e)});var r=!1;n.length>0&&(this.onHighlightScans(n),r=!0),o.length>0&&(this.onUnhighlightScans(o),r=!0),r&&(e.all=i,this.redraw())},sortScanList:function(e){var t={};this._scanList.forEach(function(e){t[e._UUID]=e});var i=function(e,i){var n=t[e],o=t[i];return n.getGlobalZ()!==o.getGlobalZ()?n.getGlobalZ()-o.getGlobalZ():n._UUID>o._UUID?1:n._UUID<o._UUID?-1:0};e.sort(i)},onHighlightScans:function(){},onUnhighlightScans:function(e){this.abortPendingTilesForScans(e)},abortPendingTilesForScans:function(e){if(0!==e.length){var t,i,n,o=this,r=this._pendingTiles;for(var a in r)if(r.hasOwnProperty(a)&&r[a]){t=r[a];for(var s in t)if(t.hasOwnProperty(s)&&t[s]){i=t[s];for(var c in i)i.hasOwnProperty(c)&&i[c]&&(n=i[c],e.forEach(function(e){n[e]&&(o.abortPendingTile(n[e]),delete n[e])}))}}this._tileQueue=this._tileQueue.filter(function(t){return e.indexOf(t.scanid)<0})}},abortAllPendingTiles:function(){var e,t,i,n=this._pendingTiles;for(var o in n)if(n.hasOwnProperty(o)&&n[o]){e=n[o];for(var r in e)if(e.hasOwnProperty(r)&&e[r]){t=e[r];for(var a in t)if(t.hasOwnProperty(a)&&t[a]){i=t[a];for(var s in i)i.hasOwnProperty(s)&&i[s]&&this.abortPendingTile(i[s])}}delete n[o]}this._tileQueue.length=0,this._numLoadingTiles=0},isImage:function(e){return"object"==typeof e&&e instanceof Image},abortPendingTile:function(e){if(this.isImage(e)){this._numLoadingTiles--;var t=WS.ScanTilesLayer.falseFn;e.onload=t,e.onerror=t,e.onabort=t,e.src=WS.MapLeaflet.EMPTY_IMG_URL}},discardAllTiles:function(){this.abortAllPendingTiles();var e=this._loadedTiles;for(var t in e)e.hasOwnProperty(t)&&delete e[t]},enableLoadingTiles:function(e){this._enableLoadingTiles=e,this.loadFromQueue()},loadOrQueueScanTile:function(e,t,i,n){if(this._enableLoadingTiles){var o=this._pendingTiles;o[e]&&o[e][t]&&o[e][t][i]&&o[e][t][i][n]||(this._numLoadingTiles>=this._maxParallelImgLoads?(this._tileQueue.push({zoom:e,x:t,y:i,scanid:n}),this.addTileToStorage(o,WS.ScanTilesLayer.ImgStatus.QUEUED,e,t,i,n)):this.loadScanTile(e,t,i,n))}},loadScanTile:function(e,t,i,n){var o,r=this,a=this._imgFactory();if(WS._2GO)o="ws2go-data/project/"+this._projectId+"/map/scan-layers/"+n+"/tiles/"+e+"/"+t+"/"+i+".png";else{var s;if(F.isImgCrossOriginAvailable()&&this._CDN.hasCDN()&&(s=this._CDN.getSignature(this._projectId,!0)),!s||Q.isPromise(s))o="/data/project/"+this._projectId+"/scan-tile/"+n+"/"+e+"/"+t+"/"+i;else{var c=this._CDN.getSource(s,Math.abs(e+t+i));o=c.BaseURL+this._projectId+"/map/scan-layers/"+n+"/tiles/"+e+"/"+t+"/"+i+".png"+c.Query,a.crossOrigin="anonymous"}}var l=function(){r.onScanTileLoad(a,e,t,i,n)},h=function(){r.onScanTileError(e,t,i,n)};a.onload=l,a.onerror=h,a.onabort=h,a.src=o,this._numLoadingTiles++,this.addTileToStorage(this._pendingTiles,a,e,t,i,n)},loadFromQueue:function(){if(this._enableLoadingTiles)for(var e=this._map.getPixelBounds(),t=this._getTileSize(),i=L.bounds(e.min.divideBy(t).floor(),e.max.divideBy(t).floor()),n=0;this._numLoadingTiles<this._maxParallelImgLoads&&n<this._tileQueue.length;){var o=this._tileQueue[n];i.contains(L.point(o.x,o.y))?(this._tileQueue.splice(n,1),this.loadScanTile(o.zoom,o.x,o.y,o.scanid)):n++}},onScanTileLoad:function(e,t,i,n,o){this._numLoadingTiles--;var r={orig:e,colorized:void 0,color:void 0};this.removeTileFromStorage(this._pendingTiles,t,i,n,o),this.addTileToStorage(this._loadedTiles,r,t,i,n,o),this.drawTileForCoords(t,i,n,!1),this.loadFromQueue()},onScanTileError:function(e,t,i,n){this._numLoadingTiles--;var o={orig:WS.ScanTilesLayer.ImgStatus.NOT_FOUND,colorized:void 0,color:void 0};this.removeTileFromStorage(this._pendingTiles,e,t,i,n),this.addTileToStorage(this._loadedTiles,o,e,t,i,n),this.loadFromQueue()},removeTileFromStorage:function(e,t,i,n,o){e[t]&&e[t][i]&&e[t][i][n]&&e[t][i][n][o]&&delete e[t][i][n][o]},addTileToStorage:function(e,t,i,n,o,r){e[i]=e[i]||{},e[i][n]=e[i][n]||{},e[i][n][o]=e[i][n][o]||{},e[i][n][o][r]=t},drawTile:function(e,t){var i=t.z,n=t.x,o=t.y,r=this._canvasMap;r[i]=r[i]||{},r[i][n]=r[i][n]||{},r[i][n][o]=e,this.drawTileForCoords(i,n,o,!0)},drawTileForCoords:function(e,t,i,n){var o=this._canvasMap;if(!o[e]||!o[e][t]||!o[e][t][i])return!1;var r=o[e][t][i],a=this.getScansRequiredForTile(e,t,i),s=this,c=a.map(function(o){var r=s.getLoadedScanTile(e,t,i,o);return!r&&n&&s.loadOrQueueScanTile(e,t,i,o),r});return this.doDrawTile(r,a,c),!0},doDrawTile:function(e,t,i){var n=this,o=e.getContext("2d"),r=e.width,a=e.height,s=document.createElement("canvas");s.width=r,s.height=a;for(var c,l=s.getContext("2d"),h=0,d=t.length;d>h;h++){var u=i[h];if(u){var p=u.orig,_=u.color;if(this.isImage(p)){var g,f=t[h],m=n._scanColors[f];if(u.colorized&&_&&_.r===m.r&&_.g===m.g&&_.b===m.b)g=u.colorized;else{g=document.createElement("canvas"),g.width=r,g.height=a;var v=g.getContext("2d");v.drawImage(p,0,0),c=v.getImageData(0,0,r,a),n._scanColorizer.colorizePixels(c,m),v.putImageData(c,0,0),u.colorized=g,u.color={r:m.r,g:m.g,b:m.b}}l.drawImage(g,0,0)}}}c=l.getImageData(0,0,r,a),o.putImageData(c,0,0)},calcColors:function(){var e=this,t=this._highlightedScanIds.all;this._scanColors={},t.forEach(function(t){var i=e._clustersByScanId[t]||[t],n=e._scanColorizer.getScanTileColor(t,i);e._scanColors[t]=n})},getLoadedScanTile:function(e,t,i,n){var o=this._loadedTiles;return o[e]&&o[e][t]&&o[e][t][i]&&o[e][t][i][n]},getScansRequiredForTile:function(e,t,i){var n=this._highlightedScanIds.all,o=this._scanLayerData._layers,r=n.filter(function(n){return o&&o[n]&&o[n]._tiles&&o[n]._tiles[e]&&o[n]._tiles[e][t]&&o[n]._tiles[e][t][i]});return r},cleanupCanvasMap:function(e){var t=this._canvasMap;for(var i in t)i!==e&&t.hasOwnProperty(i)&&t[i]&&delete t[i]},isInQueue:function(e,t,i,n){var o=F.findFirst(this._tileQueue,function(o){return o.zoom===e&&o.x===t&&o.y===i&&o.scanid===n});return!!o},consistencyCheck:function(){var e,t,i,n=this._pendingTiles,o=0,r=0;for(var a in n)if(n.hasOwnProperty(a)&&n[a]){e=n[a];{parseInt(a)}for(var s in e)if(e.hasOwnProperty(s)&&e[s]){t=e[s];{parseInt(s)}for(var c in t)if(t.hasOwnProperty(c)&&t[c]){i=t[c];{parseInt(c)}for(var l in i)i.hasOwnProperty(l)&&i[l]&&(i[l]===WS.ScanTilesLayer.ImgStatus.QUEUED?r++:o++)}}}return!0}}),WS.ScanTilesLayer.falseFn=function(){return!1},WS.ScanTilesLayer.ImgStatus={LOADED:1,LOADING:2,QUEUED:3,NOT_FOUND:4},WS.ScanTilesLayer.MAX_PARALLEL_IMG_LOADS=F.isMobile()?10:20,WS.ScanTilesLayer.TIMEOUT_MOUSEOVER=300,WS.ScanTilesLayer.ZOOM_OFFSET=-2,WS.ScanTilesLayer.Z_INDEX_START_LAYERS=0,WS.ScanTilesLayer.Z_INDEX_MAP=1e3,WS.ScanTilesLayer.Z_INDEX_START_SCANS=1001,WS.ColorGradient=function(e){this._colorPalette=e},WS.ColorGradient.prototype={getInterpolatedColor:function(e){var t=this._colorPalette.length,i=Math.floor(e*(t-1)),n=e*(t-1)-i,o=1-n;if(0>i)return this._colorPalette[0];if(i>=t-1)return this._colorPalette[t-1];var r=this._colorPalette[i],a=this._colorPalette[i+1];return{r:Math.round(o*r.r+n*a.r),g:Math.round(o*r.g+n*a.g),b:Math.round(o*r.b+n*a.b)}},getCanvasGradient:function(e,t,i,n,o){for(var r=e.createLinearGradient(t,i,n,o),a=this._colorPalette.length,s=1/(a-1),c=1,l=0;a>l;l++){var h=this._colorPalette[l];r.addColorStop(c,"rgb("+h.r+","+h.g+","+h.b+")"),c=Math.max(0,c-s)}return r}},WS.extend("ColorGradient"),WS.MapMarker=function(e,t,i,n){this._parent=t,this._visible=!1,this._marker=L.marker(i,n),this._marker._wsObject=e},WS.MapMarker.prototype={getObject:function(){return this._marker._wsObject},getMarker:function(){return this._marker},getLatLng:function(){return this._marker.getLatLng()},setLatLng:function(e){this._marker.setLatLng(e)},setVisible:function(e){e&&!this._visible?this.add():!e&&this._visible&&this.remove()},add:function(){this._parent._wsBulkAdd?this._parent._wsBulkAdd.push(this._marker):this._parent.addLayer(this._marker),this._visible=!0},remove:function(){this._parent._wsBulkRemove?this._parent._wsBulkRemove.push(this._marker):this._parent.removeLayer(this._marker),this._visible=!1},setParent:function(e){return this._visible?void(e!==this._parent&&(this._parent.removeLayer(this._marker),e.addLayer(this._marker),this._parent=e)):void(this._parent=e)},setWorldIcon:function(){this._marker.setIcon(WS.MapMarker.ICON_WORLD)},setIconByUrl:function(e){var t=L.icon({iconUrl:e,iconSize:WS.MapMarker.SIZE,iconAnchor:WS.MapMarker.ICON_ANCHOR,popupAnchor:WS.MapMarker.POPUP_ANCHOR,shadowUrl:WS.MapMarker.SHADOW_URL,shadowSize:WS.MapMarker.SHADOW_SIZE,shadowAnchor:WS.MapMarker.SHADOW_ANCHOR});this._marker.setIcon(t)},setTitle:function(e){this._marker.options.title=e,this._marker._icon&&(this._marker._icon.title=e)},on:function(e,t,i){this._marker.on(e,t,i)},off:function(e,t,i){this._marker.off(e,t,i)}},WS.extend("MapMarker"),WS.MapMarker.SIZE=[32,45],WS.MapMarker.ICON_ANCHOR=[16,43],WS.MapMarker.POPUP_ANCHOR=[0,-45],WS.MapMarker.SHADOW_URL=WS.imgUrl("icons/im/map_marker_shadow.png"),WS.MapMarker.SHADOW_SIZE=[40,50],WS.MapMarker.SHADOW_ANCHOR=[20,46],WS.MapMarker.ICON_WORLD=L.icon({iconUrl:WS.imgUrl("icons/im/old_map_marker_or.png"),iconSize:WS.MapMarker.SIZE,iconAnchor:WS.MapMarker.ICON_ANCHOR,popupAnchor:WS.MapMarker.POPUP_ANCHOR,shadowUrl:WS.MapMarker.SHADOW_URL,shadowSize:WS.MapMarker.SHADOW_SIZE,shadowAnchor:WS.MapMarker.SHADOW_ANCHOR}),WS.MapMarker.prefetchIcons=function(){var e=document.createElement("img");e.src=WS.MapMarker.ICON_WORLD.options.iconUrl;var t=document.createElement("img");t.src=WS.MapMarker.ICON_WORLD.options.shadowUrl},WS.MapMarker.bulkBegin=function(e){e._wsBulkAdd=[],e._wsBulkRemove=[]},WS.MapMarker.bulkEnd=function(e){e._wsBulkAdd.length&&e.addLayers(e._wsBulkAdd),e._wsBulkRemove.length&&e.removeLayers(e._wsBulkRemove),e._wsBulkAdd=void 0,e._wsBulkRemove=void 0},WS.MapImageControl=L.Control.extend({options:{},initialize:function(e,t){L.Util.setOptions(this,t),e=e||WS.MapLeaflet.EMPTY_IMG_URL;var i="";this.options.cssClass&&(i='class="'+this.options.cssClass+'"');var n=$('<img src="'+e+'" '+i+">");this._img=n[0]},onAdd:function(){return this._img},onRemove:function(){},setUrl:function(e){this._img.src=e||WS.MapLeaflet.EMPTY_IMG_URL},setOpacity:function(e){this._img.style.opacity=e},setVisible:function(e){this._img.style.display=e?"inline":"none"}}),WS.MapLeafletViewAllControl=L.Control.extend({options:{position:"topleft",tooltip:""},initialize:function(e,t,i){this._mapLeaflet=t,L.Util.setOptions(this,i),this.options.tooltip&&(this.options.tooltip=e.translate(this.options.tooltip))},onAdd:function(){{var e=L.DomUtil.create("div","ws_overviewmap_ViewAllControl leaflet-control-zoom leaflet-bar leaflet-control");this.createButton("",this.options.tooltip,"ws_overviewmap_ViewAllControl f_cursorPointer",e,this.onClick,this)}return e},createButton:function(e,t,i,n,o,r){var a=L.DomUtil.create("a",i,n);a.innerHTML=e,a.title=t;var s=L.DomEvent.stopPropagation;return L.DomEvent.on(a,"click",s).on(a,"mousedown",s).on(a,"dblclick",s).on(a,"click",L.DomEvent.preventDefault).on(a,"click",o,r),a},onClick:function(){this._mapLeaflet.zoomFit()}}),WS.MapLeaflet=function(e,t,i,n,o){WS.View3d.call(this,e,t,o),this._locale=i,this._unit=n,this._targetDomElement=void 0,this._overlayContainer=void 0,this._markerMap={},this._fitMarkersMargin=0,this._map=void 0},WS.MapLeaflet.prototype={initMap:function(){this._markerMap={}},setContainerDiv:function(e){this._targetDomElement=e},addViewAllControl:function(e){var t=new WS.MapLeafletViewAllControl(this._locale,this,e);this._map.addControl(t)},addMarker:function(e,t){this._markerMap[e]=t},removeMarker:function(e){this._markerMap[e]&&(this._markerMap[e].setVisible(!1),delete this._markerMap[e])},getMarkerArray:function(){var e=[];for(var t in this._markerMap)this._markerMap.hasOwnProperty(t)&&e.push(this._markerMap[t]);return e},getMarkerBounds:function(){var e=this.getMarkerArray(),t=e.map(function(e){return e.getLatLng()}),i=L.latLngBounds(t);return i},fitMarkers:function(){this.invalidateSize();var e=this.getMarkerBounds();
this.fitBounds(e,this._fitMarkersMargin)},zoomFit:function(){},getCenterOfMarkers:function(){return this.getMarkerBounds().getCenter()},containerPointToXYZ:function(e,t){var i=this._map.containerPointToLatLng(new L.Point(e,t,!1));return[i.lng,i.lat,0]},latLngToPixel:function(e){return this._map.project(e)},latLngToLayerPoint:function(e){return this._map.latLngToLayerPoint(e)},layerPointToLatLng:function(e){return this._map.layerPointToLatLng(e)},layerPointToContainerPoint:function(e){return this._map.layerPointToContainerPoint(e)},containerPointToLayerPoint:function(e){return this._map.containerPointToLayerPoint(e)},latLngToContainerPoint:function(e){return this._map.latLngToContainerPoint(e)},isContainerVisible:function(){var e=this._targetDomElement;return e&&e.offsetWidth>0&&e.offsetHeight>0},setAnimOptions:function(e){var t=this.isContainerVisible()?{}:{animate:!1};return L.extend({animate:!0},e,t)},setZoom:function(e,t){this._map.setZoom(e,this.setAnimOptions(t))},zoomIn:function(e,t){this._map.zoomIn(e,this.setAnimOptions(t))},zoomOut:function(e,t){this._map.zoomOut(e,this.setAnimOptions(t))},setView:function(e,t,i){this._map.setView(e,t,this.setAnimOptions(i))},fitBounds:function(e,t,i){void 0===t&&(t=0);var n=L.latLng(e.getSouth()-t,e.getWest()-t),o=L.latLng(e.getNorth()+t,e.getEast()+t);e=L.latLngBounds(n,o),this._map.fitBounds(e,this.setAnimOptions(i))},invalidateSize:function(){this._map&&this._map.invalidateSize()},clickDebugMode:function(e){this._map.on("click",F.proxy(this.onClickPosInfo,this)),e&&this._map.on("click",F.proxy(this.onClickMapInfo,this))},locationDebugMode:function(){this._map.locate({setView:!0,maxZoom:2}),this._map.on("locationfound",F.proxy(this.onLocationFound,this)),this._map.on("locationerror",F.proxy(this.onLocationError,this))},onLocationFound:function(e){var t=e.accuracy/2;L.marker(e.latlng).addTo(this._map).bindPopup("You are within "+t+" meters from this point"),L.circle(e.latlng,t).addTo(this._map)},onLocationError:function(e){alert(e.message)},onClickPosInfo:function(){},onClickMapInfo:function(){}},WS.extend("MapLeaflet","View3d"),WS.MapLeaflet.EMPTY_IMG_URL="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7",WS.WSTilesLayer=L.TileLayer.extend({initialize:function(e,t,i,n,o,r){this._tilesData=e,this._cdn=t,this._cdnPrefix=i,this._urlLocal=n,this._urlCDN=o,L.TileLayer.prototype.initialize.call(this,n,r)},getTileUrl:function(e){var t;if(this._urlCDN&&(t=this._cdn.getSignature(this._cdnPrefix,!0)),t&&!Q.isPromise(t)){var i=this._cdn.getSource(t,Math.abs(e.z+e.x+e.y));return i.BaseURL+L.Util.template(this._urlCDN,{z:e.z,x:e.x,y:e.y})+i.Query}return L.Util.template(this._urlLocal,{z:e.z,x:e.x,y:e.y})},_tileShouldBeLoaded:function(e){var t=this._tilesData;if(t){var i=e.x,n=e.y,o=this._map.getZoom();if("number"==typeof this.options.maxNativeZoom&&(o=Math.min(o,this.options.maxNativeZoom)),void 0===t[o]||void 0===t[o][i]||void 0===t[o][i][n])return!1}return L.TileLayer.prototype._tileShouldBeLoaded.call(this,e)},_createTile:function(){var e=L.TileLayer.prototype._createTile.call(this);return e.className+=" f_pixelated",e}}),WS.OverviewMapSettings=function(e,t,i,n,o,r,a,s,c,l,h){WS.CRUDObject.call(this,h),this._scanOrBaseTiles=void 0!==e?e:WS.OverviewMapSettings.COLORIZE_SCAN_TILES,this._scanTilesColorizeBy=void 0!==t?t:WS.OverviewMapSettings.COLORIZE_BY_HEIGHT,this._baseTilesColorizeBy=void 0!==i?i:WS.OverviewMapSettings.COLORIZE_BY_AVG_AGE,this._baseTilesColorizeWhat=void 0!==n?n:WS.OverviewMapSettings.COLORIZE_TILE_BACKGROUND,this._colorPaletteIdx=void 0!==o?o:1,this._aggregation=void 0!==r?r:WS.OverviewMapSettings.AGG_AVG,this._iconMode=void 0!==a?a:WS.OverviewMapSettings.IconModes.Category,this._showScanLabelsInMap=void 0!==s?s:!0,this._showOrthoVolumes=c||!1,this._showPolylines=void 0!==l?l:!0;var d;switch(this._colorPaletteIdx){case 0:d=[{r:254,g:178,b:76},{r:253,g:141,b:60},{r:252,g:78,b:42},{r:227,g:26,b:28},{r:189,g:0,b:38},{r:128,g:0,b:38}];break;case 1:d=[{r:0,g:0,b:255},{r:255,g:0,b:0}]}this._colorGradient=new WS.ColorGradient(d)},WS.OverviewMapSettings.prototype={clone:function(){return new WS.OverviewMapSettings(this._scanOrBaseTiles,this._scanTilesColorizeBy,this._baseTilesColorizeBy,this._baseTilesColorizeWhat,this._colorPaletteIdx,this._aggregation,this._iconMode,this._showScanLabelsInMap,this._showOrthoVolumes,this._showPolylines,this._service)},writeToLocalStorage:function(){this._service.writeToLocalStorage(this)}},WS.extend("OverviewMapSettings","CRUDObject"),WS.OverviewMapSettings.COLORIZE_BY_HEIGHT="elevation",WS.OverviewMapSettings.COLORIZE_BY_AGE="age",WS.OverviewMapSettings.AGG_AVG="aggAvg",WS.OverviewMapSettings.AGG_MIN="aggMin",WS.OverviewMapSettings.AGG_MAX="aggMax",WS.OverviewMapSettings.AGG_INDIVIDUAL="aggIndiv",WS.OverviewMapSettings.COLORIZE_SCAN_TILES="scanTiles",WS.OverviewMapSettings.COLORIZE_BASE_TILES="baseTiles",WS.OverviewMapSettings.COLORIZE_TILE_BACKGROUND="background",WS.OverviewMapSettings.COLORIZE_TILE_POINTS="points",WS.OverviewMapSettings.COLORIZE_BY_AVG_AGE="avgAge",WS.OverviewMapSettings.COLORIZE_BY_MIN_AGE="minAge",WS.OverviewMapSettings.COLORIZE_BY_MAX_AGE="maxAge",WS.OverviewMapSettings.IconModes=WS.PanoSettings.IconModes,WS.OverviewMapSettings.IconModeNames=WS.PanoSettings.IconModeNames,WS.ScanColorizer=function(e,t,i,n){F.PlugModule.call(this,e),this._settingsService=t,this._scanService=n,this._nowMsec=(new Date).getTime(),this._scanList=[],this._scansById={},this._minAge=void 0,this._maxAge=void 0,this._ageGranularity=void 0,this._minGlobalZ=void 0,this._maxGlobalZ=void 0,this._colorGradient=void 0,this.provideFemalePlug("SettingsUpdate",["updateSettings"]),this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideMalePlug("SettingsUpdate",["updateSettings"]),this._connectorService.connect(this.getFemalePlug("SettingsUpdate"),this._settingsService),this._connectorService.connect(this.getFemalePlug("SettingsUpdate"),i),this._connectorService.connect(this,this._scanService)},WS.ScanColorizer.prototype={addObjects:function(e){for(var t=!1,i=0,n=e.length;n>i;i++){var o=e[i];t=F.addUnique(this._scanList,o)||t}t&&this.update()},updateObjects:function(){},removeObjects:function(e){for(var t,i=0,n=e.length;n>i;i++){var o=e[i];t=F.removeFirst(this._scanList,o)||t}t&&this.update()},updateSettings:function(e){switch(e){case"overviewmap":case"unit":this.update()}},update:function(){var e=this;this._scanList.forEach(function(t){e._scansById[t._UUID]=t}),this._colorGradient=this._settingsService.getColorGradient(),this.calcMinMaxAge(),this.calcMinMaxHeight(),this.trigger("updateSettings",["colorizer",this])},calcMinMaxAge:function(){var e=this;if(0===this._scanList.length)return void(this._minAge=this._maxAge=this._ageGranularity=void 0);if(this._minAge=Number.MAX_VALUE,this._maxAge=-Number.MAX_VALUE,this._scanList.forEach(function(t){var i=e.getScanAge(t);i!==WS.ScanColorizer.DEFAULT_AGE&&(e._minAge=Math.min(e._minAge,i),e._maxAge=Math.max(e._maxAge,i))}),this._minAge===Number.MAX_VALUE)return void(this._minAge=this._maxAge=this._ageGranularity=void 0);var t,i=this._maxAge-this._minAge;i>3650?(this._ageGranularity="y",t=365):i>10?(this._ageGranularity="d",t=1):(this._ageGranularity="h",t=1/24),this._maxAge-this._minAge<t&&(this._maxAge=this._minAge+t)},calcMinMaxHeight:function(){var e=this;return 0===this._scanList.length?void(this._minGlobalZ=this._maxGlobalZ=void 0):(this._minGlobalZ=Number.MAX_VALUE,this._maxGlobalZ=-Number.MAX_VALUE,this._scanList.forEach(function(t){var i=t.getGlobalZ();e._minGlobalZ=Math.min(e._minGlobalZ,i),e._maxGlobalZ=Math.max(e._maxGlobalZ,i)}),void(this._maxGlobalZ-this._minGlobalZ<.001&&(this._maxGlobalZ=this._minGlobalZ+.001)))},hasAgeInfo:function(){return void 0!==this._minAge},hasHeightInfo:function(){return void 0!==this._minGlobalZ},getScanTileColor:function(e,t){var i=this;void 0===t&&(t=[e]);var n=t.map(function(e){return i._scansById[e]}),o=this._scansById[e];if(!o)return WS.ScanColorizer.DEFAULT_COLOR;if(this._settingsService.scanTilesColorizeBy()===WS.OverviewMapSettings.COLORIZE_BY_AGE){var r=this.getAggregatedAge(n,o);return this.getColorByAge(r)}var a=this.getAggregatedHeight(n,o);return this.getColorByHeight(a)},getClusterColor:function(e){var t=this,i=e.map(function(e){return t._scansById[e]});if(this._settingsService.scanTilesColorizeBy()===WS.OverviewMapSettings.COLORIZE_BY_AGE){if(!this.hasAgeInfo())return WS.ScanColorizer.DEFAULT_COLOR;var n=this.getAggregatedAge(i);return this.getColorByAge(n)}if(!this.hasHeightInfo())return WS.ScanColorizer.DEFAULT_COLOR;var o=this.getAggregatedHeight(i);return this.getColorByHeight(o)},colorizeBaseTilePoints:function(e,t){this.colorizePixels(e,this.getBaseTileColor(t))},colorizeBaseTileBackground:function(e,t){var i=e.getContext("2d"),n=this.getBaseTileColor(t);i.fillStyle="rgb("+n.r+","+n.g+","+n.b+")",i.fillRect(0,0,e.width,e.height)},getBaseTileColor:function(e){var t;switch(this._colorizeBy){case WS.OverviewMapSettings.COLORIZE_BY_AVG_AGE:t=e.Mean;break;case WS.OverviewMapSettings.COLORIZE_BY_MIN_AGE:t=e.Newest;break;case WS.OverviewMapSettings.COLORIZE_BY_MAX_AGE:t=e.Oldest;break;default:return WS.ScanColorizer.DEFAULT_COLOR}return this.getColorByDate(t)},colorizePixels:function(e,t){for(var i=t.r,n=t.g,o=t.b,r=e.data,a=0,s=r.length;s>a;a+=4)r[a]=i,r[a+1]=n,r[a+2]=o},getAggregatedAge:function(e,t){var i=this._settingsService.getAggregation();if(t&&i===WS.OverviewMapSettings.AGG_INDIVIDUAL)return this.getScanAge(t);for(var n=e.length,o=i==WS.OverviewMapSettings.AGG_MIN?Number.MAX_VALUE:0,r=0,a=0;n>a;a++){var s=this.getScanAge(e[a]);if(s!==WS.ScanColorizer.DEFAULT_AGE)switch(r++,i){case WS.OverviewMapSettings.AGG_AVG:o+=s;break;case WS.OverviewMapSettings.AGG_MIN:o=Math.min(o,s);break;case WS.OverviewMapSettings.AGG_MAX:o=Math.max(o,s);break;case WS.OverviewMapSettings.AGG_INDIVIDUAL:o+=s}}return r>0?((i===WS.OverviewMapSettings.AGG_AVG||i===WS.OverviewMapSettings.AGG_INDIVIDUAL)&&(o/=r),o):WS.ScanColorizer.DEFAULT_AGE},getScanAge:function(e){return F.isDefaultDate(e._recordingTime)?WS.ScanColorizer.DEFAULT_AGE:F.ageInDays(e._recordingTime,this._nowMsec)},getColorByAge:function(e){if(e===WS.ScanColorizer.DEFAULT_AGE)return WS.ScanColorizer.DEFAULT_COLOR;if(!this._minAge)return this._colorGradient.getInterpolatedColor(0);var t=(e-this._minAge)/(this._maxAge-this._minAge);return this._colorGradient.getInterpolatedColor(t)},getColorByDate:function(e){if(F.isDefaultDate(e))return WS.ScanColorizer.DEFAULT_COLOR;var t=F.ageInDays(e,this._nowMsec);return this.getColorByAge(t)},formatAge:function(e){return e===WS.ScanColorizer.DEFAULT_AGE?"?":WS.ScanColorizer.formatAge(e,{granularity:this._ageGranularity})},formatAgeFromDate:function(e){if(F.isDefaultDate(e))return"?";var t=F.ageInDays(e,this._nowMsec);return WS.ScanColorizer.formatAge(t,{granularity:this._ageGranularity})},getAggregatedHeight:function(e,t){var i=this._settingsService.getAggregation();if(t&&i===WS.OverviewMapSettings.AGG_INDIVIDUAL)return t.getGlobalZ();for(var n=e.length,o=e[0].getGlobalZ(),r=1;n>r;r++){var a=e[r].getGlobalZ();switch(i){case WS.OverviewMapSettings.AGG_AVG:o+=a;break;case WS.OverviewMapSettings.AGG_MIN:o=Math.min(o,a);break;case WS.OverviewMapSettings.AGG_MAX:o=Math.max(o,a);break;case WS.OverviewMapSettings.AGG_INDIVIDUAL:o+=a}}return(i===WS.OverviewMapSettings.AGG_AVG||i===WS.OverviewMapSettings.AGG_INDIVIDUAL)&&(o/=n),o},getColorByHeight:function(e){var t=(e-this._minGlobalZ)/(this._maxGlobalZ-this._minGlobalZ);return this._colorGradient.getInterpolatedColor(t)}},WS.extend("ScanColorizer","PlugModule"),WS.ScanColorizer.formatAge=function(e,t){t||(t={});var i=t.years,n=t.days,o=t.hours,r=t.separator,a=t.granularity;void 0===i&&(i="y"),void 0===n&&(n="d"),void 0===o&&(o="h"),void 0===r&&(r=" "),void 0===a&&(a="h");var s=24*e,c=Math.floor(s/24);s=Math.floor(s%24);var l=Math.floor(c/365);c=Math.floor(c%365);var h=[];switch(a){case"y":h.push(l+i);break;case"d":l>0&&h.push(l+i),h.push(c+n);break;default:l>0?(h.push(l+i),h.push(c+n)):c>0&&h.push(c+n),h.push(s+o)}return h.join(r)},WS.ScanColorizer.MSEC_PER_DAY=864e5,WS.ScanColorizer.DEFAULT_AGE=-1,WS.ScanColorizer.DEFAULT_COLOR={r:128,g:128,b:128},WS.MapScale=function(e,t,i,n,o){WS.PlugController.call(this,e,t),this.$scope=e;var r=this;this._settings=i,this._unit=n,this._scanColorizer=o,e.titleAggFunc="",e.titleAggBy="",e.min="",e.max="",e.width=WS.MapScale.DefaultSize,e.drawGradient=function(){r.drawGradient()},this.provideFemalePlug("SettingsUpdate",["updateSettings"]),this._connectorService.connect(this.getFemalePlug("SettingsUpdate"),this._settings),this._connectorService.connect(this.getFemalePlug("SettingsUpdate"),this._scanColorizer)},WS.MapScale.prototype={drawGradient:function(){var e=$("#mapScaleCanvas").get(0);if(e){var t=e.getContext("2d"),i=this._settings.getColorGradient();t.fillStyle=i.getCanvasGradient(t,e.width,0,0,0),t.fillRect(0,0,e.width,e.height)}},updateCaptions:function(){var e=this._settings.scanTilesColorizeBy()===WS.OverviewMapSettings.COLORIZE_BY_AGE,t=this._settings.scanTilesColorizeBy()===WS.OverviewMapSettings.COLORIZE_BY_HEIGHT,i=this._scanColorizer,n="?",o="?";i&&(e&&i.hasAgeInfo()?(n=i.formatAge(i._minAge),o=i.formatAge(i._maxAge)):t&&i.hasHeightInfo()&&(n=this._unit.getLengthAndUnit(i._minGlobalZ,3),o=this._unit.getLengthAndUnit(i._maxGlobalZ,3)));var r="";switch(this._settings.getAggregation()){case WS.OverviewMapSettings.AGG_AVG:r="FE_AVG";break;case WS.OverviewMapSettings.AGG_MIN:r="FE_MIN";break;case WS.OverviewMapSettings.AGG_MAX:r="FE_MAX";break;case WS.OverviewMapSettings.AGG_INDIVIDUAL:r="FE_INDV"}this.$scope.$apply(function(t){t.titleAggFunc=r,t.titleAggBy=e?"FE_AGE":"FE_ELEVATION",t.min=n,t.max=o})},updateSettings:function(e){"overviewmap"===e?this.drawGradient():"colorizer"===e&&this.updateCaptions()}},WS.extend("MapScale","PlugController"),WS.MapScale.DefaultSize=160,WS.OverviewMap=function(e,t,i,n,o,r,a,s,c,l,h,d,u,p,_,g,f,m,v,S,b,y,P,C){var w=this;WS.MapLeaflet.call(this,e,t,i,n,_),window.om=this,this._type=WS.OverviewMap.type,this._unit=n,this._selection=o,this._layer=r,this._projectService=a,this._scanService=s,this._annotation=m,this._measurement=v,this._tempmeasurement=S,this._orthophoto=b,this._tempOrthophoto=y,this._point3d=P,this._mapObjectService=u,this._mapLayerService=p,this._mapService=c,this._settingService=l,this._login=h,this._alert=d,this._domainSettings=g,this._scanColorizer=f,this._CDN=C,this._mapObject=void 0,this._mapMetadata=void 0,this._commonMetadata=void 0,this._mapLayersByObjUuid={},this._trafoView=mat4.identity(),this._fsm=new F.FiniteStateMachine(WS.OverviewMap.FSM,"void"),this._dScans=Q.defer(),this._promiseScans=this._dScans.promise,this._dPositioned=Q.defer(),this._promisePositioned=this._dPositioned.promise,this._panoviewScanId=void 0,this._logoLoaded=!1,this._numTileLayers=0,this._fadeByDefault=!0,this._objects={scan:{service:s,selection:o.getSelection("Scan"),entities:[]},annotation:{service:m,selection:o.getSelection("Annotation"),entities:[]},measurement:{service:v,selection:o.getSelection("Measurement"),entities:[]},tempmeasurement:{service:S,selection:o.getSelection("TempMeasurement"),entities:[]},orthophoto:{service:b,selection:o.getSelection("Orthophoto"),entities:[]},temporthophoto:{service:y,entities:[]},point3d:{entities:[]}},this._linesRenderable=void 0,this._lineAreaEnd=void 0,this._layers={scanTiles:void 0,baseTiles:void 0},this._frustumLayer=void 0,this._frustumPoly=L.polygon([]),this._camPosCircle=L.circleMarker(L.latLng(0,0),{opacity:0,fillOpacity:0}),this._markerSelectionGroup=void 0,this._markerClusterGroup=void 0,this._fitMarkersMargin=1.5,this._settingsSet=!1,this._logoCtrl=new WS.MapImageControl(void 0,{cssClass:"ws_customerLogo",position:"bottomright"}),this.provideFemalePlug("ViewMode",["setMode"]),this.provideMalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("ViewFocus",["focusOn"]),this.provideFemalePlug("ObjectUpdate",["updateObjects"]),this.provideFemalePlug("SettingsUpdate",["updateSettings"]),this.provideFemalePlug("ScanPointsShow",["showScanPoints","hideScanPoints"]),this.provideFemalePlug("ScanSelect",["select","unselect"]),this.provideFemalePlug("AnnotationSelect",["select","unselect"]),this.provideFemalePlug("MeasurementSelect",["select","unselect"]),this.provideFemalePlug("TempMeasurementSelect",["select","unselect"]),this.provideFemalePlug("OrthophotoSelect",["select","unselect"]),this.provideFemalePlug("PointPick3DControl",["setPickedPoints"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.provideFemalePlug("CameraChanged",["onCameraChange"]),this.provideFemalePlug("SceneRootChange",["sceneRootChange"]),this.provideMalePlug("TaskLaunch",["launchTask"]),this.provideFemalePlug("URLChange",["setFragment","applyURL"]),this.provideMalePlug("PointPick3D",["pickPoint"]),t.connect(this,l),t.connect(this.getFemalePlug("ObjectUpdate"),r),t.connect(this,n),t.connect(this,i),t.connect(this.getFemalePlug("Login"),h),t.connect(this.getFemalePlug("SettingsUpdate"),f),["Scan","Annotation","Measurement","TempMeasurement","Orthophoto"].forEach(function(e){t.connect(w,o.getSelection(e))}),[s,m,v,S,b,y,P,g,u,p].forEach(function(e){t.connect(w,e)}),this.autoConnect(e),a.subscribe("change",this.changeProjectSync.bind(this)),this.initScope(e),this.setCanvas([this.createOverlayCanvas(100,100),this.createOverlayCanvas(100,100)]),this.loadSettings()},WS.OverviewMap.prototype={initScope:function(e){var t=this;e._2GO=WS._2GO,e.error=void 0,e.message="",e.page={actionBarActive:!1},e.changeViewMode=function(e){"3d"===e.view&&(e.pointCloud?t.trigger("showObjects",[[e.pointCloud],"3d"]):t.trigger("showObjects",[[],"3d"]))},e.pickScan=F.proxy(this.pickScan,this),e.project=void 0,e.leafletLayers=[],e.zoomIn=function(){t.zoomIn(1)},e.zoomOut=function(){t.zoomOut(1)},e.zoomFit=function(){t.zoomFit()},e.toggleTileLayer=function(e){e.options.opacityIsInitial&&0===e.options.opacity&&(e.options.opacity=1,e.options.opacityIsInitial=!1),e.options.visible?t._map.removeLayer(e):e.addTo(t._map),e.options.visible=!e.options.visible},e.changeLayerOpacity=function(e,t){var i=e.options.opacity+t;i=Math.max(0,i),i=Math.min(1,i),e.setOpacity(i)},e.scale={width:WS.MapScale.DefaultSize},e.pickedPoint=void 0,e.flashPicker=!1,e.showPanoView=function(){var e=t._map?t._map.getCenter():void 0;t._scanService.getNearestScan(e?[e.lng,e.lat]:[0,0]).then(function(e){t.trigger("showObjects",[[e],"panorama",{miniView:!0}])},function(e){t._alert.errorObj(e)})},e.getPosInCS=function(i){return e.project._trafo&&t._unit.isCustomCS()?mat4.posInRefSystem(i,e.project._trafo):i}},setViewModeCtrl:function(e){this._viewModeCtrl=e,this._viewModeCtrlD.resolve(e),F.async(function(){e.viewMode(WS.OverviewMap.ViewMode.MAP)})},initLogo:function(){var e=this;this._domainSettings.get().done(function(t){e.updateDomainSettings(t)},F.NOP)},loadSettings:function(){var e=this;this._settingService.getAll().then(function(t){e.updateSettings("overviewmap",t[0])},function(t){e._alert.errorObj(t)}).done()},updateSettings:function(e,t){switch(e){case"overviewmap":this.updateSettingsInternal(t);break;case"unit":this._scene&&this._scene.traverse(new WS.UpdateUnitVisitor);break;case"language":this._scene&&this._scene.traverse(new WS.UpdateLanguageVisitor);break;case"domain":this.updateDomainSettings(t);break;case"colorizer":this.updateScanColors(),this._markerClusterGroup&&this._markerClusterGroup._topClusterLevel&&this._markerClusterGroup.refreshClusters()}},updateSettingsInternal:function(e){this._settingsSet=!0,this._scene&&(this._scene.traverse(new WS.SetIconModeVisitor(e._iconMode)),this._scene.traverse(new WS.ScanLabelsVisitor(e._showScanLabelsInMap)),this._scene.traverse(new WS.ShowBoxVisitor(e._showOrthoVolumes)),this._scene.traverse(new WS.ShowPolylineVisitor(e._showPolylines)));var t=this._markerClusterGroup;if(t){var i=t.options.maxClusterRadius,n=e._showScanLabelsInMap&&i!==WS.OverviewMap.CLUSTER_DIST_WITH_LABELS||!e._showScanLabelsInMap&&i!==WS.OverviewMap.CLUSTER_DIST_NO_LABELS;if(n){this._map.removeLayer(t),this.createClusterGroup();for(var o in this._markerMap)this.updateMarkerIcon(this._markerMap[o])}}},updateDomainSettings:function(e){this._logoCtrl.setUrl(this._domainSettings.getCustomerLogoUrl(e)),this._logoCtrl.setOpacity(e._customerLogoOpacity/100)},reset:function(){this._mapObject=void 0,this._mapMetadata=void 0,this._commonMetadata=void 0,this._mapLayersByObjUuid={},this._numTileLayers=0,this._hlObject=void 0,this.$scope.project=void 0,this.$scope.pickedPoint=void 0,this.$scope.leafletLayers=[],this._viewModeCtrl&&this._viewModeCtrl.reset(),this.init()},init:function(){var e=this;WS.View3d.prototype.init.call(this),this.mapReady()&&this._promisePositioned&&this._promisePositioned.then(function(){e.initMapEventListeners(),e.onUpdateViewDimensions(),e.updateOverlayPosition()},F.NOP).done()},initCamera:function(){this._camera||(this._camera=new WS.OrthoCamera(void 0,void 0,-Number.MAX_VALUE,Number.MAX_VALUE))},initRenderers:function(){var e,t=this._canvasList;this._renderer.length>0?this._renderer.forEach(function(e){e.clearStorage()}):(this._renderMode=WS.View3d.RenderMode.Canvas,e=t[0].getContext("2d"),this._renderer[0]=new WS.Renderer2D(e,[0,1,2,3,4],this),e=t[1].getContext("2d"),this._renderer[1]=new WS.Renderer2D(e,[5],this),this._renderer[0].setClearColor([0,0,0,0]),this._renderer[1].setClearColor([0,0,0,0]))},initScene:function(){this._renderableMap={},this._scene?(this.unloadObjects(),this._scene.removeAll()):this._scene=new WS.Scene,this.loadObjects()},initHandlers:function(){if(!this._modeToHandlerStack){var e=this._modeToHandlerStack={};e[WS.ViewBase.Mode.Move]=[new WS.PickObjectHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.PickPoint]=[new WS.PickPointHandler(this._camera,this)],e[WS.ViewBase.Mode.PickPolygon]=[new WS.PickPointsHandler(this._camera,this)],e[WS.ViewBase.Mode.SelectObject]=[new WS.PickObjectHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.SelectObjects]=[new WS.PickObjectHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.SelectObjectsRectAdd]=[new WS.SelectRegionHandler(this._camera,this._scene,this,this._selectionRenderable,!0)],e[WS.ViewBase.Mode.SelectObjectsRectSub]=[new WS.SelectRegionHandler(this._camera,this._scene,this,this._selectionRenderable,!1)],e[WS.ViewBase.Mode.PickAll]=[new WS.PickAllHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.PickPointOpenScans]=[new WS.PickObjectHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.Move][0].addListener(new WS.PickObjectListener(this,WS.PickObjectListener.SelectionMode.None,this._selection,this._alert)),e[WS.ViewBase.Mode.PickPoint][0].addListener(new WS.PickPointListener(this)),e[WS.ViewBase.Mode.PickPolygon][0].addListener(new WS.PickPointListener(this)),e[WS.ViewBase.Mode.SelectObject][0].addListener(new WS.PickObjectListener(this,WS.PickObjectListener.SelectionMode.Single,this._selection,this._alert));var t=new WS.PickObjectListener(this,WS.PickObjectListener.SelectionMode.Multi,this._selection,this._alert);e[WS.ViewBase.Mode.SelectObjects][0].addListener(t),e[WS.ViewBase.Mode.SelectObjectsRectAdd][0].addListener(t),e[WS.ViewBase.Mode.SelectObjectsRectSub][0].addListener(t),e[WS.ViewBase.Mode.PickAll][0].addListener(new WS.PickAllListener(this,this._selection,this._alert,this._point3d)),e[WS.ViewBase.Mode.PickPointOpenScans][0].addListener(new WS.PickObjectListener(this,WS.PickObjectListener.SelectionMode.Menu,this._selection,this._alert)),this.setMode(WS.OverviewMap.defaultMode)}},dispatchScanClick:function(e,t){if(this._activeHandlerStack){var i=t.getTranslationGlobal(),n=this.globalToLatLng(i),o=this.latLngToContainerPoint(n);this._activeHandlerStack[0].informListener(e,[t,o.x,o.y])}},setMode:function(e){this._mode!==e&&e!==WS.ViewBase.Mode.PickAll&&F.async(this.hideRadialMenu,this);var t=this.isAllowedToSelectScan();if(WS.View3d.prototype.setMode.call(this,e),this._allowedToSelectScan=this.isAllowedToSelectScan(),this._allowedToSelectScan!==t)for(var i in this._markerMap)this.updateMarkerIcon(this._markerMap[i]);(e===WS.ViewBase.Mode.SelectObjectsRectAdd||e===WS.ViewBase.Mode.SelectObjectsRectSub)&&this._selectionRenderable.setAppearance(e===WS.ViewBase.Mode.SelectObjectsRectAdd)},render:function(){this._width>0&&this._height>0&&this._renderer.forEach(F.proxy(function(e){e.drawScene(this._camera,this._scene)},this));var e=this._renderer[this._renderer.length-1];this._selectionRenderable.draw2d(e,function(){return!0},!1)},addRenderable:function(e,t,i,n){WS.View3d.prototype.addRenderable.call(this,e,t,i,n);var o,r=this._settingService._settings;if(e.instanceOf(WS.ScanMapRenderable)){e.setHideLabelBySetting(!r._showScanLabelsInMap);var a=e._dataObject,s=a._UUID;if(!this._markerMap[s]){var c=this.globalToLatLng(a.getTranslationGlobal());this.addMarker(a,c)}o=this._markerMap[s],e.setMarker(o)}else e.instanceOf(WS.OrthoBox3dRenderable)?e.setShowBox(r._showOrthoVolumes):e instanceof WS.PolylineAnnotationRenderable&&e.setShowPolyline(r._showPolylines);this.updateAddedRenderable(e,r._iconMode),o&&o.setVisible(!0)},onUpdateViewDimensions:function(){if(this.isOverlayVisible()&&this._map&&this._promisePositioned&&Q.isFulfilled(this._promisePositioned)){this.invalidateSize();var e=this._map.getSize();if(WS.View3d.prototype.onUpdateViewDimensions.call(this,e.x,e.y)){this.updateOverlayPosition();var t=e.x>630?WS.MapScale.DefaultSize:e.x>540?110:40,i=this.$scope;return i.scale.width!==t&&i.$apply(function(){i.scale.width=t}),!0}}return!1},createOverlayCanvas:function(e,t){var i=document.createElement("canvas");return i.className=WS.OverviewMap.OVERLAY_CANVAS_CLASS,i.width=e,i.height=t,i},initOverlayDOM:function(){var e=this._targetDomElement,t=$(e).width(),i=$(e).height(),n=$(this._map.getPanes().markerPane),o=document.createElement("div");o.className="ws_mapCanvasOverlayContainer",this._canvasList.forEach(function(e){e.width=t,e.height=i,o.appendChild(e)}),n.after(o),this._overlayContainer=o},initMapEventListeners:function(){var e=this._map;e.on("movestart",F.proxy(this.onMapMoveStart,this)),e.on("moveend",F.proxy(this.onMapMoveEnd,this)),e.on("zoomstart",F.proxy(this.onMapZoomStart,this))},overlayHideTemp:function(){this._overlayContainer.style.display="none",this._overlayTempHidden=!0,this.stopRendering()},overlayUnhideTemp:function(){this._overlayContainer.style.display="block",this._overlayTempHidden=!1,this.isOverlayVisible()&&this.startRendering()},isOverlayVisible:function(){return this._visible&&!this._overlayTempHidden},onMapMoveStart:function(){this.stopRendering(),F.async(this.hideRadialMenu,this)},onMapMoveEnd:function(){if(this.updateOverlayPosition(),this.isOverlayVisible()&&this.startRendering(),this.isContainerVisible()){if("highlight"===this._fsm._state){var e=this._fsm._meta.focus;this.isViewpointApprox(e)||this._fsm.read("move")}this.updateURL(!0)}},isViewpointApprox:function(e){var t=this._map.getZoom();if(t!==e.zoom)return!1;var i=1/this._map.options.crs.scale(t),n=WS.OverviewMap.VIEWPOINT_EPS_PX*i,o=this._map.getCenter();return Math.abs(o.lat-e.lat)<=n&&Math.abs(o.lng-e.lng)<=n},onMapZoomStart:function(){this.overlayHideTemp(),F.async(this.hideRadialMenu,this)},updateCamera:function(){var e=this._map.getBounds();this._camera.setLeftRightBottomTop(e.getWest(),e.getEast(),e.getSouth(),e.getNorth())},compensateLayerTranslation:function(){var e=this.containerPointToLayerPoint(L.point(0,0));L.DomUtil.setPosition(this._overlayContainer,e)},updateOverlayPosition:function(){this.compensateLayerTranslation(),this.updateCamera()},focusInternal:function(e){var t,i;if(e instanceof Array)t=this.globalToLatLng(e),i=this._commonMetadata._maxLevel-1,this.setView(t,i);else if(e instanceof WS.Transformation){var n=this._settingService._settings;if(e instanceof WS.Measurement||e instanceof WS.Orthophoto||e instanceof WS.Annotation&&e.isPolyline()&&n._showPolylines){var o=e instanceof WS.Orthophoto?e.getImageCornersGlobal():e._pointsGlobal,r=o.map(F.proxy(this.globalToLatLng,this)),a=L.latLngBounds(r);this.fitBounds(a),t=this._map.getCenter(),i=this._map.getZoom()}else{var s=e.getTranslationGlobal();t=this.globalToLatLng(s);var c=this._map.getZoom();i=this._page.$scope.visible&&"number"==typeof c?c:this._commonMetadata._maxLevel-1,this.setView(t,i)}this._fsm._meta.focus={object:e,lat:t.lat,lng:t.lng,zoom:i},this.highlight(e)}},focusOn:function(e,t){if("map"===t){var i=void 0!==e.miniView?e.miniView:this.miniView()||!1,n=this.getPageBox();n&&n.isCollecting()&&this.changePage({miniView:i}),i||this.trigger("launchTask",["default","overviewmap"]);var o=e.object,r=e.lookAt,a=this._commonMetadata?Math.max(this._commonMetadata._maxLevel-1,this._commonMetadata._minLevel):"focusOn",s=o?{object:o,history:!0}:{x:r[0],y:r[1],zoom:a,history:!0};switch(this._fsm._state){case"free":case"highlight":this.focusInternal(o||r),this._fsm.read(o?"focusobject":"move"),this.updateURL();break;case"void":this._fsm._meta.pending=s,this._visible&&this.loadProjectInitViewpoint();break;case"loading":this._fsm._meta.pending=s}}},pickScan:function(e){e&&this.trigger("showObjects",[[e]])},loadObjects:function(){if(this.mapReady()){var e=this;this._scanService.getAll().then(function(t){e._scanColorizer.addObjects(t),e.addObjects(t),t.forEach(function(e){e.hideScanPoints()}),e._dScans.resolve(t)},function(t){e.handleError(t)}).done();var t=[this._tempmeasurement,this._annotation,this._measurement,this._orthophoto,this._tempOrthophoto];t.forEach(function(t){t.getAll().then(function(t){e.addObjects(t)},function(t){e._alert.errorObj(t)}).done()})}},loadObject:function(e,t){return F.DI().getService(t).getByID(e,void 0,!0)},unloadObjects:function(){var e=this;["scan","annotation","measurement","orthophoto","temporthophoto","tempmeasurement"].forEach(function(t){F.clearArray(e._objects[t].entities)})},objectFilter:function(e){return e instanceof WS.Point3d||e instanceof WS.Scan||e instanceof WS.Annotation||e instanceof WS.Measurement&&e._type===WS.Measurement.Type.Map||e instanceof WS.Orthophoto},addObjects:function(e){var t=!1;if(this.mapReady()){var i=this._markerClusterGroup;i&&WS.MapMarker.bulkBegin(i);for(var n=0,o=e.length;o>n;n++){var r=e[n];if(r instanceof WS.ProjectCRUDObject){var a=2===this.addObject(r);t=t||a&&r instanceof WS.Scan}else r instanceof WS.Point3d&&(this.addObject(r),this.flashPickerCoords(),this.$scope.$apply(function(e){e.pickedPoint=r}))}if(i&&WS.MapMarker.bulkEnd(i),t){var s=this._settingService._settings;this.updateSettingsInternal(s)}}},removeObjects:function(e){var t=[],i=this._markerClusterGroup;i&&WS.MapMarker.bulkBegin(i);for(var n=0;n<e.length;n++){var o=e[n];o instanceof WS.ProjectCRUDObject?WS.View3d.prototype.removeObject.call(this,o):o instanceof WS.Point3d&&(WS.View3d.prototype.removeObject.call(this,o),this.$scope.$apply(function(e){e.pickedPoint=void 0,e.flashPicker=!1})),o instanceof WS.Scan&&(t.push(o.getID()),this.removeMarker(o.getID()))}i&&WS.MapMarker.bulkEnd(i),t.length>0&&this._layers.scanTiles&&(this._layers.scanTiles.removeFromAllScanLists(t),this._layers.scanTiles.redraw())},updateObjects:function(e){for(var t=!1,i=0,n=e.length;n>i;i++){var o=e[i];if(o)if(o instanceof WS.Scan){var r=this._markerMap[o.getID()];r&&(r.setTitle(o._displayName),WS.View3d.prototype.updateObject.call(this,o))}else o instanceof WS.Layer&&o._viewType===this._type?o._id===WS.Layer.LayerIDs.SCANS?this.setScansVisible(o._visible):o._id===WS.Layer.LayerIDs.VIEW_CAM&&this.setCamVisible(o._visible):o instanceof WS.MapObject?this.updateLayerOrder(o):o instanceof WS.MapLayer?this.updateLayer(o):o instanceof WS.ProjectCRUDObject?WS.View3d.prototype.updateObject.call(this,o):o instanceof WS.Point3d&&(WS.View3d.prototype.updateObject.call(this,o),this.flashPickerCoords(),t=!0)}t&&this.$scope.$apply()},select:function(e){for(var t=0,i=e.length;i>t;t++){var n=e[t];n instanceof WS.Scan&&this.updateMarkerIconForScan(n),n.instanceOf(WS.ProjectCRUDObject)&&WS.View3d.prototype.select.call(this,[n])
}},unselect:function(e){for(var t=0,i=e.length;i>t;t++){var n=e[t];n instanceof WS.Scan&&this.updateMarkerIconForScan(n),n.instanceOf(WS.ProjectCRUDObject)&&WS.View3d.prototype.unselect.call(this,[n])}},isAllowedToSelectScan:function(){switch(this._mode){case WS.ViewBase.Mode.SelectObject:case WS.ViewBase.Mode.SelectObjects:case WS.ViewBase.Mode.SelectObjectsRectAdd:case WS.ViewBase.Mode.SelectObjectsRectSub:return this._allowedSelections&&this._allowedSelections.indexOf("scan")>=0;default:return!1}},highlight:function(e){e instanceof WS.ProjectCRUDObject&&WS.View3d.prototype.highlight.call(this,e),e instanceof WS.Scan&&(this.updateMarkerIconForScan(e),this._layers.scanTiles&&F.async(function(){this._layers.scanTiles.setScanList("menu",[e._UUID])},this))},unhighlight:function(e){e&&(e instanceof WS.ProjectCRUDObject&&WS.View3d.prototype.unhighlight.call(this,e),e instanceof WS.Scan&&(this.updateMarkerIconForScan(e),this._layers.scanTiles&&F.async(function(){this._layers.scanTiles.removeFromScanList("menu",[e._UUID]),this._layers.scanTiles.removeFromScanList("mouseover",[e._UUID])},this)))},setPickedPoints:function(e,t,i,n,o,r,a){var s=this;this.removeLineEnd(),this.removeLines();var c=e.some(function(e){return e._takenInView!==s});if(0!==e.length&&!c&&this._scene){var l=e.map(function(e){return e._estimatedPosition});this.createLine(l,i,n,o,r,a),t&&this.createLineEnd(l,n,o)}},flashPickerCoords:function(){var e=this.$scope,t=this._point3d.getPoint();e.flashPicker=!1,t&&t._pointState!==WS.Point3d.PointState.Unknown&&setTimeout(function(){e.$apply(e.flashPicker=!0)},50)},showObjects:function(e,t){if("map"===t&&e.length){var i=e[0];this._projectService.isCurrent(i)||this._projectService.changeProject(i);var n=this.getPageBox();n&&n.isCollecting()&&this.changePage(),this.trigger("launchTask",["default","overviewmap"]),delete this._fsm._meta.pending,this._visible?this.loadProjectInitViewpoint():(this._fsm.read("reset"),this.destroyMap()),this._url.collect(),this._promisePositioned.fin(F.proxy(this._url.commit,this._url)),this._frustumPoly.setLatLngs([]),this._camPosCircle.setStyle({opacity:0,fillOpacity:0})}},changeProjectSync:function(){this._projectService.getCurrent();delete this._fsm._meta.pending,this._fsm.read("reset"),this.destroyMap(),this._frustumPoly.setLatLngs([]),this._camPosCircle.setStyle({opacity:0,fillOpacity:0})},loadProjectInitViewpoint:function(){var e=this;return this._viewModeCtrl?(this._fsm.read("startload"),void this._projectService.getCurrentProject().then(function(t){e.initMap(t),e._promiseScans.then(function(){if(e._fsm._meta.pending){var t=e._fsm._meta.pending.history;e.applyViewpoint().then(function(i){e._fsm.read("loaddone"),i&&e._fsm.read("focusobject"),t&&e.updateURL(),e._dPositioned.resolve(!0)})}else e.zoomFit(),e._fsm.read("loaddone"),e.updateURL(),e._dPositioned.resolve(!0)})},function(t){e.handleError(t)})):void this._viewModeCtrlD.promise.then(this.loadProjectInitViewpoint.bind(this))},login:function(){if(this._projectService.hasCurrent())switch(this._fsm._state){case"void":case"free":case"highlight":this.$scope.$apply("error=undefined"),this._fsm.read("reset"),this.destroyMap(),this._visible&&this.loadProjectInitViewpoint()}},logout:function(){this._fsm.read("reset"),this.destroyMap()},updateAccount:function(){this._fsm._meta.pending&&this.login()},onShow:function(){switch(this._visible=!0,WS.MapLeaflet.prototype.onShow.call(this),this.startRendering(),this._fsm._state){case"void":this._projectService.hasCurrent()&&this.loadProjectInitViewpoint();break;case"free":case"highlight":this._fsm._meta.pending&&this.applyViewpoint()}this._layers.scanTiles&&(this._layers.scanTiles.enableLoadingTiles(!0),this._layers.scanTiles.redraw()),this._logoLoaded||(this._logoLoaded=!0,this.initLogo())},preparePageChange:function(e){var t=e.state,i=F.PageBox.Action;return this.$scope.pvMiniView=!!t.pv.miniView,!this.miniView()||!t.pv.visible||t.om.visible||e.action!==i.SelectPage&&e.action!==i.SelectPageClass&&e.action!==i.ConfigurePage&&e.action!==i.ChangeRequest?void 0:(t.om.visible=!0,t.om.miniView=!0,!0)},onHide:function(){this._visible=!1,WS.MapLeaflet.prototype.onHide.call(this),this.stopRendering(),F.async(this.hideRadialMenu,this),this._layers.scanTiles&&(this._layers.scanTiles.abortAllPendingTiles(),this._layers.scanTiles.enableLoadingTiles(!1))},setMiniView:function(e,t){var i=this;return Q.try(function(){return i._logoCtrl.setVisible(!e),e||t!==F.PageBox.MiniViewTransition.Main?void 0:i.trigger("launchTask",["default","overviewmap",void 0,void 0,{noNavigation:!0}])}).then(WS.MapLeaflet.prototype.setMiniView.bind(this,e,t))},onConfigure:function(e){if(!e||!e.noReconfigure){var t=WS.ViewBase.Mode.PickAll;this._allowedSelections="annotation,scan,measurement,tempmeasurement,orthophoto",this._changeScanAllowed=!0,e&&(void 0!==e.changeScanAllowed&&(this._changeScanAllowed=e.changeScanAllowed),e.mode?t=e.mode:e.selection&&(t=WS.ViewBase.Mode.SelectObjects),e.selection&&(this._allowedSelections=e.selection)),this.setMode(t)}},updateURL:function(e){var t;switch(this._fsm._state){case"free":var i=this._url.getFragment(this._id),n=i&&this._url.decode(i);if(n&&n.x&&n.y&&n.zoom){var o={lat:parseFloat(n.y),lng:parseFloat(n.x),zoom:parseFloat(n.zoom)};if(this.isViewpointApprox(o))return}var r=this._map.getCenter(),a=this._map.getZoom();t={x:r.lng.toFixed(3),y:r.lat.toFixed(3),zoom:a},this._url.setFragment(this._id,this._url.encode(t),["p"],e);break;case"highlight":var s=this._fsm._meta.focus.object;t={t:(s.instanceOf(WS.TempMeasurement)?"temp":"")+s._class.toLowerCase(),o:s._UUID.toLowerCase()},this._url.setFragment(this._id,this._url.encode(t),["p"],e)}},setFragment:function(e){e.isUnresolved(this._id)&&e.resolve(this._id,e.get(this._id).query,["p"])},applyURL:function(e,t){var i=this;if(e===this._id){var n=t.get(this._id),o=this._url.decode(n.query);!this._projectService.hasCurrent()||this.$scope.project&&this._projectService.isCurrentProject(this.$scope.project)||(this._fsm.read("reset"),this.destroyMap()),this._visible?(this._fsm._meta.pending=o,this._map?this.applyViewpoint().then(function(e){e&&i._fsm.read("focusobject")}):this.loadProjectInitViewpoint()):this._fsm._meta.pending=o}},applyViewpoint:function(){var e=this,t=this._fsm._meta.pending,i=Q.defer();if(delete this._fsm._meta.pending,t.auto)this.zoomFit(),i.resolve(!1);else if(t.x&&t.y){var n;n=t.zoom?"focusOn"===t.zoom?Math.max(this._commonMetadata._maxLevel-1,this._commonMetadata._minLevel):parseInt(t.zoom):Math.floor(.5*(this._commonMetadata._minLevel+this._commonMetadata._maxLevel)),this.setView(L.latLng(parseFloat(t.y),parseFloat(t.x)),n),i.resolve(!1)}else t.object?(this.focusInternal(t.object),i.resolve(!0)):t.o&&t.t&&this.loadObject(t.o,t.t).then(function(t){e.focusInternal(t),i.resolve(!0)},function(n){e.handleError(n),e._fsm._meta.pending=t,i.reject(n)}).done();return i.promise},updateScanColors:function(){this._scene&&this._scene.traverse(new WS.ScanColorVisitor),this._layers.scanTiles&&this._layers.scanTiles.redraw()},showScanPoints:function(e){this.updateMarkerIconForScan(e),this._layers.scanTiles&&this._layers.scanTiles.addToScanList("selection",[e._UUID])},hideScanPoints:function(e){this.updateMarkerIconForScan(e),this._layers.scanTiles&&this._layers.scanTiles.removeFromScanList("selection",[e._UUID])},handleError:function(e){this._dPositioned.reject(),this._dScans.reject(),this.destroyMap(),this._fsm.read("reset"),F.handled(e),this.$scope.$apply(function(t){t.error=e})},destroyMap:function(){Q.isPending(this._promisePositioned)||(this._dPositioned=Q.defer(),this._promisePositioned=this._dPositioned.promise),this._dScans=Q.defer(),this._promiseScans=this._dScans.promise,WS.MapLeaflet.prototype.initMap.call(this),this.$scope.error=void 0,this.reset(),$(this._canvasList).detach();var e=this._targetDomElement.parentElement;$(this._targetDomElement).replaceWith('<div class="f_centeredContainer overviewmapdiv" style="z-index: 0;"></div>'),this._targetDomElement=$(e).find(".overviewmapdiv")[0],this._map&&(this._map.remove(),this._map=void 0),this.unloadObjects(),this._layers={}},initMap:function(e){var t=this;this.destroyMap(),e&&(this._viewModeCtrl.update(),this._mapObjectService.getAll().then(function(i){if(t._mapObject=i[0],!t._mapObject)throw new Error("EM_RESOURCE_NOT_FOUND");t._mapObject._exportVersion<3?t._mapService.getMapMetadata(e._name).then(function(i){t._mapMetadata=i,t._commonMetadata=t._mapMetadata,t.initMapPart2(e)}):(t._commonMetadata=t._mapObject,t._mapLayerService.getAll().then(function(i){for(var n=0,o=i.length;o>n;++n)t._mapLayersByObjUuid[i[n]._objectUUID]=i[n];t.initMapPart2(e)}))}).fail(function(e){t.handleError(e)}))},initMapPart2:function(e){var t=this._commonMetadata._backgroundColor;!t||255===t[0]&&255===t[1]&&255===t[2]||$(this._targetDomElement).css("background-color","rgb("+t[0]+","+t[1]+","+t[2]+")"),this.$scope.project=e,this.prepareMap(),this._mapObject._hasMapLayers?this.initMapLayers():this.initWorkspaceLayer(),this.initLayoutLayers(),this.initScanLayers()},prepareMap:function(){var e=this;this._frustumPoly=L.polygon(this._frustumPoly.getLatLngs(),{weight:1,opacity:.8,clickable:!1}),this._camPosCircle=L.circleMarker(this._camPosCircle.getLatLng(),{weight:1.5,opacity:this._camPosCircle.options.opacity,fillOpacity:this._camPosCircle.options.fillOpacity,fillColor:"#fab502",radius:4,clickable:!1}),this._frustumLayer=L.layerGroup([this._frustumPoly,this._camPosCircle]),this._map=L.map(this._targetDomElement,{maxZoom:this._commonMetadata._maxLevel+WS.OverviewMap.ADDITIONAL_ZOOM_LEVELS,zoomControl:!1,doubleClickZoom:!1,scrollWheelZom:!0,touchZoom:!0,trackResize:!0,layers:[],attributionControl:!1,crs:this._commonMetadata.getLeafletCRS()}),this._fadeByDefault=this._map.options.fadeAnimation,this._map.on("layeradd",function(t){var i=t.layer;if(e.turnOffFading(i),i instanceof L.Marker&&!(i instanceof L.MarkerCluster)){var n=e.getRenderable(i._wsObject);n&&n.setHideLabelByCluster(!1)}}),this._map.on("layerremove",function(t){var i=t.layer;if(e.turnOnFading(i),i instanceof L.Marker&&!(i instanceof L.MarkerCluster)){var n=e.getRenderable(i._wsObject);n&&n.setHideLabelByCluster(!0)}}),this._layer.isLayerVisible(WS.Layer.LayerIDs.VIEW_CAM,WS.Layer.ViewTypes.OVERVIEW_MAP)&&this._frustumLayer.addTo(this._map),this._markerSelectionGroup=L.layerGroup([]),this._map.addLayer(this._markerSelectionGroup),this.createClusterGroup(),this.setScansVisible(this._layer.isLayerVisible(WS.Layer.LayerIDs.SCANS,WS.Layer.ViewTypes.OVERVIEW_MAP)),this.setCamVisible(this._layer.isLayerVisible(WS.Layer.LayerIDs.VIEW_CAM,WS.Layer.ViewTypes.OVERVIEW_MAP)),this._map.addControl(this._logoCtrl),this.initOverlayDOM(),this.init()},createClusterGroup:function(e){e=void 0===e?!0:e;var t=this;this._markerClusterGroup=e?new L.MarkerClusterGroup({disableClusteringAtZoom:this._commonMetadata._maxLevel,maxClusterRadius:this._settingService._settings._showScanLabelsInMap?WS.OverviewMap.CLUSTER_DIST_WITH_LABELS:WS.OverviewMap.CLUSTER_DIST_NO_LABELS,iconCreateFunction:function(e){var i=e.getAllChildMarkers(),n=i.map(function(e){return e._wsObject._UUID}),o=t._scanColorizer.getClusterColor(n),r="rgba("+o.r+", "+o.g+", "+o.b+", 0.45)",a='style="border-color: '+r+"; background-color: "+r+';"',s=L.divIcon({html:'<div class="ws_cluster" '+a+"><span>"+e.getChildCount()+"</span></div>",className:"marker-cluster",iconSize:new L.Point(40,40)});return s}}):void 0,this._markerClusterGroup&&(this._map.addLayer(this._markerClusterGroup),this._markerClusterGroup.on("clustermouseover",function(){return function(e){var i=e.layer.getAllChildMarkers();if(t._layers.scanTiles&&i.length<=WS.OverviewMap.MAX_CLUSTER_SIZE_MOUSEOVER){var n=i.map(function(e){return e._wsObject._UUID});t._layers.scanTiles.setScanList("mouseover",n)}}}()),this._markerClusterGroup.on("clustermouseout",function(){return function(){t._layers.scanTiles&&t._layers.scanTiles.setScanList("mouseover",[])}}()),this._markerClusterGroup.on("animationend",function(){return function(){t.overlayUnhideTemp()}}()))},turnOffFading:function(e){if(e instanceof WS.WSTilesLayer){this._numTileLayers++;var t=F.isMobile()?2:4;t<this._numTileLayers&&(this._map.options.fadeAnimation=!1,L.DomUtil.removeClass(this._map._container,"leaflet-fade-anim"))}},turnOnFading:function(e){if(e instanceof WS.WSTilesLayer){if(this._numTileLayers--,!this._fadeByDefault)return;var t=F.isMobile()?2:4;this._numTileLayers<=t&&(this._map.options.fadeAnimation=!0,L.DomUtil.addClass(this._map._container,"leaflet-fade-anim"))}},initMapLayers:function(){if(this._mapObject._hasMapLayers){var e=this,t=this.getProjectId();this._mapService.getMapLayersMetadata(t).then(function(i){if(e._map&&e.getProjectId()===t)for(var n in i._layers){var o=i._layers[n];e.initMapLayer(o)}},function(t){e._alert.errorObj(t)})}},initLayoutLayers:function(){if(this._commonMetadata._hasLayoutLayers){var e=this,t=this.getProjectId();this._mapService.getLayoutLayersMetadata(t).then(function(i){if(e._map&&e.getProjectId()===t){var n=0;for(var o in i._layers){var r=i._layers[o];e.initLayoutLayer(r,n),n++}}},function(t){e._alert.errorObj(t)})}},initScanLayers:function(){if(this._commonMetadata._hasScanLayers){var e=this,t=this.getProjectId();this._mapService.getScanLayersMetadata(t).then(function(i){e._map&&e.getProjectId()===t&&e.initScanTilesLayer(i)},function(t){"EM_RESOURCE_NOT_FOUND"===t.message?e._alert.tip("FE_MAP_MISSING_SCAN_LAYERS",1e4):e._alert.errorObj(t)})}},initMapLayer:function(e){if(e._tiles){var t,i,n=this.getProjectId(),o=e._objectUuid;WS._2GO?t="ws2go-data/project/"+n+"/map/map-layers/"+o+"/tiles/{z}/{x}/{y}.png":(t="/data/project/"+n+"/layer-tile/"+o+"/{z}/{x}/{y}",this._CDN.hasCDN()&&(i=n+"/map/map-layers/"+o+"/tiles/{z}/{x}/{y}.png")),this.createLayer(e,o,n,t,i)}},initLayoutLayer:function(e,t){if(!e._tiles)return void 0;var i,n,o=this.getProjectId(),r=e._layoutUuid;WS._2GO?i="ws2go-data/project/"+o+"/map/layout-layers/"+r+"/tiles/{z}/{x}/{y}.png":(i="/data/project/"+o+"/layout-tile/"+r+"/{z}/{x}/{y}",this._CDN.hasCDN()&&(n=o+"/map/layout-layers/"+r+"/tiles/{z}/{x}/{y}.png")),this.createLayer(e,r,o,i,n,t)},initWorkspaceLayer:function(){var e=this.getProjectId(),t=this,i=this._mapMetadata&&4<=this._mapMetadata._exportVersion||3<=this._mapObject._exportVersion;i?this._mapService.getTilesSimpleMetadata(e).then(function(i){t.initWorkspaceLayerPart2(e,i)},function(i){t._alert.errorObj(i),t.initWorkspaceLayerPart2(e)}):this.initWorkspaceLayerPart2(e)},initWorkspaceLayerPart2:function(e,t){if(this._map&&this.getProjectId()===e){var i,n,o=t&&2<=t._exportVersion?t._objectUuid:void 0;WS._2GO?i="ws2go-data/project/"+e+"/map/tiles/{z}/{x}/{y}.png":(i="/data/project/"+e+"/tile/{z}/{x}/{y}",this._CDN.hasCDN()&&(n=e+"/map/tiles/{z}/{x}/{y}.png")),this.createLayer(t,o,e,i,n)}},initScanTilesLayer:function(e){this._layers.scanTiles=new WS.ScanTilesLayer(this._commonMetadata,this._objects.scan.entities,e,this._scanColorizer,this._CDN,this.getProjectId()),this._layers.scanTiles.addTo(this._map);var t=[];this._objects.scan.entities.forEach(function(e){e._scanPointsShown&&t.push(e._UUID)}),this._layers.scanTiles.setScanList("selection",t)},createLayer:function(e,t,i,n,o,r){var a,s,c,l,h,d,u=t?this._mapLayersByObjUuid[t]:void 0;u?(a=u._type===WS.MapLayer.Type.WORKSPACE&&"Workspace"===u._displayName?this._locale.translate("FE_SCAN_DATA"):u._displayName,s=WS.ScanTilesLayer.Z_INDEX_START_LAYERS+this._mapObject._layerOrder.length-this._mapObject.getOrderOfLayer(u._UUID,!1),h=u._type,c=u._opacity/100,l=0<u._opacity,d=u._UUID):(e instanceof WS.LayoutTiles?(a=e._layoutName,s=WS.ScanTilesLayer.Z_INDEX_START_LAYERS+r,h=WS.MapLayer.Type.LAYOUT_PLAN):(a=this._locale.translate("FE_SCAN_DATA"),s=WS.ScanTilesLayer.Z_INDEX_MAP,h=WS.MapLayer.Type.WORKSPACE),c=1,l=!0);var p=e?e._tiles:void 0,_=new WS.WSTilesLayer(p,this._CDN,i,n,o,{minZoom:this._commonMetadata._minLevel,maxZoom:this._commonMetadata._maxLevel+WS.OverviewMap.ADDITIONAL_ZOOM_LEVELS,maxNativeZoom:this._commonMetadata._maxLevel,zoomOffset:0,noWrap:!0,continuousWorld:!0,opacity:c,zIndex:s,visible:l,displayName:a,type:h,opacityIsInitial:!0,uuid:d});_.options.visible&&_.addTo(this._map),this.$scope.leafletLayers.push(_),this.$scope.leafletLayers.sort(function(e,t){return t.options.zIndex-e.options.zIndex}),this.$scope.$apply()},updateLayerOrder:function(e){if(e._project===this.getProjectId()&&this._mapObject._layerOrder){for(var t=WS.ScanTilesLayer.Z_INDEX_START_LAYERS+this._mapObject._layerOrder.length,i=0,n=this.$scope.leafletLayers.length;n>i;++i){var o=this.$scope.leafletLayers[i],r=t-this._mapObject.getOrderOfLayer(o.options.uuid,!1);o.setZIndex(r)}this.$scope.leafletLayers.sort(function(e,t){return t.options.zIndex-e.options.zIndex})}},updateLayer:function(e){if(e._project===this.getProjectId())for(var t=0,i=this.$scope.leafletLayers.length;i>t;++t){var n=this.$scope.leafletLayers[t];if(n.options.uuid===e._UUID){n.setOpacity(e._opacity/100);var o=0<e._opacity;return o!==n.options.visible&&(o?n.addTo(this._map):this._map.removeLayer(n),n.options.visible=o),void(n.options.displayName=e._displayName)}}},mapReady:function(){return this.$scope.project&&this._map},getProjectId:function(){return this.$scope.project?this.$scope.project._name:void 0},fitBounds:function(e,t,i){this._commonMetadata&&(i=i||{},i.maxZoom=this._commonMetadata._maxLevel),WS.MapLeaflet.prototype.fitBounds.call(this,e,t,i)},zoomFit:function(){if(this._objects.scan.entities.length>0)this.fitMarkers();else{this.invalidateSize();var e=this._commonMetadata,t=this.globalToLatLng([e._globalTopLeftX,e._globalBottomRightY,0]),i=this.globalToLatLng([e._globalBottomRightX,e._globalTopLeftY,0]),n=L.latLngBounds(t,i);this.fitBounds(n)}},addMarker:function(e,t){var i=this,n=new WS.MapMarker(e,this._markerClusterGroup,t,{title:e._displayName});this.updateMarkerIcon(n),n.on("click",function(){(i._mode===WS.ViewBase.Mode.SelectObject||i._mode===WS.ViewBase.Mode.SelectObjects||i._mode===WS.ViewBase.Mode.PickAll||i._mode===WS.ViewBase.Mode.PickPointOpenScans)&&i.dispatchScanClick("onDataObjectClick",e)}),n.on("dblclick",function(){return function(){i.dispatchScanClick("onDataObjectDblClick",e)}}()),n.on("mouseover",function(){return function(){i._layers.scanTiles&&i._layers.scanTiles.setScanList("mouseover",[e._UUID])}}()),n.on("mouseout",function(){return function(){i._layers.scanTiles&&i._layers.scanTiles.setScanList("mouseover",[])}}()),WS.MapLeaflet.prototype.addMarker.call(this,e._UUID,n)},updateMarkerIconForScan:function(e){var t=this._markerMap[e._UUID];t&&this.updateMarkerIcon(t)},updateMarkerIcon:function(e){var t=e?e.getObject():void 0;if(t instanceof WS.Scan){var i=t._UUID===this._panoviewScanId,n=this._hlObject===t,o=i||n||t._scanPointsShown||t._selected||this._allowedToSelectScan,r=o?this._markerSelectionGroup:this._markerClusterGroup;e.setParent(r);var a=this.getRenderable(t);a&&this.updateViewingMode(a)}},updateViewingMode:function(e){var t=e._dataObject;e.setViewingMode(t&&t._selected?WS.Renderable.ViewingMode.Selected:t&&this._hlObject===t?WS.Renderable.ViewingMode.Highlighted:e instanceof WS.ScanMapRenderable&&t&&t._UUID===this._panoviewScanId?WS.Renderable.ViewingMode.Displayed:WS.Renderable.ViewingMode.Normal)},setLayerVisible:function(e,t){e&&(t&&!this._map.hasLayer(e)?this._map.addLayer(e):!t&&this._map.hasLayer(e)&&this._map.removeLayer(e))},setCamVisible:function(e){this.setLayerVisible(this._frustumLayer,e)},setScansVisible:function(e){this.setLayerVisible(this._markerClusterGroup,e),this.setLayerVisible(this._markerSelectionGroup,e);var t=this._layers.scanTiles;if(t){var i=[];e&&this._objects.scan.entities.forEach(function(e){e._scanPointsShown&&i.push(e._UUID)}),t.setScanList("selection",i)}},globalToLatLng:function(e){return L.latLng(e[1],e[0])},setPanoScan:function(e){var t=e instanceof WS.Scan?e._UUID:e._sourceUUIDs[0],i=this._markerMap[this._panoviewScanId],n=this._markerMap[t];this._panoviewScanId=t,i&&this.updateMarkerIcon(i),n&&this.updateMarkerIcon(n),this._frustumPoly.setLatLngs([]),this._camPosCircle.setStyle({opacity:0,fillOpacity:0})},clearPanoScan:function(){var e=this._markerMap[this._panoviewScanId];this._panoviewScanId=void 0,e&&this.updateMarkerIcon(e),this._frustumPoly.setLatLngs([]),this._camPosCircle.setStyle({opacity:0,fillOpacity:0})},sceneRootChange:function(e,t){var i=this;t instanceof WS.PanoramaView&&(e instanceof WS.Scan||e instanceof WS.PointCloud&&"Scan"===e._type?this.setPanoScan(e):this.clearPanoScan(),this._viewModeCtrlD.promise.then(function(){i._viewModeCtrl.currentRoot(e)}))},onCameraChange:function(e,t){if(e&&e.instanceOf&&e.instanceOf(WS.PerspectiveCameraObject)&&t&&t.instanceOf&&t.instanceOf(WS.PanoramaView)){var i=e.getAxisGlobal(),n=e.getRightGlobal(),o=WS.OverviewMap.FRUSTUM_SIZE,r=e._fovY/180*Math.PI,a=o*Math.tan(.5*r),s=a*e._aspectRatio;vec3.scale(i,-o),vec3.scale(n,-s);var c=e.getGlobalPosition(),l=c,h=vec3.create();vec3.add(c,i,h),vec3.add(h,n,h);var d=vec3.create();vec3.add(c,i,d),vec3.subtract(d,n,d);var u=[l,h,d].map(F.proxy(this.globalToLatLng,this));this._frustumPoly.setLatLngs(u),this._camPosCircle.setLatLng(u[0]),this._camPosCircle.setStyle({opacity:1,fillOpacity:1})}}},WS.extend("OverviewMap","MapLeaflet"),WS.OverviewMap.type=WS.Layer.ViewTypes.OVERVIEW_MAP,WS.OverviewMap.defaultMode=WS.ViewBase.Mode.PickAll,WS.OverviewMap.MAX_CLUSTER_SIZE_MOUSEOVER=5,WS.OverviewMap.FRUSTUM_SIZE=5,WS.OverviewMap.TIMEOUT_SET_ICON=10,WS.OverviewMap.OVERLAY_CANVAS_CLASS="ws_mapOverlayCanvas",WS.OverviewMap.ADDITIONAL_ZOOM_LEVELS=4,WS.OverviewMap.CLUSTER_DIST_WITH_LABELS=90,WS.OverviewMap.CLUSTER_DIST_NO_LABELS=50,WS.OverviewMap.VIEWPOINT_EPS_PX=25,WS.OverviewMap.FSM={"void":{startload:"loading",reset:"void"},loading:{loaddone:"free",focusobject:"highlight",reset:"void"},free:{move:"free",focusobject:"highlight",reset:"void"},highlight:{move:"free",focusobject:"highlight",reset:"void"}},WS.OverviewMap.ViewMode={MAP:"map"},WS.OverviewMapSettingService=function(e,t){F.PlugModule.call(this,e),this._cookie=t,this._cookieId="overviewmap",this._settings=new WS.OverviewMapSettings(WS.OverviewMapSettings.COLORIZE_SCAN_TILES,WS.OverviewMapSettings.COLORIZE_BY_HEIGHT,WS.OverviewMapSettings.COLORIZE_BY_AVG_AGE,WS.OverviewMapSettings.COLORIZE_TILE_BACKGROUND,1,WS.OverviewMapSettings.AGG_AVG,WS.OverviewMapSettings.IconModes.Category,!0,!1,!0,this),this.getFromLocalStorage(this._settings),this.provideMalePlug("SettingsUpdate",["updateSettings"])},WS.OverviewMapSettingService.prototype={getNew:function(e,t,i,n,o,r,a,s){return new WS.OverviewMapSettings(e,t,i,n,o,r,a,s,this)},getAll:function(){var e=this._settings.clone(),t=Q.defer();return t.resolve([e]),t.promise},getByPrimaryKey:function(){var e=this._settings.clone(),t=Q.defer();return t.resolve(e),t.promise},update:function(e){var t=Q.defer();e.applyUpdate();var i=e.clone();return this._settings=i,this._settings.writeToLocalStorage(),t.resolve(),this.trigger("updateSettings",["overviewmap",e]),t.promise},writeToLocalStorage:function(e){var t={scanOrBaseTiles:e._scanOrBaseTiles,scanTilesColorizeBy:e._scanTilesColorizeBy,baseTilesColorizeBy:e._baseTilesColorizeBy,baseTilesColorizeWhat:e._baseTilesColorizeWhat,colorPaletteIdx:e._colorPaletteIdx,aggregation:e._aggregation,iconMode:e._iconMode,showScanLabelsInMap:e._showScanLabelsInMap,showOrthoVolumes:e._showOrthoVolumes,showPolylines:e._showPolylines};this._cookie.setLocalStorageItem(this._cookieId,JSON.stringify(t))},getFromLocalStorage:function(e){var t=JSON.parse(this._cookie.getLocalStorageItem(this._cookieId));t&&(e._scanOrBaseTiles=t.scanOrBaseTiles,e._scanTilesColorizeBy=t.scanTilesColorizeBy,e._baseTilesColorizeBy=t.baseTilesColorizeBy,e._baseTilesColorizeWhat=t.baseTilesColorizeWhat,e._colorPaletteIdx=t.colorPaletteIdx,e._aggregation=t.aggregation,e._iconMode=t.iconMode,"boolean"==typeof t.showScanLabelsInMap&&(e._showScanLabelsInMap=t.showScanLabelsInMap),"boolean"==typeof t.showOrthoVolumes&&(e._showOrthoVolumes=t.showOrthoVolumes),"boolean"==typeof t.showPolylines&&(e._showPolylines=t.showPolylines))},scanTilesColorizeBy:function(){return this._settings._scanTilesColorizeBy},getColorGradient:function(){return this._settings._colorGradient},getAggregation:function(){return this._settings._aggregation}},WS.extend("OverviewMapSettingService","PlugModule"),WS.MapMetadata=function(){this._backgroundColor=void 0,this._class=void 0,this._exportVersion=void 0,this._geoReferenced=void 0,this._globalBottomRightX=void 0,this._globalBottomRightY=void 0,this._globalTopLeftX=void 0,this._globalTopLeftY=void 0,this._hasLayoutLayers=void 0,this._hasScanLayers=void 0,this._heightInMeters=void 0,this._layoutLayersMaxLevel=void 0,this._layoutLayersMinLevel=void 0,this._maxLevel=void 0,this._maxScanElevation=void 0,this._minLevel=void 0,this._minScanElevation=void 0,this._pixelsPerMeterMax=void 0,this._scanLayersMaxLevel=void 0,this._scanLayersMinLevel=void 0,this._tileBottomRightX=void 0,this._tileBottomRightY=void 0,this._tileSizeInMeters=void 0,this._tileTopLeftX=void 0,this._tileTopLeftY=void 0,this._widthInMeters=void 0,this._numMapLevels=void 0,this._pixelsPerMeterMin=void 0},WS.MapMetadata.prototype={readJson:function(e){this._backgroundColor=e.BackgroundColor,this._class=e.Class,this._exportVersion=e.ExportVersion,this._geoReferenced=e.GeoReferenced,this._globalBottomRightX=e.GlobalBottomRightX,this._globalBottomRightY=e.GlobalBottomRightY,this._globalTopLeftX=e.GlobalTopLeftX,this._globalTopLeftY=e.GlobalTopLeftY,this._hasScanLayers=e.HasScanLayers,this._heightInMeters=e.HeightInMeters,this._maxLevel=e.MaxLevel,this._minLevel=e.MinLevel,this._pixelsPerMeterMax=e.PixelsPerMeter,this._scanLayersMaxLevel=e.ScanLayersMaxLevel,this._scanLayersMinLevel=e.ScanLayersMinLevel,this._tileBottomRightX=e.TileBottomRightX,this._tileBottomRightY=e.TileBottomRightY,this._tileSizeInMeters=e.TileSizeInMeters,this._tileTopLeftX=e.TileTopLeftX,this._tileTopLeftY=e.TileTopLeftY,this._widthInMeters=e.WidthInMeters,this._hasLayoutLayers=e.HasLayoutLayers,this._layoutLayersMaxLevel=e.LayoutLayersMaxLevel,this._layoutLayersMinLevel=e.LayoutLayersMinLevel,this._maxScanElevation=e.MaxScanElevation,this._minScanElevation=e.MinScanElevation,this._numMapLevels=this._maxLevel-this._minLevel+1,this._pixelsPerMeterMin=this._pixelsPerMeterMax/Math.pow(2,this._numMapLevels-1)},getLeafletCRS:function(){return WS.MapObject.getLeafletCRS(this)}},WS.extend("MapMetadata"),WS.ScanTiles=function(){this._class=void 0,this._exportVersion=void 0,this._scan=void 0,this._tiles=void 0,this._scanName=void 0,this._metadataUuid=void 0},WS.ScanTiles.prototype={readJson:function(e){this._class=e.Class,this._exportVersion=e.ExportVersion,this._scan=e.Scan,this._tiles=e.Tiles,this._scanName=e.ScanName,this._metadataUuid=e.MetadataUUID}},WS.extend("ScanTiles"),WS.MapTilesSimple=function(){this._class=void 0,this._exportVersion=void 0,this._tiles=void 0,this._objectUuid=void 0,this._metadataUuid=void 0},WS.MapTilesSimple.prototype={readJson:function(e){this._class=e.Class,this._exportVersion=e.ExportVersion,this._tiles=e.Tiles,this._metadataUuid=e.MetadataUUID,this._objectUuid=e.ObjectUUID}},WS.extend("MapTilesSimple"),WS.LayoutTiles=function(){this._class=void 0,this._exportVersion=void 0,this._layoutUuid=void 0,this._layoutName=void 0,this._tiles=void 0,this._metadataUuid=void 0},WS.LayoutTiles.prototype={readJson:function(e){this._class=e.Class,this._exportVersion=e.ExportVersion,this._layoutUuid=e.LayoutUuid,this._layoutName=e.LayoutName,this._tiles=e.Tiles,this._metadataUuid=e.MetadataUUID}},WS.extend("LayoutTiles"),WS.MapLayerTiles=function(){this._class=void 0,this._exportVersion=void 0,this._metadataUuid=void 0,this._objectUuid=void 0,this._tiles=void 0},WS.MapLayerTiles.prototype={readJson:function(e){this._class=e.Class,this._exportVersion=e.ExportVersion,this._metadataUuid=e.MetadataUUID,this._objectUuid=e.ObjectUUID,this._tiles=e.Tiles}},WS.extend("MapLayerTiles"),WS.ScanLayers=function(){this._class=void 0,this._exportVersion=void 0,this._layers=void 0},WS.ScanLayers.prototype={readJson:function(e){this._class=e.Class,this._exportVersion=e.ExportVersion,this._layers={};var t=e.Layers;for(var i in t)t.hasOwnProperty(i)&&(this._layers[i]=new WS.ScanTiles,this._layers[i].readJson(t[i]))}},WS.extend("ScanLayers"),WS.LayoutLayers=function(){this._class=void 0,this._exportVersion=void 0,this._layers=void 0},WS.LayoutLayers.prototype={readJson:function(e){this._class=e.Class,this._exportVersion=e.ExportVersion,this._layers={};var t=e.Layers;for(var i in t)t.hasOwnProperty(i)&&(this._layers[i]=new WS.LayoutTiles,this._layers[i].readJson(t[i]))}},WS.extend("LayoutLayers"),WS.MapLayers=function(){this._class=void 0,this._exportVersion=void 0,this._layers=void 0},WS.MapLayers.prototype={readJson:function(e){this._class=e.Class,this._exportVersion=e.ExportVersion,this._layers={};var t=e.Layers;for(var i in t)t.hasOwnProperty(i)&&(this._layers[i]=new WS.MapLayerTiles,this._layers[i].readJson(t[i]))}},WS.extend("MapLayers"),WS.OverviewMapService=function(e,t,i){WS.PlugModule.call(this,e),this._error=t,this._resource=i,this._restClientMapData=this._resource(WS._2GO?"ws2go-data/project/:project/map/metadata.json":"/data/project/:project/map-data",{},{read:{method:"GET",params:{}}}),this._restClientTileSimpleData=this._resource(WS._2GO?"ws2go-data/project/:project/map/tiles-simple.json":"/data/project/:project/tile-simple-data",{},{read:{method:"GET",params:{}}}),this._restClientScanLayerData=this._resource(WS._2GO?"ws2go-data/project/:project/map/scan-layers/scan-layers.json":"/data/project/:project/scan-layer-data",{},{read:{method:"GET",params:{}}}),this._restClientLayoutLayerData=this._resource(WS._2GO?"ws2go-data/project/:project/map/layout-layers/layout-layers.json":"/data/project/:project/layout-layer-data",{},{read:{method:"GET",params:{}}}),this._restClientMapLayerData=this._resource(WS._2GO?"ws2go-data/project/:project/map/map-layers/map-layers.json":"/data/project/:project/map-layer-data",{},{read:{method:"GET",params:{}}})},WS.OverviewMapService.prototype={getMapMetadata:function(e){var t=Q.defer();return this._restClientMapData.read({project:e},function(e){var i=new WS.MapMetadata;i.readJson(e),t.resolve(i)},this._error.restHandler(t)),t.promise},getTilesSimpleMetadata:function(e){var t=Q.defer();return this._restClientTileSimpleData.read({project:e},function(e){var i=new WS.MapTilesSimple;i.readJson(e),t.resolve(i)},this._error.restHandler(t)),t.promise},getScanLayersMetadata:function(e){var t=Q.defer();return this._restClientScanLayerData.read({project:e},function(e){var i=new WS.ScanLayers;i.readJson(e),t.resolve(i)},this._error.restHandler(t)),t.promise},getLayoutLayersMetadata:function(e){var t=Q.defer();return this._restClientLayoutLayerData.read({project:e},function(e){var i=new WS.LayoutLayers;i.readJson(e),t.resolve(i)},this._error.restHandler(t)),t.promise},getMapLayersMetadata:function(e){var t=Q.defer();return this._restClientMapLayerData.read({project:e},function(e){var i=new WS.MapLayers;i.readJson(e),t.resolve(i)},this._error.restHandler(t)),t.promise}},WS.extend("OverviewMapService","PlugModule"),WS.MapLayerService=function(e,t,i,n,o,r,a,s,c){F.ProjectCRUDService.call(this,"MapLayer",WS.MapLayer,"/maplayer",{},e,t,i,n,o,r,a,s,c)},WS.MapLayerService.prototype={getNew:function(){var e=F.CRUDService.prototype.getNew.call(this);return e._project=this._project.hasCurrent()?this._project.getCurrent():void 0,e},handleSingleEntity:function(e){e._ancestors=[]},handleEntityChanges:function(e,t,i){var n=function(e){e._ancestors=[]};return e.forEach(n),t.forEach(n),F.CRUDService.prototype.handleEntityChanges.bind(this,e,t,i)}},WS.extend("MapLayerService","ProjectCRUDService"),WS.MapObjectService=function(e,t,i,n,o,r,a,s,c){F.ProjectCRUDService.call(this,"Map",WS.MapObject,"/map",{},e,t,i,n,o,r,a,s,c)},WS.MapObjectService.prototype={getNew:function(){var e=F.CRUDService.prototype.getNew.call(this);return e._project=this._project.hasCurrent()?this._project.getCurrent():void 0,e
},handleSingleEntity:function(e){e._ancestors=[]},handleEntityChanges:function(e,t,i){var n=function(e){e._ancestors=[]};return e.forEach(n),t.forEach(n),F.CRUDService.prototype.handleEntityChanges.bind(this,e,t,i)}},WS.extend("MapObjectService","ProjectCRUDService"),WS.WorldMap=function(e,t,i,n,o,r,a,s){WS.MapLeaflet.call(this,e,i,n,o,a),this._project=r,this._login=s,this._projectSelector=void 0,this._fitMarkersMargin=.5,this._minZoom=0,this._maxZoom=19,this._urlTerrainLayer="https://{s}.tiles.mapbox.com/v3/websharecloud.i0ffdl62/{z}/{x}/{y}.png",this._tileSubdomains="abcd",this._attributionShort="<a href='https://www.mapbox.com/about/maps/' target='_blank' title='About Mapbox'>&copy; Mapbox &copy; OpenStreetMap</a>",this._datePeriodFilter=t("dateperiod"),this._dateFilter=t("date")},WS.WorldMap.prototype={zoomFit:function(){var e=this.getMarkerArray();1===e.length?(this.invalidateSize(),this.setView(e[0].getLatLng(),7)):e.length>1&&this.fitMarkers()},setProjectSelector:function(e){this._projectSelector=e},openproject:function(e){this._projectSelector.pickProject(e)},showdetails:function(e){this._projectSelector.openProjectDetails(e)},addMarker:function(e,t){var i=this,n=e._latitude,o=e._longitude,r=new WS.MapMarker(e,this._map,[n,o],{title:e.getID()});return r.setWorldIcon(),r.setVisible(!0),r.getMarker().bindPopup(t,{closeButton:!0}),r.on("dblclick",function(){var t=e;return function(){i.openproject(t)}}()),WS.MapLeaflet.prototype.addMarker.call(i,e.getID(),r),r},addMarkerCluster:function(){var e=this,t=new L.MarkerClusterGroup({disableClusteringAtZoom:!1,maxClusterRadius:50});this._map.addLayer(t),this._login.isProjectManager().then(function(i){var n=e._project.getAllWithStates(i?["Completed","Draft","Published"]:["Completed","Published"]);n.then(function(i){for(var n=i.length,o=0;n>o;o++){var r=i[o],a=r._latitude,s=r._longitude,c=new WS.MapMarker(r,t,[a,s]);c.setWorldIcon(),c.setVisible(!0),c.on("dblclick",function(){return function(){e.openproject(r)}}()),e.addMarkerPopup(c,r),WS.MapLeaflet.prototype.addMarker.call(e,r.getID(),c)}e.zoomFit(),e._map.on("popupopen",function(t){e.setPopupContent(t.popup)})}).done()}).done()},addMarkerPopup:function(e,t){var i=document.createElement("div");e.getMarker().bindPopup(i,{closeButton:!0,ws_project:t})},setPopupContent:function(e){var t=this,i=e.options.ws_project,n=function(){t.openproject(i)},o=function(){t.showdetails(i)},r=document.createElement("div");r.innerHTML='<p class="f_textML f_textBold"></p><table class="f_textSM">    <tr> <td class="f_textBold" style="padding-right:10px; max-width: 160px;"></td> <td></td></tr>    <tr> <td class="f_textBold" style="padding-right:10px"></td> <td></td></tr>    <tr> <td class="f_textBold" style="padding-right:10px"></td> <td><a target="_blank"></a></td></tr></table><table style="width:100%; margin-top:15px">    <tr>        <td>            <div class="projectImageWrapperSmall"                 style="vertical-align:middle;  background-image:url('+i.getImage()+')">            </div>        </td>        <td style="vertical-align:top; text-align:right">            <div class="btn-group">               <button class="btn btn-default" ng-click="openProjectDetails(featured)" title="Details">                  <img class="f_icon24" src="'+WS.imgUrl("icons/im/details.png")+'">               </button>               <button class="btn btn-warning" ng-click="pickProject(featured)" title="Load">                  <img class="f_icon24" src="'+WS.imgUrl("icons/im/open.png")+'">               </button>            </div>        </td>    </tr></table>',$(r).attr("style","min-width:240px;"),$(r.getElementsByTagName("p")[0]).text(i._displayName);var a=r.getElementsByTagName("table")[0],s=a.getElementsByTagName("tr")[0];if(i._type===WS.Project.Type.WSC){$(s.getElementsByTagName("td")[0]).text(t._locale.translate("FE_NO_OF_SCANS")+":"),$(s.getElementsByTagName("td")[1]).text(i._numberOfScans);var c=a.getElementsByTagName("tr")[1];$(c.getElementsByTagName("td")[0]).text(t._locale.translate("FE_REC_PERIOND_PRPJ")+":");var l=this._datePeriodFilter([i._oldestScanRecordingTime,i._newestScanRecordingTime],!0);$(c.getElementsByTagName("td")[1]).html(l)}else{$(s.getElementsByTagName("td")[0]).text(t._locale.translate("FE_PROJECT_CREATION_TIME")+":");var h=this._dateFilter(i._creationDate,!0);$(s.getElementsByTagName("td")[1]).html(h)}var d=a.getElementsByTagName("tr")[2];$(d.getElementsByTagName("td")[0]).text(t._locale.translate("FE_LOCATION")+":");var u=d.getElementsByTagName("td")[1].getElementsByTagName("a")[0];$(u).text(i._latitude+", "+i._longitude),$(u).attr("title",t._locale.translate("FE_OPEN_GMAPS")),$(u).attr("href","https://www.google.com/maps/place//"+i._latitude+","+i._longitude+"/@"+i._latitude+","+i._longitude+",15z");var p=r.getElementsByTagName("table")[1].getElementsByTagName("tr")[0],_=p.getElementsByTagName("td")[1].getElementsByTagName("button")[1];$(_).attr("title",t._locale.translate("FE_LOAD_PROJECT")),$(_).click(n);var g=p.getElementsByTagName("td")[1].getElementsByTagName("button")[0];$(g).attr("title",t._locale.translate("FE_DETAILS")),$(g).click(o),e.setContent(r)},prepareMap:function(){var e=L.tileLayer(this._urlTerrainLayer,{subdomains:this._tileSubdomains,attribution:this._attributionShort,minZoom:this._minZoom,maxZoom:this._maxZoom}),t=[e],i={minZoom:this._minZoom,maxZoom:this._maxZoom,zoomControl:!0,doubleClickZoom:!1,scrollWheelZoom:!1,touchZoom:!0,trackResize:!0,layers:t};F.isIE()&&F.ieVersion()<11&&(i.fadeAnimation=!1,i.zoomAnimation=!1,i.markerZoomAnimation=!1);var n=this._map=L.map(this._targetDomElement,i);this._map.on("focus",function(){n.scrollWheelZoom.enable()}),this._map.on("blur",function(){n.scrollWheelZoom.disable()}),L.control.scale().addTo(this._map),this.addViewAllControl({tooltip:"FE_VIEW_ALL"})}},WS.extend("WorldMap","MapLeaflet"),angular.module("ws.map",[]),F.DI().config("@task","@alert","@project","@pointcloud","@panosettings",function(e,t,i,n,o){this.registerParameter("ommenu",{evaluate:{edit:function(t){return!t._writeLock&&!t._temporary&&("Annotation"===t._class||"Measurement"===t._class||"Scan"===t._class||"Orthophoto"===t._class)&&e.taskExists("default","overviewmap","edit")},remove:function(t){return!t._writeLock&&("Annotation"===t._class||"Measurement"===t._class||"Orthophoto"===t._class)&&e.taskExists("default","overviewmap","remove")},showproperties:function(e){return"Annotation"===e._class||"Measurement"===e._class||"Scan"===e._class||"Orthophoto"===e._class},panorama:function(e){return i.canShowObjectInPano(e)},view3d:function(e){return o.isWebGlEnabled()?n.canShowObjectIn3d(e):!1},switchsegments:function(e){return"Measurement"===e._class&&"Distance"===e._displayType},share:function(t){return!t._writeLock&&!t._temporary&&("Annotation"===t._class||"Measurement"===t._class||"Scan"===t._class||"Orthophoto"===t._class)&&e.taskExists("default","overviewmap","share")},showscanpoints:function(e){return"Scan"===e._class&&!!window.om._layers.scanTiles},showdistancelabels:function(e){return"Measurement"===e._class&&"Area"===e._displayType}},options:{showscanpoints:function(e){return{checkbox:{show:e._scanPointsShown,checked:!0,x:-1,y:1},title:e._scanPointsShown?"FE_HIDE_SCAN_COLORIZATION":"FE_SHOW_SCAN_COLORIZATION"}},showdistancelabels:function(e){var t=window.om.getRenderable(e);return{checkbox:{show:t&&t.isShowingDistanceLabels(),checked:!0,x:-1,y:1},title:t&&t.isShowingDistanceLabels()?"FE_HIDE_DISTANCE_LABELS":"FE_SHOW_DISTANCE_LABELS"}}},execute:{edit:function(e){e.select(),window.om.trigger("launchTask",["default","overviewmap","edit"])},remove:function(e){return e.remove()},showproperties:function(e){window.om.trigger("showObjects",[[e],"properties"])},panorama:function(e){switch(e._class){case"Scan":window.pv.trigger("showObjects",[[e],"panorama"]);break;case"Annotation":case"Measurement":case"Orthophoto":window.pv.trigger("focusOn",[{object:e},"panorama"])}},view3d:function(e){switch(e._class){case"Scan":window.pv.trigger("showObjects",[[e],"3d"]);break;case"Annotation":case"Measurement":case"Orthophoto":window.pv.trigger("focusOn",[{object:e},"3d"])}},switchsegments:function(e){var t=window.om.getRenderable(e);t&&t.switchSegmentMode()},share:function(e){e.select(),window.om.trigger("launchTask",["default","overviewmap","share"])},unhighlight:function(e){window.om.unhighlight(e)},showscanpoints:function(e){e._scanPointsShown?e.hideScanPoints():e.showScanPoints()},showdistancelabels:function(e){var t=window.om.getRenderable(e);t&&t.switchSegmentMode()}},error:function(e){t.errorObj(e)}})}),F.DI().registerController("overviewmap",WS.OverviewMap,"@plug","@locale","@unit","@selection","@layer","@project","@scan","@overviewmapservice","@overviewmapsettings","@login","@alert","@mapobject","@maplayer","@url","@domainsettings","@scancolorizer","@annotation","@measurement","@tempmeasurement","@orthophoto","@temporthophoto","@point3d","@projectdatacdn"),F.DI().registerController("worldmap",WS.WorldMap,"$filter","@plug","@locale","@unit","@project","@url","@login"),F.DI().registerController("mapscale",WS.MapScale,"@plug","@overviewmapsettings","@unit","@scancolorizer"),F.DI().registerService("overviewmapservice",WS.OverviewMapService,"@plug","@error","$resource"),F.DI().registerService("overviewmapsettings",WS.OverviewMapSettingService,"@plug","@cookie"),F.DI().registerService("mapobject",WS.MapObjectService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),F.DI().registerService("maplayer",WS.MapLayerService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),F.DI().registerService("scancolorizer",WS.ScanColorizer,"@plug","@overviewmapsettings","@unit","@scan"),F.DI().config("@serializer","@mapobject",function(e,t){e.registerClass("Map",function(){return t.getNew()})}),F.DI().config("@serializer","@maplayer",function(e,t){e.registerClass("MapLayer",function(){return t.getNew()})}),F.DI().config("@task",WS.overviewConfigTask=function(e){e.registerTaskFactory("default","settings","editoverviewmapsettings",WS.EditOverviewMapSettingsTask,"@plug","@locale")}),angular.module("ws.map").directive("overviewmap",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("overviewmap"),link:function(e,t){var i=e.ctrl,n=t.find(".overviewmapdiv")[0];i.setContainerDiv(n),e.$on("ws_connect",function(e,t){e.stopPropagation(),i.setViewModeCtrl(t)}),i.init()},templateUrl:WS.partialUrl("overviewmap.html")})}),angular.module("ws.map").directive("mapscale",function(){return WS.PlugController.createDirective({link:function(e){e.drawGradient(),e.$watch("width",function(){e.drawGradient()})},controllerClass:F.DI().getController("mapscale"),restrict:"E",scope:{width:"="},transclude:!0,template:'<div class="ws_mapScale"><span class="hidden-xs hidden-sm">{{titleAggFunc | i18n}} {{titleAggBy | i18n}}:&nbsp;&nbsp;</span><span>{{min}} </span><canvas id="mapScaleCanvas" style="vertical-align:bottom;" width="{{width}}" height="14"></canvas><span> {{max}}</span></div>'})}),angular.module("ws.component").directive("wsworldmap",function(){var e='<div class="worldmapdiv" style="position: relative;" tabindex="0"></div>';return WS.PlugController.createDirective({controllerClass:F.DI().getController("worldmap"),scope:{display:"="},restrict:"E",require:"?^projectselector",link:function(t,i,n,o){if(o&&o.$scope){var r=o.$scope,a=t.ctrl,s=i.find(".worldmapdiv");s.replaceWith(e),s=i.find(".worldmapdiv"),r.setWorldmap(a),a.setProjectSelector(r),a.setContainerDiv(s[0]),F.async(function(){a.prepareMap(),a.addMarkerCluster()})}},template:'<a name="worldMap"></a><div class="f_box mapBox">'+e+"</div>"})}),angular.module("ws.component").directive("wsworldmapdetail",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("worldmap"),scope:{display:"=",getProject:"&"},restrict:"E",require:"?^projectdetails",link:function(e,t,i,n){if(n&&n.$scope){var o=e.ctrl;F.async(function(){var i=t.find("#detailmapdiv");o.setContainerDiv(i[0]),o.prepareMap(),e.$watch("getProject()",function(e){e&&Q.isPromise(e)&&e.then(function(e){o.getMarkerArray().forEach(function(e){o.removeMarker(e)});var t=document.createElement("div");t.innerHTML='<p class="f_textM f_textBold"></p>',$(t.getElementsByTagName("p")[0]).text(e._displayName);var i=o.addMarker(e,t);i&&(i.getMarker().openPopup(),o.zoomFit())})}),e.$apply()},this)}},template:'<div id="detailmapdiv" tabindex="0"></div>'})}),WS.EditOverviewMapSettingsTask=function(e,t){WS.Task.call(this,e),this._locale=t,this._description=[{caption:"TC_OVERVIEWMAP_SETTINGS",optional:!0,description:"TD_OVERVIEW_SETTINGS",selectPageClass:"overviewmapsettings",female:"ObjectEdit",pinBinding:"editObject(input.data)",widget:'<p ng-show="anyUnsavedChanges()"><b>{{"TD_CHANGES"|i18n}}:</b></p><ul><li ng-show="input.data.settings._changes._aggregation != input.data.settings._aggregation || input.data.settings._changes._scanTilesColorizeBy != input.data.settings._scanTilesColorizeBy">{{ formatColorizationChanges(input.data.settings._changes._aggregation, input.data.settings._changes._scanTilesColorizeBy) }}</li><li ng-show="input.data.settings._changes._iconMode != input.data.settings._iconMode">{{formatIconMode(input.data.settings._changes._iconMode)}}</li></li><li ng-show="input.data.settings._changes._showScanLabelsInMap !== input.data.settings._showScanLabelsInMap">{{ formatShowScanLabels(input.data.settings._changes._showScanLabelsInMap)}}</li><li ng-show="input.data.settings._changes._showPolylines !== input.data.settings._showPolylines">{{"FE_ANNOTATION" | i18n}} {{ formatShowPolylines(input.data.settings._changes._showPolylines)}}</li><li ng-show="input.data.settings._changes._showOrthoVolumes !== input.data.settings._showOrthoVolumes">{{"FE_ORTHOPHOTO" | i18n}} {{ formatShowOrthoVolumes(input.data.settings._changes._showOrthoVolumes)}}</li><li ng-repeat="layer in input.data.layers" ng-show="layer.hasUnsavedChanges()">{{layer.getName() | i18n}}<ul><li ng-show="layer._changes._visible != layer._visible">{{formatLayerVisibilityOutput(layer._changes._visible)}}</li></ul></li></ul>',icon:WS.Icons.TaskSection.configure}]},WS.EditOverviewMapSettingsTask.prototype={setup:function(e){var t=this;e.anyUnsavedChanges=function(){var t=e.input?e.input.data:void 0,i=t?t.layers:void 0,n=t?t.settings:void 0;if(i)for(var o=0,r=i.length;r>o;o++)if(i[o].hasUnsavedChanges())return!0;return n&&n.hasUnsavedChanges()?!0:!1},e.formatColorizationChanges=function(e,i){if(void 0===e&&void 0===i)return"";var n="";switch(i+" "+e){case WS.OverviewMapSettings.COLORIZE_BY_HEIGHT+" "+WS.OverviewMapSettings.AGG_AVG:n=t._locale.translate("FE_COLOR_HEIGHT_AVG");break;case WS.OverviewMapSettings.COLORIZE_BY_HEIGHT+" "+WS.OverviewMapSettings.AGG_MAX:n=t._locale.translate("FE_COLOR_HEIGHT_MAX");break;case WS.OverviewMapSettings.COLORIZE_BY_HEIGHT+" "+WS.OverviewMapSettings.AGG_MIN:n=t._locale.translate("FE_COLOR_HEIGHT_MIN");break;case WS.OverviewMapSettings.COLORIZE_BY_HEIGHT+" "+WS.OverviewMapSettings.AGG_INDIVIDUAL:n=t._locale.translate("FE_COLOR_HEIGHT_INDIV");break;case WS.OverviewMapSettings.COLORIZE_BY_AGE+" "+WS.OverviewMapSettings.AGG_AVG:n=t._locale.translate("FE_COLOR_AGE_AVG");break;case WS.OverviewMapSettings.COLORIZE_BY_AGE+" "+WS.OverviewMapSettings.AGG_MAX:n=t._locale.translate("FE_COLOR_AGE_MAX");break;case WS.OverviewMapSettings.COLORIZE_BY_AGE+" "+WS.OverviewMapSettings.AGG_MIN:n=t._locale.translate("FE_COLOR_AGE_MIN");break;case WS.OverviewMapSettings.COLORIZE_BY_AGE+" "+WS.OverviewMapSettings.AGG_INDIVIDUAL:n=t._locale.translate("FE_COLOR_AGE_INDIV")}return t._locale.translate("FE_SCAN_COLORIZATION")+": "+n},e.formatLayerVisibilityOutput=function(e){return void 0===e?"":t._locale.translate(e?"FE_VISBLE":"FE_INVISBLE")},e.formatIconMode=function(e){return void 0===e?"":t._locale.translateAndCompose("FE_ICONMODE_CHANGE",[t._locale.translate(WS.OverviewMapSettings.IconModeNames[e])])},e.formatShowScanLabels=function(e){if(void 0===e)return"";var i=t._locale.translate("FE_SCAN_NAME"),n=t._locale.translate(e?"FE_ENABLED":"FE_DISABLED");return i+": "+n},e.formatShowOrthoVolumes=function(e){var i=t._locale.translate("FE_VOLUME"),n=t._locale.translate(e?"FE_VISBLE":"FE_INVISBLE");return i+": "+n},e.formatShowPolylines=function(e){var i=t._locale.translate("AN_AREA"),n=t._locale.translate(e?"FE_VISBLE":"FE_INVISBLE");return i+": "+n}},execute:function(e){var t=Q.defer(),i=e?e.data:void 0,n=i?i.layers:void 0,o=i?i.settings:void 0;if(n)for(var r=0,a=n.length;a>r;r++)n[r].update();return o&&(o._changes&&o._changes._iconMode&&(o._changes._iconMode=parseInt(o._changes._iconMode)),o.update()),t.resolve(),t.promise},teardown:function(){this._result._navigateTo=this._argument._lastPage},queryTaskLaunch:function(e,t,i){return e==this._panel&&t==this._category.id&&i==this._id}},WS.extend("EditOverviewMapSettingsTask","Task"),WS.ScannerCircleImageRenderable=function(){var e=new WS.Geometry;e._positionBuffer=WS.ScannerCircleImageRenderable.PositionBuffer,e._primitiveType=WS.Geometry.PrimitiveType.TriangleStrip;var t=WS.ScannerCircleImageRenderable.CoordBuffer,i=new WS.TextureMaterial(WS.ScannerCircleImageRenderable.Image,t);WS.Mesh.call(this,e,i),this.addToLayer(WS.Layer.LayerIDs.PANO)},WS.ScannerCircleImageRenderable.prototype={draw2d:function(){},onViewingModeChange:function(){switch(this._viewingMode){case WS.Renderable.ViewingMode.Selected:this._material.setTextureImages([WS.ScannerCircleImageRenderable.ImageActive]);break;case WS.Renderable.ViewingMode.Inconsiderable:case WS.Renderable.ViewingMode.Normal:case WS.Renderable.ViewingMode.Highlighted:this._material.setTextureImages([WS.ScannerCircleImageRenderable.Image])}}},WS.extend("ScannerCircleImageRenderable","Mesh"),WS.ScannerCircleImageRenderable.Image=new WS.Image(WS.imgUrlCanvasSafe("assets/websharecloud.png")),WS.ScannerCircleImageRenderable.ImageActive=new WS.Image(WS.imgUrlCanvasSafe("assets/websharecloud_active.jpg")),WS.ScannerCircleImageRenderable.PositionBuffer=new WS.ArrayBuffer([-1,-1,-1.5,-1,1,-1.5,1,-1,-1.5,1,1,-1.5],3),WS.ScannerCircleImageRenderable.CoordBuffer=new WS.ArrayBuffer([0,0,0,1,1,0,1,1],2),WS.ViewModeCtrl=function(e,t,i,n){F.PlugController.call(this,e,n),this.$scope=e,this._pointCloud=t,this._panoSettings=i,e.config={menu:!1},e.ViewMode=WS.PanoramaView.ViewMode,e.pointClouds=[],e.viewMode=void 0,e.current=void 0,e.targetViewMode=e.viewMode,e.viewModeTransition=WS.PanoramaView.Transition.NONE,e.isSimple3dEnabled=!1,e.webGLEnabled=i.isWebGlEnabled(),e.hasPano=!1,e.toggle=function(){switch(e.viewMode){case WS.OverviewMap.ViewMode.MAP:e.changeViewMode({newMode:{view:"3d"}});break;case WS.PanoramaView.ViewMode.PANO:e.changeViewMode({newMode:{view:"3d"}});break;case WS.PanoramaView.ViewMode.POINTS:e.hasPano?e.changeViewMode({newMode:{view:"pano"}}):e.config.menu=!0}},e.pick=function(t){e.changeViewMode("pano"===t?{newMode:{view:"pano"}}:{newMode:{view:"3d",pointCloud:t}})},e.hasAlternative=function(){switch(e.viewMode){case WS.OverviewMap.ViewMode.MAP:return e.webGLEnabled&&e.pointClouds.length>0;case WS.PanoramaView.ViewMode.PANO:return e.webGLEnabled&&(e.pointClouds.length>0||e.isSimple3dEnabled);case WS.PanoramaView.ViewMode.POINTS:return e.hasPano||e.pointClouds.length>1}},e.toggleTitle=function(){if(!e.webGLEnabled)return"FE_NEED_WEBGL_FOR_3D";if(e.viewModeTransition)return"EM_3D_LOAD";switch(e.viewMode){case WS.OverviewMap.ViewMode.MAP:return e.pointClouds.length>0?"FE_GO_3D":"EM_3D_NA";case WS.PanoramaView.ViewMode.PANO:return e.pointClouds.length>0?"FE_GO_3D":"EM_3D_NA";case WS.PanoramaView.ViewMode.POINTS:return e.hasPano?"FE_GO_PANO":"EM_PANO_NA"}},e.is3d=function(){return e.viewMode===WS.PanoramaView.ViewMode.POINTS},this.provideFemalePlug("SettingsUpdate",["updateSettings"]),this.connect(this,i)},WS.ViewModeCtrl.prototype={update:function(e){this.currentRoot(e);var t=this;this.reset(),this._pointCloud.getAllEnabledCompleted().then(function(e){t.pointClouds(e)}),this._pointCloud.isSimple3dEnabled().then(function(e){t.simple3dEnabled(e)})},updateSettings:function(){this.$scope.webGLEnabled=this._panoSettings.isWebGlEnabled()},simple3dEnabled:function(e,t){return void 0!==e&&(this.$scope.isSimple3dEnabled=e,t!==!1&&this.$scope.$apply()),this.$scope.isSimple3dEnabled},hasPano:function(e,t){return void 0!==e&&(this.$scope.hasPano=e,t!==!1&&this.$scope.$apply()),this.$scope.hasPano},pointClouds:function(e,t){return void 0!==e&&(this.$scope.pointClouds=e.sort(function(e,t){var i=e._creationTime,n=t._creationTime;return n>i?1:i>n?-1:0}),t!==!1&&this.$scope.$apply()),this.$scope.pointClouds},viewMode:function(e,t){return void 0!==e&&(this.$scope.viewMode=e,t!==!1&&this.$scope.$apply()),this.$scope.viewMode},targetViewMode:function(e,t){return void 0!==e&&(this.$scope.targetViewMode=e,t!==!1&&this.$scope.$apply()),this.$scope.targetViewMode},viewModeTransition:function(e,t){return void 0!==e&&(this.$scope.viewModeTransition=e,t!==!1&&this.$scope.$apply()),this.$scope.viewModeTransition},currentRoot:function(e){return void 0!==e&&(this.$scope.currentRoot=e),this.$scope.currentRoot},reset:function(){this.$scope.pointClouds=[],this.$scope.isSimple3dEnabled=!1},$apply:function(){this.$scope.$apply()}},WS.extend("ViewModeCtrl","PlugController"),WS.PanoramaView=function(e,t,i,n,o,r,a,s,c,l,h,d,u,p,_,g,f,m,v,S,b,y){WS.View3d.call(this,e,t,i);var P=this;window.pv=this,this._type=WS.PanoramaView.type,this._selection=n,this._alert=o,this._project=r,this._scanService=a,this._annotationService=s,this._measurementService=c,this._tempMeasurementService=l,this._orthophoto=h,this._tempOrthophoto=d,this._settingService=u,this._domainSettings=p,this._loginService=_,this._unit=g,this._distance=f,this._locale=m,this._point3dService=v,this._layer=S,this._mapObjectService=b,this._pointCloudService=y,this._cameraAnimator=new WS.CameraAnimator,this._blender=new WS.Blender,this._inScanOrigin=void 0,this._root=void 0,this._promise=void 0,this._promiseTransitionD=void 0,this._promiseCamAnimD=void 0,this._settingsLoaded=!1,this.createScope(e),this._fsm=e.fsm=this.createFiniteStateMachine(),this._scene=new WS.Scene,this._renderObjects=!0,this._panoRenderable=void 0,this._skybox=void 0,this._pointsRenderable=void 0,this._rootRenderable=void 0,this._prevRenderable=void 0,this._prevPanoRenderable=void 0,this._prevScanCloudRenderable=void 0,this._prevPointCloudRenderable=void 0,this._rootIsScanCloud=!1,this._rootIsSameObject=!1,this._linesRenderable=void 0,this._lineAreaEnd=void 0,this._progressSpinner=new WS.SpinnerRenderable("loading",[200,200]),this._bearingVisualizer=new WS.CompassRenderable,this._moveHandler=void 0,this._camera=new WS.PerspectiveCamera,this._prevCameraValuesForUrl={angles:this._camera.getAnglesForCenter(),pos:this.getCamGlobalPos(),fovY:this._camera._fovY},this._cameraIsInitialized=!1,this._replaceURL=void 0,this._isCollecting=!1,this._objects={scan:{service:this._scanService,selection:n.getSelection("Scan"),entities:[]},annotation:{service:this._annotationService,selection:n.getSelection("Annotation"),entities:[]},measurement:{service:this._measurementService,selection:n.getSelection("Measurement"),entities:[]},tempmeasurement:{service:this._tempMeasurementService,selection:n.getSelection("TempMeasurement"),entities:[]},orthophoto:{service:this._orthophoto,selection:n.getSelection("Orthophoto"),entities:[]},temporthophoto:{service:this._tempOrthophoto,entities:[]},point3d:{entities:[]},wspointcloud:{service:this._pointCloudService,entities:[]}},this.provideMalePlug("ObjectShow",["showObjects"]),this.provideMalePlug("ViewFocus",["focusOn"]),this.provideMalePlug("PointPick3D",["pickPoint"]),this.provideMalePlug("SceneRootChange",["sceneRootChange"]),this.provideMalePlug("TaskLaunch",["launchTask"]),this.provideFemalePlug("ViewMode",["setMode"]),this.provideFemalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("ViewFocus",["focusOn"]),this.provideFemalePlug("ObjectUpdate",["updateObjects"]),this.provideFemalePlug("SettingsUpdate",["updateSettings"]),this.provideFemalePlug("CameraChanged",["onCameraChange"]),this.provideFemalePlug("MeasurementSelect",["select","unselect"]),this.provideFemalePlug("TempMeasurementSelect",["select","unselect"]),this.provideFemalePlug("OrthophotoSelect",["select","unselect"]),this.provideFemalePlug("AnnotationSelect",["select","unselect"]),this.provideFemalePlug("ScanSelect",["select","unselect"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.provideFemalePlug("PointPick3DControl",["setPickedPoints"]),[this._annotationService,this._measurementService,this._scanService,this._tempMeasurementService,this._orthophoto,this._tempOrthophoto,this._domainSettings,this._pointCloudService].forEach(function(e){P._connectorService.connect(P,e)}),["Scan","Annotation","Measurement","TempMeasurement","Orthophoto"].forEach(function(e){P._connectorService.connect(P,n.getSelection(e))}),this._connectorService.connect(this,this._point3dService),this._connectorService.connect(this,this._unit),this._connectorService.connect(this,this._locale),this._connectorService.connect(this,this._settingService),this._connectorService.connect(this,this._loginService),r.subscribe("change",this.changeProjectSync.bind(this)),this.loadSettings()},WS.PanoramaView.prototype={createScope:function(e){var t=this;e.root=void 0,e.error=void 0,e.loadStarted=!1,e.getPromise=function(){return t._promise},e.changeViewMode=function(e){"3d"===e.view?e.pointCloud?t.load({root:e.pointCloud,rootType:"pointcloud",camPos:"keep"},"3d"):t.load({root:t._root,rootType:void 0,camPos:"keep"},"3d"):"pano"===e.view&&t.load({closestTo:t.getCamGlobalPos()},"panorama")},e.hasMap=void 0,e.panoImageResolution="",e.panoImagePaths=void 0,e.pickedPoint=void 0,e.pickedDistance=void 0,e.flashPicker=!1,e.pointStates=WS.Point3d.PointState,e.menu={object:void 0,visible:!1,x:"0px",y:"0px"},e.page={actionBarActive:!1,visibilityCtrlActive:!1,select3dCtrlActive:!1,loading:!1},e.joystick={visible:!1,wasVisible:!1,hUpper:0,hLower:0,xButton:0,yButton:0,xTop:0,yTop:0,xUpper:0,yUpper:0,xMiddle:0,yMiddle:0,xLower:0,yLower:0,xBottom:0,yBottom:0},e.settings=void 0,e.logoUrl=void 0,e.logoOpacity=void 0,e.toggleColorMode=function(){if((t.isRootScan()||t.isRootScanCloud())&&t._viewModeCtrl.viewModeTransition()===WS.PanoramaView.Transition.NONE){var e=t.$scope.settings;switch(e._colorMode){case"blend":t._root.arePanoImagesAvailableForMode("color")||t._alert.tip("FE_NO_SUCH_COLORMODE"),e._colorMode="color";break;case"color":t._root.arePanoImagesAvailableForMode("gray")||t._alert.tip("FE_NO_SUCH_COLORMODE"),e._colorMode="gray";break;case"gray":t._root.arePanoImagesAvailableForMode("blend")||t._alert.tip("FE_NO_SUCH_COLORMODE"),e._colorMode="blend"}t._settingService.update(e)}},e.changeBlendFactor=function(e){var i=t.$scope.settings,n=i._blendFactor,o=n+e;o=Math.round(10*o)/10,o.toFixed(1),o>.9?o=.9:.1>o&&(o=.1),i._blendFactor=o,t._settingService.update(i)},e.toggleCompassOnOff=function(){var e=t.$scope.settings;e._showCompass=!e._showCompass,t._settingService.update(e)},e.isRootPointCloud=function(){return t.isRootPointCloud()},e.isRootProjectPointCloud=function(){return t.isRootProjectPointCloud()},e.rootName="",e.scanRecordingTime="1970-01-01 00:00:00",e.project=void 0,e.showMap=function(){var e={lookAt:t.getCamGlobalPos(),miniView:!0};t.trigger("focusOn",[e,"map"])},e.showProperties=function(){t.isRootScanOrScanCloud()?t.trigger("showObjects",[[t._root],"properties"]):t.isRootScanPointCloud()?t._scanService.getByID(t._root._sourceUUIDs[0]).then(function(e){t.trigger("showObjects",[[e],"properties"])}):t.isRootProjectPointCloud()&&t._project.getCurrentProject().then(function(e){t.trigger("showObjects",[[e],"projectdetails"])})},e.getPosInCS=function(i){return e.project&&e.project._trafo&&t._unit.isCustomCS()?mat4.posInRefSystem(i,e.project._trafo):i},e.dbgStats={show:!1}},setViewModeCtrl:function(e){this._viewModeCtrl=e,this._viewModeCtrlD.resolve(e)},createFiniteStateMachine:function(){return new F.FiniteStateMachine({"void":{load:"loading",delay:"pending",reset:"void"},loading:{show:"free",focusobject:"highlight",focusxyz:"xyz",delay:"pending",reset:"void"},pending:{load:"loading",reset:"void"},free:{load:"loading",delay:"pending",reset:"void"},highlight:{load:"loading",delay:"pending",move:"free",reset:"void"},xyz:{load:"loading",move:"free",reset:"void"}},"void")},isCameraInitialized:function(){return this._cameraIsInitialized},createRenderers:function(){var e,t=this._canvasList;if(this._settingService.isWebGlEnabled()){var i=!1,n=F.proxy(function(){i||(i=!0,this.disableWebGL())},this);e=F.getGLContext(t[0]),this._renderer[0]=new WS.Renderer3D(e,[0,1,2,3],this,n),this._renderer[0].updateDetailLevel(this._settingService.details3d()),e=t[2].getContext("2d"),this._renderer[1]=new WS.Renderer2D(e,[4],this),this._renderer[0].setClearColor([0,0,0,0]),this._renderer[1].setClearColor([0,0,0,0]),this._renderMode=WS.View3d.RenderMode.WebGl}else e=t[0].getContext("2d"),this._renderer[0]=new WS.Renderer2D(e,[0,1],this),e=t[1].getContext("2d"),this._renderer[1]=new WS.Renderer2D(e,[2,3],this),e=t[2].getContext("2d"),this._renderer[2]=new WS.Renderer2D(e,[4],this),this._renderer[0].setClearColor([1,1,1,1]),this._renderer[1].setClearColor([0,0,0,0]),this._renderer[2].setClearColor([0,0,0,0]),this._renderMode=WS.View3d.RenderMode.Canvas},getGLExtension:function(e){var t=this._renderer[0]._ctx;return!!F.getGLExtension(t,e)},init:function(){},changeProjectSync:function(){var e=this,t=this.$scope;this.reset(),this._viewModeCtrlD.promise.then(function(){e.getViewTrafo(),e._project.getCurrentProject().then(function(i){t.project=i,e._viewModeCtrl.hasPano(i.hasScan()),t.hasMap=i.hasOverviewMap()},function(){t.project=void 0,t.hasMap=!1})})},reset:function(){this.deactivateHandlerStack(),this.unloadPreviousRenderables(),this.unloadRootRenderable(),this.unloadAndRemoveSkybox(),this.removeAllObjects(),this.resetRenderers(),this.resetScope(),this.resetMembers(),this._fsm.read("reset"),this._fsm._meta.rollback="reset",this.trigger("sceneRootChange",[void 0,this])},unloadPreviousRenderables:function(){this._prevScanCloudRenderable&&(this.deactivateSpecialRenderable(this._prevScanCloudRenderable),this.unloadSpecialRenderable(this._prevScanCloudRenderable)),this._prevPointCloudRenderable&&(this.deactivateSpecialRenderable(this._prevPointCloudRenderable),this.unloadSpecialRenderable(this._prevPointCloudRenderable)),this._prevPanoRenderable&&(this.deactivateSpecialRenderable(this._prevPanoRenderable),this.unloadSpecialRenderable(this._prevPanoRenderable))},unloadRootRenderable:function(){this._rootRenderable&&(this.deactivateSpecialRenderable(this._rootRenderable),this.unloadSpecialRenderable(this._rootRenderable))},unloadAndRemoveSkybox:function(){this._skybox&&(this.deactivateSpecialRenderable(this._skybox),this.unloadSpecialRenderable(this._skybox),this.removeRenderable(this._skybox,this._skybox._UUID))},resetRenderers:function(){this._renderer&&this._renderer.forEach(function(e){e.clearStorage()})},resetScope:function(){var e=this.$scope;e.root=void 0,e.error=void 0,e.loadStarted=!1,e.panoImagePaths=void 0,e.panoImageResolution="",e.pickedPoint=void 0,e.pickedDistance=void 0,e.menu.object=void 0,e.menu.visible=!1,e.menu.x="0px",e.menu.y="0px",e.page.actionBarActive=!1,e.page.visibilityCtrlActive=!1,e.page.select3dCtrlActive=!1,e.page.loading=!1,e.joystick.visible=!1,e.hasMap=void 0,e.rootName="",e.scanRecordingTime="1970-01-01 00:00:00";var t=this._viewModeCtrl;t&&(t.reset(),t.viewModeTransition(WS.PanoramaView.Transition.NONE,!1),t.viewMode(WS.PanoramaView.ViewMode.PANO,!1),t.targetViewMode(t.viewMode(),!1),t.hasPano(!1,!1),F.async(t.$apply,t)),F.async(e.$apply,e)},resetMembers:function(){this._mode=void 0,this._modeToHandlerStack=void 0,this._activeHandlerStack=void 0,this._renderableMap={},this._width=void 0,this._height=void 0,this._cameraIdleCount=0,this._isMoving=0,this._trafoView=void 0,this._init=!1,this._render=!1,this._isRendering=!1,this._hlObject=void 0,this._cameraAnimator.reset(),this._blender.reset(),this._inScanOrigin=void 0,this._root=void 0,this._promise=void 0,this._promiseTransitionD=void 0,this._promiseCamAnimD=void 0,this._settingsLoaded=!1,this._panoRenderable=void 0,this._skybox=void 0,this._pointsRenderable=void 0,this._rootRenderable=void 0,this._prevRenderable=void 0,this._prevPanoRenderable=void 0,this._prevScanCloudRenderable=void 0,this._prevPointCloudRenderable=void 0,this._rootIsScanCloud=!1,this._rootIsSameObject=!1,this._linesRenderable=void 0,this._lineAreaEnd=void 0,this._renderObjects=!0,this._moveHandler=void 0,this._point3dService._point3d=void 0,this._replaceURL=void 0,this._scanService._rootScan=void 0
},getViewTrafo:function(){var e=this;return this._trafoView&&!this._trafoView._isFallback?Q.resolve(!0):this._project.getCurrentProject().then(function(t){return t._type===WS.Project.Type.INC?e._pointCloudService.getAll().then(function(t){var i=mat4.identity();return t[0]&&mat4.setTranslation(i,t[0].getTranslationGlobal()),i._isFallback=!t[0],e._trafoView=i,!0}):e._mapObjectService.getAll().then(function(t){if(!(t&&t[0]instanceof WS.MapObject))throw new Error("EXCEPTION_MESSAGE_FIND_OBJECT");var i=mat4.identity();return mat4.setTranslation(i,t[0].getTranslationGlobal()),i._isFallback=!1,e._trafoView=i,!0})})},showObjects:function(e,t,i){if(("panorama"===t||"3d"===t||"pano/3d"===t)&&(!(e.length>0)||e[0]instanceof WS.Scan||e[0]instanceof WS.PointCloud)){var n=this;this._tempOrthophoto.getAll().then(function(o){var r=o[0]&&o[0]._focusable?o[0]:void 0;n.load({root:e[0],focus:r,miniView:i&&i.miniView},t)},function(){n.load({root:e[0],miniView:i&&i.miniView},t)}).done()}},focusOn:function(e,t){if("pano/3d"===t&&(t=this.isRootCloud()?"3d":"panorama"),"panorama"===t||"3d"===t){var i={root:e.root,rootType:e.rootType,focus:e.object,lookAt:e.lookAt,camPos:e.camPos,camFov:e.camFov,picker:e.picker,miniView:e.miniView};this.load(i,t)}},load:function(e,t){var i=this;if("panorama"===t||"3d"===t||"pano/3d"===t){if(!this._viewModeCtrl)return void this._viewModeCtrlD.promise.then(this.load.bind(this,e,t));var n=void 0!==e.miniView?e.miniView:this.miniView()||!1,o=this.getPageBox();if(o&&o.isCollecting()&&this.changePage({miniView:n}),n||this.launchTask("default","panoramaview",void 0,void 0,{noNavigation:!0}),"loading"===this._fsm._state||this._viewModeCtrl.viewModeTransition()!==WS.PanoramaView.Transition.NONE)return void this._alert.error(this._viewModeCtrl.targetViewMode()===WS.PanoramaView.ViewMode.POINTS?"EM_3D_LOAD":"EM_SCAN_LOAD");this.$scope.loadStarted=!0,this._project.getCurrentProject().then(function(n){var o;if("pano/3d"===t&&(i._root?t=i._viewModeCtrl.targetViewMode()===WS.PanoramaView.ViewMode.POINTS?"3d":"panorama":F.isMobile()&&n.hasScan()?t="panorama":n._enable3D&&n.hasPointCloud()?i._settingService.isWebGlEnabled()?t="3d":n.hasScan()?t="panorama":o="FE_NEED_WEBGL_FOR_3D":n.hasScan()?t="panorama":o="EM_3D_NA"),"3d"===t&&(n._enable3D?i._settingService.isWebGlEnabled()||(o="FE_NEED_WEBGL_FOR_3D"):o="EM_3D_NA_EXTENDED"),o){var r=new Error(o);return i._promise=Q.reject(r),i.$scope.error=r,void F.handled(r)}i._replaceURL=!!e.replaceURL,i._isCollecting=!0,i._url.collect(),i._fsm.read("load"),i._fsm._meta.rollback="reset";var a=!i._init;i._promiseTransitionD=Q.defer(),i.setLoadPromise(t,e),i._promiseTransitionD.promise.then(function(){i._cameraAnimator.isAnimating()&&i._cameraAnimator.reset(),e.updateSettings instanceof WS.PanoSettings&&i.updateSceneForUpdateSettings(e.updateSettings);var n=i.determineCameraLookPosOrAngle(e,t),o=i.determineCameraTargetPos(e,t,n),r=i.setCameraAfterLoad(e,t,o,n,a);i.setCoordinatePickerAfterLoad(e,n),i._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.ANIMATING),i.updateFSMAfterLoad(e,n,r)},function(e){i._fsm.read(i._fsm._meta.rollback),i._isCollecting&&(i._url.commit(),i._isCollecting=!1),i._promise=Q.reject(e),i.$scope.$apply(function(t){t.error=e}),F.handled(e)}).done()},function(e){i._fsm.read("reset"),i._isCollecting&&(i._url.commit(),i._isCollecting=!1),i._promise=Q.reject(e),i.$scope.$apply(function(t){t.error=e}),F.handled(e)})}},determineCameraLookPosOrAngle:function(e){var t={lookPos:e.lookAt,angle:e.angle};if(!t.lookPos){var i=e.focus;if(i)if(i instanceof WS.TempOrthophoto)t.lookPos=i.getVolumeCenterGlobal();else if(i instanceof WS.Orthophoto)t.lookPos=this.$scope.settings._showOrthoVolumes?i.getVolumeCenterGlobal():i.getImageCenterGlobal();else if(i instanceof WS.Measurement||i instanceof WS.Annotation&&i.isPolyline()&&this.$scope.settings._showPolylines){var n=i.getBoundingBox();t.lookPos=n.getCenter()}else i instanceof WS.Scan?i instanceof WS.Scan&&void 0===e.angle&&0!==this._camera.isLookingAtPole()&&(t.angle=[this._camera.getPhi(),0]):t.lookPos=i.getTranslationGlobal();else this.isRootBasedOnScan()&&void 0===e.angle&&0!==this._camera.isLookingAtPole()&&(t.angle=[this._camera.getPhi(),0])}return t},determineCameraTargetPos:function(e,t,i){var n=e.focus,o=e.camPos;if("keep"===o?o=this.getCamGlobalPos():"panorama"===t&&(o=this._root.getTranslationGlobal()),!o){var r,a,s,c;if(i.lookPos)if(n instanceof WS.Measurement||n instanceof WS.Annotation&&n.isPolyline()&&this.$scope.settings._showPolylines){c=n.getBoundingBox(),r=Math.max(2.5,this._camera.calcViewingDistance(.75*c.getLongestLength(),.75*c.getLongestLength()));var l=n.determineOrientation();o="y-"===l?vec3.add(c.getCenter(),[-r,-r,r],vec3.create()):vec3.add(c.getCenter(),[r,-r,r],vec3.create())}else if(n instanceof WS.TempOrthophoto){var h;n.isHorizontal()?(r=n.getHeightInMeter()/2+this._camera.calcViewingDistance(n.getWidthInMeter(),n.getDepthInMeter())+5,h=[0,r,0]):(r=n.getDepthInMeter()/2+this._camera.calcViewingDistance(n.getWidthInMeter(),n.getHeightInMeter())+5,h=[0,0,-r]),a=mat4.toMat3(n._trafoGlobal),s=mat3.multiplyVec3(a,h,vec3.create()),o=vec3.add(i.lookPos,s,vec3.create())}else if(n instanceof WS.Orthophoto){var d=this.$scope.settings._showOrthoVolumes?n.getDepthInMeter():0;if(r=d/2+this._camera.calcViewingDistance(n.getWidthInMeter(),n.getHeightInMeter())+5,a=mat4.toMat3(n._trafoGlobal),s=mat3.multiplyVec3(a,[0,0,-r],vec3.create()),n.isHorizontal()){var u,p,_=n.getImageCornersGlobal(),g=(_[1][1]-_[0][1])/(_[1][0]-_[0][0]),f=Math.abs(Math.atan(g));_[1][0]<=_[0][0]&&g>=0?(u=-1,p=1):_[1][0]<=_[0][0]&&0>g?(u=1,p=1):_[0][0]<_[1][0]&&g>=0?(u=1,p=-1):(u=-1,p=-1),s[0]+=.001*u*Math.sin(f),s[1]+=.001*p*Math.cos(f)}o=vec3.add(i.lookPos,s,vec3.create())}else o=vec3.add(i.lookPos,[2.5,-2.5,2.5],vec3.create());else{var m=e.root;if(m instanceof WS.Scan||m instanceof WS.PointCloud&&"Scan"===m._type)o=m.getTranslationGlobal();else{var v=this._root.calcDefaultCamera();o=v.camPos,i.lookPos=v.lookAt,i.angle=void 0}}}return o},setCameraAfterLoad:function(e,t,i,n,o){if("panorama"!==t||vec3.equal(this.getCamGlobalPos(),i)||this._camera.setFromGlobalPos(i,this._trafoView),this._cameraIsInitialized=!0,o)return e.camFov&&this._camera.setFOVY(e.camFov),"panorama"!==t&&this._camera.setFromGlobalPos(i,this._trafoView),e.lookAt?this._camera.lookAt(n.lookPos,this._trafoView):e.angle?(this._camera.setPhi(n.angle[0]),this._camera.setTheta(n.angle[1])):n.lookPos?this._camera.lookAt(n.lookPos,this._trafoView):n.angle&&(this._camera.setPhi(n.angle[0]),this._camera.setTheta(n.angle[1])),this._camera;var r=new WS.PerspectiveCamera;return r.copyFrom(this._camera),e.camFov&&r.setFOVY(e.camFov),"panorama"!==t&&r.setFromGlobalPos(i,this._trafoView),e.lookAt?r.lookAt(n.lookPos,this._trafoView):e.angle?(r.setPhi(n.angle[0]),r.setTheta(n.angle[1])):n.lookPos?r.lookAt(n.lookPos,this._trafoView):n.angle&&(r.setPhi(n.angle[0]),r.setTheta(n.angle[1])),this.setCameraByTargetCam(e,r),r},setCameraByTargetCam:function(e,t){var i=this,n=this.getCamGlobalPos(),o=this._camera.getPhi(),r=this._camera.getTheta(),a=this._camera._fovY,s=t.getGlobalPos(this._trafoView),c=t.getPhi(),l=t.getTheta(),h=t._fovY;if(!vec3.equal(n,s)||o!==c||r!==l||a!==h){var d=this._cameraAnimator.calcGoodDuration(n,s,o,c,r,l,a,h);if(e.doNotAnimate||0===d){var u=this._camera._dirty;this._camera.setFromGlobalPos(s,this._trafoView),this._camera.setPhi(c),this._camera.setTheta(l),this._camera.setFOVY(h),this._camera._dirty=u}else if(this.isRendering())this._cameraAnimator.startAnimation(this._camera,d,this._trafoView,s,c,l,h);else{this._promiseCamAnimD=Q.defer();var p=this._promiseCamAnimD.promise;p.then(function(){i._cameraAnimator.startAnimation(i._camera,d,i._trafoView,s,c,l,h),i._promiseCamAnimD=void 0})}}},setCoordinatePickerAfterLoad:function(e,t){if(e.lookAt&&!e.focus&&e.picker!==!1){var i=new WS.Point3d([0,0,0],[0,0],this._root,this);i._positionGlobal=vec3.create(t.lookPos);var n=i.calcPositionInRefSystem(this._trafoView);i._estimatedPosition=vec3.create(n),i._positionLocal=vec3.create(n),i._pointState=WS.Point3d.PointState.Free,this._point3dService.setPoint(i)}},updateFSMAfterLoad:function(e,t){var i=e.focus,n=e.lookAt;i?(this.highlight(i),this._fsm.read("focusobject"),this._fsm._meta.focus={object:i,lookPos:void 0!==n?t.lookPos:void 0}):n?(this._fsm.read("focusxyz"),this._fsm._meta.focus={lookPos:t.lookPos}):this._fsm.read("show")},setLoadPromise:function(e,t){var i=this;i.getViewTrafo().then(function(){var n;n="string"==typeof t.focus?i.getObject(t.focus,t.focusType):Q.resolve(t.focus instanceof F.CRUDObject?t.focus:void 0),n.then(function(n){n instanceof F.CRUDObject&&(t.focus=n);{var o,r,a,s,c,l=!1;t.pointCloudType}"object"==typeof t.root?(r=t.root instanceof WS.Scan?t.root:void 0,a=t.root instanceof WS.PointCloud?t.root:void 0):"string"==typeof t.root&&(s="scan"===t.rootType?t.root:void 0,c="pointcloud"===t.rootType?t.root:void 0);var h=t.closestTo||t.lookAt||t.camPos;if("panorama"===e)o=r?Q.resolve(r):s?i._scanService.getByID(s,void 0,!1):n?i.loadParentScan(n,!1):h?i.getBestFittingScan(h):i._scanService.getNearestScan("center");else if("3d"===e){{s||(r?r._UUID:void 0)}i.isRootPointCloud()?o=Q.resolve(i._root):i._prevRenderable&&i._prevRenderable._dataObject instanceof WS.PointCloud?o=Q.resolve(i._prevRenderable._dataObject):(o=i._pointCloudService.getDefaultPointCloud(),l=!0),a?o=Q.resolve(a):n||c&&(o=i._pointCloudService.getByID(c,void 0,!0))}i._promise=o.then(function(e){if(!(e instanceof WS.PointCloud&&"Scan"!==e._type)||r||s||h||t.angle||t.focus)return e;var i;return e.getTreeStructureAsync().then(function(){return i=e.getFirstNonEmptyNode(),e._pointLoader.addAsListener(),e._pointLoader.loadNodeBinaryAsync(i)}).then(function(){return e}).fail(function(){return e})}).then(function(t){i.$scope.error=void 0;var o=i._rootIsScanCloud;if(!t&&l){var a=i._pointCloudService.isSimple3dEnabled().then(function(e){return e?r?r:s?i._scanService.getByID(s,void 0,!0):n?i.loadParentScan(n,!0):i.getBestFittingScan(h):Q.reject(new Error("EM_3D_NA_EXTENDED"))});return a.then(function(e){return i.processLoadedRoot(e,o,!0)},function(e){return Q.reject(e)})}return t?i.processLoadedRoot(t,o,!1):Q.reject(new Error("panorama"===e?"EM_PANO_NA_EXTENDED":"EM_3D_NA_EXTENDED"))},function(){return Q.reject(new Error("panorama"===e?"EM_PANO_NA_EXTENDED":"EM_3D_NA_EXTENDED"))}),i._promise.then(function(t){return t?(F.async(i.hideRadialMenu,i),i._viewModeCtrl.update(i._root),i.resolveRootName(),i.resolveScanRecordingTime(),void(i._rootIsSameObject?i.startAndUpdateChangeViewModeForSameRoot():(i._scanService._rootScan=t instanceof WS.Scan?t:void 0,i.setPreviousRenderable(),i.filterObjects(),i.updateMSMs(),i.updateDisplayOfAllScans(),i.updateOcclusionOfAllRenderables(),i.createAndAddSkybox(),i.updatePickerRootChanged(),i.isRootPointCloud()?i.exchangePointCloudRootRenderable():i.exchangeScanRootRenderable(),i.loadObjects(),i.trigger("sceneRootChange",[t,i])))):void i._promiseTransitionD.reject(new Error("panorama"===e?"EM_PANO_NA_EXTENDED":"EM_3D_NA_EXTENDED"))},function(e){i._promiseTransitionD.reject(e)})},function(e){("FindObjectException"===e._type||"ResourceNotFoundException"===e._type)&&(e.message="EM_3D_FOCUS"),i._promiseTransitionD.reject(e)})},function(e){i._promiseTransitionD.reject(e)})},processLoadedRoot:function(e,t,i){if(this._root&&e&&this._root._UUID===e._UUID)this._root=e,this._rootIsScanCloud=i,this._rootIsSameObject=t&&i||!t&&!i;else{this._root=e,this._rootIsScanCloud=i,this._rootIsSameObject=!1;var n=this;this.$scope.$apply(function(t){t.root=n._root,n.isRootScan()?(t.panoImagePaths=n.getPanoImagePaths(),t.panoImageResolution=e.getImageResolutionByPath(t.panoImagePaths[0])):(t.panoImagePaths=void 0,t.panoImageResolution="")})}return this._root},updateMSMs:function(){var e=this,t=this.getRelatedScanUUIDs();this._objects.measurement.entities.forEach(function(i){if(i._type===WS.Measurement.Type.MultiScanPoint){var n=e.getRenderable(i);n&&(n.setViewScanUuids(t),n.updateMSMPoints())}})},updateDisplayOfAllScans:function(){var e=this;this._objects.scan.entities.forEach(function(t){e.updateDisplayOfScan(t)})},updateDisplayOfScan:function(e){for(var t=this.getRenderables(e),i=0,n=t.length;n>i;++i)this.updateViewingMode(t[i])},updateOcclusionOfAllRenderables:function(){for(var e=this.getAllRenderables(),t=0,i=e.length;i>t;++t)this.setOcclusion(e[t])},getRelatedScanUUIDs:function(){return this.isRootScanOrScanCloud()?[this._root._UUID]:this.isRootPointCloud()?this._root._sourceUUIDs:void 0},resolveRootName:function(){var e=this,t=this.$scope;this.isRootProjectPointCloud()||this.isRootScanOrScanCloud()?t.rootName=this._root._displayName:this.isRootScanPointCloud()?this._scanService.getByID(e._root._sourceUUIDs[0]).then(function(e){t.rootName=e._displayName},function(){t.rootName=e._locale.translate("FE_SCAN")}):t.rootName=this._root&&this._root._displayName?this._root._displayName:""},resolveScanRecordingTime:function(){var e=this.$scope;this.isRootScanOrScanCloud()?e.scanRecordingTime=this._root._recordingTime:this.isRootScanPointCloud()?this._scanService.getByID(this._root._sourceUUIDs[0]).then(function(t){e.scanRecordingTime=t._recordingTime},function(){e.scanRecordingTime="1970-01-01 00:00:00"}):e.scanRecordingTime="1970-01-01 00:00:00"},loadParentScan:function(e,t){var i,n,o;if(e._scanUUIDs&&0<e._scanUUIDs.length)o=e._scanUUIDs,i=!0;else if(e._pointScans&&0<e._pointScans.length)o=e._pointScans,i=e instanceof WS.Annotation;else{for(var r=e._ancestors,a=r.length-1;a>=0;a--)if("Scan"===r[a].Class){n=r[a].UUID;break}i=e instanceof WS.Annotation&&(!F.isIE()||F.ieVersion()>9)}if(t&&(i=!0),this._root&&(n&&this._root._UUID===n||o&&o.indexOf(this._root._UUID)>=0))return Q.resolve(this._root);var s=this._scanService;return n?s.getByID(n,void 0,!1).fail(function(){if(!i)throw new Error("EM_NO_SCAN_AVAILABLE");return s.getNearestScan(e._trafoGlobal)}):o||i?s.getNearestScan(e._trafoGlobal,void 0,o,i):Q.reject(new Error("EM_NO_SCAN_AVAILABLE"))},loadObjects:function(){var e=this,t=[this._scanService,this._pointCloudService,this._annotationService,this._measurementService,this._orthophoto,this._tempMeasurementService,this._tempOrthophoto];t.forEach(function(t){t.getAll().then(function(t){e.addObjects(t)},function(t){e._alert.errorObj(t)}).done()})},addObject:function(e,t){return this._root&&this._trafoView?(e instanceof WS.Point3d&&(this.flashPickerCoords(),this.updatePickerDistance(),this.$scope.$apply(function(t){t.pickedPoint=e})),WS.View3d.prototype.addObject.call(this,e,t)):0},objectFilter:function(e){if(e.instanceOf(WS.Point3d)||e.instanceOf(WS.Orthophoto)||e.instanceOf(WS.Scan))return!0;if(e.instanceOf(WS.PointCloud))return"complete"===e._state&&this._settingService.isWebGlEnabled();var t=this.getRootUuid();if(e.instanceOf(WS.Annotation))return e.hasMapType()?!1:!F.isIE()||F.ieVersion()>9?!0:e._ancestors.some(function(e){return e.UUID===t});if(e.instanceOf(WS.Measurement)){var i=WS.Measurement.Type;if(e._type===i.Map)return!1;if(this.isRootCloud())return!0;if(e._ancestors.some(function(e){return e.UUID===t}))return!0;if(e._type===i.MultiScanPoint)return-1!==e._pointScans.indexOf(t)}return!1},isObjectRoot:function(e){return this._root===e},isRootBasedOnScan:function(e){return this.isRootScanOrScanCloud()&&(!e||this.isObjectRoot(e))||this.isRootScanPointCloud()&&(!e||this._root._sourceUUIDs[0]===e._UUID)},isRootScan:function(){return this._root&&this._root.instanceOf(WS.Scan)&&!this._rootIsScanCloud},isRootScanCloud:function(){return this._root instanceof WS.Scan&&this._rootIsScanCloud},isRootScanOrScanCloud:function(){return this.isRootScan()||this.isRootScanCloud()},isRootPointCloud:function(){return this._root instanceof WS.PointCloud},isRootProjectPointCloud:function(){return this._root instanceof WS.PointCloud&&(this._root._type===WS.PointCloud.Type.PROJECT||this._root._type===WS.PointCloud.Type.ENTITYPC)},isRootScanPointCloud:function(){return this._root instanceof WS.PointCloud&&"Scan"===this._root._type},isRootCloud:function(){return this.isRootPointCloud()||this.isRootScanCloud()},getRootUuid:function(){return void 0!==this._root?this._root._UUID:""},isRootRenderablePano:function(){return this._rootRenderable instanceof WS.PanoramaRenderable},isRootRenderableScanCloud:function(){return this._rootRenderable instanceof WS.ScanCloudRenderable},isRootRenderablePointCloud:function(){return this._rootRenderable instanceof WS.PointCloudRenderable},isRootRenderableCloud:function(){return this.isRootRenderableScanCloud()||this.isRootRenderablePointCloud()},isPreviousRenderablePano:function(){return this._prevRenderable instanceof WS.PanoramaRenderable},isPreviousRenderableScanCloud:function(){return this._prevRenderable instanceof WS.ScanCloudRenderable},isPreviousRenderablePointCloud:function(){return this._prevRenderable instanceof WS.PointCloudRenderable},isPreviousRenderableCloud:function(){return this.isPreviousRenderableScanCloud()||this.isPreviousRenderablePointCloud()},hasPreviousRenderableSameType:function(){return this.isPreviousRenderableCloud()&&this.isRootRenderableCloud()||this.isPreviousRenderablePano()&&this.isRootRenderablePano()},isPanoRenderableLoaded:function(){return this._panoRenderable&&this._renderer[0].areAllTexturesUploaded(this._panoRenderable._material)},loadSkyBox:function(){return this._skybox&&this._renderer[0].areAllTexturesUploaded(this._skybox._material)},isPointsRenderableLoaded:function(){return this._pointsRenderable&&this._pointsRenderable.isLoaded()},setPreviousRenderable:function(){this.isRootRenderablePano()?(this._prevPanoRenderable&&this._prevPanoRenderable._dataObject!==this._root&&this._prevPanoRenderable.unload(this),this._prevPanoRenderable=this._rootRenderable):this.isRootRenderableScanCloud()?(this._prevScanCloudRenderable&&this._prevScanCloudRenderable._dataObject!==this._root&&this._prevScanCloudRenderable.unload(this),this._prevScanCloudRenderable=this._rootRenderable):this.isRootRenderablePointCloud()&&(this._prevPointCloudRenderable&&this._prevPointCloudRenderable._dataObject!==this._root&&this._prevPointCloudRenderable.unload(this),this._prevPointCloudRenderable=this._rootRenderable),this._prevRenderable=this._rootRenderable,this._rootRenderable=void 0,this._pointsRenderable=void 0,this._panoRenderable=void 0},exchangeScanRootRenderable:function(){var e;this.isRootScan()?(e=this.getRenderable(this._root,WS.View3d.RenderableType.PANORAMA),e&&e.getUuid()===this._root._UUID?(this.setPanoRenderable(e),this.startChangeViewMode(WS.PanoramaView.ViewMode.PANO)):this._prevPanoRenderable&&this._prevPanoRenderable.getUuid()===this._root._UUID?this.addRenderable(this._prevPanoRenderable,WS.View3d.RenderableType.PANORAMA,this._root):(e=this.createPanoRenderable(this._root),this.addRenderable(e,WS.View3d.RenderableType.PANORAMA,this._root))):this.isRootScanCloud()&&(e=this.getRenderable(this._root,WS.View3d.RenderableType.SCAN_CLOUD)||this._prevScanCloudRenderable,e&&e.getUuid()===this._root._UUID?(this.setPointsRenderable(e),this.startChangeViewMode(WS.PanoramaView.ViewMode.POINTS)):(e=this._root.createScanCloudRenderable(this,this._settingService),this.addRenderable(e,WS.View3d.RenderableType.SCAN_CLOUD,this._root)))},exchangePointCloudRootRenderable:function(){var e=this.getRenderable(this._root,WS.View3d.RenderableType.DEFAULT);e||(e=this._root.createRenderable(this),this.addRenderable(e,WS.View3d.RenderableType.DEFAULT,this._root)),this.setPointsRenderable(e),this.startChangeViewMode(WS.PanoramaView.ViewMode.POINTS)},createAndAddSkybox:function(){if(!this._skybox){var e=this._settingService.isWebGlEnabled(),t=e&&4096<=WS.GlTexture.getMaxWidth()?"assets/skybox.jpg":"assets/skybox-small.jpg";this._skybox=new WS.SkyboxRenderable(WS.imgUrlCanvasSafe(t)),WS.View3d.prototype.addRenderable.call(this,this._skybox)}},addRenderable:function(e,t,i,n){WS.View3d.prototype.addRenderable.call(this,e,t,i,n),this.isObjectRoot(i)&&(i instanceof WS.PointCloud||t===WS.View3d.RenderableType.SCAN_CLOUD?(this.setPointsRenderable(e),this.startChangeViewMode(WS.PanoramaView.ViewMode.POINTS)):t===WS.View3d.RenderableType.PANORAMA&&(this.setPanoRenderable(e),this.startChangeViewMode(WS.PanoramaView.ViewMode.PANO)));var o=this.$scope.settings;e.instanceOf(WS.ScanPanoRenderable)?e.setHideLabelBySetting(!o._showScanLabelsInPano):e.instanceOf(WS.OrthoBox3dRenderable)?e.setShowBox(o._showOrthoVolumes):e instanceof WS.PolylineAnnotationRenderable&&e.setShowPolyline(o._showPolylines),this.updateAddedRenderable(e,o._iconMode),this.setOcclusion(e)},setOcclusion:function(e){var t=e._dataObject;if(t&&e.setOcclusion&&!(F.isIE()&&F.ieVersion()<=9)){if(this.isRootCloud())return void e.setOcclusion(!1);var i=this.getRootUuid();if(t._ancestors.some(function(e){return e.UUID===i}))e.setOcclusion(!1);else{var n=t.calcPositionInRefSystem(this._root._trafoGlobal);this.isOccluded(n).then(function(t){e.setOcclusion(t)}).done()}}},isOccluded:function(e){if(!this.isRootScan())return Q.reject();var t=[e[0],e[1],e[2]];return vec3.fromCartesianToSpherical(t,t),this._root.getWeightedDistance(t[0],t[1],512).then(function(t){var i=.5,n=vec3.length(e);return 0!==t&&n>t+i})},deactivateSpecialRenderable:function(e){e.deactivate()},unloadSpecialRenderable:function(e){e.unload(this)},createPanoRenderable:function(e){var t=this.getPanoImagePaths(),i=new WS.PanoramaRenderable(t,this.$scope.settings._blendFactor,e);return i._transform=this._root.calcTrafoInRefSystem(this._trafoView),i},setPanoRenderable:function(e,t){e.setAlpha(t?0:1),this._panoRenderable=e,this._pointsRenderable=void 0,this._rootRenderable=e},activatePanoRenderable:function(e,t){var i=this.getPanoImagePaths();e.activate(i,this.$scope.settings._blendFactor),e.setAlpha(t?0:1)},getPanoImagePaths:function(){var e=this._settingService.getPrefferedImageWidth(),t=this._settingService.getPrefferedColorMode(),i=this._root;if(e=Math.min(this.getMaxPanoramaImageWidth(),e),"blend"===t._id&&i.arePanoImagesAvailableForMode(t._id)){var n=i.getSimilarAvailableImagesForBlending(e),o=[];return o[0]=i.getImagePath(n[0]),o[1]=i.getImagePath(n[1]),o}return[i.getImagePath(i.getSimilarAvailablePanoImage(e,t._id))]},getMaxPanoramaImageWidth:function(){return this._renderMode===WS.View3d.RenderMode.Canvas?WS.CanvasTexture.getMaxWidth():this._renderMode===WS.View3d.RenderMode.WebGl?WS.GlTexture.getMaxWidth():0},setPointsRenderable:function(e,t){e.setAlpha(t?0:1),this._panoRenderable=void 0,this._pointsRenderable=e,this._rootRenderable=e},activatePointsRenderable:function(e,t){e.setAlpha(t?0:1),e.activate()},activateSkybox:function(){this._skybox&&(this._skybox.activate(),this._skybox.setAlpha(1),this.loadSkyBox())},finishPreviousRenderable:function(){this._prevRenderable&&this._prevRenderable!==this._rootRenderable&&this.deactivateSpecialRenderable(this._prevRenderable),this.isRootRenderablePano()&&this._skybox&&this.deactivateSpecialRenderable(this._skybox),this._prevPanoRenderable===this._rootRenderable?this._prevPanoRenderable=void 0:this._prevScanCloudRenderable===this._rootRenderable?this._prevScanCloudRenderable=void 0:this._prevPointCloudRenderable===this._rootRenderable&&(this._prevPointCloudRenderable=void 0)},startChangeViewMode:function(e){this.deactivateHandlerStack(),this._modeToHandlerStack=void 0,this._viewModeCtrl.targetViewMode(e),this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.LOADING);var t=e===WS.PanoramaView.ViewMode.POINTS;this.updateCameraSettings(this._prevRenderable&&!this.hasPreviousRenderableSameType()||t);var i=this.isRendering()&&this._prevRenderable&&!this.hasPreviousRenderableSameType();t?(this.activatePointsRenderable(this._pointsRenderable,i),this.activateSkybox()):this.activatePanoRenderable(this._panoRenderable,i),this._init=!0,this.$scope.$apply()},updateChangeViewModeAfterLoad:function(){this._inScanOrigin=void 0,this.finishPreviousRenderable(),this.onUpdateViewDimensions(),this._promiseTransitionD.resolve(!0)},startAndUpdateChangeViewModeForSameRoot:function(){this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.LOADING),this._init=!0,this.onUpdateViewDimensions(),this._promiseTransitionD.resolve(!0),this.$scope.$apply()},finishChangeViewMode:function(){this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.NONE),this._viewModeCtrl.viewMode(this._viewModeCtrl.targetViewMode()),this._modeToHandlerStack=void 0,this.initHandlers(),this.updateURL(this._replaceURL),this._isCollecting&&(this._url.commit(),this._isCollecting=!1),this.updatePickerDistance(),this.isRootRenderablePointCloud()&&(this._rootRenderable._panoTo3d=!1),this.updateCameraSettings(),F.async(this.$scope.$apply,this.$scope)},updatePickerRootChanged:function(){var e=this._point3dService.getPoint();if(e)switch(e._pointState){case WS.Point3d.PointState.Invalid:case WS.Point3d.PointState.Unknown:this._point3dService.setPoint(void 0)}},updatePickerDistance:function(){var e=this._point3dService.getPoint();this.$scope.pickedDistance=e&&e._positionGlobal?vec3.dist(e._positionGlobal,this.getCamGlobalPos()):void 0},flashPickerCoords:function(){var e=this.$scope,t=this._point3dService.getPoint();e.flashPicker=!1,t&&t._pointState!==WS.Point3d.PointState.Unknown&&setTimeout(function(){e.$apply(e.flashPicker=!0)},50)},initHandlers:function(){this.isRootCloud()?this._camera.set3dMode():this._camera.setPanoMode();var e=this._modeToHandlerStack={},t=this._moveHandler=this.isRootCloud()?new WS.PointCloudMoveHandler(this._camera,this,this._settingService):new WS.PanoMoveHandler(this._camera,this,this._settingService);e[WS.ViewBase.Mode.Move]=[t,new WS.PickObjectHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.PickPoint]=[t,new WS.PickPointHandler(this._camera,this)],e[WS.ViewBase.Mode.PickPolygon]=[t,new WS.PickPointsHandler(this._camera,this)],e[WS.ViewBase.Mode.SelectObject]=[t,new WS.PickObjectHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.SelectObjects]=[t,new WS.PickObjectHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.SelectObjectsRectAdd]=[t,new WS.SelectRegionHandler(this._camera,this._scene,this,this._selectionRenderable,!0)],e[WS.ViewBase.Mode.SelectObjectsRectSub]=[t,new WS.SelectRegionHandler(this._camera,this._scene,this,this._selectionRenderable,!1)],e[WS.ViewBase.Mode.PickAll]=[t,new WS.PickAllHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.PickPointOpenScans]=[t,new WS.PickAllHandler(this._camera,this._scene,this)],e[WS.ViewBase.Mode.Move][1].addListener(new WS.PickObjectListener(this,WS.PickObjectListener.SelectionMode.None,this._selection,this._alert)),e[WS.ViewBase.Mode.PickPoint][1].addListener(new WS.PickPointListener(this)),e[WS.ViewBase.Mode.PickPolygon][1].addListener(new WS.PickPointListener(this)),e[WS.ViewBase.Mode.SelectObject][1].addListener(new WS.PickObjectListener(this,WS.PickObjectListener.SelectionMode.Single,this._selection,this._alert));var i=new WS.PickObjectListener(this,WS.PickObjectListener.SelectionMode.Multi,this._selection,this._alert);e[WS.ViewBase.Mode.SelectObjects][1].addListener(i),e[WS.ViewBase.Mode.SelectObjectsRectAdd][1].addListener(i),e[WS.ViewBase.Mode.SelectObjectsRectSub][1].addListener(i),e[WS.ViewBase.Mode.PickAll][1].addListener(new WS.PickAllListener(this,this._selection,this._alert,this._point3dService)),e[WS.ViewBase.Mode.PickPointOpenScans][1].addListener(new WS.PickPointOpenScansListener(this,this._selection,this._alert)),this.setMode(this._mode||WS.PanoramaView.defaultMode)},setMode:function(e){var t=WS.ViewBase.Mode;this._mode!==e&&e!==t.PickAll&&F.async(this.hideRadialMenu,this),WS.View3d.prototype.setMode.call(this,e);var i=this._panoRenderable?this._panoRenderable._material:void 0;i&&i.setTextureImgFilter(e===t.PickPoint||e===t.PickPolygon||e===t.PickPointOpenScans?WS.Image.Filter.Nearest:WS.Image.Filter.Linear),(e===t.SelectObjectsRectAdd||e===t.SelectObjectsRectSub)&&this._selectionRenderable.setAppearance(e===t.SelectObjectsRectAdd)},updateViewingMode:function(e){var t=e._dataObject;e.setViewingMode(t&&t._selected?WS.Renderable.ViewingMode.Selected:t&&this._hlObject===t?WS.Renderable.ViewingMode.Highlighted:e instanceof WS.ScanPanoRenderable&&this.isRootBasedOnScan(t)?WS.Renderable.ViewingMode.Displayed:WS.Renderable.ViewingMode.Normal)},pick3d:function(e,t,i,n,o){var r=this._pointsRenderable,a=r&&r.isActive()&&r.useIncrRendering();return WS.View3d.prototype.pick3d.call(this,e,t,i,n,a,o)},render:function(){var e=WS.PointCloudRenderable.Draw,t=WS.PointCloudRenderable.State,i=function(){return!0},n=this.$scope,o=this._renderer[this._renderer.length-1],r=this._viewModeCtrl.targetViewMode()===WS.PanoramaView.ViewMode.POINTS,a=this.isPointsRenderableLoaded(),s=this.isPanoRenderableLoaded();if(n.dbgStats.show&&this.dbgUpdateStats(),!s&&!a)return o.clear(),this._progressSpinner._position=[this._width/2,this._height/2],this._progressSpinner.draw2d(o,i,!1),void(this._cameraIdleCount=0);if(this._isMoving||this._viewModeCtrl.viewModeTransition()!==WS.PanoramaView.Transition.NONE||this.triggerCameraChange(),this._viewModeCtrl.viewModeTransition()===WS.PanoramaView.Transition.LOADING)s?this._prevRenderable?this.isPreviousRenderablePano()?this.updateChangeViewModeAfterLoad():this.animToPanoStart():this.updateChangeViewModeAfterLoad():this._prevRenderable&&this.isPreviousRenderablePano()?this.blendTo3dStart():this.updateChangeViewModeAfterLoad();else if(this._viewModeCtrl.viewModeTransition()===WS.PanoramaView.Transition.SWITCHING_PANO_3D)r?this.blend():this._inScanOrigin?this.blend():this.animToPano();else if(this._viewModeCtrl.viewModeTransition()===WS.PanoramaView.Transition.ANIMATING)if(this._cameraAnimator.isAnimating()){var c=this._cameraAnimator.animate();c&&this.finishChangeViewMode()}else this._promiseCamAnimD||this.finishChangeViewMode();else this._cameraAnimator.isAnimating()&&this._cameraAnimator.animate();var l=e.ALL,h=!1;if(this._renderMode===WS.View3d.RenderMode.Canvas)this.updateMaxVisDistance(!1),this._panoRenderable&&(this._cameraIdleCount===WS.PanoramaView.idleToFullResFrame&&this._panoRenderable.requestFullResolutionFrame(),(this._camera._dirty||!this._panoRenderable._fullResolutionFrameRendered)&&this._renderer[0].drawScene(this._camera,this._scene,!0)),this._renderer[1].setSubdivQuality(this._cameraIdleCount>1?WS.Renderer2D.SubdivQuality.HIGH:WS.Renderer2D.SubdivQuality.LOW),this._renderer[1].drawScene(this._camera,this._scene);else{var d,u,p,_,g;this._pointsRenderable&&this._pointsRenderable.isActive()&&(d=this._pointsRenderable.update(),p=this._pointsRenderable.useIncrRendering(),g=this._pointsRenderable._state===t.MOVE,h=this._pointsRenderable.shouldShowLoading()),this._prevRenderable&&this.isPreviousRenderableCloud()&&this._prevRenderable.isActive()&&(u=this._prevRenderable.update(),_=this._prevRenderable.useIncrRendering(),void 0===g&&(g=this._prevRenderable._state===t.MOVE),h=h||this._prevRenderable.shouldShowLoading()),this.updateMaxVisDistance(void 0!==g,g),void 0!==d&&void 0!==u?l=WS.PointCloudRenderable.combineDrawStates(d,u):void 0!==d?l=d:void 0!==u&&(l=u);var f=!1;if(void 0!==p&&void 0!==_?f=p&&_:void 0!==p?f=p:void 0!==_&&(f=_),l!==e.ABORT)if(f)this._renderer[0].drawSceneIncremental(this._camera,this._scene,l);else{var m=this._renderObjects?void 0:{zIndices:[0,1]};this._renderer[0].drawScene(this._camera,this._scene,!0,void 0,m)}}if(h!==n.page.loading&&F.async(function(){n.$apply(function(){n.page.loading=h})}),l!==e.ABORT){if(o.drawScene(this._camera,this._scene),this._bearingVisualizer){var v=this,S=function(){return v._settingService._settings._showCompass&&!v.miniView()};this._bearingVisualizer.draw2d(o,S,!1,this._trafoView)}this._selectionRenderable.draw2d(o,i,!1)}},dbgUpdateStats:function(){var e=this.$scope,t=e.dbgStats;t.fps=this._dbgFps.toFixed(1);var i=this.isRootRenderablePointCloud()?this._pointsRenderable:this.isPreviousRenderablePointCloud()?this._prevRenderable:void 0,n=i?i._pointLoader:void 0,o=function(e){return(1e-6*e).toFixed(3)};t.points=o(i?n._pointsInMemory:0),t.nodes=i?n._nodesInMemory:0;
var r,a=0,s=0,c=0,l=i?i._visibleNodes:[];for(r=l.length-1;r>=0;r--){var h=l[r];a+=h._points,h._nodeInfo.positionArray&&(s+=h._points,c++)}t.pointsVis=o(a),t.nodesVis=i?i._visibleNodes.length:0,t.pointsRdr=o(s),t.nodesRdr=c,t.pointsLoad=o(n?n._requestedPoints:0),t.nodesLoad=n?n._requestedNodes.length:0,n&&(t.maxPoints=o(n._maxPointsInMemory),t.pointBudgetMove=o(i._pointBudgetMove),t.pointBudgetStill=o(i._pointBudgetStill)),F.async(function(){e.$digest()})},blendTo3dStart:function(){this.isRootRenderableCloud()&&(this._rootRenderable._inTransition=!0,this.isRootRenderablePointCloud()&&(this._rootRenderable._panoTo3d=!0)),this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.SWITCHING_PANO_3D),this._blender.startBlending([this._rootRenderable,this._prevRenderable],[1e3,1e3],[1,0])},blendToPanoStart:function(){this._blender.startBlending([this._rootRenderable,this._prevRenderable],[1e3,1e3],[1,0])},blend:function(){var e=this._blender.blend();e&&(this.isPreviousRenderableCloud()&&(this._prevRenderable._inTransition=!1),this.isRootRenderableCloud()&&(this._rootRenderable._inTransition=!1),this.updateChangeViewModeAfterLoad())},animToPanoStart:function(){this.isPreviousRenderableCloud()&&(this._prevRenderable._inTransition=!0),this._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.SWITCHING_PANO_3D);var e=this.getCamGlobalPos(),t=this._root.getTranslationGlobal(),i=this._cameraAnimator.calcGoodDuration(e,t);0===i?(this._camera.setFromGlobalPos(t,this._trafoView),this._camera._dirty=!1,0===this._cameraIdleCount&&(this._cameraIdleCount=1),this._inScanOrigin=!0,this.blendToPanoStart()):this._cameraAnimator.startAnimation(this._camera,i,this._trafoView,t)},animToPano:function(){var e=this._cameraAnimator.animate();e&&(this._inScanOrigin=!0,this.blendToPanoStart())},loadSettings:function(){var e=this;this._settingService.getAll().then(function(t){t&&0<t.length&&t[0]instanceof WS.PanoSettings&&e.$scope.$apply(function(){e.$scope.settings=t[0]})},function(t){e._alert.errorObj(t)}).done()},updateSettings:function(e,t){switch(e){case"panorama":this.updateSettingsInternal(t);break;case"unit":this.updateUnitSettings(t);break;case"language":this._scene&&this._scene.traverse(new WS.UpdateLanguageVisitor);break;case"domain":this.updateDomainSettings(t)}this.forceRerender()},updateSettingsInternal:function(e){var t=this,i=!1,n=this._renderMode===WS.View3d.RenderMode.WebGl,o=this._settingService.isWebGlEnabled(),r=this.$scope;if(r.settings=e,o!==n){if(this.destroyRenderers(),this.replaceCanvases(),this.createRenderers(),this._width=this._height=void 0,this.onUpdateViewDimensions(),o||(this._prevPointCloudRenderable&&(this.deactivateSpecialRenderable(this._prevPointCloudRenderable),this.unloadSpecialRenderable(this._prevPointCloudRenderable)),this._prevScanCloudRenderable&&(this.deactivateSpecialRenderable(this._prevScanCloudRenderable),this.unloadSpecialRenderable(this._prevScanCloudRenderable)),this._pointsRenderable&&(this.deactivateSpecialRenderable(this._pointsRenderable),this.unloadSpecialRenderable(this._pointsRenderable))),this._mouseAdapter){var a=this._canvasList[this._canvasList.length-1];this._mouseAdapter.setNode(a)}var s=WS.PanoramaView.ViewMode.PANO;if(!o&&(this._viewModeCtrl.viewMode()!==s||this._viewModeCtrl.targetViewMode()!==s)){var c;c="loading"===this._fsm._state?this._promise:this._viewModeCtrl.viewModeTransition()!==WS.PanoramaView.Transition.NONE?this._promiseTransitionD.promise:Q.resolve(),c.fin(function(){t.getBestFittingScan().then(function(i){t._viewModeCtrl.viewModeTransition(WS.PanoramaView.Transition.NONE),t._cameraAnimator.reset(),t._fsm.read("reset"),t.load({root:i,updateSettings:e},"panorama")},function(e){t.reset(),t._alert.errorObj(e)})}),i=!0}r.visible&&this.startRendering()}o&&this._renderer[0].updateDetailLevel(e.details3d()),this.updateCameraSettings(),i||(this.isRootScan()&&(r.panoImagePaths=this.getPanoImagePaths(),r.panoImageResolution=this._root.getImageResolutionByPath(r.panoImagePaths[0])),this.updateSceneForUpdateSettings(e)),r.$apply()},updateUnitSettings:function(e){var t=e[2]._unit===F.AngleUnit.gon?WS.CompassRenderable.CompassModes.Gon:WS.CompassRenderable.CompassModes.Degree;this._bearingVisualizer.setCompassMode(t),this._scene&&this._scene.traverse(new WS.UpdateUnitVisitor)},disableWebGL:function(){var e=this.$scope.settings;e&&(e._changes._enableWebGl=!1,e.update(),this._alert.error("EM_WEBGL_BROKEN"))},updateCameraSettings:function(e){e=void 0===e?this.isRootCloud():e;var t=e?this._settingService.details3d():"Pano",i=WS.PanoramaView.FAR_DIST[t],n=this._camera;i!==n._far&&n.setNearAndFarPlane(void 0,i)},updateMaxVisDistance:function(e,t){var i;if(e){var n=this._settingService.details3d();i=WS.PanoramaView.MAX_VISIBILITY[t?"Move":"Still"][n]}this._renderObjects=0!==i;var o=this,r=WS.Layer.LayerIDs;[r.ORTHOPHOTOS,r.SCANS,r.ANNOTATIONS].forEach(function(e){o._layer.forceMaxDistance(e,o,i)});var a=0===i?0:void 0;o._layer.forceMaxDistance(r.MEASUREMENTS,o,a)},updateSceneForUpdateSettings:function(e){if(this._scene&&(this._scene.traverse(new WS.SetIconModeVisitor(e._iconMode)),this._scene.traverse(new WS.ScanLabelsVisitor(e._showScanLabelsInPano)),this._scene.traverse(new WS.ShowBoxVisitor(e._showOrthoVolumes)),this._scene.traverse(new WS.ShowPolylineVisitor(e._showPolylines))),this._panoRenderable){var t=this.getPanoImagePaths();this._panoRenderable.activate(t,e._blendFactor)}var i=WS.ScanCloudRenderable.DetailWidth[e.details3d()];this._pointsRenderable instanceof WS.ScanCloudRenderable&&this._pointsRenderable.updateWidthAndMode(i,e.getColorMode()._id,this),this._prevRenderable instanceof WS.ScanCloudRenderable&&this._prevRenderable.updateWidthAndMode(i,e.getColorMode()._id,this);var n=e.details3d();this._pointsRenderable instanceof WS.PointCloudRenderable&&this._pointsRenderable.updateDetailLevel(n),this._prevRenderable instanceof WS.PointCloudRenderable&&this._prevRenderable.updateDetailLevel(n)},getBestFittingScan:function(e){if(this.isRootScanOrScanCloud())return Q.resolve(this._root);if(this.isRootScanPointCloud())return this._scanService.getByID(this._root._sourceUUIDs[0],void 0,!0);var t=e?e:this.getCamGlobalPos();return this._scanService.getNearestScan(t)},replaceCanvases:function(){var e=this._canvasList,t=$(e[0]).parent();e.each(function(e,t){var i=t.outerHTML;$(t).replaceWith(i)}),e=t.find("canvas"),this.setCanvas(e)},loadDomainSettings:function(){var e=this;this._domainSettings.get().done(function(t){e.updateDomainSettings(t)},F.NOP)},updateDomainSettings:function(e){var t=this,i=this.$scope;i.$apply(function(){i.logoUrl=t._domainSettings.getCustomerLogoUrl(e),i.logoOpacity=e._customerLogoOpacity})},onCameraChange:function(e,t){if(t===this&&this._viewModeCtrl.viewModeTransition()===WS.PanoramaView.Transition.NONE&&!this._cameraAnimator.isAnimating()){var i=this.hasCameraChanged();i>0&&("highlight"!==this._fsm._state&&"xyz"!==this._fsm._state||2!==i||this._fsm.read("move"),this.updateURL(!0),this.updatePickerDistance(),this.$scope.$apply())}},hasCameraChanged:function(){var e=this._prevCameraValuesForUrl;if(!F.closeToArray(this.getCamGlobalPos(),e.pos,WS.PanoramaView.EPS_POS)||!F.closeToAngles(this._camera.getAnglesForCenter(),e.angles,WS.PanoramaView.EPS_ANGLES))return 2;var t=this._camera._fovY;return F.closeTo(t,e.fovY,.1)?0:1},getGlobalTrafoOfRoot:function(){return this._root?this._root._trafoGlobal:mat4.identity()},unselect:function(e){for(var t=0,i=e.length;i>t;t++){var n=e[t];n instanceof WS.Scan?this.updateDisplayOfScan(n):WS.View3d.prototype.unselect.call(this,[n])}},loadPending:function(e){if("pending"===this._fsm._state){var t=this._fsm._meta.pending,i=t.s||t.u,n={root:i};void 0!==t.o?(n.focus=t.o,n.focusType=t.t):void 0!==t.p&&void 0!==t.t&&(n.angle=[parseFloat(t.p),parseFloat(t.t)]);var o=t.x||t.lx,r=t.y||t.ly,a=t.z||t.lz;n.lookAt=void 0!==o&&void 0!==r&&void 0!==a?[parseFloat(o),parseFloat(r),parseFloat(a)]:void 0,n.camPos=void 0!==t.cx&&void 0!==t.cy&&void 0!==t.cz?[parseFloat(t.cx),parseFloat(t.cy),parseFloat(t.cz)]:void 0,n.camFov=void 0!==t.cf?parseFloat(t.cf):void 0,"3d"===t.vt?n.rootType="pointcloud":"3dsc"===t.vt?(n.rootType="scan",n.pointCloudType="ScanCloud"):n.rootType="scan",n.replaceURL=!0,n.miniView=e||!1;var s="3d"===t.vt||"3dsc"===t.vt?"3d":"panorama";this.load(n,s)}},getObject:function(e,t){return F.DI().getService(t).getByID(e,void 0,!0)},getImageWidth:function(){var e=this.isRootScan()&&this.$scope.panoImagePaths?this._root.getPanoImageDescByPath(this.$scope.panoImagePaths):void 0;return e?e.width:-1},setPickedPoints:function(e,t,i,n,o,r,a){var s=this;this.removeLineEnd(),this.removeLines();var c=e.some(function(e){return e._takenInView!==s});if(0!==e.length&&!c&&this._scene){var l=e.map(function(e){var t=e.calcPositionInRefSystem(s._trafoView,!0);return[t[0],t[1],t[2]]});this.createLine(l,i,n,o,r,a),t&&this.createLineEnd(l,n,o)}},updateObjects:function(e){for(var t=!1,i=0,n=e.length;n>i;i++){var o=e[i];WS.View3d.prototype.updateObject.call(this,o),o instanceof WS.Point3d&&(this.flashPickerCoords(),this.updatePickerDistance(),t=!0)}t&&this.$scope.$apply()},removeObjects:function(e){for(var t=0,i=e.length;i>t;t++){var n=e[t];n.instanceOf&&n.instanceOf(WS.Point3d)&&this.$scope.$apply(function(e){e.pickedPoint=void 0,e.pickedDistance=void 0,e.flashPicker=!1}),this.removeObject(n)}},startRendering:function(){WS.View3d.prototype.startRendering.call(this),this._promiseCamAnimD&&this._promiseCamAnimD.resolve(!0)},showJoystick:function(e,t,i){var n=WS.PointCloudMoveHandler.JOYSTICK_BUTTON_HALF,o=10,r=Math.floor(i/2),a=e-5;this.$scope.$apply(function(i){var s=i.joystick;s.hUpper=r-o,s.hLower=s.hUpper,s.xTop=a,s.yTop=t-r-6,s.xUpper=a,s.yUpper=t-r,s.xMiddle=a,s.yMiddle=t-o,s.xLower=a,s.yLower=t+o+1,s.xBottom=a,s.yBottom=t+r+1,s.xButton=e-n,s.yButton=t-n,s.visible=!0,s.wasVisible=!0})},updateJoystick:function(e,t){var i=WS.PointCloudMoveHandler.JOYSTICK_BUTTON_HALF;this.$scope.$apply(function(e){var n=e.joystick;n.yButton=Math.min(n.yBottom-1-i,Math.max(n.yUpper-i,t-i))})},hideJoystick:function(){this.$scope.$apply(function(e){e.joystick.visible=!1})},login:function(){"loading"===this._fsm._state||"pending"===this._fsm._state||(this._visible?(this._fsm.read("delay"),this.loadPending(this.miniView())):this.reset())},logout:function(){this.reset(),this.$scope.project=void 0},updateAccount:function(){if("loading"===this._fsm._state||"pending"===this._fsm._state);else if(this._visible){var e=this._url.getFragment(this._id);this._fsm._meta.pending=this._url.decode(e),this._fsm.read("delay"),this.loadPending(this.miniView())}},onConfigure:function(e){if(!e||!e.noReconfigure){var t=WS.ViewBase.Mode.PickAll;this._allowedSelections="annotation,scan,measurement,tempmeasurement,orthophoto",this._changeScanAllowed=!0,e&&(void 0!==e.changeScanAllowed&&(this._changeScanAllowed=e.changeScanAllowed),e.mode?t=e.mode:e.selection&&(t=WS.ViewBase.Mode.SelectObjects),e.selection&&(this._allowedSelections=e.selection)),this.setMode(t)}},setMiniView:function(e,t){var i=this;return Q.try(function(){return e||t!==F.PageBox.MiniViewTransition.Main?void 0:i.trigger("launchTask",["default","panoramaview",void 0,void 0,{noNavigation:!0}])}).then(WS.View3d.prototype.setMiniView.bind(this,e,t))},onShow:function(){WS.View3d.prototype.onShow.call(this),this.onUpdateViewDimensions(),this.startRendering(),this._settingsLoaded||(this._settingsLoaded=!0,this.loadDomainSettings()),"void"===this._fsm._state?this.load({},"pano/3d"):this.loadPending()},preparePageChange:function(e){var t=e.state,i=F.PageBox.Action;return!this.miniView()||!t.om.visible||t.pv.visible||e.action!==i.SelectPage&&e.action!==i.SelectPageClass&&e.action!==i.ConfigurePage&&e.action!==i.ChangeRequest?void 0:(t.pv.visible=!0,t.pv.miniView=!0,!0)},onHide:function(){WS.View3d.prototype.onHide.call(this),this.stopRendering(),this._isCollecting&&(this._url.commit(),this._isCollecting=!1),F.async(this.hideRadialMenu,this),this._root&&this.triggerCameraChange()},updateURL:function(e){var t=this.getCamGlobalPos(),i=this._camera.getAnglesForCenter(),n=i[0],o=i[1],r=this._camera._fovY,a=this._fsm._state;if(this._prevCameraValuesForUrl={angles:i,pos:t,fovY:r},"void"===a)this._url.setFragment(this._id,"",["p"],e);else if("free"===a||"xyz"===a||"highlight"===a){var s=this.isRootScanCloud()?"3dsc":this.isRootPointCloud()?"3d":"p",c=this._root._UUID,l=this._fsm._meta.focus,h=l&&l.lookPos,d={vt:s,u:c,cf:r.toFixed(2)};this.$scope.dbgStats.show&&(d.stats="t");var u=this._url.getFragment(this._id),p=u&&this._url.decode(u)||{},_=d.vt===p.vt&&d.u===p.u&&d.stats===p.stats&&F.closeTo(r,parseFloat(p.cf),.1);switch("free"!==a&&"xyz"!==a||"p"===s||(_=_&&F.closeToArray(t,[parseFloat(p.cx),parseFloat(p.cy),parseFloat(p.cz)],WS.PanoramaView.EPS_POS)),"xyz"!==a&&"highlight"!==a||!h||(_=_&&F.closeToArray(h,[parseFloat(p.lx),parseFloat(p.ly),parseFloat(p.lz)],WS.PanoramaView.EPS_POS)),a){case"free":if("p"!==s&&(d.cx=t[0].toFixed(5),d.cy=t[1].toFixed(5),d.cz=t[2].toFixed(5)),d.p=n.toFixed(5),d.t=o.toFixed(5),_=_&&F.closeToAngles(i,[parseFloat(p.p),parseFloat(p.t)],WS.PanoramaView.EPS_ANGLES))return;this._url.setFragment(this._id,this._url.encode(d),["p"],e);break;case"xyz":if(_)return;"p"!==s&&(d.cx=t[0].toFixed(5),d.cy=t[1].toFixed(5),d.cz=t[2].toFixed(5)),d.lx=h[0].toFixed(5),d.ly=h[1].toFixed(5),d.lz=h[2].toFixed(5),this._url.setFragment(this._id,this._url.encode(d),["p"],e);break;case"highlight":var g=l.object;if(d.t=(g.instanceOf(WS.TempMeasurement)?"temp":"")+g._class.toLowerCase(),d.o=g._UUID.toLowerCase(),_=_&&d.t===p.t&&d.o===p.o)return;h&&(d.lx=h[0].toFixed(5),d.ly=h[1].toFixed(5),d.lz=h[2].toFixed(5)),this._url.setFragment(this._id,this._url.encode(d),["p"],e)}}},setFragment:function(e){e.isUnresolved(this._id)&&e.resolve(this._id,e.get(this._id).query,["p"])},applyURL:function(e,t){if(e===this._id){var i=t.get(e),n=this._url.decode(i.query);if("loading"===this._fsm._state||"pending"===this._fsm._state)return void(this._settingService.isWebGlEnabled()&&this._alert.error(this._viewModeCtrl.targetViewMode()===WS.PanoramaView.ViewMode.POINTS?"EM_3D_LOAD":"EM_SCAN_LOAD"));this._fsm.read("reset"),this._fsm._meta.pending=n,this._fsm._meta.rollback="delay",this._visible?(this._fsm.read("delay"),this.loadPending()):this._fsm.read("delay"),this.$scope.dbgStats.show=!!n.stats}}},WS.extend("PanoramaView","View3d"),WS.PanoramaView.defaultMode=WS.ViewBase.Mode.PickAll,WS.PanoramaView.type=WS.Layer.ViewTypes.PANO_VIEW,WS.PanoramaView.idleToFullResFrame=10,WS.PanoramaView.ViewMode={PANO:"pano",POINTS:"points"},WS.PanoramaView.Transition={NONE:!1,LOADING:"loading",SWITCHING_PANO_3D:"switch",ANIMATING:"animating"},WS.PanoramaView.EPS_POS=.005,WS.PanoramaView.EPS_ANGLES=.01,WS.PanoramaView.FAR_DIST={VeryLow:100,Low:200,Medium:300,High:400,VeryHigh:500,Pano:500},WS.PanoramaView.MAX_VISIBILITY={Move:{VeryLow:0,Low:0,Medium:20,High:30,VeryHigh:50},Still:{VeryLow:40,Low:60,Medium:80,High:void 0,VeryHigh:void 0}},WS.PanoShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.pano_vs,WS.shaderSrc.pano_fs)},WS.extend("PanoShaderDesc","BasicShaderDesc"),WS.PanoShaderDesc.ID="PanoShader",WS.SkyboxShaderDesc=function(){WS.BasicShaderDesc.call(this,WS.shaderSrc.pano_vs,WS.shaderSrc.skybox_fs)},WS.extend("SkyboxShaderDesc","BasicShaderDesc"),WS.SkyboxShaderDesc.ID="SkyboxShader",WS.PanoramaMaterial=function(e,t){WS.BlendMaterial.call(this,WS.PanoShaderDesc,!0,!1,!1,[],t),this.setTextureImgUrls(e),this._projMatrix=mat4.create(),this._inverseProjMatrix=mat4.create(),this._alpha=1,this._circleVisible=!0},WS.PanoramaMaterial.prototype={configureShader:function(e){var t=e.getTexture(this.getImage(0));if(!t||!t.isImageUploaded())return!1;var i=e.getTexture(this.getImage(1));if(i&&!i.isImageUploaded())return!1;var n=e.getShaderProgram(this);return n.setAttributeValue("aVertexPosition",e.getGlBuffer(e._geometry._positionBuffer)),n.setUniformValue("uTex0",new WS.TextureValue(t,0)),n.setUniformValue("uTex1",new WS.TextureValue(i?i:t,1)),mat4.multiply(e._camera._camMatrix,e.getModelMatrix(),this._projMatrix),mat4.inverse(this._projMatrix,this._inverseProjMatrix),n.setUniformValue("uBlendFactor0",this._alpha*this._blendFactor),n.setUniformValue("uBlendFactor1",this._alpha*(1-this._blendFactor)),n.setUniformValue("uViewport",e._viewport._dimensions),n.setUniformValue("uProjMatrix",this._inverseProjMatrix),n.setUniformValue("uCircleVisible",this._circleVisible),!0},setPanoramaImages:function(e,t){this.setTextureImgUrls(e),this.setBlendFactor(t)}},WS.extend("PanoramaMaterial","BlendMaterial"),WS.SkyboxMaterial=function(e){WS.ShaderMaterial.call(this,WS.SkyboxShaderDesc,!0,!1,!1,[]),this.setTextureImgUrls([e]),this._inverseProjMatrix=mat4.create(),this._alpha=1},WS.SkyboxMaterial.prototype={configureShader:function(e){var t=e.getTexture(this.getImage(0));if(!t||!t.isImageUploaded())return!1;var i=e.getShaderProgram(this);return i.setAttributeValue("aVertexPosition",e.getGlBuffer(e._geometry._positionBuffer)),i.setUniformValue("uTex",new WS.TextureValue(t,0)),mat4.inverse(e._camera._camMatrixOrigin,this._inverseProjMatrix),i.setUniformValue("uAlpha",this._alpha),i.setUniformValue("uViewport",e._viewport._dimensions),i.setUniformValue("uProjMatrix",this._inverseProjMatrix),!0}},WS.extend("SkyboxMaterial","ShaderMaterial"),WS.GlobeRenderable=function(e){WS.Mesh.call(this,new WS.CenteredQuadGeometry,e),this._activated=!1},WS.GlobeRenderable.prototype={activate:function(){this._activated=!0},deactivate:function(){this._activated=!1},isActive:function(){return this._activated},unload:function(e){e.deleteStorageForRenderableAndMembers(this),this._material.clearTextureImages()},isLoaded:function(){return this._material.hasImages()&&this._material.areImagesLoaded()},setAlpha:function(e){this._material._alpha=e},getAlpha:function(){return this._material._alpha},draw3d:function(e,t){this._activated&&t(this)&&(this.drawMemberRenderables3d(e,t,!0),WS.Mesh.prototype.draw3d.call(this,e,t,!0))}},WS.extend("GlobeRenderable","Mesh"),WS.PanoramaRenderable=function(e,t,i){var n=new WS.PanoramaMaterial(e,t);WS.GlobeRenderable.call(this,n),this._circleImageRenderable=new WS.ScannerCircleImageRenderable,this._circleVisible=!0,this._fullResRenderWorker=void 0,this._renderFullResolutionFrame=!1,this._fullResolutionFrameRendered=!1,this._isRenderingFullResolutionFrame=!1,this._targetFramesPerSecond=WS.PanoramaRenderable.TargetFrameCount,this._circleColor=WS.PanoramaRenderable.CircleColorNormal,this._fullResolutionFrame={cameraMatrix:void 0,width:void 0,height:void 0,data:void 0},this.setDataObject(i),this.showLogo(!i.isVirtual()),this.addToLayer(WS.Layer.LayerIDs.PANO,!0)},WS.PanoramaRenderable.prototype={activate:function(e,t){WS.GlobeRenderable.prototype.activate.call(this),this._fullResolutionFrameRendered=!1,this._material.setPanoramaImages(e,t)},unload:function(e){WS.GlobeRenderable.prototype.unload.call(this,e),this._fullResolutionFrameRendered=!1},calculateRenderTimePerPixel:function(e){var t=e._camera,i=300,n=150,o=mat4.create(t._camMatrix);mat4.inverse(o);var r=e.getMaterialTextures(this._material);if(r&&0!==r.length){var a={widthPanoTexture:r[0].getWidth(),heightPanoTexture:r[0].getHeight(),dataPanoTexture:r[0]._canvasData},s=r.length>1?{widthPanoTexture:r[1].getWidth(),heightPanoTexture:r[1].getHeight(),dataPanoTexture:r[1]._canvasData}:void 0,c={frameX:i,frameY:n,panoTexture0:a,panoTexture1:s,blendFactor:this._material._blendFactor,cameraMatrix:o,dataOut:new Array(i*n*4),circleColor:this._circleColor},l=PanoramaShader.perform(c);return l.time/(i*n)}},calculateNeededScale:function(e,t,i,n){var o=e*t,r=1e3/n,a=i*o,s=Math.sqrt(a/r);return s=Math.ceil(s),(Math.round(e/s)<10||Math.round(t/s)<10)&&s++,s},onViewingModeChange:function(){switch(this._circleImageRenderable.setViewingMode(this._viewingMode),this._viewingMode){case WS.Renderable.ViewingMode.Selected:this._circleColor=WS.PanoramaRenderable.CircleColorActive;break;case WS.Renderable.ViewingMode.Inconsiderable:case WS.Renderable.ViewingMode.Normal:case WS.Renderable.ViewingMode.Highlighted:this._circleColor=WS.PanoramaRenderable.CircleColorNormal}},requestFullResolutionFrame:function(){this._renderFullResolutionFrame=!0,this._fullResolutionFrameRendered=!1},getFullResRenderWorker:function(){if(!this._fullResRenderWorker&&"undefined"!=typeof Worker){var e=this;this._fullResRenderWorker=new Worker(workerPath+"/panoramashaderworker.js"),this._fullResRenderWorker.addEventListener("message",function(t){var i=e._fullResolutionFrame,n=t.data;e._isRenderingFullResolutionFrame=!1,i.data=n.data},!1)}return this._fullResRenderWorker},draw2d:function(e,t){if(this._activated&&t(this)){this.drawMemberRenderables2d(e,t,!0);var i=e._camera,n=e._ctx,o=mat4.multiply(i._camMatrix,e.getModelMatrix(),mat4.create());mat4.inverse(o);var r,a,s=e._viewport;if(!e.areAllTexturesUploaded(this._material)||s.getWidth()<=0||s.getHeight()<=0)return void(this._fullResolutionFrameRendered=!1);this._renderTimePerPixel||(this._renderTimePerPixel=this.calculateRenderTimePerPixel(e));var c=e.getMaterialTextures(this._material);if(c&&0!==c.length){var l={widthPanoTexture:c[0].getWidth(),heightPanoTexture:c[0].getHeight(),dataPanoTexture:c[0]._canvasData},h=c.length>1?{widthPanoTexture:c[1].getWidth(),heightPanoTexture:c[1].getHeight(),dataPanoTexture:c[1]._canvasData}:void 0,d=this._fullResolutionFrame;if(this._renderFullResolutionFrame&&!this._isRenderingFullResolutionFrame){d.cameraMatrix=mat4.create(i._camMatrix),d.height=e._canvasHeight,d.width=e._canvasWidth,this._isRenderingFullResolutionFrame=!0,this._fullResolutionFrameRendered=!1;var u={frameX:d.width,frameY:d.height,panoTexture0:l,panoTexture1:h,blendFactor:this._material._blendFactor,cameraMatrix:o,circleColor:this._circleColor},p=this.getFullResRenderWorker();if(p)p.postMessage(u);else{e.setCanvasScaleFactor(1),e.setViewPortDimensions(e._canvasWidth,e._canvasHeight),r=n.getImageData(0,0,s.getWidth(),s.getHeight()),u.dataOut=r.data;var _=PanoramaShader.perform(u);d.data=_.data,this._isRenderingFullResolutionFrame=!1}this._renderFullResolutionFrame=!1}if(d&&d.data&&!this._isRenderingFullResolutionFrame&&mat4.equal(d.cameraMatrix,i._camMatrix)&&d.width===e._canvasWidth&&d.height===e._canvasHeight&&!i._dirty)this._fullResolutionFrameRendered=!0,a=d.data,e.setCanvasScaleFactor(1),e.setViewPortDimensions(e._canvasWidth,e._canvasHeight),r=n.getImageData(0,0,s.getWidth(),s.getHeight());else{var g=this.calculateNeededScale(e._canvasWidth,e._canvasHeight,this._renderTimePerPixel,this._targetFramesPerSecond);e.setCanvasScaleFactor(g),e.setViewPortDimensions(Math.floor(e._canvasWidth/g),Math.floor(e._canvasHeight/g)),r=n.getImageData(0,0,s.getWidth(),s.getHeight()),this._fullResolutionFrameRendered=!1;var f={frameX:e._viewport.getWidth(),frameY:e._viewport.getHeight(),panoTexture0:l,panoTexture1:h,blendFactor:this._material._blendFactor,cameraMatrix:o,dataOut:r.data,circleColor:this._circleColor},m=PanoramaShader.perform(f);a=m.data}if(r.data!==a)if(r.data.set)r.data.set(a);else{var v=0,S=r.data,b=S.length;for(v=0;b>v;v++)S[v]=a[v]}n.putImageData(r,0,0)}}},getVisibleMemberRenderables:function(){return this._circleVisible?[this._circleImageRenderable]:[]},getMemberRenderables:function(){return[this._circleImageRenderable]},setBlendFactor:function(e){this._material._blendFactor=e},showLogo:function(e){this._circleVisible=e,this._material._circleVisible=e}},WS.extend("PanoramaRenderable","GlobeRenderable"),WS.PanoramaRenderable.TargetFrameCount=30,WS.PanoramaRenderable.CircleColorNormal=[255,255,255],WS.PanoramaRenderable.CircleColorActive=[160,220,246],WS.SkyboxRenderable=function(e){var t=new WS.SkyboxMaterial(e);WS.GlobeRenderable.call(this,t),this._UUID=F.generateUUID(),this.addToLayer(WS.Layer.LayerIDs.PANO,!0)},WS.SkyboxRenderable.prototype={draw2d:function(){}},WS.extend("SkyboxRenderable","GlobeRenderable"),WS.PanoSettingService=function(e,t){WS.PlugModule.call(this,e),this._cookie=t,this._cookieId="panosettings",this._settings=new WS.PanoSettings(10,2,"color",WS.PanoSettings.IconModes.Category,.6,!0,!0,!0,!1,WS.PanoSettings.Detail3d.AUTOMATIC,!0,this),this.getFromLocalStorage(this._settings),this.provideMalePlug("SettingsUpdate",["updateSettings"])},WS.PanoSettingService.prototype={getNew:function(e,t,i,n,o,r,a,s,c,l){return new WS.PanoSettings(e,t,i,n,o,r,a,s,c,l,this)},getAll:function(){var e=this._settings.clone(),t=Q.defer();return t.resolve([e]),t.promise},getByPrimaryKey:function(){var e=this._settings.clone(),t=Q.defer();return t.resolve(e),t.promise},update:function(e){var t=Q.defer();e.applyUpdate();var i=e.clone();return this._settings=i,this._settings.writeToLocalStorage(),t.resolve(),this.trigger("updateSettings",["panorama",e]),t.promise},writeToLocalStorage:function(e){var t={movementSpeed:e._movementSpeed,imageResolutionIndex:e._imageResolutionIndex,colorMode:e._colorMode,iconMode:e._iconMode,blendFactor:e._blendFactor,enableWebGl:e._enableWebGl,showCompass:e._showCompass,showScanLabelsInPano:e._showScanLabelsInPano,showOrthoVolumes:e._showOrthoVolumes,details3d:e._details3d,showPolylines:e._showPolylines};this._cookie.setLocalStorageItem(this._cookieId,JSON.stringify(t))},getFromLocalStorage:function(e){var t=JSON.parse(this._cookie.getLocalStorageItem(this._cookieId));t&&(e._movementSpeed=t.movementSpeed,e._imageResolutionIndex=Math.min(t.imageResolutionIndex,WS.Scan.DeviceMaxResolutionIdx),e._colorMode=t.colorMode,e._iconMode=t.iconMode,e._blendFactor=t.blendFactor,"boolean"==typeof t.enableWebGl&&(e._enableWebGl=t.enableWebGl),"boolean"==typeof t.showCompass&&(e._showCompass=t.showCompass),"boolean"==typeof t.showScanLabelsInPano&&(e._showScanLabelsInPano=t.showScanLabelsInPano),"boolean"==typeof t.showOrthoVolumes&&(e._showOrthoVolumes=t.showOrthoVolumes),"string"==typeof t.details3d&&(e._details3d=t.details3d),"boolean"==typeof t.showPolylines&&(e._showPolylines=t.showPolylines))},getPrefferedImageWidth:function(){return this._settings.getPanoImageResolution()._width},getPrefferedColorMode:function(){return this._settings.getColorMode()},getMovementSpeed:function(){return this._settings._movementSpeed},isWebGlEnabled:function(){return F.isWebGlAvailable()&&this._settings._enableWebGl},invertX:function(e){return e.isIn3dMode()?1:-1},invertY:function(e){return e.isIn3dMode()?1:-1},details3d:function(){return this._settings.details3d()}},WS.extend("PanoSettingService","PlugModule"),WS.PickAllListener=function(e,t,i,n){WS.PickObjectListener.call(this,e,WS.PickObjectListener.SelectionMode.Menu,t,i),this._point3dService=n},WS.PickAllListener.prototype={onPickPoint:function(e,t,i,n){this._view.hideRadialMenu();var o=new WS.Point3d(i,[e,t],this.getRefSystem(),this._view,n);this._point3dService.setPoint(o)}},WS.extend("PickAllListener","PickObjectListener"),WS.PickPointOpenScansListener=function(e,t,i){WS.PickObjectListener.call(this,e,WS.PickObjectListener.SelectionMode.Menu,t,i)},WS.PickPointOpenScansListener.prototype={onPickPoint:function(e,t,i,n){var o=new WS.Point3d(i,[e,t],this.getRefSystem(),this._view,n);this._view.trigger("pickPoint",[o])}},WS.extend("PickPointOpenScansListener","PickObjectListener"),WS.PanoMoveHandler=function(e,t,i){WS.MoveHandler.call(this,e,t,i)},WS.PanoMoveHandler.prototype={onDragMove:function(e,t,i,n){var o=i-e,r=n-t,a=this.determineRotationDeltas(o,r);if(0!==a[0]){var s=this._settingService.invertX(this._camera);this._camera.rotateHorizontally(s*a[0])}if(0!==a[1]){var c=this._settingService.invertY(this._camera);this._camera.rotateVertically(c*a[1])}return!0}},WS.extend("PanoMoveHandler","MoveHandler"),angular.module("ws.panoramaview",[]),F.DI().config("@task","@alert","@project","@pointcloud","@panosettings",function(e,t,i,n,o){this.registerParameter("panomenu",{evaluate:{edit:function(t){return!t._writeLock&&!t._temporary&&("Annotation"===t._class||"Measurement"===t._class||"Scan"===t._class||"Orthophoto"===t._class)&&e.taskExists("default","panoramaview","edit")},remove:function(t){return!t._writeLock&&("Annotation"===t._class||"Measurement"===t._class||"Orthophoto"===t._class)&&e.taskExists("default","panoramaview","remove")},showproperties:function(e){return"Annotation"===e._class||"Measurement"===e._class||"Scan"===e._class||"Orthophoto"===e._class},panorama:function(e){return i.canShowObjectInPano(e)},view3d:function(e){return o.isWebGlEnabled()?n.canShowObjectIn3d(e):!1},map:function(e){return i.canShowObjectInMap(e)},switchsegments:function(e){return"Measurement"===e._class&&"Distance"===e._displayType},share:function(t){return!t._writeLock&&!t._temporary&&("Annotation"===t._class||"Measurement"===t._class||"Scan"===t._class||"Orthophoto"===t._class)&&e.taskExists("default","panoramaview","share")}},execute:{edit:function(e){e.select(),window.pv.trigger("launchTask",["default","panoramaview","edit"])},remove:function(e){return e.remove()},showproperties:function(e){window.pv.trigger("showObjects",[[e],"properties"])},panorama:function(e){switch(e._class){case"Scan":window.pv.trigger("showObjects",[[e],"panorama"]);break;case"Annotation":case"Measurement":case"Orthophoto":window.pv.trigger("focusOn",[{object:e},"panorama"])}},view3d:function(e){switch(e._class){case"Scan":window.pv.trigger("showObjects",[[e],"3d"]);break;case"Annotation":case"Measurement":case"Orthophoto":window.pv.trigger("focusOn",[{object:e},"3d"])}},map:function(e){window.pv.trigger("focusOn",[{object:e},"map"])},switchsegments:function(e){var t=window.pv.getRenderable(e);t&&t.switchSegmentMode()},share:function(e){e.select(),window.pv.trigger("launchTask",["default","panoramaview","share"])},unhighlight:function(e){window.pv.unhighlight(e)}},error:function(e){t.errorObj(e)}})}),F.DI().registerController("panoramaview",WS.PanoramaView,"@plug","@url","@selection","@alert","@project","@scan","@annotation","@measurement","@tempmeasurement","@orthophoto","@temporthophoto","@panosettings","@domainsettings","@login","@unit","@distance","@locale","@point3d","@layer","@mapobject","@pointcloud"),F.DI().registerController("viewmodectrl",WS.ViewModeCtrl,"@pointcloud","@panosettings","@plug"),F.DI().registerService("panosettings",WS.PanoSettingService,"@plug","@cookie"),F.DI().config("@task",WS.panoramaConfigTask=function(e){e.registerTaskFactory("default","settings","editpanosettings",WS.EditPanoSettingsTask,"@plug","@unit","@locale")}),F.DI().config(function(){var e=!1,t=!1,i=function(){return window.pv._pointsRenderable},n=function(){window.pv._camera._dirty=!0};window.LOD={object:function(){var e=i();return e?e._dataObject:void 0},renderable:function(){return i()},visLOD:function(){t?e?t=!1:e=!0:e?e=!1:t=!0;var o=i();o&&o.instanceOf(WS.PointCloudRenderable)&&(o.dbgShowLod(e),o.dbgShowBBoxes(t),n())},stats:function(){var e=window.pv.$scope.dbgStats;window.pv.$scope.$apply(function(){e.show=!e.show})},camFreeze:function(){var e=i();if(e){var t=window.pv,n=t._camera;e._dbgFreezeCam=new WS.PerspectiveCamera,e._dbgFreezeCam.copyFrom(t._camera),t.addRenderable(new WS.CameraRenderable(t)),n.setNearAndFarPlane(void 0,n._far+1e3)}},camUnfreeze:function(){var e=i();if(e){var t=window.pv,n=t._camera;n.setNearAndFarPlane(void 0,n._far-1e3);for(var o=t.getAllRenderables(),r=0,a=o.length;a>r;++r)if(o[r]instanceof WS.CameraRenderable){t.removeRenderable(o[r]);break}e._dbgFreezeCam=void 0}},camReset:function(){var e=i();if(e){var t=window.pv,n=t._camera,o=n._far;n.copyFrom(e._dbgFreezeCam),n.setNearAndFarPlane(void 0,o)}},moveNormal:function(){var e=i();e&&(e._dbgMove=0)},moveAlways:function(){var e=i();e&&(e._dbgMove=1)},moveNever:function(){var e=i();e&&(e._dbgMove=2)},printNodes:function(){var e=i();e&&(e._debugDlVisNodes=!0)},setDepthRange:function(e,t){var o=i();o&&(o._minDepth=e,o._maxDepth=t,n())},setBestNodes:function(e){var t=i();t&&(t._bestNodes=e,n())},setSubTree:function(e){var t=i();t&&(t._dbgSubtree=e,n())},showFrameBuffer:function(e){var t=i();t&&(t._occlusionFrameBuffer._dbgImage=void 0!==e?e:!0)},gapFiller:function(e){var t=i();t&&(t.useIncrRendering=e?WS.PointCloudRenderable.prototype.useIncrRendering:function(){return!1
},window.pv._renderer[0]._dbgGapFillAll=2===e,n())}}}),angular.module("ws.panoramaview").directive("panoramaview",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("panoramaview"),link:function(e,t){var i=e.ctrl,n=t.find("canvas");i.setCanvas(n),i.createRenderers(),e.$on("ws_connect",function(e,t){e.stopPropagation(),i.setViewModeCtrl(t)})},templateUrl:WS.partialUrl("panoramaview.html")})}),angular.module("ws.panoramaview").directive("viewmodectrl",function(){return{restrict:"E",replace:!1,controller:F.DI().getAngularController("viewmodectrl"),link:function(e){e.$emit("ws_connect",e._ctrl)},scope:{changeViewMode:"&",small:"="},templateUrl:WS.partialUrl("viewmodectrl.html")}}),WS.EditPanoSettingsTask=function(e,t,i){WS.Task.call(this,e),this._unit=t,this._locale=i,this._description=[{caption:"TC_PANO_SETTINGS",optional:!0,description:"TD_PANO_SETTINGS",selectPageClass:"panosettings",completeCondition:"areLayerVisibilityThresholdsValid()",female:"ObjectEdit",pinBinding:"editObject(input.data)",widget:'<p ng-show="anyUnsavedChanges()"><b>{{"TD_CHANGES"|i18n}}:</b></p><ul><li ng-show="input.data.settings._changes._imageResolutionIndex != input.data.settings._imageResolutionIndex">{{formatImageResolutionOutput( input.data.settings._changes._imageResolutionIndex)}}</li><li ng-show="input.data.settings._changes._colorMode != input.data.settings._colorMode">{{formatColorMode(input.data.settings._changes._colorMode)}}</li><li ng-show="input.data.settings._changes._iconMode != input.data.settings._iconMode">{{formatIconMode(input.data.settings._changes._iconMode)}}</li><li ng-show="input.data.settings._changes._movementSpeed!= input.data.settings._movementSpeed">{{ formatMovementSpeed(input.data.settings._changes._movementSpeed)}}</li><li ng-show="input.data.settings._changes._blendFactor!= input.data.settings._blendFactor">{{ formatBlendFactor(input.data.settings._changes._blendFactor)}}</li><li ng-show="input.data.settings._changes._showCompass!= input.data.settings._showCompass">{{ formatShowCompass(input.data.settings._changes._showCompass)}}</li><li ng-show="input.data.settings._changes._showScanLabelsInPano !== input.data.settings._showScanLabelsInPano">{{ formatShowScanLabels(input.data.settings._changes._showScanLabelsInPano)}}</li><li ng-show="input.data.settings._changes._showPolylines !== input.data.settings._showPolylines">{{"FE_ANNOTATION" | i18n}} {{ formatShowPolylines(input.data.settings._changes._showPolylines)}}</li><li ng-show="input.data.settings._changes._showOrthoVolumes !== input.data.settings._showOrthoVolumes">{{"FE_ORTHOPHOTO" | i18n}} {{ formatShowOrthoVolumes(input.data.settings._changes._showOrthoVolumes)}}</li><li ng-show="input.data.settings._changes._details3d !== input.data.settings._details3d">{{"FE_3D_DETAILS" | i18n}}: {{ formatDetails3d(input.data.settings._changes._details3d)}}</li><li ng-repeat="layer in input.data.layers" ng-show="layer.hasUnsavedChanges()">{{layer.getName() | i18n}}<ul><li ng-show="layer._changes._visible != layer._visible">{{formatLayerVisibilityOutput(layer._changes._visible)}}</li><li ng-show="(layer._changes._visibleDistanceThresEnabled != layer._visibleDistanceThresEnabled) ||(layer._changes._visibleDistanceThres != layer._visibleDistanceThres)">{{formatLayerVisibilityThresOutput(layer._changes._visibleDistanceThresEnabled, layer._changes._visibleDistanceThres)}}</li></ul></li><li ng-show="input.data.settings._changes._enableWebGl != input.data.settings._enableWebGl">{{formatWebGlEnabled(input.data.settings._changes._enableWebGl)}}</li></ul>',icon:WS.Icons.TaskSection.configure}]},WS.EditPanoSettingsTask.prototype={setup:function(e){var t=this._unit,i=this._locale;e.formatLayerVisibilityOutput=function(e){return void 0===e?"":i.translate(e?"FE_VISBLE":"FE_INVISBLE")},e.formatLayerVisibilityThresOutput=function(e,n){if(void 0===e&&void 0===n)return"";var o=t.getLengthAndUnit(n,0);return e?i.translateAndCompose("FE_PANO_SET_LIMIT_VIS_CHNG",[o]):i.translate("FE_PANO_SET_NOLIMIT_VIS_CHNG")},e.formatImageResolutionOutput=function(e){if(void 0===e)return"";var t=WS.PanoSettings.Resolutions[e];return i.translateAndCompose("FE_PANO_SET_IMAGE_CHANGE",[i.translate(t.getName())])},e.formatColorMode=function(e){if(void 0===e)return"";var t=WS.PanoSettings.ColorModes[e];return i.translateAndCompose("FE_PANO_SET_CMODE_CHANGE",[i.translate(t.getName())])},e.formatIconMode=function(e){return void 0===e?"":i.translateAndCompose("FE_ICONMODE_CHANGE",[i.translate(WS.PanoSettings.IconModeNames[e])])},e.formatMovementSpeed=function(e){return void 0===e?"":(e=5*e+"%",i.translateAndCompose("FE_PANO_SET_MSPD_CHANGE",[e]))},e.formatBlendFactor=function(e){if(void 0===e)return"";e=100*e;var t=i.translate("FE_COLOR"),n=i.translate("FE_GRAY");return e+"% "+t+" | "+(100-e)+"% "+n},e.formatWebGlEnabled=function(e){if(void 0===e)return"";var t=i.translate(e?"FE_ENABLED":"FE_DISABLED"),n=i.translateAndCompose("FE_PANO_SET_WEBGL_CHANGE",[t]);return n},e.formatShowCompass=function(e){if(void 0===e)return"";var t=i.translate(e?"FE_ENABLED":"FE_DISABLED"),n=i.translateAndCompose("FE_PANO_SET_COMPASS_CHANGE",[t]);return n},e.formatShowScanLabels=function(e){if(void 0===e)return"";var t=i.translate("FE_SCAN_NAME"),n=i.translate(e?"FE_ENABLED":"FE_DISABLED");return t+": "+n},e.formatShowOrthoVolumes=function(e){var t=i.translate("FE_VOLUME"),n=i.translate(e?"FE_VISBLE":"FE_INVISBLE");return t+": "+n},e.formatShowPolylines=function(e){var t=i.translate("AN_AREA"),n=i.translate(e?"FE_VISBLE":"FE_INVISBLE");return t+": "+n},e.formatDetails3d=function(e){var t,n;return e&&(t=WS.PanoSettings.details3dStringID(e),n=i.translate(t),e===WS.PanoSettings.Detail3d.AUTOMATIC&&(t=WS.PanoSettings.details3dStringID(WS.PanoSettings.autoDetails3d()),n+=" ("+i.translate(t)+")")),n},e.anyUnsavedChanges=function(){var t=e.input?e.input.data:void 0,i=t?t.layers:void 0,n=t?t.settings:void 0;if(i)for(var o=0,r=i.length;r>o;o++)if(i[o].hasUnsavedChanges())return!0;return n&&n.hasUnsavedChanges()?!0:!1},e.areLayerVisibilityThresholdsValid=function(){var t=e.input?e.input.data:void 0,i=t?t.layers:void 0,n=0;if(i)for(var o=0,r=i.length;r>o;o++)if(n=i[o]._changes._visibleDistanceThres,n&&F.validateNumber(n))return!1;return!0}},execute:function(e){var t=Q.defer(),i=e?e.data:void 0,n=i?i.layers:void 0,o=i?i.settings:void 0;if(n)for(var r=0,a=n.length;a>r;r++)n[r].update();return o&&(o._changes&&o._changes._iconMode&&(o._changes._iconMode=parseInt(o._changes._iconMode)),o.update()),t.resolve(),t.promise},teardown:function(){this._result._navigateTo=this._argument._lastPage},queryTaskLaunch:function(e,t,i){return e==this._panel&&t==this._category.id&&i==this._id}},WS.extend("EditPanoSettingsTask","Task"),WS.PointCloud=function(e){F.Transformation.call(this,e),this._pointCloudService=e,this._pointLoader=new WS.PointLoader(e,this),this._treeStructure=void 0,this._treeStructurePromise=void 0,this._treeStructureRequested=!1,this._class="WSPointCloud",this._description=void 0,this._hyperlinks=[],this._creationTime=void 0,this._type=void 0,this._sourceUUIDs=void 0,this._sourceTypes=void 0,this._sourceRevisions=void 0,this._inputMin=void 0,this._inputMax=void 0,this._colorRatio=void 0,this._homogenization=void 0,this._resolution=void 0,this._state=void 0,this._dataMin=void 0,this._dataMax=void 0,this._points=void 0,this._depth=void 0,this._lodDepth=void 0,this._splitFactor=void 0,this._formatVersion=void 0,this._builderVersion=void 0,this._entityUUIDs=void 0},WS.PointCloud.prototype={readJson:function(e){F.Transformation.prototype.readJson.call(this,e),this.readHyperlinksJson(e),this._description=e.Description,this._creationTime=e.CreationTime,this._type=e.Type,this._sourceUUIDs=e.SourceUUIDs,this._sourceTypes=e.SourceTypes,this._sourceRevisions=e.SourceRevisions,this._inputMin=e.InputMin,this._inputMax=e.InputMax,this._colorRatio=e.ColorRatio,this._homogenization=e.Homogenization,this._resolution=e.Resolution,this._state=e.State,this._dataMin=e.DataMin,this._dataMax=e.DataMax,this._points=e.Points,this._depth=e.Depth,this._lodDepth=e.LodDepth,this._splitFactor=e.SplitFactor,this._formatVersion=e.FormatVersion,this._builderVersion=e.BuilderVersion,this._entityUUIDs=e.EntityUUIDs||void 0},writeJson:function(){var e=F.Transformation.prototype.writeJson.call(this);return this.writeHyperlinksJson(e),e.Class=this._class,e.Description=this._description,e.CreationTime=this._creationTime,e.Type=this._type,e.SourceUUIDs=this._sourceUUIDs,e.SourceTypes=this._sourceTypes,e.SourceRevisions=this._sourceRevisions,e.InputMin=this._inputMin,e.InputMax=this._inputMax,e.ColorRatio=this._colorRatio,e.Homogenization=this._homogenization,e.Resolution=this._resolution,e},writeChanges:function(){var e=F.Transformation.prototype.writeChanges.call(this);return this.writeHyperlinksChanges(e)},createRenderable:function(e){return new WS.PointCloudRenderable(this,e,e._settingService.details3d())},canBeShownInView:function(e){return"panorama"===e||"3d"===e},processNodes:function(e){for(var t={},i=0,n=e.length;n>i;i++)t[e[i]._shortID]=e[i];return t},getTreeStructure:function(){return this._treeStructure?this._treeStructure:void(this._treeStructureRequested||this.getTreeStructureAsync())},getTreeStructureAsync:function(){if(!this._treeStructurePromise){this._treeStructureRequested=!0;var e=this;this._treeStructurePromise=this._pointCloudService.getPointCloudNodes(this._UUID).then(function(t){e._treeStructure=e.processNodes(t)})}return this._treeStructurePromise},unloadTreeStructure:function(){this._treeStructure=void 0,this._treeStructurePromise=void 0,this._treeStructureRequested=!1},getFirstNonEmptyNode:function(){for(var e=this._treeStructure,t="r",i=e[t];!i._points;)t+="0",i=e[t];return i},calcDefaultCamera:function(){var e,t=.5,i=.8,n=1.25,o=10,r=130;if(this._treeStructure){var a=this.getFirstNonEmptyNode();a&&a._nodeInfo.positionArray&&(e=a.calcCoordQuantiles([t,i]))}if(!e){var s=this.getTranslationGlobal(),c=vec3.scale([.667,-.667,.333],o),l=vec3.add(s,c,vec3.create());return{camPos:l,lookAt:s}}var h=vec3.create(e[0]),d=vec3.create(e[1]),u=n*vec3.dist(h,d);u=Math.max(Math.min(u,r),o);var p=.667*u,_=vec3.create([p,-p,.5*p]);return vec3.add(_,h,d),mat4.multiplyVec3(this._trafoGlobal,d),mat4.multiplyVec3(this._trafoGlobal,h),{camPos:d,lookAt:h}}},WS.extend("PointCloud","Transformation"),WS.mixin("PointCloud","HyperlinkedObject"),WS.PointCloud.State={COMPLETE:"complete",PENDING:"pending"},WS.PointCloud.Type={ENTITYPC:"EntityPC",PROJECT:"Project",SCAN:"Scan"},WS.PointCloud.ScanType={SCAN:"Scan",VIRTUAL:"Virtual",PHOTO:"Photo"},WS.PointCloud.ColorRatio={DEFAULT:100,MIN:0,MAX:100},WS.PointCloud.Homogenization={DEFAULT:.001,MIN:1e-4,MAX:1},WS.PointCloudNode=function(){this._class="PointCloudNode",this._ID=void 0,this._points=void 0,this._min=void 0,this._max=void 0,this._q=void 0,this._version,this._builderVersion,this._compression,this._homogenization,this._depth,this._lodDepth,this._splitFactor,this._trafoGlobal,this._shortID=void 0,this._nodeInfo=new WS.NodeInfo},WS.PointCloudNode.prototype={readJson:function(e){this._class=e.Class,this._ID=e.ID,this._shortID=WS.PointCloudNode.getShortID(e.ID),this._points=e.Points,this._min=e.Min,this._max=e.Max,this._q=e.Q,"rt"===this._ID&&(this._version=e.Version,this._builderVersion=e.BuilderVersion,this._compression=e.Compression,this._homogenization=e.Homogenization,this._depth=e.Depth,this._lodDepth=e.LodDepth,this._splitFactor=e.SplitFactor,this._trafoGlobal=e.TransformationGlobal)},writeJson:function(){},getCenter:function(){return[(this._min[0]+this._max[0])/2,(this._min[1]+this._max[1])/2,(this._min[2]+this._max[2])/2]},calcCoordQuantiles:function(e){return F.calcQuantilesKd(this._nodeInfo.positionArray,e,3)}},WS.extend("PointCloudNode"),WS.PointCloudNode.getShortID=function(e){for(var t="",i=0;i<e.length;i+=2){var n=i>0?i+1:i;t+=e.charAt(n)}return t},WS.PointCloudNode.MIN_PTS=3e4,WS.PointCloudNode.MAX_PTS=6e4,WS.PointCloudService=function(e,t,i,n,o,r,a,s,c,l){F.ProjectCRUDService.call(this,"PointCloud",WS.PointCloud,"/pointcloud",{},e,t,i,n,o,r,a,s,c);this._nodesClient=this._resource("/pointcloudnode/:project/:uuid",{},{readAll:{method:"GET",params:{},isArray:!0}}),this._workerLauncher=new WS.WorkerLauncher(window.workerPath+"/pointloaderworker.js"),this._binaryBaseUrl="",this._CDN=l,l.hasCDN()&&i.subscribe("change",function(){var e=i.getCurrent();l.loadSignature(e)})},WS.PointCloudService.prototype={getAll:function(e,t,i){return WS._2GO?Q.resolve([]):WS.ProjectCRUDService.prototype.getAll.call(this,e,t,i)},getAllEnabled:function(e){var t=this;return this._project.getCurrentProject().then(function(i){return i._enable3D?t.getAll(void 0,void 0,e):[]})},getAllEnabledCompleted:function(e){return this.getAllEnabled(e).then(function(e){return e.filter(function(e){return"complete"===e._state})})},getByIDEnabled:function(e,t){if(void 0===e)return Q.resolve(void 0);var i=this;return this._project.getCurrentProject().then(function(n){return n._enable3D?i.getByID(e,t,!0):void 0})},getByID:function(e,t,i){return void 0===e||WS._2GO?Q.resolve(void 0):F.ProjectCRUDService.prototype.getByID.call(this,e,t,i)},getAllForScan:function(e){return this.getAllEnabled().then(function(t){return t.filter(function(t){return-1!==t._sourceUUIDs.indexOf(e)})})},getBestForScan:function(e,t){return this.getAll().then(function(i){var n=function(e,t){return t._sourceUUIDs.length-e._sourceUUIDs.length},o=i.filter(function(i){return"complete"===i._state&&(!t||i._type===t)&&-1!==i._sourceUUIDs.indexOf(e)});return o.length>0?o.sort(n)[0]:i.filter(function(e){return"complete"===e._state}).sort(n)[0]})},getBestForCoords:function(e,t){return this.getAllEnabled().then(function(i){var n={},o={},r=i.filter(function(e){return"complete"===e._state&&(!t||e._type===t)});i=r[0]?r:i.filter(function(e){return"complete"===e._state}),i.forEach(function(t){var i=mat4.invertOrtho(t._trafoGlobal,mat4.create()),r=mat4.multiplyVec3(i,e,vec3.create()),a=t._UUID,s=t._dataMin,c=t._dataMax,l=vec3.lerp(s,c,.5,vec3.create());n[a]=r[0]>s[0]&&r[0]<c[0]&&r[1]>s[1]&&r[1]<c[1]&&r[2]>s[2]&&r[2]<c[2]?1:0,o[a]=vec3.dist(l,r)});var a=function(e,t){return n[e._UUID]!==n[t._UUID]?n[t._UUID]-n[e._UUID]:o[e._UUID]-o[t._UUID]};return i.sort(a)[0]})},getBestForObject:function(e,t){var i;if(e.instanceOf(WS.Scan))return this.getBestForScan(e._UUID,t);if(e.instanceOf(WS.Annotation))i=e._pointScans||[e._parentUUID];else if(e.instanceOf(WS.Measurement))i=e._pointScans||[e._parentUUID];else{if(!e.instanceOf(WS.Orthophoto))return Q.resolve(void 0);i=e._scanUUIDs}var n=this.compareByMatchAndSize(i);return this.getAllEnabled().then(function(e){var i=e.filter(function(e){return"complete"===e._state&&(!t||e._type===t)}).sort(n);return i[0]?i[0]:e.filter(function(e){return"complete"===e._state}).sort(n)[0]})},compareByMatchAndSize:function(e){return function(t,i){var n=0,o=0;return e.forEach(function(e){n+=t._sourceUUIDs.indexOf(e)>=0?1:0,o+=i._sourceUUIDs.indexOf(e)>=0?1:0}),n!==o?o-n:i._sourceUUIDs.length-t._sourceUUIDs.length}},canShowObjectIn3d:function(e){var t=this;return e.canBeShownInView("3d")?this.getDefaultPointCloud().then(function(e){return e?!0:t.isSimple3dEnabled()}):Q.resolve(!1)},getProjectPointCloud:function(e){var t=this;return this.getAllEnabled().then(function(i){var n=i.filter(function(e){return"complete"===e._state&&(e._type===WS.PointCloud.Type.PROJECT||e._type===WS.PointCloud.Type.ENTITYPC)});return 0<n.length?n[0]:e?t.getBestForScan(e):void 0})},getLatestPointCloud:function(e){var t=this;return this.getAllEnabled().then(function(i){var n=i.filter(function(e){return"complete"===e._state}).sort(function(e,t){var i=e._creationTime,n=t._creationTime;return n>i?1:i>n?-1:0});return 0<n.length?n[0]:e?t.getBestForScan(e):void 0})},getDefaultPointCloud:function(e){return this.getLatestPointCloud(e)},getScanPointCloud:function(e,t){var i=this;return this.getAllForScan(e).then(function(n){var o=n.filter(function(e){return"complete"===e._state&&"Scan"===e._type});return 0<o.length?o[0]:t?i.getBestForScan(e):void 0})},getForScan:function(e,t,i){return"Project"===t||"EntityPC"===t?this.getProjectPointCloud(e):"Scan"===t?this.getScanPointCloud(e,!0):"ScanCloud"===t?Q.resolve(void 0):this.getBestForScan(e,i)},getForFocusedObject:function(e,t,i,n,o){var r=this;return this.getByIDEnabled(t).then(function(e){return e},function(){return void 0}).then(function(e){return e?e:i?r.getForScan(i,n,o):void 0}).then(function(t){return t?t:r.getBestForObject(e,o)})},hasProjectPointCloud:function(){return this.getProjectPointCloud().then(function(e){return!!e},function(){return!1})},hasScanPointCloud:function(e){return this.getScanPointCloud(e).then(function(e){return!!e},function(){return!1})},isSimple3dEnabled:function(){return this._project.getCurrentProject().then(function(e){return!(!e._simple3DEnabled||!e._enable3D)},function(){return!1})},getPointCloudNodes:function(e){var t=this,i=Q.defer(),n={project:this._project.getCurrent(),uuid:e};return this._nodesClient.readAll(n,function(e){i.resolve(e.map(F.proxy(t._serializer.read,t._serializer)))},this._error.restHandler(i)),i.promise},getNodeBinary:function(e,t){var i,n=e._UUID,o=e._entityUUIDs&&e._entityUUIDs[0],r=this._project.getCurrent();this._CDN.hasCDN()&&(i=this._CDN.getSignature(r,!0));var a;if(i&&!Q.isPromise(i)){var s=this._CDN.getSource(i,F.crc32(t));a=o?s.BaseURL+r+"/entity/"+o+"/"+t+".ptu"+s.Query:s.BaseURL+r+"/wspointclouds/"+n+"/"+t+".ptu"+s.Query}else a=o?this._binaryBaseUrl+"/entity/"+r+"/"+o+"/data/blob/"+t+".ptu":this._binaryBaseUrl+"/data/project/"+r+"/pointcloud/"+n+"/"+t;var c={pointCloud:n,nodeName:t,url:a};this._workerLauncher.runWorker(c)}},WS.extend("PointCloudService","ProjectCRUDService"),WS.PointLoader=function(e,t){this._service=e,this._pc=t,this._addedNodes=!1,this._nodesInMemory=0,this._pointsInMemory=0,this._loadedNodes={},this._deferredNodes={},this._maxPointsInMemory=WS.PointLoader.MAX_POINTS_IN_MEMORY[WS.PanoSettings.Detail3d.VERY_HIGH],this._requestedNodes=[],this._requestedPoints=0;var i=this;this._func=function(e){i.completeRequest(e.data)},this.addAsListener()},WS.PointLoader.prototype={loadNodeBinary:function(e){var t=this._requestedNodes;if(!(WS.PointLoader.MAX_PARALLEL_REQUESTS<=t.length||-1<t.indexOf(e)||e._nodeInfo.failed)){t.push(e),this._requestedPoints+=e._points;try{this._service.getNodeBinary(this._pc,e._ID)}catch(i){t.pop(),this._requestedPoints-=e._points}}},loadNodeBinaryAsync:function(e){var t=e._shortID,i=this._deferredNodes[t];return i||(i=this._deferredNodes[t]=Q.defer(),this._loadedNodes[t]?i.resolve():e._nodeInfo.failed?i.reject():this.loadNodeBinary(e)),i.promise},completeRequest:function(e){if(e.request.pointCloud===this._pc._UUID){var t=F.removeFirst(this._requestedNodes,function(t){return t._ID===e.request.nodeName}),i=t&&t._shortID;if(!e.loaded)return void(t&&(t._nodeInfo.failed=!0,this._requestedPoints-=t._points,this._deferredNodes[i]&&this._deferredNodes[i].reject()));if(t){var n=t._nodeInfo;for(var o in e)"request"!==o&&(n[o]=e[o]);this._nodesInMemory++,this._pointsInMemory+=t._points,this._requestedPoints-=t._points,this._loadedNodes[i]=t,this._deferredNodes[i]&&this._deferredNodes[i].resolve(),this._addedNodes=!0}}},unloadNode:function(e){this._nodesInMemory--,this._pointsInMemory-=e._nodeInfo.numPoints,delete this._loadedNodes[e._shortID]},unloadAll:function(){for(var e in this._deferredNodes)this._deferredNodes[e].promise.isPending()&&this._deferredNodes[e].reject(),delete this._deferredNodes[e];this.cancelRequests(),this._nodesInMemory=0,this._pointsInMemory=0,this._addedNodes=!1,this._loadedNodes={}},addAsListener:function(){this._service._workerLauncher.addListener(this._func)},removeAsListener:function(){this._service._workerLauncher.removeListener(this._func)},cancelRequests:function(){for(var e in this._deferredNodes)this._deferredNodes[e].promise.isPending()&&(this._deferredNodes[e].reject(),delete this._deferredNodes[e]);this._requestedPoints=0,this._requestedNodes=[]}},WS.extend("PointLoader"),WS.PointLoader.MAX_PARALLEL_REQUESTS=10,WS.PointLoader.MAX_POINTS_IN_MEMORY={VeryLow:3e6,Low:8e6,Medium:1e7,High:15e6,VeryHigh:2e7},WS.PointCloudMoveHandler=function(e,t,i){WS.MoveHandler.call(this,e,t,i),this._forwardSpeed=0,this._backwardSpeed=0,this._leftSpeed=0,this._rightSpeed=0,this._upSpeed=0,this._downSpeed=0,this._rotLeftSpeed=0,this._rotRightSpeed=0,this._rotUpSpeed=0,this._rotDownSpeed=0,this._zoomPlusSpeed=0,this._zoomMinusSpeed=0,this._forwardTargetSpeed=0,this._backwardTargetSpeed=0,this._leftTargetSpeed=0,this._rightTargetSpeed=0,this._upTargetSpeed=0,this._downTargetSpeed=0,this._rotLeftTargetSpeed=0,this._rotRightTargetSpeed=0,this._rotUpTargetSpeed=0,this._rotDownTargetSpeed=0,this._zoomPlusTargetSpeed=0,this._zoomMinusTargetSpeed=0,this._turbo=1,this._lastUpdate=void 0,this._isMovingByKey=!1,this._holdDiffY=0,this._joystickVisible=!1,this._joystickHeight=0},WS.PointCloudMoveHandler.prototype={onDragMove:function(e,t,i,n,o){var r=i-e,a=n-t;if(o===WS.MouseAdapter.Button.Left){var s=this.determineRotationDeltas(r,a);if(0!==s[0]){var c=this._settingService.invertX(this._camera);this._camera.rotateHorizontally(c*s[0])}if(0!==s[1]){var l=this._settingService.invertY(this._camera);this._camera.rotateVertically(l*s[1])}}else o===WS.MouseAdapter.Button.Middle?(0!==r&&this._camera.moveSideways(r*WS.PointCloudMoveHandler.PAN_SPEED),0!==a&&this._camera.moveVertical(a*WS.PointCloudMoveHandler.PAN_SPEED)):o===WS.MouseAdapter.Button.Right&&0!==a&&this._camera.moveForward(a*WS.PointCloudMoveHandler.MOVE_SPEED);return!0},getNowMillis:function(){return Date.now()},update:function(){if(void 0===this._lastUpdate)return this._lastUpdate=this.getNowMillis(),void(this._isMovingByKey=!1);var e=(this.getNowMillis()-this._lastUpdate)/1e3;this.updateKeys(e),this.updateJoystick(e),this._lastUpdate=this.getNowMillis()},updateKeys:function(e){var t,i,n,o=WS.PointCloudMoveHandler.ACCELERATION*e,r=1-o,a=WS.PointCloudMoveHandler.METERS_PER_SECOND*e*this._turbo,s=2*o,c=1-s;this._forwardTargetSpeed!==this._forwardSpeed&&(this._forwardSpeed=this._forwardSpeed*r+this._forwardTargetSpeed*o,this._forwardSpeed<.01&&(this._forwardSpeed=0)),0!==this._forwardSpeed&&this._camera.moveForward(this._forwardSpeed*a),this._backwardTargetSpeed!==this._backwardSpeed&&(this._backwardSpeed=this._backwardSpeed*r+this._backwardTargetSpeed*o,this._backwardSpeed<.01&&(this._backwardSpeed=0)),0!==this._backwardSpeed&&this._camera.moveForward(-this._backwardSpeed*a),this._leftTargetSpeed!==this._leftSpeed&&(this._leftSpeed=this._leftSpeed*r+this._leftTargetSpeed*o,this._leftSpeed<.01&&(this._leftSpeed=0)),0!==this._leftSpeed&&this._camera.moveSideways(-this._leftSpeed*a),this._rightTargetSpeed!==this._rightSpeed&&(this._rightSpeed=this._rightSpeed*r+this._rightTargetSpeed*o,this._rightSpeed<.01&&(this._rightSpeed=0)),0!==this._rightSpeed&&this._camera.moveSideways(this._rightSpeed*a),this._upTargetSpeed!==this._upSpeed&&(this._upSpeed=this._upSpeed*r+this._upTargetSpeed*o,this._upSpeed<.01&&(this._upSpeed=0)),0!==this._upSpeed&&this._camera.moveVertical(-this._upSpeed*a),this._downTargetSpeed!==this._downSpeed&&(this._downSpeed=this._downSpeed*r+this._downTargetSpeed*o,this._downSpeed<.01&&(this._downSpeed=0)),0!==this._downSpeed&&this._camera.moveVertical(this._downSpeed*a),this._rotLeftTargetSpeed!==this._rotLeftSpeed&&(this._rotLeftSpeed=this._rotLeftSpeed*c+this._rotLeftTargetSpeed*s,this._rotLeftSpeed<.01&&(this._rotLeftSpeed=0)),0!==this._rotLeftSpeed&&(t=this.determineRotationDeltas(WS.PointCloudMoveHandler.ROTATION_SPEED,0),i=this._settingService.invertX(this._camera),this._camera.rotateHorizontally(i*this._rotLeftSpeed*e*t[0])),this._rotRightTargetSpeed!==this._rotRightSpeed&&(this._rotRightSpeed=this._rotRightSpeed*c+this._rotRightTargetSpeed*s,this._rotRightSpeed<.01&&(this._rotRightSpeed=0)),0!==this._rotRightSpeed&&(t=this.determineRotationDeltas(WS.PointCloudMoveHandler.ROTATION_SPEED,0),i=this._settingService.invertX(this._camera),this._camera.rotateHorizontally(i*-this._rotRightSpeed*e*t[0])),this._rotUpTargetSpeed!==this._rotUpSpeed&&(this._rotUpSpeed=this._rotUpSpeed*c+this._rotUpTargetSpeed*s,this._rotUpSpeed<.01&&(this._rotUpSpeed=0)),0!==this._rotUpSpeed&&(t=this.determineRotationDeltas(0,WS.PointCloudMoveHandler.ROTATION_SPEED),n=this._settingService.invertY(this._camera),this._camera.rotateVertically(n*this._rotUpSpeed*e*t[1])),this._rotDownTargetSpeed!==this._rotDownSpeed&&(this._rotDownSpeed=this._rotDownSpeed*c+this._rotDownTargetSpeed*s,this._rotDownSpeed<.01&&(this._rotDownSpeed=0)),0!==this._rotDownSpeed&&(t=this.determineRotationDeltas(0,WS.PointCloudMoveHandler.ROTATION_SPEED),n=this._settingService.invertY(this._camera),this._camera.rotateVertically(n*-this._rotDownSpeed*e*t[1])),this._zoomPlusTargetSpeed!==this._zoomPlusSpeed&&(this._zoomPlusSpeed=this._zoomPlusSpeed*c+this._zoomPlusTargetSpeed*s,this._zoomPlusSpeed<.01&&(this._zoomPlusSpeed=0)),0!==this._zoomPlusSpeed&&this._camera.changeFOVY(-this._zoomPlusSpeed*e,2),this._zoomMinusTargetSpeed!==this._zoomMinusSpeed&&(this._zoomMinusSpeed=this._zoomMinusSpeed*c+this._zoomMinusTargetSpeed*s,this._zoomMinusSpeed<.01&&(this._zoomMinusSpeed=0)),0!==this._zoomMinusSpeed&&this._camera.changeFOVY(this._zoomMinusSpeed*e,2);var l=0!==this._forwardSpeed||0!==this._backwardSpeed||0!==this._leftSpeed||0!==this._rightSpeed||0!==this._upSpeed||0!==this._downSpeed||0!==this._rotLeftSpeed||0!==this._rotRightSpeed||0!==this._rotUpSpeed||0!==this._rotDownSpeed||0!==this._zoomPlusSpeed||0!==this._zoomMinusSpeed;!this._isMovingByKey&&l?this.startMove():this._isMovingByKey&&!l&&this.endMove(),this._isMovingByKey=l},onForwardPress:function(){return this._forwardTargetSpeed=1,!0},onBackwardPress:function(){return this._backwardTargetSpeed=1,!0},onLeftPress:function(){return this._leftTargetSpeed=1,!0},onRightPress:function(){return this._rightTargetSpeed=1,!0},onUpPress:function(){return this._upTargetSpeed=1,!0},onDownPress:function(){return this._downTargetSpeed=1,!0},onJPress:function(){return this._rotLeftTargetSpeed=1,!0},onLPress:function(){return this._rotRightTargetSpeed=1,!0},onIPress:function(){return this._rotUpTargetSpeed=1,!0},onKPress:function(){return this._rotDownTargetSpeed=1,!0},onPlusPress:function(){return this._zoomPlusTargetSpeed=WS.PointCloudMoveHandler.ZOOM_SPEED,!0},onMinusPress:function(){return this._zoomMinusTargetSpeed=WS.PointCloudMoveHandler.ZOOM_SPEED,!0},onShiftPress:function(){return this._turbo=WS.PointCloudMoveHandler.TURBO_SPEED,!0},onForwardRelease:function(){return this._forwardTargetSpeed=0,!0},onBackwardRelease:function(){return this._backwardTargetSpeed=0,!0},onLeftRelease:function(){return this._leftTargetSpeed=0,!0},onRightRelease:function(){return this._rightTargetSpeed=0,!0},onUpRelease:function(){return this._upTargetSpeed=0,!0},onDownRelease:function(){return this._downTargetSpeed=0,!0},onJRelease:function(){return this._rotLeftTargetSpeed=0,!0},onLRelease:function(){return this._rotRightTargetSpeed=0,!0},onIRelease:function(){return this._rotUpTargetSpeed=0,!0},onKRelease:function(){return this._rotDownTargetSpeed=0,!0},onPlusRelease:function(){return this._zoomPlusTargetSpeed=0,!0},onMinusRelease:function(){return this._zoomMinusTargetSpeed=0,!0},onShiftRelease:function(){return this._turbo=1,!0},onDblClick:function(e,t,i,n){if(i!==F.MouseAdapter.Button.Left)return!1;var o=this.pickPoint(e,t,n?9:5);if(!o||!o[3])return!1;var r=o[2];return this.flyToTarget(r),!0},flyToTarget:function(e){var t=this._view._cameraAnimator;if(!t.isAnimating()){var i=this._view._trafoView,n=this._camera,o=n.getGlobalPos(i),r=n.getPhi(),a=n.getTheta(),s=this.calcGoodDistToCam(o,e),c=vec3.subtract(o,e,vec3.create());vec3.normalize(c),vec3.scale(c,s),vec3.add(c,e);var l=new WS.PerspectiveCamera;l.copyFrom(n),l.setFromGlobalPos(c,i),l.lookAt(e,i);var h=l.getPhi(),d=l.getTheta(),u=2*t.calcGoodDuration(o,c,r,h,a,d);u>0&&(t.startAnimation(n,u,i,c,h,d),this._view.hideRadialMenu())}},calcGoodDistToCam:function(e,t){var i=vec3.dist(e,t);return 8>=i?Math.max(this._camera._near+.01,i/4):32>=i?2+(i-8)/24:3+(i-32)/50},onHoldStart:function(e,t){this._holdDiffY=0;var i=this.calculateJoystick(e,t);return this._joystickVisible=i[0],this._joystickHeight=i[3],this._joystickVisible&&(this._view.showJoystick(i[1],i[2],this._joystickHeight),this.startMove()),!0},onHoldMove:function(e,t,i,n,o,r){return this._joystickVisible&&(this._holdDiffY=r-t,this._view.updateJoystick(e,t)),!0},onHoldStop:function(){return this._joystickVisible&&(this.endMove(),this._view.hideJoystick()),this._holdDiffY=0,this._joystickVisible=!1,this._joystickHeight=0,!0},updateJoystick:function(e){if(this._joystickVisible&&WS.PointCloudMoveHandler.JOYSTICK_DEAD_ZONE<Math.abs(this._holdDiffY)){var t=Math.floor(this._joystickHeight/2),i=Math.max(-t,Math.min(t,this._holdDiffY))/t,n=(i>0?1:-1)*Math.pow(Math.abs(i),WS.PointCloudMoveHandler.JOYSTICK_POWER);if(this._joystickHeight<WS.PointCloudMoveHandler.JOYSTICK_MEDIUM_HEIGHT){var o=WS.PointCloudMoveHandler.JOYSTICK_MEDIUM_HEIGHT-WS.PointCloudMoveHandler.JOYSTICK_MIN_HEIGHT,r=this._joystickHeight-WS.PointCloudMoveHandler.JOYSTICK_MIN_HEIGHT,a=1-r/o,s=.4,c=1-a*s;n=Math.max(-c,Math.min(c,n))}var l=n*WS.PointCloudMoveHandler.JOYSTICK_METERS_PER_SECOND*e;this._camera.moveForward(l)}},calculateJoystick:function(e,t){var i=WS.PointCloudMoveHandler.JOYSTICK_BUTTON_HALF,n=WS.PointCloudMoveHandler.JOYSTICK_DIST_TO_BORDER;e=Math.max(i+n,Math.min(this._view._width-1-i-n,e));var o=Math.floor(WS.PointCloudMoveHandler.JOYSTICK_MIN_HEIGHT/2),r=o+i+n;if(r>t||this._view._height-r<t)return[!1,e,t,0];var a=WS.PointCloudMoveHandler.JOYSTICK_MAX_HEIGHT,s=Math.floor(a/2),c=s+i;if(c>t)a=2*(t+1-i)-1-2*n;else if(this._view._height-1-c<t){var l=this._view._height-t;a=2*(l+1-i)-1-2*n}return[!0,e,t,a]}},WS.extend("PointCloudMoveHandler","MoveHandler"),WS.PointCloudMoveHandler.ACCELERATION=5,WS.PointCloudMoveHandler.METERS_PER_SECOND=4,WS.PointCloudMoveHandler.PAN_SPEED=.01,WS.PointCloudMoveHandler.MOVE_SPEED=.025,WS.PointCloudMoveHandler.ROTATION_SPEED=667,WS.PointCloudMoveHandler.ZOOM_SPEED=50,WS.PointCloudMoveHandler.TURBO_SPEED=5,WS.PointCloudMoveHandler.JOYSTICK_POWER=1.4,WS.PointCloudMoveHandler.JOYSTICK_METERS_PER_SECOND=15,WS.PointCloudMoveHandler.JOYSTICK_MIN_HEIGHT=101,WS.PointCloudMoveHandler.JOYSTICK_MEDIUM_HEIGHT=251,WS.PointCloudMoveHandler.JOYSTICK_MAX_HEIGHT=401,WS.PointCloudMoveHandler.JOYSTICK_DIST_TO_BORDER=5,WS.PointCloudMoveHandler.JOYSTICK_DEAD_ZONE=9,WS.PointCloudMoveHandler.JOYSTICK_BUTTON_HALF=34,WS.NodeInfo=function(){this.loaded=!1,this.failed=!1,this.numPoints=0,this.lastUse=null,this.visible=!1,this.hq=!1,this.positionArray=null,this.colorArray=null,this.depth=null,this.camDistance=null,this.centerDistance=null,this.centerBonus=null,this.rating=null,this.lod=null},WS.NodeInfo.prototype={unload:function(){this.positionArray=null,this.colorArray=null,this.loaded=!1,this.numPoints=0}},WS.extend("NodeInfo"),WS.OcclusionFrameBuffer=function(e){WS.FrameBuffer.call(this,e),this._countColorsBuf=void 0,this._dbgImage=!1},WS.OcclusionFrameBuffer.prototype={readTextureIntoBuffer:function(){if(this._countColorsBuf=this.readTexture(0,0,this._width,this._height),this._dbgImage){this._dbgImage!==!0&&this._dbgImage--;var e=this._width,t=this._height,i=document.createElement("canvas");i.width=e,i.height=t;var n=i.getContext("2d");n.fillStyle="rgba(0,0,0,0)",n.clearRect(0,0,e,t);for(var o=n.getImageData(0,0,e,t),r=this._countColorsBuf.length,a=0;r>a;a++)o.data[a]=this._countColorsBuf[a];n.putImageData(o,0,0);var s=i.toDataURL(),c=console;c.log(s)}},countColorsForStartFrame:function(e,t,i){for(var n=this._countColorsBuf,o=0;i>o;o+=4)for(var r=o*t,a=0;t>a;a+=4){var s=4*(r+a);255===n[s+3]&&(e[(n[s+1]<<8)+n[s+2]]+=16)}this._countColorsBuf=void 0},countColors:function(e){for(var t=this._countColorsBuf,i=t.length-3+1,n=1;i>n;n+=4)255===t[n+2]&&e[(t[n]<<8)+t[n+1]]++;this._countColorsBuf=void 0},abortCountColors:function(){this._countColorsBuf=void 0
}},WS.extend("OcclusionFrameBuffer","FrameBuffer"),WS.OcclusionRenderable=function(e,t,i,n,o){var r=this.determineBufferData(e,t,i),a=new WS.Geometry;a._primitiveType=WS.Geometry.PrimitiveType.Triangles,a._indexBuffer=new WS.IndexBuffer(r[0]),a._positionBuffer=new WS.ArrayBuffer(r[1],3);var s=new WS.ColorMaterial(new WS.ArrayBuffer(r[2],4));s._depthTest=!0,s._depthWrite=!0,WS.Mesh.call(this,a,s),this.addToLayer(n),this._transform=o},WS.OcclusionRenderable.prototype={updateBuffers:function(e,t,i){var n=this.determineBufferData(e,t,i);this._geometry._indexBuffer.setBufferData(n[0]),this._geometry._positionBuffer.setBufferData(n[1]),this._material._colorBuffer.setBufferData(n[2])},determineBufferData:function(e,t,i){for(var n=[],o=e.length,r=8,a=WS.OcclusionRenderable.INDEX_ARRAY_FOR_BOX,s=36,c=new Uint16Array(o*s),l=0,h=0;o>h;++h)for(var d=h*r,u=0;s>u;++u)c[l++]=a[u]+d;n[0]=c;for(var p=new Float32Array(o*r*3),_=0;o>_;_++)for(var g=e[_],f=.01-g._shortID.length/i*.01,m=[g._min[0]-f,g._min[1]-f,g._min[2]-f],v=[g._max[0]+f,g._max[1]+f,g._max[2]+f],S=r-1;S>=0;--S){var b=S%2>=1?v[0]:m[0],y=S%4>=2?v[1]:m[1],P=S%8>=4?v[2]:m[2],C=3*(8*_+S);p[C]=b,p[C+1]=y,p[C+2]=P}n[1]=p;var w=new Float32Array(o*r*4);l=0;for(var T=0;o>T;++T)for(var M=t[T],W=0;r>W;++W)w[l++]=M[0],w[l++]=M[1],w[l++]=M[2],w[l++]=M[3];return n[2]=w,n}},WS.extend("OcclusionRenderable","Mesh"),WS.OcclusionRenderable.INDEX_ARRAY_FOR_BOX=[0,1,3,0,3,2,5,4,6,5,6,7,4,5,1,4,1,0,2,3,7,2,7,6,4,0,2,4,2,6,1,5,7,1,7,3],WS.PointCloudRenderable=function(e,t,i){this.setDataObject(e),this._details3d=void 0,this._transform=e.calcTrafoInRefSystem(t._trafoView),this._transformInverse=mat4.invertOrtho(this._transform,mat4.create()),this._activated=!1,this._pointLoader=e._pointLoader,this._homogenization=e._homogenization,this._lodThreshMoving=void 0,this._moveHomogenization=void 0,this._view=t,this._alpha=1,this._prIndex={},this._vrIndex={},this._prs=[],this._visiblePrs=[],this._pointBudgetMove=void 0,this._pointBudgetStill=void 0,this._nodeBudgetMove=void 0,this._nodeBudgetStill=7054,this._minPixelStill=void 0,this._physicalFactorGF=void 0,this.updateDetailLevel(i,!0);var n=this._view._renderer[0],o=n._shaderProgramStorage;this._voronoi=n instanceof WS.Renderer3D&&t.getGLExtension("EXT_frag_depth")&&o.inquireShaderProgram(WS.VoronoiPointShaderDesc)._compiled;var r=this._voronoi?WS.PointCloudRenderable.VORONOI_FACTOR:WS.PointCloudRenderable.SIZE_FACTOR;this._pointSize={physical:this._homogenization*r,minPixel:2,maxPixel:40},this._minDepth=void 0,this._maxDepth=void 0,this._lodLookupTable=[],this._hqMaxDistance=void 0,this._pickable3d=!0,this._visibleNodes=[],this._mvMatrix=mat4.create(),this._camPos=void 0,this._frustum=void 0,this._colorCountFrame=0,this._colorArray=new Uint32Array(65536),this._shortIDToColor={},this._ratedAfterStart=!1,this._framesAfterStart=0,this._ratedAndEnoughFrames=!1,this._panoTo3d=!1,this._inTransition=!1,this._inNewRestCycle=!1,this._ratingsContainingCamera={},this._occlusionRenderable=void 0,this._occlusionFrameBuffer=void 0,this._state=void 0,this._prevState=void 0,this._initializedTree=!1,this._now=void 0,this._last=void 0,this._numberOfScans=e._sourceTypes.length,this.addToLayer(WS.Layer.LayerIDs.POINT_CLOUD,!0),this._dbgShowLod=!1,this._dbgShowBBoxes=!1,this._dbgBBoxRenderables={},this._debugDlVisNodes=!1,this._dbgMove=0,this._dbgSubtree=void 0,this._dbgFreezeCam=void 0,this._dbgLodColors=this.dbgGetLodColors()},WS.PointCloudRenderable.prototype={assignPickColors:function(e){for(var t=this,i=0,n=this._visiblePrs.length;n>i;++i){var o=this._visiblePrs[i],r=e.assignColorToRenderable(t,o),a=[r[0]/255,r[1]/255,r[2]/255,r[3]/255];o.setPickColor(a)}},setPickColor:function(){},updateDetailLevel:function(e,t){this._details3d=e,this._pointLoader._maxPointsInMemory=WS.PointLoader.MAX_POINTS_IN_MEMORY[e],this._pointBudgetMove=WS.PointCloudRenderable.BUDGET_MOVE[e],this._pointBudgetStill=WS.PointCloudRenderable.BUDGET_STILL[e],this._nodeBudgetMove=Math.ceil(.8*this._pointBudgetMove/WS.PointCloudNode.MIN_PTS),t||this.unloadNodes(this._dbgFreezeCam||this._view._camera,!0);var i=!1,n=this._view._renderer[0];n instanceof WS.Renderer3D&&(i=n.gapFillerEnabled()),this._minPixelStill=i?2:3,this._physicalFactorGF=i?1:2},activate:function(){if(this._activated=!0,this._pointLoader.addAsListener(),!this._occlusionFrameBuffer){var e=this._view._renderer[0];this._occlusionFrameBuffer=e._frameBufferStorage.get("occlusion_"+this._id,WS.OcclusionFrameBuffer)}this.update()},deactivate:function(){var e=WS.PointCloudRenderable.State;if(this.abortRateResting(),this._panoTo3d=!1,this._inTransition=!1,this._inNewRestCycle=!1,(this._state===e.MOVE||this._state===e.REST_DRAW||this._state===e.REST_READ||this._state===e.REST_COUNT||this._state===e.REST_IDLE)&&(this._state=e.START_IDLE),this._occlusionFrameBuffer){var t=this._view._renderer[0];t instanceof WS.Renderer3D&&t._frameBufferStorage.destroy("occlusion_"+this._id),this._occlusionFrameBuffer=void 0}this._pointLoader.cancelRequests(),this._pointLoader.removeAsListener(),this._pointLoader._addedNodes=!1,this._activated=!1},isActive:function(){return this._activated},unload:function(e){e.deleteStorageForRenderableAndMembers(this),this._initializedTree=!1,this._prIndex={},this._vrIndex={},this._prs=[],this._visiblePrs=[],this._dbgBBoxRenderables={},this._lodLookupTable=[],this._visibleNodes=[],this._panoTo3d=!1,this._inTransition=!1,this._inNewRestCycle=!1,this._ratedAfterStart=!1,this._ratedAndEnoughFrames=!1,this._state=void 0,this._dataObject.unloadTreeStructure(),this._pointLoader.unloadAll()},isLoaded:function(){return!!this._dataObject._treeStructure},update:function(){var e=WS.PointCloudRenderable.Draw,t=WS.PointCloudRenderable.State;if(!this._activated)return e.NO;var i=this._dataObject.getTreeStructure();if(!this._view.isCameraInitialized()||!i)return e.NO;this._now=this.getNow(),this._now=Math.max(this._now,(this._last||0)+.1),this._initializedTree||(this._initializedTree=!0,this.determineLodMoving());var n,o=this._dbgFreezeCam||this._view._camera;return this.updateState(o),this._state===t.REST_IDLE?n=e.KEEP:this._state===t.MOVE||this._state===t.START?(this.updateCamera(o),this.updateLODLookupTable(o),this.collectVisibleNodes(),this.rateAndSortNodes(),this.processRatedNodes(o),this.updateRenderables(),this.unloadNodes(o),n=e.ALL):this._state===t.REST_DRAW?(this.updateCamera(o),this.updateLODLookupTable(o),this.collectVisibleNodes(),this.rateAndSortNodes(),n=e.ABORT):this._state===t.REST_READ?(this.rateAndSortNodes(),n=e.ABORT):this._state===t.REST_COUNT?(this.rateAndSortNodes(),this.processRatedNodes(o),this.updateRenderables(),this.unloadNodes(o),n=this._inNewRestCycle?e.ALL:e.ADD):n=e.KEEP,(this._inTransition||2===this._dbgMove&&o._dirty)&&(n=e.ALL),this._last=this._now,n},determineLodMoving:function(){500<this._numberOfScans||625e7<this._dataObject._points?(this._lodThreshMoving=6,this._moveHomogenization=.064):50<this._numberOfScans||625e6<this._dataObject._points?(this._lodThreshMoving=5,this._moveHomogenization=.032):5<this._numberOfScans||375e5<this._dataObject._points?(this._lodThreshMoving=4,this._moveHomogenization=.016):(this._lodThreshMoving=3,this._moveHomogenization=.008)},updateState:function(e){var t=WS.PointCloudRenderable.State,i=t.START,n=t.START_IDLE,o=t.REST_DRAW,r=t.REST_READ,a=t.REST_COUNT,s=t.REST_IDLE,c=t.MOVE,l=WS.PointCloudRenderable.MIN_CAMERA_IDLE_COUNT,h=this._prevState=this._state;this._ratedAfterStart?this._ratedAndEnoughFrames?2===this._dbgMove||!e._dirty&&1!==this._dbgMove?l<=this._view._cameraIdleCount||h===n||2===this._dbgMove?0===this._colorCountFrame?this._pointLoader._addedNodes||this._panoTo3d||h===c||h===n?(this._state=o,this._inNewRestCycle=h===c||h===n||this._panoTo3d,this._panoTo3d=!1,this._pointLoader._addedNodes=!1):this._state=s:this._state=1===this._colorCountFrame?r:a:h===o?this._state=r:h===r?this._state=a:h===a?this._panoTo3d?(this._state=o,this._inNewRestCycle=!1,this._panoTo3d=!1,this._pointLoader._addedNodes=!1):this._state=s:h===s&&this._panoTo3d&&(this._state=o,this._inNewRestCycle=!1,this._panoTo3d=!1,this._pointLoader._addedNodes=!1):this._state=c:this._state=n:this._state=i,this._state===c&&(this._pointLoader._addedNodes=!1,this._panoTo3d=!1),this._framesAfterStart++,this._ratedAndEnoughFrames=this._ratedAndEnoughFrames||this._ratedAfterStart&&l<=this._framesAfterStart},useIncrRendering:function(){var e=WS.PointCloudRenderable.State;switch(this._state){case e.REST_DRAW:case e.REST_READ:case e.REST_COUNT:case e.REST_IDLE:return!0;default:return!1}},shouldShowLoading:function(){return this._state!==WS.PointCloudRenderable.State.MOVE&&0<this._pointLoader._requestedNodes.length},updateCamera:function(e){this._camPos=e.getGlobalPos(this._transformInverse);var t=this._state===WS.PointCloudRenderable.State.MOVE;this._frustum=e.calcFrustum(this._transform,t?.5*e._far:void 0)},updateLODLookupTable:function(e){for(var t=this._dataObject.getTreeStructure(),i=this._state===WS.PointCloudRenderable.State.MOVE,n=i?4:this._minPixelStill,o=Math.tan(e._fovY*Math.PI/360),r=this._homogenization*e._height/(2*n*o),a=t.r,s=a._q,c=Math.floor(s),l=F.log2(c),h=this._dataObject._lodDepth+l,d=0;h>d;d++)this._lodLookupTable[d]=r,r*=2;this._lodLookupTable[h]=Number.MAX_VALUE;var u=i?.032:.008;this._hqMaxDistance=u*(e._height/(2*n*o))},collectVisibleNodes:function(){var e=this._camPos,t=this._frustum;this._visibleNodes=[];var i=this._dataObject.getTreeStructure(),n=[],o=0,r=i.r,a=vec3.intersectAABoxWithFrustum(r._min,r._max,t);if(a!==WS.PerspectiveCamera.FrustumBoxIntersection.OUTSIDE){var s=r._nodeInfo;s.depth=1;var c=this.calcNearestDistance(e,r._min,r._max);s.camDistance=c,s.centerDistance=vec3.dist(e,r.getCenter()),s.hq=c<this._hqMaxDistance;var l=WS.PerspectiveCamera.FrustumBoxIntersection.INSIDE,h=WS.PerspectiveCamera.FrustumBoxIntersection.INTERSECT,d=WS.PerspectiveCamera.FrustumBoxIntersection.OUTSIDE,u=this._dataObject._lodDepth,p=this._lodLookupTable,_=p.length-1,g=this._lodThreshMoving,f=this._state,m=this._visibleNodes,v=this._hqMaxDistance;for(n.push([r,a,"r"]);o<n.length;){var S=n[o],b=S[0],y=b._nodeInfo,P=S[1],C=S[2],w=C.length,T=0<b._points;if(null===y.lod){var M;if(T){var W=Math.min(u,w),E=Math.floor(b._q),I=F.log2(E);M=u-W+I}else if(w>1){var R=C.slice(0,-1),L=i[R];M=L._nodeInfo.lod}else M=_;y.lod=M}var O=y.lod;if(f===WS.PointCloudRenderable.State.MOVE&&g>O)o++;else{T&&m.push(b);for(var D=0;i[C+D];){var A=C+D,x=i[A],k=this.calcNearestDistance(e,x._min,x._max);if(k<p[O]){var U=P===h?vec3.intersectAABoxWithFrustum(x._min,x._max,t):l;if(U!==d){var j=x._nodeInfo;j.depth=w+1,j.camDistance=k,j.centerDistance=vec3.dist(e,x.getCenter()),j.hq=v>k,n.push([x,U,A])}}D++}o++}}}},processRatedNodes:function(){var e=this._visibleNodes,t=e.length;if(0!==t){this._debugDlVisNodes&&(this.dbgDlVisibleNodes(),this._debugDlVisNodes=!1);for(var i=this._state===WS.PointCloudRenderable.State.MOVE,n=i?this._pointBudgetMove:this._pointBudgetStill,o=i?this._nodeBudgetMove:this._nodeBudgetStill,r=0,a=0,s=this._minDepth,c=this._maxDepth,l=this._dbgSubtree,h=this._bestNodes,d=this._now,u=this._pointLoader,p=0;t>p;p++){var _=e[p],g=_._nodeInfo;if(!(0<g.rating)){e.length=p;break}var f=_._shortID,m=f.length;if(!(n>r&&o>a)){e.length=p;break}if(g.loaded){r+=g.numPoints,a+=1;var v=void 0!==s&&s>m,S=void 0!==c&&m>c,b=void 0!==l&&f!==l,y=void 0!==h&&p+1>h;g.visible=!(v||S||b||y),g.lastUse=d}else g.visible=!1,u.loadNodeBinary(_)}}},updateRenderables:function(){var e=this._visibleNodes.length;if(0!==e){var t=this._visibleNodes,i=this._prs,n=this._visiblePrs=[],o=this._vrIndex={},r=this._prIndex,a=this._voronoi,s=this._state===WS.PointCloudRenderable.State.MOVE,c=s?this._moveHomogenization/this._homogenization:1,l=s?1:this._physicalFactorGF,h=a?WS.PointCloudRenderable.VORONOI_FACTOR:WS.PointCloudRenderable.SIZE_FACTOR,d=this._pointSize;d.physical=Math.max(.003,this._homogenization*c*l*h),d.minPixel=s?4:this._minPixelStill;for(var u=0;e>u;u++){var p=t[u],_=p._nodeInfo;if(_.visible){var g=a&&_.hq,f=p._shortID,m=i[r[f]];m?(m.enableVoronoi(g),n.push(m),o[f]=n.length-1):_.positionArray&&(m=this.addPointRenderable(p,g,d),n.push(m),o[f]=n.length-1)}}}},unloadNodes:function(e,t){var i=this.determineNodesToUnload(e,t);if(i)for(var n=this._pointLoader,o=this._prs,r=this._prIndex,a=0,s=i.length;s>a;++a){var c=i[a],l=c._shortID,h=o[r[l]];h&&this.removePointRenderable(h,l),n.unloadNode(c),c._nodeInfo.unload()}},calcNearestDistance:function(e,t,i){var n=e[0],o=e[1],r=e[2],a=t[0],s=t[1],c=t[2],l=i[0],h=i[1],d=i[2];a>n?n=a:n>l&&(n=l),s>o?o=s:o>h&&(o=h),c>r?r=c:r>d&&(r=d);var u=n-e[0],p=o-e[1],_=r-e[2];return Math.sqrt(u*u+p*p+_*_)},determineNodesToUnload:function(e){var t=this._pointLoader,i=t._requestedNodes.length*WS.PointCloudNode.MAX_PTS,n=t._pointsInMemory+i;if(n<=t._maxPointsInMemory)return void 0;var o,r,a=t._pointsInMemory-this._pointBudgetStill-WS.PointCloudNode.MAX_PTS,s=[],c=(this._dataObject.getTreeStructure(),this._now),l=this._pointLoader._loadedNodes;for(var h in l){var d=l[h];r=d._nodeInfo,(r.lastUse<c||!r.lastUse)&&r.loaded&&s.push(d)}var u=s.length,p=Number.MAX_VALUE,_=Number.MIN_VALUE;for(o=0;u>o;++o)r=s[o]._nodeInfo,p=Math.min(p,r.lastUse),_=Math.max(_,r.lastUse);var g=Math.max(1,_-p),f=e.unprojectPoint([e._width/2,e._height/2,.99]);for(vec3.subtract(f,this._camPos),vec3.normalize(f),o=0;u>o;++o)this.rateUnloading(s[o],p,g,e,f);s.sort(function(e,t){return t._nodeInfo.rating-e._nodeInfo.rating});var m=0;for(o=0;u>o&&a>m;++o)m+=s[o]._nodeInfo.numPoints;return s.length=o,s},addPointRenderable:function(e,t,i){var n=e._nodeInfo,o=e._shortID,r=new WS.DynamicPointRenderable(new WS.ArrayBuffer(n.positionArray,3),new WS.ArrayBuffer(n.colorArray,4,WS.Buffer.ItemDataType.UBYTE),i,void 0,t,o),a=r._material;return n.colorArray=null,r.setAlpha(this._alpha),r.addToLayer(this._layerId),a._useFixedColor=this._dbgShowLod,a._fixedColor=this._dbgLodColors[o.length]._bufferData,a._mvMatrix=this._mvMatrix,this._prs.push(r),this._prIndex[o]=this._prs.length-1,this._dbgShowBBoxes&&!this._dbgBBoxRenderables[o]&&this.dbgAddBBoxRenderable(e),r},removePointRenderable:function(e,t){var i=this._prIndex,n=this._vrIndex;this._view.deleteStorageForRenderableAndMembers(e);var o=i[t];delete i[t],this._prs.splice(o,1);for(var r in i)o<i[r]&&i[r]--;var a=n[t];if(a>=0){delete n[t],this._visiblePrs.splice(a,1);for(var s in n)a<n[s]&&n[s]--}this._dbgBBoxRenderables[t]&&this.dbgRemoveBBoxRenderable(t)},getNow:function(){return Date.now()},rateAndSortNodes:function(){var e=WS.PointCloudRenderable.State,t=this._dbgFreezeCam||this._view._camera,i=this._state,n=this._visibleNodes;i===e.START?(this.rateRestingDraw(t),this.rateRestingRead()&&this.rateRestingCount(t,!0)):i===e.MOVE?(this._prevState!==e.MOVE&&this.abortRateResting(),n.length>0&&this.rateMoving(t)):i===e.REST_DRAW?this.rateRestingDraw(t):i===e.REST_READ?this.rateRestingRead():i===e.REST_COUNT&&this.rateRestingCount(t,!1),n.sort(function(e,t){return t._nodeInfo.rating-e._nodeInfo.rating})},rateMoving:function(e){for(var t=49.9,i=35.1,n=5.1,o=5,r=4.9,a=this._visibleNodes,s=this.getNodesContainingCamera(e,!0),c=250,l=.5*e._far,h=n/10,d=WS.PointCloudNode.MIN_PTS,u=this._lodThreshMoving,p=this._dataObject._lodDepth,_=0,g=a.length;g>_;++_){var f=a[_],m=f._nodeInfo,v=m.camDistance*(c/l),S=0,b=m.lod;S=b===u+1?1:b===p-2?.95:b===u?.85:b>=p-1?.8:b===u+2?.65:b===p-3?.6:b===u+3?.4:b===p-4?.35:b===u+4?.1:b===p-5?.05:0;var y,P=S*t;y=50>=v?Math.max(.1,.0001674720747*v*v-.02669879092*v+.9984014448)*i:c>v?h-(v-50)/(c-50)*h:0;var C=s[f._shortID]?o:0,w=Math.min(r,r*(f._points-d)/d),T=0;if(m.lastUse)if(m.lastUse===this._last)T=n;else{var M=this._last-m.lastUse;2e3>M&&(T=(-5+2*M/1e3)*n)}m.rating=Math.max(0,P+y+C+w+T)}},rateRestingDraw:function(e){var t=this._view,i=t._renderer[0],n=i._shaderProgramStorage,o=this._visibleNodes,r=this._colorArray,a=this._shortIDToColor={},s=new WS.Scene,c=new WS.ObjectLabeler(WS.ObjectLabeler.DEFAULT_INTERVAL,3),l=[],h=[],d=this._prs,u=this._prIndex,p=this._pointLoader._requestedNodes,_=!1;if(!this._inNewRestCycle&&this.useIncrRendering()&&!n.inquireShaderProgram(WS.ColorShaderDesc)._failSafe){var g=i._frameBufferStorage.get("post_gf_depth"),f=g._camMatrix&&mat4.equal(g._camMatrix,e._camMatrix);f&&(_=!0)}this.determineRatingForNodesContainingCamera(e);for(var m=this._ratingsContainingCamera,v=0,S=o.length;S>v;++v){var b,y,P=o[v],C=P._shortID,w=P._nodeInfo.loaded,T=d[u[C]];w&&T&&!_?(b=c.getColor().rgb,T.setPickColor([b[0]/255,b[1]/255,b[2]/255,1]),y=(b[1]<<8)+b[2],r[y]=0,a[C]=y,s.add(T)):w||m[C]||-1!==p.indexOf(P)||(b=c.getColor().rgb,l.push([b[0]/255,b[1]/255,b[2]/255,1]),h.push(P),y=(b[1]<<8)+b[2],r[y]=0,a[C]=y)}0<h.length&&(this._occlusionRenderable?this._occlusionRenderable.updateBuffers(h,l,this._dataObject._depth):this._occlusionRenderable=new WS.OcclusionRenderable(h,l,this._dataObject._depth,this._layerId,this._transform),s.add(this._occlusionRenderable)),i.drawScene(e,s,!1,void 0,{destFB:this._occlusionFrameBuffer,colorMode:WS.RendererBase.RenderMode.NODE,rgbDepthTest:_}),this._colorCountFrame=1},rateRestingRead:function(){return this._view._width&&this._view._height?(this._occlusionFrameBuffer.readTextureIntoBuffer(),this._colorCountFrame=2,!0):(this._colorCountFrame=0,!1)},rateRestingCount:function(e,t){var i=this._view,n=i._width,o=i._height;if(!n||!o)return this._occlusionFrameBuffer.abortCountColors(),void(this._colorCountFrame=0);var r=this._colorArray;t?this._occlusionFrameBuffer.countColorsForStartFrame(r,n,o):this._occlusionFrameBuffer.countColors(r);for(var a,s=this._visibleNodes,c=s.length,l=n/2,h=o/2,d=n>o?h:l,u=n*o,p=[this._transform[12],this._transform[13],this._transform[14]],_=this._ratingsContainingCamera,g=this._shortIDToColor,f=0,m=0;c>m;++m)a=s[m]._nodeInfo,a.loaded&&(a.rating=200+1/(a.camDistance+1),f++);for(var v=WS.PointCloudRenderable.MIN_PIXELS,S=0;c>S;++S){var b=s[S];a=b._nodeInfo;var y=b._shortID;if(!a.loaded){var P=_[y];if(P)a.rating=P;else{var C=g[y];if(C>-1){var w=r[C],T=w/u*100;a.centerBonus=this.calculateCenterBonus(e,b,l,h,d,p),a.rating=w>v?Math.min(100,10+T+a.centerBonus):0}}}}this._ratedAfterStart=!0,this._colorCountFrame=0},rateUnloading:function(e,t,i,n,o){var r=e._nodeInfo,a=100-100*(r.lastUse-t)/i,s=this._camPos,c=this.calcNearestDistance(s,e._min,e._max),l=500;c*=l/n._far;var h;h=20>=c?.5*c:50>=c?10+4/3*(c-20):100>=c?50+.7*(c-50):Math.min(100,85+15/(l-100)*(c-100));var d;if(0===c)d=0;else{var u=e.getCenter();vec3.subtract(u,this._camPos),vec3.normalize(u);var p=vec3.angle(o,u),_=p/Math.PI;d=_*_*100}var g=r.lod,f=0;0===g?f=100:1===g&&(f=50),r.rating=Math.min(100,.25*a+.4*h+.3*d+.05*f)},calculateCenterBonus:function(e,t,i,n,o,r){var a=t.getCenter(),s=[r[0]+a[0],r[1]+a[1],r[2]+a[2],1],c=e.projectPoint(s);if(c){var l=i-s[0],h=n-s[1],d=Math.sqrt(l*l+h*h),u=Math.max(0,1-d/o),p=t._nodeInfo.centerDistance,_=50>p?Math.max(.1,.0001674720747*p*p-.02669879092*p+.9984014448):.1;return Math.max(.1,u*_*WS.PointCloudRenderable.MAX_CENTER_BONUS)}return.05},abortRateResting:function(){this._colorCountFrame=0,this._occlusionRenderable&&this._view.deleteStorageForRenderableAndMembers(this._occlusionRenderable),this._occlusionFrameBuffer&&this._occlusionFrameBuffer.abortCountColors()},determineRatingForNodesContainingCamera:function(e){var t=this.getNodesContainingCamera(e),i=this._ratingsContainingCamera={},n=t.length;this._ratingWithCamera={};for(var o,r,a=WS.PointCloudRenderable.RATINGS_WITHIN_CAMERA,s=0;n>s&&10>s;++s)o=t[s],r=o._points?a[s]:0,i[o._shortID]=r;for(var c=10;n>c;++c)o=t[c],r=o._points?11-.01*c:0,i[o._shortID]=r},getNodesContainingCamera:function(e,t){var i=this._dataObject.getTreeStructure(),n=i.r,o=t?{}:[];return 0===this.calcNearestDistance(this._camPos,n._min,n._max)&&(this.getNodesContainingCameraHelper(o,i,n,t),t?o[n._shortID]=n:o.push(n)),o},getNodesContainingCameraHelper:function(e,t,i,n){for(var o=i._shortID,r=0,a=t[o+r],s=this._camPos;a;){if(0===this.calcNearestDistance(s,a._min,a._max)){this.getNodesContainingCameraHelper(e,t,a,n),n?e[a._shortID]=a:e.push(a);break}r++,a=t[o+r]}},setAlpha:function(e){if(this._alpha!==e){this._alpha=e;for(var t=0,i=this._prs.length;i>t;++t)this._prs[t].setAlpha(e)}},getAlpha:function(){return this._alpha},getMemberRenderables:function(){return this._dbgShowBBoxes?this.dbgGetRenderables(!1):this._prs},getVisibleMemberRenderables:function(){return this._dbgShowBBoxes?this.dbgGetRenderables(!0):this._visiblePrs},draw3d:function(e,t){var i=e._renderColorMode===WS.RendererBase.RenderMode.PICK_3D_POINT||e._renderColorMode===WS.RendererBase.RenderMode.PICK_3D;if(this._activated){if(i||t(this)){mat4.multiply(e._camera._transform,e.getModelMatrix(),this._mvMatrix);var n=i?t:void 0;this.drawMemberRenderables3d(e,WS.PointCloudRenderable.getIsPointsAndVisible(WS.DynamicPointShaderDesc,n),!1),this.drawMemberRenderables3d(e,WS.PointCloudRenderable.getIsPointsAndVisible(WS.VoronoiPointShaderDesc,n),!1)}this._dbgShowBBoxes&&!i&&this.drawMemberRenderables3d(e,WS.PointCloudRenderable.getIsNoPointsAndVisible(t),!1)}},drawMemberRenderables3d:function(e,t){for(var i=this.getVisibleMemberRenderables(),n=0,o=i.length;o>n;n++){var r=i[n];r.draw3d(e,t,!1)}},draw2d:function(){},dbgDlVisibleNodes:function(){var e={},t=console,i=this._visibleNodes;t.log(i.length,"visible nodes");for(var n=0;n<i.length;n++)e[i[n]._shortID]=n+1;var o="digraph {\ngraph [nodesep=0.02 ranksep=0.25];\nnode [margin=0 fontsize=9 width=0.3 height=0.3];\n",r=this._dataObject.getTreeStructure();for(var a in r)o+=e[a]?a+' [label="'+e[a]+'",style=filled,color=".7 .3 1.0"];\n':a+' [label=""];\n',a.length>1&&(o+=a.substring(0,a.length-1)+" -> "+a+";\n");o+="}";var s=document.createElement("a");s.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(o)),s.setAttribute("download","nodelist.txt"),s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},dbgAddBBoxRenderable:function(e){for(var t=new WS.LinesRenderable(new WS.ArrayBuffer(new MatrixArray(72),3),this._dbgLodColors[e._shortID.length]),i=t._geometry._positionBuffer,n=WS.Box3dRenderable.WIREFRAME_INDICES,o=e._min,r=e._max,a=n.length-1;a>=0;a--){var s=n[a],c=s%2>=1?r[0]:o[0],l=s%4>=2?r[1]:o[1],h=s%8>=4?r[2]:o[2],d=a>0;i.setItem(a,[c,l,h],d)}t._material._depthTest=!0,t.addToLayer(WS.Layer.LayerIDs.TEMP),this._dbgBBoxRenderables[e._shortID]=t},dbgRemoveBBoxRenderable:function(e){this._view.deleteStorageForRenderableAndMembers(this._dbgBBoxRenderables[e]),delete this._dbgBBoxRenderables[e]},dbgShowLod:function(e){this._dbgShowLod=e,this._prs.forEach(function(t){t._material._useFixedColor=e})},dbgShowBBoxes:function(e){if(this._dbgShowBBoxes=e,e){var t=this._dataObject.getTreeStructure();if(t)for(var i in this._prIndex)this._dbgBBoxRenderables[i]||this.dbgAddBBoxRenderable(t[i])}else for(var n in this._dbgBBoxRenderables)this.dbgRemoveBBoxRenderable(n)},dbgGetLodColors:function(){for(var e=Math.max(2,this._dataObject._depth),t=[],i=1;e>=i;i++){var n=1-(i-1)/(e-1);t[i]=new WS.ArrayBuffer([Math.max(0,Math.min(1,.25>=n?1:2-4*n)),Math.max(0,Math.min(1,.5>=n?4*n:4-4*n)),Math.max(0,Math.min(1,.75>=n?-2+4*n:1)),1],4)}return t},dbgGetRenderables:function(e){var t=F.cloneArray(e?this._visiblePrs:this._prs);for(var i in this._dbgBBoxRenderables)this._visiblePrs[this._vrIndex[i]]&&t.push(this._dbgBBoxRenderables[i]);return t}},WS.extend("PointCloudRenderable","Renderable"),WS.PointCloudRenderable.SIZE_FACTOR=1.25,WS.PointCloudRenderable.VORONOI_FACTOR=2,WS.PointCloudRenderable.MIN_CAMERA_IDLE_COUNT=6,WS.PointCloudRenderable.MIN_PIXELS=64,WS.PointCloudRenderable.RATINGS_WITHIN_CAMERA=[100,60,30,22.5,17.5,15,13.5,12.5,11.75,11.25],WS.PointCloudRenderable.MAX_CENTER_BONUS=10,WS.PointCloudRenderable.State={START:0,START_IDLE:1,REST_DRAW:2,REST_READ:3,REST_COUNT:4,REST_IDLE:5,MOVE:6},WS.PointCloudRenderable.Draw={ABORT:0,NO:1,KEEP:2,ADD:3,ALL:4},WS.PointCloudRenderable.BUDGET_MOVE={VeryLow:12e5,Low:14e5,Medium:15e5,High:18e5,VeryHigh:18e5},WS.PointCloudRenderable.BUDGET_STILL={VeryLow:2e6,Low:65e5,Medium:85e5,High:13e6,VeryHigh:18e6},WS.PointCloudRenderable.combineDrawStates=function(e,t){return t>=e?t:e},WS.PointCloudRenderable.getIsPointsAndVisible=function(e,t){return function(i){return i instanceof WS.DynamicPointRenderable&&i._material._shaderProgramDesc===e&&(!t||t(i))}},WS.PointCloudRenderable.getIsNoPointsAndVisible=function(e){return function(t){return!(t instanceof WS.DynamicPointRenderable||e&&!e(t))}},WS.ScanCloudRenderable=function(e,t,i,n,o){WS.DynamicPointRenderable.call(this,new WS.ArrayBuffer([],3),new WS.ArrayBuffer([],4,WS.Buffer.ItemDataType.UBYTE),1,void 0,!1),this.setDataObject(e),this._transform=e.calcTrafoInRefSystem(o._trafoView),this._view=o,this._activated=!1,this._scanService=t,this._width=i,this._candidates=void 0,this._colorMode=n,this._lowZ=void 0,this._highZ=void 0,this._pickable3d=!0,this._state=void 0,this._inTransition=!1,this.determineModeAndWidth(),this.addToLayer(WS.Layer.LayerIDs.POINT_CLOUD,!0)},WS.ScanCloudRenderable.prototype={activate:function(){var e=this,t=this._dataObject,i=this._width,n=this._colorMode;this._activated=!0;var o,r,a=this._scanService.loadDistanceImage(t,i);if("elevation"!==n){var s=t.getSimilarAvailablePanoImage(i,n),c=new WS.Image(t.getImagePath(s),WS.Image.Filter.Nearest);o=new WS.CanvasTexture(c),r=o.getPromise()}else r=Q.resolve();Q.all([a,r]).spread(function(r){e._dataObject===t&&e._colorMode===n&&e._width===i&&(e.updatePoints(r,o?o._canvasData:void 0),o&&o.destroy())}).done()},deactivate:function(){this._activated=!1,this._inTransition=!1},isActive:function(){return this._activated},unload:function(e){e.deleteStorageForRenderableAndMembers(this),this._geometry._positionBuffer.setBufferData([]),this._material._colorBuffer.setBufferData([]),this._lowZ=void 0,this._highZ=void 0,this._inTransition=!1},update:function(){if(!this._activated||!this._view.isCameraInitialized())return WS.PointCloudRenderable.Draw.NO;this.updateState(),this.setPointSize({physical:this._state===WS.ScanCloudRenderable.State.MOVE?.064:.002,minPixel:2,maxPixel:20});var e;return e=this._state===WS.ScanCloudRenderable.State.REST_IDLE?WS.PointCloudRenderable.Draw.KEEP:WS.PointCloudRenderable.Draw.ALL,this._inTransition&&(e=WS.PointCloudRenderable.Draw.ALL),this._geometry._positionItemsToUse=this._state===WS.ScanCloudRenderable.State.MOVE?this._candidates:void 0,e},updateState:function(){var e=this._view._cameraIdleCount,t=WS.PointCloudRenderable.MIN_CAMERA_IDLE_COUNT;this._state=1===this._dbgMove||t>e?WS.ScanCloudRenderable.State.MOVE:e===t?WS.ScanCloudRenderable.State.REST_DRAW:WS.ScanCloudRenderable.State.REST_IDLE},useIncrRendering:function(){return this._state===WS.ScanCloudRenderable.State.REST_DRAW||this._state===WS.ScanCloudRenderable.State.REST_IDLE},shouldShowLoading:function(){return!1},updateWidthAndMode:function(e,t,i){var n=this._width,o=this._colorMode;this._width=e,this._colorMode=t,this.determineModeAndWidth(),(this._width!==n||this._colorMode!==o)&&(this.deactivate(),this.unload(i),this.activate())},isLoaded:function(){return this._geometry._positionBuffer.hasData()},determineModeAndWidth:function(){if("blend"===this._colorMode&&(this._colorMode="color"),"elevation"===this._colorMode)this._width=this._dataObject.getSimilarAvailableDistanceImage(this._width);else{var e=this._dataObject.getSimilarAvailablePanoImage(this._width,this._colorMode),t=this._dataObject.getSimilarAvailableDistanceImage(this._width);this._width=Math.min(e.width,t),this._colorMode=e.colorModeId}},updatePoints:function(e,t){var i=this._width,n=i/2,o=0,r=0,a=new Float32Array(3*i*n),s=new Uint8Array(4*i*n),c=0,l=0,h=0,d=0,u=3*i*n-1,p=4*i*n-1,_=1/n,g=1/i*2*Math.PI,f=.9;i>2048&&(f=1.01),i>4096&&(f=3.01);for(var m=Math.ceil(f),v=0;n>v;++v)for(var S=(v+.5)*_*Math.PI,b=Math.sin(S),y=Math.cos(S),P=Math.ceil(f/Math.cos(S-Math.PI/2)),C=0;i>C;++C){var w=e[c];if(0!==w){var T=(C+.5)*g;v%m===0&&C%P===0?(o++,a[h++]=w*Math.cos(-T)*b,a[h++]=w*Math.sin(-T)*b,a[h++]=w*y,t&&(s[d++]=t[l],s[d++]=t[l+1],s[d++]=t[l+2],s[d++]=255)):(r++,a[u--]=w*y,a[u--]=w*Math.sin(-T)*b,a[u--]=w*Math.cos(-T)*b,t&&(s[p--]=255,s[p--]=t[l+2],s[p--]=t[l+1],s[p--]=t[l]))}l+=4,c+=1}var M=new Float32Array(3*(o+r)),W=new Uint8Array(4*(o+r));M.set(a.subarray(0,3*o)),W.set(s.subarray(0,4*o)),r>0&&(M.set(a.subarray(u+1),3*o),W.set(s.subarray(p+1),4*o)),this._candidates=o,this._geometry._positionBuffer.setBufferData(M),this._material._colorBuffer.setBufferData(W),this.setPointSize({physical:8.192/i,minPixel:2,maxPixel:40})},onViewingModeChange:function(){},draw3d:function(e,t){this._activated&&WS.DynamicPointRenderable.prototype.draw3d.call(this,e,t,!1)}},WS.extend("ScanCloudRenderable","DynamicPointRenderable"),WS.ScanCloudRenderable.DetailWidth={VeryLow:512,Low:1024,Medium:2048,High:4096,VeryHigh:8192},WS.ScanCloudRenderable.State={REST_DRAW:WS.PointCloudRenderable.State.REST_DRAW,REST_IDLE:WS.PointCloudRenderable.State.REST_IDLE,MOVE:WS.PointCloudRenderable.State.MOVE},WS.WorkerLauncher=function(e){this._workerUrl=e,this._listeners=[],this._pool=[],this._running=0},WS.WorkerLauncher.prototype={addListener:function(e){F.addUnique(this._listeners,e)},removeListener:function(e){F.removeFirst(this._listeners,function(t){return t===e})},runWorker:function(e){var t,i=this;0===this._pool.length?(t=new Worker(this._workerUrl),t.addEventListener("message",function(e){i._pool.push(t),i._running--,i._listeners.forEach(function(t){t(e)})})):t=this._pool.pop(),t.postMessage(e),this._running++}},F.DI().registerService("pointcloud",WS.PointCloudService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource","@projectdatacdn"),F.DI().config("@serializer","@pointcloud",function(e,t){e.registerClass("WSPointCloud",function(){return t.getNew()}),e.registerClass("PointCloudNode",function(){return new WS.PointCloudNode}),e.registerClass("PointCloudRootNode",function(){return new WS.PointCloudNode})}),WS.Orthophoto=function(e){WS.Transformation.call(this,e),this._class="Orthophoto",this._description=void 0,this._hyperlinks=[],this._width=void 0,this._height=void 0,this._scale=void 0,this._minDepth=void 0,this._maxDepth=void 0,this._scanUUIDs=void 0,this._colorMode=void 0,this._gapFiller=void 0,this._previewSizes=void 0,this._previewSizesSquare=void 0,this._temporary=!1,this._imageSizes=void 0,this._imageWidths=void 0,this._imageHeights=void 0,this._hideImage=!1},WS.Orthophoto.prototype={readJson:function(e){WS.Transformation.prototype.readJson.call(this,e),this.readHyperlinksJson(e),this._description=e.Description,this._width=e.Width,this._height=e.Height,this._scale=e.Scale,this._minDepth=e.MinDepth,this._maxDepth=e.MaxDepth,this._scanUUIDs=e.ScanUUIDs,this._colorMode=e.ColorMode,this._gapFiller=e.GapFiller,this._previewSizes=e.PreviewSizes,this._previewSizesSquare=e.PreviewSizesSquare,this.setImageSizes()},writeJson:function(){var e=WS.Transformation.prototype.writeJson.call(this);return this.writeHyperlinksJson(e),e.Class=this._class,e.Description=this._description,e.Width=this._width,e.Height=this._height,e.Scale=this._scale,e.MinDepth=this._minDepth,e.MaxDepth=this._maxDepth,e.ScanUUIDs=this._scanUUIDs,e.ColorMode=this._colorMode,e.GapFiller=this._gapFiller,e.PreviewSizes=this._previewSizes,e.PreviewSizesSquare=this._previewSizesSquare,e},writeChanges:function(){var e=WS.Transformation.prototype.writeChanges.call(this);return this.writeHyperlinksChanges(e)},setImageSizes:function(){this._previewSizes||(this._previewSizes=[]),this._previewSizesSquare||(this._previewSizesSquare=[]);var e=this._height<=this._width,t=this.getAspectRatio();this._imageSizes=e?[this._width].concat(this._previewSizes):[this._height].concat(this._previewSizes),this._imageWidths=[this._width],this._imageHeights=[this._height];for(var i=0,n=this._previewSizes.length;n>i;++i)e?(this._imageWidths.push(this._previewSizes[i]),this._imageHeights.push(Math.max(Math.round(this._previewSizes[i]/t),1))):(this._imageWidths.push(Math.max(Math.round(this._previewSizes[i]*t),1)),this._imageHeights.push(this._previewSizes[i]))
},getImagePathByIndex:function(e){return"/data/project/"+this._project+"/orthophoto/"+this._UUID+(void 0!==e&&0!==e?"/"+this._imageSizes[e]:"")},getSquareImagePathBySize:function(e){return"/data/project/"+this._project+"/orthophoto/"+this._UUID+"/"+e+"/square"},getImagePaths:function(){for(var e=[],t=this._imageSizes.length,i=0;t>i;++i)e.push(this.getImagePathByIndex(i));return e},getWidthInMeter:function(){return this._width/this._scale},getHeightInMeter:function(){return this._height/this._scale},getAspectRatio:function(){return this._width/this._height},getDepthInMeter:function(){return this._maxDepth-this._minDepth},getIndexOfBestFit:function(e){if(this._imageSizes[0]<=e)return 0;for(var t=this._imageSizes.length,i=1;t>i;++i)if(this._imageSizes[i]<=e)return i;return t-1},getImageCenterGlobal:function(){var e=vec3.create([.5*this.getWidthInMeter(),.5*this.getHeightInMeter(),0]);return mat4.multiplyVec3(this._trafoGlobal,e,vec3.create())},getVolumeCenterGlobal:function(){var e=vec3.create([.5*this.getWidthInMeter(),.5*this.getHeightInMeter(),(this._minDepth+this._maxDepth)/2]);return mat4.multiplyVec3(this._trafoGlobal,e,vec3.create())},getImageCornersGlobal:function(){var e=this,t=this.getWidthInMeter(),i=this.getHeightInMeter(),n=[vec3.create([0,0,0]),vec3.create([t,0,0]),vec3.create([t,i,0]),vec3.create([0,i,0])];return n.map(function(t){return mat4.multiplyVec3(e._trafoGlobal,t,vec3.create())})},createRenderable:function(e){var t,i=this._temporary&&e._type===WS.Layer.ViewTypes.OVERVIEW_MAP,n=!this._temporary,o=this._temporary,r=this._temporary;this._hideImage&&(t={},t.imagePlaneAlphas={},t.imagePlaneAlphas[WS.Renderable.ViewingMode.Normal]=0,t.imagePlaneAlphas[WS.Renderable.ViewingMode.Selected]=0);var a=new WS.OrthoBox3dRenderable(r,t,i,n,o),s=this._temporary?WS.Layer.LayerIDs.TEMP:WS.Layer.LayerIDs.ORTHOPHOTOS;a.addToLayer(s,!0),a.setDataObject(this);var c=this;return a.update=function(t){if(!(c._trafoGlobal&&c._scale&&c._width&&c._height&&void 0!==c._maxDepth&&void 0!==c._minDepth))return void a.setSize(t,void 0);var i=c._width/c._scale,n=c._height/c._scale,o=c._minDepth-c._maxDepth,r=c._maxDepth;a._transform=c.calcTrafoInRefSystem(e._trafoView),a.setSize(t,i,n,o,r),a.updateAppearance(t)},a.update(),a},canBeShownInView:function(){return!0},areOrthoImagesAvailable:function(){return this._service.areOrthoImagesAvailable(this._UUID)},isHorizontal:function(){var e=this.getImageCornersGlobal(),t=Math.abs(e[2][2]-e[0][2]);return.01>=t}},WS.extend("Orthophoto","Transformation"),WS.mixin("Orthophoto","HyperlinkedObject"),WS.OrthophotoService=function(e,t,i,n,o,r,a,s,c){F.ProjectCRUDService.call(this,"Orthophoto",WS.Orthophoto,"/orthophoto",{},e,t,i,n,o,r,a,s,c),this._restImage=this._resource("/data/project/:project/orthophoto/:uuid/:size/:square",{},{read:{method:"GET",params:{}}})},WS.OrthophotoService.prototype={areOrthoImagesAvailable:function(e){var t=Q.defer();return this._restImage.read({project:this._project.getCurrent(),uuid:e,size:"64",square:"square"},function(){t.resolve(!0)},function(){t.resolve(!1)}),t.promise},remove:function(e,t){return F.ProjectCRUDService.prototype.remove.call(this,e,t).fail(function(e){throw"IntegrityViolationException"===e._type&&(e.message="EM_JOB_DEL_OBJ"),e})}},WS.extend("OrthophotoService","ProjectCRUDService"),WS.TempOrthophoto=function(e){WS.Orthophoto.call(this,e),this._class="TempOrthophoto",this._UUID=F.generateUUID(),this._temporary=!0,this._isFocusable=!1},WS.extend("TempOrthophoto","Orthophoto"),WS.TempOrthophotoService=function(e,t,i,n,o,r,a,s,c){WS.ProjectCRUDService.call(this,"TempOrthophoto",WS.TempOrthophoto,"/orthodummy",{},e,t,i,n,o,r,a,s,c)},WS.TempOrthophotoService.prototype={getAll:function(){return Q.resolve(F.cloneArray(this._entities))},getByID:function(e){var t=F.findFirst(this._entities,function(t){return t.getID()===e});return t?Q.resolve(t):Q.reject(new Error("EXCEPTION_MESSAGE_FIND_OBJECT"))},create:function(e){var t=F.addUnique(this._entities,e);return t&&this.trigger("addObjects",[[e]]),Q.resolve()},update:function(e){var t=this._entities.indexOf(e)>=0;return t&&this.trigger("updateObjects",[[e]]),Q.resolve()},remove:function(e){var t=F.removeFirst(this._entities,e);return t&&(e.unselect(),this.trigger("removeObjects",[[e]])),Q.resolve()}},WS.extend("TempOrthophotoService","ProjectCRUDService"),F.DI().config("@task",function(e){this.registerParameter("orthophotoselection","Orthophoto"),this.registerParameter("orthophotocolumnconfig",{name:!0,position:!1,category:!0,tags:!0,view:!0,writeAccess:!0,preview:!0}),this.registerController("orthophoto",WS.ObjectList,"$filter","@plug","@url","@orthophoto","@project","@pointcloud","@selection","@alert","@login","@panosettings","%orthophotoselection%","%orthophotocolumnconfig%"),this.registerService("orthophoto",WS.OrthophotoService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),this.registerService("temporthophoto",WS.TempOrthophotoService,"@serializer","@error","@project","@selection","@plug","@login","@revision","?@workspace","$resource"),WS._2GO||e.registerTaskFactory("default","overviewmap","orthophoto",WS.OrthoPhotoMapTask,"@plug","@point3d","@orthophoto","@temporthophoto","@jobqueue","@category","@tag","@layer","@project","@unit")}),F.DI().config("@serializer","@orthophoto",function(e,t){e.registerClass("Orthophoto",function(){return t.getNew()})}),angular.module("ws.widget").directive("orthophotolist",function(){return WS.PlugController.createDirective({scope:{caption:"@",collapsed:"="},link:function(e,t,i){e.galleryid=i.id+"ig"},controllerClass:F.DI().getController("orthophoto"),template:'<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'})}),WS.ProjectPageBase=function(e,t,i,n,o,r,a,s){var c=this;F.Embeddable.call(this,e,t,i),this._project=n,this._pointCloud=o,this._panoSettings=r,this._alert=a,this._login=s,e.pickProject=F.proxy(this.pickProject,this),e.openMap=function(e){c.trigger("showObjects",[[e._name],"map"])},e.openScanView=function(){c.trigger("showObjects",[[],"pano/3d"])},e.openWorkbench=function(e){c.trigger("showObjects",[[e],"workbench"])},this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this,this._project),this.connect(this,this._login)},WS.ProjectPageBase.prototype={pickProject:function(e){var t=this;if(e._type===WS.Project.Type.WSC)this.trigger("showObjects",[[e._name],"map"]);else{var i=this._project.isCurrent(e._name)?Q.resolve():this._project.changeProject(e._name);i.then(function(){t._pointCloud.getLatestPointCloud().then(function(e){e&&t._panoSettings.isWebGlEnabled()?t.trigger("showObjects",[[e],"3d"]):(t._alert.message(e?"FE_NEED_WEBGL_FOR_3D":"EM_3D_NA"),t.launchTask("default","object"))},function(e){t._alert.errorObj(e),t.launchTask("default","object")})})}},login:function(){var e=this;this._login.isProjectManager().then(function(t){e.$scope.$apply(function(e){e.isPM=t})}).done()},logout:function(){this.$scope.$apply(function(e){e.isPM=!1})},updateAccount:function(){}},WS.extend("ProjectPageBase","Embeddable"),WS.ProjectSelector=function(e,t,i,n,o,r,a,s,c,l){WS.ProjectPageBase.call(this,e,n,a,t,s,c,l,o);var h=this;this._cookie=r,this._worldmap=void 0,e.page={query:""},e.projects=[],e.projectNames=[],e.featuredProjects=[],e.setWorldmap=F.proxy(this.setWorldmap,this),e.showProjectOnMap=F.proxy(this.showProjectOnMap,this),e.openProjectDetails=F.proxy(this.openProjectDetails,this),e.pageconfig={mode:"thumbnails",showmap:!F.isMobile(),showfeatured:!F.isMobile()},e.page={predicate:"_displayName",sortby:"FE_PROJECT_NAME",reverse:!1,query:""},this._projectsPromise=void 0,e.getProjects=function(){return h._projectsPromise},e.error=void 0,e.errormap=void 0,e.setPredicate=function(t,i){e.page.reverse=e.page.predicate===t?!e.page.reverse:!1,e.page.predicate=t,e.page.sortby=i},e.setToolTipFTBox=function(e){return e?"FE_HIDE_FT_BOX":"FE_SHOW_FT_BOX"},e.setToolTipMap=function(e){return e?"FE_HIDE_MAP":"FE_SHOW_MAP"},e.storePageConfig=function(){h.storePageConfig()},e.$watch("page.query",function(){h.updateURL(!0)}),e.toggleFeatSlide=function(e){var t=$(".carousel");t.carousel(e)},e.initCarousel=function(){var e=$(".carousel");e.carousel({interval:7500})},this._cookieId="projectselector",this.provideMalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("ProjectSelect",["select","unselect"]),this.connect(this.getFemalePlug("ProjectSelect"),i.getSelection("Project"))},WS.ProjectSelector.prototype={updateProjects:function(){var e=this;this._login.isProjectManager().then(function(t){e._projectsPromise=e._project.getAllWithStates(t?["Completed","Draft","Published"]:["Completed","Published"]),e._projectsPromise.then(function(t){e.$scope.$apply(function(e){e.projects=t,e.featuredProjects=t.filter(function(e){return e._featured})})}).done()}).done()},setWorldmap:function(e){this._worldmap=e},showProjectOnMap:function(e){this._worldmap&&(this._worldmap.setView([e._latitude,e._longitude],16),this.$scope.scrollToMap())},openProjectDetails:function(e){this.trigger("showObjects",[[e],"projectdetails"])},select:function(){this.$scope.$apply()},unselect:function(){this.$scope.$apply()},addObjects:function(e){this.$scope.$apply(function(t){for(var i=0;i<e.length;i++){var n=e[i];"Completed"===n._uploadState&&(F.addUnique(t.projects,n),n._featured&&F.addUnique(t.featuredProjects,n))}})},updateObjects:function(){this.$scope.$apply()},removeObjects:function(e){this.$scope.$apply(function(t){e.forEach(function(e){F.removeFirst(t.projects,e),F.removeFirst(t.featuredProjects,e)})})},onShow:function(){F.Embeddable.prototype.onShow.call(this),this.updateProjects()},onConfigure:function(e){if(!e||!e.noReconfigure){var t=JSON.parse(this._cookie.getLocalStorageItem(this._cookieId));t&&(this.$scope.pageconfig=t)}},login:function(){WS.ProjectPageBase.prototype.login.call(this),this._visible&&this.updateProjects()},logout:function(){WS.ProjectPageBase.prototype.logout.call(this),this._visible&&this.updateProjects()},storePageConfig:function(){this._cookie.setLocalStorageItem(this._cookieId,JSON.stringify(this.$scope.pageconfig))},updateURL:function(e){var t={};this.$scope.page.query&&(t.q=encodeURIComponent(this.$scope.page.query).replace(/%/gi,"$")),this._url.setFragment(this._id,this._url.encode(t),[],e)},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query)}},applyURL:function(e,t){if(e==this._id){var i=t.get(this._id),n=this._url.decode(i.query);this.$scope.$apply(function(e){e.page.query=decodeURIComponent((n.q||"").replace(/\$/gi,"%"))})}}},WS.extend("ProjectSelector","ProjectPageBase"),WS.ProjectDetails=function(e,t,i,n,o,r,a,s){WS.ProjectPageBase.call(this,e,i,n,t,r,a,s,o);var c=this;this._promise=void 0,e.getProject=function(){return c._promise},e.overview=!1,e.$on("launchTask",function(t,i){e.panel=i}),this.provideFemalePlug("ObjectShow",["showObjects"]),this.provideMalePlug("ObjectShow",["showObjects"])},WS.ProjectDetails.prototype={showObjects:function(e,t){var i=e[0];"projectdetails"==t?(this._project.changeProject(i._name),this.changePage()):"workbench"===t&&(this._project.changeProject(i._name),this.launchTask("workbench","projectselector",void 0,void 0,{noNavigation:!0}),this.changePage())},loadProject:function(e){this._promise=this._project.getCurrentProject(),e&&(this._promise=this._promise.then(function(e){return e})),this.$scope.$apply()},addObjects:function(){},updateObjects:function(e){if(this._project.hasCurrent()&&0!==e.length){var t=this._project.getCurrent();e.some(function(e){return e._name===t})&&this.loadProject(!0)}},removeObjects:function(){},login:function(){WS.ProjectPageBase.prototype.login.call(this),this._visible&&this.loadProject()},logout:function(){WS.ProjectPageBase.prototype.logout.call(this),this._promise=void 0},updateAccount:function(){WS.ProjectPageBase.prototype.updateAccount.call(this),this._visible&&this.loadProject()},onShow:function(){WS.ProjectPageBase.prototype.onShow.call(this),this.loadProject()},onConfigure:function(e){e&&(this.$scope.overview=e.task)},updateURL:function(){this._url.setFragment(this._id,"",["p"])},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query,["p"])}},applyURL:function(e){e==this._id&&this._visible&&this.loadProject()}},WS.extend("ProjectDetails","ProjectPageBase"),WS.ObjectList=function(e,t,i,n,o,r,a,s,c,l,h,d,u){var p=this;this._service=o,this._project=r,this._pointCloud=a,this._alert=c,this._panoSettings=h,this._selectionName=d,this._promise=void 0,e.Math=window.Math,e.getObjects=function(){return p._promise},e.page={objects:[],index:0,limit:20,predicate:"_displayName",reverse:!1,sortby:"FE_NAME",query:""},e.selection=!0,e.taskName=void 0,e.columnconfig=u,e.canShowInMap={},e.canShowInPano={},e.canShowIn3d={},e.showObjects=function(e,t){p.trigger("showObjects",[e,t])},e.focusObject=function(e,t){p.trigger("focusOn",[{object:e},t])},e.imagegallerySetup=function(t,i){p.trigger("showObjects",[e.getOrdered(),"gallery",{object:t,colormode:i}])},e.setPredicate=function(t,i){e.page.reverse=e.page.predicate===t?!e.page.reverse:!1,e.page.predicate=t,e.page.sortby=i,e.page.index=0},this._objectSelection=s.getSelection(d),this._objectFilter=t("objectfilter"),this._orderFilter=t("orderBy"),this._paginateFilter=t("paginate"),e.getFiltered=function(){return p._objectFilter(e.page.objects,e.page.query,e.columnconfig)},e.getOrdered=function(){return p._orderFilter(e.getFiltered(),e.page.predicate,e.page.reverse)},e.getVisible=function(){return p._paginateFilter(e.getOrdered(),e.page.index,e.page.limit)},e.$watch("getFiltered().length",function(t){e.filteredlength=t}),e.changeSelection=function(t){e.task&&e.selection?t.toggleSelection():!e.task||"Scan"===t._class&&"RemoveTask"===e.taskName||p._alert.message("IM_NOT_IN_SELECTIONMODE")},e.changeSelectionAll=function(t){switch(t){case"all":p._objectSelection.selectMulti(e.getOrdered());break;case"visible":p._objectSelection.selectMulti(e.getVisible());break;case"none":p._objectSelection.clear()}},WS.Embeddable.call(this,e,i,n),this.provideMalePlug("ObjectShow",["showObjects"]),this.provideMalePlug("ViewFocus",["focusOn"]),this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideFemalePlug(d+"Select",["select","unselect"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.provideFemalePlug("SettingsUpdate",["updateSettings"]),this.connect(this,this._service),this.connect(this._objectSelection,this),this.connect(this,l),this.connect(this,h),this.autoConnect(e)},WS.ObjectList.prototype={addModule:function(e){WS.Embeddable.prototype.addModule.call(this,e),this.connect(this,e)},addObjects:function(e){var t=this.$scope;F.addObjectsByID(t.page.objects,e),this.updateButtons(e),t.$apply("page.index = 0"),t.$emit("objectsLength",this,t.page.objects.length)},updateObjects:function(){this.$scope.$apply()},removeObjects:function(e){var t=this.$scope;F.removeObjectsByID(t.page.objects,e),e.forEach(function(e){delete t.canShowInMap[e._UUID],delete t.canShowInPano[e._UUID],delete t.canShowIn3d[e._UUID]}),t.$apply("page.index = 0"),t.$emit("objectsLength",this,t.page.objects.length)},select:function(){this.$scope.$apply()},unselect:function(){this.$scope.$apply()},refresh:function(){this._promise=this._visible?this.getAll():void 0},onShow:function(){WS.Embeddable.prototype.onShow.call(this),this.refresh()},onConfigure:function(e){e&&e.noReconfigure||(this.$scope.selection=!1,this.$scope.task=!1,e&&(e.selection&&-1!=e.selection.split(",").indexOf(this._selectionName.toLowerCase())&&(this.$scope.selection=!0),this.$scope.task=e.task,this.$scope.taskName=e.name))},updateURL:function(e){this._url.setFragment(this._id,"",["p"],e)},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query,["p"])}},getAll:function(){var e=this;if(this._project.hasCurrent()){var t={project:this._project.getCurrent()};return this._service.getAll(t).then(function(t){return e.$scope.$emit("objectsLength",e,t.length),t})}return Q.resolve([])},login:function(){this.refresh(),this.updateButtons(this.$scope.page.objects)},logout:function(){this._promise=void 0},updateAccount:function(){},updateSettings:function(e){"panorama"===e&&this.updateButtons(this.$scope.page.objects)},updateButtons:function(e){var t=this,i=this.$scope;if(this._project.getCurrentProject().then(function(t){var n=t.hasOverviewMap(),o=t.hasScan();e.forEach(function(e){i.canShowInMap[e._UUID]=n&&e.canBeShownInView("map"),i.canShowInPano[e._UUID]=o&&e.canBeShownInView("panorama")}),i.$apply()}),this._panoSettings.isWebGlEnabled()){var n=e.map(function(e){return e instanceof WS.PointCloud?Q.resolve(!1):t._pointCloud.canShowObjectIn3d(e).then(function(t){i.canShowIn3d[e._UUID]=t})});Q.allSettled(n).then(i.$apply.bind(i))}else e.forEach(function(e){i.canShowIn3d[e._UUID]=!1}),i.$apply()}},WS.extend("ObjectList","Embeddable"),WS.ObjectPropertiesPage=function(e,t,i,n,o,r,a,s,c){WS.Embeddable.call(this,e,t,n);var l=this;this._login=i,this._projectService=o,this._pointCloud=r,this._panoSettings=a,this._locale=s,this._unit=c,this._project=void 0,e.cs=WS.UnitService.CS.GLOBAL,e.customCaption="",e.hasCustom=!1,e.setGlobal=function(){e.cs=WS.UnitService.CS.GLOBAL},e.setCustom=function(){e.cs=WS.UnitService.CS.PROJECT},e.setLocal=function(){e.cs=WS.UnitService.CS.LOCAL},e.isGlobal=function(){return e.cs===WS.UnitService.CS.GLOBAL},e.isCustom=function(){return e.cs===WS.UnitService.CS.PROJECT},e.isLocal=function(){return e.cs===WS.UnitService.CS.LOCAL},e.getPos=function(e){return l.getPos(e.getTranslationGlobal(),e.getTranslationLocal())},e.getCentroid=function(e){return l.getPos(e._centroidGlobal,e._centroidLocal)},e.getPosInCSSpecial=function(t){return e.isCustom()?mat4.posInRefSystem(t,l._project._trafo):t},e.getPositionsInCS=function(t){return e.isLocal()?t._pointsLocal:e.isCustom()?mat4.positionsInRefSystem(t._pointsGlobal,l._project._trafo):t._pointsGlobal},e.obj=void 0,e.canShowInMap=void 0,e.canShowInPano=void 0,e.canShowIn3d=void 0,e.canShowInAny=void 0,e.picker={index:void 0,widths:void 0,heights:void 0,paths:void 0,showResolutions:void 0,showOpen:void 0,showRefresh:void 0},this._objectClass=void 0,this._objectUUID=void 0,this._promise=void 0,e.getPromise=function(){return l._promise},e.showObjects=function(e,t){l.trigger("showObjects",[e,t])},e.focusObject=function(e,t,i){var n={object:e,root:i,rootType:i?"scan":void 0};l.trigger("focusOn",[n,t])},e.refresh=function(){l._visible&&l._objectClass&&l._objectUUID&&l.loadObject(l._objectUUID,l._objectClass)},this.provideMalePlug("PageSelect",["selectPage","selectPageClass"]),this.provideMalePlug("ObjectShow",["showObjects"]),this.provideMalePlug("ViewFocus",["focusOn"]),this.provideFemalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this,i),this.connect(this,a)},WS.ObjectPropertiesPage.prototype={getPos:function(e,t){return this.$scope.isLocal()?t:this.$scope.isCustom()?mat4.posInRefSystem(e,this._project._trafo):e},loadObject:function(e,t){var i=this;this._promise=Q.all([F.DI().getService(t).getByID(e),this._projectService.getCurrentProject()]).spread(function(e,t){return i._project=t,i.initByObject(e),e},function(e){throw F.handled(e),e}),this._promise.done()},showObjects:function(e,t){var i=this;if(e.length&&"properties"===t){var n=e[0];this._objectClass=(n.instanceOf(WS.TempMeasurement)?"temp":"")+n._class.toLowerCase(),this._objectUUID=n._UUID,this._promise=Q.all([Q.resolve(n),this._projectService.getCurrentProject()]).spread(function(e,t){return i._project=t,i.initByObject(e),e},function(e){throw F.handled(e),e}),this._promise.done(),this.updateURL(),this.updateUserAndRights(),this.changePage()}},initByObject:function(e){this.$scope.obj=e,this.initCS(),this.initPickerForOrthophoto(e),this.checkOrthoImage(e),this.updateButtons(e)},initCS:function(){var e=this.$scope;e.hasCustom=void 0!==this._project._trafo,e.hasCustom&&this._unit.isCustomCS()?(e.customCaption=this._project._trafoName||this._locale.translate("FE_PROJECT"),e.setCustom()):(e.customCaption="",e.setGlobal())},initPickerForOrthophoto:function(e){if(e instanceof WS.Orthophoto){var t=this.$scope.picker;this.$scope.$apply(function(){t.widths=e._imageWidths,t.heights=e._imageHeights,t.paths=e.getImagePaths(),t.index=e.getIndexOfBestFit(1024),t.showResolutions=void 0,t.showOpen=void 0,t.showRefresh=void 0})}},checkOrthoImage:function(e){if(e instanceof WS.Orthophoto){var t=this.$scope,i=this.$scope.picker;e.areOrthoImagesAvailable().then(function(e){t.$apply(function(){i.showResolutions=e,i.showOpen=e,i.showRefresh=!e})}).done()}},updateUserAndRights:function(){var e=this;this._login.getUsername().then(function(t){e.$scope.$apply('username = "'+t+'"')}).done(),this._login.isUser().then(function(t){e.$scope.$apply("isUser = "+t)}).done(),this._login.isProjectManager().then(function(t){e.$scope.$apply("isProjectManager = "+t)}).done(),this._login.isLoggedIn().then(function(t){e.$scope.$apply("isLoggedIn = "+t)}).done()},updateSettings:function(e){switch(e){case"panorama":this.$scope.obj&&this.updateButtons(this.$scope.obj);break;case"unit":this.$scope.obj&&this.initCS()}},updateButtons:function(e){var t=this.$scope;t.canShowInMap=void 0,t.canShowInPano=void 0,t.canShowIn3d=void 0,t.canShowInAny=void 0,t.canShowInMap=this._project.hasOverviewMap()&&e.canBeShownInView("map"),t.canShowInPano=this._project.hasScan()&&e.canBeShownInView("panorama"),t.canShowInAny=t.canShowInAny||t.canShowInMap||t.canShowInPano,t.$apply();var i=this._panoSettings.isWebGlEnabled()?this._pointCloud.canShowObjectIn3d(e):Q.resolve(!1);i.then(function(e){t.canShowIn3d=e,t.canShowInAny=t.canShowInAny||e,t.$apply()})},updateURL:function(){if(this._objectClass&&this._objectUUID){var e={t:this._objectClass,u:this._objectUUID};this._url.setFragment(this._id,this._url.encode(e),["p"])}},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query,["p"])}},applyURL:function(e,t){if(e===this._id){var i=t.get(this._id),n=this._url.decode(i.query);this._objectClass=n.t,this._objectUUID=n.u,n.t&&n.u&&(this.loadObject(n.u,n.t),this.updateUserAndRights())}},login:function(){this._visible&&this._objectClass&&this._objectUUID&&(this.loadObject(this._objectUUID,this._objectClass),this.updateUserAndRights())},logout:function(){this._promise=Q.reject(WS.authenticationException)},updateAccount:function(){this.login()}},WS.extend("ObjectPropertiesPage","Embeddable"),WS.ProjectContentPage=function(e,t,i,n,o){F.Page.call(this,e,t,i,n);var r=this;this._project=o,this._promise=void 0,this._objectAmounts={},e.page={hasObjects:void 0},e.getProject=function(){return r._promise},e.$on("objectsLength",function(t,i,n){t.stopPropagation(),r._objectAmounts[i._id]=n;var o=!1;for(var a in r._objectAmounts)if(r._objectAmounts.hasOwnProperty(a)&&0<r._objectAmounts[a]){o=!0;break}e.page.hasObjects=o}),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this,n)},WS.ProjectContentPage.prototype={updateURL:function(){this._id&&this._url.setFragment(this._id,"",["p"])},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query,["p"])}},loadProject:function(){var e=this._project.getCurrent();this.$scope.project&&this.$scope.project._name===e||(this._promise=this._project.getByID(e))},onShow:function(){F.Page.prototype.onShow.call(this),this.loadProject()},login:function(){this._visible&&this.loadProject()},logout:function(){this._promise=void 0},updateAccount:function(){}},WS.extend("ProjectContentPage","Page"),WS.UserAccountPage=function(e,t,i,n,o,r,a,s){F.Page.call(this,e,t,i);var c=this;this._login=n,this._userService=o,this._locale=r,this._domainSettings=a,this._localUserSettings=s,this._promise=void 0,e.getPromise=function(){return c._promise},e.user=this._userService.getNew(),e.usersettings=new WS.Usersettings,e.options={requestPassword:!1},e.onChange=function(e){e.cleanUpChanges(),c.trigger("editObject",[e])},e.onChangeOptions=function(){c.trigger("editObject",[e.options])},e.languages=this._locale.getLanguages(),e.is2go=WS._2GO,e.lengthUnitsMetric=WS.UnitService.SupportedLengthUnitsMetric,e.lengthUnitsImperial=WS.UnitService.SupportedLengthUnitsImperial,e.lengthUnitsSurvey=WS.UnitService.SupportedLengthUnitsSurvey,e.areaUnitsMetric=WS.UnitService.SupportedAreaUnitsMetric,e.areaUnitsImperial=WS.UnitService.SupportedAreaUnitsImperial,e.areaUnitsSurvey=WS.UnitService.SupportedAreaUnitsSurvey,e.angleUnits=WS.UnitService.SupportedAngleUnits,e.overrideLengthUnit=!1,e.overrideAreaUnit=!1,e.overrideAngleUnit=!1,e.coordinateSystems=WS.UnitService.SupportedCSs,this.provideMalePlug("ObjectEdit",["editObject"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this._login,this)},WS.UserAccountPage.prototype={loadSettings:function(){var e=this,t=this._login;WS._2GO?this._promise=e._domainSettings.get(!0).then(function(t){e.$scope.$apply(function(){e.readUnits(t,e._localUserSettings._settings)})}):(this.$scope.options.requestPassword=!1,this._promise=t.isLoggedIn().then(function(i){if(i)return[t.getUserID(),t.getUsername(),t.getFirstname(),t.getMiddlename(),t.getLastname(),t.getSettings(),e._domainSettings.get(!0)];throw F.authenticationException}).spread(function(t,i,n,o,r,a,s){e.$scope.$apply(function(c){c.user=e._userService.getNew(),c.user._ID=t,c.user._username=i,c.user._firstname=n,c.user._middlename=o,c.user._lastname=r,e.trigger("editObject",[c.user]),e.readUnits(s,a)})}))},readUnits:function(e,t){this.$scope.overrideLengthUnit=e._overrideLengthUnit,this.$scope.overrideAreaUnit=e._overrideAreaUnit,this.$scope.overrideAngleUnit=e._overrideAngleUnit;var i=new WS.Usersettings;t?(i.readJson(t),i._language||(i._language=e._language),(!i._units||e._overrideLengthUnit)&&(i._units=e._lengthUnit),(!i._areaunit||e._overrideAreaUnit)&&(i._areaunit=e._areaUnit),(!i._angleUnit||e._overrideAngleUnit)&&(i._angleUnit=e._angleUnit)):(i._language=e._language,i._units=e._lengthUnit,i._areaunit=e._areaUnit,i._angleUnit=e._angleUnit,i._coordSystem=WS.UnitService.CS.PROJECT),this.$scope.usersettings=i,this.trigger("editObject",[this.$scope.usersettings])},onShow:function(){F.Page.prototype.onShow.call(this);var e=this;WS._2GO?this.launchTask("default","settings","myaccount",void 0,{noRepeat:!0}).then(function(){e.loadSettings()}).done():this._login.isLoggedIn().then(function(t){t?e.launchTask("default","settings","myaccount",void 0,{noRepeat:!0}).then(function(){e.loadSettings()}).done():e._promise=Q.reject(F.authenticationException)}).done()},updateURL:function(){this._url.setFragment(this._id,"")},login:function(){if(this._visible){var e=this;this.launchTask("default","settings","myaccount").then(function(){e.loadSettings()}).done()}},logout:function(){this._promise=Q.reject(F.authenticationException)},updateAccount:function(){}},WS.extend("UserAccountPage","Page"),WS.OverviewMapSettingsPage=function(e,t,i){WS.Page.call(this,e,t,i);var n=this;this._settingService=F.DI().getService("overviewmapsettings"),this._layerService=F.DI().getService("layer"),this.$scope=e,this.$scope.availIconModes=WS.OverviewMapSettings.IconModes,this.$scope.iconModeNames=WS.OverviewMapSettings.IconModeNames,this.$scope.change=function(){for(var e=n.$scope,t=0;t<e.layers.length;t++){e.layers[t].cleanUpChanges()}e.settings.cleanUpChanges();var i={settings:e.settings,layers:e.layers};n.trigger("editObject",[i])},this.$scope.showElevation=function(e){return e===WS.OverviewMapSettings.COLORIZE_BY_HEIGHT},this.provideMalePlug("ObjectEdit",["editObject"])},WS.OverviewMapSettingsPage.prototype={onShow:function(){this.getSettings(),this.launchTask("default","settings","editoverviewmapsettings",void 0,{noRepeat:!0})},getSettings:function(){var e=this;this._settingService.getByPrimaryKey("default").then(function(t){e.$scope.settings=t,e.$scope.$apply()}).done();var t=function(e){return e._id===WS.Layer.LayerIDs.ANNOTATIONS||e._id===WS.Layer.LayerIDs.MEASUREMENTS||e._id===WS.Layer.LayerIDs.SCANS||e._id===WS.Layer.LayerIDs.ORTHOPHOTOS||e._id===WS.Layer.LayerIDs.VIEW_CAM};this._layerService.getAll(WS.Layer.ViewTypes.OVERVIEW_MAP,t).then(function(t){e.$scope.layers=t,e.$scope.$apply()}).done()}},WS.extend("OverviewMapSettingsPage","Page"),WS.PanoSettingsPage=function(e,t,i){WS.Page.call(this,e,t,i);var n=this;this._settingService=F.DI().getService("panosettings"),this._unitService=F.DI().getService("unit"),this._layerService=F.DI().getService("layer"),this.$scope=e,e.availResolutions=WS.PanoSettings.Resolutions,e.maxResolution=-1,e.haveAllRes=!0,e.availColorModes=WS.PanoSettings.ColorModes,e.availIconModes=WS.PanoSettings.IconModes,e.iconModeNames=WS.PanoSettings.IconModeNames,e.unit=this._unitService.getLengthUnit(),e.webGlAvailable=F.isWebGlAvailable(),e.ie11=11===F.ieVersion(),e.details3d={auto:!1,value:void 0};var o=WS.PanoSettings.Detail3d;e.details3dAvail=WS._2GO?[{value:o.MEDIUM,resolution:WS.ScanCloudRenderable.DetailWidth.Medium},{value:o.HIGH,resolution:WS.ScanCloudRenderable.DetailWidth.High},{value:o.VERY_HIGH,resolution:WS.ScanCloudRenderable.DetailWidth.VeryHigh}]:[{value:o.VERY_LOW,descr:"FE_3D_DETAILS_VERYLOW",examples:""},{value:o.LOW,descr:"FE_3D_DETAILS_LOW",examples:" Apple iPad 2, Samsung Galaxy Tab 2"},{value:o.MEDIUM,descr:"FE_3D_DETAILS_MEDIUM",examples:" Apple iPad Air, Samsung Galaxy Tab 4"},{value:o.HIGH,descr:"FE_3D_DETAILS_HIGH",examples:" Apple iPad Air 2, Samsung Galaxy Tab S"},{value:o.VERY_HIGH,descr:"FE_3D_DETAILS_VERYHIGH",examples:""}],e.details3dAvail.forEach(function(e){e.name=WS.PanoSettings.details3dStringID(e.value)}),e.speedMin=WS.PanoSettings.MinMovementSpeed,e.speedMax=WS.PanoSettings.MaxMovementSpeed,e.change=function(){e.updateMaxRes();for(var t=0,i=e.layers.length;i>t;t++){var o=e.layers[t];o.cleanUpChanges()}e.settings._changes._details3d=e.details3d.auto?WS.PanoSettings.Detail3d.AUTOMATIC:e.details3d.value,e.details3d.auto&&(e.details3d.value=WS.PanoSettings.autoDetails3d()),e.settings.cleanUpChanges();var r={settings:e.settings,layers:e.layers};n.trigger("editObject",[r])},e.updateMaxRes=function(){for(var t=F.isWebGlAvailable()&&e.settings._changes._enableWebGl,i=t?WS.GlTexture.getMaxWidth():WS.CanvasTexture.getMaxWidth(),n=WS.Scan.PanoImageResolutions,o=WS.Scan.DeviceMaxResolutionIdx;o>0&&n[o]._width>i;)o--;e.maxResolution=o,e.settings._changes._imageResolutionIndex>e.maxResolution&&(e.settings._changes._imageResolutionIndex=e.maxResolution),e.haveAllRes=e.maxResolution===n.length-1},e.changeMovementSpeed=function(t){var i=e.settings._changes._movementSpeed,n=i+t;n>WS.PanoSettings.MaxMovementSpeed&&(n=WS.PanoSettings.MaxMovementSpeed),n<WS.PanoSettings.MinMovementSpeed&&(n=WS.PanoSettings.MinMovementSpeed),e.settings._changes._movementSpeed=n,e.change()},e.changeBlendFactor=function(t){var i=e.settings._changes._blendFactor,n=i+t;n=Math.round(10*n)/10,n.toFixed(1),n>.9?n=.9:.1>n&&(n=.1),e.settings._changes._blendFactor=n,e.change()},e._2GO=WS._2GO,this.provideMalePlug("ObjectEdit",["editObject"])},WS.PanoSettingsPage.prototype={onShow:function(){this.getSettings(),this.launchTask("default","settings","editpanosettings",void 0,{noRepeat:!0})},getSettings:function(){var e=this.$scope;e.unit=this._unitService.getLengthUnit(),this._settingService.getByPrimaryKey("default").then(function(t){e.settings=t,t._details3d===WS.PanoSettings.Detail3d.AUTOMATIC?(e.details3d.auto=!0,e.details3d.value=WS.PanoSettings.autoDetails3d()):(e.details3d.auto=!1,e.details3d.value=t._details3d),e.updateMaxRes(),e.$apply()}).done();var t=function(e){return e._id===WS.Layer.LayerIDs.ANNOTATIONS||e._id===WS.Layer.LayerIDs.MEASUREMENTS||e._id===WS.Layer.LayerIDs.SCANS||e._id===WS.Layer.LayerIDs.ORTHOPHOTOS};this._layerService.getAll(WS.Layer.ViewTypes.PANO_VIEW,t).then(function(t){e.layers=t,e.$apply()
}).done()}},WS.extend("PanoSettingsPage","Page"),angular.module("ws.page",[]),F.DI().registerParameter("scanselection","Scan"),F.DI().registerParameter("scancolumnconfig",{name:!0,position:!1,category:!0,tags:!0,view:!0,writeAccess:!0,type:!1,preview:!0,recordingTime:!1}),F.DI().registerParameter("annotationselection","Annotation"),F.DI().registerParameter("annotationcolumnconfig",{name:!0,position:!1,category:!0,tags:!0,view:!0,writeAccess:!0,type:!1}),F.DI().registerParameter("measurementselection","Measurement"),F.DI().registerParameter("measurementcolumnconfig",{name:!0,position:!1,category:!0,tags:!0,view:!0,writeAccess:!0,type:!0}),F.DI().registerController("project",WS.ProjectSelector,"@project","@selection","@plug","@login","@cookie","@url","@pointcloud","@panosettings","@alert"),F.DI().registerController("projectdetails",WS.ProjectDetails,"@project","@plug","@url","@login","@pointcloud","@panosettings","@alert"),F.DI().registerController("scan",WS.ObjectList,"$filter","@plug","@url","@scan","@project","@pointcloud","@selection","@alert","@login","@panosettings","%scanselection%","%scancolumnconfig%"),F.DI().registerController("annotation",WS.ObjectList,"$filter","@plug","@url","@annotation","@project","@pointcloud","@selection","@alert","@login","@panosettings","%annotationselection%","%annotationcolumnconfig%"),F.DI().registerController("measurement",WS.ObjectList,"$filter","@plug","@url","@measurement","@project","@pointcloud","@selection","@alert","@login","@panosettings","%measurementselection%","%measurementcolumnconfig%"),F.DI().registerController("objectproperties",WS.ObjectPropertiesPage,"@plug","@login","@url","@project","@pointcloud","@panosettings","@locale","@unit"),F.DI().registerController("projectcontent",WS.ProjectContentPage,"@plug","@url","@login","@project"),F.DI().registerController("useraccount",WS.UserAccountPage,"@plug","@url","@login","@user","@locale","@domainsettings","?@localusersettings"),F.DI().registerController("overviewmapsettings",WS.OverviewMapSettingsPage,"@plug","@url"),F.DI().registerController("panosettings",WS.PanoSettingsPage,"@plug","@url"),F.DI().registerController("legal",WS.Page,"@plug","@url"),angular.module("ws.page").directive("projectselector",function(){return WS.PlugController.createDirective({link:function(e,t){e.scrollToMap=function(){var e=t.find("#worldmapcontainer")[0];e&&e.scrollIntoView()}},controllerClass:F.DI().getController("project"),template:'<asyncpartial firstload="visible" partial="projectselector.html"></asyncpartial>'})}),angular.module("ws.page").directive("projectdetails",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("projectdetails"),require:"?^page",link:function(e,t,i,n){if(n&&n.$scope){var o=n.$scope.ctrl,r=e.ctrl;r._page=o}},template:'<asyncpartial firstload="visible" partial="projectdetails.html"></asyncpartial>'})}),angular.module("ws.page").directive("scanlist",function(){return WS.PlugController.createDirective({scope:{caption:"@",collapsed:"="},link:function(e,t,i){e.galleryid=i.id+"ig"},controllerClass:F.DI().getController("scan"),template:'<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'})}),angular.module("ws.page").directive("annotationlist",function(){return WS.PlugController.createDirective({scope:{caption:"@",collapsed:"="},link:function(e,t,i){e.galleryid=i.id+"ig"},controllerClass:F.DI().getController("annotation"),template:'<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'})}),angular.module("ws.page").directive("measurementlist",function(){return WS.PlugController.createDirective({scope:{caption:"@",collapsed:"="},link:function(e,t,i){e.galleryid=i.id+"ig"},controllerClass:F.DI().getController("measurement"),template:'<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'})}),angular.module("ws.page").directive("projectcontentpage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("projectcontent"),templateUrl:F.partialUrl("projectcontentpage.html")})}),angular.module("ws.page").directive("objectpropertiespage",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("objectproperties"),template:'<asyncpartial firstload="visible" partial="objectpropertiespage.html"></asyncpartial>'})}),angular.module("ws.page").directive("useraccountpage",function(){return WS.Page.createDirective({controllerClass:F.DI().getController("useraccount"),template:'<asyncpartial firstload="visible" partial="useraccount.html"></asyncpartial>'})}),angular.module("ws.map").directive("overviewmapsettingspage",function(){return WS.Page.createDirective({controllerClass:F.DI().getController("overviewmapsettings"),template:'<asyncpartial firstload="visible" partial="overviewmapsettingspage.html"></asyncpartial>'})}),angular.module("ws.page").directive("panosettingspage",function(){return WS.Page.createDirective({controllerClass:F.DI().getController("panosettings"),template:'<asyncpartial firstload="visible" partial="panosettingspage.html"></asyncpartial>'})}),angular.module("ws.page").directive("legalpage",function(){return WS.Page.createDirective({controllerClass:F.DI().getController("legal"),template:'<asyncpartial firstload="visible" partial="legalpage.html"></asyncpartial>'})}),WS.Footerbar=function(e,t){WS.PlugController.call(this,e,t);var i=this;this._page=void 0,e.launchCategory=function(e){i.trigger("launchTask",["default",e])},e.compactPanel=!1,e.frontendversion=WS.Version.getVersion(),e.$on("collapseTaskPanel",function(e,t){i.$scope.compactPanel=t}),e.showLegalPage=function(){i.trigger("selectPageClass",["legal"])},this.provideMalePlug("PageSelect",["selectPage","selectPageClass"]),this.provideMalePlug("TaskLaunch",["launchTask"])},WS.extend("Footerbar","PlugController"),angular.module("ws.footerbar",[]),F.DI().registerController("footerbar",WS.Footerbar,"@plug"),angular.module("ws.footerbar").directive("footerbar",function(){return WS.PlugController.createDirective({controllerClass:F.DI().getController("footerbar"),templateUrl:WS.partialUrl("footerbar.html")})}),WS.SettingsService=function(e,t,i,n,o,r,a){WS.PlugModule.call(this,r),this._constructor=e,this._serializer=n,this._error=o,this._entity=void 0,this._restClient=a(t,i,{read:{method:"GET",params:{}},edit:{method:"PUT",params:{}}}),this.provideMalePlug("SettingsUpdate",["updateSettings"])},WS.SettingsService.prototype={getNew:function(e){var t=new this._constructor(this);return e&&t.readJson(e),t},get:function(e){var t=Q.defer();if(void 0===this._entity||e){var i=this;this._restClient.read({},function(e){var n=i._serializer.read(e);i._entity=n,i.trigger("updateSettings",[n.getTriggerKey(),n]),t.resolve(n)},this._error.restHandler(t))}else t.resolve(this._entity);return t.promise},update:function(e){var t=this,i=Q.defer();return this._restClient.edit({},e.writeChanges(),function(n){e.applyUpdate(n),t.trigger("updateSettings",[e.getTriggerKey(),e]),i.resolve(e)},this._error.restHandler(i)),i.promise}},WS.extend("SettingsService","PlugModule"),WS.DomainSettings=function(e){F.CRUDObject.call(this,e),this._class=void 0,this._version=void 0,this._customerLogoFileType=void 0,this._customerLogoOpacity=void 0,this._customerLogoRevision=void 0,this._language=void 0,this._lengthUnit=void 0,this._areaUnit=void 0,this._angleUnit=void 0,this._distState=void 0,this._areaState=void 0,this._persistMeasurements=void 0,this._overrideLengthUnit=void 0,this._overrideAreaUnit=void 0,this._overrideAngleUnit=void 0,this._overrideDistState=void 0,this._overrideAreaState=void 0,this._overridePersistMeasurements=void 0,this._incrementCustomerLogoRevision=void 0},WS.DomainSettings.prototype={readJson:function(e){this._class="DomainSettings",this._version=e.Version,this._customerLogoFileType=e.CustomerLogoFileType,this._customerLogoOpacity=e.CustomerLogoOpacity,this._customerLogoRevision=e.CustomerLogoRevision,this._language=e.Language,this._lengthUnit=e.LengthUnit,this._areaUnit=e.AreaUnit,this._angleUnit=e.AngleUnit,this._distState=e.DistState,this._areaState=e.AreaState,this._persistMeasurements=e.PersistMeasurements,this._overrideLengthUnit=e.OverrideLengthUnit,this._overrideAreaUnit=e.OverrideAreaUnit,this._overrideAngleUnit=e.OverrideAngleUnit,this._overrideDistState=e.OverrideDistState,this._overrideAreaState=e.OverrideAreaState,this._overridePersistMeasurements=e.OverridePersistMeasurements,delete this._incrementCustomerLogoRevision},writeJson:function(){var e={};return e.Class="DomainSettings",e.Version=this._version,e.CustomerLogoFileType=this._customerLogoFileType,e.CustomerLogoOpacity=this._customerLogoOpacity,e.CustomerLogoRevision=this._customerLogoRevision,e.Language=this._language,e.LengthUnit=this._lengthUnit,e.AreaUnit=this._areaUnit,e.AngleUnit=this._angleUnit,e.DistState=this._distState,e.AreaState=this._areaState,e.PersistMeasurements=this._persistMeasurements,e.OverrideLengthUnit=this._overrideLengthUnit,e.OverrideAreaUnit=this._overrideAreaUnit,e.OverrideAngleUnit=this._overrideAngleUnit,e.OverrideDistState=this._overrideDistState,e.OverrideAreaState=this._overrideAreaState,e.OverridePersistMeasurements=this._overridePersistMeasurements,e.IncrementCustomerLogoRevision=this._incrementCustomerLogoRevision,e},getTriggerKey:function(){return"domain"},hasCustomerLogo:function(){return!!this._customerLogoFileType&&""!==this._customerLogoFileType},incrementCustomerLogoRevision:function(){this._changes._incrementCustomerLogoRevision=!0}},WS.extend("DomainSettings","CRUDObject"),WS.DomainSettingsService=function(e,t,i,n){var o=WS._2GO?"ws2go-data/domain/settings.json":"/domain/settings";WS.SettingsService.call(this,WS.DomainSettings,o,{},e,t,i,n)},WS.DomainSettingsService.prototype={getCustomerLogoUrl:function(e){return e.hasCustomerLogo()?WS._2GO?"ws2go-data/domain/customer-logo."+e._customerLogoFileType:"/data/domain/customer-logo/"+e._customerLogoFileType+"?revision="+e._customerLogoRevision:void 0}},WS.extend("DomainSettingsService","SettingsService"),F.DI().registerService("domainsettings",WS.DomainSettingsService,"@serializer","@error","@plug","$resource"),F.DI().config("@serializer","@domainsettings",function(e,t){e.registerClass("DomainSettings",function(){return t.getNew()})}),F.DI().registerParameter("selectionCollapseThresh",10),F.DI().registerParameter("taskcategories",{"default":[{name:"C_PROJECT",id:"projectselector",page:"projectselector",tasks:[]},{name:"C_OVERVIEWMAP",id:"overviewmap",executable:["map"],page:"overviewmap",pageConfiguration:{selection:"scan,annotation,measurement,tempmeasurement,orthophoto",mode:WS.ViewBase.Mode.PickAll,changeScanAllowed:!0},tasks:[{caption:"T_MEASURE_DIST",id:"measuredistance",icon:"measuredist.png"},{caption:"T_MEASURE_AREA",id:"measurearea",icon:"measurearea.png"},{caption:"T_ANNOTATE",id:"annotate",icon:"annotatepad.png",executable:["login","user"]},{caption:"T_ORTHOPHOTO",id:"orthophoto",icon:"orthophoto.png",executable:["login","user"]},{caption:"T_EDIT",id:"edit",icon:"edit.png",executable:["login","user"]},{caption:"T_EDIT_CATEGORY",id:"editcategory",icon:"editcategory.png",executable:["login","user"]},{caption:"T_EDIT_TAG",id:"edittag",icon:"edittag.png",executable:["login","user"]},{caption:"T_SHARE",id:"share",icon:"share.png",executable:["login","user"]},{caption:"T_DELETE",id:"remove",icon:"remove.png"}]},{name:"C_SCANVIEW",id:"panoramaview",executable:["project"],page:"panoramaview",tasks:[{caption:"T_MEASURE_DIST",id:"measuredistance",icon:"measuredist.png"},{caption:"T_ANNOTATE",id:"annotate",icon:"annotatepad.png",executable:["login","user"]},{caption:"T_EDIT",id:"edit",icon:"edit.png",executable:["login","user"]},{caption:"T_EDIT_CATEGORY",id:"editcategory",icon:"editcategory.png",executable:["login","user"]},{caption:"T_EDIT_TAG",id:"edittag",icon:"edittag.png",executable:["login","user"]},{caption:"T_SHARE",id:"share",icon:"share.png",executable:["login","user"]},{caption:"T_DELETE",id:"remove",icon:"remove.png"}]},{name:"C_OBJECT",id:"object",executable:["project"],page:"object",tasks:[{caption:"T_EDIT",id:"edit",icon:"edit.png",executable:["login","user"]},{caption:"T_EDIT_CATEGORY",id:"editcategory",icon:"editcategory.png",executable:["login","user"]},{caption:"T_EDIT_TAG",id:"edittag",icon:"edittag.png",executable:["login","user"]},{caption:"T_SHARE",id:"share",icon:"share.png",executable:["login","user"]},{caption:"T_DELETE",id:"remove",icon:"remove.png",executable:["login","user"]}]},{name:"C_JOB_QUEUE",id:"jobqueue",page:"jobqueue",tasks:[]},{name:"C_SETTINGS",id:"settings",tasks:[{caption:"T_MYACCOUNT",id:"myaccount",icon:"account.png",executable:WS._2GO?void 0:["login"]},{caption:"T_OVERVIEW_MAP_SETTINGS",id:"editoverviewmapsettings",icon:"overviewmap.png"},{caption:"T_PANO_VIEW_SETTINGS",id:"editpanosettings",icon:"panoramaview.png"}]}],workbench:[{name:"C_PROJECT",id:"projectselector",page:"projectselector",iconPath:"main_projects.svg",iconMargin:!0},{name:"C_IMPORT",id:"import",executable:["project"],page:"import",iconPath:"main_import.svg",iconMargin:!0},{name:"C_PROCESSING",id:"processing",executable:["project"],iconPath:"main_process.svg",iconMargin:!0,page:"processing",tasks:[{caption:"T_CREATE_3D",id:"createptclouds",icon:"create3d.png",executable:["admin"]},{caption:"T_DEL_ENTITIES",id:"delentities",icon:"remove.png",executable:["admin"]}]},{name:"C_PUBLISH",id:"publish",executable:["project"],iconPath:"main_export.svg",iconMargin:!0,page:"projectdetails",pageConfiguration:{},tasks:[{caption:"T_EDIT_PROJECT",id:"editmetadata",icon:"edit.png",executable:["admin"]},{caption:"T_CONFIG_MAP",id:"adminmapsettings",icon:"overviewmap.png",executable:["admin","canconfiguremap"]},{caption:"T_PUBLISH_PROJECT",id:"publish",icon:"publish.png",executable:["admin","unpublished","publishable"],beta:!0}]}],admin:[{name:"C_DASHBOARD",id:"dashboard",visible:["login","admin"],page:"dashboard",tasks:[]},{name:"C_PROJECT_M",id:"projectmanagement",visible:["login","admin"],page:"projectlist",tasks:[{caption:"T_CREATE_PROJECT",id:"createproject",icon:"createproject.png",beta:!0},{caption:"T_ACCESS_CONTROL",id:"rights",icon:"rights.png"},{caption:"T_DELETE_PROJECT",id:"delete",icon:"delete.png"}]},{name:"C_GROUP_M",id:"groups",visible:["login","admin"],page:"groups",tasks:[{caption:"T_CREATE_GROUP",id:"addgroup",icon:"addgroup.png"},{caption:"T_EDIT_GROUP",id:"editgroup",icon:"edit.png"},{caption:"T_DELETE_GROUP",id:"deletegroup",icon:"delete.png"},{caption:"T_ADD_USER",id:"addusertogroup",icon:"adduser.png"},{caption:"T_REMOVE_USER",id:"removeuserfromgroup",icon:"removeuser.png"}]},{name:"C_USER_M",id:"users",visible:["login","superuser"],page:"users",pageConfiguration:{"with":"roles"},tasks:[{caption:"T_ADD_USER",id:"adduser",icon:"adduser.png"},{caption:"T_REMOVE_USER",id:"removeuser",icon:"removeuser.png"}]},{name:"C_ROLE_M",id:"roles",visible:["login","superuser"],page:"users",pageConfiguration:{"with":"roles"},tasks:[{caption:"T_GRANT_ROLE",id:"grantrole",icon:"grantrole.png"},{caption:"T_REVOKE_ROLE",id:"revokerole",icon:"revokerole.png"}]},{name:"C_SETTINGS",id:"adminsettings",visible:["login","superuser"],tasks:[{caption:"T_DOMAIN",id:"domainsettings",icon:"domain.png"}]}]}),WS._2GO&&F.DI().config("@task",function(e){var t="default",i=function(t,i,n){n.forEach(function(n){e.removeTask(t,i,n)})};i(t,"overviewmap",["annotate","orthophoto","edit","editcategory","edittag","share"]),i(t,"panoramaview",["annotate","edit","editcategory","edittag","share"]),i(t,"object",["edit","editcategory","edittag","share","remove"]),e.removeCategory(t,"jobqueue")}),WS.Icons={},WS.Icons.TaskSection={textinput:"textinput.png",selectobject:"select.png",category:"category_76.png",tags:"tag_76.png",hyperlink:"hyperlink.png",check:"check.png",choice:"choice.png",configure:"configure.png",location:"location.png",point3d:"point3d.png",remove:"delete.png",share:"share.png",lock:"lock.png",group:"group.png",resolution:"resolution.png",minheight:"height_min.png",maxheight:"height_max.png",frustumfront:"frustum_front.png",volumedepth:"volume_depth.png",volumeheight:"volume_height.png",volumewidth:"volume_width.png",volumedepth2:"volume_depth2.png",volumeheight2:"height.png",volumewidth2:"width.png",defineimgplane:"define_img_plane.png",colormode:"gray.png",gapfiller:"gapfiller.png",pointcloud:"blackcloud.png",arrowright:"arrow-right.png",image:"image.png",selectbox:"selectbox.png"},WS.Data=function(e){F.CRUDObject.call(this,e),this._class=void 0,this._name=void 0,this._extension=void 0,this._type=void 0,this._state=void 0},WS.Data.prototype={readJson:function(e){this._class="Data",this._name=e.Name,this._extension=e.Extension,this._type=e.Type,this._state=e.State},writeJson:function(){var e={};return e.Class="Data",e.Name=this._name,e.Extension=this._extension,e.Type=this._type,e.State=this._state,e}},WS.extend("Data","CRUDObject"),WS.Entity=function(e){F.CRUDObject.call(this,e),this._class=void 0,this._UUID=void 0,this._displayName=void 0,this._category=void 0,this._tags=void 0,this._version=void 0,this._creator=void 0,this._creationDate=void 0,this._completionDate=void 0,this._state=void 0,this._project=void 0,this._relations=void 0},WS.Entity.prototype={matchesJson:function(e){return this._UUID===e.UUID},readJson:function(e){this._UUID=e.UUID,this._displayName=e.DisplayName,this._category=e.Category,this._tags=e.Tags,this._version=e.Version,this._creator=e.Creator,this._creationDate=e.CreationDate,this._completionDate=e.CompletionDate,this._state=e.State,this._relations=void 0},writeJson:function(){var e={};return e.UUID=this._UUID,e.DisplayName=this._displayName,e.Category=this._category,e.Tags=this._tags,e.Version=this._version,e.Creator=this._creator,e.CreationDate=this._creationDate,e.CompletionDate=this._completionDate,e.State=this._state,e.Relations=this._relations,e},getID:function(){return this._UUID},canBeShownInView:function(){return!1}},WS.extend("Entity","CRUDObject"),WS.Entity.State={INCOMPLETE:"incomplete",PROCESSING:"processing",COMPLETE:"complete",FAILED:"failed",DELETING:"deleting"},WS.Entity.RelationType={USES:"uses"},WS.Entity.DISPLAYNAME_MAX_CHARS=80,WS.Entity.DISPLAYNAME_MAX_BYTES=128,WS.EntityService=function(e,t,i,n,o,r,a,s){WS.CRUDService.call(this,a||"Entity",s||WS.Entity,"/entity/:project",{},e,t,i,n,o),this._http=r,this._dataClient=this._resource("/entity/:project/:entityUuid/data",{},{create:{method:"POST",params:{}},readAll:{method:"GET",params:{},isArray:!0}}),this._dataExtendedClient=this._resource("/entity/:project/:entityUuid/data/:name.:extension",{},{remove:{method:"DELETE",params:{}}})},WS.EntityService.prototype={create:function(e){return F.CRUDService.prototype.create.call(this,e,{project:e._project})},update:function(e){return F.CRUDService.prototype.update.call(this,e,{project:e._project})},remove:function(e){return F.CRUDService.prototype.remove.call(this,e,{project:e._project})},getByID:function(e,t,i,n){return F.CRUDService.prototype.getByID.call(this,e,t,i,n).then(function(e){return e._project=t.project,e})},getAll:function(e,t){return F.CRUDService.prototype.getAll.call(this,e,t).then(function(t){return t.forEach(function(t){t._project=e.project}),t})},getLocks:function(e){var t=Q.defer(),i={method:"GET",url:"/entity/"+e+"/locks"};return this._http(i).success(function(e){t.resolve(e)}).error(this._error.httpHandler(t)),t.promise},getNewData:function(){return new WS.Data(this)},createData:function(e,t){var i=this,n={project:t._project,entityUuid:t._UUID},o=Q.defer();return this._dataClient.create(n,e.writeJson(),function(t){e.readJson(t),o.resolve(e)},i._error.restHandler(o)),o.promise},deleteData:function(e,t){var i=this,n={project:t._project,entityUuid:t._UUID,name:e._name,extension:e._extension},o=Q.defer();return this._dataExtendedClient.remove(n,e.writeJson(),function(){o.resolve()},i._error.restHandler(o)),o.promise},postWithRetries:function(e,t,i,n){var o=this,r=Q.defer(),a={method:"POST",url:e,data:i,headers:{"Content-Type":t},transformRequest:[]};if(n){if(Q.isFulfilled(n.promise))return r.resolve(!1),r.promise;a.timeout=n.promise}return this._http(a).success(function(e){n&&n.reject(),r.resolve(e)}).error(function(e,t){0===t?r.resolve(!1):o._http(a).success(function(e){n&&n.reject(),r.resolve(e)}).error(function(e,t){0===t?r.resolve(!1):o._http(a).success(function(e){n&&n.reject(),r.resolve(e)}).error(o._error.httpHandler(r))})}),r.promise},uploadSingle:function(e,t,i,n){var o=WS.getMimeType(e._extension);if(!o){var r=new Error("EM_FILE_TYPE_2");return r._file=e._name+"."+e._extension,Q.reject(r)}var a="/entity/"+t._project+"/"+t._UUID+"/data/single/"+e._name+"."+e._extension;return this.postWithRetries(a,o,i,n)},uploadMultiStart:function(e,t){var i=WS.getMimeType(e._extension);if(!i){var n=new Error("EM_FILE_TYPE_2");return n._file=e._name+"."+e._extension,Q.reject(n)}var o="/entity/"+t._project+"/"+t._UUID+"/data/multi/start/"+e._name+"."+e._extension;return this.postWithRetries(o,i,"")},uploadMultiContinue:function(e,t,i,n,o,r){var a=WS.getMimeType(e._extension);if(!a){var s=new Error("EM_FILE_TYPE_2");return s._file=e._name+"."+e._extension,Q.reject(s)}var c="/entity/"+t._project+"/"+t._UUID+"/data/multi/continue/"+i+"/"+n+"/"+e._name+"."+e._extension;return this.postWithRetries(c,a,o,r)},uploadMultiFinish:function(e,t,i){var n=WS.getMimeType(e._extension);if(!n){var o=new Error("EM_FILE_TYPE_2");return o._file=e._name+"."+e._extension,Q.reject(o)}var r="/entity/"+t._project+"/"+t._UUID+"/data/multi/finish/"+i+"/"+e._name+"."+e._extension;return this.postWithRetries(r,n,"")}},WS.extend("EntityService","CRUDService"),WS.EntityCPE=function(e){WS.Entity.call(this,e),this._class="EntityCPE",this._color=void 0,this._reflection=void 0,this._reflectionRange=void 0,this._normal=void 0,this._quantization=void 0},WS.EntityCPE.prototype={readJson:function(e){WS.Entity.prototype.readJson.call(this,e),this._color=e.Color,this._reflection=e.Reflection,this._reflectionRange=e.ReflectionRange,this._normal=e.Normal,this._quantization=e.Quantization},writeJson:function(){var e=WS.Entity.prototype.writeJson.call(this);return e.Class="EntityCPE",e.Color=this._color,e.Reflection=this._reflection,e.ReflectionRange=this._reflectionRange,e.Normal=this._normal,e.Quantization=this._quantization,e}},WS.extend("EntityCPE","Entity"),WS.EntityCPEService=function(e,t,i,n,o,r){WS.EntityService.call(this,e,t,i,n,o,r,"EntityCPE",WS.EntityCPE)},WS.EntityCPEService.prototype={getAll:function(e,t){return e.class="EntityCPE",WS.EntityService.prototype.getAll.call(this,e,t)}},WS.extend("EntityCPEService","EntityService"),WS.EntityPC=function(e){WS.Entity.call(this,e),this._class="EntityPC",this._colorRatio=void 0,this._homogenization=void 0,this._resolution=void 0,this._scanUUIDs=void 0},WS.EntityPC.prototype={readJson:function(e){WS.Entity.prototype.readJson.call(this,e),this._colorRatio=e.ColorRatio,this._homogenization=e.Homogenization,this._resolution=e.Resolution,this._scanUUIDs=e.ScanUUIDs},writeJson:function(){var e=WS.Entity.prototype.writeJson.call(this);return e.Class="EntityPC",e.ColorRatio=this._colorRatio,e.Homogenization=this._homogenization,e.Resolution=this._resolution,e.ScanUUIDs=this._scanUUIDs,e}},WS.extend("EntityPC","Entity"),WS.EntityPCService=function(e,t,i,n,o,r){WS.EntityService.call(this,e,t,i,n,o,r,"EntityPC",WS.EntityPC)},WS.EntityPCService.prototype={getAll:function(e,t){return e.class="EntityPC",WS.EntityService.prototype.getAll.call(this,e,t)}},WS.extend("EntityPCService","EntityService"),WS.Uploader=function(e,t){this._entity=e,this._projectId=t},WS.Uploader.prototype={getNewEntity:function(e){var t=this._entity.getNew();return t._displayName=e.name,t._project=this._projectId,t},getNewData:function(e){var t=this._entity.getNewData();return t._name=this.getValidFileName(e.name),t},createEntity:function(){},createData:function(){},prepareUpload:function(e){var t=this,i=Q.defer();return this.createEntity(e).then(function(n){t.createData(e,n).then(function(o){i.resolve([t,e,o,n])},function(e){t.remove(n).then(function(){i.reject(e)},function(){i.reject(e)}).done()}).done()},function(e){i.reject(e)}).done(),i.promise},remove:function(e,t){var i=this,n=Q.defer();return this.setState(e,WS.Entity.State.FAILED).then(function(o){t?i._entity.deleteData(t,e).then(function(){i._entity.remove(o).then(function(){n.resolve()},function(e){n.reject(e)}).done()},function(e){"EXCEPTION_MESSAGE_FIND_OBJECT"===e.message?i._entity.remove(o).then(function(){n.resolve()},function(e){n.reject(e)}).done():n.reject(e)}).done():i._entity.remove(o).then(function(){n.resolve()},function(e){n.reject(e)}).done()},function(e){"EXCEPTION_MESSAGE_FIND_OBJECT"===e.message?n.resolve():n.reject(e)}).done(),n.promise},setState:function(e,t){return e._changes._state=t,this._entity.update(e)},uploadSingle:function(e){var t=e._data,i=e._entity,n=e._file,o=this,r=Q.defer(),a=new FileReader;return a.onload=function(){var s=new Uint8Array(a.result);o._entity.uploadSingle(t,i,s,e._canceller).then(function(e){r.resolve([e!==!1,n,t,i])},function(e){r.reject(e)}).done()},a.onerror=function(){var e=new Error("EM_READ_FILE");e._file=n.name,r.reject(e)},a.readAsArrayBuffer(n),r.promise},uploadMulti:function(e,t){var i=e._data,n=e._entity,o=e._file,r=this,a=Q.defer();return this._entity.uploadMultiStart(i,n).then(function(s){function c(){l.readAsArrayBuffer(o.slice(h,h+d))}var l=new FileReader,h=0,d=WS.Uploader.calcPartSize(o.size),u=1,p=0,_=Math.ceil(o.size/d);l.onload=function(){var g=new Uint8Array(l.result);r._entity.uploadMultiContinue(i,n,s,u,g,e._canceller).then(function(e){return g=void 0,e===!1?void a.resolve([!1,o,i,n]):(p++,void(p===_?r._entity.uploadMultiFinish(i,n,s).then(function(){a.resolve([!0,o,i,n])},function(e){a.reject(e)}).done():(t(n,u,p,_),u++,h+=d,c())))},function(e){a.reject(e)}).done()},l.onerror=function(){var e=new Error("EM_READ_FILE");e._file=o.name,a.reject(e)},c()},function(e){a.reject(e)}).done(),a.promise},getValidFileName:function(e){var t=e.substr(0,e.lastIndexOf(".")),i=this.removeInvalidChars(t);return 1<i.length?i:"file"},removeInvalidChars:function(e){for(var t="",i=e.length,n=0;i>n;++n){var o=e[n];this.isValidFileName(o)&&(t+=o)}return t},isValidFileName:function(e){var t=/[\w\-]+/;return!!t.exec(e)}},WS.extend("Uploader"),WS.Uploader.SINGLE_MAXSIZE=5242880,WS.Uploader.PART_MINSIZE=5242880,WS.Uploader.MAXPARTS=1e4,WS.Uploader.calcPartSize=function(e){return Math.max(WS.Uploader.PART_MINSIZE,Math.ceil(e/WS.Uploader.MAXPARTS))},WS.UploaderCPE=function(e,t){WS.Uploader.call(this,e,t)},WS.UploaderCPE.prototype={createEntity:function(e){var t=this,i=Q.defer(),n=this.getNewEntity(e),o=new FileReader;return o.onload=function(){var r=t.setEntityAttributes(n,o.result);if(!r){var a=new Error("EM_FILE_TYPE_2");return a._file=e.name,void i.reject(a)}t._entity.create(n).then(function(e){i.resolve(e)},function(e){i.reject(e)}).done()},o.onerror=function(){var t=new Error("EM_READ_FILE");t._file=e.name,i.reject(t)},o.readAsArrayBuffer(e.slice(0,20)),i.promise},setEntityAttributes:function(e,t){if(t.byteLength<20)return!1;var i=new DataView(t),n=i.getUint8(8),o=i.getUint8(9),r=i.getUint8(10),a=i.getFloat32(12,!0),s=i.getUint32(16,!0);if(0===n)e._color="none";else if(1===n)e._color="rgb16";else{if(2!==n)return!1;e._color="rgb24"}if(0===o)e._reflection="none";else{if(1!==o)return!1;e._reflection="var_int"}if(0===r)e._normal="none";else{if(1!==r)return!1;e._normal="phi_theta"}return 0>=a||a>.1?!1:(e._quantization=a,s>2147483647?!1:(e._reflectionRange=s,!0))},createData:function(e,t){var i=this.getNewData(e);return i._extension="cpe",this._entity.createData(i,t)}},WS.extend("UploaderCPE","Uploader"),WS.UploadController=function(e,t,i,n,o){function r(e){c.onDragEnter(e)}function a(e){c.onDragEnd(e)}function s(e){c.onDrop(e)}F.Embeddable.call(this,e,t,i);var c=this;this._alert=n,this._entitycpe=o,this._numUploads=0,this._numCurrentUploads=0,this._uosToUpload=[],e.page={uploadObjects:[],dragging:!1,showProcessing:!1,hasDnD:!F.isTouch()},e.getUploadObjects=function(){return e.page.uploadObjects[e.project]},e.cancel=function(e){e._uploading?e._canceller.resolve():c.cancelEarly(e)};var l=document.getElementById("uploadZone");l&&(l.addEventListener("dragenter",r,!1),l.addEventListener("dragend",a,!1),l.addEventListener("dragleave",a,!1),l.addEventListener("drop",s,!1))},WS.UploadController.prototype={onDragEnter:function(e){e.stopPropagation(),e.preventDefault(),"uploadZone"===e.target.id&&this.$scope.$apply(function(e){e.page.dragging=!0})},onDragEnd:function(e){e.stopPropagation(),e.preventDefault(),"uploadZone"===e.target.id&&this.$scope.$apply(function(e){e.page.dragging=!1})},onDrop:function(e){e.stopPropagation(),e.preventDefault();this.$scope.$apply(function(e){e.page.dragging=!1});var t=e.dataTransfer?e.dataTransfer.files:[],i=t.length;if(0!==i){if(!window.FileReader)return void this._alert.error("EM_BROWSER",F.AlertServiceBase.DELAY_MEDIUM,"Firefox: 3.6, Chrome: 7, Internet Explorer: 10, Opera: 12.02, Safari: 6.0.2");var n=this.$scope.project;if(!n)return void this._alert.error("EM_NO_PROJECT",F.AlertServiceBase.DELAY_MEDIUM);this.$scope.$apply(function(e){e.page.showProcessing=!0}),this.uploadFiles(n,t)}},uploadFiles:function(e,t){for(var i=this,n=this.$scope,o=t.length,r=0;o>r;++r)this.getUploader(e,t[r]).then(function(e){var t=e[0],o=e[1];0===i._numUploads&&window.addEventListener("beforeunload",i.confirmClose,!1),i._numUploads+=1,t.prepareUpload(o).then(function(e){var t=e[0],o=e[1],r=e[2],a=e[3],s={_data:r,_entity:a,_file:o,_uploader:t,_progress:0,_canceller:Q.defer(),_uploading:!1,_cancelled:!1,_error:!1},c=a._project;void 0===n.page.uploadObjects[c]&&(n.page.uploadObjects[c]=[]),n.$apply(function(){n.page.uploadObjects[c].push(s),n.page.showProcessing=!1}),i._uosToUpload.push(s),i.tryToUploadNextFile()},function(e){n.$apply(function(){n.page.showProcessing=!1}),i.reduceNumUploads(),i.showErrorMsg(e)})},function(e){n.$apply(function(){n.page.showProcessing=!1}),i.showErrorMsg(e)}).done()},getUploader:function(e,t){var i=this,n=Q.defer(),o=new FileReader,r=F.getExtensionFromPath(t.name);if(r&&"cpe"===r.toLowerCase())o.onload=function(){var r=new Uint8Array(o.result);if(67===r[0]&&80===r[1]&&69===r[2])n.resolve([new WS.UploaderCPE(i._entitycpe,e),t]);else{var a=new Error("EM_FILE_TYPE_2");a._file=t.name,n.reject(a)}},o.onerror=function(){var e=new Error("EM_READ_FILE");e._file=t.name,n.reject(e)},o.readAsArrayBuffer(t.slice(0,3));else{var a=new Error("EM_FILE_TYPE_2");a._file=t.name,n.reject(a)}return n.promise},tryToUploadNextFile:function(){if(!(WS.UploadController.MAX_PARALLEL_UPLOADS<=this._numCurrentUploads)&&0<this._uosToUpload.length){var e=this._uosToUpload.shift();this.uploadSingleFile(e)}},uploadSingleFile:function(e){function t(e,t,n,o){i.onPartProgress(e,t,n,o)}var i=this;this._numCurrentUploads+=1;var n=e._uploader;e._uploading=!0,e._file.size<=WS.Uploader.SINGLE_MAXSIZE?n.uploadSingle(e).then(function(e){i.handleUploadResponse(e,n)},function(t){i.onError(t,n,e._data,e._entity)}).done():n.uploadMulti(e,t).then(function(e){i.handleUploadResponse(e,n)},function(t){i.onError(t,n,e._data,e._entity)}).done()},handleUploadResponse:function(e,t){var i=e[0],n=(e[1],e[2]),o=e[3];if(i){var r=this;t.setState(o,WS.Entity.State.COMPLETE).then(function(e){r.onSuccess(e)},function(e){r.onError(e,t,n,o)})}else this.onCancelled(t,n,o)},onPartProgress:function(e,t,i,n){var o=this,r=o.getUploadObject(e);if(r){var a=r._canceller&&Q.isFulfilled(r._canceller.promise);r._canceller=Q.defer(),a&&r._canceller.resolve(),this.$scope.$apply(function(){r._progress=i/n})}},remove:function(e,t,i){var n=this;e.remove(i,t).fail(function(e){n.showErrorMsg(e)}).done()},onSuccess:function(e){var t=this;this._numCurrentUploads-=1,this.reduceNumUploads(),this.tryToUploadNextFile(),this.$scope.$apply(function(){var i=t.getUploadObject(e);i&&(i._uploading=!1,i._progress=1)})},onCancelled:function(e,t,i){var n=this;this._numCurrentUploads-=1,this.reduceNumUploads(),this.tryToUploadNextFile(),this.$scope.$apply(function(){var e=n.getUploadObject(i);
e&&(e._uploading=!1,e._cancelled=!0,e._progress=0)}),this.remove(e,t,i)},onError:function(e,t,i,n){var o=this;this._numCurrentUploads-=1,this.reduceNumUploads(),this.tryToUploadNextFile(),this.$scope.$apply(function(){var e=o.getUploadObject(n);e&&(e._uploading=!1,e._error=!0,e._progress=0)}),this.showErrorMsg(e),this.remove(t,i,n)},cancelEarly:function(e){this.reduceNumUploads(),F.removeFirst(this._uosToUpload,e),e._cancelled=!0,e._progress=0,this.remove(e._uploader,e._data,e._entity)},reduceNumUploads:function(){this._numUploads-=1,0===this._numUploads&&window.removeEventListener("beforeunload",this.confirmClose,!1)},getUploadObject:function(e){var t=this.$scope.page.uploadObjects[e._project];if(!t)return void 0;for(var i=t.length,n=0;i>n;++n)if(t[n]._entity._UUID===e._UUID)return t[n];return void 0},showErrorMsg:function(e){"EM_READ_FILE"===e.message?this._alert.error(e.message,void 0,void 0,[e._file]):"EM_FILE_TYPE_2"===e.message?this._alert.error(e.message,void 0,void 0,[e._file,"CPE"]):this._alert.errorObj(e)},preventDefault:function(e){e.preventDefault()},confirmClose:function(e){var t="o/";return e.returnValue=t,t},onShow:function(){F.Embeddable.prototype.onShow.call(this),window.addEventListener("dragover",this.preventDefault,!1),window.addEventListener("dragenter",this.preventDefault,!1),window.addEventListener("dragend",this.preventDefault,!1),window.addEventListener("dragleave",this.preventDefault,!1),window.addEventListener("drop",this.preventDefault,!1)},onHide:function(){F.Embeddable.prototype.onHide.call(this),window.removeEventListener("dragover",this.preventDefault,!1),window.removeEventListener("dragenter",this.preventDefault,!1),window.removeEventListener("dragend",this.preventDefault,!1),window.removeEventListener("dragleave",this.preventDefault,!1),window.removeEventListener("drop",this.preventDefault,!1);var e=this.$scope.page.uploadObjects;for(var t in e)e.hasOwnProperty(t)&&F.removeAll(e[t],function(e){return 1===e._progress||e._cancelled||e._error})}},WS.extend("UploadController","Embeddable"),WS.UploadController.MAX_PARALLEL_UPLOADS=2,angular.module("ws.entity",[]),F.DI().registerService("entity",WS.EntityService,"@serializer","@error","@selection","@plug","$resource","$http"),F.DI().registerService("entitycpe",WS.EntityCPEService,"@serializer","@error","@selection","@plug","$resource","$http"),F.DI().registerService("entitypc",WS.EntityPCService,"@serializer","@error","@selection","@plug","$resource","$http"),F.DI().config("@serializer","@entity",function(e,t){e.registerClass("Entity",function(){return t.getNew()}),e.registerClass("Data",function(){return t.getNewData()})}),F.DI().config("@serializer","@entitycpe",function(e,t){e.registerClass("EntityCPE",function(){return t.getNew()})}),F.DI().config("@serializer","@entitypc",function(e,t){e.registerClass("EntityPC",function(){return t.getNew()})}),F.DI().registerController("uploadcontroller",WS.UploadController,"@plug","@url","@alert","@entitycpe"),angular.module("ws.entity").directive("upload",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("uploadcontroller"),restrict:"E",scope:{project:"="},templateUrl:F.partialUrl("upload.html"),transclude:!0})}),WS.ChargedTask={getConfirmCostsStep:function(e){return F.mergeObjects({caption:"TC_CONFIRM_COST",icon:WS.Icons.TaskSection.check,widget:'<div>{{"FE_CONFIRM_COSTS" | i18n}} <strong>{{costs}}&nbsp;{{\'FE_SCANS\' | i18n}}</strong>.</div><div ng-show="!costsValid" style="height:48px;"><img ng-show="costsValid === undefined" class="f_icon16" static-src="icons/im/spinner.gif"></div><checkbox target="input.confirmedCosts" source="input.confirmedCosts" name="{{\'FE_CONFIRM\' | i18n}}" ng-show="costsValid"></checkbox><betahint ng-show="input.cpes.length">{{ "FE_CPE_FREE" | i18n }}</betahint><alert type="info">{{"FE_CONFIRM_COSTS_INFO" | i18n}}</alert>',completeCondition:"costsValid && input.confirmedCosts"},e||{})},setupConfirmCostsStep:function(){this.$scope.input.confirmedCosts=!1,this.$scope.costsValid=!1,this.$scope.costs=0}},WS.defineMixin("ChargedTask"),WS.AddUserTask=function(e,t){WS.Task.call(this,t),this._user=e,this.$scope=void 0,this._description=[{caption:"TC_USERNAME",optional:!0,selectPageClass:"users",description:"TD_ADDUSERNAME",widget:'<editarea target="input.usernames" focus-me="section._active" placeholder="{{\'TC_USERNAME\'|i18n}}"></editarea><p class="f_textBold">{{"TD_SELECTED_USERS"|i18n}}</p><ul><li ng-repeat="email in input.emails" ng-class="{f_textError: email.validationMsg}"><div class="f_breakAll">{{email.address}}</div><div ng-show="email.validationMsg"> ({{email.validationMsg | i18n}})</div></li></ul><p class="f_textBold">{{"FE_PLEASENOTE"|i18n}}:</p><p>{{"TD_ADDUSERNAME2"|i18n}}</p>',icon:WS.Icons.TaskSection.textinput,completeCondition:"(input.emails.length > 0) && input.emailsAllValid"}]},WS.AddUserTask.prototype={setup:function(e){this.$scope=e,e.$watch("input.usernames",function(t){if(e.input.emails=[],e.input.emailsAllValid=!0,t){var i=t.split(/[,|;|\s|\r|\n|<|>]+/);i.forEach(function(t){if(t.indexOf("@")>=0){var i=F.validateEmail(t);e.input.emailsAllValid=e.input.emailsAllValid&&!i;var n={address:t,validationMsg:i};e.input.emails.push(n)}})}})},execute:function(e){var t=this,i=e.emails.map(function(e){return e.address});return this._user.getAll().then(function(e){return e.forEach(function(e){var t=i.indexOf(e.getUsername());-1!==t&&i.splice(t,1)}),t._user.addUsersToDomain(i)})}},WS.extend("AddUserTask","Task"),WS.RemoveUserTask=function(e,t){WS.Task.call(this,e),this._userService=t,this._description=[{caption:"TC_SELECT_USER",selectPageClass:"users",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{"with":"roles",selection:"user"},select:"User",selection:"input.userSelection",selectionEntry:"{{entry.getNameAndUsername()}}",completeCondition:"input.userSelection.length > 0"},{caption:"TC_CONFIRM_DELETE",description:"TD_DELETE",widget:'<checkbox target="input.removalConfirmed" source="input.removalConfirmed" name="{{\'TD_DELETE_YES\' | i18n}}"></checkbox>',icon:WS.Icons.TaskSection.check,completeCondition:"input.removalConfirmed == true"}]},WS.RemoveUserTask.prototype={execute:function(e){var t=this,i=Q.defer();return this._userService.removeUsersFromDomain(e.userSelection).then(function(e){i.resolve(e)}).fail(function(e){F.DI().getService("error").isExceptionType(e,"DomainAdminException")?(t.$scope.input.removalConfirmed=!1,t.setActiveSection(t._sections[0]),F.DI().getService("alert").error(e.message,F.AlertServiceBase.DELAY_SHORT),i.reject(WS.Task.LOCAL_RECOVERY)):i.reject(e)}).done(),i.promise}},WS.extend("RemoveUserTask","Task"),WS.CreateGroupTask=function(e,t,i){WS.Task.call(this,e),this._groupService=t,this._locale=i,this._description=[{caption:"TC_ENTER_NAME",selectPageClass:"groups",widget:'<edit target="input.group._name" validation="validateGroupName" focus-me="section._active" placeholder="{{\'FE_ENTER_NAME\'|i18n}}"/>',icon:WS.Icons.TaskSection.textinput,completeCondition:"input.group._name && !validateGroupName(input.group._name)"},{caption:"TC_ENTER_DESCR",optional:!0,widget:'<editarea target="input.group._description" validation="validateGroupDescription" focus-me="section._active" placeholder="{{\'FE_ENTER_DESCR\'|i18n}}"></editarea>',icon:WS.Icons.TaskSection.textinput,completeCondition:"!validateGroupDescription(input.group._description)"}]},WS.CreateGroupTask.prototype={setup:function(e){e.input.group=this._groupService.getNew(),e.validateGroupName=F.proxy(this._groupService.validateGroupName,this._groupService),e.validateGroupDescription=F.proxy(this._groupService.validateGroupDescription,this._groupService)},execute:function(e){var t=this;return e.group.create().fail(function(e){if(F.DI().getService("error").isExceptionType(e,"ResourceAlreadyExistsException"))throw t.setHint(e.message),WS.Task.LOCAL_RECOVERY;throw e})}},WS.extend("CreateGroupTask","Task"),WS.EditGroupTask=function(e,t,i){WS.Task.call(this,e),this._groupService=t,this._locale=i;var n="input.selectedGroup.length > 0";this._description=[{caption:"TC_SELECT_GROUP",selectPageClass:"groups",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{selection:"group"},select:"Group",selection:"input.selectedGroup",selectionEntry:"{{entry._name}}",selectSingle:!0,completeCondition:n},{caption:"TC_EDIT_NAME",optional:!0,widget:'<edit target="input.selectedGroup[0]._changes._name" source="input.selectedGroup[0]._name" validation="validateGroupName" focus-me="section._active" placeholder="{{\'FE_ENTER_NAME\'|i18n}}"/>',icon:WS.Icons.TaskSection.textinput,startCondition:n,completeCondition:"input.selectedGroup[0]._changes._name && !validateGroupName(input.selectedGroup[0]._changes._name)"},{caption:"TC_EDIT_DESCR",optional:!0,widget:'<editarea target="input.selectedGroup[0]._changes._description" source="input.selectedGroup[0]._description" validation="validateGroupDescription" focus-me="section._active" placeholder="{{\'FE_ENTER_DESCR\'|i18n}}"></editarea>',icon:WS.Icons.TaskSection.textinput,startCondition:n,completeCondition:"!validateGroupDescription(input.selectedGroup[0]._changes._description)"}]},WS.EditGroupTask.prototype={setup:function(e){e.validateGroupName=F.proxy(this._groupService.validateGroupName,this._groupService),e.validateGroupDescription=F.proxy(this._groupService.validateGroupDescription,this._groupService)},execute:function(e){return e.selectedGroup[0].update()}},WS.extend("EditGroupTask","Task"),WS.DeleteGroupTask=function(e,t){WS.Task.call(this,e),this._groupService=t,this._description=[{caption:"TC_SELECT_GROUP",selectPageClass:"groups",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{selection:"group"},select:"Group",selection:"input.groups",selectionEntry:"{{entry._name}}",completeCondition:"input.groups.length > 0"},{caption:"TC_CONFIRM_DELETE",description:"TD_CHECK_DELETE_GROUP",widget:'<checkbox target="input.deletionConfirmed" source="input.deletionConfirmed" name="{{\'TD_DELETE_GROUP_YES\' | i18n}}"></checkbox>',icon:WS.Icons.TaskSection.check,completeCondition:"input.deletionConfirmed"}]},WS.DeleteGroupTask.prototype={execute:function(e){return Q.all(e.groups.map(function(e){return e.remove()}))}},WS.extend("DeleteGroupTask","Task"),WS.AddUserToGroupTask=function(e,t){WS.Task.call(this,e),this._userService=t,this._description=[{caption:"TC_SELECT_GROUP",description:"TD_ADD_USER_GROUP",selectPageClass:"groups",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{selection:"group"},select:"Group",selection:"input.selectedGroups",selectionEntry:"{{entry._name}}",completeCondition:"input.selectedGroups.length > 0"},{caption:"TC_SELECT_USER",description:"TD_ADD_USER_GROUP_2",selectPageClass:"users",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{"with":"groups",selection:"user"},select:"User",selection:"input.selectedUsers",selectionEntry:"{{entry.getNameAndUsername()}}",completeCondition:"input.selectedUsers.length > 0"}]},WS.AddUserToGroupTask.prototype={execute:function(e){return Q.all(e.selectedGroups.map(function(t){return t.addUsers(e.selectedUsers)}))}},WS.extend("AddUserToGroupTask","Task"),WS.RemoveUserFromGroupTask=function(e){WS.Task.call(this,e),this._description=[{caption:"TC_SELECT_GROUP",description:"TD_REMOVE_USER_GROUP",selectPageClass:"groups",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{selection:"group"},select:"Group",selection:"input.selectedGroups",selectionEntry:"{{entry._name}}",completeCondition:"input.selectedGroups.length > 0"},{caption:"TC_SELECT_USER",description:"TD_REMOVE_USER_GROUP_2",selectPageClass:"users",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{"with":"groups",selection:"user"},select:"User",selection:"input.selectedUsers",selectionEntry:"{{entry.getNameAndUsername()}}",completeCondition:"input.selectedUsers.length > 0"},{caption:"TC_CONFIRM_REMOVAL",description:"TD_REMOVAL",widget:'<checkbox target="input.removalConfirmed" source="input.removalConfirmed" name="{{\'TD_REMOVAL_YES\' | i18n}}"></checkbox>',icon:WS.Icons.TaskSection.check,completeCondition:"input.removalConfirmed"}]},WS.RemoveUserFromGroupTask.prototype={execute:function(e){return Q.all(e.selectedGroups.map(function(t){return t.removeUsers(e.selectedUsers)}))}},WS.extend("RemoveUserFromGroupTask","Task"),WS.GrantRoleTask=function(e){WS.Task.call(this,e),this._description=[{caption:"TC_SELECT_USER",description:"TD_ADD_USER_ROLE",selectPageClass:"users",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{"with":"roles",selection:"user"},select:"User",selection:"input.selectedUsers",selectionEntry:"{{entry.getNameAndUsername()}}",completeCondition:"input.selectedUsers.length > 0"},{caption:"TC_SELECT_ROLE",selectPageClass:"roles",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{selection:"role"},select:"Role",selection:"input.selectedRoles",selectionEntry:"{{entry._name}}",completeCondition:"input.selectedRoles.length > 0"}]},WS.GrantRoleTask.prototype={execute:function(e){return Q.all(e.selectedRoles.map(function(t){return t.addUsers(e.selectedUsers)}))}},WS.extend("GrantRoleTask","Task"),WS.RevokeRoleTask=function(e){WS.Task.call(this,e),this._description=[{caption:"TC_SELECT_USER",description:"TD_REMOVE_USER_ROLE",selectPageClass:"users",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{"with":"roles",selection:"user"},select:"User",selection:"input.selectedUsers",selectionEntry:"{{entry.getNameAndUsername()}}",completeCondition:"input.selectedUsers.length > 0"},{caption:"TC_SELECT_ROLE",selectPageClass:"roles",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{selection:"role"},select:"Role",selection:"input.selectedRoles",selectionEntry:"{{entry._name}}",completeCondition:"input.selectedRoles.length > 0"},{caption:"TC_CONFIRM_REMOVAL",description:"TD_REMOVAL_ROLES",widget:'<checkbox target="input.removalConfirmed" source="input.removalConfirmed" name="{{\'TD_REMOVAL_ROLES_YES\' | i18n}}"></checkbox>',icon:WS.Icons.TaskSection.check,completeCondition:"input.removalConfirmed"}]},WS.RevokeRoleTask.prototype={execute:function(e){var t=Q.defer();return Q.all(e.selectedRoles.map(function(t){return t.removeUsers(e.selectedUsers)})).then(function(e){t.resolve(e)}).fail(function(e){F.DI().getService("error").isExceptionType(e,"DomainAdminException")?(F.DI().getService("alert").error(e.message,F.AlertServiceBase.DELAY_SHORT),t.reject(WS.Task.LOCAL_RECOVERY)):t.reject(e)}).done(),t.promise}},WS.extend("RevokeRoleTask","Task"),WS.WorkbenchBaseTask=function(e,t){WS.Task.call(this,e),this._project=t},WS.WorkbenchBaseTask.prototype={setup:function(e){this.$scope=e,e.input.project=void 0,this._project.getCurrentProject().then(function(t){e.input.project=t}).done()}},WS.extend("WorkbenchBaseTask","Task"),WS.ProjectTaskBase=function(e,t){F.Task.call(this,e),this._projectService=t},WS.ProjectTaskBase.prototype={setup:function(e){this.$scope=e,e.input.project=void 0,this._projectService.getCurrentProject().then(function(t){e.input.project=t}).done(),this.addValidators(e)},addValidators:function(e){e.validateNumber=F.validateNumber,e.validateDisplayName=function(e){return e&&e.length?WS.Project.DISPLAYNAME_MAX_CHARS<e.length||WS.Project.DISPLAYNAME_MAX_BYTES<F.byteLength(e)?"EM_NAME_TOO_LONG_60":void 0:"EM_NAME_TOO_SHORT"}},getFeatureStep:function(e){return F.mergeObjects({caption:"TC_FEATURE_PROJECT",optional:!0,description:"TD_FEATURE_PROJECT",widget:'<checkbox target="input.project._changes._featured" source="input.project._featured" name="{{\'TC_FEATURE_PROJECT\' | i18n}}"></checkbox>',icon:WS.Icons.TaskSection.check},e||{})},getDescStep:function(e){return F.mergeObjects({caption:"TC_EDIT_DESCR",optional:!0,widget:'<markdownhint></markdownhint><br /><br /><editarea	target="input.project._changes._description" source="input.project._description" focus-me="section._active" placeholder="{{\'FE_ENTER_DESCR\'|i18n}}"></editarea>',icon:WS.Icons.TaskSection.textinput},e||{})},getLocationStep:function(e){return F.mergeObjects({caption:"TC_EDIT_LOCATION",optional:!0,description:"TD_EDIT_LOCATION",widget:'<label>{{\'FE_LATITUDE\' | i18n}}</label><edit target="input.project._changes._latitude" source="input.project._latitude" validation="validateNumber" focus-me="section._active" placeholder="{{\'FE_LATITUDE\'|i18n}}"/><label>{{\'FE_LONGITUDE\' | i18n}}</label><edit target="input.project._changes._longitude" source="input.project._longitude" validation="validateNumber" placeholder="{{\'FE_LONGITUDE\'|i18n}}"/>',icon:WS.Icons.TaskSection.location,completeCondition:"!validateNumber(input.project._changes._latitude) && !validateNumber(input.project._changes._longitude)"},e||{})},getImageStep:function(e){return F.mergeObjects({id:"image",caption:"TC_CHANGE_PREVIEW_IMG",selectPageClass:"projectimage",optional:!0,description:"TD_CHANGE_PREVIEW_IMG",widget:'<alert type="warning" ng-show="input.project._changes._newImage.error">{{input.project._changes._newImage.error | i18n}}</alert>',icon:WS.Icons.TaskSection.image,completeCondition:"!input.project._changes._newImage.loading && !input.project._changes._newImage.error"},e||{})}},WS.extend("ProjectTaskBase","Task"),WS.CreatePointCloudsTask=function(e,t,i,n,o,r,a,s){WS.WorkbenchBaseTask.call(this,e,t),this._scan=i,this._jobQueue=n,this._transaction=o,this._entityPC=r,this._entityCPE=a,this._locale=s,this._nameChangedByUser=!1;var c={pro:{blockvisible:{scan:!0,cpe:!0,pc:!1,lpc:!1},blockcollapsed:{scan:!1,cpe:!1,pc:!1,lpc:!1}}},l={pro:{blockvisible:{scan:!0,cpe:!0,pc:!1,lpc:!0},blockcollapsed:{scan:!0,cpe:!0,pc:!1,lpc:!1}}};this._description=[{caption:"TC_SELECT_SOURCES",description:"TD_SELECT_SOURCES",selectPageClass:"processing",icon:WS.Icons.TaskSection.selectbox,pageConfiguration:F.mergeObjects({selection:"scan,entitycpe"},c),select:"Scan,EntityCPE",selection:"input.scans,input.cpes",selectionEntry:"{{entry._displayName}}",widget:'<betahint>{{ "FE_BETA_PC_SOURCES" | i18n }}</betahint><alert type="warning" ng-if="notCompleteCPE().length > 0">{{ "FE_NOT_COMPLETE_SOURCES" | i18n }}:<ul><li ng-repeat="entity in notCompleteCPE()">{{ entity._displayName }}</li></ul></alert>',completeCondition:"hasValidSource()"},this.getConfirmCostsStep({pageConfiguration:l}),{caption:"TC_ENTER_NAME",optional:!1,widget:'<edit target="input.name" validation="validateName" userchange="userChangedName" focus-me="section._active" placeholder="{{\'FE_ENTER_NAME\'|i18n}}"/>',icon:WS.Icons.TaskSection.textinput,pageConfiguration:l,completeCondition:"0 < input.name.length && !validateName(input.name)"},{caption:"TC_SET_COLORMODE",description:"TD_SET_COLORMODE_3D",icon:WS.Icons.TaskSection.colormode,pageConfiguration:l,optional:!0,widget:'<div ng-repeat="mode in colorModes" class="btn-group"><button class="btn btn-default" title="{{mode.str | i18n}}" ng-click="setColorMode(mode.id)" ng-class="{\'btn-info\': input.colorMode == mode.id}" style="padding-top:0; padding-bottom:0; margin-bottom:5px;"><img class="f_icon32" static-src="{{mode.icon}}"/><div style="width:170px; display:inline-block;">{{mode.str | i18n}}</div></button></div>'}]},WS.CreatePointCloudsTask.prototype={setup:function(e){WS.WorkbenchBaseTask.prototype.setup.call(this,e);var t=this;this.setupNameStep(),this.setupConfirmCostsStep(),e.colorModes={Color:{id:"Color",str:"FE_PREFER_COLOR",icon:"icons/color.png"},Gray:{id:"Gray",str:"FE_PREFER_GRAY",icon:"icons/gray.png"}},e.input.colorMode="Color",e.setColorMode=function(t){e.input.colorMode=t},e.notCompleteCPE=function(){return e.input.cpes.filter(function(e){return e._state!==WS.Entity.State.COMPLETE})},e.hasValidSource=function(){var t=e.input;return t.project&&(t.scans.length>0||t.cpes.some(function(e){return e._state===WS.Entity.State.COMPLETE}))},e.$watch('input.scans.length + "," + input.cpes.length',function(){var i=e.input.scans||[],n=(e.input.cpes||[]).filter(function(e){return e._state===WS.Entity.State.COMPLETE});t.calculateCosts(i,n),t.generateName(i,n)});var i=[this._scan.getAll(),this._entityCPE.getAll({project:this._project.getCurrent()})];Q.all(i).spread(function(i,n){0===n.length&&(t._scan._selection.setSelection(i),e.$apply(function(){F.clearArray(e.input.scans),i.forEach(function(t){e.input.scans.push(t)})}))})},setupNameStep:function(){var e=this;this.$scope.validateName=function(e){return e&&e.length?WS.Entity.DISPLAYNAME_MAX_CHARS<e.length||WS.Entity.DISPLAYNAME_MAX_BYTES<F.byteLength(e)?"EM_NAME_TOO_LONG_80":void 0:"EM_NAME_TOO_SHORT"},this.$scope.userChangedName=function(){e._nameChangedByUser=!0}},calculateCosts:function(e){var t=this.$scope,i=e.length;t.input.confirmedCosts=!1,i>0?(t.costsValid=void 0,this._transaction.calcCosts(1,i).then(function(n){e.length===i&&t.$apply(function(){t.input.confirmedCosts=!1,t.costsValid=!0,t.costs=n})})):(t.costsValid=!0,t.input.confirmedCosts=!1,t.costs=0)},generateName:function(e,t){var i=this.$scope;if(!this._nameChangedByUser)if(0===e.length&&0===t.length)i.input.name=this._locale.translate("FE_POINT_CLOUD");else for(var n=6;n>=0;n--){var o=Math.ceil(n/2),r=Math.floor(n/2);if(i.input.name=this.generateNameInternal(e,r,t,o),!i.validateName(i.input.name))break}},generateNameInternal:function(e,t,i,n){var o=e.length,r=i.length,a="";if(r>0){var s=i.slice(0,n).map(function(e){return e._displayName});s.length>0&&s.length<r&&s.push("...");var c="";s.length>0&&(c=" ("+s.join(", ")+")"),a+=r+(1===r?" CPE":" CPEs")+c}if(o>0){var l=e.slice(0,t).map(function(e){return e._displayName});l.length>0&&l.length<o&&l.push("...");var h=this._locale.translate("FE_SCAN"),d=this._locale.translate("FE_SCANS"),u=this._locale.translate("FE_AND"),p="";l.length>0&&(p=" ("+l.join(", ")+")"),r>0&&(a+=" "+u+" "),a+=o+" "+(1===o?h:d)+p}return a},execute:function(e){var t=this,i=(this.$scope,e.project),n=this._entityPC.getNew();return n._project=i._name,""!==e.name&&(n._displayName=e.name),n._scanUUIDs=e.scans.map(function(e){return e._UUID}),n._relations=e.cpes.filter(function(e){return e._state===WS.Entity.State.COMPLETE}).map(function(e){return{Sub:e._UUID,Type:WS.Entity.RelationType.USES}}),n._colorRatio="Gray"===e.colorMode?0:100,n.create().then(function(e){return e._changes._state=WS.Entity.State.PROCESSING,e.update()}).then(function(){t._jobQueue.getAll()}).fail(function(e){return t._jobQueue.getAll(),new F.TaskResult([e.message],[],!0)})},queryTaskLaunch:function(e,t,i){return e===this._panel&&t===this._category.id&&(!i||"createptclouds"===i)}},WS.extend("CreatePointCloudsTask","WorkbenchBaseTask"),WS.mixin("CreatePointCloudsTask","ChargedTask"),WS.CreateProjectTask=function(e,t){WS.ProjectTaskBase.call(this,e,t),this._idChangedByUser=!1,this._usedIds=void 0,this._promiseUsed=void 0,this._description=[{caption:"TC_ENTER_NAME",selectPageClass:"projectlist",icon:WS.Icons.TaskSection.textinput,widget:'<betahint>{{ "FE_BETA_INC_PROJECTS" | i18n }}</betahint><p>{{"TD_CREATE_PROJECT"|i18n}}</p><div>{{"TC_ENTER_NAME" | i18n}}:</div><edit target="input.project._changes._displayName" validation="validateDisplayName" focus-me="section._active" placeholder="{{\'FE_ENTER_NAME\'|i18n}}"/><br /><div>{{"FE_ENTER_URL_ID" | i18n}}:</div><edit target="input.project._changes._name" validation="validateName" userchange="userChangedId" placeholder="{{\'FE_ENTER_URL_ID\'|i18n}}"/>',completeCondition:"!validateDisplayName(input.project._changes._displayName) && !validateName(input.project._changes._name)"},this.getDescStep(),this.getLocationStep(),this.getImageStep()]},WS.CreateProjectTask.prototype={setup:function(e){var t=this;this.$scope=e;var i=this._projectService.getNew();i._type=WS.Project.Type.INC,i._name="",i._description="",i._latitude=0,i._longitude=0,e.input.project=i,this.addValidators(e),e.userChangedId=function(){t._idChangedByUser=!0},e.$watch("input.project._changes._displayName",function(e){void 0!==e&&t.generateId(e)}),this.provideMalePlug("ObjectEdit",["editObject"]);var n=this._connectorService;n.connect(this.getMalePlug("ObjectEdit"),n.getPlugModule("pi")),this.trigger("editObject",[i,"createproject"])},addValidators:function(e){WS.ProjectTaskBase.prototype.addValidators.call(this,e),e.validateName=function(e){return e&&e.length?40<e.length?"EM_NAME_TOO_LONG_40":e.match(/^([a-z]|[0-9]|[\-])+$/)?void 0:"EM_ENTER_PROJ_ID":"EM_NAME_TOO_SHORT"}},generateId:function(e){var t=this;if(!this._idChangedByUser){var i=this.displayNameToId(e);this._usedIds?this.generateIdCheckUsed(i,this._usedIds,!1):(this._promiseUsed||(this._promiseUsed=this._projectService.getUsedProjectIds()),this._promiseUsed.then(function(e){t._usedIds=e,t.generateIdCheckUsed(i,t._usedIds,!0)}))}},displayNameToId:function(e){for(var t="",i="abcdefghijklmnopqrstuvwxyz0123456789",n=e.length,o=0;n>o&&t.length<31;++o){var r=e[o].toLowerCase();0!==t.length&&"-"===t[t.length-1]||"-"!==r&&" "!==r&&"."!==r&&"_"!==r&&","!==r&&";"!==r&&":"!==r&&"&"!==r&&"/"!==r&&"\\"!==r?-1!==i.indexOf(r)&&(t+=r):t+="-"}return t},generateIdCheckUsed:function(e,t,i){for(var n=t.length,o=0;n>o;++o)if(e===t[o]){e+="-"+F.generateUUID().substr(0,8);break}i?this.$scope.$apply(function(t){t.input.project._changes._name=e}):this.$scope.input.project._changes._name=e},execute:function(){var e=this.$scope.input.project,t=e._changes._newImage;return e.applyChanges(),e.create().then(function(){return t?e.updateImage(t.type,t.data).then(function(){return e._changes._image=""+Date.now(),e.update()},function(e){var t="EXCEPTION_MESSAGE_INVALID_REQUEST_BODY_WRONG_CONTENT_TYPE"===e.message?"EM_IMAGE_DECODE":e.message;return new F.TaskResult([t])}):new F.TaskResult},function(e){return e&&"EXCEPTION_MESSAGE_RESOURCE_ALREADY_EXISTS"===e.message?new F.TaskResult(["EM_DUPLICATE_PROJ_ID"],[],!0):new F.TaskResult([e?e.message:"EM_UNKNOWN_ERROR"])})},teardown:function(e){!this._result._abortedByLaunchTask&&e&&(this._projectService.changeProject(this.$scope.input.project._name),this._result._followupTask={panel:"workbench",category:"import"})}},WS.extend("CreateProjectTask","ProjectTaskBase"),WS.DeleteProjectTask=function(e,t){WS.Task.call(this,e,t),this._description=[{caption:"TC_SELECT_PROJECT",selectPageClass:"projectlist",icon:WS.Icons.TaskSection.selectobject,pageConfiguration:{selection:"project"},select:"Project",selection:"input.projects",selectionEntry:"{{entry._displayName}}",completeCondition:"0 < input.projects.length"},{caption:"TC_CONFIRM_DELETE",description:"TD_CHECK_DELETE_PROJECT",widget:'<checkbox target="input.deletionConfirmed" source="input.deletionConfirmed" name="{{\'TD_DELETE_PROJECT_YES\' | i18n}}"></checkbox>',icon:WS.Icons.TaskSection.check,completeCondition:"input.deletionConfirmed"}]},WS.DeleteProjectTask.prototype={execute:function(e){return Q.allSettled(e.projects.map(function(e){return e.remove()})).then(function(e){var t={};return e.forEach(function(e){"rejected"===e.state&&(t[e.reason.message]=!0)}),new WS.TaskResult(Object.keys(t))})}},WS.extend("DeleteProjectTask","Task"),WS.ProjectRightsTask=function(e,t,i){WS.Task.call(this,t),this._projectService=e,this._localeService=i,this._description=[{caption:"TC_MANAGE_RIGHTS",optional:!0,description:"TD_MANAGE_RIGHTS",selectPageClass:"projectgroupmanagement",widget:'<p ng-show="!isEmpty(input.public) || !isEmpty(input.enable3D) || !isEmpty(input.relations)"><b>{{\'TD_CHANGES\' | i18n}}:</b></p><p ng-show="!isEmpty(input.public)">{{\'FE_PRIVACY\' | i18n}}:</p><ul><li ng-repeat="element in input.public">{{element.project._displayName}}: {{publicStateIs(element.public)}}</li></ul><p ng-show="!isEmpty(input.enable3D)">{{\'FE_ENABLE_3D_VIEW\' | i18n}}:</p><ul><li ng-repeat="element in input.enable3D">{{element.project._displayName}}: {{enable3DStateIs(element.enable3D)}}</li></ul><p ng-show="!isEmpty(input.relations)">{{\'TD_ACCESS_RIGHTS\' | i18n}}:</p><ul><li ng-repeat="element in input.relations">{{element.project._displayName}}<ul style="margin-left:0px" ng-show="!isEmpty(element.add)">{{\'TD_VISIBLE_FOR\' | i18n}}:<li style="margin-left:25px" ng-repeat="group in element.add">{{group._name}}</li></ul><ul style="margin-left:0px" ng-show="!isEmpty(element.remove)">{{\'TD_INVISIBLE_FOR\' | i18n}}:<li style="margin-left:25px" ng-repeat="groupr in element.remove">{{groupr._name}}</li></ul></li></ul>',icon:WS.Icons.TaskSection.configure}]},WS.ProjectRightsTask.prototype={setup:function(e){this._relationChanges=[],this._publicChanges=[],this._enable3DChanges=[],e.input.relations=this._relationChanges,e.input["public"]=this._publicChanges,e.input.enable3D=this._enable3DChanges,this.$scope=e;var t=this;this.provideFemalePlug("RelationChange",["addRelation","removeRelation"]),this._plugHandle=this.getFemalePlug("RelationChange"),this._connectorService.getMalePlugProviders("RelationChange").forEach(function(e){t.connect(t._plugHandle,e)}),e.isEmpty=function(e){return 0===e.length},e.publicStateIs=function(e){return t._localeService.translate(e?"FE_PUBLIC":"FE_PRIVATE")},e.enable3DStateIs=function(e){return t._localeService.translate(e?"FE_ON":"FE_OFF")}},execute:function(e){var t=[];e["public"].forEach(function(e){e.project._changes._public=e["public"],t.push(e.project)}),e.enable3D.forEach(function(e){e.project._changes._enable3D=e.enable3D,F.findFirst(t,e.project)||t.push(e.project)});var i=[];return t.forEach(function(e){i.push(e.update())}),e.relations.forEach(function(e){0!==e.add.length&&i.push(e.project.addGroups(e.add)),0!==e.remove.length&&i.push(e.project.removeGroups(e.remove))}),Q.all(i)},teardown:function(){this._plugHandle.disconnect(),this.revokeFemalePlug("RelationChange"),this._relationChanges=[],this._enable3DChanges=[],this._publicChanges=[]},addRelation:function(e,t){if(t instanceof WS.Group){var i=this.belongsProjectToChanges(this._relationChanges,e);if(-1===i)this.insertGroup(e,t,"add");else{var n=this.arrayIndexOfGroup(this._relationChanges[i].add,t._ID);-1===n?this.addGroupToArray(i,t,"add"):this.removeGroupFromArray(i,n,"add")}}else"boolean"==typeof t["public"]?this._publicChanges.push(t):this._enable3DChanges.push(t);this.$scope.$apply()},removeRelation:function(e,t){var i;if(t instanceof WS.Group)if(i=this.belongsProjectToChanges(this._relationChanges,e),-1===i)this.insertGroup(e,t,"remove");else{var n=this.arrayIndexOfGroup(this._relationChanges[i].remove,t._ID);-1===n?this.addGroupToArray(i,t,"remove"):this.removeGroupFromArray(i,n,"remove")}else"boolean"==typeof t["public"]?(i=this.belongsProjectToChanges(this._publicChanges,e),-1!==i&&this._publicChanges.splice(i,1)):(i=this.belongsProjectToChanges(this._enable3DChanges,e),-1!==i&&this._enable3DChanges.splice(i,1));this.$scope.$apply()},insertGroup:function(e,t,i){var n=[],o=[];"add"===i?n.push(t):o.push(t);var r={project:e,add:n,remove:o};this._relationChanges.push(r)},arrayIndexOfGroup:function(e,t){for(var i=0;i<e.length;i++)if(e[i]._ID===t)return i;return-1},belongsProjectToChanges:function(e,t){for(var i=0;i<e.length;i++)if(e[i].project._name===t._name)return i;return-1},addGroupToArray:function(e,t,i){"add"===i?this._relationChanges[e].add.push(t):this._relationChanges[e].remove.push(t)},removeGroupFromArray:function(e,t,i){"add"===i?this._relationChanges[e].add.splice(t,1):this._relationChanges[e].remove.splice(t,1),0===this._relationChanges[e].add.length&&0===this._relationChanges[e].remove.length&&this._relationChanges.splice(e,1)},queryTaskLaunch:function(e,t,i){return e===this._panel&&t===this._category.id&&i===this._id}},WS.extend("ProjectRightsTask","Task"),WS.PublishTask=function(e,t,i){WS.WorkbenchBaseTask.call(this,e,t),this._pointcloud=i,this._description=[{caption:"T_PUBLISH_PROJECT",description:"TD_PUBLISH_PROJECT",icon:WS.Icons.TaskSection.check,widget:'<betahint>{{ "FE_BETA_PUBLISH" | i18n }}</betahint><checkbox ng-show="hasContent" target="input.checked" source="input.checked" name="{{\'T_PUBLISH_PROJECT\' | i18n}}"></checkbox><alert type="error" ng-show="!hasContent">{{ "EM_NO_DATA" | i18n }}</alert>',completeCondition:"input.checked && hasContent"}]},WS.PublishTask.prototype={setup:function(e){WS.WorkbenchBaseTask.prototype.setup.call(this,e);e.input.project=void 0,e.input.checked=!1,e.hasContent=!1,this._pointcloud.getAll().then(function(t){if(0===t.length)return void(e.hasContent=!1);
for(var i=t.length,n=0;i>n;++n){var o=t[n];if(o._state===WS.PointCloud.State.COMPLETE&&(o._readPublic||0<o._readGroups.length))return void(e.hasContent=!0)}e.hasContent=!1}).done()},execute:function(e){var t=e.project;return t._changes._state=WS.Project.State.PUBLISHED,t.update()},teardown:function(e){!this._result._abortedByLaunchTask&&e&&(this._result._followupTask={panel:"default",category:"projectselector"})}},WS.extend("PublishTask","WorkbenchBaseTask"),WS.DelEntitiesTask=function(e,t,i,n,o){WS.WorkbenchBaseTask.call(this,e,t),this._locale=i,this._entityCPE=n,this._entityPC=o,this._pcMap={},this._locks={},this._cpesDeletable=[],this._pcsDeletable=[];var r={pro:{blockvisible:{scan:!1,cpe:!0,pc:!1,lpc:!0},blockcollapsed:{scan:!1,cpe:!1,pc:!1,lpc:!1}}};this._description=[{caption:"TC_DELETE_OBJECT",description:"FE_SEL_OBJS",selectPageClass:"processing",icon:WS.Icons.TaskSection.selectbox,pageConfiguration:F.mergeObjects({selection:"entitycpe,entitypc,pointcloud"},r),select:"EntityCPE,EntityPC,PointCloud",selection:"input.cpes,input.pcs,input.lpcs",selectionEntry:"{{entry._displayName}}",completeCondition:"hasDeletable()"}]},WS.DelEntitiesTask.prototype={setup:function(e){WS.WorkbenchBaseTask.prototype.setup.call(this,e);var t=this,i=this._project.getCurrent();this._entityCPE.getLocks(i).then(function(e){t._locks=e}),this._entityPC.getAll({project:i}).then(function(e){for(var i=e.length,n=0;i>n;++n)t._pcMap[e[n]._UUID]=e[n]}),e.alerts={EntityCPE:{},EntityPC:{}},e.$watch('input.cpes.length + "," + input.pcs.length',function(){t.determineDeletableEntities()}),e.hasDeletable=function(){return 1<=t._cpesDeletable.length+t._pcsDeletable.length+e.input.lpcs.length}},determineDeletableEntities:function(){this._cpesDeletable=[],this._pcsDeletable=[];for(var e={},t=this.$scope.input.pcs,i=t.length,n=0;i>n;++n){var o=t[n];o._state===WS.Entity.State.PROCESSING?this.$scope.alerts.EntityPC[o._UUID]=this._locale.translate("FE_DEL_PROC"):(delete this.$scope.alerts.EntityPC[o._UUID],e[o._UUID]=o,this._pcsDeletable.push(o))}for(var r=this.$scope.input.cpes,a=r.length,s=0;a>s;++s){var c=r[s],l=this._locks[c._UUID],h="";if(void 0!==l)for(var d=l.length,u=0;d>u;++u){var p=l[u];e[p]||(h+=(""===h?"":", ")+'"'+this._pcMap[p]._displayName+'"')}""!==h?this.$scope.alerts.EntityCPE[c._UUID]=this._locale.translate("FE_DEL_OTHERS")+" "+h+".":(delete this.$scope.alerts.EntityCPE[c._UUID],this._cpesDeletable.push(c))}},execute:function(e){var t=this,i=this._pcsDeletable.concat(e.lpcs);return Q.allSettled(i.map(function(e){return e.remove()})).then(function(e){return Q.allSettled(t._cpesDeletable.map(function(e){return e.remove()})).then(function(t){var i=[],n=e.concat(t);return n.forEach(function(e){"rejected"===e.state&&i.push(e.reason)}),new F.TaskResult(void 0,void 0,void 0,i)})})},queryTaskLaunch:function(e,t,i){return e===this._panel&&t===this._category.id&&(!i||"delentities"===i)}},WS.extend("DelEntitiesTask","WorkbenchBaseTask"),WS.EditProjectTask=function(e,t,i,n,o){WS.ProjectTaskBase.call(this,e,t),this._rootService=i,this._root=void 0,this._unit=n,this._alert=o,this._description=[{caption:"TC_EDIT_PROJECT_NAME",optional:!0,widget:'<edit target="input.project._changes._displayName" source="input.project._displayName" validation="validateDisplayName" focus-me="section._active"></edit>',icon:WS.Icons.TaskSection.textinput,completeCondition:"!validateDisplayName(input.project._changes._displayName)"},this.getFeatureStep(),this.getDescStep(),this.getLocationStep(),this.getImageStep(),{caption:"TC_TRAFO_CUSTOM",description:"TD_TRAFO_CUSTOM",optional:!0,widget:'<checkbox target="input.useCS" source="input.useCS" name="{{\'FE_USE_TRAFO_CUSTOM\' | i18n}}"></checkbox><label class="ws_lblTask">{{\'FE_ENTER_NAME\' | i18n}}:</label><edit disabled="!input.useCS" target="input.project._changes._trafoName" source="input.project._trafoName" validation="validateTrafoName"></edit><label class="ws_lblTask">X:</label><unitedit disabled="!input.useCS" class="f_textInline" unitclass="unitclass" unit="unit" model="input.csX" precision="6"></unitedit><label class="ws_lblTask">Y:</label><unitedit disabled="!input.useCS" class="f_textInline" unitclass="unitclass" unit="unit" model="input.csY" precision="6"></unitedit><label class="ws_lblTask">Z:</label><unitedit disabled="!input.useCS" class="f_textInline" unitclass="unitclass" unit="unit" model="input.csZ" precision="6"></unitedit><label class="ws_lblTask">{{\'FE_ROT_X\' | i18n}}:</label><unitedit disabled="!input.useCS" class="f_textInline" unitclass="angleunitclass" unit="areaunit" model="input.csRX" precision="9"></unitedit><label class="ws_lblTask">{{\'FE_ROT_Y\' | i18n}}:</label><unitedit disabled="!input.useCS" class="f_textInline" unitclass="angleunitclass" unit="areaunit" model="input.csRY" precision="9"></unitedit><label class="ws_lblTask">{{\'FE_ROT_Z\' | i18n}}:</label><unitedit disabled="!input.useCS" class="f_textInline" unitclass="angleunitclass" unit="areaunit" model="input.csRZ" precision="9"></unitedit><button ng-disabled="!input.useCS" ng-click="useRootTrafo()" class="btn btn-default" style="margin-top: 10px;" title="{{\'FE_USE_WS_TRAFO\' | i18n}}">{{\'FE_DEFAULT\' | i18n}}</button>',icon:WS.Icons.TaskSection.point3d,completeCondition:"isCSInputOkay()"}]},WS.EditProjectTask.prototype={setup:function(e){WS.ProjectTaskBase.prototype.setup.call(this,e);var t=this;e.unit=this._unit.getLengthUnit(),e.areaunit=this._unit.getAngleUnit(),e.angleunitclass=F.AngleUnit,e.input.useCS=!1,e.input.csX=0,e.input.csY=0,e.input.csZ=0,e.input.csRX=0,e.input.csRY=0,e.input.csRZ=0,t._unbindWatch=e.$watch("input.project",function(i){i&&(i.discardChanges(),t.trigger("editObject",[i,"editproject"]),t._rootService.getAll().then(function(i){t._root=i[0],e.input.useCS=void 0!==e.input.project._trafo,t.initTrafo()}))}),e.validateTrafoName=function(e){return 20<e.length||40<F.byteLength(e)?"EM_NAME_TOO_LONG_20":void 0},e.useRootTrafo=function(){t.useTrafo(t._root._trafoGlobal)},e.isCSInputOkay=function(){var t=e.input;return!t.useCS||void 0===e.validateTrafoName(t.project._changes._trafoName)&&void 0===F.validateNumber(t.csX)&&void 0===F.validateNumber(t.csY)&&void 0===F.validateNumber(t.csZ)&&void 0===F.validateNumber(t.csRX)&&void 0===F.validateNumber(t.csRY)&&void 0===F.validateNumber(t.csRZ)},this.provideMalePlug("ObjectEdit",["editObject"]);var i=this._connectorService;i.connect(this.getMalePlug("ObjectEdit"),i.getPlugModule("pi"))},execute:function(e){var t=this,i=e.project;t._unbindWatch();var n;e.useCS&&(n=mat4.identity(),mat4.setTranslation(n,[e.csX,e.csY,e.csZ]),mat4.rotateZ(n,e.csRZ),mat4.rotateY(n,e.csRY),mat4.rotateX(n,e.csRX));var o=!i._trafo&&n||i._trafo&&!n||i._trafo&&n&&!mat4.equal(i._trafo,n);o&&(i._changes._trafo=n),e.useCS||""===i._trafoName||(i._changes._trafoName="");var r=i._changes._newImage,a=r?i.updateImage(r.type,r.data):Q.resolve();return a.then(function(){return r&&(i._changes._image=""+Date.now()),i.update().then(function(e){return o&&(t._alert.message("FE_PAGE_RELOAD"),setTimeout(function(){location.reload(!0)},1e3)),e})},function(e){delete i._changes._newImage,delete i._changes._image;var t=e.message;return"EXCEPTION_MESSAGE_INVALID_REQUEST_BODY_WRONG_CONTENT_TYPE"===t&&(t="EM_IMAGE_DECODE"),new F.TaskResult([t],[],!0)})},initTrafo:function(){this.$scope.input.project._trafo?this.useTrafo(this.$scope.input.project._trafo):this.$scope.useRootTrafo()},useTrafo:function(e){var t=this.$scope.input,i=mat4.getTranslation(e);t.csX=i[0],t.csY=i[1],t.csZ=i[2];var n=[0,0,0];mat4.getXYZRotation(e,n,[0,0,0]),t.csRX=n[0],t.csRY=n[1],t.csRZ=n[2]}},WS.extend("EditProjectTask","ProjectTaskBase"),WS.DomainSettingsTask=function(e,t,i){WS.Task.call(this,e),this._localeService=t,this._fileService=i,this._description=[{caption:"TC_DOMAIN_SETTINGS",optional:!0,description:"TD_DOMAIN_SETTINGS",selectPageClass:"domainsettings",female:"ObjectEdit",pinBinding:"editObject(input.data)",widget:'<p ng-if="hasUnsavedChanges()"><strong>{{"TD_CHANGES"|i18n}}:</strong></p><ul><li ng-if="isLogoChanged()">{{formatLogo()}}</li><li ng-if="isOpacityChanged()">{{formatOpacity()}}</li><li ng-repeat="(key, value) in getChanges()" ng-if="isChangeForDisplay(key)">{{translateKey(key)}}: {{translateValue(value)}}</li></ul>',icon:WS.Icons.TaskSection.configure}]},WS.DomainSettingsTask.prototype={setup:function(e){this.$scope=e;var t=this;e.getData=function(){var t=e.input?e.input.data:void 0;return t},e.getSettings=function(){var t=e.getData(),i=t?t.settings:void 0;return i},e.getChanges=function(){var t=e.getSettings(),i=t?t._changes:void 0;return i},e.isChangeForDisplay=function(e){return"_customerLogoFileType"!==e&&"_customerLogoOpacity"!==e&&"_customerLogoRevision"!==e&&"_incrementCustomerLogoRevision"!==e},e.hasUnsavedChanges=function(){if(e.isLogoChanged()||e.isOpacityChanged())return!0;var t=e.getChanges();return t instanceof Object&&0<Object.keys(t).length},e.translateKey=function(e){var i=t._localeService;switch(e){case"_language":return i.translate("FE_LANGUAGE");case"_lengthUnit":return i.translate("FE_UNITS");case"_areaUnit":return i.translate("FE_AREA_UNIT");case"_angleUnit":return i.translate("FE_ANGLE_UNIT");case"_distState":return i.translate("FE_DIST_APPEARANCE");case"_areaState":return i.translate("FE_AREA_APPEARANCE");case"_persistMeasurements":return i.translate("FE_PERSIST_MMS");case"_overrideLengthUnit":return i.translate("FE_UNITS")+": "+i.translate("FE_OVERRIDE_USER_SETTING");case"_overrideAreaUnit":return i.translate("FE_AREA_UNIT")+": "+i.translate("FE_OVERRIDE_USER_SETTING");case"_overrideAngleUnit":return i.translate("FE_ANGLE_UNIT")+": "+i.translate("FE_OVERRIDE_USER_SETTING");case"_overrideDistState":return i.translate("FE_DIST_APPEARANCE")+": "+i.translate("FE_OVERRIDE_USER_SETTING");case"_overrideAreaState":return i.translate("FE_AREA_APPEARANCE")+": "+i.translate("FE_OVERRIDE_USER_SETTING");case"_overridePersistMeasurements":return i.translate("FE_PERSIST_MMS")+": "+i.translate("FE_OVERRIDE_USER_SETTING")}return""},e.translateValue=function(e){for(var i=t._localeService.getLanguages(),n=0,o=i.length;o>n;n++)if(i[n].id===e)return i[n].caption;var r=t._localeService;switch(e){case"gon":return r.translate("FE_GON");case"deg":return r.translate("FE_DEGREE");case"segment":return r.translate("FE_SHOW_SEGMENTS");case"axis":return r.translate("FE_SHOW_AXES");case"angle":return r.translate("FE_SHOW_ANGLES");case"hide":return r.translate("FE_HIDE_DISTANCE_LABELS");case"show":return r.translate("FE_SHOW_DISTANCE_LABELS");case!0:return r.translate("FE_ENABLED");case!1:return r.translate("FE_DISABLED")}return e},e.isLogoChanged=function(){var t=e.getData();return t&&(t.logoChangedToNone||t.logoChangedToNew)},e.isOpacityChanged=function(){var t=e.getChanges();return t&&t._customerLogoOpacity!==e.getSettings()._customerLogoOpacity},e.formatLogo=function(){var i=e.getData();return i?i.logoChangedToNone?t._localeService.translate("FE_LOGO")+": "+t._localeService.translate("FE_NONE"):i.logoChangedToNew&&i.newLogoFileName?t._localeService.translate("FE_LOGO")+": "+i.newLogoFileName:"":""},e.formatOpacity=function(){var i=e.getChanges(),n=i?i._customerLogoOpacity:void 0;return void 0===n||null===n?"":t._localeService.translate("FE_LOGO_OPACITY")+": "+n+"%"}},execute:function(){var e=Q.defer(),t=this.$scope.getData(),i=this.$scope.getSettings();if(i){var n=this,o=i._changes._customerLogoFileType;i.hasCustomerLogo()&&t.logoChangedToNone?this._fileService.deleteCustomerLogos().then(function(){n.updateSettings(i,e,!0)}).fail(function(){n.updateSettings(i,e,!0)}).done():t.logoChangedToNew&&t.newLogoData?this._fileService.uploadCustomerLogo(o,t.newLogoData).then(function(){n.updateSettings(i,e,!0)}).fail(function(t){e.reject(t)}).done():n.updateSettings(i,e,!1)}else e.resolve(!1);return e.promise},updateSettings:function(e,t,i){i&&e.incrementCustomerLogoRevision(),e.update().then(function(e){t.resolve(e)}).fail(function(e){t.reject(e)}).done()},teardown:function(){this._result._abortedByLaunchTask||(this._result._followupTask={panel:"admin",category:"dashboard"})},queryTaskLaunch:function(e,t,i){return e===this._panel&&t===this._category.id&&i===this._id}},WS.extend("DomainSettingsTask","Task"),WS.AdminMapSettingsTask=function(e,t){WS.WorkbenchBaseTask.call(this,e,t),this._description=[{caption:"TC_EDIT_SETTINGS",description:"TD_CONFIG_MAP",optional:!0,selectPageClass:"adminmapsettings",female:"ObjectEdit",pinBinding:"editObject(input.data)",icon:WS.Icons.TaskSection.configure,completeCondition:"!hasViolatingLayers()",widget:'<div ng-if="0 < getChangedLayers().length"><strong>{{"TD_CHANGES"|i18n}}:</strong></div><div ng-repeat="layer in getChangedLayers()"><div ng-class="{f_textError: isViolatingLayer(layer)}">{{layer._displayName}}:</div><ul><li ng-if="layer._displayName !== layer._changes._displayName" ng-class="{f_textError: isViolatingLayer(layer)}">{{"FE_NAME"|i18n}}: {{layer._displayName}} &#8594; {{layer._changes._displayName}}</li><li ng-if="layer._opacity !== layer._changes._opacity">{{"FE_OPACITY"|i18n}}: {{layer._opacity}}% &#8594; {{layer._changes._opacity}}%</li><li ng-if="isOrderChanged(layer)">{{"FE_ORDER"|i18n}}: {{getOldOrder(layer)}} &#8594; {{getNewOrder(layer)}}</li></ul></div><alert ng-if="hasViolatingLayers()" type="error">{{"EM_MAP_LAYER_NAME"|i18n}}</alert><alert type="info">{{"FE_LAYER_ORDER_INFO"|i18n}}</alert>'}]},WS.AdminMapSettingsTask.prototype={setup:function(e){WS.WorkbenchBaseTask.prototype.setup.call(this,e),this.$scope=e;var t=this;e.getData=function(){var t=e.input?e.input.data:void 0;return t},e.getMapObject=function(){var t=e.getData(),i=t?t.mapObject:void 0;return i},e.getMapLayers=function(){var t=e.getData(),i=t?t.mapLayers:void 0;return i},e.getChangedLayers=function(){var t=[],i=[],n=[],o=e.getMapLayers();if(o){for(var r=0,a=o.length;a>r;++r){var s=o[r];n[s._UUID]=s,s.hasUnsavedChanges()&&(i[s._UUID]=s,t.push(s))}var c=e.getMapObject();if(c&&c._layerOrder!==c._changes._layerOrder)for(var l=c._layerOrder,h=c._changes._layerOrder,d=0,u=l.length;u>d;++d){var p=l[d];i[p]||p===h[d]||t.push(n[p])}}return t},e.isOrderChanged=function(t){var i=e.getMapObject();if(!i||i._layerOrder===i._changes._layerOrder)return!1;var n=i.getOrderOfLayer(t._UUID,!1),o=i.getOrderOfLayer(t._UUID,!0);return n!==o},e.getOldOrder=function(t){var i=e.getMapObject();return i?i.getOrderOfLayer(t._UUID,!1)+1:0},e.getNewOrder=function(t){var i=e.getMapObject();return i?i.getOrderOfLayer(t._UUID,!0)+1:0},e.getViolatingLayers=function(){var t=e.getData(),i=t?t.violatingLayers:void 0;return i},e.hasViolatingLayers=function(){var t=e.getViolatingLayers();for(var i in t)if(t.hasOwnProperty(i))return!0;return!1},e.isViolatingLayer=function(t){var i=e.getViolatingLayers();return i?void 0!==i[t._UUID]:!1},this.$scope.$watch("input.project",function(e){t.trigger("editObject",[e])}),this.provideMalePlug("ObjectEdit",["editObject"]);var i=this._connectorService;i.connect(this.getMalePlug("ObjectEdit"),i.getPlugModule("amsp"))},execute:function(){var e=this.$scope.getMapObject(),t=this.$scope.getMapLayers(),i={root:""},n=[];if(e&&e.hasUnsavedChanges()&&n.push(e.update(i)),t)for(var o=0,r=t.length;r>o;++o)t[o].hasUnsavedChanges()&&n.push(t[o].update(i));return Q.allSettled(n).then(function(e){var t={};return e.forEach(function(e){"rejected"===e.state&&(t[e.reason.message]=!0)}),new WS.TaskResult(Object.keys(t))})},queryTaskLaunch:function(e,t,i){return e===this._panel&&t===this._category.id&&i===this._id}},WS.extend("AdminMapSettingsTask","WorkbenchBaseTask"),WS.LogoFileService=function(e,t){this.$http=e,this._error=t},WS.LogoFileService.prototype={uploadCustomerLogo:function(e,t){var i=Q.defer(),n=WS.getMimeType(e);if(void 0===n)return i.reject(new Error("EM_FILE_TYPE")),i.promise;var o="/data/domain/customer-logo/"+e;return this.$http({method:"POST",url:o,data:t,headers:{"Content-Type":n}}).success(function(){i.resolve(!0)}).error(this._error.httpHandler(i)),i.promise},deleteCustomerLogos:function(){var e=Q.defer();return this.$http({method:"DELETE",url:"/data/domain/customer-logo"}).success(function(){e.resolve(!0)}).error(this._error.httpHandler(e)),e.promise}},WS.extend("LogoFileService"),WS.AdminUserService=function(e,t,i,n,o,r){WS.UserService.call(this,e,t,i,n,o,r)},WS.AdminUserService.prototype={removeUsersFromDomain:function(e){var t={Action:"remove",Users:e.map(function(e){return e.getUsername()})},i=this;return this.arrayAction(t).then(function(e){i.updateInternalMultiple(e)})},addUsersToDomain:function(e){var t={Action:"add",Users:e},i=this;return this.arrayAction(t).then(function(e){i.updateInternalMultiple(e)})},getRelatedGroups:function(e){var t;if(null===e._groupids){var i={};i["with"]="groupids",t=this.getAll(i).then(function(){return F.DI().getService("group").getByIDs(e._groupids,{},!0)})}else t=F.DI().getService("group").getByIDs(e._groupids,{},!0);return t.then(function(t){return e._groups=t,t})},getRelatedRoles:function(e){var t;if(null===e._roleids){var i={};i["with"]="roleids",t=this.getAll(i).then(function(){return F.DI().getService("role").getByIDs(e._roleids,{},!0)})}else t=F.DI().getService("role").getByIDs(e._roleids,{},!0);return t.then(function(t){return e._roles=t,t})},linkWithGroup:function(e,t,i){e._groupids=e._groupids||[],F.addUnique(e._groupids,t.getID()),F.addUnique(e._groups,t),i||F.DI().getService("group").linkWithUser(t,e,!0)},unlinkWithGroup:function(e,t,i){e._groupids=e._groupids||[],F.removeFirst(e._groupids,t.getID()),F.removeFirst(e._groups,t),i||F.DI().getService("group").unlinkWithUser(t,e,!0)},linkWithRole:function(e,t,i){e._roleids=e._roleids||[],F.addUnique(e._roleids,t.getID()),F.addUnique(e._roles,t),i||F.DI().getService("role").linkWithUser(t,e,!0)},unlinkWithRole:function(e,t,i){e._roleids=e._roleids||[],F.removeFirst(e._roleids,t.getID()),F.removeFirst(e._roles,t),i||F.DI().getService("role").unlinkWithUser(t,e,!0)}},WS.extend("AdminUserService","UserService"),WS.AdminService=function(e,t,i,n,o){WS.CRUDService.call(this,"Admin",void 0,"/admin/rule",{},e,t,i,n,o)},WS.AdminService.prototype={removeRelatedGroups:function(e,t){var i={ProjectName:e._name,Public:!1,Groups:t.map(function(e){return e.getID()})},n={Rule:"ProjectVisibility",Action:"remove",Params:i};return this.action(n)},addRelatedGroups:function(e,t){var i={ProjectName:e._name,Public:!1,Groups:t.map(function(e){return e.getID()})},n={Rule:"ProjectVisibility",Action:"add",Params:i};return this.action(n)}},WS.extend("AdminService","CRUDService"),WS.GroupService=function(e,t,i,n,o,r,a){WS.CRUDService.call(this,"Group",WS.Group,"/admin/group",{},e,t,n,o,a);var s=this;i.subscribe("logout",function(){s.removeInternal()}),this._user=r},WS.GroupService.prototype={addRelatedUsers:function(e,t){var i={Action:"add",Users:t.map(function(e){return e.getID()})},n=this;return this.entityAction(e,i).then(function(){t.forEach(function(t){n.linkWithUser(e,t)})})},removeRelatedUsers:function(e,t){var i={Action:"remove",Users:t.map(function(e){return e.getID()})},n=this;return this.entityAction(e,i).then(function(){t.forEach(function(t){n.unlinkWithUser(e,t)})})},getRelatedUsers:function(e){if(null===e._userids){var t={},i=this;return t["with"]="userids",this.getAll(t).then(function(){return i._user.getByIDs(e._userids,{},!0).then(function(t){return e._users=t,t})})}return this._user.getByIDs(e._userids,{},!0).then(function(t){return e._users=t,t})},validateGroupName:function(e){return e.length<2?"EM_GROUPNAME_TOOSHORT":e.length>40?"EM_GROUPNAME_TOOLONG":/^[a-z A-Z 0-9]+$/.test(e)?void 0:"EM_GROUP_ONLY_CHARACTERS"},validateGroupDescription:function(e){return e&&e.length>1024?"EM_INVALID_GROUP_DESCRIPTION":void 0},linkWithUser:function(e,t,i){e._userids=e._userids||[],F.addUnique(e._userids,t.getID()),F.addUnique(e._users,t),i||this._user.linkWithGroup(t,e,!0)},unlinkWithUser:function(e,t,i){F.removeFirst(e._userids,t.getID()),F.removeFirst(e._users,t),i||this._user.unlinkWithGroup(t,e,!0)}},WS.extend("GroupService","CRUDService"),WS.RoleService=function(e,t,i,n,o,r){WS.CRUDService.call(this,"Role",WS.Role,"/admin/role",{},e,t,n,o,r);var a=this;i.subscribe("logout",function(){a.removeInternal()})},WS.RoleService.prototype={addRelatedUsers:function(e,t){var i={Action:"grant",Users:t.map(function(e){return e.getID()})},n=this;return this.entityAction(e,i).then(function(){t.forEach(function(t){n.linkWithUser(e,t)})})},removeRelatedUsers:function(e,t){var i={Action:"revoke",Users:t.map(function(e){return e.getID()})},n=this;return this.entityAction(e,i).then(function(){t.forEach(function(t){n.unlinkWithUser(e,t)})})},getRelatedUsers:function(e){if(null===e._userids){var t={};return t["with"]="userids",this.getAll(t).then(function(){return F.DI().getService("user").getByIDs(e._userids,{},!0).then(function(t){return e._users=t,t})})}return F.DI().getService("user").getByIDs(e._userids,{},!0).then(function(t){return e._users=t,t})},linkWithUser:function(e,t,i){e._userids=e._userids||[],F.addUnique(e._userids,t.getID()),F.addUnique(e._users,t),i||F.DI().getService("user").linkWithRole(t,e,!0)},unlinkWithUser:function(e,t,i){e._userids=e._userids||[],F.removeFirst(e._userids,t.getID()),F.removeFirst(e._users,t),i||F.DI().getService("user").unlinkWithRole(t,e,!0)}},WS.extend("RoleService","CRUDService"),WS.Role=function(e){WS.CRUDObject.call(this,e),this._ID=void 0,this._name="",this._description="",this._img="",this._userids=null,this._users=[]},WS.Role.prototype={getID:function(){return this._ID},matchesJson:function(e){return this._ID===e.Id},getUsers:function(){return this._service.getRelatedUsers(this)},addUsers:function(e){return this._service.addRelatedUsers(this,e)},removeUsers:function(e){return this._service.removeRelatedUsers(this,e)},readJson:function(e){this._ID=e.Id,this._name=e.Name,this._description=e.Description,null!==e.UserIds&&(this._userids=e.UserIds)},writeJson:function(){var e={};return e.Class="Role",e.Id=this._ID,e.Name=this._name,e.Description=this._description,e}},WS.extend("Role","CRUDObject"),WS.Role.Id={PROJECT_MANAGER:1,DOMAIN_ADMIN:2,USER:3,UPLOADER:4},WS.Group=function(e){WS.CRUDObject.call(this,e),this._service=e,this._ID=void 0,this._name="",this._description="",this._img=WS.imgUrl("icons/im/taskbar/groups/main256x256.png"),this._userids=null,this._users=[]},WS.Group.prototype={getID:function(){return this._ID},matchesJson:function(e){return this._ID===e.Id},getUsers:function(){return this._service.getRelatedUsers(this)},addUsers:function(e){return this._service.addRelatedUsers(this,e)},removeUsers:function(e){return this._service.removeRelatedUsers(this,e)},readJson:function(e){this._ID=e.Id,this._name=e.Name,this._description=e.Description,null!==e.UserIds&&(this._userids=e.UserIds)},writeJson:function(){var e={};return e.Class="Group",e.Id=this._ID,e.Name=this._name,e.Description=this._description,e}},WS.extend("Group","CRUDObject"),angular.module("ws.admin",[]),F.DI().redefineService("user",WS.AdminUserService,"@serializer","@error","@login","@selection","@plug","$resource"),F.DI().registerService("group",WS.GroupService,"@serializer","@error","@login","@selection","@plug","@user","$resource"),F.DI().registerService("role",WS.RoleService,"@serializer","@error","@login","@selection","@plug","$resource"),F.DI().registerService("admin",WS.AdminService,"@serializer","@error","@selection","@plug","$resource"),F.DI().registerService("logofile",WS.LogoFileService,"$http","@error"),F.DI().config("@serializer","@group","@role",WS.adminConfigSerializer=function(e,t,i){e.registerClass("Group",function(){return t.getNew()}),e.registerClass("Role",function(){return i.getNew()})}),F.DI().config("@task",WS.adminConfigTask=function(e){e.registerTaskFactory("admin","users","adduser",WS.AddUserTask,"@user","@plug"),e.registerTaskFactory("admin","users","removeuser",WS.RemoveUserTask,"@plug","@user"),e.registerTaskFactory("admin","groups","addgroup",WS.CreateGroupTask,"@plug","@group","@locale"),e.registerTaskFactory("admin","groups","editgroup",WS.EditGroupTask,"@plug","@group","@locale"),e.registerTaskFactory("admin","groups","deletegroup",WS.DeleteGroupTask,"@plug","@group"),e.registerTaskFactory("admin","groups","addusertogroup",WS.AddUserToGroupTask,"@plug","@user"),e.registerTaskFactory("admin","groups","removeuserfromgroup",WS.RemoveUserFromGroupTask,"@plug"),e.registerTaskFactory("admin","roles","grantrole",WS.GrantRoleTask,"@plug"),e.registerTaskFactory("admin","roles","revokerole",WS.RevokeRoleTask,"@plug"),e.registerTaskFactory("admin","projectmanagement","createproject",WS.CreateProjectTask,"@plug","@project"),e.registerTaskFactory("admin","projectmanagement","delete",WS.DeleteProjectTask,"@plug","@project"),e.registerTaskFactory("admin","projectmanagement","rights",WS.ProjectRightsTask,"@project","@plug","@locale"),e.registerTaskFactory("admin","adminsettings","domainsettings",WS.DomainSettingsTask,"@plug","@locale","@logofile"),e.registerTaskFactory("workbench","processing","createptclouds",WS.CreatePointCloudsTask,"@plug","@project","@scan","@jobqueue","@transaction","@entitypc","@entitycpe","@locale"),e.registerTaskFactory("workbench","processing","delentities",WS.DelEntitiesTask,"@plug","@project","@locale","@entitycpe","@entitypc"),e.registerTaskFactory("workbench","publish","editmetadata",WS.EditProjectTask,"@plug","@project","@root","@unit","@alert"),e.registerTaskFactory("workbench","publish","adminmapsettings",WS.AdminMapSettingsTask,"@plug","@project"),e.registerTaskFactory("workbench","publish","publish",WS.PublishTask,"@plug","@project","@pointcloud")}),angular.module("ws.admin").filter("selected",function(){return function(e){return e.filter(function(e){return e._selected})}}),angular.module("ws.admin").filter("adminrole",function(){return function(e){return e.filter(function(e){return e._roles.admin})}}),angular.module("ws.admin").filter("superuserrole",function(){return function(e){return e.filter(function(e){return e._roles.superuser})}}),angular.module("ws.admin").filter("userrole",function(){return function(e){return e.filter(function(e){return e._roles.user})}}),angular.module("ws.admin").filter("adminfilter",function(){return function(e,t){return e.filter(function(e){return t?e._name&&-1!==e._name.toLowerCase().indexOf(t.toLowerCase())||e._description&&-1!==e._description.toLowerCase().indexOf(t.toLowerCase())?e:void 0:e})}}),WS.getMimeType=function(e){switch(e){case"png":return"image/png";case"jpg":return"image/jpeg";case"gif":return"image/gif";case"tif":return"image/tiff";case"cpe":return"application/x-scene-cpe";case"txt":return"text/plain"}return void 0},WS.getFileType=function(e){switch(e){case"image/png":return"png";case"image/jpeg":case"image/jpg":return"jpg";case"image/gif":return"gif";case"image/tiff":return"tif"}return void 0},F.DI().config("@task","@project",WS.unpublishedValidator=function(e,t){e.addValidator("unpublished",function(){return t.getCurrentProject().then(function(e){return e._state===WS.Project.State.DRAFT?void 0:"FE_ALREADY_PUBLISHED"},function(){return"EM_NO_PROJECT"})})}),F.DI().config("@task","@pointcloud",WS.publishableValidator=function(e,t){e.addValidator("publishable",function(){return t.getAll().then(function(e){if(0===e.length)return"EM_NO_DATA";for(var t=0;t<e.length;++t){var i=e[t];if(i._state===WS.PointCloud.State.COMPLETE&&(i._readPublic||0<i._readGroups.length))return}return"EM_NO_DATA"})})}),WS.Job=function(e){WS.CRUDObject.call(this,e),this._class="Job",this._version=void 0,this._jobID=void 0,this._type=void 0,this._family=void 0,this._owner=void 0,this._domain=void 0,this._project=void 0,this._object=void 0,this._priority=void 0,this._weight=void 0,this._billingId=void 0,this._state=void 0,this._error=void 0,this._creationTime=void 0,this._earliestTime=void 0,this._latestTime=void 0,this._startTime=void 0,this._endTime=void 0,this._workerID=void 0,this._workerLock=void 0},WS.Job.prototype={getID:function(){return this._jobID},matchesJson:function(e){return this._jobID===e.JobID},readJson:function(e){this._version=e.Version,this._jobID=e.JobID,this._queue=e.Queue,this._family=e.Family,this._owner=e.Owner,this._domain=e.Domain,this._project=e.Project,this._object=e.Object,this._priority=e.Priority,this._weight=e.Weight,this._billingId=e.BillingID,this._state=e.State,this._error=e.Error,this._creationTime=e.CreationTime,this._earliestTime=e.EarliestTime,this._latestTime=e.LatestTime,this._startTime=e.StartTime,this._endTime=e.EndTime,this._workerID=e.WorkerID,this._workerLock=e.WorkerLock},writeJson:function(){var e={};return e.Class=this._class,e.Version=this._version,e.JobID=this._jobID,e.Queue=this._queue,e.Family=this._family,e.Owner=this._owner,e.Domain=this._domain,e.Project=this._project,e.Object=this._object,e.Priority=this._priority,e.Weight=this._weight,e.BillingID=this._billingId,e.State=this._state,e.Error=this._error,e.CreationTime=this._creationTime,e.EarliestTime=this._earliestTime,e.LatestTime=this._latestTime,e.StartTime=this._startTime,e.EndTime=this._endTime,e.WorkerID=this._workerID,e.WorkerLock=this._workerLock,e},hasJobResultUrl:function(){return"orthophoto"===this._queue},getJobResultUrl:function(){return"orthophoto"===this._queue?"/?v=op&t=p:default,c:object,m:t&op=op1&op1=t:orthophoto,u:"+this._object+"&p="+this._project:void 0}},WS.extend("Job","CRUDObject"),WS.Job.State={PENDING:"pending",RUNNING:"running",ABORTED:"aborted",COMPLETE:"complete",ERROR:"error"},WS.QueueInfo=function(){this._class="QueueInfo",this._queue=void 0,this._amount=void 0,this._sumWeight=void 0,this._minWeight=void 0,this._maxWeight=void 0,this._avgWeight=void 0},WS.QueueInfo.prototype={getID:function(){return this._queue},readJson:function(e){this._queue=e.Queue,this._amount=e.Amount,this._sumWeight=e.SumWeight,this._minWeight=e.MinWeight,this._maxWeight=e.MaxWeight,this._avgWeight=e.AvgWeight},summarizeFromJson:function(e){var t=this;this._queue=void 0,this._amount=0,this._sumWeight=0,this._minWeight=0,this._maxWeight=Number.POSITIVE_INFINITY,e.forEach(function(e){t._amount+=e.Amount,t._sumWeight+=e.SumWeight,t._minWeight=Math.min(t._minWeight,e.MinWeight),t._maxWeight=Math.max(t._maxWeight,e.MaxWeight)}),this._avgWeight=this._amount?this._sumWeight/this._amount:void 0}},WS.extend("QueueInfo"),WS.JobQueueService=function(e,t,i,n,o,r){this._login=i,WS.CRUDService.call(this,"Job",WS.Job,"/queue/monitor",{},e,t,n,o,r);var a=this;this.provideMalePlug("JobNotification",["updateJobStatus"]),i.subscribe("logout",function(){a.removeInternal()})},WS.JobQueueService.prototype={updateJobStatus:function(){this.trigger("updateJobStatus")},getAll:function(){return this.getDomainOrDie().then(F.proxy(function(e){return this.getAllForDomain(e)},this))},getAllForDomain:function(e){return WS.CRUDService.prototype.getAll.call(this,{domain:e})},getAggregated:function(e,t){return this.getDomainOrDie().then(F.proxy(function(i){return this.getAggregatedForDomain(i,e,t)},this))},getAggregatedForDomain:function(e,t,i){var n=Q.defer(),o={aggregated:1,domain:e,state:t?t.join(","):void 0};return this._restClient.readAll(o,function(e){if(i){var t=new WS.QueueInfo;t.summarizeFromJson(e),n.resolve(t)}else{var o=e.map(function(e){var t=new WS.QueueInfo;return t.readJson(e),t});n.resolve(o)}},this._error.restHandler(n)),n.promise},getDomainOrDie:function(){return this._login.getDomain().then(function(e){if(!e)throw F.authenticationException;return e})},determineProjectNames:function(e,t){for(var i={},n=0,o=e.length;o>n;++n){var r=e[n]._project;i[r]=r}for(var a=[],s=0,c=t.length;c>s;++s){var l=t[s]._name;a[l]=t[s]._displayName}var h=[],d={};for(var u in i){var p=a[u]?a[u]:"",_={id:u,displayName:p};h.push(_),d[u]=p}return h.sort(function(e,t){return""===e.displayName?""===t.displayName?e.id<t.id?-1:t.id<e.id?1:0:1:""===t.displayName?-1:e.displayName<t.displayName?-1:t.displayName<e.displayName?1:e.id<t.id?-1:t.id<e.id?1:0}),[h,d]}},WS.extend("JobQueueService","CRUDService"),F.DI().registerService("jobqueue",WS.JobQueueService,"@serializer","@error","@login","@selection","@plug","$resource"),F.DI().config("@plug",F.jobConfig=function(e){e.describe("JobNotification",["updateJobStatus"])
}),F.DI().config("@serializer","@jobqueue",WS.jobQueueConfigSerializer=function(e,t){e.registerClass("Job",function(){return t.getNew()})}),angular.module("ws.filter").filter("jobfilter",function(){return function(e,t,i){i||(i="");var n=t.toLowerCase().split(","),o=n.length;return e.filter(function(e){for(var t=(e._state||"").toLowerCase(),r=!1,a=0;o>a&&!r;a++)r=r||-1!==t.indexOf(n[a]);var s=""===i||i===e._project;return r&&s})}}),angular.module("ws.filter").filter("jobtype",function(){return function(e){switch(e){case"orthophoto":return"FE_ORTHOPHOTO";case"scanpointcloud":return"FE_SCAN_PC";case"projectpointcloud":return"FE_PROJECT_PC";default:return"FE_UNKNOWN"}}}),WS.CookieWarning=function(e,t,i){F.PlugController.call(this,e,t),e.visible=!i.getLocalStorageItem("cookies_ok"),e.ok=function(){i.setLocalStorageItem("cookies_ok",Date.now()),e.visible=!1}},WS.extend("CookieWarning","PlugController"),angular.module("ws.component.cookiewarning",[]),F.DI().registerController("cookiewarning",WS.CookieWarning,"@plug","@cookie"),angular.module("ws.component").directive("cookiewarning",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("cookiewarning"),restrict:"E",transclude:!0,template:'<section ng-if="visible" class="alertify alertify-alert" style="max-width: 440px; border-radius: 0px;"><div class="alertify-dialog"><article class="alertify-inner"><p class="alertify-message" style="text-align: left">{{"FE_COOKIE_INFO"|i18n}}</p><nav class="alertify-buttons"><button class="btn f_btnFontDark btn-success" ng-click="ok()">{{"FE_OK"|i18n}}</button></nav></article></div></section>'})}),WS.Transaction=function(e){F.CRUDObject.call(this,e),this._version=void 0,this._tid=void 0,this._domain=void 0,this._project=void 0,this._object=void 0,this._creationTime=void 0,this._chargeTime=void 0,this._initiator=void 0,this._action=void 0,this._credits=void 0,this._state=void 0,this._metadata=void 0,this._comment=void 0,this._projectCaption=void 0,this._actionCaption=void 0,this._userName=void 0,this._userFirstLast=void 0,this._dateCharged=void 0},WS.Transaction.prototype={readJson:function(e){this._version=e.Version,this._tid=e.TID,this._domain=e.Domain,this._project=e.Project,this._object=e.Object,this._creationTime=e.CreationTime,this._chargeTime=e.ChargeTime,this._initiator=e.Initiator,this._action=e.Action,this._credits=e.Credits,this._state=e.State,this._metadata=e.Metadata,this._comment=e.Comment,this._dateCharged=F.datestringToDateObj(this._chargeTime)}},WS.extend("Transaction","CRUDObject"),WS.Transaction.State={PENDING:"pending",CHARGED:"charged",ABORTED:"aborted"},WS.Transaction.Action={WS_PC_CREATE:"ws_pc_create",RECHARGE:"recharge"},WS.TransactionService=function(e,t,i,n){this._serializer=e,this._error=t,this._locale=i,this._restClient=n("/account/transaction/month/:period",{},{get:{method:"GET",params:{},isArray:!0}}),this._costsClient=n("/account/transaction/price",{},{post:{method:"POST",params:{}}})},WS.TransactionService.prototype={getNew:function(e){var t=new WS.Transaction(this);return e&&t.readJson(e),t},get:function(e,t,i){var n=this,o={period:e},r=Q.defer();return this._restClient.get(o,function(e){var o=n._serializer.read(e),a={};t&&t.forEach(function(e){a[e._name]=e});var s={};i&&i.forEach(function(e){s[e._ID]=e}),o.forEach(function(e){if(e._projectCaption=e._project&&a[e._project]?a[e._project]._displayName+" ("+e._project+")":e._project?" ("+e._project+")":"",e._initiator&&s[e._initiator]){var t=s[e._initiator].getName(),i=s[e._initiator]._username;e._userName=i,e._userFirstLast=0<t.length?t:""}else e._userName="",e._userFirstLast="";e._actionCaption=""===e._action?"":e._action===WS.Transaction.Action.WS_PC_CREATE?n._locale.translate("T_CREATE_3D"):e._action===WS.Transaction.Action.RECHARGE?n._locale.translate("FE_RECHARGE"):e._action}),r.resolve(o)},this._error.restHandler(r)),r.promise},calcCosts:function(e,t){var i=Q.defer(),n={BillingItems:{WS_PC_CREATE_PERPROJECT:e,WS_PC_CREATE_PERSCAN:t}};return this._costsClient.post({},n,function(e){i.resolve(e.Price)},this._error.restHandler(i)),i.promise}},WS.extend("TransactionService"),WS.DomainStats=function(){this._use={trafficOut:void 0,trafficIn:void 0,storage:void 0,storageLatest:void 0,detailStorage:[],storageByProject:{},detailTraffic:[],overTrafficOut:void 0,overTrafficOutCost:void 0,overStorageLatest:void 0,overStorage:void 0,overStorageCost:void 0,creditsCharged:void 0,creditsPending:void 0,overCreditsCharged:void 0,overCreditsChargedPending:void 0,overCreditsChargedCost:void 0,overCreditsChargedPendingCost:void 0,finalCost:void 0},this._package={domainName:void 0,packageName:void 0,currency:void 0,packagePrice:void 0,startDate:void 0,endDate:void 0,costOutGb:void 0,costStorageGb:void 0,costCredit:void 0,trafficOut:void 0,trafficIn:void 0,storage:void 0,credits:void 0,users:void 0},this._hasPackage=!1,this._transactions=void 0},WS.extend("DomainStats"),WS.StatService=function(e,t,i,n,o,r){F.PlugModule.call(this,n),this._error=e,this._http=t,this._user=i,this._project=o,this._transaction=r},WS.StatService.prototype={getData:function(e){var t=this,i=Q.defer(),n=this._project.getAll(),o=this._user.getAll();return Q.all([n,o]).spread(function(n,o){var r=t.getRawBillingdata(e),a=t.getStorageByResource(e,n),s=t._transaction.get(e,n,o);Q.all([r,a,s]).spread(function(e,n,o){var r=t.buildData(e,n,o);i.resolve(r)},function(e){i.reject(e)})},function(e){i.reject(e)}),i.promise},buildData:function(e,t,i){var n=1/1073741824,o=new WS.DomainStats;o._package.domainName=e.domainid,o._package.packageName=e.billingPackage.PackageName,o._package.currency=e.billingPackage.Currency,o._package.packagePrice=e.billingPackage.BaseCost,o._package.startDate=e.startDate,o._package.endDate=e.endDate,o._package.costOutGb=e.billingPackage.TrafficOutCostPerGb,o._package.costStorageGb=e.billingPackage.StorageCostPerGb,o._package.costCredit=e.billingPackage.CostPerCredit,o._package.trafficOut=e.billingPackage.MaxTrafficOut*n,o._package.trafficIn=e.billingPackage.MaxTrafficIn*n,o._package.storage=e.billingPackage.MaxStorageSize*n,o._package.credits=e.billingPackage.FreeCredits,o._package.users=e.billingPackage.MaxUsers,o._hasPackage=!!o._package.packageName,o._use.trafficOut=e.trafficOut*n,o._use.trafficIn=e.trafficIn*n,o._use.storage=e.storageSize*n;var r=0;for(var a in t){var s=t[a];for(var c in s)r+=s[c].storageSize}if(o._use.storageLatest=r*n,o._use.detailStorage=e.storageSizes,o._use.storageByProject=t.project,o._use.detailTraffic=e.detailedTraffic,o._use.overTrafficOut=e.overTrafficOut*n,o._use.overTrafficOutCost=e.overTrafficOutCost,o._hasPackage){var l=Math.max(0,r-e.billingPackage.MaxStorageSize);o._use.overStorageLatest=l*n}else o._use.overStorageLatest=0;return o._use.overStorage=e.overStorageSize*n,o._use.overStorageCost=e.overStorageSizeCost,o._use.creditsCharged=e.creditsCharged,o._use.creditsPending=e.creditsPending,o._use.overCreditsCharged=e.overCreditsCharged,o._use.overCreditsChargedPending=e.overCreditsChargedPending,o._use.overCreditsChargedCost=e.overCreditsChargedCost,o._use.overCreditsChargedPendingCost=e.overCreditsChargedPendingCost,o._use.finalCost=e.finalCost,o._transactions=i,o},getRawBillingdata:function(e){var t=Q.defer(),i=this._http.get("/account/"+e+"month");return i.success(function(e){t.resolve(e)}).error(this._error.httpHandler(t)),t.promise},getStorageByResource:function(e,t){var i=this,n=Q.defer(),o=this._http.get("/account/storagebyresource/"+e+"month");return o.success(function(o){var r=t?Q.resolve(t):i._project.getAll();r.then(function(t){var i={};t.forEach(function(e){i[e._name]=e});var r=o.project;for(var a in r)i[a]?r[a].displayName=i[a]._displayName:"this"===e&&delete r[a];"this"===e&&t.forEach(function(e){r[e._name]||(r[e._name]={displayName:e._displayName,storageSize:0,date:void 0})});for(var s in o){var c=o[s];for(var l in c)c[l].resourceType=s,c[l].resourceId=l}n.resolve(o)},function(e){n.reject(e)})}).error(this._error.httpHandler(n)),n.promise}},WS.extend("StatService","PlugModule"),angular.module("ws.dashboard",[]),F.DI().config(function(){this.registerService("transaction",WS.TransactionService,"@serializer","@error","@locale","$resource"),this.registerService("stats",WS.StatService,"@error","$http","@user","@plug","@project","@transaction")}),F.DI().config("@serializer","@transaction",function(e,t){e.registerClass("Transaction",function(){return t.getNew()})}),WS.EntityList=function(e,t,i,n,o,r,a,s,c,l,h,d,u,p){WS.ObjectList.call(this,e,t,i,n,o,r,a,s,c,l,h,d,u),this.provideFemalePlug("JobNotification",["updateJobStatus"]),this.connect(this.getFemalePlug("JobNotification"),p)},WS.EntityList.prototype={updateJobStatus:function(){this.refresh()}},WS.extend("EntityList","ObjectList"),WS.JobQueuePage=function(e,t,i,n,o,r,a,s,c,l){var h=this;this._service=a,this._projectService=s,this._pointCloud=c,this._alert=n,this._panoSettings=l,this._promise=void 0,e.getObjects=function(){return h._promise},e.page={objects:[],index:0,limit:5,predicate:"_creationTime",reverse:!0,sortby:"",query:"",projId:"",projNameObjs:[],projDisplayNames:{},projFilterCaption:""},e.jobsByState={pending:0,running:0,complete:0,aborted:0,error:0},e.setProjectFilter=function(t){if(""===t)e.page.projId="",e.page.projFilterCaption="";else{var i=e.page.projDisplayNames[t];void 0===i?(e.page.projId="",e.page.projFilterCaption=""):""===i?(e.page.projId=t,e.page.projFilterCaption="n/a"):(e.page.projId=t,e.page.projFilterCaption=i+" ("+t+")")}e.page.index=0,h.updateURL(!0)},e.setReverse=function(t){e.page.reverse=t,h.updateURL(!0)},e.toggleFilter=function(e){h.$scope.page.query=e===h.$scope.page.query?"":e,h.$scope.page.index=0,h.updateURL(!0)},this._jobFilter=t("jobfilter"),this._orderFilter=t("orderBy"),this._paginateFilter=t("paginate"),e.getFiltered=function(){return h._jobFilter(e.page.objects,e.page.query,e.page.projId,{})},e.getOrdered=function(){return h._orderFilter(e.getFiltered(),e.page.predicate,e.page.reverse)},e.getVisible=function(){return h._paginateFilter(e.getOrdered(),e.page.index,e.page.limit)},e.$watch("getFiltered().length",function(t){e.filteredlength=t}),e.refresh=function(){h._promise&&h._promise.isPending()||(h._promise=h.getJobs())},e.loadProject=function(e){h.trigger("showObjects",[[e],"map"])},e.webGlEnabled=l.isWebGlEnabled(),e.showPointCloud=function(e){if("complete"===e._state){var t=e._project,i=e._object,n=h._projectService.isCurrent(t)?Q.resolve():h._projectService.changeProject(t);n.then(function(){h._pointCloud.getAll().then(function(e){var t=F.findFirst(e,function(e){return(e._UUID===i||e._entityUUIDs&&e._entityUUIDs.indexOf(i)>=0)&&e._state===WS.PointCloud.State.COMPLETE});if(!t)throw new Error("EM_RESOURCE_NOT_FOUND");h.trigger("showObjects",[[t],"3d"])}).fail(function(e){h._alert.errorObj(e)})})}},WS.Embeddable.call(this,e,i,o),this.provideMalePlug("ObjectShow",["showObjects"]),this.provideMalePlug("ViewFocus",["focusOn"]),this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.provideFemalePlug("SettingsUpdate",["updateSettings"]),this.provideFemalePlug("JobNotification",["updateJobStatus"]),this.connect(this,this._service),this.connect(this,r),this.connect(this,l),this.autoConnect(e)},WS.JobQueuePage.prototype={updateJobStatus:function(){this.$scope.refresh()},onShow:function(){WS.Embeddable.prototype.onShow.call(this),this.$scope.refresh()},getJobs:function(){var e=this._service.getAll(),t=this,i=this.$scope;return e.then(function(e){t._projectService.getAll().then(function(n){var o=t._service.determineProjectNames(e,n);i.$apply(function(){i.page.projNameObjs=o[0],i.page.projDisplayNames=o[1],i.setProjectFilter(i.page.projId)})}).done()}),e},updateJobsByState:function(e){e=e||this.$scope.page.objects;var t=this.$scope.jobsByState;for(var i in t)t.hasOwnProperty(i)&&(t[i]=0);e.forEach(function(e){t[e._state]++})},addObjects:function(e){F.addObjectsByID(this.$scope.page.objects,e),this.updateJobsByState(),this.$scope.$apply("page.index = 0")},updateObjects:function(){this.updateJobsByState(),this.$scope.$apply()},removeObjects:function(e){F.removeObjectsByID(this.$scope.page.objects,e),this.updateJobsByState(),this.$scope.$apply("page.index = 0")},updateURL:function(e){var t={q:this.$scope.page.query||"",r:this.$scope.page.reverse?"t":"f",p:this.$scope.page.projId||""};this._url.setFragment(this._id,this._url.encode(t),[],e)},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query,[])}},applyURL:function(e,t){var i=this.$scope;if(e===this._id){var n=t.get(this._id),o=this._url.decode(n.query);i.$apply(function(){i.page.query=o.q||"",i.page.reverse="t"===o.r,i.page.projId=o.p||""})}},login:function(){this._visible?(!this._promise||this._promise.isRejected())&&(this._promise=this.getJobs()):this._promise=void 0},logout:function(){this._promise=void 0},updateAccount:function(){},updateSettings:function(e){"panorama"===e&&(this.$scope.webGlEnabled=this._panoSettings.isWebGlEnabled(),this.$scope.$apply())}},WS.extend("JobQueuePage","Embeddable"),WS.AccountValidationPage=function(e,t,i,n){F.Page.call(this,e,i,n);var o=this;this._account=t,this._promise=void 0,e.getPromise=function(){return!o._promise&&o._token&&(o._promise=t.validateAccount(o._token),o._promise.fail(function(t){e.$apply(function(){e.errormessage="object"==typeof t&&"EM_RESOURCE_NOT_FOUND"==t.message?"FE_VALIDATE_ACCOUNT_FAILED":"FE_VALIDATE_ACCOUNT_FAILED_UNKNOWN"})})),o._promise}},WS.AccountValidationPage.prototype={updateURL:function(){this._url.setFragment(this._id,"")},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query)}},applyURL:function(e,t){if(e==this._id){var i=t.get(this._id).query;this._token=this._account.sanitizeToken(i),this.$scope.$apply()}}},WS.extend("AccountValidationPage","Page"),WS.ResetPasswordPage=function(e,t,i,n){F.Page.call(this,e,i,n);var o=this;this._account=t,this._promise=void 0,e.getPromise=function(){return o._promise},this._token=void 0,e.formData={},e.submit=function(i){e.submitted=!0,o._promise=t.changePassword(o._token,e.formData.password),e.formData={},i.$setPristine(),o._promise.fail(function(t){e.errormessage="object"==typeof t&&"EM_RESOURCE_NOT_FOUND"==t.message?"FE_CHANGE_PASSWORD_EXPIRED":"FE_CHANGE_PASSWORD_FAILED"}).done()},e.notValidNames=/^[a-z A-Z]+$/,e.validatePassword=function(){return void 0===e.formData.password?!1:e.passwordsEqual()&&void 0===F.validatePassword(e.formData.password)},e.passwordsEqual=function(){return e.formData.confirmPassword===e.formData.password},e.canSubmit=function(){return e.validatePassword()&&e.formData.termsAccepted}},WS.ResetPasswordPage.prototype={updateURL:function(){this._url.setFragment(this._id,"")},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query)}},applyURL:function(e,t){if(e==this._id){var i=t.get(this._id).query;this._token=this._account.sanitizeToken(i)}}},WS.extend("ResetPasswordPage","Page"),WS.ProjectListPage=function(e,t,i,n,o,r,a,s){WS.Page.call(this,e,o,a);var c=this;this.$scope=e,this._projectService=i,this._alert=r,this._stats=s,this._projectsPromise=void 0,this._projectFilter=t("projectfilter"),this.$scope.getProjects=function(){return c._projectsPromise},e.page={projects:[],predicate:"_displayName",query:"",minVersion:void 0,withMap:void 0},e.stateComparator=function(e){switch(e._type){case WS.Project.Type.INC:return e._state===WS.Project.State.PUBLISHED?4:2;case WS.Project.Type.WSC:return e._uploadState===WS.Project.UploadState.COMPLETED?3:1}},e.changeSelection=function(t){e.task&&e.selection?t.toggleSelection():e.task&&c._alert.message("IM_NOT_IN_SELECTIONMODE")};var l=n.getSelection("Project");e.changeSelectionAllProjects=function(t){t?l.setSelection(e.getFiltered()):l.clear()},e.openWorkbench=function(e){c.trigger("showObjects",[[e],"workbench"])},e.getFiltered=function(){return c._projectFilter(e.page.projects,e.page.query,e.page.minVersion,e.page.withMap)},e.byteToGB=1/1073741824,this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideFemalePlug("ProjectSelect",["select","unselect"]),this.provideMalePlug("ObjectShow",["showObjects"]),this._connectorService.connect(this,this._projectService),this._connectorService.connect(this.getFemalePlug("ProjectSelect"),n.getSelection("Project"))},WS.ProjectListPage.prototype={addObjects:function(e){for(var t=0,i=e.length;i>t;++t){var n=e[t];this.$scope.$apply(function(e){F.addUnique(e.page.projects,n)})}},updateObjects:function(){this.$scope.$apply()},removeObjects:function(e){for(var t=0,i=e.length;i>t;++t){var n=e[t];this.$scope.$apply(function(e){F.removeFirst(e.page.projects,n)})}},updateProjects:function(){var e=this;this._projectsPromise=this._projectService.getAll();var t=this._stats.getStorageByResource("this");Q.all([this._projectsPromise,t]).spread(function(t,i){var n=i.project;t.forEach(function(e){n[e._name]&&(e._storageSize=n[e._name].storageSize)}),e.$scope.$apply()}),t.fail(function(t){e._alert.errorObj(t,F.AlertServiceBase.DELAY_MEDIUM)})},select:function(){this.$scope.$apply()},unselect:function(){this.$scope.$apply()},onShow:function(){F.Page.prototype.onShow.call(this),this.updateProjects()},onConfigure:function(e){var t=this.$scope;t.selection=!1,t.task=!1,e&&("project"===e.selection&&(t.selection=!0),t.task=e.task,t.page.minVersion=e.minVersion,t.page.withMap=e.withMap)}},WS.extend("ProjectListPage","Page"),WS.ImportPage=function(e,t,i,n,o){F.Page.call(this,e,t,n);var r=this;this.$scope=e,this._project=i,this._login=o,this._projectName=void 0,this._promise=void 0,this.$scope.getProject=function(){return r._promise},this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this._login,this)},WS.ImportPage.prototype={getProject:function(e){var t=void 0===e?this._project.getCurrent():e;this._projectName=t,this._promise=this._project.getByID(t),this.$scope.$apply()},onShow:function(){F.Page.prototype.onShow.call(this);var e=this;this.getProject(),this._login.isLoggedIn().then(function(t){t?e.login():e.logout()}).done()},login:function(){if(this._visible&&this._projectName){var e=this;this._login.isProjectManager().then(function(t){t?e.getProject(e._projectName):(e._promise=Q.reject(WS.PMException),e.$scope.$apply())}).done()}},logout:function(){this._promise=Q.reject(WS.authenticationException),this.$scope.$apply()},updateAccount:function(){this.login()},updateURL:function(){this._projectName&&this._url.setFragment(this._id,"",["p"])},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query,["p"])}},applyURL:function(e){e===this._id&&this._visible&&this.getProject()}},WS.extend("ImportPage","Page"),WS.RoleDetailsPage=function(e,t,i,n,o){WS.Page.call(this,e,t,i);var r=this;this._role=n,this._roleID=void 0,this._promise=void 0,e.getPromise=function(){return r._promise},this._userPromise=void 0,e.getUserPromise=function(){if(!r._userPromise){var e=r.$scope.getPromise();e&&(r._userPromise=e.then(function(e){return e.getUsers()}))}return r._userPromise},e.predicate="_firstname",e.setPredicate=function(t){e.reverse=e.predicate===t?!e.reverse:!1,e.predicate=t},e.placeholdEmpty=F.PLACEHOLD_EMPTY,this.provideFemalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(o,this)},WS.RoleDetailsPage.prototype={showObjects:function(e,t){"roledetails"==t&&(this.changePage(),this._roleObject=e[0],this._roleID=this._roleObject._ID,this._promise=Q.resolve(this._roleObject),this._userPromise=void 0,this.updateURL())},updateURL:function(){this._roleID&&this._url.setFragment(this._id,this._roleID.toString())},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query)}},applyURL:function(e,t){e==this._id&&(this._roleID=parseInt(t.get(this._id).query),this._promise=this._role.getByID(this._roleID),this._userPromise=void 0)},login:function(){this._visible&&(this._promise=this._role.getByID(this._roleID))},logout:function(){this._promise=Q.reject(WS.authenticationException),this._userPromise=void 0},updateAccount:function(){}},WS.extend("RoleDetailsPage","Page"),WS.GroupPage=function(e,t,i,n,o,r,a,s){WS.Page.call(this,e,o,a);var c=this;this._groupService=i,this._alert=r,this._groupPromise=void 0,this._adminFilter=t("adminfilter"),e.getGroups=function(){return c._groupPromise},e.page={groups:[],predicate:"_name",query:""},e.showGroupDetailPage=function(e){c.trigger("showObjects",[[e],"groupdetails"])},e.changeSelection=function(t){e.task&&e.selection?t.toggleSelection():e.task&&c._alert.message("IM_NOT_IN_SELECTIONMODE")};var l=n.getSelection("Group");e.changeSelectionAllGroups=function(t){t?l.setSelection(e.getFiltered()):l.clear()},e.getFiltered=function(){return c._adminFilter(e.page.groups,e.page.query)},this.provideMalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideFemalePlug("GroupSelect",["select","unselect"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this,this._groupService),this.connect(this,n.getSelection("Group")),this.connect(this,s)},WS.GroupPage.prototype={addObjects:function(e){for(var t=0;t<e.length;t++){var i=e[t];this.$scope.$apply(function(e){F.addUnique(e.page.groups,i)})}},updateObjects:function(){this.$scope.$apply()},removeObjects:function(e){for(var t=0;t<e.length;t++){var i=e[t];this.$scope.$apply(function(e){F.removeFirst(e.page.groups,i)})}},updateGroups:function(){this._groupPromise=this._groupService.getAll()},select:function(){this.$scope.$apply()},unselect:function(){this.$scope.$apply()},onShow:function(){WS.Page.prototype.onShow.call(this),this.updateGroups()},onConfigure:function(e){e&&e.noReconfigure||(this.$scope.selection=!1,this.$scope.task=!1,e&&(e.selection&&(this.$scope.selection=e.selection),this.$scope.task=e.task))},login:function(){this._visible&&this.updateGroups()},logout:function(){this._groupPromise=Q.reject(WS.authenticationException)},updateAccount:function(){}},WS.extend("GroupPage","Page"),WS.GroupDetailsPage=function(e,t,i,n,o){WS.Page.call(this,e,t,i);var r=this;this._group=n,this._groupID=void 0,this._promise=void 0,e.getPromise=function(){return r._promise},this._usersPromise=void 0,e.getUsersPromise=function(){if(!r._usersPromise){var e=r.$scope.getPromise();e&&(r._usersPromise=e.then(function(e){return e.getUsers()}))}return r._usersPromise},e.predicate="_firstname",e.setPredicate=function(t){e.reverse=e.predicate===t?!e.reverse:!1,e.predicate=t},e.placeholdEmpty=F.PLACEHOLD_EMPTY,e.membersAvailable=function(){return e.userlist.length>0},this.provideFemalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(o,this)},WS.GroupDetailsPage.prototype={showObjects:function(e,t){"groupdetails"==t&&(this.changePage(),this._groupObject=e[0],this._groupID=this._groupObject._ID,this._promise=Q.resolve(this._groupObject),this._usersPromise=void 0,this.updateURL())},updateURL:function(){this._groupID&&this._url.setFragment(this._id,this._groupID.toString())},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query)}},applyURL:function(e,t){e==this._id&&(this._groupID=parseInt(t.get(this._id).query),this._promise=this._group.getByID(this._groupID),this._usersPromise=void 0)},login:function(){this._visible&&(this._promise=this._group.getByID(this._groupID))},logout:function(){this._promise=Q.reject(WS.authenticationException),this._userPromise=void 0},updateAccount:function(){}},WS.extend("GroupDetailsPage","Page"),WS.ProjectGroupManagement=function(e,t,i,n,o,r){WS.Page.call(this,e,t,i);var a=this;this._projectService=n,this._groupService=o,this._groupPromise=void 0,e.getGroupPromise=function(){return a._groupPromise},this._projectPromise=void 0,e.getProjectPromise=function(){return a._projectPromise},e.projectlist=[],e.grouplist=[],this._arrayChanges=[],this._arrayPublic=[],this._arrayEnable3D=[],e.page={forProjects:!0,project:void 0,group:void 0,idxProject:void 0,idxGroup:void 0,queryProject:"",queryGroup:"",predProject:"_displayName",sortProject:!1,sortGroup:!1};var s=e.page;e.error=void 0,e.changeRelation=function(e,t){var i=a.belongsProjectToChanges(a._arrayChanges,e);if(-1===i){var n={project:e,add:[],remove:[]};-1!==e._groupids.indexOf(t._ID)?(n.remove.push(t),a.trigger("removeRelation",[e,t])):(n.add.push(t),a.trigger("addRelation",[e,t])),a._arrayChanges.push(n)}else{var o=a.arrayIndexOfGroup(a._arrayChanges[i].add,t._ID),r=a.arrayIndexOfGroup(a._arrayChanges[i].remove,t._ID);-1===o&&-1===r?-1!==e._groupids.indexOf(t._ID)?(a.addGroupToArray(i,t,"remove"),a.trigger("removeRelation",[e,t])):(a.addGroupToArray(i,t,"add"),a.trigger("addRelation",[e,t])):-1!==o?(a.removeGroupFromArray(i,o,"add"),a.trigger("addRelation",[e,t])):-1!==r&&(a.removeGroupFromArray(i,r,"remove"),a.trigger("removeRelation",[e,t]))}},e.changePublicFlag=function(e){var t={project:e,"public":!e._public},i=a.belongsProjectToChanges(a._arrayPublic,e);-1===i?(a._arrayPublic.push(t),a.trigger("addRelation",[e,t])):(a._arrayPublic.splice(i,1),a.trigger("removeRelation",[e,t]))},e.changeEnable3DFlag=function(e){var t={project:e,enable3D:!e._enable3D},i=a.belongsProjectToChanges(a._arrayEnable3D,e);-1===i?(a._arrayEnable3D.push(t),a.trigger("addRelation",[e,t])):(a._arrayEnable3D.splice(i,1),a.trigger("removeRelation",[e,t]))},e.belongsGroupToProject=function(e,t){var i=-1!==e._groupids.indexOf(t._ID)?"true":"false",n=a.belongsProjectToChanges(a._arrayChanges,e);return-1!==n&&(a.isGroupInArray(a._arrayChanges[n].add,t)?i="change_true":a.isGroupInArray(a._arrayChanges[n].remove,t)&&(i="change_false")),i},e.publicString=function(e){var t=e._public?"true":"false",i=a.belongsProjectToChanges(a._arrayPublic,e);return-1!==i&&(t=a._arrayPublic[i]["public"]?"change_true":"change_false"),t},e.isPublic=function(e){var t=e._public,i=a.belongsProjectToChanges(a._arrayPublic,e);return-1!==i&&(t=a._arrayPublic[i]["public"]),t},e.enable3DString=function(e){var t=e._enable3D?"3d_true":"checked_false",i=a.belongsProjectToChanges(a._arrayEnable3D,e);return-1!==i&&(t=a._arrayEnable3D[i].enable3D?"3d_change_true":"checked_change_false"),t},e.isEnable3D=function(e){var t=e._enable3D,i=a.belongsProjectToChanges(a._arrayEnable3D,e);return-1!==i&&(t=a._arrayEnable3D[i].enable3D),t},e.getMtTriangle=function(){return s.forProjects?0<=s.idxProject?55*(s.idxProject+1)+18:-1:0<=s.idxGroup?55*(s.idxGroup+1)+18:-1},e.getMtRights=function(){return s.forProjects?0<=s.idxProject?55*s.idxProject:0:0<=s.idxGroup?55*s.idxGroup:0},e.showProjects=function(){s.forProjects||(s.forProjects=!0,s.queryProject="",s.queryGroup="")},e.showGroups=function(){s.forProjects&&(s.forProjects=!1,s.queryProject="",s.queryGroup="")},e.changeSearchProject=function(){s.project&&(s.project=void 0,s.group=void 0,s.idxProject=void 0)},e.filterSearchProject=function(){""!==s.queryProject&&(s.queryProject="",e.changeSearchProject())},e.changeSearchGroup=function(){s.group&&(s.project=void 0,s.group=void 0,s.idxGroup=void 0)},e.filterSearchGroup=function(){""!==s.queryGroup&&(s.queryGroup="",e.changeSearchGroup())},e.$watch("page.predProject",function(t,i){t!==i&&e.changeSearchProject()}),e.$watch("page.sortProject",function(t,i){t!==i&&e.changeSearchProject()}),e.$watch("page.sortGroup",function(t,i){t!==i&&e.changeSearchGroup()}),this.provideMalePlug("RelationChange",["addRelation","removeRelation"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this,r)},WS.ProjectGroupManagement.prototype={updateData:function(){this._groupPromise=this._groupService.getAll(),this._projectPromise=this._projectService.getAll({"with":"groupids"})},onShow:function(){WS.Page.prototype.onShow.call(this),this.updateData(),this._arrayChanges=[],this._arrayPublic=[],this._arrayEnable3D=[];var e=this.$scope.page;e.forProjects=!0,e.project=void 0,e.group=void 0,e.idxProject=void 0,e.idxGroup=void 0,e.queryProject="",e.queryGroup="",e.predProject="_displayName",e.sortProject=!1,e.sortGroup=!1,this.launchTask("admin","projectmanagement","rights",void 0,{noNavigation:!0})},isGroupInArray:function(e,t){var i=!1;return e.forEach(function(e){e._ID===t._ID&&(i=!0)}),i},arrayIndexOfGroup:function(e,t){for(var i=0;i<e.length;i++)if(e[i]._ID===t)return i;return-1},belongsProjectToChanges:function(e,t){for(var i=0;i<e.length;i++)if(e[i].project._name===t._name)return i;return-1},addGroupToArray:function(e,t,i){"add"===i?this._arrayChanges[e].add.push(t):this._arrayChanges[e].remove.push(t)},removeGroupFromArray:function(e,t,i){"add"===i?this._arrayChanges[e].add.splice(t,1):this._arrayChanges[e].remove.splice(t,1)},login:function(){this._visible&&(this.updateData(),this.launchTask("admin","projectmanagement","rights",void 0,{noNavigation:!0}))},logout:function(){this._groupPromise=Q.reject(WS.authenticationException)},updateAccount:function(){}},WS.extend("ProjectGroupManagement","Page"),WS.UserDetailsPage=function(e,t,i,n,o){WS.Page.call(this,e,t,i);var r=this;this._user=n,this._userID=void 0,this._promise=void 0,e.getPromise=function(){return r._promise},this._groupsPromise=void 0,e.getGroupsPromise=function(){if(!r._groupsPromise){var e=r.$scope.getPromise();return e&&(r._groupsPromise=e.then(function(e){return n.getRelatedGroups(e)})),r._groupsPromise}},this._rolesPromise=void 0,e.getRolesPromise=function(){if(!r._rolesPromise){var e=r.$scope.getPromise();e&&(r._rolesPromise=e.then(function(e){return n.getRelatedRoles(e)}))}return r._rolesPromise},e.placeholdEmpty=F.PLACEHOLD_EMPTY,this.provideFemalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(o,this)},WS.UserDetailsPage.prototype={showObjects:function(e,t){"userdetails"==t&&(this.changePage(),this._userObject=e[0],this._userID=this._userObject._ID,this._promise=Q.resolve(this._userObject),this._groupsPromise=void 0,this._rolesPromise=void 0,this.updateURL())},updateURL:function(){this._userID&&this._url.setFragment(this._id,this._userID.toString())},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query)}},applyURL:function(e,t){e==this._id&&(this._userID=parseInt(t.get(this._id).query),this._promise=this._user.getByID(this._userID),this._groupsPromise=void 0,this._rolesPromise=void 0)},login:function(){this._visible&&(this._promise=this._user.getByID(this._userID))},logout:function(){this._promise=Q.reject(WS.authenticationException),this._userPromise=void 0},updateAccount:function(){}},WS.extend("UserDetailsPage","Page"),WS.UserPage=function(e,t,i,n,o,r,a,s){WS.Page.call(this,e,n,r);var c=this;this._service=t,this._alert=o,this._login=a,this._promise=void 0,e.getPromise=function(){return c._promise},e.page={objects:[],index:0,limit:20,predicate:"_firstname",reverse:!1},e.error=void 0,e.placeholdEmpty=F.PLACEHOLD_EMPTY,e.Math=window.Math;var l=function(e,t){return!e._roles.some(function(e){return e._ID===t})};e.globalOrder=function(t){switch(e.page.predicate){case"orderByProjectAdmin":return l(t,WS.Role.Id.PROJECT_MANAGER);case"orderByDomainAdmin":return l(t,WS.Role.Id.DOMAIN_ADMIN);case"orderByUploader":return l(t,WS.Role.Id.UPLOADER);case"orderByUser":return l(t,WS.Role.Id.USER);case"_firstname":case"_lastname":case"_username":return t[e.page.predicate];default:throw"Sort key not implemented"}},e.setPredicate=function(t,i){e.page.reverse=e.page.predicate===t?!e.page.reverse:!1,e.page.predicate=t,e.page.sortby=i,e.page.index=0};var h="User";this._objectSelection=i.getSelection(h),this._objectFilter=s("userfilter"),this._orderFilter=s("orderBy"),this._paginateFilter=s("paginate"),e.getFiltered=function(){return c._objectFilter(e.page.objects,e.page.query)},e.getOrdered=function(){return c._orderFilter(e.getFiltered(),e.globalOrder,e.page.reverse)
},e.getVisible=function(){return c._paginateFilter(e.getOrdered(),e.page.index,e.page.limit)},e.$watch("getFiltered().length",function(t){e.filteredlength=t}),e.changeSelection=function(t){e.task&&e.selection?t.toggleSelection():e.task&&c._alert.message("IM_NOT_IN_SELECTIONMODE")},e.changeSelectionAll=function(t){switch(t){case"all":c._objectSelection.selectMulti(e.getOrdered());break;case"visible":c._objectSelection.selectMulti(e.getVisible());break;case"none":c._objectSelection.clear()}},e.roleIcon=function(e,t){var i="none";return e._roles.some(function(e){return e._ID===WS.Role.Id[t]?(i=e._name.toLowerCase().replace(" ",""),!0):void 0}),i},this.provideMalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideFemalePlug("UserSelect",["select","unselect"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this,this._service),this.connect(this,i.getSelection("User")),this.connect(this,a)},WS.UserPage.prototype={addObjects:function(e){var t=this._service;this._visible&&this.$scope.$apply(function(i){for(var n=Q.resolve(),o=0;o<e.length;o++){var r=e[o];F.addUnique(i.page.objects,r)&&("groups"===i["with"]&&(n=n.then(function(){return t.getRelatedGroups(r)})),"roles"===i["with"]&&(n=n.then(function(){return t.getRelatedRoles(r)})))}n.then(function(){i.$apply()}).done()})},updateObjects:function(){this._visible&&this.$scope.$apply()},removeObjects:function(e){this._visible&&this.$scope.$apply(function(t){for(var i=0;i<e.length;i++){var n=e[i];F.removeFirst(t.page.objects,n)}})},updateUsers:function(){var e=this,t=this._service,i={};this._pendingWith&&(this.$scope["with"]=this._pendingWith,this._pendingWith=void 0);var n=this.$scope["with"];"groups"==n?i["with"]="groupids":"roles"==n&&(i["with"]="roleids"),this._promise=this._service.getAll(i),this._promise.then(function(i){var o=Q.resolve();"groups"===n?i.forEach(function(e){o=o.then(function(){return t.getRelatedGroups(e)})}):"roles"===n&&i.forEach(function(e){o=o.then(function(){return t.getRelatedRoles(e)})}),o.then(function(){e.$scope.$apply()}).done()})},select:function(){this.$scope.$apply()},unselect:function(){this.$scope.$apply()},onShow:function(){WS.Page.prototype.onShow.call(this),this.updateUsers()},onConfigure:function(e){if(!e||!e.noReconfigure){var t=!1;e?(e["with"]&&this.$scope["with"]!=e["with"]&&(t=this._visible),this.$scope["with"]=e["with"]):this.$scope["with"]=void 0,this.$scope.selection=!1,this.$scope.task=!1,e&&("user"==e.selection&&(this.$scope.selection=!0),this.$scope.task=e.task,this.updateURL(!0),t&&this.updateUsers())}},login:function(){this._visible&&this.updateUsers()},logout:function(){this._promise=Q.reject(WS.authenticationException)},updateAccount:function(){},updateURL:function(){this._url.setFragment(this._id,this.$scope["with"]||"",void 0,!0)},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query)}},applyURL:function(e,t){e==this._id&&(this._pendingWith=t.get(this._id).query)}},WS.extend("UserPage","Page"),WS.RolePage=function(e,t,i,n,o,r,a,s){WS.Page.call(this,e,o,a);var c=this;this._roleService=i,this._alert=r,this._rolesPromise=void 0,this._adminFilter=t("adminfilter"),this.$scope.getRoles=function(){return c._rolesPromise},e.page={roles:[],predicate:"_name",query:""},e.showRoleDetailPage=function(e){c.trigger("showObjects",[[e],"roledetails"])},e.changeSelection=function(t){e.task&&e.selection?t.toggleSelection():e.task&&c._alert.message("IM_NOT_IN_SELECTIONMODE")};var l=n.getSelection("Role");e.changeSelectionAllRoles=function(t){t?l.setSelection(e.getFiltered()):l.clear()},e.getFiltered=function(){return c._adminFilter(e.page.roles,e.page.query)},this.provideMalePlug("ObjectShow",["showObjects"]),this.provideFemalePlug("ObjectCRUD",["addObjects","updateObjects","removeObjects"]),this.provideFemalePlug("RoleSelect",["select","unselect"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this,this._roleService),this.connect(this,n.getSelection("Role")),this.connect(this,s)},WS.RolePage.prototype={addObjects:function(e){for(var t=0;t<e.length;t++){var i=e[t];this.$scope.$apply(function(e){F.addUnique(e.page.roles,i)})}},updateObjects:function(){this.$scope.$apply()},removeObjects:function(e){for(var t=0;t<e.length;t++){var i=e[t];this.$scope.$apply(function(e){F.removeFirst(e.page.roles,i)})}},updateRoles:function(){this._rolesPromise=this._roleService.getAll()},select:function(){this.$scope.$apply()},unselect:function(){this.$scope.$apply()},onShow:function(){WS.Page.prototype.onShow.call(this),this.updateRoles()},onConfigure:function(e){e&&e.noReconfigure||(this.$scope.selection=!1,this.$scope.task=!1,e&&("role"==e.selection&&(this.$scope.selection=!0),this.$scope.task=e.task))},login:function(){this._visible&&this.updateRoles()},logout:function(){this._rolesPromise=Q.reject(WS.authenticationException)},updateAccount:function(){}},WS.extend("RolePage","Page"),WS.Dashboard=function(e,t,i,n,o,r,a){WS.Page.call(this,e,i,n);var s=this;this._locale=r,this._encryption=a,this._statService=t,e.stats=void 0,e.chartData={trafficDetailUp:{},trafficDetailDown:{},trafficDetailAcc:{},storageDetail:{},storageByProject:{},budgetDaily:{},budgetAcc:{}},e.showPendingTransactions=!0,e.showChargedTransactions=!0,e.pendingTransactions=void 0,e.chargedTransactions=void 0,e.sort={predicatePending:"_creationTime",predicateCharged:"_chargeTime",reversePending:!1,reverseCharged:!1},this._promise=void 0,e.getStats=function(){return s._promise},e.placeholdEmpty=F.PLACEHOLD_EMPTY,e.dataPeriod="this",e.setPeriod=function(t){("this"===t||"last"===t)&&(e.dataPeriod=t,s.updateStats())},e.refresh=function(){s.updateStats()},e.collapseToggle=function(t){t||e.$broadcast("redrawchart")},this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(o,this)},WS.Dashboard.prototype={updateStats:function(){this._promise=this._statService.getData(this.$scope.dataPeriod),this.createChartData()},onShow:function(){WS.Page.prototype.onShow.call(this),this.updateStats()},createChartData:function(){var e=this;this.$scope.getStats().then(function(t){e.createTrafficChartData(t),e.createStorageChartData(t),e.createStorageByProjectChartData(t),e.createTransactionData(t)},function(){}).done()},createTrafficChartData:function(e){for(var t=e._use.detailTraffic,i=1/1073741824,n=[],o=[],r=[],a=[],s=[],c=0;c<t.length;c++)n[c]=t[c].date.substr(0,10),o[c]=t[c].trafficOut*i,r[c]=t[c].trafficIn*i,s[c]=e._package.trafficOut,a[c]=0===c?o[c]:o[c]+a[c-1];this.$scope.chartData.trafficDetailUp={labels:n,datasets:[{fillColor:"rgba(220,220,220,0.5)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",data:r}],max:Math.max(1,Math.max.apply(Math,r))},this.$scope.chartData.trafficDetailDown={labels:n,datasets:[{fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",data:o}],max:Math.max(1,Math.max.apply(Math,o))},this.$scope.chartData.trafficDetailAcc={labels:n,datasets:[{fillColor:"rgba(32,32,32,0.01)",strokeColor:"rgba(32,32,32,0.5)",pointColor:"rgba(249,11,11,0.01)",pointStrokeColor:"rgba(249,11,11,0.01)",data:s},{fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",data:a}],max:Math.max(1,Math.max(Math.max.apply(Math,a),e._package.trafficOut))}},createStorageChartData:function(e){for(var t=e._use.detailStorage,i=1/1073741824,n=[],o=[],r=0;r<t.length;r++)n[r]=t[r].date.substr(0,10),o[r]=t[r].storageSize*i;this.$scope.chartData.storageDetail={labels:n,datasets:[{fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",data:o}],max:Math.max(1,Math.max(0,Math.max.apply(Math,o)))}},createStorageByProjectChartData:function(e){var t=this,i=this._locale,n=e._use.storageByProject,o=1/1073741824,r=Math.max(0,e._package.storage-e._use.storageLatest),a=function(e){return F.shortenString(e,20,4)},s=function(e){var i=t._encryption.crc32(e);return WS.ColorGenerator.hexColorFromInt(i)},c=[],l=[];for(var h in n)l.push(n[h]);l.sort(function(e,t){return t.storageSize-e.storageSize}),l.forEach(function(e){var t=e.resourceId,n=e.displayName,r=e.storageSize*o;c.push({value:r,label:a(t),legendLabels:[r?r.toFixed(1)+" "+i.translate("FE_GIGABYTES"):"?",t,n||""],color:s(t)})}),e._hasPackage&&c.push({value:r,legendLabels:[r.toFixed(1)+" "+i.translate("FE_GIGABYTES"),i.translate("FE_REMAINING_INC_STORAGE"),""],label:i.translate("FE_REMAINING_INC_STORAGE"),color:"#d1d3d4"}),this.$scope.chartData.storageByProjectPie=c},createTransactionData:function(e){var t=e._transactions,i=this.prepareTransactions(t),n=e._package.credits;this.createTransactionCharts(i,n)},prepareTransactions:function(e){var t=this.$scope,i=[],n=[];return e.forEach(function(e){e._state===WS.Transaction.State.PENDING?i.push(e):e._state===WS.Transaction.State.CHARGED&&n.push(e)}),t.pendingTransactions=i,t.chargedTransactions=n,t.showPendingTransactions="this"===t.dataPeriod&&0<i.length,t.showChargedTransactions=0<n.length,t.chargedTransactions},createTransactionCharts:function(e,t){var i=this.$scope.dataPeriod,n=[],o=[],r=[],a=[],s=new Date;"this"===i?e.forEach(function(e){var t=e._dateCharged;s.getDate()<t.getDate()&&s.setDate(t.getDate())}):"last"===i&&s.setDate(0);for(var c=s.getDate(),l=s.getMonth(),h=s.getFullYear(),d=0;c>d;++d)n[d]=F.dateToMySQLString(new Date(Date.UTC(h,l,d+1)),!0),o[d]=t,r[d]=0,a[d]=0;e.forEach(function(e){r[e._dateCharged.getDate()-1]+=-e._credits});for(var u=0;c>u;++u)a[u]=r[u]+(0===u?0:a[u-1]);this.$scope.chartData.budgetDaily={labels:n,datasets:[{fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",data:r}],max:Math.max(1,Math.max.apply(Math,r))},this.$scope.chartData.budgetAcc={labels:n,datasets:[{fillColor:"rgba(32,32,32,0.01)",strokeColor:"rgba(32,32,32,0.5)",pointColor:"rgba(249,11,11,0.01)",pointStrokeColor:"rgba(249,11,11,0.01)",data:o},{fillColor:"rgba(151,187,205,0.5)",strokeColor:"rgba(151,187,205,1)",pointColor:"rgba(151,187,205,1)",pointStrokeColor:"#fff",data:a}],max:Math.max(1,Math.max(Math.max.apply(Math,a),t))}},getChartColor:function(e){return 75>e?"#008444":100>e?"#e57200":"#ff0000"},updateURL:function(){this._url.setFragment(this._id,"")},login:function(){this._visible&&this.updateStats()},logout:function(){this._promise=Q.reject(WS.authenticationException)},updateAccount:function(){}},WS.extend("Dashboard","Page"),WS.DomainSettingsPage=function(e,t,i,n,o,r,a){WS.Page.call(this,e,t,r);var s=this;this._settingsService=i,this._locale=n,this._alertService=o,this._login=a,this._promise=void 0,this.$scope.settings=void 0,this.$scope.page={logoSelected:void 0},this.$scope.logoUrl=void 0,this.$scope.logoDisplayable=void 0,this.$scope.logoHasCurrent=void 0,this.$scope.browserCompatible=F.supportsFileReader(),this.$scope.languages=this._locale.getLanguages(),this.$scope.lengthUnitsMetric=WS.UnitService.SupportedLengthUnitsMetric,this.$scope.lengthUnitsImperial=WS.UnitService.SupportedLengthUnitsImperial,this.$scope.lengthUnitsSurvey=WS.UnitService.SupportedLengthUnitsSurvey,this.$scope.areaUnitsMetric=WS.UnitService.SupportedAreaUnitsMetric,this.$scope.areaUnitsImperial=WS.UnitService.SupportedAreaUnitsImperial,this.$scope.areaUnitsSurvey=WS.UnitService.SupportedAreaUnitsSurvey,this.$scope.angleUnits=WS.UnitService.SupportedAngleUnits,this.$scope.distStates={segment:"FE_SHOW_SEGMENTS",axis:"FE_SHOW_AXES"},this.$scope.areaStates={hide:"FE_HIDE_DISTANCE_LABELS",show:"FE_SHOW_DISTANCE_LABELS"},this._newLogoData=void 0,this._newLogoFileName=void 0,this._newLogoFileType=void 0,this.$scope.getSettings=function(){return s._promise},this.$scope.changeOpacity=function(e){s.updateChangesForOpacity(e)},this.$scope.readInitLogo=function(){var e=$("#inputInitLogo").get(0);s.readNewLogo(e)},this.$scope.readUpdateLogo=function(){var e=$("#inputUpdateLogo").get(0);s.readNewLogo(e)},this.$scope.updateLogoRadio=function(){s.updateChangesForLogo()},this.$scope.onChange=function(){s.submitChanges()},this.provideMalePlug("ObjectEdit",["editObject"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this._login,this)},WS.DomainSettingsPage.prototype={readNewLogo:function(e){if(!F.supportsFileReader())return this.clearNewLogo(),void this._alertService.error("EM_BROWSER",F.AlertServiceBase.DELAY_MEDIUM,"Firefox: 3.6, Chrome: 7, Internet Explorer: 10, Opera: 12.02, Safari: 6.0.2");var t=new FileReader,i=e.files;if(!i||0===i.length)return void this.clearNewLogo();var n=i[0],o=this.getFileName(n);if(!o||0===o.length)return this.clearNewLogo(),void this._alertService.error("EM_FILE",F.AlertServiceBase.DELAY_SHORT);var r=WS.getFileType(n.type);if("jpg"!==r&&"png"!==r&&"gif"!==r)return this.clearNewLogo(),void this._alertService.error("EM_FILE_TYPE",F.AlertServiceBase.DELAY_MEDIUM,"PNG, JPG, GIF");if(!n.size||WS.DomainSettingsPage.MAX_FILE_SIZE<n.size){this.clearNewLogo();var a=WS.DomainSettingsPage.MAX_FILE_SIZE/1024+" "+this._locale.translate("FE_KILOBYTES");return void this._alertService.error("EM_FILE_SIZE",F.AlertServiceBase.DELAY_MEDIUM,a)}var s=this,c=this.$scope;t.onload=function(){var e=t.result,i=e.split(","),o=i[i.length-1];s._newLogoData=o,s._newLogoFileName=n.name,s._newLogoFileType=r,c.$apply(function(){c.logoDisplayable=!0,c.logoUrl=e,c.page.logoSelected="logoShow"}),s.updateChangesForLogo()},t.readAsDataURL(n)},clearNewLogo:function(){var e=this.$scope;this._newLogoData=void 0,this._newLogoFileName=void 0,this._newLogoFileType=void 0;var t=e.settings;t&&t.hasCustomerLogo()?this.init(t):e.$apply(function(){e.logoDisplayable=!1,e.logoUrl=void 0,e.page.logoSelected="logoDontShow"}),this.updateChangesForLogo()},getFileName:function(e){var t=e.name;return t.substr(0,t.lastIndexOf("."))},updateChangesForLogo:function(){var e=this.$scope.settings,t=e._changes,i=this.$scope.page.logoSelected;"logoDontShow"===i?t._customerLogoFileType="":"logoShow"===i&&(t._customerLogoFileType=this.hasNewLogo()?this._newLogoFileType:e._customerLogoFileType),this.submitChanges()},updateChangesForOpacity:function(e){var t=this.$scope.settings._changes,i=t._customerLogoOpacity+e;i>100?i=100:0>i&&(i=0),t._customerLogoOpacity=i,this.submitChanges()},submitChanges:function(){var e=this.$scope.settings;e.cleanUpChanges();var t=e.hasCustomerLogo()&&"logoDontShow"===this.$scope.page.logoSelected,i=this.hasNewLogo()&&"logoShow"===this.$scope.page.logoSelected,n={settings:e,logoChangedToNone:t,logoChangedToNew:i,newLogoData:i?this._newLogoData:void 0,newLogoFileName:i?this._newLogoFileName:void 0};this.trigger("editObject",[n])},hasNewLogo:function(){return void 0!==this._newLogoFileType},init:function(e){this._newLogoData=void 0,this._newLogoFileName=void 0,this._newLogoFileType=void 0;var t=this,i=this.$scope;i.$apply(function(i){i.settings=e,i.logoHasCurrent=e.hasCustomerLogo(),i.page.logoSelected=e.hasCustomerLogo()?"logoShow":"logoDontShow",i.logoUrl=t._settingsService.getCustomerLogoUrl(e),i.logoDisplayable=e.hasCustomerLogo()})},loadSettings:function(){var e=this;this._promise=this._settingsService.get(!0),this._promise.then(function(t){e.init(t)},function(t){e.$scope.$apply(function(e){e.error=t})}).done()},onShow:function(){WS.Page.prototype.onShow.call(this);var e=this;this._login.isLoggedIn().then(function(t){t?e.login():e.logout()}).done()},updateURL:function(){this._url.setFragment(this._id,"")},login:function(){if(this._visible){var e=this;this._login.isDomainAdmin().then(function(t){t?e.launchTask("admin","adminsettings","domainsettings").then(function(){e.loadSettings()}).done():(e._promise=Q.reject(WS.DAException),e.$scope.$apply())}).done()}},logout:function(){this._promise=Q.reject(WS.authenticationException),this.$scope.$apply()},updateAccount:function(){}},WS.extend("DomainSettingsPage","Page"),WS.DomainSettingsPage.MAX_FILE_SIZE=204800,WS.ProjectImagePage=function(e,t,i,n,o,r){F.Page.call(this,e,t,i),this._locale=n,this._alert=o,this._login=r,this._promise=void 0;var a=this;e.project=void 0,e.browserCompatible=F.supportsFileReader(),e.defaultImageUrl=F.imgUrl("default/defaultProjectImage.jpg"),e.setDomElements=function(){var t=document.getElementById("projectPreviewInput"),i=document.getElementById("projectPreviewImg");t.onchange=function(){e.readImage(t)},i.onload=e.onImageLoad,i.onerror=e.onImageFail,i.onabort=e.onImageFail},e.readImage=function(e){a.readImage(e)},e.onImageLoad=function(){var t=e.project&&e.project._changes._newImage;t&&(t.loading=!1,t.error=void 0),e.$apply()},e.onImageFail=function(){var t=e.project&&e.project._changes._newImage;t&&(t.loading=!1,t.error="EM_IMAGE_DECODE"),e.$apply()},e.getPromise=function(){return a._promise},this.provideFemalePlug("ObjectEdit",["editObject"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this._login,this)},WS.ProjectImagePage.prototype={readImage:function(e){var t=this.$scope,i=t.project;if(i&&F.supportsFileReader()){var n=new FileReader,o=e.files;if(o&&0!==o.length){var r=o[0],a=r.name;if(!a||0===a.length)return void this._alert.error("EM_FILE",F.AlertServiceBase.DELAY_SHORT);var s=WS.getFileType(r.type);if("jpg"!==s&&"png"!==s&&"gif"!==s)return void this._alert.error("EM_FILE_TYPE",F.AlertServiceBase.DELAY_MEDIUM,"PNG, JPG, GIF");if(!r.size||r.size>WS.ProjectImagePage.MAX_FILE_SIZE){var c=WS.ProjectImagePage.MAX_FILE_SIZE/1048576+" "+this._locale.translate("FE_MEGABYTES");return void this._alert.error("EM_FILE_SIZE",F.AlertServiceBase.DELAY_MEDIUM,c)}var l=i._changes._newImage=i._changes._newImage||{};l.loading=!0,l.error=void 0,t.$apply(),n.onload=function(){var e=n.result,i=e.split(","),o=i[i.length-1];l.dataURL=e,l.data=o,l.type=s,t.$apply()},n.readAsDataURL(r)}}},editObject:function(e,t){this._mode=t,this.$scope.$apply(function(t){t.project=e instanceof WS.Project?e:void 0}),this.updateURL(!0)},updateURL:function(){this._url.setFragment(this._id,this._mode||"","editproject"===this._mode?["p"]:[])},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);this._mode=t.query,e.resolve(this._id,t.query,"editproject"===this._mode?["p"]:[])}},applyURL:function(e){e===this._id&&("editproject"===this._mode?this.launchTask("workbench","publish","editmetadata",void 0,{taskSection:"image"}):"createproject"===this._mode&&this.launchTask("admin","projectmanagement","createproject",void 0,{taskSection:"image"}))},updatePromise:function(e){var t=this,i=e?void 0:this._promise;this._promise=i||this._login.isLoggedIn().then(function(e){if(!e)throw WS.authenticationException;return t._login.isProjectManager().then(function(e){if(!e)throw new Error("EM_NO_ADMIN");t.$scope.error=void 0})}),this._promise.fin(function(){t.$scope.$apply()})},onShow:function(){WS.Page.prototype.onShow.call(this),this.updatePromise(!1)},login:function(){this.updatePromise(!0),this.$scope.$apply()},logout:function(){this._promise=Q.reject(WS.authenticationException),this.$scope.project=void 0,this.$scope.$apply()},updateAccount:function(){}},WS.extend("ProjectImagePage","Page"),WS.ProjectImagePage.MAX_FILE_SIZE=10485760,WS.ProjectImagePage.MAX_MPIXELS=33,WS.AdminMapSettingsPage=function(e,t,i,n,o,r){F.Page.call(this,e,t,i);var a=this;this.$scope=e,this._login=n,this._mapobjectservice=o,this._maplayerservice=r,this._promise=void 0,this._project=void 0,e.mapObject=void 0,e.mapLayers=[],e.violatingLayers={},e.flashed=void 0,e.isDragging=!1,e.invisibleDropTargets=[],e.onSliderStop=function(t,i){var n=parseInt(i.substr(8)),o=e.mapLayers[n];a.submitChange(o),t.stopPropagation()},e.$on("sliderStop",e.onSliderStop),e.onNameChange=function(t){for(var i=a.getUniqueViolators(e.mapLayers,"_displayName"),n={},o=0,r=i.length;r>o;++o)n[i[o]._UUID]=!0;var s=t._changes._displayName;(!s||!s.length||128<s.length)&&(n[t._UUID]=!0),e.violatingLayers=n,a.submitChange(t)},e.isNameChanged=function(e){return e._changes._displayName!==e._displayName},e.setOrder=function(t,i){var n=e.mapLayers.length;if(!(0>i||i>n-1)){F.moveElementInArray(e.mapLayers,t,i);var o=F.cloneArray(e.mapObject._changes._layerOrder);F.moveElementInArray(o,t,i),e.mapObject._changes._layerOrder=o,e.flash(i),a.submitChange(e.mapObject)}},e.onDrop=function(t,i){var n=e.mapLayers.length,o=parseInt(t.target.id.substr(8));0>o||o>n||o===i||o===i+1||(o>i&&(o-=1),e.setOrder(i,o),t.stopPropagation())},e.$on("ANGULAR_DRAG_START",function(e,t,i,n){a.onDragStart(e,t,i,n)}),e.$on("ANGULAR_DRAG_END",function(e,t,i,n){a.onDragEnd(e,t,i,n)}),e.isDropTargetVisible=function(t){for(var i=0,n=e.invisibleDropTargets.length;n>i;++i)if(e.invisibleDropTargets[i]===t)return!1;return!0},e.flash=function(t){e.flashed=void 0,setTimeout(function(){e.$apply(function(){e.flashed=t})},50)},e.getPromise=function(){return a._promise},this.provideMalePlug("ObjectEdit",["editObject"]),this.provideFemalePlug("ObjectEdit",["editObject"]),this.provideFemalePlug("Login",["login","logout","updateAccount"]),this.connect(this._login,this)},WS.AdminMapSettingsPage.prototype={onDragStart:function(e,t,i,n){if("maplayer"===i){var o=n.data,r=[o];o+1<=this.$scope.mapLayers.length&&r.push(o+1),this.$scope.$apply(function(e){e.isDragging=!0,e.invisibleDropTargets=r})}},onDragEnd:function(e,t,i){"maplayer"===i&&this.$scope.$apply(function(e){e.isDragging=!1,e.invisibleDropTargets=[]})},editObject:function(e){e instanceof WS.Project&&(this._project=e._name,this.updatePromise())},submitChange:function(e){e&&e.cleanUpChanges();var t={mapObject:this.$scope.mapObject,mapLayers:this.$scope.mapLayers,violatingLayers:this.$scope.violatingLayers};this.trigger("editObject",[t])},reset:function(){this.$scope.$apply(function(e){e.mapLayers=[],e.mapObject=void 0,e.violatingLayers={},e.flashed=void 0,e.isDragging=!1,e.invisibleDropTargets=[]})},updatePromise:function(){if(this.reset(),this._project){var e=this,t=this.$scope,i=this._mapobjectservice.getAll({project:this._project}),n=this._maplayerservice.getAll({project:this._project});this._promise=Q.all([i,n]).spread(function(i,n){var o=i[0];o._project=e._project;for(var r=0,a=n.length;a>r;++r)n[r]._project=e._project;for(var s=[],c=[],l=0,h=n.length;h>l;++l)s[n[l]._UUID]=n[l];for(var d=0,u=o._layerOrder.length;u>d;++d)c.push(s[o._layerOrder[d]]);return t.$apply(function(){t.mapLayers=c,t.mapObject=o}),e.submitChange(),!0},function(i){e._promise=Q.reject(i),t.$apply()})}},onShow:function(){WS.Page.prototype.onShow.call(this);var e=this;this._login.isLoggedIn().then(function(t){t?e.login():e.logout()}).done()},login:function(){if(this._visible){var e=this;this._login.isProjectManager().then(function(t){t?e.launchTask("workbench","publish","adminmapsettings",void 0,{noNavigation:!0}).then(function(){e.updatePromise()}).done():(e._promise=Q.reject(WS.PMException),e.$scope.$apply())}).done()}},logout:function(){this._promise=Q.reject(F.authenticationException),this.$scope.$apply()},updateAccount:function(){},getUniqueViolators:function(e,t){for(var i=[],n=[],o=[],r=[],a=0,s=e.length;s>a;++a){var c=e[a],l=c[t],h=c._changes[t];h!==l?(void 0!==o[h]?i.push(c):r.push(c),o[h]=c):n[l]=c}for(var d=0,u=r.length;u>d;++d){var p=r[d],_=p._changes[t];void 0!==n[_]&&i.push(p)}return i},updateURL:function(){this._url.setFragment(this._id,"",["p"])},setFragment:function(e){if(e.isUnresolved(this._id)){var t=e.get(this._id);e.resolve(this._id,t.query,["p"])}},applyURL:function(e){e==this._id&&this._visible&&(this._project=F.DI().getService("project").getCurrent(),this.updatePromise())}},WS.extend("AdminMapSettingsPage","Page"),WS.LegacyPCList=function(e,t,i,n,o,r,a,s,c,l,h,d,u,p){WS.EntityList.call(this,e,t,i,n,o,r,a,s,c,l,h,d,u,p)},WS.LegacyPCList.prototype={getAll:function(){var e=this;if(this._project.hasCurrent()){var t={project:this._project.getCurrent()},i=function(e){return e._exportVersion<3};return Q.all([this._pointCloud.getAll(void 0,i),this._service.getAll(t)]).then(function(t){var i=t[0].concat(t[1]);return e.$scope.$emit("objectsLength",e,i.length),i})}return Q.resolve([])}},WS.extend("LegacyPCList","EntityList"),WS.ProcessingPage=function(e,t,i,n,o){WS.ProjectContentPage.call(this,e,t,i,n,o),this.setDefaultConfig()},WS.ProcessingPage.prototype={setDefaultConfig:function(){this.$scope.blockvisible={scan:!0,cpe:!0,pc:!1,lpc:!0},this.$scope.blockcollapsed={scan:!1,cpe:!1,pc:!1,lpc:!1}},onConfigure:function(e){if(WS.ProjectContentPage.prototype.onConfigure.call(this,e),!e||!e.pro)return void this.setDefaultConfig();var t=e.pro.blockvisible||{};for(var i in this.$scope.blockvisible)this.$scope.blockvisible[i]=t[i]===!0;var n=e.pro.blockcollapsed||{};for(var o in this.$scope.blockcollapsed)this.$scope.blockcollapsed[o]=n[o]!==!1}},WS.extend("ProcessingPage","ProjectContentPage"),F.DI().registerParameter("proscancolumnconfig",{name:!0,position:!1,category:!0,tags:!0,type:!1,preview:!0,recordingTime:!1}),F.DI().registerParameter("procpeselection","EntityCPE"),F.DI().registerParameter("procpecolumnconfig",{name:!0,state:!0,creationDate:!0}),F.DI().registerParameter("proptcloudselection","EntityPC"),F.DI().registerParameter("proptcloudcolumnconfig",{name:!0,state:!0,creationDate:!0}),F.DI().registerController("jobqueue",WS.JobQueuePage,"$filter","@plug","@alert","@url","@login","@jobqueue","@project","@pointcloud","@panosettings"),F.DI().registerController("accountvalidation",WS.AccountValidationPage,"@account","@plug","@url"),F.DI().registerController("resetpassword",WS.ResetPasswordPage,"@account","@plug","@url"),F.DI().registerController("group",WS.GroupPage,"$filter","@group","@selection","@plug","@alert","@url","@login"),F.DI().registerController("groupdetails",WS.GroupDetailsPage,"@plug","@url","@group","@login"),F.DI().registerController("user",WS.UserPage,"@user","@selection","@plug","@alert","@url","@login","$filter"),F.DI().registerController("userdetails",WS.UserDetailsPage,"@plug","@url","@user","@login"),F.DI().registerController("role",WS.RolePage,"$filter","@role","@selection","@plug","@alert","@url","@login"),F.DI().registerController("roledetails",WS.RoleDetailsPage,"@plug","@url","@role","@login"),F.DI().registerController("projectlist",WS.ProjectListPage,"$filter","@project","@selection","@plug","@alert","@url","@stats"),F.DI().registerController("dashboard",WS.Dashboard,"@stats","@plug","@url","@login","@locale","@encryption"),F.DI().registerController("projectgroupmanagement",WS.ProjectGroupManagement,"@plug","@url","@project","@group","@login"),F.DI().registerController("domainsettings",WS.DomainSettingsPage,"@plug","@domainsettings","@locale","@alert","@url","@login"),F.DI().registerController("projectimage",WS.ProjectImagePage,"@plug","@url","@locale","@alert","@login"),F.DI().registerController("adminmapsettings",WS.AdminMapSettingsPage,"@plug","@url","@login","@mapobject","@maplayer"),F.DI().registerController("processing",WS.ProcessingPage,"@plug","@url","@login","@project"),F.DI().registerController("import",WS.ImportPage,"@plug","@project","@url","@login"),F.DI().registerController("proscan",WS.ObjectList,"$filter","@plug","@url","@scan","@project","@pointcloud","@selection","@alert","@login","@panosettings","%scanselection%","%proscancolumnconfig%"),F.DI().registerController("procpe",WS.EntityList,"$filter","@plug","@url","@entitycpe","@project","@pointcloud","@selection","@alert","@login","@panosettings","%procpeselection%","%procpecolumnconfig%","@jobqueue"),F.DI().registerController("proptcloud",WS.EntityList,"$filter","@plug","@url","@entitypc","@project","@pointcloud","@selection","@alert","@login","@panosettings","%proptcloudselection%","%proptcloudcolumnconfig%","@jobqueue"),F.DI().registerController("prolpc",WS.LegacyPCList,"$filter","@plug","@url","@entitypc","@project","@pointcloud","@selection","@alert","@login","@panosettings","%proptcloudselection%","%proptcloudcolumnconfig%","@jobqueue"),angular.module("ws.page").directive("jobqueue",function(){return F.PlugController.createDirective({controllerClass:F.DI().getController("jobqueue"),template:'<asyncpartial firstload="visible" partial="jobqueue.html"></asyncpartial>'})}),angular.module("ws.page").directive("accountvalidationpage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("accountvalidation"),template:'<asyncpartial firstload="visible" partial="accountvalidationpage.html"></asyncpartial>'})}),angular.module("ws.page").directive("resetpasswordpage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("resetpassword"),template:'<asyncpartial firstload="visible" partial="resetpasswordpage.html"></asyncpartial>'})}),angular.module("ws.page").directive("grouppage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("group"),template:'<asyncpartial firstload="visible" partial="grouppage.html"></asyncpartial>'})}),angular.module("ws.page").directive("userpage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("user"),template:'<asyncpartial firstload="visible" partial="userpage.html"></asyncpartial>',scope:{"with":"@"}})}),angular.module("ws.page").directive("rolepage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("role"),template:'<asyncpartial firstload="visible" partial="rolepage.html"></asyncpartial>'})}),angular.module("ws.page").directive("projectlistpage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("projectlist"),template:'<asyncpartial firstload="visible" partial="projectlistpage.html"></asyncpartial>'})}),angular.module("ws.page").directive("groupdetailspage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("groupdetails"),template:'<asyncpartial firstload="visible" partial="groupdetailspage.html"></asyncpartial>'})}),angular.module("ws.page").directive("userdetailspage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("userdetails"),template:'<asyncpartial firstload="visible" partial="userdetailspage.html"></asyncpartial>'})}),angular.module("ws.page").directive("roledetailspage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("roledetails"),template:'<asyncpartial firstload="visible" partial="roledetailspage.html"></asyncpartial>'})}),angular.module("ws.page").directive("projectgroupmanagementpage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("projectgroupmanagement"),template:'<asyncpartial firstload="visible" partial="projectgroupmanagement.html"></asyncpartial>',scope:{"with":"@"}})}),angular.module("ws.page").directive("dashboard",function(){return F.Page.createDirective({controllerClass:F.DI().getController("dashboard"),template:'<asyncpartial firstload="visible" partial="dashboard.html"></asyncpartial>'})}),angular.module("ws.page").directive("domainsettingspage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("domainsettings"),template:'<asyncpartial firstload="visible" partial="domainsettingspage.html"></asyncpartial>'})}),angular.module("ws.page").directive("projectimagepage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("projectimage"),template:'<asyncpartial firstload="visible" partial="projectimagepage.html"></asyncpartial>'})}),angular.module("ws.page").directive("adminmapsettingspage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("adminmapsettings"),template:'<asyncpartial firstload="visible" partial="adminmapsettingspage.html"></asyncpartial>'})}),angular.module("ws.page").directive("scanadminlist",function(){return F.PlugController.createDirective({scope:{caption:"@",collapsed:"="},link:function(e,t,i){e.galleryid=i.id+"ig"},controllerClass:F.DI().getController("proscan"),template:'<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'})}),angular.module("ws.page").directive("cpelist",function(){return F.PlugController.createDirective({scope:{caption:"@",collapsed:"="},link:function(e,t,i){e.galleryid=i.id+"ig"
},controllerClass:F.DI().getController("procpe"),template:'<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'})}),angular.module("ws.page").directive("pclist",function(){return F.PlugController.createDirective({scope:{caption:"@",collapsed:"="},link:function(e,t,i){e.galleryid=i.id+"ig"},controllerClass:F.DI().getController("proptcloud"),template:'<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'})}),angular.module("ws.page").directive("lpclist",function(){return F.PlugController.createDirective({scope:{caption:"@",collapsed:"="},link:function(e,t,i){e.galleryid=i.id+"ig"},controllerClass:F.DI().getController("prolpc"),template:'<asyncpartial firstload="visible" partial="objectlist.html"></asyncpartial>'})}),angular.module("ws.page").directive("processingpage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("processing"),template:'<asyncpartial firstload="visible" partial="processingpage.html"></asyncpartial>'})}),angular.module("ws.page").directive("importpage",function(){return F.Page.createDirective({controllerClass:F.DI().getController("import"),template:'<asyncpartial firstload="visible" partial="importpage.html"></asyncpartial>'})}),angular.module("ws.page").directive("workbenchtitle",function(){return F.DI().inject("%linkRepository%","%previewGuide%",function(e,t){return{restrict:"E",scope:{project:"="},link:function(i){i.extLink=e+t},templateUrl:F.partialUrl("workbenchtitle.html")}})}),WS.ShareTask=function(e,t){WS.Task.call(this,e),this._login=t,this._description=[this.getSelectionStep({pageConfiguration:{selection:"annotation,measurement,orthophoto,scan",mode:WS.ViewBase.Mode.SelectObjects},select:"Annotation,Measurement,Orthophoto,Scan",selection:"input.annotations,input.measurements,input.orthophotos,input.scans",widget:'<alert type="warning" ng-show="hasUnlocked() && hasLocked()">{{ \'FE_WARN_WRITELOCKED\' | i18n }}</alert><alert type="error" ng-show="length() > 0 && !hasUnlocked()">{{ \'FE_ERROR_ALLWRITELOCKED\' | i18n }}</alert>',completeCondition:"hasUnlocked()"}),{caption:"TC_SELECT_AUDIENCE",widget:'<radio options="audience" selected="input.share"></radio><alert type="warning" ng-show="input.share == \'private\' && willVanish()">{{ \'FE_WARN_VANISH\' | i18n }}</alert>',pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},icon:WS.Icons.TaskSection.group,completeCondition:"input.share"},{caption:"TC_SELECT_ACCESSLEVEL",widget:'<radio options="readWriteOptions" selected="input.readWrite"></radio><alert type="warning" ng-show="input.readWrite == \'readWrite\'">{{ \'FE_WARN_WRITEACCESS\' | i18n }}</alert>',icon:WS.Icons.TaskSection.lock,pageConfiguration:{mode:WS.ViewBase.Mode.Move,changeScanAllowed:!1},startCondition:"input.share == 'public'",completeCondition:"input.readWrite"}]},WS.ShareTask.prototype={setupDescription:function(){this._description[0].description=this.getSelectionStepDescription()},setup:function(e){this.$scope=e,this.setupSelectionStep(),e.audience={"private":"FE_ONLY_CREATOR","public":"FE_PROJECT_PUBLIC"},e.readWriteOptions={read:"FE_READONLY",readWrite:"FE_READWRITE"},this._login.getUsername().then(function(t){e.$apply(function(e){e.username=t})}).done();var t=function(t){return t._createdBy!=e.username};e.willVanish=function(){return e.input.annotations.filter(F.isUnlocked).some(t)||e.input.measurements.filter(F.isUnlocked).some(t)||e.input.orthophotos.filter(F.isUnlocked).some(t)||e.input.scans.filter(F.isUnlocked).some(t)},e.hasLocked=function(){return e.input.annotations.some(F.isLocked)||e.input.measurements.some(F.isLocked)||e.input.orthophotos.some(F.isLocked)||e.input.scans.some(F.isLocked)},e.hasUnlocked=function(){return e.input.annotations.some(F.isUnlocked)||e.input.measurements.some(F.isUnlocked)||e.input.orthophotos.some(F.isUnlocked)||e.input.scans.some(F.isUnlocked)},e.length=function(){return e.input.annotations.length+e.input.measurements.length+e.input.orthophotos.length+e.input.scans.length}},execute:function(e){var t="public"==e.share,i=t&&"readWrite"==e.readWrite,n=e.annotations.concat(e.measurements,e.orthophotos,e.scans);return Q.allSettled(n.filter(F.isUnlocked).map(function(e){return e._changes._readPublic=t,e._changes._writePublic=i,e.hasUnsavedChanges()?e.update().then(function(){return e}):Q.resolve(e)})).then(function(e){var t={};return e.forEach(function(e){"rejected"==e.state&&(t[e.reason.message]=!0)}),new WS.TaskResult(Object.keys(t))})}},WS.extend("ShareTask","Task"),WS.mixin("ShareTask","SelectionTask"),F.DI().config("@task",function(e){e.registerTaskFactory("default","object","share",WS.ShareTask,"@plug","@login"),e.registerTaskFactory("default","panoramaview","share",WS.ShareTask,"@plug","@login"),e.registerTaskFactory("default","overviewmap","share",WS.ShareTask,"@plug","@login")}),WS.OrthoPhotoTask=function(e,t,i,n,o,r,a,s,c,l,h){WS.Task.call(this,e),this._point3d=t,this._orthophoto=i,this._tempOrthophoto=n,this._jobQueue=o,this._cat=r,this._tag=a,this._layer=s,this._projectService=c,this._unit=l,this._project=void 0,this._viewType=h,this._tempPhoto=void 0;var d="input.scans.length > 0",u={startCondition:d};this._descriptionCommon=[{caption:"TC_SET_RESOLUTION",description:"TD_SET_RESOLUTION",widget:'<p class="f_textBold">{{"FE_PANO_SET_PREF_RES" | i18n}}</p><div class="input-group" style="margin-top:1px; margin-bottom:5px;"><unitedit class="f_textInline" inverse="true" unitcaption="px" unitclass="unitclass" unit="unit" model="input.scale" precision="2" change="scaleChange()" icon="resolution.png" ng-focus="setWatch(\'scale\')" ng-blur="removeWatch()"></unitedit></div><p class="f_textBold" style="margin-top:15px;">{{"FE_IMG_DIMENSIONS" | i18n}}</p><div class="input-group"><div class="input-group-addon" style="max-width: 50px;padding-left: 8px;"><img class="f_icon32" static-src="icons/imgwidth.png"/></div><input class="form-control" type="number" min="1" step="1" ng-model="input.imgWidthPx" ng-change="widthPxChange()"><div class="input-group-addon">px</div></div><div class="input-group" style="margin-top:1px; margin-bottom:5px;"><div class="input-group-addon" style="max-width: 50px;padding-left: 8px;"><img class="f_icon32" static-src="icons/imgheight.png"/></div><input class="form-control" type="number" min="1" step="1" ng-model="input.imgHeightPx" ng-change="heightPxChange()"><div class="input-group-addon">px</div></div><p>{{"FE_EST_FILESIZE" | i18n}}: {{ getFileSizeEstimate() }}&nbsp;{{"FE_MEGABYTES" | i18n}}</p><alert type="warning" ng-if="input.imgWidthPx < minImgLengthPx">{{"FE_IMG_WIDTH_TOO_SMALL" | i18n}}. {{"FE_MIN_IS" | i18n}}: {{minImgLengthPx}}&nbsp;px</alert><alert type="warning" ng-if="input.imgWidthPx > maxImgLengthPx">{{"FE_IMG_WIDTH_TOO_BIG" | i18n}}. {{"FE_MAX_IS" | i18n}}: {{maxImgLengthPx}}&nbsp;px</alert><alert type="warning" ng-if="input.imgHeightPx < minImgLengthPx">{{"FE_IMG_HEIGHT_TOO_SMALL" | i18n}}. {{"FE_MIN_IS" | i18n}}: {{minImgLengthPx}}&nbsp;px</alert><alert type="warning" ng-if="input.imgHeightPx > maxImgLengthPx">{{"FE_IMG_HEIGHT_TOO_BIG" | i18n}}. {{"FE_MAX_IS" | i18n}}: {{maxImgLengthPx}}&nbsp;px</alert><alert type="warning" ng-if="input.imgWidthPx * input.imgHeightPx > maxImgAreaPx && input.imgWidthPx <= maxImgLengthPx && input.imgHeightPx <= maxImgLengthPx">{{"FE_IMG_SIZE_TOO_BIG" | i18n}}. {{"FE_MAX_IS" | i18n}}: {{maxImgAreaMPx}}&nbsp;{{"FE_MPIXEL" | i18n}}</alert>',icon:WS.Icons.TaskSection.resolution,optional:!0,startCondition:d,completeCondition:"input.scale > 0 && input.imgWidthPx  >= minImgLengthPx && input.imgWidthPx  <= maxImgLengthPx && input.imgHeightPx >= minImgLengthPx && input.imgHeightPx <= maxImgLengthPx && input.imgWidthPx * input.imgHeightPx <= maxImgAreaPx"},{caption:"TC_SET_COLORMODE",description:"TD_SET_COLORMODE",widget:'<div ng-repeat="mode in availColorModes" class="btn-group"><button class="btn btn-default" title="{{mode.str | i18n}}" ng-click="setColorMode(mode.id)" ng-class="{\'btn-info\': input.colorMode == mode.id}" style="padding-top:0; padding-bottom:0; margin-bottom:5px;"><img class="f_icon32" static-src="{{mode.icon}}"/><div style="width:170px; display: inline-block;">{{mode.str | i18n}}</div></button></div><p>{{"FE_EST_FILESIZE" | i18n}}: {{ getFileSizeEstimate() }}&nbsp;{{"FE_MEGABYTES" | i18n}}</p>',icon:WS.Icons.TaskSection.colormode,optional:!0,startCondition:d},{caption:"TC_GAPFILLER",description:"TD_GAPFILLER",widget:'<checkbox target="input.gapFiller" source="input.gapFiller" name="{{\'TD_CB_GAPFILLER\' | i18n }}"></checkbox>',icon:WS.Icons.TaskSection.gapfiller,optional:!0,startCondition:d},this.getNameStep({startCondition:d,completeCondition:"input.name.length == 0 || !validateName(input.name)"}),this.getDescriptionStep(u),this.getHyperlinkStep(u),this.getCategoryStep(u),this.getTagStep(u)]},WS.OrthoPhotoTask.prototype={getSelectScansStep:function(e){return this.getSelectionStep(F.mergeObjects({caption:"TC_SELECT_SCANS",description:"TD_ORTHO_SELECT_SCANS",pageConfiguration:{selection:"scan",mode:WS.ViewBase.Mode.SelectObjects},select:"Scan",selection:"input.scans",selectionIcon:void 0,selectionIconShow:void 0,completeCondition:"input.scans && input.scans.length > 0"},e||{}))},setup:function(e){var t=this;this.scope=e,this._finished=!1,this.setupNameStep(),this.setupHyperlinkStep(),this.setupCategoryTagSteps(),this._tempPhoto=this._tempOrthophoto.getNew(),this._tempPhoto.create(),this._projectService.getCurrentProject().then(function(e){t._project=e}),e.Math=Math,e.availColorModes={Color:{id:"Color",str:"FE_PREFER_COLOR",icon:"icons/color.png",bytesPerPx:2},Gray:{id:"Gray",str:"FE_PREFER_GRAY",icon:"icons/gray.png",bytesPerPx:1.5},PseudoDistance:{id:"PseudoDistance",str:"FE_COLORIZE_BY_DISTANCE",icon:"icons/pseudocolor.png",bytesPerPx:2}},e.input.colorMode="Color",e.setColorMode=function(t){e.input.colorMode=t},e.input.gapFiller=!0;var i="icons/colordot-";e.colordotIcons=[i+"27b.png",i+"fb0.png",i+"d22.png"],e.getFileSizeEstimate=function(){var t=e.input,i=t.imgWidthPx,n=t.imgHeightPx,o=e.availColorModes[t.colorMode].bytesPerPx;return void 0!==i&&void 0!==n?(i*n/1e6*o).toFixed(2):"0"},e.scaleChange=function(){var t=e.input.scale;void 0!==t?(e.input.imgWidthPx=Math.ceil(e.input.imgWidth*t),e.input.imgHeightPx=Math.ceil(e.input.imgHeight*t)):e.input.imgWidthPx=e.input.imgHeightPx=void 0},e.widthPxChange=function(){e.input.imgWidthPx=Math.ceil(e.input.imgWidthPx),e.input.scale=e.input.imgWidthPx/e.input.imgWidth,e.input.imgHeightPx=Math.ceil(e.input.imgHeight*e.input.scale)},e.heightPxChange=function(){e.input.imgHeightPx=Math.ceil(e.input.imgHeightPx),e.input.scale=e.input.imgHeightPx/e.input.imgHeight,e.input.imgWidthPx=Math.ceil(e.input.imgWidth*e.input.scale)},e.minImgLengthWorld=.099,e.minImgLengthPx=64,e.maxImgLengthPx=1e6,e.maxImgAreaPx=1e9,e.maxImgAreaMPx=Math.round(e.maxImgAreaPx/1e6),e.minDistanceNearFar=.0099,e.input.tags=[],e.input.category="",e.setSelectionTool=function(e,i){t.setActiveSection(i)},e.getPosInCS=function(e){return e?t._project._trafo&&t._unit.isCustomCS()?mat4.posInRefSystem(e,t._project._trafo):e:void 0}},canShowOrthophoto:function(){},prepareOrthophoto:function(e,t){this.prepareOrthophotoImpl(t,e.pickedPoints[0]._positionGlobal,e.pickedPoints[1]._positionGlobal,e.pickedPoints[2]._positionGlobal,e.scale,e.minDepth,e.maxDepth,e.scans,e.colorMode,e.focusable)},prepareOrthophotoImpl:function(e,t,i,n,o,r,a,s,c,l){o=o||80;var h=vec3.create(t),d=vec3.create(i),u=vec3.create(n),p=vec3.subtract(d,h,vec3.create()),_=vec3.subtract(u,h,vec3.create()),g=vec3.length(p);vec3.normalize(p);var f=vec3.cross(p,_,vec3.create());vec3.normalize(f);var m=vec3.cross(f,p,vec3.create()),v=mat3.createFrom(p[0],p[1],p[2],m[0],m[1],m[2],f[0],f[1],f[2]);mat3.transpose(v);var S=mat3.toMat4(v),b=mat4.identity();b[12]=-h[0],b[13]=-h[1],b[14]=-h[2],mat4.multiply(S,b),S=Array.prototype.slice.call(S);var y=parseFloat(o),P=Math.ceil(g*y),C=mat4.multiplyVec3(S,u,vec3.create()),w=Math.ceil(C[1]*y),T=Math.min(r,a),M=Math.max(r,a);e._trafoGlobal=mat4.invertOrtho(S,new Array(16)),e._width=P,e._height=w,e._scale=y,e._minDepth=T,e._maxDepth=M,e._scanUUIDs=(s||[]).map(function(e){return e._UUID}),e._colorMode=c,e._focusable=l||!1;var W=this.$scope.input;W.name&&(e._displayName=W.name),e._description=W.description,e._category=W.category,e._tags=W.tags,e._hyperlinks=W.hyperlinkObjects},updateTempPhoto:function(e){this.canShowOrthophoto()?this.prepareOrthophoto(e.input,this._tempPhoto):this._tempPhoto._trafoGlobal=void 0,this._tempPhoto.update()},execute:function(e){var t=this,i=this._orthophoto.getNew();return this.prepareOrthophoto(e,i),i._gapFiller=e.gapFiller,i.create().then(function(){return t._jobQueue.getAll(),i._service._filter(i)?t.isOrthophotoVisible(i)?void 0:new WS.TaskResult([],["IM_HIDDEN_OBJECT"]):new WS.TaskResult([],["IM_FILTERED_OBJECT"])},function(e){return new WS.TaskResult([e?e.message:"EM_UNKNOWN_ERROR"],[],!0)})},teardown:function(){this.triggerAndDestroy("setPickedPoints",[[]]),this._finished=!0,this._tempPhoto.remove()},queryTaskLaunch:function(e,t){return"default"==e&&("panoramaview"==t||"overviewmap"==t||"object"==t)},isOrthophotoVisible:function(){return this._layer.isLayerVisible(WS.Layer.LayerIDs.ORTHOPHOTOS,this._viewType)}},WS.extend("OrthoPhotoTask","Task"),WS.mixin("OrthoPhotoTask","SelectionTask"),WS.mixin("OrthoPhotoTask","ModelTask"),WS.OrthoPhotoTask.DOT_COLORS=[.172,.482,.713,1,.98,.709,.007,1,.843,.098,.109,1],WS.OrthoPhotoTask.DOT_BORDER_COLORS=[0,0,0,1,0,0,0,1,0,0,0,1],WS.OrthoPhotoMapTask=function(e,t,i,n,o,r,a,s,c,l){WS.OrthoPhotoTask.call(this,e,t,i,n,o,r,a,s,c,l,WS.Layer.ViewTypes.OVERVIEW_MAP);var h='<div class="btn-group"><button ng-click="rotateImage(false)" ng-disabled="!(input.imgWidth >= minImgLengthWorld && input.imgHeight >= minImgLengthWorld)" class="btn btn-default f_btnAutoWidth" title="{{\'FE_ROTATE_IMG\'|i18n}}"><img class="f_icon32" static-src="icons/rotate-ccw.png" style="margin-top:-3px;"/></button> <button ng-click="rotateImage(true)"  ng-disabled="!(input.imgWidth >= minImgLengthWorld && input.imgHeight >= minImgLengthWorld)" class="btn btn-default f_btnAutoWidth" title="{{\'FE_ROTATE_IMG\'|i18n}}"><img class="f_icon32" static-src="icons/rotate-cw.png"  style="margin-top:-3px;"/></button></div><div class="btn-group" style="margin-left:26px;"><button ng-click="setBirdsEye(true)"  class="btn btn-default f_btnAutoWidth" ng-class="{\'btn-info\':  input.birdsEye}" title="{{\'FE_TOP_DOWN_VIEW\'|i18n}}"><img class="f_icon16" static-src="icons/camera-d.png" style="margin-top:-3px;"/></button> <button ng-click="setBirdsEye(false)" class="btn btn-default f_btnAutoWidth" ng-class="{\'btn-info\': !input.birdsEye}" title="{{\'FE_BOTTOM_UP_VIEW\'|i18n}}"><img class="f_icon16" static-src="icons/camera-u.png"  style="margin-top:-3px;"/></button></div>';this._description=[{caption:"TC_CHOOSE_TYPE",description:"TD_CHOOSE_ORTHOPHOTO_TYPE",widget:'<div class="btn-group"><button class="btn btn-default" title="{{\'FE_FACADE_VIEW\'|i18n}}" ng-click="setMode(\'facade\')" ng-disabled="input.mode.id" ng-class="{\'btn-info\': input.mode.id === \'facade\'}" style="padding-top: 0;padding-bottom: 0;margin-bottom: 5px;"><img class="f_icon32" static-src="icons/facade.png"/><div style="width:170px; display: inline-block;">{{"FE_FACADE_VIEW"|i18n}}</div></button></div><div class="btn-group"><button class="btn btn-default" title="{{\'FE_GROUND_VIEW\'|i18n}}"ng-click="setMode(\'groundview\')" ng-disabled="input.mode.id" ng-class="{\'btn-info\': input.mode.id === \'groundview\'}" style="padding-top: 0;padding-bottom: 0;margin-bottom: 5px;"><img class="f_icon32" static-src="icons/groundview.png"/><div style="width:170px; display: inline-block;">{{"FE_GROUND_VIEW"|i18n}}</div></button></div>',icon:WS.Icons.TaskSection.choice,selectPageClass:"overviewmap",pageConfiguration:{mode:WS.ViewBase.Mode.PickPolygon},completeCondition:"taskFlow.modeSelected"},{caption:"TC_DEFINE_IMG",description:"TD_ORTHO_DEF_IMG_PLANE_FACADE",widget:'<p ng-show="input.pickedPoints.length > 0" class="f_textSM"><b>{{"FE_SELECTED_POINTS_1" | i18n}}</b></p><div ng-repeat="point in input.pickedPoints2"><div class="btn-group" style="margin-bottom:10px;"><button ng-disabled="!hasEnoughPoints()" ng-click="toggleEditPoint($index)" class="btn btn-default f_textS" style="height: 25px; padding-top: 0px; width:225px;" ng-class="{\'btn-info\': isEditingPoint($index)}" title="{{\'FE_EDIT\' | i18n}}"><div style="text-align: center; width: 189px; display: inline-block;"><img class="f_icon24" static-src="{{colordotIcons[$index]}}"/><span>{{getPosInCS(point._positionGlobal) | pos}}</span></div><img ng-if="$index != editPointIndex" class="f_icon24" static-src="icons/pickpoint.png"/><img ng-if="$index == editPointIndex" class="f_icon24" static-src="icons/im/checked_true.png"/></button></div></div><div ng-if="hasEnoughPoints()"><button ng-click="flipDirection()" class="btn btn-default f_btnAutoWidth" style="margin-top: 10px;" title="{{\'FE_FLIP_CAM_DIRECTION\'|i18n}}"><img class="f_icon16" static-src="icons/camera-l.png" style="width:auto;"/><img class="f_icon24" static-src="icons/arrows-lr.png" style="width:auto; margin-left:8px; margin-right:8px;"/><img class="f_icon16" static-src="icons/camera-r.png" style="width:auto;"/></button></div><alert type="info" ng-if="!hasEnoughPoints()">{{"FE_PTS_REQUIRED" | i18n}}: {{input.mode.numPts - input.pickedPoints.length}}</alert><alert type="info" ng-if=" hasEnoughPoints() && input.imgWidth < minImgLengthWorld">{{"FE_IMG_WIDTH_TOO_SMALL" | i18n}}.</alert>',icon:WS.Icons.TaskSection.volumewidth2,female:"PointPick3D",pinBinding:"pickPoint(input.pickedPoint)",selectPageClass:"overviewmap",pageConfiguration:{mode:WS.ViewBase.Mode.PickPolygon},startCondition:'input.mode.id === "facade"',completeCondition:"input.imgWidth >= minImgLengthWorld && hasEnoughPoints() && taskFlow.planeDefined"},{caption:"TC_DEFINE_IMG",description:"TD_ORTHO_DEF_IMG_PLANE_3PTS",widget:'<p class="f_textSM"><b>{{"FE_IMG_WIDTH" | i18n}} / {{"FE_X_AXIS" | i18n}}:</b></p><div ng-repeat="point in input.pickedPoints2"><div class="btn-group" style="margin-bottom:10px;"><button ng-disabled="!hasEnoughPoints()" ng-click="toggleEditPoint($index)" class="btn btn-default f_textS" style="height: 25px; padding-top: 0px; width:225px;" ng-class="{\'btn-info\': isEditingPoint($index)}" title="{{\'FE_EDIT\' | i18n}}"><div style="text-align: center; width: 189px; display: inline-block;"><img class="f_icon24" static-src="{{colordotIcons[$index]}}"/><span>{{getPosInCS(point._positionGlobal) | pos}}</span></div><img ng-if="$index != editPointIndex" class="f_icon24" static-src="icons/pickpoint.png"/><img ng-if="$index == editPointIndex" class="f_icon24" static-src="icons/im/checked_true.png"/></button></div></div><div><p class="f_textSM"><b>{{"FE_IMG_HEIGHT" | i18n}}:</b></p><div class="btn-group" style="margin-top:1px; margin-bottom:5px;"><unitedit class="f_textInline" style="float:left; max-width:184px;" unitclass="unitclass" unit="unit" model="input.groundviewHeight" precision="2" change="groundviewHeightChange()" icon="imgheight.png"></unitedit><button ng-disabled="!hasEnoughPoints()" ng-click="toggleEditPoint(2)" class="btn btn-default" ng-class="{\'btn-info\': isEditingPoint(2)}" style="height: 34px;width: 34px; padding:0; float:right; margin-left: 6px; border-top-left-radius: 3px; border-bottom-left-radius: 3px" title="{{\'FE_EDIT\' | i18n}}"><img ng-if="2 != editPointIndex" class="f_icon24" static-src="icons/pickpoint.png"/><img ng-if="2 == editPointIndex" class="f_icon24" static-src="icons/im/checked_true.png"/></button></div></div><div ng-if="hasEnoughPoints()" style="margin-top:20px; margin-bottom:5px;">'+h+'</div><alert type="info" ng-if="!hasEnoughPoints()">{{"FE_PTS_REQUIRED" | i18n}}: {{input.mode.numPts - input.pickedPoints.length}}</alert><alert type="info" ng-if=" hasEnoughPoints() && input.imgWidth < minImgLengthWorld">{{"FE_IMG_WIDTH_TOO_SMALL" | i18n}}.</alert><alert type="info" ng-if=" hasEnoughPoints() && input.imgHeight < minImgLengthWorld">{{"FE_IMG_HEIGHT_TOO_SMALL" | i18n}}.</alert>',icon:WS.Icons.TaskSection.volumewidth2,female:"PointPick3D",pinBinding:"pickPoint(input.pickedPoint)",selectPageClass:"overviewmap",pageConfiguration:{mode:WS.ViewBase.Mode.PickPolygon},startCondition:'input.mode.id == "groundview"',completeCondition:"hasEnoughPoints() && input.imgWidth >= minImgLengthWorld && input.imgHeight >= minImgLengthWorld"},{caption:"TC_ORTHO_ADJ_DEPTH",description:"TD_ORTHO_ADJ_DEPTH",widget:'<div class="input-group" style="margin-top:1px; margin-bottom:5px;"><unitedit class="f_textInline" unitclass="unitclass" unit="unit" model="input.maxDepth" precision="2" change="" icon="frustum_back.png"></unitedit></div><div class="input-group" style="margin-top:1px; margin-bottom:5px;"><unitedit class="f_textInline" unitclass="unitclass" unit="unit" model="input.minDepth" precision="2" change="" icon="frustum_front.png"></unitedit></div><alert type="info" ng-if="input.minDepth !== undefined && input.maxDepth !== undefined && Math.abs(-input.minDepth - input.maxDepth) < minDistanceNearFar">{{"FE_RANGE_TOO_SMALL_NO_PTS" | i18n}}.</alert>',icon:WS.Icons.TaskSection.volumedepth2,selectPageClass:"overviewmap",pageConfiguration:{mode:WS.ViewBase.Mode.PickPolygon},startCondition:'input.mode.id == "facade" && taskFlow.planeDefined',optional:!0,completeCondition:"input.minDepth !== undefined && input.maxDepth !== undefined && Math.abs(-input.minDepth - input.maxDepth) >= minDistanceNearFar"},this.getSelectScansStep({toolbarWidget:'<tasktoolbar toolbar="viewselectiontoolbar" model="section._pageConfiguration.mode" onchange="setSelectionTool(value, section)"></tasktoolbar><alert type="info" ng-if="input.scans.length < 1">{{"FE_SCANS_REQUIRED" | i18n }}: {{1 - input.scans.length}}</alert><alert type="info" ng-if="input.scans.length > 20">{{"FE_SCANS_HIGH_NO" | i18n }}</alert>',startCondition:"taskFlow.planeDefined"}),{_isSetElevationStep:!0,caption:"TC_SET_ELEVATION",description:"TD_SET_ELEVATION_FACADE",widget:'<div class="btn-group" style="margin-top:1px; margin-bottom:5px;"><unitedit class="f_textInline" style="float:left; max-width:184px;" unitclass="unitclass" unit="unit" model="input.top" precision="2" change="" icon="img_top.png"></unitedit><button ng-click="toggleEditHeight(\'top\')" class="btn btn-default" ng-class="{\'btn-info\': \'top\' === editHeightId}" style="height: 34px;width: 34px; padding:0; float:right; margin-left: 6px; border-top-left-radius: 3px; border-bottom-left-radius: 3px" title="{{\'FE_PICK_POINT_TOP\' | i18n}}"><img ng-if="\'top\' !== editHeightId" class="f_icon24" static-src="icons/pickpoint.png"/><img ng-if="\'top\' === editHeightId" class="f_icon24" static-src="icons/im/checked_true.png"/></button></div><div class="btn-group" style="margin-top:1px; margin-bottom:5px;"><unitedit class="f_textInline" style="float:left; max-width:184px;" unitclass="unitclass" unit="unit" model="input.bottom" precision="2" change="" icon="img_bottom.png"></unitedit><button ng-click="toggleEditHeight(\'bottom\')" class="btn btn-default" ng-class="{\'btn-info\': \'bottom\' === editHeightId}" style="height: 34px;width: 34px; padding:0; float:right; margin-left: 6px; border-top-left-radius: 3px; border-bottom-left-radius: 3px" title="{{\'FE_PICK_POINT_BOTTOM\' | i18n}}"><img ng-if="\'bottom\' !== editHeightId" class="f_icon24" static-src="icons/pickpoint.png"/><img ng-if="\'bottom\' === editHeightId" class="f_icon24" static-src="icons/im/checked_true.png"/></button></div><p>{{"FE_CUR_TOTAL_HEIGHT" | i18n}}: {{input.imgHeight | unit:2}}</p><alert type="warning" ng-if="viewUnavailableWarning === true">{{\'FE_POINT_PICK_ONLY_PV\' | i18n}}</alert><alert type="warning" ng-if="input.top !== undefined && input.bottom !== undefined && input.imgHeight < minImgLengthWorld">{{"FE_IMG_HEIGHT_TOO_SMALL" | i18n}}.</alert>',icon:WS.Icons.TaskSection.volumeheight2,female:"PointPick3D",pinBinding:"pickPoint(input.pickedHeight)",pageConfiguration:{selection:"scan",mode:WS.ViewBase.Mode.PickPointOpenScans},startCondition:'input.mode.id === "facade" && input.scans.length > 0',completeCondition:"input.top !== undefined && input.bottom !== undefined && input.imgHeight >= minImgLengthWorld && taskFlow.seenElevation"},{_isSetElevationStep:!0,caption:"TC_SET_ELEVATION",description:"TD_SET_ELEVATION_GVIEW",widget:'<div class="btn-group" style="margin-top:1px; margin-bottom:5px;"><unitedit class="f_textInline" style="float:left; max-width:184px;" unitclass="unitclass" unit="unit" model="input.maxDepth" precision="2" change="" icon="height_max.png"></unitedit><button ng-click="toggleEditHeight(\'maxDepth\')" class="btn btn-default" ng-class="{\'btn-info\': \'maxDepth\' === editHeightId}" style="height: 34px;width: 34px; padding:0; float:right; margin-left: 6px; border-top-left-radius: 3px; border-bottom-left-radius: 3px" title="{{\'FE_PICK_POINT_TOP\' | i18n}}"><img ng-if="\'maxDepth\' !== editHeightId" class="f_icon24" static-src="icons/pickpoint.png"/><img ng-if="\'maxDepth\' === editHeightId" class="f_icon24" static-src="icons/im/checked_true.png"/></button></div><div class="btn-group" style="margin-top:1px; margin-bottom:5px;"><unitedit class="f_textInline" style="float:left; max-width:184px;" unitclass="unitclass" unit="unit" model="input.minDepth" precision="2" change="" icon="height_min.png"></unitedit><button ng-click="toggleEditHeight(\'minDepth\')" class="btn btn-default" ng-class="{\'btn-info\': \'minDepth\' === editHeightId}" style="height: 34px;width: 34px; padding:0; float:right; margin-left: 6px; border-top-left-radius: 3px; border-bottom-left-radius: 3px" title="{{\'FE_PICK_POINT_BOTTOM\' | i18n}}"><img ng-if="\'minDepth\' !== editHeightId" class="f_icon24" static-src="icons/pickpoint.png"/><img ng-if="\'minDepth\' === editHeightId" class="f_icon24" static-src="icons/im/checked_true.png"/></button></div><p>{{"FE_CUR_TOTAL_HEIGHT" | i18n}}: {{Math.abs(input.minDepth - input.maxDepth) | unit:2}}</p><div ng-if="hasEnoughPoints()" style="margin-top:20px; margin-bottom:5px;">'+h+'</div><alert type="warning" ng-if="viewUnavailableWarning === true">{{\'FE_POINT_PICK_ONLY_PV\' | i18n}}</alert><alert type="warning" ng-if="input.minDepth !== undefined && input.maxDepth !== undefined && (input.maxDepth-input.minDepth) < minDistanceNearFar">{{"FE_RANGE_TOO_SMALL_NO_PTS" | i18n}}.</alert>',icon:WS.Icons.TaskSection.volumeheight2,female:"PointPick3D",pinBinding:"pickPoint(input.pickedHeight)",pageConfiguration:{selection:"scan",mode:WS.ViewBase.Mode.PickPointOpenScans},startCondition:'input.mode.id === "groundview" && input.scans.length > 0',completeCondition:"input.minDepth !== undefined && input.maxDepth !== undefined && (input.maxDepth-input.minDepth) >= minDistanceNearFar && taskFlow.seenElevation"}],this._description=this._description.concat(this._descriptionCommon)},WS.OrthoPhotoMapTask.prototype={canShowOrthophoto:function(){var e=this.$scope.input;return"facade"===e.mode.id?void 0!==e.top&&void 0!==e.bottom&&this.$scope.hasEnoughPoints()&&this.$scope.pointsReady():"groundview"===e.mode.id?e.imgHeight>1e-4&&void 0!==e.minDepth&&void 0!==e.maxDepth&&this.$scope.hasEnoughPoints()&&this.$scope.pointsReady():!1},prepareOrthophoto:function(e,t){var i,n,o;if("facade"===e.mode.id){e.facadeCamFlipped?(i=vec3.create(e.pickedPoints[1]._positionGlobal),n=vec3.create(e.pickedPoints[0]._positionGlobal)):(i=vec3.create(e.pickedPoints[0]._positionGlobal),n=vec3.create(e.pickedPoints[1]._positionGlobal)),o=vec3.create(n);var r=Math.max(e.top,e.bottom),a=Math.min(e.top,e.bottom);i[2]=r,n[2]=r,o[2]=a,this.prepareOrthophotoImpl(t,i,n,o,e.scale,-e.minDepth,e.maxDepth,e.scans,e.colorMode,e.focusable)}else if("groundview"===e.mode.id){i=vec3.create(e.pickedPoints[0]._positionGlobal),n=vec3.create(e.pickedPoints[1]._positionGlobal),o=vec3.create(e.pickedPoints[2]._positionGlobal),i[2]=n[2]=o[2]=e.birdsEye?e.minDepth:e.maxDepth;var s=vec2.subtract(n,i,vec2.create()),c=vec2.subtract(o,i,vec2.create()),l=(e.birdsEye?-1:1)*vec2.cross(s,c);if(0>l){var h=i;i=n,n=h}this.prepareOrthophotoImpl(t,i,n,o,e.scale,0,e.minDepth-e.maxDepth,e.scans,e.colorMode,e.focusable)}},setup:function(e){WS.OrthoPhotoTask.prototype.setup.call(this,e);var t=this;e.unit=this._unit.getLengthUnit(),e.input.pickedPoints=[],e.input.facadeCamFlipped=!1,e.input.minDepth=1,e.input.maxDepth=1,e.input.top=10,e.input.bottom=-10,e.input.scale=80,e.input.birdsEye=!0,e.input.groundviewHeight=0,e.input.imgWidth=25,e.input.imgHeight=40,e.input.imgHeightPx=e.input.imgHeight*e.input.scale,e.input.imgWidthPx=e.input.imgWidth*e.input.scale,e.input.scans=[],e.input.mode={id:void 0,numPts:void 0},e.taskFlow={modeSelected:!1,planeDefined:!1,seenElevation:!1},e.setMode=function(i){if(!e.input.mode.id)switch(i){case"facade":e.input.mode.id=i,e.input.mode.numPts=2,e.taskFlow.modeSelected=!0,t.setActiveSection(t._sections[1]);break;case"groundview":e.input.mode.id=i,e.input.mode.numPts=3,e.taskFlow.modeSelected=!0,t.setActiveSection(t._sections[2])}},e.$watch("input.pickedHeight",function(i){var n=e.editHeightId;if(void 0!==n){var o=i;t._point3d.determine3DCoords(o).then(function(){t._finished||o._pointState===WS.Point3d.PointState.Valid&&t.scope.$apply(function(){switch(n){case"top":case"bottom":case"minDepth":case"maxDepth":e.input[n]=o._positionGlobal[2]}})},function(){e.$apply(function(){o._pointState=WS.Point3d.PointState.Invalid})}).done()}});var i=function(){e.input.imgHeight=void 0!==e.input.top&&void 0!==e.input.bottom?Math.abs(e.input.top-e.input.bottom):void 0,e.scaleChange(),t.updateTempPhoto(e)};e.$watch("input.top",i),e.$watch("input.bottom",i),e.$watch("input.scans.length",function(){if(e.input.mode.id&&!e.taskFlow.seenElevation){var i=0;if(e.input.focusable=e.input.scans.length>0,e.input.scans.length>0){for(var n=0;n<e.input.scans.length;n++)i+=e.input.scans[n]._trafoGlobal[14];i/=e.input.scans.length}var o=i-5,r=i+5;"facade"===e.input.mode.id?(e.input.bottom=o,e.input.top=r):(e.input.minDepth=o,e.input.maxDepth=r),t.updateTempPhoto(e)}}),e.$watch("task._activeSection",function(t){e.editPointIndex=e.editHeightId=void 0,t&&t._source&&t._source._isSetElevationStep&&(e.taskFlow.seenElevation=!0)});var n=function(){var i=e.input.pickedPoints.slice(0,2),n=4*i.length,o=WS.OrthoPhotoTask.DOT_COLORS.slice(0,n),r=WS.OrthoPhotoTask.DOT_BORDER_COLORS.slice(0,n);t.trigger("setPickedPoints",[i,!1,void 0,o,r,8,11])};e.$watch("input.pickedPoint",function(i){if(i&&i._takenInView._type===WS.OverviewMap.type){var o,r=e.input.pickedPoints,a=e.editPointIndex;i&&void 0!==a?(o=i,o._pointState=WS.Point3d.PointState.Valid,o._positionGlobal=o._estimatedPosition,r[a]=o):i&&e.input.pickedPoints.length<e.input.mode.numPts&&(o=i,o._pointState=WS.Point3d.PointState.Valid,o._positionGlobal=o._estimatedPosition,r.push(o),a=r.length-1),e.input.pickedPoints2=e.input.pickedPoints.concat({},{}).slice(0,2),r.length>=2&&(e.input.imgWidth=vec2.dist(r[0]._positionGlobal,r[1]._positionGlobal),e.scaleChange()),"groundview"===e.input.mode.id&&(3===r.length?2===a?e.groundviewCalcHeight():(e.input.groundviewHeight=e.input.groundviewHeight||.01,e.groundviewCalc3rdPoint()):2===r.length&&(e.input.groundviewHeight||(e.input.imgHeight=e.input.groundviewHeight=.6*e.input.imgWidth,e.editPointIndex=2),e.groundviewCalc3rdPoint())),t.updateTempPhoto(e),n()}}),e.groundviewCalc3rdPoint=function(){var t=e.input,i=t.pickedPoints.map(function(e){return e._positionGlobal}),n=vec2.subtract(i[0],i[1],vec2.create());vec2.normalize(n);var o=vec3.createFrom(-n[1],n[0],0);vec3.scale(o,t.groundviewHeight);var r=vec3.add(i[0],o,vec3.create());t.pickedPoints.length<3&&t.pickedPoints.push(new WS.Point3d(r,[0,0],t.pickedPoints[0]._refSystem,t.pickedPoints[0]._takenInView)),t.pickedPoints[2]._positionGlobal=r,t.pickedPoints[2]._pointState=WS.Point3d.PointState.Valid},e.groundviewCalcHeight=function(){var t=e.input,i=t.pickedPoints.map(function(e){return e._positionGlobal}),n=vec2.subtract(i[0],i[1],vec2.create());vec2.normalize(n);
var o=vec2.createFrom(-n[1],n[0]),r=vec2.subtract(i[2],i[0],vec2.create());t.groundviewHeight=vec2.dot(r,o)},e.groundviewHeightChange=function(){var i=e.input;i.pickedPoints.length>=2&&(e.groundviewCalc3rdPoint(),t.updateTempPhoto(e))},e.$watch("input.groundviewHeight",function(){e.input.imgHeight=void 0!==e.input.groundviewHeight?Math.abs(e.input.groundviewHeight):void 0,e.scaleChange()}),e.toggleEditHeight=function(i){return i===e.editHeightId?(e.editHeightId=void 0,void(e.viewUnavailableWarning=!1)):void(t.getPageBox().isPageVisible("pv")?(e.editHeightId=i,e.viewUnavailableWarning=!1):(e.editHeightId=void 0,e.viewUnavailableWarning=!0))},e.isEditingPoint=function(t){return t===e.editPointIndex||void 0===e.editPointIndex&&t===e.input.pickedPoints.length},e.toggleEditPoint=function(t){e.editPointIndex=t===e.editPointIndex?void 0:t},e.hasEnoughPoints=function(){return e.input.mode.numPts<=e.input.pickedPoints.length?(e.taskFlow.planeDefined="facade"===e.input.mode.id?e.input.imgWidth>=e.minImgLengthWorld:!0,!0):(e.taskFlow.planeDefined=!1,!1)},e.flipDirection=function(){e.input.facadeCamFlipped=!e.input.facadeCamFlipped;var i=e.input.minDepth;e.input.minDepth=e.input.maxDepth,e.input.maxDepth=i,e.editPointIndex=void 0,t.updateTempPhoto(e)},e.setBirdsEye=function(i){e.input.birdsEye=i,e.editPointIndex=void 0,e.editHeightId=void 0,t.updateTempPhoto(e)},e.rotateImage=function(i){var o=e.input;o.groundviewHeight<0&&(i=!i);var r=o.pickedPoints[0]._positionGlobal,a=o.pickedPoints[1]._positionGlobal,s=vec2.subtract(r,a,vec2.create());vec2.normalize(s);var c=vec3.createFrom(-s[1],s[0],0);vec2.scale(c,o.groundviewHeight),i?(o.pickedPoints[0]._positionGlobal=a,o.pickedPoints[1]._positionGlobal=vec3.add(a,c,[0,0,0]),o.pickedPoints[2]._positionGlobal=r):(o.pickedPoints[0]._positionGlobal=vec3.add(r,c,[0,0,0]),o.pickedPoints[1]._positionGlobal=r,o.pickedPoints[2]._positionGlobal=a),o.pickedPoints.forEach(function(e){e._estimatedPosition=e._positionLocal=e._positionGlobal});var l=o.imgHeight;e.groundviewCalcHeight(),o.imgWidth=l,e.scaleChange(),e.editPointIndex=void 0,e.editHeightId=void 0,t.updateTempPhoto(e),n()},e.pointsReady=function(){return e.input.pickedPoints.every(function(e){return e._positionGlobal&&e._pointState===WS.Point3d.PointState.Valid})};var o=function(){t.updateTempPhoto(e)};e.$watch("input.minDepth",o),e.$watch("input.maxDepth",o),this.provideMalePlug("PointPick3DControl",["setPickedPoints"]),this._connectorService.connectWithAll(this.getMalePlug("PointPick3DControl"))}},WS.extend("OrthoPhotoMapTask","OrthoPhotoTask"),angular.module("ws",["ngResource","ngSanitize","angularRangeSlider","ang-drag-drop","f.component","f.component.radialmenu","f.filter","f.widget","f.util","f.unit","f.task","f.alert","f.user","ws.component.radialmenu","ws.filter","ws.widget","ws.annotation","ws.scanlist","ws.map","ws.panoramaview","ws.headerbar","ws.footerbar","ws.component","ws.page","ws.component.imagegallery"].concat(WS._2GO?[]:["ws.entity","ws.admin","ws.dashboard"])).config(["$sceDelegateProvider",function(e){e.resourceUrlWhitelist(["self","http://*.cloudfront.net/**","https://*.cloudfront.net/**"])}]).config(["$locationProvider",function(e){e.html5Mode(!0)}]).run(["$location",function(e){var t=e.search();if(e.absUrl().match("/user/newpassword/"))t.sptoken&&e.search({v:"rp",rp:t.sptoken}).replace();else if(e.absUrl().match("/user/accountvalidation/"))t.sptoken&&e.search({v:"av",av:t.sptoken}).replace();else if(t.project&&t.x&&t.y&&t.z){var i="x:"+t.x+",y:"+t.y+",z:"+t.z;e.search({v:"pv",t:"p:default,c:panoramaview,m:f",pv:"pv1",pv1:i,p:t.project}).replace()}else if(t.project&&t.map){var n;t.x&&t.y?(n="x:"+t.x+",y:"+t.y,t.zoom&&(n+=",zoom:"+t.zoom)):n="auto:t",e.search({v:"om",t:"p:default,c:overviewmap,m:f",om:"om1",om1:n,p:t.project}).replace()}else t.project&&e.search({v:"pd",t:"p:default,c:projectselector,m:f",pd:"pd1",pd1:"",p:t.project}).replace()}]).run(["$http","$resource","$filter","$location","$rootScope","$window","$sanitize",function(e,t,i,n,o,r,a){var s=F.DI();s.registerAuxiliary("$resource",function(){return t}),s.registerAuxiliary("$http",function(){return e}),s.registerAuxiliary("$location",function(){return n}),s.registerAuxiliary("$filter",function(){return i}),s.registerAuxiliary("$rootScope",function(){return o}),s.registerAuxiliary("$window",function(){return r}),s.registerAuxiliary("$sanitize",function(){return a}),s.registerAuxiliary("$localStorage",function(){var e;try{e=window.localStorage}catch(t){}return e||(e={getItem:function(){return null},setItem:function(){},removeItem:function(){},clear:function(){}}),e});var c=F.isSmallScreen()?"f":"t";s.registerParameter("defaultURL","v=ps&t=p:default,c:projectselector,m:"+c+"&ps=ps1&ps1="),s.registerParameter("URLroots",["v","t"]),s.registerParameter("signedProjectRoute","/data/signedurl/"),s.registerService("projectdatacdn",F.SignedURLService,"$http","@error","%signedProjectRoute%"),s.registerParameter("linkRepository","http://farosoftwareupdate.websharecloud.com/links/ws/"),s.registerParameter("previewGuide","preview-guide.html"),s.registerParameter("devSupportMail","WebShareCloud@faro.com"),WS._2GO&&s.registerParameter("linkifyDocsRoot","ws2go-data/documents/"),F.DI().init()}]);